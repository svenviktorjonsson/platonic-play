(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const Er="#3b82f6",Tr="#4a5568",Cr="#718096",id=300,wr="#242c3a",Us=2,el=3,Fe=9,Pr=12,rd=5,tl=8,rt=8,nl=.9,sl=5,yi=[4,4],ad={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},ld={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class cd{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=ad,this.namedColormaps=ld,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,s=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,o=1;if(s&&s.type==="colormap"&&(s.points||s.controlPoints)){this.state.isCyclic=s.isCyclic===!0;let r=JSON.parse(JSON.stringify(s.controlPoints||s.points));if(r.length===1){r[0].pos=.5;const a=r[0].color,d=a[0]/255,l=a[1]/255,c=a[2]/255;i=(d+l+c)/3,o=r[0].alpha!==void 0?r[0].alpha:1}this.state.points=r.map(a=>{const d=a.color,l=a.alpha!==void 0?a.alpha:1;return this.createPointFromRgb(d[0]/255,d[1]/255,d[2]/255,l,a.pos,a.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=o,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async s=>{const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch preset file at ${s}: Status ${i.status}`);return await i.json()},n=s=>{try{const i=localStorage.getItem(s);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:s}=t.dataset;if(s==="named_colors"||s==="custom_colors"){let i;if(s==="named_colors"?i=this.namedColors[n]:i=this.customColors[n]?.rgb,!i){console.error(`RGB undefined for ${n} in ${s}`);return}this.applyColorToSelection(i)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const i=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(i==="Cancel"||i==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,s)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,s=t[1]/255,i=t[2]/255;if(this.state.selectedPointIds.size===0){const o=this.state.points.length;o>0&&this.state.points.forEach(d=>{d.pos=d.pos*(o/(o+1))});const r=o===0?.5:1,a=this.createPointFromRgb(n,s,i,1,r,1);this.state.points.push(a),this.sortPoints()}else{this.state.points.forEach(r=>{if(this.state.selectedPointIds.has(r.id)){const a=this.convertRgbToCurrentColorspace(n,s,i);r.hsPos=a.hsPos,r.originalHsPos={...a.hsPos},r.lightness=a.lightness}});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}loadColormap(t,n,s=!1){s||this.saveState();const i=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!i||!i.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const o=i.points.map(r=>{let a=[0,0,0];typeof r.color=="string"?a=this.namedColors[r.color]||this.customColors[r.color]?.rgb||a:Array.isArray(r.color)&&(a=r.color);const d=a[0]/255,l=a[1]/255,c=a[2]/255,h=r.alpha??1;return this.createPointFromRgb(d,l,c,h,r.pos,r.order)});this.state.points=o,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=(B,D={})=>{const N=document.createElement(B);if(D.id){N.id=D.id;const k=D.id.replace(/-(\w)/g,(Y,X)=>X.toUpperCase());this.elements[k]=N}return D.className&&(N.className=D.className),D.text&&(N.textContent=D.text),D.type&&(N.type=D.type),D.placeholder&&(N.placeholder=D.placeholder),N};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),s=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const o=t("div",{id:"selected-color-section",className:"control-section"}),r=t("div",{id:"current-colormap-section",className:"control-section"}),a=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),a.append(this.elements.tabRgbCube,this.elements.tabHslCone);const d=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});d.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(a,d);const c=t("h2",{className:"panel-header",text:"Lightness"}),h=t("div",{id:"lightness-slider-container",className:"canvas-container"}),f=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});h.append(t("canvas",{id:"lightness-bg-canvas"}),f),s.append(c,h);const u=t("h2",{className:"panel-header",text:"Alpha"}),p=t("div",{id:"alpha-slider-container",className:"canvas-container"}),g=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});p.append(t("canvas",{id:"alpha-bg-canvas"}),g),i.append(u,p);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const m=t("div",{className:"preset-category-header"});m.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(m,t("div",{className:"preset-items-container"}));const x=t("h3",{className:"section-title",text:"Selected Color"}),S=t("div",{className:"preview-container"});S.append(t("canvas",{id:"selected-color-preview-canvas"}));const v=t("div",{className:"space-y-2"}),b=t("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const T=t("div");T.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const _=t("div");_.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const C=t("div");C.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),b.append(T,_,C),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const E=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),M=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),I=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(E,M,I),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const w=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),L=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(w,L);const P=t("h3",{className:"input-label",text:"Interpolation"});P.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const A=t("div",{className:"interpolation-grid"});A.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),A.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),v.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,P,A),o.append(x,S,v);const R=t("h3",{className:"section-title text-center",text:"Current Colormap"}),O=t("div",{className:"preview-container"});O.append(t("canvas",{id:"colormap-preview-canvas"}));const $=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const F=t("div",{className:"button-row"});F.append(this.elements.reverseButton,this.elements.cycleButton),$.append(F,this.elements.closeButton,this.elements.selectButton),r.append(R,O,$),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const V=t("div",{id:"modal-dialog",className:"modal-dialog"});V.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),V.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(V),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,s,this.elements.colorsPresetsWrapper,o,i,this.elements.colormapsPresetsWrapper,r,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(f,"lightness"),this.createInteractiveCanvas(g,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const s=i=>{const o=i.target.closest(".preset-item");o&&(i.type==="click"?this.handlePresetClick(o):i.type==="contextmenu"&&o.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,o.dataset.name,o.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",s),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",s),this.elements.colormapsPresetsWrapper.addEventListener("click",s),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",s),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const o=this.state.points,r=o.length,a=(u,p)=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(g);return{pos:parseFloat((p!==void 0?p:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(r>0){const u=this.state.isCyclic?r:r-1;for(let p=0;p<u;p++){const g=o[p],y=o[(p+1)%r];i.push(a(g));const m=Math.max(g.order,y.order);if(m===0){let x=g.pos,S=y.pos;this.state.isCyclic&&S<x&&(S+=1);const v=x+(S-x)*.5;i.push(a(g,this.wrapPositionCyclic(v-1e-6))),i.push(a(y,this.wrapPositionCyclic(v)))}else if(m===3){const S=g.pos;let v=y.pos;this.state.isCyclic&&v<S&&(v+=1);const b=v-S;for(let T=1;T<16;T++){const _=T/16,C=S+_*b,E=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(C));if(E){const M=this.abstractToRgb(E.u,E.v,E.lightness),I=this.clampColor(M);i.push({pos:parseFloat(this.wrapPositionCyclic(C).toFixed(6)),alpha:parseFloat(E.alpha.toFixed(4)),color:[I.r,I.g,I.b],order:E.order})}}}}this.state.isCyclic||i.push(a(o[r-1]))}const d=new Map;i.forEach(u=>d.set(u.pos,u));let l=Array.from(d.values()).sort((u,p)=>u.pos-p.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const c=this.state.points.map(u=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),g=this.clampColor(p);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[g.r,g.g,g.b],order:u.order}}),h={points:l,controlPoints:c,isCyclic:this.state.isCyclic},f=new CustomEvent("select",{detail:h,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(f)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,s){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const o={Rename:()=>this.handlePresetAction("rename",n,s),Delete:()=>this.handlePresetAction("delete",n,s)};for(const[r,a]of Object.entries(o)){const d=document.createElement("button");d.className="context-menu-item",d.textContent=r,d.onclick=a,i.appendChild(d)}i.style.left=`${t.clientX}px`,i.style.top=`${t.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,s){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(s==="custom_colors"&&delete this.customColors[n],s==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(s),this.populatePresets());else if(t==="rename"){const i=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(i&&i!==n){const o=s==="custom_colors"?this.customColors:this.customColormaps;if(o[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}o[i]=o[n],delete o[n],this.saveCustomPresets(s),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const s=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!s)return!1;if(t==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const o=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),r=this.clampColor(o);this.customColors[s]={rgb:[r.r,r.g,r.b],alpha:i.alpha}}else{const i=this.state.points.map(o=>{const r=this.abstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness),a=this.clampColor(r);return{pos:o.pos,alpha:o.alpha,color:[a.r,a.g,a.b],order:o.order}});this.customColormaps[s]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=s,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(o,r)=>{const a=document.createElement("div");a.className="preset-category-header";const d=document.createElement("div");d.className="preset-category-title",d.textContent=o;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=r,a.appendChild(d),a.appendChild(l),a},n=(o,r,a,d)=>{Object.keys(r).sort().forEach(l=>{const c=document.createElement("div");c.className="preset-item",c.dataset.name=l,c.dataset.type=a,c.dataset.custom=d;const h=document.createElement("canvas");h.className="preset-icon",a.includes("colormap")?(h.width=64,h.height=16):(h.width=16,h.height=16);const f=document.createElement("span");if(f.textContent=l,c.appendChild(h),c.appendChild(f),o.appendChild(c),a==="named_colors"||a==="custom_colors"){const u=r[l],p=d?u.rgb:u;this.drawColorIcon(h,p)}else this.drawColormapIcon(h,r[l].points,this.namedColors,this.customColors)})},s=document.createElement("div");s.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(s),n(s,this.namedColors,"named_colors",!1),n(s,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),n(i,this.namedColormaps,"named_colormaps",!1),n(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,s,i){const o=n.map(c=>{let h=[0,0,0];typeof c.color=="string"?h=s[c.color]||(i[c.color]?i[c.color].rgb:[0,0,0]):Array.isArray(c.color)&&(h=c.color);const{hsPos:f,lightness:u}=this.convertRgbToCurrentColorspace(h[0]/255,h[1]/255,h[2]/255);return{id:Math.random(),hsPos:f,originalHsPos:{...f},lightness:u,alpha:c.alpha??1,pos:c.pos,order:1}}).sort((c,h)=>c.pos-h.pos),r=this.state.points;this.state.points=o;const a=t.getContext("2d"),{width:d,height:l}=t;if(this.drawCheckerboard(a),this.state.points.length>0)for(let c=0;c<d;c++){const h=c/(d-1),f=this.getInterpolatedPropertiesAt(h);if(!f)continue;const u=this.clampAbstractPoint(f.u,f.v,f.lightness),p=this.abstractToRgb(u.u,u.v,f.lightness),{r:g,g:y,b:m}=this.clampColor(p);a.fillStyle=`rgba(${g}, ${y}, ${m}, ${f.alpha})`,a.fillRect(c,0,1,l)}this.state.points=r}showPrompt(t,n,s=null){return new Promise(i=>{const{modalOverlay:o,modalTitle:r,modalInputContainer:a,modalInput:d,modalButtons:l}=this.elements,c=document.querySelectorAll("[data-tick-canvas]");c.forEach(h=>h.style.display="none"),r.textContent=t,l.innerHTML="",s?(d.value=s.value||"",d.placeholder=s.placeholder||"",a.classList.remove("hidden")):a.classList.add("hidden"),n.forEach(h=>{const f=document.createElement("button");f.className=`modal-button ${h==="Save"||h==="Delete"||h==="Rename"?"modal-button-primary":"modal-button-secondary"}`,f.textContent=h,f.onclick=()=>{o.classList.add("hidden"),c.forEach(u=>u.style.display=""),i(s?d.value:h)},l.appendChild(f)}),o.classList.remove("hidden"),s&&d.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(s=>s.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(s=>Math.abs(s.pos)<1e-6),n=this.state.points.some(s=>Math.abs(s.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(o=>({id:o.id,pos:o.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(o=>{o.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const s=t.getContext("2d");s.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,s.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,s,i,o,r){const{hsPos:a,lightness:d}=this.convertRgbToCurrentColorspace(t,n,s);return{id:Date.now()+Math.random(),hsPos:a,originalHsPos:{...a},lightness:d,alpha:i,pos:o,order:r}}convertRgbToCurrentColorspace(t,n,s){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),lightness:(t+n+s)/3};{const i=this.rgbToHsl(t,n,s);return{hsPos:this.rgbToHslDiConeAbstract(t,n,s),lightness:i.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:c,clientHeight:h}=l.container;(l.c.width!==c||l.c.height!==h)&&(l.c.width=c,l.c.height=h)});const i=this.elements.hsBgCanvas,o=this.elements.interactiveCanvases.hs,r=i.parentElement,a=r.clientWidth,d=r.clientHeight;[i,o].forEach(l=>{l&&(l.width=a,l.height=d,l.style.width=`${a}px`,l.style.height=`${d}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(i=>{let o;n==="RGB_CUBE"?o=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):o=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let r,a;if(t==="RGB_CUBE")r=this.rgbCubeRgbToAbstract(o),a=(o.r+o.g+o.b)/3;else{const d=this.rgbToHsl(o.r,o.g,o.b);r=this.rgbToHslDiConeAbstract(o.r,o.g,o.b),a=d.l}i.hsPos=r,i.originalHsPos={...r},i.lightness=a});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const s=Date.now(),i=this.elements.interactiveCanvases[n];if(!i)return;const o=i.getBoundingClientRect(),r=i.width/o.width,a=i.height/o.height,d=(t.clientX-o.left)*r,l=(t.clientY-o.top)*a,c={x:d,y:l};let h=!1,f=null,u=!1;if(n==="hs")f=this.findHitPointHS(d,l);else{const m=this.findHitPointSlider(d,l,n);f=m.hitPoint,u=m.hitLine}if(s-this.lastClickTime<id&&f&&f.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=s,this.lastClickTarget=f?f.id:null,f){this.state.viewLightness=f.lightness,this.state.viewAlpha=f.alpha;const m=t.ctrlKey||t.metaKey,x=t.shiftKey;!this.state.selectedPointIds.has(f.id)&&!m&&!x&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(f.id),this.state.lastSelectedPointId=f.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=i,this.state.activeDrag.pointId=f?f.id:null,f){const m=new Map;if(n==="hs"){this.state.activeDrag.startX=d,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:x,offsetX:S,offsetY:v}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const T=b.hsPos.u*x+S,_=b.hsPos.v*x+v;this.state.activeDrag.initialPointPositions.set(b.id,{x:T,y:_})}})}else this.state.points.forEach(x=>{this.state.selectedPointIds.has(x.id)&&m.set(x.id,{lightness:x.lightness-f.lightness,alpha:x.alpha-f.alpha,pos:x.pos-f.pos})}),this.state.activeDrag.offsets=m}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const g=m=>{const x=(m.clientX-o.left)*r,S=(m.clientY-o.top)*a,v=Math.sqrt((x-c.x)**2+(S-c.y)**2);!h&&v>rd&&(h=!0,f&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(m)},y=m=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y),h||this.handleClick(d,l,n,f,m),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",g),document.addEventListener("mouseup",y)}handleClick(t,n,s,i,o){const{shiftKey:r,ctrlKey:a,metaKey:d}=o,l=a||d;if(i){const{selectedPointIds:c}=this.state,h=i.id;if(this.clickCount===3)this.state.points.forEach(f=>c.add(f.id)),this.state.lastSelectedPointId=h;else if(this.clickCount===2){const f=this.state.points.findIndex(p=>p.id===h);c.clear(),[f-1,f,f+1].forEach(p=>{p>=0&&p<this.state.points.length&&c.add(this.state.points[p].id)}),this.state.lastSelectedPointId=h}else l?c.has(h)?(c.delete(h),this.state.lastSelectedPointId===h&&(this.state.lastSelectedPointId=c.size>0?Array.from(c)[0]:null)):(c.add(h),this.state.lastSelectedPointId=h):r?(c.add(h),this.state.lastSelectedPointId=h):(c.clear(),c.add(h),this.state.lastSelectedPointId=h)}else if(s==="hs")this.createNewPointHS(t,n);else if(s==="lightness"||s==="alpha"){const c=this.elements.interactiveCanvases[s],h=Math.ceil(Fe*2.2),f=c.height-2*h,p=(c.height-h-n)/f,g=Math.max(0,Math.min(1,p));s==="lightness"?this.state.viewLightness=g:this.state.viewAlpha=g}this.drawAll()}findHitPointHS(t,n){const s=Math.ceil(Fe*2.2),i=Math.ceil(rt/2),o=s+i,r=o,a=o,d=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;for(const c of this.state.points){const h=c.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=c.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=r-Fe&&h<=r+d+Fe&&f>=a-Fe&&f<=a+l+Fe&&Math.sqrt((t-h)**2+(n-f)**2)<=Pr)return c}return null}handleInputChange(t,n){const s=t.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(n==="lightness"||n==="alpha"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(r=>{this.state.selectedPointIds.has(r.id)&&(r[n]=o,n==="lightness"&&this.constrainPointToValidArea(r))}),i=!0)}else if(n==="position"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(r=>{this.state.selectedPointIds.has(r.id)&&(r.pos=o)}),this.sortPoints(),i=!0)}if(i){const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,s,i,o,r,a=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),s=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(s))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,s=Math.max(0,Math.min(255,s))/255;const d=this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),l=(t+n+s)/3;this.state.points.forEach(c=>{this.state.selectedPointIds.has(c.id)&&(c.hsPos={...d},c.originalHsPos={...d},c.lightness=l)}),a=!0}else{if(i=parseFloat(this.elements.hslHInput.value),o=parseFloat(this.elements.hslSInput.value),r=this.state.viewLightness,isNaN(i)||isNaN(o))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),o=Math.max(0,Math.min(1,o));const d=this.hslToRgb(i,o,r),l=this.rgbToHslDiConeAbstract(d.r,d.g,d.b);this.state.points.forEach(c=>{this.state.selectedPointIds.has(c.id)&&(c.hsPos={...l},c.originalHsPos={...l})}),a=!0}if(a){const d=this.getLastSelectedPoint();d&&(this.state.viewLightness=d.lightness,this.state.viewAlpha=d.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const s=document.createElement("canvas");s.className=`interactive-canvas ${n}-interactive`,s.dataset.type=n,t.appendChild(s),this.elements.interactiveCanvases[n]=s}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:s,pointId:i}=this.state.activeDrag,o=s,r=o.getBoundingClientRect(),a=o.width/r.width,d=o.height/r.height,l=(t.clientX-r.left)*a,c=(t.clientY-r.top)*d;n.endsWith("-line")?this.handleLineDrag(c,o.height,n):i&&this.handlePointDrag(l,c,o,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),s=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:s}}rgbToHslDiConeAbstract(t,n,s){const i=this.rgbToHsl(t,n,s),o=1-Math.abs(2*i.l-1),r=i.s*o,a=i.h*2*Math.PI,d=r*Math.cos(a),l=r*Math.sin(a);return{u:d,v:l}}hslDiConeAbstractToRgb(t,n,s){const i=(Math.atan2(n,t)/(2*Math.PI)+1)%1,o=Math.sqrt(t*t+n*n),r=s,a=1-Math.abs(2*r-1);if(a<1e-9)return{r,g:r,b:r};const d=o/a;return this.hslToRgb(i,d,r)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,s=n&&n.tagName==="INPUT",i=t.ctrlKey||t.metaKey;if(i&&t.key==="z"){t.preventDefault(),this.undo();return}if(i&&t.key==="y"){t.preventDefault(),this.redo();return}if(s){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(i&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(o=>this.state.selectedPointIds.add(o.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(o=>!this.state.selectedPointIds.has(o.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,s,i=null){let o=t,r=sl+1;const a=Math.ceil(Fe*2.2),d=Math.ceil(rt/2),l=a+d,c=n-l-a,h=n-a;return this.state.points.forEach(f=>{if(f.id===i)return;const u=h-f[s]*c,p=Math.abs(t-u);p<sl&&p<r&&(o=u,r=p)}),o}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:s}=this.state,i=this.elements.hsBgCanvas.width,o=this.elements.hsBgCanvas.height;if(i===0||o===0)return;const r=this.elements.hsBgCanvas.getContext("2d");r.fillStyle=wr,r.fillRect(0,0,i,o);const a=Math.ceil(Fe*2.2),d=Math.ceil(rt/2),l=a+d,c=i-l-a,h=o-l-a;if(c<=0||h<=0)return;const f=s==="RGB_CUBE"?Math.min(c,h)/(Math.sqrt(2/3)*2)*nl:Math.min(c,h)/2*nl;this.state.transform.scale=f,this.state.transform.offsetX=i/2,this.state.transform.offsetY=o/2;const u=l,p=l,g=c,y=h,m=rt,x=Math.round(g/m),S=Math.round(y/m),v=g/x,b=y/S;for(let M=0;M<S;M++)for(let I=0;I<x;I++){const w=u+I*v,L=p+M*b;(M+I)%2===0?r.fillStyle=Cr:r.fillStyle=Tr,r.fillRect(w,L,v,b)}if(s==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const I=i/2,w=o/2,L=t<.5?0:255;r.fillStyle=`rgba(${L}, ${L}, ${L}, ${n})`,r.fillRect(Math.floor(I),Math.floor(w),1,1);return}const T=r.createImageData(g,y),_=T.data;for(let M=0;M<y;M++)for(let I=0;I<g;I++){const w=u+I,L=p+M,P=(w-this.state.transform.offsetX)/this.state.transform.scale,A=(L-this.state.transform.offsetY)/this.state.transform.scale,{r:R,g:O,b:$}=this.abstractToRgb(P,A,t),F=(M*g+I)*4;this.isValidColor(R,O,$)&&(_[F]=Math.round(R*255),_[F+1]=Math.round(O*255),_[F+2]=Math.round($*255),_[F+3]=255)}const C=document.createElement("canvas");C.width=g,C.height=y,C.getContext("2d").putImageData(T,0,0),r.globalAlpha=n,r.drawImage(C,u,p),r.globalAlpha=1}evaluateCubicSpline(t,n){const s=this.state.points,i=s.length;if(t<0||t>=i)return null;let o,r,a,d;if(this.state.isCyclic){const u=p=>{const g=(p%i+i)%i;return s[g]};t===i-1?(o=u(t-1),r=u(t),a=u(0),d=u(1)):(o=u(t-1),r=u(t),a=u(t+1),d=u(t+2))}else r=s[t],a=s[t+1],o=t>0?s[t-1]:s[t],d=t+2<i?s[t+2]:s[t+1];const l=n,c=l*l,h=c*l,f=(u,p,g,y)=>.5*(2*p+(-u+g)*l+(2*u-5*p+4*g-y)*c+(-u+3*p-3*g+y)*h);return{u:f(o.hsPos.u,r.hsPos.u,a.hsPos.u,d.hsPos.u),v:f(o.hsPos.v,r.hsPos.v,a.hsPos.v,d.hsPos.v),lightness:f(o.lightness,r.lightness,a.lightness,d.lightness),alpha:f(o.alpha,r.alpha,a.alpha,d.alpha),order:2}}isValidColor(t,n,s){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&s>=-.001&&s<=1.001}drawSliderBackgrounds(){const t=Math.ceil(Fe*2.2),n=Math.ceil(rt/2),s=t+n,i=this.elements.lightnessBgCanvas.getContext("2d"),o=this.elements.lightnessBgCanvas;i.fillStyle=wr,i.fillRect(0,0,o.width,o.height);const r=s,a=o.width-t,d=s,l=o.height-t,c=a-r,h=l-d;if(h>0&&c>0){const v=i.createLinearGradient(0,d,0,l);v.addColorStop(0,"white"),v.addColorStop(1,"black"),i.fillStyle=v,i.fillRect(r,d,c,h)}const f=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;f.fillStyle=wr,f.fillRect(0,0,u.width,u.height);const p=s,g=u.width-t,y=s,m=u.height-t,x=g-p,S=m-y;if(S>0&&x>0){const v=rt,b=Math.round(x/v),T=Math.ceil(S/v),_=x/b,C=v,E=m-T*C;for(let I=0;I<T;I++)for(let w=0;w<b;w++){const L=p+w*_,P=E+I*C;if(P<m&&P+C>y){(I+w)%2===0?f.fillStyle=Cr:f.fillStyle=Tr;const A=Math.max(P,y),R=Math.min(P+C,m)-A;R>0&&f.fillRect(L,A,_,R)}}const M=f.createLinearGradient(0,y,0,m);M.addColorStop(0,"white"),M.addColorStop(1,"rgba(255,255,255,0)"),f.fillStyle=M,f.fillRect(p,y,x,S)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=Er,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Fe*2.2),i=Math.ceil(rt/2),o=s+i,r=o,a=o,d=t.width-o-s,l=t.height-o-s;if(this.state.points.length>1){const c=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let h=0;h<c;h++){const f=this.state.points[h],u=this.state.points[(h+1)%this.state.points.length];if(Math.max(f.order,u.order)===0)continue;let g=f.pos,y=u.pos;this.state.isCyclic&&y<g&&(y+=1);const m=y-g;if(m<1e-9)continue;const x=Math.max(10,Math.ceil(m*100)),S=[];for(let b=0;b<=x;b++){const T=g+b/x*m,_=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(T));if(!_)continue;const C=this.clampAbstractPoint(_.u,_.v,_.lightness),E=C.u*this.state.transform.scale+this.state.transform.offsetX,M=C.v*this.state.transform.scale+this.state.transform.offsetY;S.push({x:E,y:M,isOnPlane:Math.abs(_.lightness-this.state.viewLightness)<1e-10})}if(S.length<2)continue;const v=S.every(b=>b.isOnPlane);n.strokeStyle="black",n.lineWidth=Us,n.globalAlpha=v?.7:.4,n.setLineDash(v?[]:yi),n.beginPath(),n.moveTo(S[0].x,S[0].y);for(let b=1;b<S.length;b++)n.lineTo(S[b].x,S[b].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(r,a,d,l),n.clip(),this.state.points.forEach(c=>{const h=c.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=c.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=r-Fe&&h<=r+d+Fe&&f>=a-Fe&&f<=a+l+Fe){const u=this.abstractToRgb(c.hsPos.u,c.hsPos.v,c.lightness),{r:p,g,b:y}=this.clampColor(u),m=this.state.selectedPointIds.has(c.id),x=c.id===this.state.lastSelectedPointId,S=Math.abs(c.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),c.order){case 0:this._drawCircle(n,h,f,Fe);break;case 1:this._drawDroplet(n,h,f,Fe);break;case 3:this._drawTriangle(n,h,f,Fe);break;default:this._drawCircle(n,h,f,Fe)}n.globalAlpha=c.alpha,n.fillStyle=`rgb(${p}, ${g}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=m?Er:"black",n.lineWidth=x?el:Us,n.setLineDash(S?[]:yi),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Fe*2.2),i=Math.ceil(rt/2),o=s+i,r=o,a=t.width-s,d=o,l=t.height-s,c=a-r,h=l-d;let f=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(f=p.lightness)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(p=>{const g=r+p.pos*c,y=l-p.lightness*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:v}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),T=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,v,b,T,p.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=Us;const s=this.state.points,i=s.length;if(n==="hs"){t.restore();return}const o=Math.ceil(Fe*2.2),r=Math.ceil(rt/2),a=o+r,d=a,l=t.canvas.height-o,c=t.canvas.width-a-o,h=l-a,f=d+c;if(c<=0){t.restore();return}const u=this.state.isCyclic?i:i-1;for(let p=0;p<u;p++){const g=s[p],y=s[(p+1)%i],m=Math.max(g.order,y.order),x=this.state.isCyclic&&p===i-1;if(m===0){const S=l-g[n]*h,v=l-y[n]*h,b=d+g.pos*c,T=d+y.pos*c;if(x&&g.pos>y.pos){let _=g.pos,C=y.pos+1;const E=_+(C-_)*.5,M=d+(E-Math.floor(E))*c,I=this.getInterpolatedPropertiesAt(g.pos),w=this.getInterpolatedPropertiesAt(y.pos);if(I){const L=this.abstractToRgb(I.u,I.v,I.lightness),P=this.clampColor(L);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${I.alpha})`,t.setLineDash([]),E>1?(t.beginPath(),t.moveTo(b,S),t.lineTo(f,S),t.stroke(),t.beginPath(),t.moveTo(d,S),t.lineTo(M,S),t.stroke()):(t.beginPath(),t.moveTo(b,S),t.lineTo(M,S),t.stroke())}if(w){const L=this.abstractToRgb(w.u,w.v,w.lightness),P=this.clampColor(L);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${w.alpha})`,t.setLineDash([]),E>1?(t.beginPath(),t.moveTo(M,v),t.lineTo(T,v),t.stroke()):(t.beginPath(),t.moveTo(M,v),t.lineTo(f,v),t.stroke(),t.beginPath(),t.moveTo(d,v),t.lineTo(T,v),t.stroke())}t.beginPath(),t.setLineDash(yi),t.strokeStyle="black",t.moveTo(M,S),t.lineTo(M,v),t.stroke()}else if(!x){let _=g.pos,C=y.pos;const E=_+(C-_)*.5,M=d+E*c,I=this.getInterpolatedPropertiesAt(g.pos),w=this.getInterpolatedPropertiesAt(y.pos);if(I){const L=this.abstractToRgb(I.u,I.v,I.lightness),P=this.clampColor(L);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${I.alpha})`,t.setLineDash([]);const A=p===0&&!this.state.isCyclic?d:b;t.beginPath(),t.moveTo(A,S),t.lineTo(M,S),t.stroke()}if(w){const L=this.abstractToRgb(w.u,w.v,w.lightness),P=this.clampColor(L);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${w.alpha})`,t.setLineDash([]);const A=p===u-1&&!this.state.isCyclic?f:T;t.beginPath(),t.moveTo(M,v),t.lineTo(A,v),t.stroke()}t.beginPath(),t.setLineDash(yi),t.strokeStyle="black",t.moveTo(M,S),t.lineTo(M,v),t.stroke()}}else if(t.setLineDash([]),x&&g.pos>y.pos){const S=l-g[n]*h,v=l-y[n]*h,b=d+g.pos*c,T=d+y.pos*c,_=1-g.pos;if(_>1e-6){const C=t.createLinearGradient(b,0,f,0),E=Math.max(2,Math.ceil(_*20));for(let w=0;w<=E;w++){const L=g.pos+w/E*_,P=this.getInterpolatedPropertiesAt(L);if(P){const A=this.abstractToRgb(P.u,P.v,P.lightness),{r:R,g:O,b:$}=this.clampColor(A);C.addColorStop(w/E,`rgba(${R}, ${O}, ${$}, ${P.alpha})`)}}const M=this.getInterpolatedPropertiesAt(1),I=M?l-M[n]*h:S;t.beginPath(),t.moveTo(b,S),t.lineTo(f,I),t.strokeStyle=C,t.stroke()}if(y.pos>1e-6){const C=t.createLinearGradient(d,0,T,0),E=Math.max(2,Math.ceil(y.pos*20));for(let w=0;w<=E;w++){const L=w/E*y.pos,P=this.getInterpolatedPropertiesAt(L);if(P){const A=this.abstractToRgb(P.u,P.v,P.lightness),{r:R,g:O,b:$}=this.clampColor(A);C.addColorStop(w/E,`rgba(${R}, ${O}, ${$}, ${P.alpha})`)}}const M=this.getInterpolatedPropertiesAt(0),I=M?l-M[n]*h:v;t.beginPath(),t.moveTo(d,I),t.lineTo(T,v),t.strokeStyle=C,t.stroke()}}else if(!x){const S=d+g.pos*c,v=d+y.pos*c,b=(T,_,C,E)=>{const M=_-T;if(Math.abs(M)<1e-9)return;const I=t.createLinearGradient(C,0,E,0),w=Math.ceil(Math.abs(E-C)/2);for(let L=0;L<=w;L++){const P=T+L/w*M,A=this.getInterpolatedPropertiesAt(P);if(!A)continue;const R=this.abstractToRgb(A.u,A.v,A.lightness),{r:O,g:$,b:F}=this.clampColor(R);I.addColorStop(L/w,`rgba(${O}, ${$}, ${F}, ${A.alpha})`)}t.beginPath();for(let L=0;L<=w;L++){const P=T+L/w*M,A=this.getInterpolatedPropertiesAt(P);if(!A)continue;const R=Math.max(0,Math.min(1,P)),O=d+R*c,$=l-A[n]*h;L===0?t.moveTo(O,$):t.lineTo(O,$)}t.strokeStyle=I,t.stroke()};if(p===0&&!this.state.isCyclic&&Math.abs(g.pos)>=1e-6){const T=this.getInterpolatedPropertiesAt(g.pos);if(T){const _=this.abstractToRgb(T.u,T.v,T.lightness),{r:C,g:E,b:M}=this.clampColor(_);t.strokeStyle=`rgba(${C}, ${E}, ${M}, ${T.alpha})`;const I=l-T[n]*h;t.beginPath(),t.moveTo(d,I),t.lineTo(S,I),t.stroke()}}if(b(g.pos,y.pos,S,v),p===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const T=this.getInterpolatedPropertiesAt(y.pos);if(T){const _=this.abstractToRgb(T.u,T.v,T.lightness),{r:C,g:E,b:M}=this.clampColor(_);t.strokeStyle=`rgba(${C}, ${E}, ${M}, ${T.alpha})`;const I=l-T[n]*h;t.beginPath(),t.moveTo(v,I),t.lineTo(f,I),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const s=t.lightness<.05||t.lightness>.95,i=n.lightness<.05||n.lightness>.95;if(s&&i)return!0;const o=10;for(let r=0;r<=o;r++){const a=r/o,d=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*a,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*a,c=t.lightness+(n.lightness-t.lightness)*a,h=this.abstractToRgb(d,l,c);if(!this.isValidColor(h.r,h.g,h.b))return!1}return!0}drawInterpolatedPath(t,n,s,i){const o=s.pos-n.pos;if(o<1e-6)return;const r=Math.max(2,Math.ceil(o*t.canvas.width/4));let a=!1;for(let d=0;d<=r;d++){const l=n.pos+d/r*o,c=this.getInterpolatedPropertiesAt(l);if(!c)continue;const h=this.clampAbstractPoint(c.u,c.v,c.lightness),f=h.u*this.state.transform.scale+this.state.transform.offsetX,u=h.v*this.state.transform.scale+this.state.transform.offsetY;!a||d===0?(t.moveTo(f,u),a=!0):t.lineTo(f,u)}}drawHSSegment(t,n,s,i,o){let r=n.pos,a=s.pos;this.state.isCyclic&&a<r&&(a+=1);const d=a-r;if(d<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(d*t.canvas.width/8)),c=[];for(let f=0;f<=l;f++){const u=r+f/l*d,p=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!p)continue;const g=this.clampAbstractPoint(p.u,p.v,p.lightness),y=g.u*this.state.transform.scale+this.state.transform.offsetX,m=g.v*this.state.transform.scale+this.state.transform.offsetY,x=Math.abs(p.lightness-this.state.viewLightness)<1e-10;c.push({x:y,y:m,isOnPlane:x,u:g.u,v:g.v})}if(c.length<2)return;if(c.every(f=>f.isOnPlane)){t.strokeStyle="black",t.lineWidth=Us,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(c[0].x,c[0].y);for(let f=1;f<c.length;f++)t.lineTo(c[f].x,c[f].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=Us,t.globalAlpha=.4;const f=Math.sqrt((s.hsPos.u-n.hsPos.u)**2+(s.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+f*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(c[0].x,c[0].y);for(let p=1;p<c.length;p++)t.lineTo(c[p].x,c[p].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const s=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<s;i++){const o=this.state.points[i],r=this.state.points[(i+1)%this.state.points.length];if(Math.max(o.order,r.order)===0)continue;const d=Math.abs(o.lightness-this.state.viewLightness)<1e-10,l=Math.abs(r.lightness-this.state.viewLightness)<1e-10;if(d&&l)continue;const c=o.lightness,h=r.lightness,f=this.state.viewLightness;if(c<f&&h>f||c>f&&h<f){const u=this.findLightnessIntersection(o,r,f);if(u!==null){let p=r.pos-o.pos;this.state.isCyclic&&r.pos<o.pos&&(p+=1);const g=o.pos+u*p,y=this.getInterpolatedPropertiesAt(g);if(!y)continue;const m=this.clampAbstractPoint(y.u,y.v,y.lightness),x=m.u*this.state.transform.scale+this.state.transform.offsetX,S=m.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(x,S,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,s){const i=t.lightness,o=n.lightness;if(Math.abs(o-i)<1e-10)return null;if(Math.max(t.order,n.order)===1){const h=(s-i)/(o-i);return h>0&&h<1?h:null}let a=0,d=1;const l=25;for(let h=0;h<l;h++){const f=(a+d)/2,u=t.pos+(n.pos-t.pos)*f,p=this.getInterpolatedPropertiesAt(u);if(!p)break;if(Math.abs(p.lightness-s)<1e-10)return f;p.lightness<s?o>i?a=f:d=f:o>i?d=f:a=f}const c=(a+d)/2;return c>.01&&c<.99?c:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const s=t.canvas,i=Math.ceil(Fe*2.2),o=Math.ceil(rt/2),r=i+o;t.save(),t.strokeStyle="white",t.lineWidth=1;const a=r,d=s.width-i,l=r,c=s.height-i,h=d-a,f=c-l;this.clearTickLabels(s);const u=[0,.2,.4,.6,.8,1],p=["0","0.2","0.4","0.6","0.8","1"],g=s.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,m=window.pageYOffset||document.documentElement.scrollTop;for(let x=0;x<u.length;x++){const S=u[x],v=Math.floor(a+S*h)+.5;S===0?(t.beginPath(),t.moveTo(v,l),t.lineTo(v,c+5),t.stroke()):(t.beginPath(),t.moveTo(v,c),t.lineTo(v,c+5),t.stroke());const b=g.left+y+v,T=g.top+m+c+8;this.createKaTeXLabel(p[x],b,T,"bottom",s)}for(let x=0;x<u.length;x++){const S=u[x],v=Math.floor(c-S*f)+.5;S===0?(t.beginPath(),t.moveTo(a-5,v),t.lineTo(d,v),t.stroke()):(t.beginPath(),t.moveTo(a-5,v),t.lineTo(a,v),t.stroke());const b=g.left+y+a-8,T=g.top+m+v;this.createKaTeXLabel(p[x],b,T,"left",s)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(s=>s.remove())}createKaTeXLabel(t,n,s,i,o){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const r=document.createElement("div");r.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),r.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,r.dataset.tickCanvas=o.dataset.type,document.body.appendChild(r);return}try{const r=document.createElement("div");r.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,r.dataset.tickCanvas=o.dataset.type,katex.render(t,r,{throwOnError:!1,displayMode:!1}),document.body.appendChild(r)}catch(r){console.warn("KaTeX rendering failed:",r),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,s,i,o)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Fe*2.2),i=Math.ceil(rt/2),o=s+i,r=o,a=t.width-s,d=o,l=t.height-s,c=a-r,h=l-d;let f=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(f=p.alpha)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(p=>{const g=r+p.pos*c,y=l-p.alpha*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:v}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),T=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,v,b,T,p.order)})}_drawCircle(t,n,s,i){t.arc(n,s,i,0,2*Math.PI)}_drawJoukowsky(t,n,s,i,o){const a=[];let d=1/0,l=-1/0,c=1/0,h=-1/0;for(let m=0;m<=50;m++){const x=m/50*2*Math.PI,S=Math.cos(x),v=Math.sin(x),b=1-o+o*S,T=o*v,_=b*b+T*T;if(Math.abs(_)<1e-9)continue;const C=o*v-o*v/_,E=o*S+b/_;a.push({x:C,y:E}),C<d&&(d=C),C>l&&(l=C),E<c&&(c=E),E>h&&(h=E)}const f=h-c,u=i*2.5/f,p=(l+d)/2,g=(h+c)/2;t.beginPath();const y=a[0];t.moveTo(n+(y.x-p)*u,s-(y.y-g)*u);for(let m=1;m<a.length;m++){const x=a[m];t.lineTo(n+(x.x-p)*u,s-(x.y-g)*u)}t.closePath()}_drawDroplet(t,n,s,i){this._drawJoukowsky(t,n,s,i,.6666666666666666)}_drawTriangle(t,n,s,i){const o=i*1.4;t.moveTo(n,s-o),t.lineTo(n+o*Math.sqrt(3)/2,s+o/2),t.lineTo(n-o*Math.sqrt(3)/2,s+o/2),t.closePath()}drawPoint(t,n,s,i,o,r,a,d,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,s,Fe);break;case 1:this._drawDroplet(t,n,s,Fe);break;case 3:this._drawTriangle(t,n,s,Fe);break;default:this._drawCircle(t,n,s,Fe)}t.fillStyle=`rgb(${i}, ${o}, ${r})`,t.fill(),t.strokeStyle=a?Er:"black",t.lineWidth=d?el:Us,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,s=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){s||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!s){const{lightness:o,hsPos:r}=t,a=this.abstractToRgb(r.u,r.v,o);if(i){const{r:d,g:l,b:c}=this.clampColor(a);this.elements.rgbRInput.value=d,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=c}else{const d=this.rgbToHsl(a.r,a.g,a.b);this.elements.hslHInput.value=d.h.toFixed(2),this.elements.hslSInput.value=d.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:s}=t.parentElement;(t.width!==n||t.height!==s)&&(t.width=n,t.height=s);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),this.drawCheckerboard(i);const o=this.getLastSelectedPoint();if(o){const{hsPos:r,lightness:a,alpha:d}=o,l=this.abstractToRgb(r.u,r.v,a),{r:c,g:h,b:f}=this.clampColor(l);i.fillStyle=`rgba(${c}, ${h}, ${f}, ${d})`,i.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,s=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let i=0;i<n;i++){const o=i/(n-1),r=this.getInterpolatedPropertiesAt(o);if(!r)continue;const a=this.clampAbstractPoint(r.u,r.v,r.lightness),d=this.abstractToRgb(a.u,a.v,r.lightness),{r:l,g:c,b:h}=this.clampColor(d);t.fillStyle=`rgba(${l}, ${c}, ${h}, ${r.alpha})`,t.fillRect(i,0,1,s)}}getInterpolatedPropertiesAt(t){const n=this.state.points,s=n.length;if(s===0)return null;if(s===1){const f=n[0];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}const i=this.state.isCyclic,o=i?(t%1+1)%1:t;let r,a,d=-1;for(let f=0;f<s-1;f++)if(o>=n[f].pos&&o<=n[f+1].pos){d=f,r=n[f],a=n[f+1];break}if(d===-1)if(i)d=s-1,r=n[s-1],a=n[0];else{const f=o<n[0].pos?n[0]:n[s-1];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(!r||!a)return null;let l=a.pos-r.pos;if(i&&d===s-1&&(l+=1),Math.abs(l)<1e-9)return{u:r.hsPos.u,v:r.hsPos.v,lightness:r.lightness,alpha:r.alpha,order:r.order};let c;i&&d===s-1?c=o>=r.pos?(o-r.pos)/l:(o+1-r.pos)/l:c=(o-r.pos)/l;const h=Math.max(r.order,a.order);if(h===0){const f=c<.5?r:a;return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(h===3){const f=this.evaluateCubicSpline(d,c);if(f){const u=Math.max(0,Math.min(1,f.lightness)),p=Math.max(0,Math.min(1,f.alpha)),g=this.clampAbstractPoint(f.u,f.v,u);return{u:g.u,v:g.v,lightness:u,alpha:p,order:2}}}return{u:r.hsPos.u+(a.hsPos.u-r.hsPos.u)*c,v:r.hsPos.v+(a.hsPos.v-r.hsPos.v)*c,lightness:r.lightness+(a.lightness-r.lightness)*c,alpha:r.alpha+(a.alpha-r.alpha)*c,order:1}}abstractToRgb(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,s);const i=this.rgbCubeAbstractToRgb(t,n,s);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE"){const f=Math.sqrt(t*t+n*n),u=1-Math.abs(2*s-1);return f>u&&u>1e-6?{u:t/f*u,v:n/f*u}:{u:t,v:n}}if(s<=.01||s>=.99)return{u:0,v:0};let{r:i,g:o,b:r}=this.abstractToRgb(t,n,s);if(this.isValidColor(i,o,r))return{u:t,v:n};let a=0,d=0,l=1/0;const c=Math.max(Math.abs(t),Math.abs(n),.5),h=50;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const p=t+(f/h-.5)*2*c,g=n+(u/h-.5)*2*c,y=this.abstractToRgb(p,g,s);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((p-t)**2+(g-n)**2);m<l&&(l=m,a=p,d=g)}}return l<1/0?{u:a,v:d}:{u:0,v:0}}hslToRgb(t,n,s){if(n===0)return{r:s,g:s,b:s};const i=s<.5?s*(1+n):s+n-s*n,o=2*s-i,r=(c,h,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<1/6?c+(h-c)*6*f:f<1/2?h:f<2/3?c+(h-c)*(2/3-f)*6:c),a=r(o,i,t+1/3),d=r(o,i,t),l=r(o,i,t-1/3);return{r:a,g:d,b:l}}rgbToHsl(t,n,s){const i=Math.max(t,n,s),o=Math.min(t,n,s);let r=0,a=0,d=(i+o)/2;if(i!==o){const l=i-o;switch(a=d>.5?l/(2-i-o):l/(i+o),i){case t:r=(n-s)/l+(n<s?6:0);break;case n:r=(s-t)/l+2;break;case s:r=(t-n)/l+4;break}r/=6}return{h:r,s:a,l:d}}drawCheckerboard(t){const n=t.canvas.width,s=t.canvas.height,i=n/rt,o=s/rt;t.fillStyle=Tr,t.fillRect(0,0,n,s),t.fillStyle=Cr;for(let r=0;r<o;r++)for(let a=0;a<i;a++)(r+a)%2===0&&t.fillRect(a*rt,r*rt,rt,rt)}findClosestValidPoint(t,n,s){const i=Math.ceil(Fe*2.2),o=Math.ceil(rt/2),r=i+o,a=r,d=r,l=this.elements.hsBgCanvas.width-r-i,c=this.elements.hsBgCanvas.height-r-i,h=Math.max(a,Math.min(a+l,t)),f=Math.max(d,Math.min(d+c,n)),{scale:u,offsetX:p,offsetY:g}=this.state.transform,y=(h-p)/u,m=(f-g)/u,x=this.abstractToRgb(y,m,s);if(this.isValidColor(x.r,x.g,x.b))return{x:h,y:f};if(this.state.colorSpace==="HSL_DI_CONE"){const S=Math.sqrt(y*y+m*m),v=1-Math.abs(2*s-1);if(S>v&&v>1e-6){const b=y/S*v,T=m/S*v;return{x:b*u+p,y:T*u+g}}return{x:h,y:f}}return this.findClosestPointOnRgbGamut(y,m,s,u,p,g,a,d,l,c)}getGamutVerticesRgb(t){const n=[],s=a=>a>=-1e-6&&a<=1.000001,i=(a,d)=>Math.abs(a.r-d.r)<1e-6&&Math.abs(a.g-d.g)<1e-6&&Math.abs(a.b-d.b)<1e-6,o=(a,d,l)=>{if(s(a)&&s(d)&&s(l)){const c={r:a,g:d,b:l};n.some(h=>i(h,c))||n.push(c)}},r=3*t;return o(r,0,0),o(0,r,0),o(0,0,r),o(1,r-1,0),o(1,0,r-1),o(r-1,1,0),o(0,1,r-1),o(r-1,0,1),o(0,r-1,1),o(1,1,r-2),o(1,r-2,1),o(r-2,1,1),n}rgbCubeAbstractToRgb(t,n,s){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},o={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},r=s+t*i.x+n*o.x,a=s+t*i.y+n*o.y,d=s+t*i.z+n*o.z;return{r,g:a,b:d}}findClosestPointOnRgbGamut(t,n,s,i,o,r,a,d,l,c){let h=t,f=n,u=1/0;const p=.5,g=50;for(let x=0;x<=g;x++)for(let S=0;S<=g;S++){const v=t+(x/g-.5)*2*p,b=n+(S/g-.5)*2*p,T=this.abstractToRgb(v,b,s);if(this.isValidColor(T.r,T.g,T.b)){const _=Math.sqrt((v-t)**2+(b-n)**2);_<u&&(u=_,h=v,f=b)}}if(u<1/0){const x=this.refineClosestPoint(t,n,h,f,s);h=x.u,f=x.v}const y=h*i+o,m=f*i+r;return{x:Math.max(a,Math.min(a+l,y)),y:Math.max(d,Math.min(d+c,m))}}refineClosestPoint(t,n,s,i,o){let r=s,a=i,d=.02;for(let l=0;l<5;l++){let c=!1;const h=20;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const p=r+(f/h-.5)*2*d,g=a+(u/h-.5)*2*d,y=this.abstractToRgb(p,g,o);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((r-t)**2+(a-n)**2);Math.sqrt((p-t)**2+(g-n)**2)<m&&(r=p,a=g,c=!0)}}if(d*=.5,!c)break}return{u:r,v:a}}findClosestPointOnPolygon(t,n){let s=null,i=1/0;for(let o=0;o<n.length;o++){const r=n[o],a=n[(o+1)%n.length],d=a.x-r.x,l=a.y-r.y;let c;if(d===0&&l===0)c=r;else{const f=((t.x-r.x)*d+(t.y-r.y)*l)/(d*d+l*l);f<0?c=r:f>1?c=a:c={x:r.x+f*d,y:r.y+f*l}}const h=(t.x-c.x)**2+(t.y-c.y)**2;h<i&&(i=h,s=c)}return s}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const s=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=s.u,t.hsPos.v=s.v}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(Fe*2.2),r=Math.ceil(rt/2),a=o+r,d=i.height-a-o,l=i.height-o,c=s==="lightness"?l-this.state.viewLightness*d:l-this.state.viewAlpha*d;let h=Math.abs(n-c)<=tl,f=null;for(let u=0;u<this.state.points.length;u++){const p=this.state.points[u],g=i.width-a-o,y=a+p.pos*g,m=s==="lightness"?l-p.lightness*d:l-p.alpha*d;if(Math.sqrt((t-y)**2+(n-m)**2)<=Pr){f=p;break}}return{hitPoint:f,hitLine:h}}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(Fe*2.2),r=i.height-2*o,a=i.height-o,d=s==="lightness"?a-this.state.viewLightness*r:a-this.state.viewAlpha*r;let l=Math.abs(n-d)<=tl,c=null;for(let h=0;h<this.state.points.length;h++){const f=this.state.points[h],u=i.width-2*o,p=o+f.pos*u,g=s==="lightness"?a-f.lightness*r:a-f.alpha*r;if(Math.sqrt((t-p)**2+(n-g)**2)<=Pr){c=f;break}}return{hitPoint:c,hitLine:l}}createNewPointHS(t,n){const s=Math.ceil(Fe*2.2),i=Math.ceil(rt/2),o=s+i,r=o,a=o,d=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;if(t<r||t>r+d||n<a||n>a+l)return;const c=(t-this.state.transform.offsetX)/this.state.transform.scale,h=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:f,viewAlpha:u}=this.state,{r:p,g,b:y}=this.abstractToRgb(c,h,f);if(this.isValidColor(p,g,y)){this.markAsDirty();const m=this.state.points.length;m>0&&this.state.points.forEach(S=>{S.pos=S.pos-S.pos/m});const x={id:Date.now(),hsPos:{u:c,v:h},originalHsPos:{u:c,v:h},lightness:f,alpha:u,pos:m===0?.5:1,order:1};this.state.points.push(x),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(x.id),this.state.lastSelectedPointId=x.id,this.drawAll()}}handleLineDrag(t,n,s){const i=s.startsWith("lightness")?"lightness":"alpha",o=s.startsWith("lightness")?"viewLightness":"viewAlpha",r=Math.ceil(Fe*2.2),a=Math.ceil(rt/2),d=r+a,l=n-d-r,h=(this.findSnapPosition(t,n,i)-d)/l,f=Math.max(0,Math.min(1,1-h));this.state[o]=f,this.drawAll()}handlePointDrag(t,n,s,i){const o=this.getPointById(this.state.activeDrag.pointId);o&&(i==="hs"?this.handleHSPointDrag(t,n):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(o,t,n,s,i),this.drawAll())}handleHSPointDrag(t,n){const{startX:s,startY:i,initialPointPositions:o}=this.state.activeDrag,{scale:r,offsetX:a,offsetY:d}=this.state.transform,l=Math.ceil(Fe*2.2),c=Math.ceil(rt/2),h=l+c,f=h,u=h,p=this.elements.hsBgCanvas.width-h-l,g=this.elements.hsBgCanvas.height-h-l,y=t-s,m=n-i;this.state.points.forEach(x=>{if(o.has(x.id)){const S=o.get(x.id),v=S.x+y,b=S.y+m,T=Math.max(f,Math.min(f+p,v)),_=Math.max(u,Math.min(u+g,b)),C=this.findClosestValidPoint(T,_,x.lightness),E=(C.x-a)/r,M=(C.y-d)/r;x.hsPos={u:E,v:M};const I=this.abstractToRgb(E,M,x.lightness);this.isValidColor(I.r,I.g,I.b)&&(x.originalHsPos={u:E,v:M})}})}adjustPointForNewLightness(t,n){const s=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(s.r,s.g,s.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}handleSliderPointDrag(t,n,s,i,o){const{offsets:r}=this.state.activeDrag,a=Math.ceil(Fe*2.2),d=Math.ceil(rt/2),l=a+d;i.width-a,i.height-a;const c=this.findSnapPosition(s,i.height,o,t.id),h=l,f=i.width-a,u=l,p=i.height-a,g=f-h,y=p-u,m=(c-u)/y,x=Math.max(0,Math.min(1,1-m));let S=(n-h)/g,v=S;this.state.isCyclic?(S<0?v=1+S:S>1&&(v=S-1),v=this.wrapPositionCyclic(v)):v=Math.max(0,Math.min(1,S));for(const b of this.state.points)if(r.has(b.id)){const T=r.get(b.id),_=x+T[o];let C=v+T.pos;if(this.state.isCyclic?C=this.wrapPositionCyclic(C):C=Math.max(0,Math.min(1,C)),b.pos=C,o==="lightness"){const E=Math.max(0,Math.min(1,_));b.lightness=E;const M=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,E);if(this.isValidColor(M.r,M.g,M.b))b.hsPos={...b.originalHsPos};else{const I=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,E);b.hsPos.u=I.u,b.hsPos.v=I.v}this.state.viewLightness=E}else b.alpha=Math.max(0,Math.min(1,_)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const dd=[5,4],xa=16,hd=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],ol=e=>{const t=[{power:3,value:e[0]},{power:2,value:e[1]},{power:1,value:e[2]},{power:0,value:e[3]}],n=s=>Number(s.toFixed(6));return t.filter(s=>Math.abs(s.value)>1e-10).map((s,i)=>{const o=s.value<0?"-":"+",r=Math.abs(s.value),a=n(r),d=s.power===0?"":`t^${s.power}`,l=s.power===0?`${a}`:`${a}${d}`;return i===0?s.value<0?`-${l}`:`${l}`:`${o} ${l}`}).join(" ").replace(/t\^1\b/g,"t")},fd=(e,t,n,s,i)=>{const o=[t.x,n.x,s.x,i.x],r=[t.y,n.y,s.y,i.y],a=e.map(l=>l.reduce((c,h,f)=>c+h*o[f],0)),d=e.map(l=>l.reduce((c,h,f)=>c+h*r[f],0));return{x:a,y:d}},ud=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),r=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],a=t?n:n-1,d=[];for(let l=0;l<a;l++)d.push({index:l,p0:r(l-1),p1:r(l),p2:r(l+1),p3:r(l+2)});return d};function gd(e,t=!1,n=xa){if(e.length<2)return e;const s=[],i=e.length,o=t?i:i-1;for(let r=0;r<o;r++){const a=e[r],d=e[(r+1)%i],l=r===0?0:1;for(let c=l;c<=n;c++){const h=c/n;s.push({x:a.x+(d.x-a.x)*h,y:a.y+(d.y-a.y)*h})}}return s}const cn=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},Li=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),pd=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},ws=(e,t,n,s,i,o,r,a=null)=>{const d=i*.5;if(d<=1e-6)return;const l={x:d,y:d},c=Math.PI,h=-Math.PI/2,f=pd(c,h),u=Math.max(2,o);for(let p=r?0:1;p<=u;p++){const g=p/u,y=c+f*g,m={x:l.x+Math.cos(y)*d,y:l.y+Math.sin(y)*d},x={x:t.x+n.x*m.x+s.x*m.y,y:t.y+n.y*m.x+s.y*m.y};a?a(x):e.push(x)}};function il(e,t=!1,n="relative",s=0,i=xa,o=!1,r=!1,a=!1,d=!1){if(e.length<2)return e;if(s<=1e-6)return t?[...e,e[0]]:[...e];const l=e.length,c=[],h=[],f=n==="fixed"?"absolute":n,u=f==="absolute"?"relative":f,p=v=>{const b=e[(v-1+l)%l],T=e[v],_=e[(v+1)%l],C=Li(b,T),E=Li(_,T),M=Math.hypot(C.x,C.y),I=Math.hypot(E.x,E.y);if(M<=1e-6||I<=1e-6)return null;let w,L,P;const A=Math.min(M,I)*.5;if(u==="absolute"?(w=Math.max(0,Math.min(1,s)),L=cn(E),P=cn(C)):(f==="absolute"?w=Math.max(0,Math.min(s,A))*2:w=Math.max(0,Math.min(1,s)),L=f==="absolute"?cn(E):E,P=f==="absolute"?cn(C):C),w<=1e-6)return null;const R=w*.5,O=a?-R:f==="absolute"?M*.5:.5,$=a?-R:f==="absolute"?I*.5:.5,F={x:T.x+P.x*O,y:T.y+P.y*O},V={x:T.x+L.x*$,y:T.y+L.y*$},B=cn(P),D=cn(L),N={x:B.x+D.x,y:B.y+D.y},k=Math.hypot(N.x,N.y),Y=k>1e-6?{x:N.x/k,y:N.y/k}:{x:0,y:0},X=f==="absolute"?R:R*Math.min(M,I),z={x:T.x-Y.x*(X/Math.sqrt(2)),y:T.y-Y.y*(X/Math.sqrt(2))},G={x:-B.y,y:B.x},W={x:-D.y,y:D.x},H=G.x*Y.x+G.y*Y.y<0?{x:-G.x,y:-G.y}:G,q=W.x*Y.x+W.y*Y.y<0?{x:-W.x,y:-W.y}:W,K=(f==="absolute"?R:R*M)/Math.sqrt(2),ne=(f==="absolute"?R:R*I)/Math.sqrt(2),he={x:T.x+B.x*(M*.5)+H.x*K,y:T.y+B.y*(M*.5)+H.y*K},ae={x:T.x+D.x*(I*.5)+q.x*ne,y:T.y+D.y*(I*.5)+q.y*ne},se={x:T.x+P.x*R,y:T.y+P.y*R},Q={x:T.x+L.x*R,y:T.y+L.y*R};return{index:v,origin:T,axisX:L,axisY:P,baseScale:w,radius:R,edgeInIndex:(v-1+l)%l,edgeOutIndex:v,midIn:F,midOut:V,arcStart:se,arcEnd:Q,bisectorOuter:z,midInOrtho:he,midOutOrtho:ae}},g=(v,b=null,T=null)=>{if(!d){c.push({x:v.x,y:v.y});return}c.push({x:v.x,y:v.y,tag:b||void 0,edgeIndex:T??void 0})},y=v=>g(v,"arc"),m=(v,b)=>{!a||v.radius<=1e-6||(b?(g(v.midInOrtho,"line",v.edgeInIndex),g(v.bisectorOuter,"corner")):(g(v.bisectorOuter,"corner"),g(v.midOutOrtho,"line",v.edgeOutIndex)))};if(t){for(let b=0;b<l;b++){const T=p(b);T&&h.push(T)}if(!h.length)return[...e,e[0]];if(a){const b=h[0];g(b.arcStart,"line",b.edgeInIndex),ws(c,b.origin,b.axisX,b.axisY,b.baseScale,i,!1,y);for(let T=1;T<h.length;T++){const _=h[T];g(_.arcStart,"line",_.edgeInIndex),ws(c,_.origin,_.axisX,_.axisY,_.baseScale,i,!1,y)}return g({...b.arcStart},"line",b.edgeInIndex),c}const v=h[0];return g(v.midIn,"line",v.edgeInIndex),m(v,!0),h.forEach((b,T)=>{T>0&&(g(b.midIn,"line",b.edgeInIndex),m(b,!0)),ws(c,b.origin,b.axisX,b.axisY,b.baseScale,i,!0,y),m(b,!1),g(b.midOut,"line",b.edgeOutIndex),g(b.origin,"corner")}),g({...v.midIn},"line",v.edgeInIndex),c}if(u==="absolute"){for(let T=1;T<l-1;T++){const _=p(T);_&&h.push(_)}if(!h.length)return[...e];const v=h[0];g(e[0],"line",0),v&&g(v.midIn,"line",v.edgeInIndex),m(v,!0),h.forEach((T,_)=>{_>0&&(g(T.midIn,"line",T.edgeInIndex),m(T,!0)),ws(c,T.origin,T.axisX,T.axisY,T.baseScale,i,!0,y),m(T,!1),g(T.midOut,"line",T.edgeOutIndex)});const b=h[h.length-1];return b&&g(b.midOut,"line",b.edgeOutIndex),g(e[l-1],"line",l-2),c}if(a){for(let b=1;b<l-1;b++){const T=p(b);T&&h.push(T)}if(!h.length)return[...e];g(e[0],"line",0);const v=h[0];g(v.arcStart,"line",v.edgeInIndex),ws(c,v.origin,v.axisX,v.axisY,v.baseScale,i,!1,y);for(let b=1;b<h.length;b++){const T=h[b];g(T.arcStart,"line",T.edgeInIndex),ws(c,T.origin,T.axisX,T.axisY,T.baseScale,i,!1,y)}return g(e[l-1],"line",l-2),c}for(let v=1;v<l-1;v++){const b=p(v);b&&h.push(b)}if(!h.length)return[...e];const x=h[0],S=h[h.length-1];return g(e[0],"line",0),g(x.midIn,"line",x.edgeInIndex),h.forEach((v,b)=>{b>0&&g(v.midIn,"line",v.edgeInIndex),m(v,!0),ws(c,v.origin,v.axisX,v.axisY,v.baseScale,i,!0,y),m(v,!1),g(v.midOut,"line",v.edgeOutIndex)}),g(S.midOut,"line",S.edgeOutIndex),g(e[l-1],"line",l-2),c}function yd(e,t=!1,n="relative",s=0){if(e.length<3)return[];if(s<=1e-6)return[];const i=e.length,o=[],r=n==="fixed"?"absolute":n,a=r==="absolute"?"relative":r,d=t?i:i-1;for(let l=1;l<d;l++){const c=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=Li(c,h),p=Li(f,h),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)continue;const m=Math.min(g,y)*.5;let x,S,v;if(a==="absolute"){const Y=Math.min(g,y);x=Math.max(0,Math.min(s,Y*.5))*2,S=cn(p),v=cn(u)}else x=r==="absolute"?Math.max(0,Math.min(s,m))*2:Math.max(0,Math.min(1,s)),S=r==="absolute"?cn(p):p,v=r==="absolute"?cn(u):u;if(x<=1e-6)continue;const b=x*.5,T=cn(v),_=cn(S),C={x:T.x+_.x,y:T.y+_.y},E=Math.hypot(C.x,C.y),M=E>1e-6?{x:C.x/E,y:C.y/E}:{x:0,y:0},I=r==="absolute"?b:b*Math.min(g,y),w=t?(()=>{let Y=0;for(let X=0;X<i;X++){const z=e[X],G=e[(X+1)%i];Y+=z.x*G.y-G.x*z.y}return Y})():1,L=(h.x-c.x)*(f.y-h.y)-(h.y-c.y)*(f.x-h.x),A=(w>=0?L>=0:L<=0)?-1:1,R={x:h.x+M.x*I*A,y:h.y+M.y*I*A},O={x:-T.y,y:T.x},$={x:-_.y,y:_.x},F=O.x*M.x+O.y*M.y<0?{x:-O.x,y:-O.y}:O,V=$.x*M.x+$.y*M.y<0?{x:-$.x,y:-$.y}:$,B=(r==="absolute"?b:b*g)/Math.sqrt(2),D=(r==="absolute"?b:b*y)/Math.sqrt(2),N={x:h.x+T.x*(g*.5)+F.x*B,y:h.y+T.y*(g*.5)+F.y*B},k={x:h.x+_.x*(y*.5)+V.x*D,y:h.y+_.y*(y*.5)+V.y*D};o.push(R,N,k)}return o}function rl(e,t=.5,n=!1,s=xa,i={}){if(e.length<2)return e;const o=[],r=Math.max(0,Math.min(1,t)),a=(1-r)*.5,d=hd(a),l=i?.logSegments??!1,c=i?.label??"Catmull-Rom",h=(u,p,g,y,m)=>{const x=m*m,S=x*m,v=2*S-3*x+1,b=S-2*x+m,T=-2*S+3*x,_=S-x;return{x:v*u.x+b*g.x+T*p.x+_*y.x,y:v*u.y+b*g.y+T*p.y+_*y.y}};return ud(e,n).forEach(({index:u,p0:p,p1:g,p2:y,p3:m})=>{if(l){const b=fd(d,p,g,y,m);console.groupCollapsed(`${c} segment ${u}`),console.log("Matrix M (rows t^3,t^2,t,1; cols P0..P3):",d),console.log("P0..P3:",p,g,y,m),console.log(`tension: ${r}, tau: ${a}`),console.log("P(t) = [t^3 t^2 t 1] * M * [P0 P1 P2 P3]"),console.log(`x(t) = ${ol(b.x)}`),console.log(`y(t) = ${ol(b.y)}`),console.groupEnd()}const x=u===0?0:1,S={x:(y.x-p.x)*a,y:(y.y-p.y)*a},v={x:(m.x-g.x)*a,y:(m.y-g.y)*a};for(let b=x;b<=s;b++){const T=b/s;o.push(h(g,y,S,v,T))}}),o}const md={id:null,preset:"closed",type:"spline",mode:"piecewise",order:3,tension:.5,radiusMode:"absolute",radiusValue:.5,relRadiusValue:.5,absRadiusValue:.5,linearStyle:"lines",nurbsDegree:3,pointHandling:"anchor"},cr=500,Zs=e=>Math.max(0,Math.min(1,e)),Hl=e=>Math.max(0,Math.min(cr,e)),mi=e=>{const t=Zs(Number(e)||0);return t*t*cr},al=e=>{const t=Hl(Number(e)||0);return Math.sqrt(t/cr)},ll=[{id:"closed",label:"Closed"},{id:"open",label:"Open"},{id:"figure8",label:"Figure 8"},{id:"branching",label:"Branching"},{id:"branching4",label:"Branching (4)"},{id:"branching5",label:"Branching (5)"}],xd=[{id:"linear",label:"Linear"},{id:"spline",label:"Spline"},{id:"radius",label:"Radius"}];class Sd{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:this._createStyle(),previewPoints:this._createDefaultPresetPoints()},this.wrapper=null,this.elements={},this.previewCards=new Map,this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this._renderAllPreviews())}show(t=null){this.state.style=this._normalizeStyle(t),this._updateUIFromState(),this.wrapper.style.display="block",requestAnimationFrame(()=>{this._renderAllPreviews()})}hide(){this.wrapper&&(this.wrapper.style.display="none")}_createStyle(){return{...md,id:`style_${Date.now()}`}}_normalizeStyle(t){const n=this._createStyle();if(!t)return n;const i=Number(t.order)===3?3:1;let o=t.type==="px_radius"?"abs_radius":t.type,r=t.radiusMode==="fixed"?"absolute":t.radiusMode,a=t.pointHandling;o==="cubic_spline"?(o="spline",a="anchor"):o==="circular_arc"?o="radius":o==="linear"&&(o="linear"),o==="catmull"?(o="spline",a="anchor"):o==="nurbs"?(o="spline",a="control"):o==="linear"?(o="spline",a="anchor"):o==="rel_radius"?(o="radius",r="relative"):o==="abs_radius"&&(o="radius",r="absolute");const d=t.relRadiusValue??(r==="relative"?Zs(t.radiusValue):n.relRadiusValue),l=t.absRadiusValue??(r==="absolute"?al(t.radiusValue):n.absRadiusValue),c=r==="relative"?d:mi(l);return o||(t.mode==="radius"?o="radius":i===3&&t.tension!==void 0?(o="spline",a="anchor"):i===3?o="spline":(o="spline",a="anchor")),{...n,...t,id:t.id||n.id,preset:t.preset||n.preset,order:i,type:o||n.type,radiusMode:r||n.radiusMode,radiusValue:c,relRadiusValue:d,absRadiusValue:l,linearStyle:t.linearStyle||n.linearStyle,nurbsDegree:t.nurbsDegree||n.nurbsDegree,pointHandling:o==="spline"?"anchor":a??t.pointHandling??n.pointHandling}}_createDefaultPresetPoints(){const t={x:.6,y:.25},n={x:.55,y:.45},s={x:.55,y:.5},i=[{x:.2,y:.2},{x:.8,y:.25},{x:.7,y:.6},{x:.5,y:.45},{x:.3,y:.75}],o=[{x:.05,y:.8},{x:.25,y:.4},{x:.45,y:.7},{x:.65,y:.2},{x:.85,y:.55}],r=[{x:.72,y:.5},{x:.61,y:.31},{x:.39,y:.31},{x:.28,y:.5},{x:.39,y:.69},{x:.61,y:.69},{x:.5,y:.5}];return{closed:{vertices:i,edges:i.map((a,d)=>[d,(d+1)%i.length])},open:{vertices:o,edges:o.slice(0,-1).map((a,d)=>[d,d+1])},figure8:{vertices:r,edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0],[0,6],[6,3]],faces:[[0,1,2,3,4,5]]},branching:[[{x:.1,y:.85},{x:.3,y:.6},{x:.5,y:.4},t],[t,{x:.75,y:.15},{x:.9,y:.1}],[t,{x:.75,y:.35},{x:.9,y:.45}]],branching4:{in:[[{x:.12,y:.15},{x:.32,y:.3},n],[{x:.18,y:.75},{x:.35,y:.58},n]],out:[[n,{x:.75,y:.25},{x:.92,y:.2}],[n,{x:.75,y:.6},{x:.9,y:.72}]]},branching5:{in:[[{x:.1,y:.25},{x:.32,y:.38},s],[{x:.18,y:.8},{x:.35,y:.64},s]],out:[[s,{x:.78,y:.25},{x:.92,y:.2}],[s,{x:.78,y:.5},{x:.92,y:.52}],[s,{x:.78,y:.78},{x:.9,y:.85}]]}}}_initializeDOM(){const t=(_,C={})=>{const E=document.createElement(_);if(C.id){E.id=C.id;const M=C.id.replace(/-(\w)/g,(I,w)=>w.toUpperCase());this.elements[M]=E}return C.className&&(E.className=C.className),C.text&&(E.textContent=C.text),C.type&&(E.type=C.type),C.value!==void 0&&(E.value=C.value),C.attrs&&Object.entries(C.attrs).forEach(([M,I])=>E.setAttribute(M,I)),E};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"interpolation-editor-layout"}),s=t("div",{className:"editor-panel preview-panel"});s.append(t("div",{className:"panel-header",text:"Preview Presets"}));const i=t("div",{className:"preview-list"});ll.forEach(_=>{const C=t("button",{className:"preview-card",attrs:{"data-preset":_.id,type:"button"}}),E=t("div",{className:"preview-card-label",text:_.label}),M=t("canvas",{className:"preview-card-canvas"});C.append(M,E),i.append(C),this.previewCards.set(_.id,{card:C,canvas:M})}),s.append(i);const o=t("div",{className:"editor-panel type-panel"});o.append(t("div",{className:"panel-header",text:"Interpolation Type"}));const r=t("div",{className:"toggle-stack",id:"type-list"});xd.forEach(_=>{const C=t("button",{className:"toggle-row",text:_.label,attrs:{"data-type":_.id,type:"button"}});r.append(C)}),o.append(r);const a=t("div",{className:"editor-panel params-panel"});a.append(t("div",{className:"panel-header",text:"Parameters"}));const d=t("div",{className:"param-section",id:"tension-section"});d.append(t("div",{className:"section-caption",text:"Catmull-Rom tension."}));const l=t("div",{className:"param-row"});this.elements.tensionSlider=t("input",{id:"tension-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.tensionInput=t("input",{id:"tension-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),l.append(this.elements.tensionSlider,this.elements.tensionInput),d.append(l);const c=t("div",{className:"param-section",id:"linear-section"});c.append(t("div",{className:"section-caption",text:"Linear marker style."}));const h=t("div",{className:"param-row"}),f=t("div",{className:"toggle-group",id:"linear-style-toggle"});f.append(t("button",{className:"toggle-button",text:"Lines",attrs:{"data-linear-style":"lines",type:"button"}}),t("button",{className:"toggle-button",text:"Arrows",attrs:{"data-linear-style":"arrows",type:"button"}})),h.append(f),c.append(h);const u=t("div",{className:"param-section",id:"handling-section"});u.append(t("div",{className:"section-caption",text:"Point handling."}));const p=t("div",{className:"param-row"}),g=t("div",{className:"toggle-group",id:"point-handling-toggle"});g.append(t("button",{className:"toggle-button",text:"Control",attrs:{"data-point-handling":"control",type:"button"}}),t("button",{className:"toggle-button",text:"Anchor",attrs:{"data-point-handling":"anchor",type:"button"}}),t("button",{className:"toggle-button",text:"Mixed",attrs:{"data-point-handling":"mixed",type:"button"}})),p.append(g),u.append(p);const y=t("div",{className:"param-section",id:"radius-section"});y.append(t("div",{className:"section-caption",text:"Clamped to half each adjacent edge."}));const m=t("div",{className:"param-row"});this.elements.radiusSlider=t("input",{id:"radius-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.radiusInput=t("input",{id:"radius-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),m.append(this.elements.radiusSlider,this.elements.radiusInput),y.append(m);const x=t("div",{className:"toggle-group",id:"radius-mode-toggle"});x.append(t("button",{className:"toggle-button",text:"Relative",attrs:{"data-radius-mode":"relative",type:"button"}}),t("button",{className:"toggle-button",text:"Absolute",attrs:{"data-radius-mode":"absolute",type:"button"}})),y.append(x);const S=t("div",{className:"param-section",id:"nurbs-section"});S.append(t("div",{className:"section-caption",text:"NURBS degree."}));const v=t("div",{className:"param-row"});this.elements.nurbsDegreeSlider=t("input",{id:"nurbs-degree-slider",type:"range",attrs:{min:"2",max:"5",step:"1"}}),this.elements.nurbsDegreeInput=t("input",{id:"nurbs-degree-input",type:"number",attrs:{min:"2",max:"5",step:"1"}}),v.append(this.elements.nurbsDegreeSlider,this.elements.nurbsDegreeInput),S.append(v),a.append(c,u,d,y,S);const b=t("div",{className:"editor-panel actions-panel"});b.append(t("div",{className:"panel-header",text:"Actions"}));const T=t("div",{className:"button-row"});this.elements.closeButton=t("button",{id:"close-button",className:"editor-button secondary",text:"Close",attrs:{type:"button"}}),this.elements.selectButton=t("button",{id:"select-button",className:"editor-button primary",text:"Select",attrs:{type:"button"}}),T.append(this.elements.closeButton,this.elements.selectButton),b.append(T),n.append(s,o,a,b),this.wrapper.append(n),this.container.appendChild(this.wrapper)}_setupEventListeners(){window.addEventListener("resize",()=>{this.wrapper&&this.wrapper.style.display!=="none"&&this._renderAllPreviews()}),this.previewCards.forEach((o,r)=>{o.card.addEventListener("click",()=>{this._setStyle({preset:r})}),o.canvas.addEventListener("mousedown",a=>{this._handlePreviewMouseDown(a,r)})}),this.wrapper.querySelector("#type-list").querySelectorAll(".toggle-row").forEach(o=>{o.addEventListener("click",()=>{this._applyTypeSelection(o.dataset.type)})}),this.wrapper.querySelector("#linear-style-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({linearStyle:o.dataset.linearStyle})})}),this.wrapper.querySelector("#point-handling-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({pointHandling:o.dataset.pointHandling})})}),this.elements.radiusSlider.addEventListener("input",o=>{const r=Number(o.target.value);this._applyRadiusValue(r,!0)}),this.elements.radiusInput.addEventListener("change",o=>{const r=Number(o.target.value);this._applyRadiusValue(r,!1)}),this.wrapper.querySelector("#radius-mode-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._applyRadiusMode(o.dataset.radiusMode)})}),this.elements.tensionSlider.addEventListener("input",o=>{const r=Number(o.target.value);this._applyTensionValue(r,!0)}),this.elements.tensionInput.addEventListener("change",o=>{const r=Number(o.target.value);this._applyTensionValue(r,!1)}),this.elements.nurbsDegreeSlider.addEventListener("input",o=>{const r=Number(o.target.value);this._applyNurbsDegreeValue(r,!0)}),this.elements.nurbsDegreeInput.addEventListener("change",o=>{const r=Number(o.target.value);this._applyNurbsDegreeValue(r,!1)}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{this.onSelect(this._exportStyleForHost()),this.hide()}),window.addEventListener("mousemove",o=>{this._handlePreviewMouseMove(o)}),window.addEventListener("mouseup",()=>{this._handlePreviewMouseUp()})}_setStyle(t){this.state.style={...this.state.style,...t},this._updateUIFromState(),this._renderAllPreviews()}_exportStyleForHost(){const{id:t,name:n,type:s,tension:i,radiusMode:o,radiusValue:r,pointHandling:a,order:d,preset:l,mode:c,linearStyle:h}=this.state.style,f={id:t,name:n,order:d,preset:l,mode:c,linearStyle:h};return s==="spline"?{...f,type:"cubic_spline",cornerHandling:"pass_through",tension:Number(i??.5)}:s==="radius"?{...f,type:"circular_arc",cornerHandling:a==="mixed"?"mixed":"cut_all",radiusMode:o,radiusValue:r}:{...f,type:"linear",cornerHandling:"pass_through"}}_applyRadiusValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};if(s.radiusMode==="relative"){const i=Zs(t);s.radiusValue=i,s.relRadiusValue=i}else{const i=n?Zs(t):al(t);s.absRadiusValue=i,s.radiusValue=mi(i)}this.state.style=s,n?this.elements.radiusInput.value=s.radiusValue.toFixed(s.radiusMode==="absolute"?0:2):this.elements.radiusSlider.value=s.radiusMode==="absolute"?s.absRadiusValue:s.radiusValue,this._updateUIFromState(),this._renderAllPreviews()}_applyTensionValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.tension=Math.max(0,Math.min(1,t)),this.state.style=s,n?this.elements.tensionInput.value=s.tension.toFixed(2):this.elements.tensionSlider.value=s.tension,this._updateUIFromState(),this._renderAllPreviews()}_applyRadiusMode(t){if(t!=="relative"&&t!=="absolute")return;const n={...this.state.style};n.radiusMode=t,t==="relative"?n.radiusValue=n.relRadiusValue??n.radiusValue:n.radiusValue=mi(n.absRadiusValue??n.radiusValue),this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_applyNurbsDegreeValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.nurbsDegree=Math.max(2,Math.min(5,Math.round(t))),this.state.style=s,n?this.elements.nurbsDegreeInput.value=s.nurbsDegree:this.elements.nurbsDegreeSlider.value=s.nurbsDegree,this._updateUIFromState()}_applyTypeSelection(t){const n={...this.state.style,type:t};switch(t){case"linear":n.mode="piecewise",n.order=1,n.pointHandling="anchor";break;case"spline":n.mode="piecewise",n.order=3,n.pointHandling="anchor";break;case"radius":n.mode="radius",n.radiusMode=n.radiusMode||"relative",n.radiusValue=n.radiusMode==="relative"?n.relRadiusValue??n.radiusValue:mi(n.absRadiusValue??n.radiusValue),n.pointHandling=n.pointHandling==="mixed"?"mixed":"control";break}this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_updateUIFromState(){const{preset:t,mode:n,order:s,radiusMode:i,radiusValue:o,tension:r,type:a,linearStyle:d,nurbsDegree:l,pointHandling:c}=this.state.style;this.previewCards.forEach((y,m)=>{y.card.classList.toggle("is-active",m===t)}),this.wrapper.querySelectorAll("#type-list .toggle-row").forEach(y=>{y.classList.toggle("is-active",y.dataset.type===a)}),this.wrapper.querySelectorAll("#linear-style-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.linearStyle===d)}),this.wrapper.querySelectorAll("#point-handling-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.pointHandling===c)});const h=this.wrapper.querySelector("#linear-section"),f=this.wrapper.querySelector("#handling-section"),u=this.wrapper.querySelector("#tension-section"),p=this.wrapper.querySelector("#radius-section"),g=this.wrapper.querySelector("#nurbs-section");h.classList.toggle("is-hidden",a!=="linear"),f.classList.toggle("is-hidden",!0),u.classList.toggle("is-hidden",a!=="spline"),p.classList.toggle("is-hidden",a!=="radius"),g.classList.toggle("is-hidden",!0),this.wrapper.querySelectorAll("#radius-mode-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.radiusMode===i)}),i==="absolute"?(this.elements.radiusSlider.value=Zs(this.state.style.absRadiusValue),this.elements.radiusInput.value=Hl(o).toFixed(0),this.elements.radiusInput.min="0",this.elements.radiusInput.max=String(cr),this.elements.radiusInput.step="1"):(this.elements.radiusSlider.value=Zs(o),this.elements.radiusInput.value=Number(this.elements.radiusSlider.value).toFixed(2),this.elements.radiusInput.min="0",this.elements.radiusInput.max="1",this.elements.radiusInput.step="0.01"),this.elements.tensionSlider.value=Math.max(0,Math.min(1,r)),this.elements.tensionInput.value=Number(r).toFixed(2),this.elements.nurbsDegreeSlider.value=l,this.elements.nurbsDegreeInput.value=l}_renderAllPreviews(){ll.forEach(t=>{const n=this.previewCards.get(t.id);n&&this._renderPreviewCard(n.canvas,t.id,t.id===this.state.style.preset)})}_renderPreviewCard(t,n,s){const i=t.getBoundingClientRect(),o=window.devicePixelRatio||1,r=Math.max(1,Math.floor(i.width*o)),a=Math.max(1,Math.floor(i.height*o));(t.width!==r||t.height!==a)&&(t.width=r,t.height=a);const d=t.getContext("2d");d.save(),d.scale(o,o),d.clearRect(0,0,i.width,i.height),d.fillStyle="#1f2937",d.fillRect(0,0,i.width,i.height),this._drawPreset(d,i.width,i.height,n,s),d.restore()}_drawPreset(t,n,s,i,o){const a=n-32,d=s-32,l=I=>({x:16+I.x*a,y:16+I.y*d}),c=this._getPresetPoints(i),h=o?"#3b82f6":"#6b7280",f=o?"#60a5fa":"#94a3b8";t.lineWidth=this._getStrokeWidth(),t.lineJoin=this.state.style.mode==="radius"?"round":"miter",t.lineCap="round",t.strokeStyle=h;const u=[],p=new Set,g=new Set,y=I=>{p.has(I)||(p.add(I),u.push(I))},m=this.state.style.mode==="radius"&&i==="branching",x=(I,w,L)=>{const P=L.x-w.x,A=L.y-w.y,R=I.x-w.x,O=I.y-w.y,$=P*P+A*A;return $<1e-6?0:(R*P+O*A)/$},S=I=>{if(!I)return 0;const w=Math.hypot(I.b.x-I.a.x,I.b.y-I.a.y);return w<=1e-6?0:this.state.style.radiusMode==="relative"?Math.max(0,Math.min(.5,this.state.style.radiusValue*.5)):Math.max(0,Math.min(.5,this.state.style.radiusValue/w))},v=(I,w,L,P,A)=>{if(I.length<3||!P)return I;const R=S(P),O=L?A?0:.5:R,$=L?1-R:A?1:.5,F=I.filter(V=>{if(V.tag==="line"&&V.edgeIndex!==void 0){if(V.edgeIndex!==w)return!0;const B=x(V,P.a,P.b);return B>=O&&B<=$}return V.tag!=="line"});return F.length>=2,F},b=c.faces&&c.vertices?c.vertices:null,T=c.faces||null,_=!!(b&&T&&T.length);let C=null,E=null;const M=Math.hypot(a,d);if(c.paths.forEach((I,w)=>{const L=I.points,P=L.map(l);if(L.forEach(y),w===0&&i==="closed"&&(console.groupCollapsed("anchor-control-debug"),console.log("mode",this.state.style.mode),console.log("type",this.state.style.type),console.log("pointHandling",this.state.style.pointHandling),console.log("radiusMode",this.state.style.radiusMode),console.log("radiusValue",this.state.style.radiusValue)),P.length>=2){t.save(),t.lineWidth=Math.max(1,this._getStrokeWidth()*.6),t.strokeStyle="#94a3b8",t.lineCap="round",t.lineJoin="round",t.setLineDash(dd);const R=[];for(let O=0;O<P.length-1;O++)m&&i==="branching"&&w===0&&O===P.length-2||R.push([P[O],P[O+1]]);I.closed&&R.push([P[P.length-1],P[0]]),R.forEach(([O,$])=>{const F=Math.round(O.x),V=Math.round(O.y),B=Math.round($.x),D=Math.round($.y),N=`${F}:${V}`,k=`${B}:${D}`,Y=N<k?`${N}|${k}`:`${k}|${N}`;g.has(Y)||(g.add(Y),t.beginPath(),t.moveTo(O.x,O.y),t.lineTo($.x,$.y),t.stroke())}),t.restore()}let A=this._getInterpolatedPoints(P,I.closed,M);if(A.length<2){w===0&&i==="closed"&&(console.log("drawPoints empty"),console.groupEnd());return}if(w===0&&i==="closed"){const R=A.reduce(($,F)=>({x:Math.min($.x,F.x),y:Math.min($.y,F.y)}),{x:1/0,y:1/0}),O=A.reduce(($,F)=>({x:Math.max($.x,F.x),y:Math.max($.y,F.y)}),{x:-1/0,y:-1/0});console.log("drawPoints bounds",{min:R,max:O}),console.groupEnd()}if(m){const R=6+this.state.style.order*4,O=this.state.style.pointHandling==="control";A=il(P,I.closed,this.state.style.radiusMode,this.state.style.radiusValue,R,!1,!1,O,!0);const $=I.trueEndpointStart===!0,F=I.trueEndpointEnd===!0;if(w===0){const V=P.length>=2?{a:P[0],b:P[1]}:null;A=v(A,0,!0,V,$);const B=P.length>=2?{a:P[P.length-2],b:P[P.length-1]}:null;A=v(A,P.length-2,!1,B,F)}else{const V=P.length>=2?{a:P[0],b:P[1]}:null,B=P.length>=2?{a:P[P.length-2],b:P[P.length-1]}:null;A=v(A,0,!0,V,$),A=v(A,P.length-2,!1,B,F)}if(A.length<2)return;A=A.map(V=>({x:V.x,y:V.y}))}if(this.state.style.mode!=="radius"&&(this.state.style.type!=="spline"||I.forceTrim)){if(I.trimFromPoint){const R=l(I.trimFromPoint);let O=0,$=1/0;A.forEach((F,V)=>{const B=Math.hypot(F.x-R.x,F.y-R.y);B<$&&($=B,O=V)}),A=A.slice(O),!A.length||Math.hypot(A[0].x-R.x,A[0].y-R.y)>1e-6?A.unshift(R):A[0]=R}if(I.trimToPoint){const R=l(I.trimToPoint);let O=0,$=1/0;A.forEach((F,V)=>{const B=Math.hypot(F.x-R.x,F.y-R.y);B<$&&($=B,O=V)}),A=A.slice(0,O+1),!A.length||Math.hypot(A[A.length-1].x-R.x,A[A.length-1].y-R.y)>1e-6?A.push(R):A[A.length-1]=R}}if(!(A.length<2)){if(t.beginPath(),t.moveTo(A[0].x,A[0].y),A.slice(1).forEach(R=>t.lineTo(R.x,R.y)),I.closed&&(this.state.style.mode!=="radius"||this.state.style.radiusValue<=1e-6)&&t.closePath(),t.stroke(),I.isBoundary&&I.closed?(C=A,E=new Set(L)):!_&&i==="closed"&&I.closed&&!Object.prototype.hasOwnProperty.call(I,"isBoundary")&&(C=A),this.state.style.mode==="radius"&&this.state.style.pointHandling==="anchor"){const R=yd(P,I.closed,this.state.style.radiusMode,this.state.style.radiusValue);R.length&&(t.save(),t.fillStyle="#f87171",R.forEach(O=>{t.beginPath(),t.arc(O.x,O.y,3,0,Math.PI*2),t.fill()}),t.restore())}this.state.style.type==="linear"&&this.state.style.linearStyle==="arrows"&&this._drawEdgeArrows(t,P,I.closed)}}),C&&C.length>=2&&(t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)",t.beginPath(),t.moveTo(C[0].x,C[0].y),C.slice(1).forEach(I=>t.lineTo(I.x,I.y)),t.closePath(),t.fill(),t.restore()),_){t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)";let I=!1;T.forEach(w=>{if(!Array.isArray(w)||w.length<3)return;const L=w.map(O=>b[O]).filter(Boolean);if(L.length<3)return;const P=E?L.every(O=>E.has(O)):!1;if(P&&C&&!I){t.beginPath(),t.moveTo(C[0].x,C[0].y),C.slice(1).forEach(O=>t.lineTo(O.x,O.y)),t.closePath(),t.fill(),I=!0;return}if(P&&C)return;const A=L.map(l),R=this._getInterpolatedPoints(A,!0,M);!R||R.length<2||(t.beginPath(),t.moveTo(R[0].x,R[0].y),R.slice(1).forEach(O=>t.lineTo(O.x,O.y)),t.closePath(),t.fill())}),t.restore()}t.fillStyle=f,u.map(l).forEach(I=>{t.beginPath(),t.arc(I.x,I.y,3.5,0,Math.PI*2),t.fill()})}_getStrokeWidth(){return 2}_drawEdgeArrows(t,n,s){if(n.length<2)return;const i=10,o=6,r=n.length,a=s?r:r-1;t.save(),t.fillStyle=t.strokeStyle;for(let d=0;d<a;d++){const l=n[d],c=n[(d+1)%r],h=c.x-l.x,f=c.y-l.y,u=Math.hypot(h,f);if(u<.001)continue;const p=h/u,g=f/u,y=c,m={x:y.x-p*i,y:y.y-g*i},x={x:m.x+-g*(o/2),y:m.y+p*(o/2)},S={x:m.x+g*(o/2),y:m.y-p*(o/2)};t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(x.x,x.y),t.lineTo(S.x,S.y),t.closePath(),t.fill()}t.restore()}_getInterpolatedPoints(t,n,s=1){const{mode:i,order:o,type:r,pointHandling:a,nurbsDegree:d,radiusMode:l,radiusValue:c}=this.state.style;if(i==="radius"||t.length<2){if(i==="radius"){const u=6+o*4,p=c;return p<=1e-6?t:il(t,n,l,p,u,!1,!1,a==="control")}return t}const h=4+o*4;if(r==="linear"||o===1)return gd(t,n,h);if(t.length<3)return t;const f=this.state.style.tension??.5;return rl(t,f,n,h)}_buildControlCatmullTargets(t,n){if(t.length<2)return t;const s=[],i=t.length,o=n?i:i-1;n||s.push(t[0]);for(let r=0;r<o;r++){const a=t[r],d=t[(r+1)%i];s.push({x:(a.x+d.x)*.5,y:(a.y+d.y)*.5})}return n||s.push(t[i-1]),s}_buildMixedCatmullTargets(t,n){if(t.length<2)return t;const s=this._getPathOrientation(t,n),i=[],o=t.length;for(let r=0;r<o;r++){if(!n&&(r===0||r===o-1)){i.push(t[r]);continue}const a=t[(r-1+o)%o],d=t[r],l=t[(r+1)%o],c=(d.x-a.x)*(l.y-d.y)-(d.y-a.y)*(l.x-d.x);(s>=0?c>=0:c<=0)?i.push(d):(i.push({x:(a.x+d.x)*.5,y:(a.y+d.y)*.5}),i.push({x:(d.x+l.x)*.5,y:(d.y+l.y)*.5}))}return i}_buildMixedControlPoints(t,n,s){if(t.length<3)return t;const i=this._getPathOrientation(t,n),o=Math.max(0,s-1),r=[];n?t.length:t.length-1;for(let a=0;a<t.length;a++){const d=(a-1+t.length)%t.length,l=(a+1)%t.length,c=t[d],h=t[a],f=t[l],u=(h.x-c.x)*(f.y-h.y)-(h.y-c.y)*(f.x-h.x),g=!n&&(a===0||a===t.length-1)||(i>=0?u>=0:u<=0);if(r.push(h),g)for(let y=0;y<o;y++)r.push({x:h.x,y:h.y})}return r}_getPathOrientation(t,n){if(!n)return 1;let s=0;for(let i=0;i<t.length;i++){const o=t[(i+1)%t.length];s+=t[i].x*o.y-o.x*t[i].y}return s}_getPresetPoints(t){const n=this.state.previewPoints[t];if(n&&n.vertices&&n.edges)return this._buildPathsFromGraph(n);if(t==="open")return{paths:this.state.previewPoints.open.map(s=>({closed:!1,points:s}))};if(t==="branching"){const s=this.state.previewPoints.branching[0]||[],i=s.length>=1?s[s.length-1]:null,o=s.length>=2?s[s.length-2]:null,r=this.state.style.type==="spline",a=r?s.slice(Math.max(0,s.length-3)):s.slice(Math.max(0,s.length-2));return{paths:this.state.previewPoints.branching.map((d,l)=>{if(l===0)return{closed:!1,points:d,trimToPoint:r?o:null,forceTrim:r,trueEndpointStart:!0,trueEndpointEnd:!1};const c=[...a],h=d[0],u=i&&h&&Math.abs(h.x-i.x)<1e-6&&Math.abs(h.y-i.y)<1e-6?d.slice(1):d;return c.push(...u),{closed:!1,points:c,trimFromPoint:r?o:i,forceTrim:r,trueEndpointStart:!1,trueEndpointEnd:!0}})}}if(t==="branching4"){const s=this.state.previewPoints.branching4;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[],r=c=>{const h=Math.hypot(c.x,c.y);return h>1e-6?{x:c.x/h,y:c.y/h}:{x:0,y:0}},a=i.map(c=>{if(c.length<2)return null;const h=c[c.length-1],f=c[c.length-2];return r({x:h.x-f.x,y:h.y-f.y})}),d=o.map(c=>{if(c.length<2)return null;const h=c[0],f=c[1];return r({x:f.x-h.x,y:f.y-h.y})});if(i.length!==1&&o.length!==1){const c=[];if(i.length===2&&o.length===2){const f=this.dragState?.presetId==="branching4"&&this.dragState.pointIndex!==null,u=M=>f?(this.branching4Pairing||(this.branching4Pairing=M),this.branching4Pairing):(this.branching4Pairing=null,M),p=a.map(M=>M?{x:-M.x,y:-M.y}:null),g=M=>Math.atan2(M.y,M.x),y=(M,I)=>{const w=p[M],L=d[I];return!w||!L?-1/0:w.x*L.x+w.y*L.y},m=(M,I)=>M.x*I.y-M.y*I.x,S=[{type:"in",idx:0,dir:p[0]},{type:"in",idx:1,dir:p[1]},{type:"out",idx:0,dir:d[0]},{type:"out",idx:1,dir:d[1]}].filter(M=>M.dir).slice().sort((M,I)=>g(M.dir)-g(I.dir)),v=S.map((M,I)=>M.type==="in"?I:null).filter(M=>M!==null),b=v.length===2&&(Math.abs(v[0]-v[1])===1||Math.abs(v[0]-v[1])===3),T=M=>y(0,M[0])+y(1,M[1]),_=[0,1],C=[1,0];let E=_;if(b){const M=(P,A)=>{const R=Math.abs(P-A);return Math.min(R,4-R)},I=P=>S.findIndex(A=>A.type==="out"&&A.idx===P),w=P=>S.findIndex(A=>A.type==="in"&&A.idx===P),L=P=>{const A=M(w(0),I(P[0])),R=M(w(1),I(P[1]));return A+R};E=L(C)>L(_)?C:_}else{const M=T(_),I=T(C);if(I===M&&this.state.style.type==="spline"){const w=L=>{const P=p[0]&&d[L[0]]?Math.sign(m(p[0],d[L[0]])):0,A=p[1]&&d[L[1]]?Math.sign(m(p[1],d[L[1]])):0;return(P<0?1:0)+(A<0?1:0)};E=w(C)>w(_)?C:_}else E=I>M?C:_}return E=u(E),i.forEach((M,I)=>{const w=E[I],L=o[w],P=L[0]===M[M.length-1]?L.slice(1):L;c.push({closed:!1,points:[...M,...P]})}),{paths:c}}const h=new Set;return i.forEach((f,u)=>{let p=-1,g=-1/0;const y=a[u];if(o.forEach((m,x)=>{if(h.has(x))return;const S=d[x];if(!y||!S)return;const v=y.x*S.x+y.y*S.y;v>g&&(g=v,p=x)}),p>=0){h.add(p);const m=o[p],x=m[0]===f[f.length-1]?m.slice(1):m;c.push({closed:!1,points:[...f,...x]})}else c.push({closed:!1,points:f})}),o.forEach((f,u)=>{h.has(u)||c.push({closed:!1,points:f})}),{paths:c}}const l=[];return i.length===1?o.forEach(c=>{const h=i[0],f=c[0]===h[h.length-1]?c.slice(1):c;l.push({closed:!1,points:[...h,...f]})}):i.forEach(c=>{const h=o[0],f=h[0]===c[c.length-1]?h.slice(1):h;l.push({closed:!1,points:[...c,...f]})}),{paths:l}}if(t==="branching5"){const s=this.state.previewPoints.branching5;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[];return{paths:[...i.map(a=>({closed:!1,points:a})),...o.map(a=>({closed:!1,points:a}))]}}return{paths:[{closed:!0,points:this.state.previewPoints.closed[0]}]}}_buildPathsFromGraph(t){const n=t.vertices||[],s=t.edges||[];if(!n.length||!s.length)return{paths:[]};const i=new Map,o=new Map,r=new Map;s.forEach(([D,N])=>{i.has(D)||i.set(D,[]),i.get(D).push(N),o.has(N)||o.set(N,[]),o.get(N).push(D),r.set(D,(r.get(D)||0)+1),r.set(N,(r.get(N)||0)+1)});const a=new Map,d=new Map,l=(D,N)=>D<N?`${D}-${N}`:`${N}-${D}`;s.forEach(([D,N])=>{const k=l(D,N);d.has(k)||d.set(k,[D,N]),a.has(D)||a.set(D,new Set),a.has(N)||a.set(N,new Set),a.get(D).add(N),a.get(N).add(D)});const c=(D,N)=>Math.atan2(n[N].y-n[D].y,n[N].x-n[D].x),h=new Map;n.forEach((D,N)=>{const k=[...a.get(N)||[]];k.sort((Y,X)=>c(N,Y)-c(N,X)),h.set(N,k)});const f=(D,N)=>{const k=h.get(N)||[];if(!k.length)return null;const Y=k.indexOf(D);return Y<0?k[0]:k[(Y-1+k.length)%k.length]},p=(()=>{const D=[],N=new Set,k=(Y,X)=>`${Y}->${X}`;return d.forEach(([Y,X])=>{[[Y,X],[X,Y]].forEach(([z,G])=>{const W=k(z,G);if(N.has(W))return;const H=[];let q=z,K=G,ne=0;for(;ne++<s.length*4;){N.add(k(q,K)),H.push(q);const he=f(q,K);if(he==null)break;const ae=K,se=he;if(q=ae,K=se,q===z&&K===G)break}H.length>=3&&D.push(H)})}),D})(),g=D=>[...D].sort((N,k)=>N-k).join("_"),y=[],m=new Set;p.forEach(D=>{const N=g(D);m.has(N)||(m.add(N),y.push(D))});const x=D=>{let N=0;for(let k=0;k<D.length;k++){const Y=n[D[k]],X=n[D[(k+1)%D.length]];N+=Y.x*X.y-X.x*Y.y}return N*.5};let S=null;if(y.length){let D=null,N=-1/0;y.forEach(k=>{const Y=Math.abs(x(k));Y>N&&(N=Y,D=k)}),S=D}const v=new Set(S||[]),b=new Set;if(S&&S.length>=2)for(let D=0;D<S.length;D++){const N=S[D],k=S[(D+1)%S.length];b.add(l(N,k))}const T=new Map,_=D=>Math.atan2(D.y,D.x),C=(D,N)=>D.x*N.y-D.y*N.x,E=(D,N)=>D.x*N.x+D.y*N.y,M=(D,N)=>({x:N.x-D.x,y:N.y-D.y}),I=D=>{const N=Math.hypot(D.x,D.y);return N>1e-6?{x:D.x/N,y:D.y/N}:{x:0,y:0}};n.forEach((D,N)=>{if(v.has(N))return;const k=o.get(N)||[],Y=i.get(N)||[];if(k.length===2&&Y.length===2){const X=k.map(te=>I(M(n[te],n[N]))),z=Y.map(te=>I(M(n[N],n[te]))),G=X.map(te=>({x:-te.x,y:-te.y})),W=(te,ce)=>E(G[te],z[ce]),H=[0,1],q=[1,0],K=W(0,0)+W(1,1),ne=W(0,1)+W(1,0),ae=[{type:"in",idx:0,dir:G[0]},{type:"in",idx:1,dir:G[1]},{type:"out",idx:0,dir:z[0]},{type:"out",idx:1,dir:z[1]}].filter(te=>te.dir).slice().sort((te,ce)=>_(te.dir)-_(ce.dir)),se=ae.map((te,ce)=>te.type==="in"?ce:null).filter(te=>te!==null),Q=se.length===2&&(Math.abs(se[0]-se[1])===1||Math.abs(se[0]-se[1])===3);let ee=H;if(Q){const te=(Se,ve)=>{const Qe=Math.abs(Se-ve);return Math.min(Qe,4-Qe)},ce=Se=>ae.findIndex(ve=>ve.type==="out"&&ve.idx===Se),fe=Se=>ae.findIndex(ve=>ve.type==="in"&&ve.idx===Se),Ee=Se=>{const ve=te(fe(0),ce(Se[0])),Qe=te(fe(1),ce(Se[1]));return ve+Qe};ee=Ee(q)>Ee(H)?q:H}else if(ne===K&&this.state.style.type==="spline"){const te=ce=>{const fe=Math.sign(C(G[0],z[ce[0]])),Ee=Math.sign(C(G[1],z[ce[1]]));return(fe<0?1:0)+(Ee<0?1:0)};ee=te(q)>te(H)?q:H}else ee=ne>K?q:H;k.forEach((te,ce)=>{const fe=Y[ee[ce]];T.set(`${te}->${N}`,fe)})}});const w=n.map((D,N)=>N).filter(D=>(o.get(D)||[]).length===0),L=[],P=new Set,A=(D,N)=>`${D}->${N}`,R=(D,N)=>b.has(l(D,N)),O=(D,N,k,Y=!1)=>{const X=A(D,N);if(P.has(X)){L.push([...k,N]);return}P.add(X);const z=[...k,N];if(!Y&&v.has(N)&&z.length>1){L.push(z);return}const G=i.get(N)||[],W=o.get(N)||[],H=T.get(`${D}->${N}`);if(H!==void 0){if(z.includes(H)){L.push(z);return}O(N,H,z);return}if(G.length===0){L.push(z);return}if(W.length===2&&G.length>2){L.push(z);return}if(W.length===1&&G.length>1){G.forEach(q=>{!Y&&R(N,q)||O(N,q,z,Y)});return}if(W.length<=1&&G.length===1){if(!Y&&R(N,G[0])){L.push(z);return}O(N,G[0],z,Y);return}G.forEach(q=>{!Y&&R(N,q)||O(N,q,z,Y)})};let $=null;if(S&&S.length>=3)$=[...S,S[0]],L.push($),s.forEach(([D,N])=>{R(D,N)&&P.add(A(D,N))}),s.forEach(([D,N])=>{const k=A(D,N);P.has(k)||O(D,N,[D],!1)});else if(w.length)w.forEach(D=>{(i.get(D)||[]).forEach(k=>O(D,k,[D]))});else{const D=s[0]?.[0];D!==void 0&&(i.get(D)||[]).forEach(k=>O(D,k,[D]))}const F=L.map(D=>{const N=D.length>2&&D[0]===D[D.length-1],k=N?D.slice(0,-1):D,Y=k.map(q=>n[q]),X=k[0],z=k[k.length-1],G=r.get(X)||0,W=r.get(z)||0,H=D===$;return{closed:N,points:Y,isBoundary:H,trueEndpointStart:G===1,trueEndpointEnd:W===1,trimFromPoint:!H&&this.state.style.type==="spline"&&G>2?n[X]:null,trimToPoint:!H&&this.state.style.type==="spline"&&W>2?n[z]:null,forceTrim:!H&&this.state.style.type==="spline"}}),V=S?g(S):null,B=y.filter(D=>g(D)!==V);return{paths:F,vertices:n,faces:B}}_handlePreviewMouseDown(t,n){const s=this._findHitPoint(t,n);s&&(this.dragState=s,t.preventDefault())}_handlePreviewMouseMove(t){const{presetId:n,pathIndex:s,pointIndex:i,vertexIndex:o,ioType:r,ioIndex:a}=this.dragState;if(n===null)return;const d=this.previewCards.get(n);if(!d)return;const{x:l,y:c}=this._getNormalizedPoint(t,d.canvas),h={x:Math.max(0,Math.min(1,l)),y:Math.max(0,Math.min(1,c))},f=this.state.previewPoints[n];if(f&&f.in&&f.out&&r&&Number.isInteger(a)){const x=f[r]?.[a]?.[i];x&&(x.x=h.x,x.y=h.y,this._renderAllPreviews());return}if(f&&f.vertices&&f.edges){Number.isInteger(o)&&f.vertices[o]&&(f.vertices[o].x=h.x,f.vertices[o].y=h.y,f.pathOverrides&&delete f.pathOverrides,this._renderAllPreviews());return}const p=(f&&f.vertices&&f.edges?f.pathOverrides?.map(y=>y.points):this.state.previewPoints[n])?.[s];if(!p)return;const g=p[i];g?(g.x=h.x,g.y=h.y):p[i]=h,this._renderAllPreviews()}_handlePreviewMouseUp(){this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}_findHitPoint(t,n){const s=this.previewCards.get(n);if(!s)return null;const o=s.canvas.getBoundingClientRect(),r=t.clientX-o.left,a=t.clientY-o.top,d=16,l=o.width-d*2,c=o.height-d*2,h=8,f=this.state.previewPoints[n];if(f&&f.in&&f.out){const p=[...f.in.map((g,y)=>({points:g,ioType:"in",ioIndex:y})),...f.out.map((g,y)=>({points:g,ioType:"out",ioIndex:y}))];for(let g=0;g<p.length;g++){const{points:y,ioType:m,ioIndex:x}=p[g];for(let S=0;S<y.length;S++){const v=d+y[S].x*l,b=d+y[S].y*c;if(Math.hypot(r-v,a-b)<=h)return{presetId:n,pathIndex:g,pointIndex:S,vertexIndex:null,ioType:m,ioIndex:x}}}return null}const u=f&&f.vertices&&f.edges?this._getPresetPoints(n).paths.map(p=>p.points):this.state.previewPoints[n];for(let p=0;p<u.length;p++){const g=u[p];for(let y=0;y<g.length;y++){const m=d+g[y].x*l,x=d+g[y].y*c;if(Math.hypot(r-m,a-x)<=h){let S=null;return f&&f.vertices&&f.edges&&(S=f.vertices.indexOf(g[y]),S<0&&(S=null)),{presetId:n,pathIndex:p,pointIndex:y,vertexIndex:S,ioType:null,ioIndex:null}}}}return null}_getNormalizedPoint(t,n){const s=n.getBoundingClientRect(),i=16,o=s.width-i*2,r=s.height-i*2,a=(t.clientX-s.left-i)/o,d=(t.clientY-s.top-i)/r;return{x:a,y:d}}}function Bo(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Id(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,s=[];let i=0,o;for(;(o=n.exec(t))!==null;){const d=o[0],l=o.index;l>i&&s.push({type:"text",content:t.substring(i,l)}),d==="\\$"?s.push({type:"text",content:"$"}):s.push({type:"math",content:d}),i=l+d.length}i<t.length&&s.push({type:"text",content:t.substring(i)});const r=[];let a=null;for(const d of s)d.type==="text"?a===null?a={type:"text",content:d.content}:a.content+=d.content:(a!==null&&(r.push(a),a=null),r.push(d));return a!==null&&r.push(a),r.length===0&&s.length===1&&s[0].type==="text"?s:r}function bd(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let s=null,i=!1;if(t&&t[1]?.trim()?(s=t[1].trim(),i=!0):n&&n[1]?.trim()&&(s=n[1].trim(),i=!1),s===null)return`<span class="text-segment">${Bo(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(s,{throwOnError:!1,displayMode:i,output:"html",strict:"warn"})}catch(o){return console.error("KaTeX renderToString unexpected error:",o),`<span class="katex-error" title="${Bo(o.message||"Unknown KaTeX error")}">${Bo(e)}</span>`}}function vd(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const s=t==null?"":String(t);let i="";try{i=Id(s).map(r=>r.type==="text"?`<span class="text-segment">${Bo(r.content)}</span>`:r.type==="math"?bd(r.content):"").join("")}catch(o){console.error("Error processing string segments for rendering:",o,s),i=`<span class="katex-error" title="${Bo(String(o.message||"Unknown error"))}">Error</span>`}e.innerHTML=i}function Md(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const s=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let i;const o=[];for(s.lastIndex=0;(i=s.exec(e))!==null;){const[,f,u,p,g,y,m,x,S,v,b,T]=i;let _={};if(f){const C=f.split("_"),E=C[0].slice(1),M=C[1].slice(1);_={type:"backslashSubscript",value:`\\mathrm{${E}}_\\mathrm{${M}}`}}else if(u)_={type:"doubleBackslash",value:"\\\\"};else if(p)_={type:"command",value:p};else if(g)_={type:"backslashLetter",value:g.slice(1)};else if(y){_={type:"word",value:y};const C=o[o.length-1],E=o[o.length-2],M=C?.type==="other"&&C.value==="{"&&E?.type==="command";_.isArgument=M}else m?_={type:"number",value:m}:x?_={type:"dollar",value:"\\$"}:S?_={type:"ampersand",value:"&"}:v?_={type:"space",value:" "}:b?_={type:"newline",value:"\\\\"}:T&&(_={type:"other",value:T});_.type&&o.push(_)}const r=["a","I"],a=["+","-","=","*","/","<",">"],d=(f,u)=>{let p=f+u;for(;p>=0&&p<o.length;){if(o[p].type!=="space")return o[p];p+=u}return null},l=f=>f?f.type==="other"&&a.includes(f.value):!1,c=f=>f?f.type==="backslashLetter"||f.type==="word"&&f.value.length===1&&!r.includes(f.value):!1;let h="";for(let f=0;f<o.length;f++){const u=o[f];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":h+=u.value;break;case"other":["#","%"].includes(u.value)?h+="\\"+u.value:h+=u.value;break;case"backslashLetter":h+=u.value;break;case"word":if(u.isArgument)h+=u.value;else if(u.value.length>1)h+=`\\mathrm{${u.value}}`;else{const x=o[f-1],S=o[f-2],v=x?.type==="other"&&x.value==="(",b=v&&S?.type==="space",T=v&&S?.type!=="space",_=d(f,-1),C=d(f,1),E=l(_)||l(C);b?h+=`\\mathrm{${u.value}}`:r.includes(u.value)?E||T?h+=u.value:h+=`\\mathrm{${u.value}}`:h+=u.value}break;case"space":let g=!0;const y=d(f,-1),m=d(f,1);if(!y||!m)g=!0;else{const x=c(y),S=c(m),v=l(y),b=l(m);(v||b)&&(g=!1),x&&S&&(g=!1)}h+=g?"\\ ":" ";break;default:h+=u.value;break}}if(h.endsWith("\\ ")){const f=h.match(/(\\ )+$/);if(f){const u=f[0].length/2,p="\\,".repeat(u);h=h.replace(/(\\ )+$/,p)}}return h===""?"":`$$${h}$$`}const Ed={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},Td={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},cl=5,Lo=25,Hr=20,Cd=20,wd=.1,Sa=[1/4,1/3,1/2,2/3,3/4],Ni=4,Hs=30,$e=5,dr=Hs/2,hr=10,As=2,Zn=1,qn=[6,6],Kl=[3,3],Ar=360,$o=180,ql=90,Be=2*Math.PI,fr=.01,Ia=Math.sqrt(3)/2,Pd=400,Ad=Math.PI/3,_d=1.5,pn=Math.PI/6,Dd=1.5,kd=[2,3],Rd=[1,3],Ld=.01,Nd=8,Od=5,Fd=Math.PI/24,Bd=15,go="_EDGE_",Oi=300,$d=3,ur=7,dl=1e-15,hl=1e13,fl=1.15,Vd=1e-5,Xd=1-1e-5,ba=.001,Ul=.01,Yd=.95,Gd=100,Wd=1.5,zd=.5,Hd=1.5,St=4,Fi=.9,cs=24,_s=10,ds=8,Ft=20,Ye=12,Kr=5,qr=20,Ur=10,jr=5,_r=20,Dr=12,Kd="\\phantom{-}0",Ei="i",xi="r",qd="\\mathrm{Re}",Ud="\\mathrm{Im}",jd=80,Jr=1,kr=Math.PI/2,Jd="#808080",Qs="rgba(128, 128, 128, 1)",Zd=4,Qd=.25,ct=10,Ue=56,oi=35,ul=10,eh=36,th=30,Rt=40,nh=20,Co=32,va=2,Fn=1.5,Rr=[2,4],Un=1.5,Ma=10,jl=3,wo=15,sh=4,Jl=1,gl=12,Zl=6,oh=2,ih=24,rh="T",ah=12,lh=10,ch=10,dh=3,Yn=2,Vo=2,dn=7,Lr=30,gr=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],Nr=4,En=12,po=30,hs=18,xn=1,Ql=1.5,Zr=11,Bi=18,$i=60,ec=20,tc=8,hh=20,pl=18,Qr=1e6,ea=1e-6,Vi=1e-5,Ds=.015,eo=32,fh=10,yl=16,uh=12,gh=14,js="\\hphantom{-}",Gt="\\pi",ml="\\delta = ",_o="\\theta = ",Ea=15,Ns=.8,Xi=3,ms=2,ph=1,yh=3,mh=1,xh=140,xl=.4,Sh=.9,Si=.05,Ih=10,Sl=1.5,Or=[15,5,1],Il=80,bh=.01,ue=1e-9,Ta=50,vh=6,Mh=10,pr=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let s=1;s<=n*4;s++)e.add(s/n);return Array.from(e).sort((n,s)=>n-s)})();function Eh(e,t){const n=new Set;n.add(0);for(let s=1;s<=e;s++)for(let i=1;i<=s*t;i++)n.add(i/s);return Array.from(n).sort((s,i)=>s-i)}const jn=Eh(vh,Mh),Bn="regular",rn=" transformation_rotation",$n=" transformation_scale",Sn="transformation_rotate_scale",Qn="transformation_directional_scale",yr="none",Ca="regular",zo="complex",mr="polar",ii="none",wa="lines",Pa="points",Aa="triangular",_a="polar",Os="degrees",ri="radians",Ho="none",Ko="on",Th="none",Ch=" ",wh="Escape",Ph="Delete",Ah="Backspace",_h="r",bl="=",vl="+",Ml="-",El="c",Tl="v",Cl="x",Fr="z",wl="y",Pl="a",nt="vertex",qe="edge",at="face",qt="text",Dh=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],kh=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),r=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],a=t?n:n-1,d=[];for(let l=0;l<a;l++)d.push({index:l,p0:r(l-1),p1:r(l),p2:r(l+1),p3:r(l+2)});return d},Al=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},_l=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Rh=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},Xo=(e,t=!1)=>{const n=[],s=e.length,i=t?s:s-1;for(let o=0;o<i;o++)n.push({type:"line",a:e[o],b:e[(o+1)%s]});return n},Lh=(e,t=!1,n=.5)=>{const i=(1-Math.max(0,Math.min(1,n)))*.5,o=Dh(i),r=[];return kh(e,t).forEach(({p0:d,p1:l,p2:c,p3:h})=>{const f=[d.x,l.x,c.x,h.x],u=[d.y,l.y,c.y,h.y],p=o.map(y=>y.reduce((m,x,S)=>m+x*f[S],0)),g=o.map(y=>y.reduce((m,x,S)=>m+x*u[S],0));r.push({type:"cubic",coeffX:p,coeffY:g})}),r},Nh=(e,t,n,s)=>{if(e.length<2||s<=1e-6)return Xo(e,t);const i=e.length,o=n==="fixed"?"absolute":n,r=[],a=l=>{const c=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=_l(c,h),p=_l(f,h),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)return null;const m=Math.min(g,y)*.5;let x,S,v;if(o==="absolute"?(x=Math.max(0,Math.min(s,m))*2,S=Al(p),v=Al(u)):(x=Math.max(0,Math.min(1,s)),S=p,v=u),x<=1e-6)return null;const b=x*.5,T=o==="absolute"?g*.5:.5,_=o==="absolute"?y*.5:.5,C={x:h.x+v.x*T,y:h.y+v.y*T},E={x:h.x+S.x*_,y:h.y+S.y*_},M={x:h.x+v.x*b,y:h.y+v.y*b},I={x:h.x+S.x*b,y:h.y+S.y*b},w=Math.PI,L=-Math.PI/2,P=Rh(w,L);return{origin:h,axisX:S,axisY:v,baseScale:x,midIn:C,midOut:E,arcStart:M,arcEnd:I,startAngle:w,sweep:P}};if(t){const l=[];for(let c=0;c<i;c++){const h=a(c);h&&l.push(h)}return l.length?(r.push({type:"line",a:l[0].midIn,b:l[0].arcStart}),l.forEach(c=>{r.push({type:"affineArc",origin:c.origin,axisX:c.axisX,axisY:c.axisY,baseScale:c.baseScale,startAngle:c.startAngle,sweep:c.sweep}),r.push({type:"line",a:c.arcEnd,b:c.midOut})}),r.push({type:"line",a:l[l.length-1].midOut,b:l[0].midIn}),r):Xo(e,!0)}const d=[];for(let l=1;l<i-1;l++){const c=a(l);c&&d.push(c)}return d.length?(r.push({type:"line",a:e[0],b:d[0].midIn}),d.forEach(l=>{r.push({type:"line",a:l.midIn,b:l.arcStart}),r.push({type:"affineArc",origin:l.origin,axisX:l.axisX,axisY:l.axisY,baseScale:l.baseScale,startAngle:l.startAngle,sweep:l.sweep}),r.push({type:"line",a:l.arcEnd,b:l.midOut})}),r.push({type:"line",a:d[d.length-1].midOut,b:e[i-1]}),r):Xo(e,!1)};function Oh(e,t,n=!1){return!t||e.length<2?[]:t.type==="linear"?Xo(e,n):t.type==="cubic_spline"?Lh(e,n,t.tension??.5):t.type==="circular_arc"?Nh(e,n,t.radiusMode??"relative",t.radiusValue??0):Xo(e,n)}function Fh(e,t){const n=[];return e.forEach((s,i)=>{const o=(r,a=!1)=>{i>0,n.push(r)};if(s.type==="line"){const r=s.a,a=s.b,d=t?t(r):r,l=t?t(a):a,c=Math.hypot(l.x-d.x,l.y-d.y),h=Math.max(2,Math.ceil(c/8));for(let f=0;f<=h;f++){const u=f/h;o({x:r.x+(a.x-r.x)*u,y:r.y+(a.y-r.y)*u},f===0)}return}if(s.type==="cubic"){const r=s.coeffX,a=s.coeffY,d=g=>({x:((r[0]*g+r[1])*g+r[2])*g+r[3],y:((a[0]*g+a[1])*g+a[2])*g+a[3]}),l=d(0),c=d(1),h=t?t(l):l,f=t?t(c):c,u=Math.hypot(f.x-h.x,f.y-h.y),p=Math.max(4,Math.ceil(u/6));for(let g=0;g<=p;g++){const y=g/p;o(d(y),g===0)}return}if(s.type==="affineArc"){const{origin:r,axisX:a,axisY:d,baseScale:l,startAngle:c,sweep:h}=s,f=l*.5,u={x:f,y:f},p=24;for(let g=0;g<=p;g++){const y=g/p,m=c+h*y,x={x:u.x+Math.cos(m)*f,y:u.y+Math.sin(m)*f};o({x:r.x+a.x*x.x+d.x*x.y,y:r.y+a.y*x.x+d.y*x.y},g===0)}}}),n}function xs(e,t,n=!1,s=null){const i=Oh(e,t,n);return i.length?Fh(i,s):e}function bt(e,t,n=!1){if(e===0)return"0";const s=Math.abs(e),i=e<0?"-":"";let o;if(n||s>=Qr||s!==0&&s<ea){if(e===0)return"0";const a=s.toExponential(Math.max(0,t-1)).split("e");let d=parseFloat(a[0]).toString(),l=parseInt(a[1],10);o=`${d} \\cdot 10^{${l}}`}else{const r=s<1?0:Math.floor(Math.log10(s))+1;let a;if(s===0)a=t-1;else if(s<1){let c=0,h=s;for(;h<1&&c<t+5;)h*=10,c++;a=Math.max(0,c-1+t)}else a=Math.max(0,t-r);let d=s.toFixed(a),l=parseFloat(d);if(Math.abs(l)===0&&e!==0)return"0";o=Math.abs(l).toString()}return i+o}function Da(e,t){return t===0?e:Da(t,e%t)}function le(e){return e.id1<e.id2?`${e.id1}${go}${e.id2}`:`${e.id2}${go}${e.id1}`}function Ii(e,t,n,s,i,o){const r=i-n,a=o-s,d=r*r+a*a;if(d===0){const p=e-n,g=t-s;return Math.sqrt(p*p+g*g)}let l=-((n-e)*r+(s-t)*a)/d;l<0&&(l=0),l>1&&(l=1);const c=n+l*r,h=s+l*a,f=e-c,u=t-h;return Math.sqrt(f*f+u*u)}function pe(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function _n(e,t,n,s,i=!1){const o=[];if(t==="none"||!n||n<=0)return o;if(t==="polar"){const r=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,a=Math.hypot(e.x,e.y),d=Math.round(a/n)*n;s.forEach(l=>{if(l.alpha>.01&&l.angle>0){const c=l.angle,f=Math.round(r/c)*c*Math.PI/180;o.push({x:d*Math.cos(f),y:d*Math.sin(f),isGridPoint:!0})}})}else if(t==="triangular"){const r=n*Ia,a=e.x/n-e.y/(n*Math.sqrt(3)),d=e.y/r;let l=Math.round(a),c=Math.round(d),h=Math.round(-a-d);const f=Math.abs(l-a),u=Math.abs(c-d),p=Math.abs(h-(-a-d));f>u&&f>p?l=-c-h:u>p&&(c=-l-h);const g=l*n+c*n/2,y=c*r;o.push({x:g,y,isGridPoint:!0})}else if(i){const r=Math.floor(e.x/n)*n,a=Math.floor(e.y/n)*n;o.push({x:r,y:a,isGridPoint:!0},{x:r+n,y:a,isGridPoint:!0},{x:r,y:a+n,isGridPoint:!0},{x:r+n,y:a+n,isGridPoint:!0})}else o.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return o}function $t(){return crypto.randomUUID()}function Tn(e){for(;e<0;)e+=Be;for(;e>=Be;)e-=Be;return e}function Dl(e,t,n=0){let s=t-e,i=Math.round((n-s)/(2*Math.PI));return s+i*(2*Math.PI)}function ft(e){return e=Tn(e),e>Math.PI&&(e-=Be),e}function Bh(e){for(;e<0;)e+=Ar;for(;e>=Ar;)e-=Ar;return e}function ka(e,t){const{p1:n,p2:s}=e,{center:i,radius:o}=t,r={x:s.x-n.x,y:s.y-n.y},a={x:n.x-i.x,y:n.y-i.y},d=r.x*r.x+r.y*r.y,l=2*(a.x*r.x+a.y*r.y),c=a.x*a.x+a.y*a.y-o*o;let h=l*l-4*d*c;if(h<0)return[];h=Math.sqrt(h);const f=(-l-h)/(2*d),u=(-l+h)/(2*d);return[{x:n.x+f*r.x,y:n.y+f*r.y},{x:n.x+u*r.x,y:n.y+u*r.y}]}function ks(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let s=2;s*s<=n;s++)for(;n%(s*s)===0;)n/=s*s,t*=s;return[t,n]}function Rs(e,t,n=""){const s=n?`\\${n}`:"";return t===1?e===1&&n?s:`${e}${s}`:e===1?`\\sqrt{${t}}${s}`:`${e}\\sqrt{${t}}${s}`}function ie(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function yn(e,t=Ds,n=eo){if(Math.abs(e)<Vi)return"0";const s=e<0?"-":"",i=Math.abs(e);if(Math.abs(i-Math.round(i))<t){const a=Math.round(i);return s+a.toString()}const o=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[a,d]of o)if(d<=n&&Math.abs(i-a/d)<t)return s+`${a}/${d}`;for(let a=1;a<=n;a++){const d=Math.round(i*a);if(!(d===0&&i>Vi)&&Math.abs(i-d/a)<t/a){const l=Da(d,a),c=d/l,h=a/l;return h===1?s+`${c}`:s+`${c}/${h}`}}let r=2;return i<.01?r=3:i<.1?r=2:i<10?r=1:r=0,s+i.toFixed(r)}function Fs(e,t){if(t.length<3)return!1;const n=e.x,s=e.y;let i=!1;for(let o=0,r=t.length-1;o<t.length;r=o++){const a=t[o].x,d=t[o].y,l=t[r].x,c=t[r].y;if(a===n&&d===s||d===c&&d===s&&n>=Math.min(a,l)&&n<=Math.max(a,l)||a===l&&a===n&&s>=Math.min(d,c)&&s<=Math.max(d,c))return!0;d>s!=c>s&&n<(l-a)*(s-d)/(c-d)+a&&(i=!i)}return i}function es(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function $h(e,t,n){const s=t.localCoordSystem;if(!s)return null;const i=n(s.origin),o=Nd;if(ie(e,i)<o)return{face:t,type:"center"};const r=Od,a=Cn({x:1,y:0},s),d=n(a);if(gt(e,i,d).distance<r)return{face:t,type:"x_axis"};const c=Cn({x:0,y:1},s),h=n(c);return gt(e,i,h).distance<r?{face:t,type:"y_axis"}:null}function yo(e,t){if(Fs(e,t))return e;let n=e,s=1/0;for(let i=0;i<t.length;i++){const o=t[i],r=t[(i+1)%t.length],a=gt(e,o,r);a.distance<s&&(s=a.distance,n={x:a.x,y:a.y})}return n}function nc(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:s,isColorModePanelExpanded:i,isInterpolationPanelExpanded:o,isTransformPanelExpanded:r,isDisplayPanelExpanded:a,isVisibilityPanelExpanded:d,isSessionsPanelExpanded:l}){const c=(h,f)=>f?h.x>=f.x&&h.x<=f.x+f.width&&h.y>=f.y&&h.y<=f.y+f.height:!1;if(s){for(const h of t.colorTargetIcons||[])if(c(e,h))return{...h,type:"colorTargetIcon"};for(const h of t.colorSwatches||[])if(c(e,h))return{...h,type:"colorSwatch"};if(c(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(c(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(c(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(c(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(i){for(const h of t.colorModeIcons||[])if(c(e,h))return{...h,type:"colorModeIcon"}}if(r){for(const h of t.transformIcons||[])if(c(e,h))return{...h,type:"transformIcon"}}if(o){for(const h of t.interpolationIcons||[])if(c(e,h))return{...h,type:"interpolationIcon"}}if(a){for(const h of t.displayIcons||[])if(c(e,h))return{...h,type:"displayIcon"}}if(d){for(const h of t.visibilityIcons||[])if(c(e,h))return{...h,type:"visibilityIcon"}}if(l){for(const h of t.sessionIcons||[])if(c(e,h))return{...h,type:"sessionIcon"};if(c(e,t.removeSessionButton))return{...t.removeSessionButton,type:"button"};if(c(e,t.addSessionButton))return{...t.addSessionButton,type:"button"}}if(n){if(c(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(c(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(c(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(c(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(c(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(c(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"};if(c(e,t.sessionsToolButton))return{...t.sessionsToolButton,type:"toolButton"};if(c(e,t.colorModeToolButton))return{...t.colorModeToolButton,type:"toolButton"}}return c(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function Vh(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function gt(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,r=e.y-t.y,a=s*s+i*i;if(a===0)return{x:t.x,y:t.y,distance:ie(e,t),onSegmentStrict:!0,t:0};let d=(o*s+r*i)/a;const l=d>Vd&&d<Xd,c=Math.max(0,Math.min(1,d)),h=t.x+c*s,f=t.y+c*i,u=ie(e,{x:h,y:f});return{x:h,y:f,distance:u,onSegmentStrict:l,t:c}}function sc(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,r=e.y-t.y,a=s*s+i*i;if(a===0)return{x:t.x,y:t.y,distance:ie(e,t)};let d=(o*s+r*i)/a;const l=t.x+d*s,c=t.y+d*i,h=ie(e,{x:l,y:c});return{x:l,y:c,distance:h}}function mt(e,t={},n=0){if(!e||typeof e!="string")return n;const s=e.trim();if(!s)return n;try{const i={...t},o=Object.keys(i),r=o.map(c=>i[c]),a=s.replace(/\^/g,"**"),l=new Function(...o,`'use strict'; return (${a});`)(...r);return Number.isFinite(l)?l:n}catch{return n}}function Po(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function Br(e,t,n){e/=255,t/=255,n/=255;const s=Math.max(e,t,n),i=Math.min(e,t,n);let o,r,a=(s+i)/2;if(s===i)o=r=0;else{const d=s-i;switch(r=a>.5?d/(2-s-i):d/(s+i),s){case e:o=(t-n)/d+(t<n?6:0);break;case t:o=(n-e)/d+2;break;case n:o=(e-t)/d+4;break}o/=6}return[o,r,a]}function Xh(e,t,n,s,i=null){const o=Math.atan2(e.y-t.y,e.x-t.x);if(!s)return{angle:o,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const r=Fd;let a={angle:o,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const d={edge:1,vertex_direction:2,cardinal:3},l=(h,f,u=null,p=null)=>{const g=ft(h),y=Math.abs(ft(o-g));if(y<r){const m=d[f],x=a.snapType?d[a.snapType]:1/0;m<x?a={angle:g,difference:y,edgeIndex:u,snapType:f,targetVertexId:p}:m===x&&y<a.difference&&(a={angle:g,difference:y,edgeIndex:u,snapType:f,targetVertexId:p})}};return s.edgeAngles&&s.edgeAngles.forEach((h,f)=>{[h,h+Math.PI/2,h-Math.PI/2,h+Math.PI].forEach(u=>{l(u,"edge",f)})}),s.vertices&&s.vertices.forEach(h=>{if(ie(t,h)>ue){const f=Math.atan2(h.y-t.y,h.x-t.x);l(f,"vertex_direction",null,h.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(h=>l(h,"cardinal")),{angle:a.angle,edgeIndex:a.edgeIndex,snapType:a.snapType,snapped:a.difference<1/0,targetVertexId:a.targetVertexId}}function Yh(e,t,n,s,i,o=null,r=null,a="x_axis"){if(!o||!r||!n.alignedEdgeInfo)return{snapped:!1};const d=Bd/r.scale;let l=[];const{v1Id:c,v2Id:h}=n.alignedEdgeInfo,f=i(c),u=i(h);if(f&&u&&f.type==="regular"&&u.type==="regular"){const g=ie(f,u);[.25,1/3,.5,2/3,.75,1].forEach(m=>{const x=g*m,S=Math.abs(o-x);l.push({scale:x,distance:S,type:"edge_fraction",priority:m===.5?1:m===1?2:3,fraction:m})})}if(l.length===0)return{snapped:!1};l.sort((g,y)=>g.priority!==y.priority?g.priority-y.priority:g.distance-y.distance);const p=l.find(g=>g.distance<d);return p?{snapped:!0,scale:p.scale,snapType:"edge_fraction",edgeFraction:p.fraction}:{snapped:!1}}function Gh(e,t,n,s,i){let o=null,r=1/0;if(t&&(t.vertices&&t.vertices.forEach(a=>{const d=ie(e,a);d<r&&(r=d,o={snapped:!0,snapPoint:a,snapType:"vertex",vertexId:a.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(a=>{const d=ie(e,a);d<r&&(r=d,o={snapped:!0,snapPoint:{x:a.x,y:a.y},snapType:"edge",edgeInfo:{v1:a.v1,v2:a.v2}})}),t.faceCenters&&t.faceCenters.forEach(a=>{const d=ie(e,a);d<r&&(r=d,o={snapped:!0,snapPoint:a,snapType:"faceCenter"})})),n&&n!=="none"&&s&&s.interval1){const a=s.alpha2>s.alpha1&&s.interval2?s.interval2:s.interval1;_n(e,n,a,i,!0).forEach(l=>{const c=ie(e,l);c<r&&(r=c,o={snapped:!0,snapPoint:l,snapType:"grid"})})}return o||{snapped:!1}}function Wh(e){if(Array.isArray(e)){const[t,n,s]=Br(e[0],e[1],e[2]),i=1-s,[o,r,a]=$r(t,n,i);return[o,r,a]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,s,i,o]=t,r=parseInt(n),a=parseInt(s),d=parseInt(i),[l,c,h]=Br(r,a,d),f=1-h,[u,p,g]=$r(l,c,f);return`rgba(${u}, ${p}, ${g}, ${o})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16),[i,o,r]=Br(t,n,s),a=1-r,[d,l,c]=$r(i,o,a);return`#${d.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function xr(e){let t=0;const n=e.length;for(let s=0;s<n;s++){const i=(s+1)%n;t+=e[s].x*e[i].y,t-=e[i].x*e[s].y}return t/2}function zh(e,t,n){return Math.max(t,Math.min(n,e))}function Hh(e,t){return e==="light"?Td:t}function $r(e,t,n){let s,i,o;if(t===0)s=i=o=n;else{const r=(l,c,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?l+(c-l)*6*h:h<.5?c:h<.6666666666666666?l+(c-l)*(6*(.6666666666666666-h)):l),a=n<.5?n*(1+t):n+t-n*t,d=2*n-a;s=r(d,a,e+1/3),i=r(d,a,e),o=r(d,a,e-1/3)}return[Math.round(s*255),Math.round(i*255),Math.round(o*255)]}function Js(e,t){const n=yn(e,.001),s=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${s}`;if(n==="1")return s;if(n==="-1")return`-${s}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${s}`;if(n.includes("/")){let i="",o=n;o.startsWith("-")&&(i="-",o=o.substring(1));const r=o.split("/"),a=r[0],d=r[1];return a==="1"?`${i}\\frac{1}{${d}}${s}`:`${i}\\frac{${a}}{${d}}${s}`}return`${n}${s}`}function ut(e,t,n,s,i,o){const r={x:e.x-t.x,y:e.y-t.y};if(i){const a=Math.hypot(o.x,o.y);if(a>ue){const d={x:o.x/a,y:o.y/a},l=r.x*d.x+r.y*d.y,c={x:r.x-l*d.x,y:r.y-l*d.y},h=l*s,f={x:h*d.x+c.x,y:h*d.y+c.y};return{x:t.x+f.x,y:t.y+f.y}}return{x:e.x,y:e.y}}else{let a={...r};a.x*=s,a.y*=s;const d=a.x,l=a.y;return a.x=d*Math.cos(n)-l*Math.sin(n),a.y=d*Math.sin(n)+l*Math.cos(n),{x:t.x+a.x,y:t.y+a.y}}}function kl(){return[1,0,0,0,1,0,0,0,1]}function Rl(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}function ta(e,t){const n=t.x,s=t.y;return{x:e[0]*n+e[1]*s+e[2],y:e[3]*n+e[4]*s+e[5]}}function oc(e,t){if(t<=0)return kl();let n=kl(),s=e,i=Math.floor(t);for(;i>0;)i%2===1&&(n=Rl(n,s)),s=Rl(s,s),i=Math.floor(i/2);return n}function na(e,t,n,s,i){let o=1,r=0,a=0,d=1;if(s){const h=Math.hypot(i.x,i.y);if(h>ue){const f=i.x/h,u=i.y/h,p=n-1;o=1+p*f*f,r=p*f*u,a=p*u*f,d=1+p*u*u}}else{const h=Math.cos(t),f=Math.sin(t),u=n;o=h*u,r=-f*u,a=f*u,d=h*u}const l=e.x-(o*e.x+r*e.y),c=e.y-(a*e.x+d*e.y);return[o,r,l,a,d,c,0,0,1]}function Ti(e,t,n){if(n===0)return{x:e.x,y:e.y};const s=oc(t,n);return ta(s,e)}function Sr(e){if(e.length<3)return null;if(e.length===3){const[t,n,s]=e,i=ie(n,s),o=ie(t,s),r=ie(t,n),a=i+o+r;if(a<ue)return null;const d=(i*t.x+o*n.x+r*s.x)/a,l=(i*t.y+o*n.y+r*s.y)/a,h=2*(Math.abs((n.x-t.x)*(s.y-t.y)-(s.x-t.x)*(n.y-t.y))/2)/a;return{center:{x:d,y:l},radius:h}}return Kh(e)}function ic(e,t,n){const s=Sa.reduce((o,r)=>Math.abs(r-e.t)<Math.abs(o-e.t)?r:o),i={x:t.x+s*(n.x-t.x),y:t.y+s*(n.y-t.y)};return{fraction:s,point:i}}function Kh(e){if(e.length<3)return null;let t={x:e.reduce((i,o)=>i+o.x,0)/e.length,y:e.reduce((i,o)=>i+o.y,0)/e.length};Fs(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,s=Ll(t,e);for(let i=0;i<Cd;i++){let o=!1;const r=s*wd,a=[{x:r,y:0},{x:-r,y:0},{x:0,y:r},{x:0,y:-r},{x:r*Math.SQRT1_2,y:r*Math.SQRT1_2},{x:-r*Math.SQRT1_2,y:r*Math.SQRT1_2},{x:r*Math.SQRT1_2,y:-r*Math.SQRT1_2},{x:-r*Math.SQRT1_2,y:-r*Math.SQRT1_2}];for(const d of a){const l={x:n.x+d.x,y:n.y+d.y};if(Fs(l,e)){const c=Ll(l,e);c>s&&(n=l,s=c,o=!0)}}if(!o)break}return{center:n,radius:Math.max(s,ue)}}function Ll(e,t){let n=1/0;for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length],r=rc(e,i,o);n=Math.min(n,r)}return n}function rc(e,t,n){return gt(e,t,n).distance}function qh(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=Nl(n,t);else if(!n.localCoordSystem.isCustom){const s=Nl(n,t);s&&(n.localCoordSystem.origin=s.origin,n.localCoordSystem.scale=s.scale)}})}function Uh(e,t,n){const s=[e];let i=e,o=t;const r=n.size+2;for(let a=0;a<r;a++){if(s.push(o),o===e)return s.pop(),s;const d=n.get(o);if(!d||d.length<1)return null;const l=d.indexOf(i);if(l===-1)return null;const c=(l+1)%d.length,h=d[c];i=o,o=h}return null}function jh(e,t,n){if(e.length<=1)return e;const s=new Set(t.map(i=>[i.id1,i.id2].sort().join("_")));return e.filter(i=>{const o=i.vertexIds;if(o.length<3)return!1;for(let r=0;r<o.length;r++)for(let a=r+2;a<o.length;a++){if(r===0&&a===o.length-1)continue;const d=o[r],l=o[a],c=[d,l].sort().join("_");if(s.has(c))return!1}return!0})}function Ir(e,t){const n=new Map,s=new Map;e.forEach(l=>{const c=t(l.id1),h=t(l.id2);!c||!h||c.type!=="regular"||h.type!=="regular"||(s.has(c.id)||s.set(c.id,c),s.has(h.id)||s.set(h.id,h),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,c]of n.entries()){const h=s.get(l);h&&c.sort((f,u)=>{const p=s.get(f),g=s.get(u);if(!p||!g)return 0;const y=Math.atan2(p.y-h.y,p.x-h.x),m=Math.atan2(g.y-h.y,g.x-h.x);return y-m})}const i=[],o=new Set;for(const[l,c]of n.entries())for(const h of c){const f=`${l}->${h}`;if(o.has(f))continue;const u=Uh(l,h,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const m=u[y],x=u[(y+1)%u.length];o.add(`${m}->${x}`)}const g={vertexIds:u};g.id=pe(g),i.push(g)}}const r=jh(i,e),a=[],d=new Set;return r.forEach(l=>{const c=[...l.vertexIds].sort().join("_");d.has(c)||(a.push(l),d.add(c))}),a}function Bs(e,t,n,s){const i={id1:e.id,id2:t.id,directionFrom:e.id,directionTo:t.id},o=e.x-t.x,r=e.y-t.y,a=o/n,d=r/n,l=1e-5;if(n&&Math.abs(a-Math.round(a))<l&&Math.abs(d-Math.round(d))<l){i.labelMode="exact";const h=Math.round(a),f=Math.round(d);i.exactValue={g2gSquaredSum:h*h+f*f,gridInterval:n}}else i.labelMode="decimal";return i.color=s(qe),i}function ac(e,t){let n=null,s=1/0;return t.forEach(i=>{if(!i)return;const o=Math.abs(e.x-(i.x+i.width/2));o<s&&o<i.width/2+ct&&(s=o,n=i)}),n}function Jh(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function We(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],p=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${p})`}Number.isFinite(t)||(t=0),e.isCyclic?t=(t%1+1)%1:t=Math.max(0,Math.min(1,t));let s=n[0],i=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){s=n[u],i=n[u+1];break}const o=i.pos-s.pos,r=o>0?(t-s.pos)/o:0,a=Math.round(s.color[0]+(i.color[0]-s.color[0])*r),d=Math.round(s.color[1]+(i.color[1]-s.color[1])*r),l=Math.round(s.color[2]+(i.color[2]-s.color[2])*r),c=s.alpha!==void 0?s.alpha:1,h=i.alpha!==void 0?i.alpha:1,f=c+(h-c)*r;return`rgba(${a},${d},${l},${f})`}function Nl(e,t){const n=e.vertexIds.map(i=>t(i)).filter(i=>i&&i.type==="regular");if(n.length<3)return null;const s=Sr(n);return s?{origin:{...s.center},angle:0,scale:s.radius,isCustom:!1,showCoordSystem:!1}:null}function Do(e,t){if(!t)return e;const n={x:e.x-t.origin.x,y:e.y-t.origin.y},s=Math.cos(-t.angle),i=Math.sin(-t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return t.scale===0?{x:0,y:0}:{x:o.x/t.scale,y:o.y/t.scale}}function hn(e,t){const n=new Set;return t.forEach(s=>{s.id1===e?n.add(s.id2):s.id2===e&&n.add(s.id1)}),Array.from(n)}function Cn(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},s=Math.cos(t.angle),i=Math.sin(t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return{x:o.x+t.origin.x,y:o.y+t.origin.y}}function Zh(e,t,n,s){const i=(e.x-t.x)*(n.y-s.y)-(e.y-t.y)*(n.x-s.x);if(Math.abs(i)<ue)return null;const o=((e.x-n.x)*(n.y-s.y)-(e.y-n.y)*(n.x-s.x))/i,r=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/i;return o>ue&&o<1-ue&&r>ue&&r<1-ue?{x:e.x+o*(t.x-e.x),y:e.y+o*(t.y-e.y)}:null}function Qh(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length];if(rc(n,i,o)<ue)return!1}if(!Fs(n,t))return!1}return!0}function ef(e,t,n){const s=[];for(let i=0;i<t.length;i++)s.push({p1:t[i],p2:t[(i+1)%t.length]});for(const i of e){const o=n(i.id1),r=n(i.id2);if(!(!o||!r)){for(const a of s)if(Zh(o,r,a.p1,a.p2))return!0}}return!1}function sa(e,t,n){const s=[];for(const i of e)for(const o of t){if(i.originalId===o.originalId&&i.transformIndex===o.transformIndex)continue;const r=ie(i,o);r<n&&s.push({dist:r,sourceVertex:i,targetVertex:o,correctionVector:{x:o.x-i.x,y:o.y-i.y},type:"vertex-vertex"})}return s}function to(e,t,n){const s=[];for(const i of e)for(const o of t){if(!o||!o.originalEdge||!o.p1||!o.p2)continue;const r=i.transformIndex===o.transformIndex,a=i.originalId===o.originalEdge.id1||i.originalId===o.originalEdge.id2;if(r&&a)continue;const d=gt(i,o.p1,o.p2);d.distance<n&&d.onSegmentStrict&&s.push({dist:d.distance,sourceVertex:i,targetEdge:o,snapPoint:{x:d.x,y:d.y},correctionVector:{x:d.x-i.x,y:d.y-i.y},type:"vertex-to-edge"})}return s}function lc(e){return e<=1?[1]:Array.from({length:e-1},(t,n)=>n+1)}function Yi(e,t,n,s){const i=[];if(e.length===0||t<=0)return i;for(const o of lc(t)){const r=o,a=o;e.forEach(d=>{i.push({...s(d,r,n),originalId:d.id,transformIndex:a,type:"regular"})})}return i}function Gi(e,t,n){const s=[];if(e.length===0||n<=0)return s;for(const i of lc(n)){const o=i,r=t.filter(a=>a.transformIndex===o);r.length!==0&&e.forEach(a=>{const d=r.find(c=>c.originalId===a.id1),l=r.find(c=>c.originalId===a.id2);d&&l&&s.push({p1:d,p2:l,originalEdge:a,transformIndex:o,originalEdgeId:le(a)})})}return s}function tf(e,t,n,s,i,o,r,a,d){const l=$e*2/o.scale,c=$e/o.scale,h=e.filter(B=>B.type==="regular");if(h.length===0||i<=0)return{snapped:!1,finalTransform:r,mergePairs:[],edgeSnaps:[],bestSnap:null};const f=new Set(e.map(B=>B.id)),u=new Map(h.map(B=>[B.id,B])),p=Yi(h,i,r,a),g=t.filter(B=>B.type==="regular"&&!f.has(B.id)).map(B=>({...B,originalId:B.id,transformIndex:void 0})),y=n.filter(B=>f.has(B.id1)&&f.has(B.id2)),m=Gi(y,p,i),x=n.filter(B=>!f.has(B.id1)||!f.has(B.id2)).map(B=>({p1:s(B.id1),p2:s(B.id2),originalEdge:B,transformIndex:void 0,originalEdgeId:le(B)})).filter(B=>B.p1&&B.p2),S=[],v=[...g,...p],b=[...x,...m];if(p.forEach(B=>{v.forEach(D=>{if(B.originalId===D.originalId&&B.transformIndex===D.transformIndex)return;const N=ie(B,D);N<l&&S.push({type:"vertex-vertex",dist:N,source:{originalId:B.originalId,transformIndex:B.transformIndex,point:u.get(B.originalId)},target:{originalId:D.originalId,transformIndex:D.transformIndex,point:D}})})}),p.forEach(B=>{b.forEach(D=>{const N=B.transformIndex===D.transformIndex,k=B.originalId===D.originalEdge.id1||B.originalId===D.originalEdge.id2;if(N&&k)return;const Y=gt(B,D.p1,D.p2);Y.distance<c&&Y.onSegmentStrict&&S.push({type:"vertex-to-edge",dist:Y.distance,source:{originalId:B.originalId,transformIndex:B.transformIndex,point:u.get(B.originalId)},target:{originalEdgeId:D.originalEdgeId,transformIndex:D.transformIndex,point:{x:Y.x,y:Y.y}}})})}),m.forEach(B=>{v.forEach(D=>{const N=D.transformIndex===B.transformIndex,k=D.originalId===B.originalEdge.id1||D.originalId===B.originalEdge.id2;if(N&&k)return;const Y=gt(D,B.p1,B.p2);if(Y.distance<c&&Y.onSegmentStrict){const X=u.get(B.originalEdge.id1),z=u.get(B.originalEdge.id2);if(X&&z){const G={x:X.x+Y.t*(z.x-X.x),y:X.y+Y.t*(z.y-X.y)};S.push({type:"edge-to-vertex",dist:Y.distance,source:{originalId:B.originalEdgeId,transformIndex:B.transformIndex,point:G},target:{originalId:D.originalId,transformIndex:D.transformIndex,point:D}})}}})}),S.length===0)return{snapped:!1,finalTransform:r,mergePairs:[],edgeSnaps:[],bestSnap:null};const T={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};S.sort((B,D)=>{const N=T[B.type]??99,k=T[D.type]??99;return N!==k?N-k:B.dist-D.dist});const _=S[0],C=_.source.transformIndex,E=_.target.transformIndex,M=d(_.source.point,_.target.point,C,E,r);if(!M)return{snapped:!1,finalTransform:r,mergePairs:[],edgeSnaps:[],bestSnap:null};const I={...r,...M},w=Yi(h,i,I,a),L=Gi(y,w,i),P=g.map(B=>({...B})),A=[...P,...w],R=sa(w,A,ue),$=[...x.map(B=>({...B})),...L],F=to(w,$,ue),V=to(P,L,ue);return{snapped:!0,finalTransform:I,bestSnap:_,mergePairs:R.map(B=>({source:{originalId:B.sourceVertex.originalId,transformIndex:B.sourceVertex.transformIndex},target:{originalId:B.targetVertex.originalId,transformIndex:B.targetVertex.transformIndex}})),edgeSnaps:[...F,...V].map(B=>({sourceVertex:{originalId:B.sourceVertex.originalId,transformIndex:B.sourceVertex.transformIndex},targetEdge:{originalEdgeId:B.targetEdge.originalEdgeId,transformIndex:B.targetEdge.transformIndex}}))}}function cc(e,t,n,s,i,o,r,a){const d=$e*2/o.scale,l=$e/o.scale,c=String(Bn).trim(),h=e.filter(X=>(X&&X.type?String(X.type).trim():"undefined")===c);if(h.length===0||i<=0)return{snapped:!1,finalTransform:r,mergePairs:[],edgeSnaps:[]};const f=new Set(e.map(X=>X.id)),u=Yi(h,i,r,a),p=t.filter(X=>X.type==="regular"&&!f.has(X.id)).map(X=>({...X,originalId:X.id,transformIndex:void 0})),g=n.filter(X=>f.has(X.id1)&&f.has(X.id2)),y=Gi(g,u,i),m=n.filter(X=>!f.has(X.id1)||!f.has(X.id2)).map(X=>({p1:s(X.id1),p2:s(X.id2),originalEdge:X,transformIndex:void 0,originalEdgeId:le(X)})).filter(X=>X.p1&&X.p2),x=[...p,...u],S=[...m,...y],v=sa(u,x,d),b=to(u,S,l),_=to(p,y,l).map(X=>({dist:X.dist,sourceEdge:X.targetEdge,targetVertex:X.sourceVertex,correctionVector:{x:X.sourceVertex.x-X.snapPoint.x,y:X.sourceVertex.y-X.snapPoint.y},type:"edge-to-vertex"})),C=[...v,...b,..._];if(C.length===0)return{snapped:!1,finalTransform:r,mergePairs:[],edgeSnaps:[]};const E={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};C.sort((X,z)=>{const G=E[X.type]??99,W=E[z.type]??99;return G!==W?G-W:X.dist-z.dist});const M=C[0];let I={...M.correctionVector};const w=M.sourceVertex?M.sourceVertex.transformIndex:M.sourceEdge.transformIndex,L=M.targetVertex?M.targetVertex.transformIndex:M.targetEdge?M.targetEdge.transformIndex:void 0;let P;L===void 0?P=w:P=w-L;let A={x:0,y:0};Math.abs(P)>1e-9?(A.x=I.x/P,A.y=I.y/P):A={x:0,y:0};const R={...r,delta:{x:r.delta.x+A.x,y:r.delta.y+A.y}},O=Yi(h,i,R,a).map(X=>({...X,id:`final_${X.originalId}_${X.transformIndex}`})),$=p.map(X=>({...X})),F=[...$,...O],V=sa(O,F,ue),B=m.map(X=>({...X})),D=Gi(g,O,i),N=[...B,...D],k=to(O,N,ue),Y=to($,D,ue);return{snapped:!0,finalTransform:R,bestSnap:M,mergePairs:V.map(X=>({source:{originalId:X.sourceVertex.originalId,transformIndex:X.sourceVertex.transformIndex},target:{originalId:X.targetVertex.originalId,transformIndex:X.targetVertex.transformIndex}})),edgeSnaps:[...k,...Y].map(X=>({sourceVertex:{originalId:X.sourceVertex.originalId,transformIndex:X.sourceVertex.transformIndex},targetEdge:{originalEdgeId:X.targetEdge.originalEdgeId,transformIndex:X.targetEdge.transformIndex}}))}}function nf(e,t,n,s,i,o,r){const a={delta:i},l=cc(e,t,n,s,o,r,a,(c,h,f=a)=>({x:c.x+f.delta.x*h,y:c.y+f.delta.y*h}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const Vr=e=>Math.max(0,Math.min(1,e)),ht=(e,t)=>{const n=es(e);return n||t},oa=e=>`rgba(${Math.round(e.r)},${Math.round(e.g)},${Math.round(e.b)},${e.a??1})`,ao=(e,t)=>{let n=0,s=0,i=0,o=0,r=0;return e.forEach((a,d)=>{const l=t[d]||0;r+=l,n+=a.r*l,s+=a.g*l,i+=a.b*l,o+=a.a*l}),r<=0?{r:0,g:0,b:0,a:1}:{r:n/r,g:s/r,b:i/r,a:o/r}};function Wi(e,t,n,s,i,o,r){if(!t)return[n,s];const a=e.directionFrom||e.id1,d=e.directionTo||e.id2,l=o(a)||n,c=o(d)||s,h={x:c.x-l.x,y:c.y-l.y},f=Math.hypot(h.x,h.y)||1;h.x/=f,h.y/=f;const u=e.interpolationStyleId||null,p=(M,I)=>{const w=[];return i.forEach(L=>{L.id1===e.id1&&L.id2===e.id2||L.id1===e.id2&&L.id2===e.id1||(L.id1===M&&L.id2!==I&&w.push(L),L.id2===M&&L.id1!==I&&w.push(L))}),w},g=(M,I,w)=>{const L=p(M,I).filter(F=>(F.interpolationStyleId||null)===u);if(L.length!==1)return null;const P=L[0],R=[P.id1===M?P.id2:P.id1];let O=null,$=w?-1/0:1/0;return R.forEach(F=>{const V=o(F);if(!V||V.type!==Bn)return;const B=o(M);if(!B)return;const D={x:V.x-B.x,y:V.y-B.y},N=Math.hypot(D.x,D.y);if(N<=ue)return;const k=D.x/N*h.x+D.y/N*h.y;w?k>$&&($=k,O=V):k<$&&($=k,O=V)}),O},y=g(a,d,!1),m=g(d,a,!0),x=[l,c];y&&x.unshift(y),m&&x.push(m);const S=xs(x,t,!1,r);if(!S||S.length<2)return[n,s];let v=0,b=S.length-1,T=1/0,_=1/0;if(S.forEach((M,I)=>{const w=ie(M,n);w<T&&(T=w,v=I);const L=ie(M,s);L<_&&(_=L,b=I)}),v===b)return[n,s];const C=Math.min(v,b),E=Math.max(v,b);return S.slice(C,E+1)}function sf(e){const t=xh/e;let n=Math.pow(10,Math.floor(Math.log10(t))),s=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-s)<ue||n===0)&&(s=n===0?.001:n*10,n===0&&(n=1e-4));const i=n,o=s;let r=0;o>i&&i>0&&(r=(Math.log10(t)-Math.log10(i))/(Math.log10(o)-Math.log10(i)));let a=(r-xl)/(Sh-xl);a=Math.max(0,Math.min(1,a)),a=a*a*(3-2*a);let d=1-a,l=a;d<Si?d=0:d>1-Si&&(d=1),l<Si?l=0:l>1-Si&&(l=1);const c=d+l;return c>0&&c!==2&&(d/=c,l/=c),{grid1Interval:i,grid2Interval:o,alpha1:d,alpha2:l}}function of(e,t,n,s){const i=s({x:0,y:0}),o={x:t/2,y:n/2},r=ie(i,o);let a;r<1e-6?a=Il:a=Il/r*(180/Math.PI),(isNaN(a)||a<=ue)&&(a=ue);const d=[];let l=[...Or],c=l[l.length-1];const h=1e-15;for(;c>h;)c/=10,l.includes(c)||l.push(c);l.sort((y,m)=>m-y);let f=null,u=null;for(let y=l.length-1;y>=0;y--){const m=l[y];if(a<m){f={angle:m,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!f&&l.length>0?(f={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!f&&l.length===0&&(f={angle:Or[0],alpha:1}),d.push(f),u){const y=Math.log10(f.angle),m=Math.log10(u.angle),x=Math.log10(a);let S;m===y?S=0:S=(x-y)/(m-y),S=Math.max(0,Math.min(1,S));const v=S*S*(3-2*S);v>bh&&(u.alpha=v,d.push(u))}const p=[],g=new Set;d.sort((y,m)=>m.angle-y.angle);for(const y of d)g.has(y.angle)||(p.push(y),g.add(y.angle));return p.length===0&&p.push({angle:Or[0],alpha:1}),p}function dc(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:s,colors:i,isDragConfirmed:o,dragPreviewVertices:r,currentAltPressed:a},d,l,c){if(!n&&s.length===0)return;const h=new Map;o&&r&&r.forEach(u=>{if(u&&u.id){const p=u.originalId||u.id;h.set(p,u)}});const f=u=>o&&h.has(u)?h.get(u):l(u);t.forEach(u=>{const p=c(u),g=s.includes(p),y=!a&&p===n;if(o&&u.vertexIds.some(m=>h.has(m)),(g||y)&&u.color!=="transparent"){e.save(),e.fillStyle=i.selectionGlow,e.globalAlpha=Qd,e.beginPath();const m=u.vertexIds.map(S=>f(S)).filter(S=>S&&S.type==="regular");if(m.length<3){e.restore();return}m.map(S=>d(S)).forEach((S,v)=>{v===0?e.moveTo(S.x,S.y):e.lineTo(S.x,S.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(S=>{const v=t.find(b=>b.id===S);if(v){const b=v.vertexIds.map(T=>f(T)).filter(T=>T&&T.type==="regular");if(b.length>=3){const T=b.map(_=>d(_));e.moveTo(T[0].x,T[0].y),T.slice(1).forEach(_=>e.lineTo(_.x,_.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function Ra(e,t,{colors:n,verticesVisible:s=!0,isSnapped:i=!1},o){if(t.type===Bn&&!s&&!i)return;const r=o(t);switch(t.type){case Bn:e.beginPath(),e.arc(r.x,r.y,$e,0,Be),e.fillStyle=i?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case rn:case $n:case Sn:case Qn:const a=dr*2,d={type:t.type,x:r.x-a/2,y:r.y-a/2,width:a,height:a};br(e,d,n);break}}function hc(e,t,n,s){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=s)return{ranges:[[0,360]],isFullCircle:!0};const i={left:0,right:n,top:0,bottom:s};if(e.x+t<i.left||e.x-t>i.right||e.y+t<i.top||e.y-t>i.bottom)return null;const o=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(o.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const a=[];if(o.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const g=u.x-e.x,y=u.y-e.y,m=Math.atan2(-y,g),x=m<0?m+2*Math.PI:m;a.push(x*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{ka({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(g=>{const y=g.x-e.x,m=g.y-e.y,x=Math.atan2(-m,y),S=x<0?x+2*Math.PI:x;a.push(S*180/Math.PI)})}),a.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(a.map(u=>Math.round(u*1e6)/1e6))].sort((u,p)=>u-p);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let c=0,h=0,f=0;for(let u=0;u<l.length;u++){const p=l[u],g=l[(u+1)%l.length];let y;u===l.length-1?y=360-p+g:y=g-p,y>c&&(c=y,h=p,f=g)}return f>h?{ranges:[[f,h+360]],isFullCircle:!1}:{ranges:[[f,h]],isFullCircle:!1}}function rf(e,{canvas:t,dpr:n,colors:s}){const i=t.width/n,o=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=s.background,e.fillRect(0,0,i,o)}function gs(e,t){return e?.colorMode||t}function qo(e,t){return e?.colorMode||t}function zi(e,t=32){if(!e||e.length!==2)return e;const[n,s]=e,i=[];for(let o=0;o<=t;o++){const r=o/t;i.push({x:n.x+(s.x-n.x)*r,y:n.y+(s.y-n.y)*r})}return i}function af(e,{allFaces:t,allEdges:n,facesVisible:s,isDragConfirmed:i,dragPreviewVertices:o,transformIndicatorData:r,initialDragVertexStates:a,colors:d,initialCoordSystemStates:l,interpolationStyle:c,getInterpolationStyleById:h,faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x",edgeWeightExpression:m="1-r",faceVertexWeightExpression:x="1/(r+0.001)",faceEdgeWeightExpression:S="1/(r+0.001)",angleDisplayMode:v="degrees"},b,T){if(!s||!t||!d||!e)return;const _=M=>{if(i&&o){const I=o.find(w=>w&&(w.id===M||w.originalId===M));if(I)return I}return T(M)};t.filter(M=>!M.parentFaceId).forEach(M=>{if(!M||!M.vertexIds||M.vertexIds.length<3)return;const I=M.vertexIds.map($=>_($)).filter($=>$&&$.type==="regular");if(I.length<3)return;const w=M.interpolationStyleId&&h?h(M.interpolationStyleId):null,P=(w?xs(I,w,!0,b):I).map($=>b($));let A=M,R=M.localCoordSystem;if(i&&M.vertexIds.some($=>o.some(F=>F.id===$))&&M.localCoordSystem){const $=l.get(M.id);R=Uo(M,{initialSystem:$,dragPreviewVertices:o,initialDragVertexStates:a,findVertexById:T,transformIndicatorData:r}),A={...M,localCoordSystem:R}}P.every($=>$&&typeof $.x=="number"&&typeof $.y=="number")&&qi(e,P,A,d,b,T,n,t,_,!0,c,{faceColorMode:qo(M,f),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:x,faceEdgeWeightExpression:S,angleDisplayMode:v})}),t.filter(M=>M.parentFaceId&&M.color!=="transparent").forEach(M=>{if(!M||!M.vertexIds||M.vertexIds.length<3)return;const I=M.vertexIds.map($=>_($)).filter($=>$&&$.type==="regular");if(I.length<3)return;const w=M.interpolationStyleId&&h?h(M.interpolationStyleId):null,P=(w?xs(I,w,!0,b):I).map($=>b($));let A=M,R=M.localCoordSystem;if(i&&M.vertexIds.some($=>o.some(F=>F.id===$))&&M.localCoordSystem){const $=l.get(M.id);R=Uo(M,{initialSystem:$,dragPreviewVertices:o,initialDragVertexStates:a,findVertexById:T,transformIndicatorData:r}),A={...M,localCoordSystem:R}}P.every($=>$&&typeof $.x=="number"&&typeof $.y=="number")&&qi(e,P,A,d,b,T,n,t,_,!1,c,{faceColorMode:qo(M,f),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:x,faceEdgeWeightExpression:S,angleDisplayMode:v})})}function Uo(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:s,findVertexById:i,transformIndicatorData:o}){if(!t)return e.localCoordSystem;const r=new Set(e.vertexIds),a=new Set(s.map(p=>p.id));if([...r].every(p=>a.has(p))){const p=JSON.parse(JSON.stringify(t));if(o){const{center:g,rotation:y,scale:m,directionalScale:x,startPos:S}=o,v={x:S.x-g.x,y:S.y-g.y};if(p.origin=ut(t.origin,g,y,m,x,v),x){const b=Cn({x:1,y:0},t),T=ut(b,g,y,m,x,v);p.scale=ie(p.origin,T)}else p.angle=Tn(t.angle+y),p.scale=t.scale*m}else if(s.length>0&&n.length>0){const g=s.find(m=>r.has(m.id)),y=g?n.find(m=>m.id===g.id):null;if(y){const m=y.x-g.x,x=y.y-g.y;p.origin.x+=m,p.origin.y+=x}}return p}const l=e.vertexIds.map(p=>n.find(g=>g&&g.id===p)||i(p)).filter(p=>p&&p.type==="regular");if(!t.isCustom){const p=Sr(l);if(p){const g=o?o.rotation:0;return{...t,origin:p.center,scale:p.radius,angle:Tn(t.angle+g)}}return t}const c=JSON.parse(JSON.stringify(t));if(o){const{center:p,rotation:g,scale:y,directionalScale:m,startPos:x}=o,S={x:x.x-p.x,y:x.y-p.y};if(c.origin=ut(t.origin,p,g,y,m,S),m){const v=Cn({x:1,y:0},t),b=ut(v,p,g,y,m,S);c.scale=ie(c.origin,b)}else c.angle=Tn(t.angle+g),c.scale=t.scale*y}let h={...c.origin},f=c.angle,u=c.scale;if(c.attachedToVertex){if(a.has(c.attachedToVertex)){const p=n.find(g=>g.id===c.attachedToVertex);p&&(h={...p})}}else if(c.attachedToEdge&&(a.has(c.attachedToEdge.v1)||a.has(c.attachedToEdge.v2))){const p=n.find(y=>y.id===c.attachedToEdge.v1)||i(c.attachedToEdge.v1),g=n.find(y=>y.id===c.attachedToEdge.v2)||i(c.attachedToEdge.v2);p&&g&&(h={x:p.x+c.attachedToEdge.t*(g.x-p.x),y:p.y+c.attachedToEdge.t*(g.y-p.y)})}if(c.rotationAlignedToEdge&&(a.has(c.rotationAlignedToEdge.v1)||a.has(c.rotationAlignedToEdge.v2))){const p=n.find(y=>y.id===c.rotationAlignedToEdge.v1)||i(c.rotationAlignedToEdge.v1),g=n.find(y=>y.id===c.rotationAlignedToEdge.v2)||i(c.rotationAlignedToEdge.v2);if(p&&g){const y=Math.atan2(g.y-p.y,g.x-p.x),{originalAngle:m,originalSystemAngle:x}=c.rotationAlignedToEdge,S=x-m;f=Tn(y+S)}}if(c.scaleAttachedToEdge&&(a.has(c.scaleAttachedToEdge.v1)||a.has(c.scaleAttachedToEdge.v2))){const p=n.find(y=>y.id===c.scaleAttachedToEdge.v1)||i(c.scaleAttachedToEdge.v1),g=n.find(y=>y.id===c.scaleAttachedToEdge.v2)||i(c.scaleAttachedToEdge.v2);p&&g&&(u=ie(p,g)*c.scaleAttachedToEdge.scaleRatio)}return l.length>=3?c.origin=yo(h,l):c.origin=h,c.angle=f,c.scale=Math.max(.01,u),c}function lf(e,t,n){const{copyCount:s,isDragConfirmed:i,initialDragVertexStates:o,dragPreviewVertices:r,transformIndicatorData:a,allEdges:d,allFaces:l,findVertexById:c,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",edgeWeightExpression:m="1-r",faceColorExpression:x="x",faceColorPolarExpression:S="r",faceVertexWeightExpression:v="1/(r+0.001)",faceEdgeWeightExpression:b="1/(r+0.001)",angleDisplayMode:T="degrees",initialCoordSystemStates:_=new Map,getInterpolationStyleById:C}=t,E=o.length===1&&!a&&o[0].type==="regular";if(!i||!o.length||s<=0||E)return;const M=o.filter(A=>A.type==="regular");if(M.length===0)return;const I=new Set(M.map(A=>A.id)),w=d.filter(A=>I.has(A.id1)&&I.has(A.id2)),L=d.filter(A=>I.has(A.id1)&&!I.has(A.id2)||I.has(A.id2)&&!I.has(A.id1)),P=l.filter(A=>A.vertexIds.every(R=>I.has(R)));e.save(),e.globalAlpha=1;for(let A=0;A<s;A++){A+=s==1;const R=A,O=A;let $;const F=new Map;if(a){const{center:k,rotation:Y,scale:X,directionalScale:z,startPos:G}=a,W={x:G.x-k.x,y:G.y-k.y};$=M.map(H=>{const q=ut(H,k,Y*O,Math.pow(X,O),z,W);return{...H,...q,id:`preview_${H.id}_${R}`,originalId:H.id,transformIndex:R}})}else{const k=r.length>0?r[0].x-o[0].x:0,Y=r.length>0?r[0].y-o[0].y:0;$=M.map(X=>({...X,x:X.x+k*O,y:X.y+Y*O,id:`preview_${X.id}_${R}`,originalId:X.id,transformIndex:R}))}if(!$||$.length===0)continue;$.forEach(k=>F.set(k.originalId,k)),P.forEach(k=>{const Y=k.vertexIds.map(X=>F.get(X)).filter(Boolean);if(Y.length===k.vertexIds.length){const X=k.interpolationStyleId&&C?C(k.interpolationStyleId):null,G=(X?xs(Y,X,!0,n):Y).map(H=>n(H));let W=k;if(k.localCoordSystem){const H=_.get(k.id)||k.localCoordSystem,q=Uo(k,{initialSystem:H,dragPreviewVertices:r,initialDragVertexStates:o,findVertexById:c,transformIndicatorData:a});W={...k,localCoordSystem:q}}qi(e,G,W,h,n,c,d,[],H=>F.get(H),!1,null,{faceColorMode:qo(k,g),edgeColorMode:p,faceColorExpression:x,faceColorPolarExpression:S,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:v,faceEdgeWeightExpression:b,angleDisplayMode:T})}}),e.setLineDash([]),e.lineWidth=As;const V=ht(h.edge,{r:255,g:255,b:255,a:1}),B=k=>ht(k?.color||h.vertex||h.edge,V),D=(k,Y,X,z)=>{const G=gs(k,p);if(G==="inherit_vertices"&&X&&z){const W=B(X),H=B(z),q=k.weightExpression||m,K=ie(X,z)||1,ne=Y*K,he=(1-Y)*K,ae=ne/K,se=he/K,Q=mt(q,{r:ae,a:0},1),ee=mt(q,{r:se,a:0},1);return ao([W,H],[Q,ee])}if(G==="colormap"&&k.colormapItem){const W=k.colorExpression||y,H=mt(W,{x:Y},Y),q=We(k.colormapItem,H);return ht(q,V)}return ht(k.color||h.edge,V)},N=k=>F.get(k)||c(k);w.forEach(k=>{const Y=F.get(k.id1),X=F.get(k.id2);if(Y&&X){const z=k.interpolationStyleId&&C?C(k.interpolationStyleId):null;let G=Wi(k,z,Y,X,d,N,n);const W=gs(k,p);G.length===2&&(W==="inherit_vertices"||W==="colormap")&&(G=zi(G));const H=G.map(ae=>n(ae));if(H.length<2)return;const q=H[0],K=H[H.length-1];if(W==="inherit_vertices"||W==="colormap"){B(Y),B(X);let ae=0;for(let Q=1;Q<H.length;Q++)ae+=Math.hypot(H[Q].x-H[Q-1].x,H[Q].y-H[Q-1].y);let se=0;for(let Q=1;Q<H.length;Q++){const ee=H[Q-1],te=H[Q],ce=Math.hypot(te.x-ee.x,te.y-ee.y),fe=ae>0?se/ae:0,Ee=ae>0?(se+ce)/ae:1,Se=(fe+Ee)/2,ve=D(k,Se,Y,X);e.strokeStyle=oa(ve),e.beginPath(),e.moveTo(ee.x,ee.y),e.lineTo(te.x,te.y),e.stroke(),se+=ce}}else if(k.colormapItem){let ae=0;for(let Q=1;Q<H.length;Q++)ae+=Math.hypot(H[Q].x-H[Q-1].x,H[Q].y-H[Q-1].y);let se=0;for(let Q=1;Q<H.length;Q++){const ee=H[Q-1],te=H[Q],ce=Math.hypot(te.x-ee.x,te.y-ee.y),fe=ae>0?se/ae:0,Ee=ae>0?(se+ce)/ae:1,Se=(fe+Ee)/2,ve=k.gradientStart+(k.gradientEnd-k.gradientStart)*Se,Qe=We(k.colormapItem,ve);e.strokeStyle=Qe,e.beginPath(),e.moveTo(ee.x,ee.y),e.lineTo(te.x,te.y),e.stroke(),se+=ce}}else{e.strokeStyle=k.color||h.edge,e.beginPath(),e.moveTo(H[0].x,H[0].y);for(let ae=1;ae<H.length;ae++)e.lineTo(H[ae].x,H[ae].y);e.stroke()}const ne=le(k);if((f?.get(ne)||[]).some(ae=>ae.copyIndex===R)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Ns,e.lineWidth=ms,e.lineCap="round",e.lineJoin="round";const ae=K.x-q.x,se=K.y-q.y,Q=Math.hypot(ae,se),ee=Ni;if(Q>ue){const te=-se/Q,ce=ae/Q,fe=te*ee,Ee=ce*ee;e.beginPath(),e.arc(q.x,q.y,ee,Math.atan2(Ee,fe),Math.atan2(-Ee,-fe)),e.lineTo(K.x-fe,K.y-Ee),e.arc(K.x,K.y,ee,Math.atan2(-Ee,-fe),Math.atan2(Ee,fe)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(q.x,q.y,ee,0,Be),e.stroke();e.restore()}}}),L.forEach(k=>{const Y=I.has(k.id1)?k.id2:k.id1,X=I.has(k.id1)?k.id1:k.id2,z=F.get(X),G=c(Y);if(z&&G){const W=k.interpolationStyleId&&C?C(k.interpolationStyleId):null;let H=Wi(k,W,z,G,d,N,n);const q=gs(k,p);H.length===2&&(q==="inherit_vertices"||q==="colormap")&&(H=zi(H));const K=H.map(Q=>n(Q));if(K.length<2)return;const ne=K[0],he=K[K.length-1];if(q==="inherit_vertices"||q==="colormap"){B(z),B(G);let Q=0;for(let te=1;te<K.length;te++)Q+=Math.hypot(K[te].x-K[te-1].x,K[te].y-K[te-1].y);let ee=0;for(let te=1;te<K.length;te++){const ce=K[te-1],fe=K[te],Ee=Math.hypot(fe.x-ce.x,fe.y-ce.y),Se=Q>0?ee/Q:0,ve=Q>0?(ee+Ee)/Q:1,Qe=(Se+ve)/2,lt=D(k,Qe,z,G);e.strokeStyle=oa(lt),e.beginPath(),e.moveTo(ce.x,ce.y),e.lineTo(fe.x,fe.y),e.stroke(),ee+=Ee}}else if(k.colormapItem){let Q=0;for(let te=1;te<K.length;te++)Q+=Math.hypot(K[te].x-K[te-1].x,K[te].y-K[te-1].y);let ee=0;for(let te=1;te<K.length;te++){const ce=K[te-1],fe=K[te],Ee=Math.hypot(fe.x-ce.x,fe.y-ce.y),Se=Q>0?ee/Q:0,ve=Q>0?(ee+Ee)/Q:1,Qe=(Se+ve)/2,lt=k.gradientStart+(k.gradientEnd-k.gradientStart)*Qe,Dn=We(k.colormapItem,lt);e.strokeStyle=Dn,e.beginPath(),e.moveTo(ce.x,ce.y),e.lineTo(fe.x,fe.y),e.stroke(),ee+=Ee}}else{e.strokeStyle=k.color||h.edge,e.beginPath(),e.moveTo(K[0].x,K[0].y);for(let Q=1;Q<K.length;Q++)e.lineTo(K[Q].x,K[Q].y);e.stroke()}const ae=le(k);if((f?.get(ae)||[]).some(Q=>Q.copyIndex===R)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Ns,e.lineWidth=ms,e.lineCap="round",e.lineJoin="round";const Q=he.x-ne.x,ee=he.y-ne.y,te=Math.hypot(Q,ee),ce=Ni;if(te>ue){const fe=-ee/te,Ee=Q/te,Se=fe*ce,ve=Ee*ce;e.beginPath(),e.arc(ne.x,ne.y,ce,Math.atan2(ve,Se),Math.atan2(-ve,-Se)),e.lineTo(he.x-Se,he.y-ve),e.arc(he.x,he.y,ce,Math.atan2(-ve,-Se),Math.atan2(ve,Se)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(ne.x,ne.y,ce,0,Be),e.stroke();e.restore()}}}),$.forEach(k=>{const Y=k.originalId,X=u.get(Y)||[],z=X.some(H=>H.copyIndex===R),G=X.find(H=>H.copyIndex===R),W=G?G.type:null;Ra(e,k,{colors:h,verticesVisible:!0,isSnapped:!1},n),z&&La(e,k,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:W,currentAltPressed:!1},n)})}e.restore()}function La(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:r,activeCenterId:a,colors:d,verticesVisible:l=!0,isHovered:c=!1,isSnapped:h=!1,snapType:f=null,currentAltPressed:u}=n;if(u&&c)return;let p;if(t.type===Bn){if(p=o.includes(t.id),!l&&!p&&!c&&!h)return}else p=r.includes(t.id);if(p||c||h){const y=s(t);e.save();let m=d.selectionGlow;t.id===a&&t.type!=="regular"?m=d.activeCenterGlow:h?m=d.feedbackSnapped:c&&(m=d.selectionGlow),e.shadowColor=m,e.shadowBlur=Ea,e.globalAlpha=Ns,e.strokeStyle=m,e.lineWidth=ms,e.beginPath();let x;t.type===Bn?x=$e+Xi:x=dr+Xi,e.arc(y.x,y.y,x,0,Be),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function cf(e,t,n){const{copyCount:s=1,initialDragVertexStates:i,dragPreviewVertices:o,allEdges:r,allFaces:a,findVertexById:d,findNeighbors:l,findAllVerticesInSubgraph:c,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",edgeWeightExpression:m="1-r",faceColorExpression:x="x",faceColorPolarExpression:S="r",faceVertexWeightExpression:v="1/(r+0.001)",faceEdgeWeightExpression:b="1/(r+0.001)",angleDisplayMode:T="degrees",initialCoordSystemStates:_=new Map,getInterpolationStyleById:C}=t;if(!i||i.length!==1||!o||o.length===0)return;const E=i[0];for(let M=0;M<s;M++){M+=s==1;const I=M,w=M;let L;const P=o.length>0?o[0].x-i[0].x:0,A=o.length>0?o[0].y-i[0].y:0;L={x:E.x+P*w,y:E.y+A*w};const R={...E,...L,originalId:E.id,transformIndex:I},O=new Set(c(E.id)),$=r.filter(k=>O.has(k.id1)&&O.has(k.id2)),F=a.filter(k=>k.vertexIds.every(Y=>O.has(Y))),V=k=>k===E.id?R:O.has(k)?d(k):null;F.forEach(k=>{const Y=k.vertexIds.map(V).filter(Boolean);if(Y.length>=3){const X=k.interpolationStyleId&&C?C(k.interpolationStyleId):null,G=(X?xs(Y,X,!0,n):Y).map(H=>n(H));let W=k;if(k.localCoordSystem){const H=_.get(k.id)||k.localCoordSystem,q=Uo(k,{initialSystem:H,dragPreviewVertices:o,initialDragVertexStates:i,findVertexById:d,transformIndicatorData:null});W={...k,localCoordSystem:q}}qi(e,G,W,h,n,d,r,a,V,!0,null,{faceColorMode:qo(k,g),edgeColorMode:p,faceColorExpression:x,faceColorPolarExpression:S,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:v,faceEdgeWeightExpression:b,angleDisplayMode:T})}}),e.save(),e.lineWidth=As,e.setLineDash([]);const B=ht(h.edge,{r:255,g:255,b:255,a:1}),D=k=>ht(k?.color||h.vertex||h.edge,B),N=(k,Y,X,z)=>{const G=gs(k,p);if(G==="inherit_vertices"&&X&&z){const W=D(X),H=D(z),q=k.weightExpression||m,K=ie(X,z)||1,ne=Y*K,he=(1-Y)*K,ae=ne/K,se=he/K,Q=mt(q,{x:0,y:0,r:ae,a:0},1),ee=mt(q,{x:0,y:0,r:se,a:0},1);return ao([W,H],[Q,ee])}if(G==="colormap"&&k.colormapItem){const W=k.colorExpression||y,H=mt(W,{x:Y},Y),q=We(k.colormapItem,H);return ht(q,B)}return ht(k.color||h.edge,B)};$.forEach(k=>{const Y=V(k.id1),X=V(k.id2);if(Y&&X){const z=k.interpolationStyleId&&C?C(k.interpolationStyleId):null;let W=Wi(k,z,Y,X,r,se=>V(se),n);const H=gs(k,p);W.length===2&&(H==="inherit_vertices"||H==="colormap")&&(W=zi(W));const q=W.map(se=>n(se));if(q.length<2)return;const K=q[0],ne=q[q.length-1];if(H==="inherit_vertices"||H==="colormap"){let se=0;for(let ee=1;ee<q.length;ee++)se+=Math.hypot(q[ee].x-q[ee-1].x,q[ee].y-q[ee-1].y);let Q=0;for(let ee=1;ee<q.length;ee++){const te=q[ee-1],ce=q[ee],fe=Math.hypot(ce.x-te.x,ce.y-te.y),Ee=se>0?Q/se:0,Se=se>0?(Q+fe)/se:1,ve=(Ee+Se)/2,Qe=N(k,ve,Y,X);e.strokeStyle=oa(Qe),e.beginPath(),e.moveTo(te.x,te.y),e.lineTo(ce.x,ce.y),e.stroke(),Q+=fe}}else if(k.colormapItem){let se=0;for(let ee=1;ee<q.length;ee++)se+=Math.hypot(q[ee].x-q[ee-1].x,q[ee].y-q[ee-1].y);let Q=0;for(let ee=1;ee<q.length;ee++){const te=q[ee-1],ce=q[ee],fe=Math.hypot(ce.x-te.x,ce.y-te.y),Ee=se>0?Q/se:0,Se=se>0?(Q+fe)/se:1,ve=(Ee+Se)/2,Qe=k.gradientStart+(k.gradientEnd-k.gradientStart)*ve,lt=We(k.colormapItem,Qe);e.strokeStyle=lt,e.beginPath(),e.moveTo(te.x,te.y),e.lineTo(ce.x,ce.y),e.stroke(),Q+=fe}}else{e.strokeStyle=k.color||h.edge,e.beginPath(),e.moveTo(q[0].x,q[0].y);for(let se=1;se<q.length;se++)e.lineTo(q[se].x,q[se].y);e.stroke()}const he=le(k);if((f?.get(he)||[]).some(se=>se.copyIndex===I)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Ns,e.lineWidth=ms,e.lineCap="round",e.lineJoin="round";const se=ne.x-K.x,Q=ne.y-K.y,ee=Math.hypot(se,Q),te=Ni;if(ee>ue){const ce=-Q/ee,fe=se/ee,Ee=ce*te,Se=fe*te;e.beginPath(),e.arc(K.x,K.y,te,Math.atan2(Se,Ee),Math.atan2(-Se,-Ee)),e.lineTo(ne.x-Ee,ne.y-Se),e.arc(ne.x,ne.y,te,Math.atan2(-Se,-Ee),Math.atan2(Se,Ee)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(K.x,K.y,te,0,Be),e.stroke();e.restore()}}}),e.restore(),O.forEach(k=>{const Y=V(k);if(!Y)return;const X=k===E.id,z=u.get(E.id)||[],G=X&&z.some(K=>K.copyIndex===I),W=X?z.find(K=>K.copyIndex===I):null,H=W?W.type:null,q={...Y,id:`preview_${Y.originalId||Y.id}_${I}`,originalId:Y.originalId||Y.id,transformIndex:I};Ra(e,q,{colors:h,verticesVisible:!0,isSnapped:!1},n),G&&La(e,q,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:H,currentAltPressed:!1},n)})}}function fc(e,{startVertex:t,snappedData:n,isShiftPressed:s,currentColor:i,nextCreationColor:o,nextEdgeColor:r,colors:a,edgeColormapInfo:d,interpolationStyle:l},c){const h=c(t),f=c(n);e.save();let u=[{x:t.x,y:t.y},{x:n.x,y:n.y}];if(l&&l.type&&l.type!=="linear"?(u=xs(u,l,!1,null),e.setLineDash([])):e.setLineDash(qn),d&&d.colormapItem){const m=e.createLinearGradient(h.x,h.y,f.x,f.y),x=We(d.colormapItem,d.startT),S=We(d.colormapItem,d.endT);m.addColorStop(0,x),m.addColorStop(1,S),e.strokeStyle=m}else n.snapped||s?e.strokeStyle=a.feedbackSnapped:e.strokeStyle=r;e.lineWidth=As;const g=u.map(m=>c(m));e.beginPath(),e.moveTo(g[0].x,g[0].y);for(let m=1;m<g.length;m++)e.lineTo(g[m].x,g[m].y);if(e.stroke(),e.restore(),l?.linearStyle==="arrows"&&g.length>=2){const m=(v,b)=>{const T=Math.atan2(b.y-v.y,b.x-v.x),_=Ye*.6,C={x:b.x-Math.cos(T)*_+Math.cos(T+Math.PI/2)*_*.6,y:b.y-Math.sin(T)*_+Math.sin(T+Math.PI/2)*_*.6},E={x:b.x-Math.cos(T)*_+Math.cos(T-Math.PI/2)*_*.6,y:b.y-Math.sin(T)*_+Math.sin(T-Math.PI/2)*_*.6};e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(C.x,C.y),e.lineTo(E.x,E.y),e.closePath(),e.fill()};e.save();const x=g[g.length-2],S=g[g.length-1];e.fillStyle=e.strokeStyle||r,m(x,S),e.restore()}if(e.save(),e.beginPath(),e.arc(f.x,f.y,$e,0,Be),n.snapped?e.fillStyle=a.feedbackSnapped:e.fillStyle=o,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=a.feedbackSnapped,e.shadowBlur=Ea,e.globalAlpha=Ns,e.strokeStyle=a.feedbackSnapped,e.lineWidth=ms;const m=$e+Xi;e.beginPath(),e.arc(f.x,f.y,m,0,Be),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function Hi(e,t,n){const s=[];if(n>360){const o=n-360,r=Math.floor(t/e)*e;for(let a=r;a<360;a+=e)a>=t&&s.push(a);for(let a=0;a<=o+e;a+=e)a<=o&&s.push(a)}else{const o=Math.floor(t/e)*e;for(let r=o;r<=n+e;r+=e)r>=t&&r<=n&&r>=0&&r<360&&s.push(r)}return[...new Set(s)].sort((o,r)=>o-r)}function df(e,t,n){return e.x>=-20&&e.x<=t+Ft&&e.y>=-20&&e.y<=n+Ft}function hf(e,t,n,s,i,{canvas:o,dpr:r,viewTransform:a,angleDisplayMode:d,colors:l},c,h){if(typeof c!="function"||typeof n!="function")return;const f=c({x:0,y:0}),u=o.width/r,p=o.height/r,g={x:u/2,y:p/2},y=Math.min(u,p)/4,m=ie(f,g),x=y+m;if(x<ec||!uc(f.x,f.y,x,u,p))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=xn;const S=Math.min(u,p)*400,v=x>S;let b=null;if(v){const w={x:0,y:0,w:u,h:p},L={x:f.x,y:f.y,r:x},P=ia(L,w);if(P.length>=2){let A=P[0],R=P[1],O=0;for(let V=0;V<P.length;V++)for(let B=V+1;B<P.length;B++){const D=(P[V].x-P[B].x)**2+(P[V].y-P[B].y)**2;D>O&&(O=D,A=P[V],R=P[B])}e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(R.x,R.y),e.stroke();const $=(Math.atan2(f.y-A.y,A.x-f.x)*180/Math.PI+360)%360,F=(Math.atan2(f.y-R.y,R.x-f.x)*180/Math.PI+360)%360;b={minAngle:Math.min($,F),maxAngle:Math.max($,F),isFullCircle:!1},Math.abs($-F)>180&&(b={minAngle:Math.max($,F),maxAngle:Math.min($,F)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(f.x,f.y,x,0,2*Math.PI),e.stroke(),b=hc(f,x,u,p);if(e.restore(),!b)return;const T=x/(a.scale/r),_=new Set,C=new Map;h.forEach(w=>{const L=w.alpha;if(L<Ul||x*(w.angle*Math.PI/180)<tc*.5)return;const A=`rgba(${l.feedbackDefault.join(",")}, ${L*Yd})`;let R;if(b.isFullCircle){R=[];for(let O=0;O<360;O+=w.angle)R.push(O)}else R=[],b.ranges&&Array.isArray(b.ranges)?b.ranges.forEach(O=>{const[$,F]=O,V=Hi(w.angle,$,F);R.push(...V)}):b.minAngle!==void 0&&b.maxAngle!==void 0&&(R=Hi(w.angle,b.minAngle,b.maxAngle)),R=[...new Set(R)];R.forEach(O=>{if(O=Math.round(O*1e10)/1e10,d==="degrees"){if(_.has(O))return}else if(d==="radians"){const k=`${O}-${w.angle}`;if(C.has(k))return}const $=O*Math.PI/180,F={x:f.x+(x+Bi)*Math.cos($),y:f.y-(x+Bi)*Math.sin($)},V=Gd;if(!(F.x>-V&&F.x<u+V&&F.y>-V&&F.y<p+V))return;let D={textAlign:"center",textBaseline:"middle"};if(d==="radians"&&(D={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=A,e.lineWidth=Zn,O%90===0&&O<360){const k={x:f.x+x*Math.cos($),y:f.y-x*Math.sin($)};let Y;const X=St*1.5;switch(O){case 0:Y={x:Math.SQRT1_2,y:-Math.SQRT1_2},D={textAlign:"left",textBaseline:"bottom"};break;case 90:Y={x:Math.SQRT1_2,y:-Math.SQRT1_2},D={textAlign:"left",textBaseline:"bottom"};break;case 180:Y={x:-Math.SQRT1_2,y:-Math.SQRT1_2},D={textAlign:"right",textBaseline:"bottom"};break;case 270:Y={x:Math.SQRT1_2,y:Math.SQRT1_2},D={textAlign:"left",textBaseline:"top"};break}const z={x:k.x+Y.x*X,y:k.y+Y.y*X};e.lineWidth=Wd,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(z.x,z.y),e.stroke(),F.x=z.x,F.y=z.y}else{const k={x:f.x+(x-$e)*Math.cos($),y:f.y-(x-$e)*Math.sin($)},Y={x:f.x+(x+$e)*Math.cos($),y:f.y-(x+$e)*Math.sin($)};df(Y,u,p)&&(e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(Y.x,Y.y),e.stroke())}e.restore();let N="";if(d==="degrees"){let k=Math.max(0,(w.angle.toString().split(".")[1]||"").length);w.angle<1&&(k=Math.max(k,Math.ceil(-Math.log10(w.angle))+1));const Y=Math.round(O*Math.pow(10,k))/Math.pow(10,k),X=parseFloat(Y.toFixed(k));N=`${Math.round(X*1e10)/1e10}^{\\circ}`}else if(O===0&&d==="radians")N="0";else if(O!==0)if(w.angle<=5){const Y=O*Math.PI/180,X=Math.max(0,(w.angle.toString().split(".")[1]||"").length),z=Math.max(3,X+2);let G=Y.toFixed(z);G=parseFloat(G).toString(),parseFloat(G)!==0&&(N=G)}else{const Y=O,X=180,z=Da(Y,X),G=Y/z,W=X/z;W===1?G===1?N="\\pi":G===-1?N="-\\pi":N=`${G}\\pi`:G===1?N=`\\frac{\\pi}{${W}}`:G===-1?N=`-\\frac{\\pi}{${W}}`:G<0?N=`-\\frac{${Math.abs(G)}\\pi}{${W}}`:N=`\\frac{${G}\\pi}{${W}}`}if(N){const k=d==="radians"?`circ-label-${O}-${w.angle}-${T.toExponential(15)}`:`circ-label-${O}-${T.toExponential(15)}`;if(n({id:k,content:N,x:F.x,y:F.y,color:A,fontSize:Zr,options:D}),d==="degrees")_.add(O);else{const Y=`${O}-${w.angle}`;C.set(Y,{levelAngle:w.angle,alpha:L,labelId:k})}}})});const E=l.feedbackDefault;let M=-1/0;const I={x:f.x+x,y:f.y};if(I.x>-20&&I.x<u+Ft&&I.y>-20&&I.y<p+Ft)M=0;else{const w={x:0,y:0,w:u,h:p},L={x:f.x,y:f.y,r:x},P=ia(L,w);if(P.length>0){let A=-1/0;P.forEach(O=>{const $=Math.atan2(f.y-O.y,O.x-f.x),F=$>=0?$:$+2*Math.PI,V={x:f.x+x*Math.cos(F),y:f.y-x*Math.sin(F)},B=Ft;V.x>-B&&V.x<u+B&&V.y>-B&&V.y<p+B&&F>A&&(A=F)}),[{x:0,y:0},{x:w.w,y:0},{x:w.w,y:w.h},{x:0,y:w.h}].forEach(O=>{if(ie(O,f)<L.r){const $=Math.atan2(f.y-O.y,O.x-f.x),F=$>=0?$:$+2*Math.PI,V={x:f.x+x*Math.cos(F),y:f.y-x*Math.sin(F)},B=Ft;V.x>-B&&V.x<u+B&&V.y>-B&&V.y<p+B&&F>A&&(A=F)}}),A>-1/0&&(M=A)}}if(M>-1/0){const w=M,L={x:f.x+x*Math.cos(w),y:f.y-x*Math.sin(w)},P={x:-Math.sin(w),y:-Math.cos(w)},A={x:Math.cos(w),y:-Math.sin(w)},R={x:L.x-Ye*P.x+Ye/2*A.x,y:L.y-Ye*P.y+Ye/2*A.y},O={x:L.x-Ye*P.x-Ye/2*A.x,y:L.y-Ye*P.y-Ye/2*A.y};e.save(),e.fillStyle=`rgba(${E.join(",")}, 1.0)`,e.beginPath(),e.moveTo(L.x,L.y),e.lineTo(R.x,R.y),e.lineTo(O.x,O.y),e.closePath(),e.fill(),e.restore();let $;if(w===0)$={x:L.x-_r,y:L.y+Dr+Ye};else{const F={x:-Math.cos(w),y:Math.sin(w)};$={x:L.x+F.x*(Dr+Ye)+P.x*_r,y:L.y+F.y*(Dr+Ye)+P.y*_r}}n({id:"theta-label-sticky",content:"\\theta",x:$.x,y:$.y,color:`rgba(${E.join(",")}, 1.0)`,fontSize:cs,options:{textAlign:"center",textBaseline:"middle"}})}}function ia(e,t){const{x:n,y:s,r:i}=e,{x:o,y:r,w:a,h:d}=t,l=[],c={center:{x:n,y:s},radius:i},h=(f,u,p,g)=>{ka({p1:{x:f,y:u},p2:{x:p,y:g}},c).forEach(x=>{const S=p-f,v=g-u;let b;Math.abs(S)>Math.abs(v)?b=(x.x-f)/S:b=(x.y-u)/v,b>=0&&b<=1&&l.push({x:x.x,y:x.y})})};return h(o,r,o+a,r),h(o+a,r,o+a,r+d),h(o+a,r+d,o,r+d),h(o,r+d,o,r),l}function uc(e,t,n,s,i){return!(e+n<0||e-n>s||t+n<0||t-n>i)}function ff(e,t,n,s,i,o,r){const a=`rgba(${r.axisTickLabel.join(",")}, ${Fi})`,d=St*_d;e.save(),e.strokeStyle=a,e.lineWidth=Dd,e.setLineDash([]);const l=d,c=l/Math.tan(Ad),h=t.x-c,f=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(h,f),e.stroke(),e.restore(),o({id:"tick-label-origin",content:Kd,x:t.x-St-ds,y:t.y+St+ds,color:a,fontSize:_s,options:{textAlign:"right",textBaseline:"top"}})}function uf(e,t,{canvas:n,dpr:s,coordsDisplayMode:i,viewTransform:o,angleDisplayMode:r,colors:a},d,l,c,h,f){e.save();const u=n.width/s,p=n.height/s,g=d({x:0,y:0}),y=(S,v,b,T)=>{e.beginPath(),e.moveTo(S,v),e.lineTo(b,T),e.stroke();const _=Math.atan2(T-v,b-S);e.beginPath(),e.moveTo(b,T),e.lineTo(b-Ye*Math.cos(_-pn),T-Ye*Math.sin(_-pn)),e.lineTo(b-Ye*Math.cos(_+pn),T-Ye*Math.sin(_+pn)),e.closePath(),e.fill()},m=(S,v,b,T,_)=>{const C=new Map,E=new Map,M=($,F,V)=>{if(!$||F<fr)return;const B=l({x:0,y:0}),D=l({x:u,y:p}),N=$*ue;{const k=Math.floor(B.x/$),Y=Math.ceil(D.x/$),X=Math.floor(D.y/$),z=Math.ceil(B.y/$);for(let G=k;G<=Y;G++){const W=G*$;if(Math.abs(W)<N)continue;const H=C.get(W);H?V?C.set(W,{alpha:Math.max(H.alpha,F),isCoarser:!0}):H.isCoarser||C.set(W,{alpha:Math.max(H.alpha,F),isCoarser:!1}):C.set(W,{alpha:F,isCoarser:V})}for(let G=X;G<=z;G++){const W=G*$;if(Math.abs(W)<N)continue;const H=E.get(W);H?V?E.set(W,{alpha:Math.max(H.alpha,F),isCoarser:!0}):H.isCoarser||E.set(W,{alpha:Math.max(H.alpha,F),isCoarser:!1}):E.set(W,{alpha:F,isCoarser:V})}}},I=!b||S>=b;M(S,v,I),M(b,T,!I);let w=!1;const L=$=>{const F=Math.abs($);(F>=Qr||F>0&&F<ea)&&(w=!0)};C.forEach(($,F)=>L(F)),E.forEach(($,F)=>L(F));const P=l({x:0,y:0}),A=l({x:u,y:p});L(P.x),L(P.y),L(A.x),L(A.y);const R=S||b||1,O=R>0?Math.max(0,-Math.floor(Math.log10(R))):0;return C.forEach(($,F)=>{const V=$.isCoarser?1:$.alpha,B=`rgba(${a.axisTickLabel.join(",")}, ${Fi*V})`;e.strokeStyle=B,e.lineWidth=Zn;{const D=d({x:F,y:0}).x;e.beginPath(),e.moveTo(D,g.y),e.lineTo(D,g.y+St),e.stroke();let N;if(w){const Y=Math.log10(Math.abs(F)),X=Math.floor(Y),z=R/Math.pow(10,X),G=Math.max(0,-Math.floor(Math.log10(z))+1),H=Math.abs(F).toExponential(G).split("e");let q=H[0];q=q.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let K=parseInt(H[1],10);N=`${F<0?"-":""}${q} \\cdot 10^{${K}}`}else N=F.toFixed(O).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");f({id:((Y,X)=>`${Y}-${X.toExponential(15)}`)("tick-label-x",F),content:N,x:D,y:g.y+St+ds,color:B,fontSize:_s,options:{textAlign:"center",textBaseline:"top"}})}}),E.forEach(($,F)=>{const V=$.isCoarser?1:$.alpha,B=`rgba(${a.axisTickLabel.join(",")}, ${Fi*V})`;e.strokeStyle=B,e.lineWidth=Zn;const D=d({x:0,y:F}).y;let N;if(w){const Y=Math.log10(Math.abs(F)),X=Math.floor(Y),z=R/Math.pow(10,X),G=Math.max(0,-Math.floor(Math.log10(z))+1),H=Math.abs(F).toExponential(G).split("e");let q=H[0];q=q.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let K=parseInt(H[1],10);N=`${F<0?"-":""}${q} \\cdot 10^{${K}}`}else N=F.toFixed(O).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");i===zo&&Math.abs(F)>ue&&(N==="1"?N=Ei:N==="-1"?N=`-${Ei}`:N+=Ei),e.beginPath(),e.moveTo(g.x,D),e.lineTo(g.x-St,D),e.stroke(),f({id:((Y,X)=>`${Y}-${X.toExponential(15)}`)("tick-label-y",F),content:N,x:g.x-St-ds,y:D,color:B,fontSize:_s,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:w}};e.lineWidth=Hd,e.strokeStyle=a.axis,e.fillStyle=a.axis;let x={useScientific:!1};if(i===mr){const{interval1:S,interval2:v,alpha1:b,alpha2:T}=c;pf(e,t,{canvas:n,dpr:s,colors:a},d,f);let _=!1;const C=I=>{const w=Math.abs(I);(w>=Qr||w>0&&w<ea)&&(_=!0)},E=l({x:0,y:0}),M=l({x:u,y:p});C(E.x),C(E.y),C(M.x),C(M.y),gf(e,t,{canvas:n,dpr:s,colors:a},d,l,c,f,_),hf(e,t,f,0,0,{canvas:n,dpr:s,viewTransform:o,angleDisplayMode:r,colors:a},d,h),x={useScientific:_}}else{g.y>0&&g.y<p&&y(0,g.y,u,g.y),g.x>0&&g.x<u&&y(g.x,p,g.x,0);let S="x",v="y";i===zo&&(S=qd,v=Ud),f({id:"axis-label-x",content:S,x:u-Ye-qr,y:g.y-Kr,color:a.axis,fontSize:cs,options:{textAlign:"center",textBaseline:"bottom"}}),f({id:"axis-label-y",content:v,x:g.x+Ur,y:Ye+jr,color:a.axis,fontSize:cs,options:{textAlign:"left",textBaseline:"middle"}}),x=m(c.interval1,c.alpha1,c.interval2,c.alpha2)}return ff(e,g,u,p,i,f,a),e.restore(),x}function gf(e,t,{canvas:n,dpr:s,colors:i},o,r,a,d,l){const c=n.width/s,h=n.height/s,f=o({x:0,y:0}),u=f.y>-20&&f.y<h+Ft,p=f.x>-20&&f.x<c+Ft;if(!u&&!p)return;const{interval1:g,interval2:y,alpha1:m,alpha2:x}=a,S=new Map,v=g||y||1,b=v>0?Math.max(0,-Math.floor(Math.log10(v))):0,T=(C,E,M)=>{if(!C||E<fr)return;let I=0;if(u){const R=r({x:0,y:f.y}),O=r({x:c,y:f.y});I=Math.max(I,Math.abs(R.x),Math.abs(O.x))}if(p){const R=r({x:f.x,y:0}),O=r({x:f.x,y:h});I=Math.max(I,Math.abs(R.y),Math.abs(O.y))}I*=1.1;const w=1,L=Math.ceil(I/C),A=Math.min(L,w+1e3);for(let R=w;R<=A;R++){const O=R*C;let $=!1;if(u){const F=o({x:O,y:0}).x,V=o({x:-O,y:0}).x;(F>=-20&&F<=c+Ft||V>=-20&&V<=c+Ft)&&($=!0)}if(!$&&p){const F=o({x:0,y:O}).y,V=o({x:0,y:-O}).y;(F>=-20&&F<=h+Ft||V>=-20&&V<=h+Ft)&&($=!0)}if($){const F=S.get(O);F?M?S.set(O,{alpha:Math.max(F.alpha,E),isCoarser:!0}):F.isCoarser||S.set(O,{alpha:Math.max(F.alpha,E),isCoarser:!1}):S.set(O,{alpha:E,isCoarser:M})}}},_=!y||g>=y;T(g,m,_),T(y,x,!_),S.forEach((C,E)=>{const M=C.isCoarser?1:C.alpha,I=`rgba(${i.axisTickLabel.join(",")}, ${Fi*M})`;e.strokeStyle=I,e.lineWidth=Zn;let w;if(l){const P=Math.log10(Math.abs(E)),A=Math.floor(P),R=v/Math.pow(10,A),O=Math.max(0,-Math.floor(Math.log10(R))+1),F=Math.abs(E).toExponential(O).split("e");let V=F[0];V=V.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let B=parseInt(F[1],10);w=`${E<0?"-":""}${V} \\cdot 10^{${B}}`}else w=E.toFixed(b).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const L=E.toExponential(15);if(u){const P=o({x:E,y:0});P.x>-20&&P.x<c+Ft&&(e.beginPath(),e.moveTo(P.x,f.y-St/2),e.lineTo(P.x,f.y+St/2),e.stroke(),d({id:`polartick-r-x-${L}`,content:w,x:P.x,y:f.y+St+ds,color:I,fontSize:_s,options:{textAlign:"center",textBaseline:"top"}}));const A=o({x:-E,y:0});A.x>-20&&A.x<c+Ft&&(e.beginPath(),e.moveTo(A.x,f.y-St/2),e.lineTo(A.x,f.y+St/2),e.stroke(),d({id:`polartick-r-negx-${L}`,content:w,x:A.x,y:f.y+St+ds,color:I,fontSize:_s,options:{textAlign:"center",textBaseline:"top"}}))}if(p){const P=o({x:0,y:E});P.y>-20&&P.y<h+Ft&&(e.beginPath(),e.moveTo(f.x-St/2,P.y),e.lineTo(f.x+St/2,P.y),e.stroke(),d({id:`polartick-r-posy-${L}`,content:w,x:f.x-St-ds,y:P.y,color:I,fontSize:_s,options:{textAlign:"right",textBaseline:"middle"}}));const A=o({x:0,y:-E});A.y>-20&&A.y<h+Ft&&(e.beginPath(),e.moveTo(f.x-St/2,A.y),e.lineTo(f.x+St/2,A.y),e.stroke(),d({id:`polartick-r-negy-${L}`,content:w,x:f.x-St-ds,y:A.y,color:I,fontSize:_s,options:{textAlign:"right",textBaseline:"middle"}}))}})}function pf(e,t,{canvas:n,dpr:s,colors:i},o,r){const a=n.width/s,d=n.height/s,l=o({x:0,y:0}),c=(g,y,m,x)=>{e.beginPath(),e.moveTo(g,y),e.lineTo(m,x),e.stroke();const S=Math.atan2(x-y,m-g);e.beginPath(),e.moveTo(m,x),e.lineTo(m-Ye*Math.cos(S-pn),x-Ye*Math.sin(S-pn)),e.lineTo(m-Ye*Math.cos(S+pn),x-Ye*Math.sin(S+pn)),e.closePath(),e.fill()};e.lineWidth=Zn;const h=a>l.x,f=0<l.x,u=0<l.y,p=d>l.y;h&&(c(l.x,l.y,a,l.y),r({id:"axis-label-r-posx",content:xi,x:a-Ye-qr,y:l.y-Kr,color:i.axis,fontSize:cs,options:{textAlign:"center",textBaseline:"bottom"}})),f&&(c(l.x,l.y,0,l.y),r({id:"axis-label-r-negx",content:xi,x:Ye+qr,y:l.y-Kr,color:i.axis,fontSize:cs,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(c(l.x,l.y,l.x,0),r({id:"axis-label-r-posy",content:xi,x:l.x+Ur,y:Ye+jr,color:i.axis,fontSize:cs,options:{textAlign:"left",textBaseline:"middle"}})),p&&(c(l.x,l.y,l.x,d),r({id:"axis-label-r-negy",content:xi,x:l.x+Ur,y:d-Ye-jr,color:i.axis,fontSize:cs,options:{textAlign:"left",textBaseline:"middle"}}))}function yf(e,{canvas:t,dpr:n,colors:s,gridAlpha:i},o,r,a,d,l){const c=t.width/n,h=t.height/n,f=Math.min(c,h)*Pd;let u,p;if(o.x>=0&&o.x<=c&&o.y>=0&&o.y<=h)u=0;else{const I=[Ii(o.x,o.y,0,0,c,0),Ii(o.x,o.y,c,0,c,h),Ii(o.x,o.y,c,h,0,h),Ii(o.x,o.y,0,h,0,0)];u=Math.min(...I)}const y=[{x:0,y:0},{x:c,y:0},{x:c,y:h},{x:0,y:h}].map(I=>Math.sqrt((I.x-o.x)**2+(I.y-o.y)**2));p=Math.max(...y);const m=u*n/a.scale,x=p*n/a.scale,S=(I,w)=>{if(!I||w<fr||I*a.scale/n<Ih)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${w*i})`,e.lineWidth=Zn;const P=m===0?1:Math.ceil(m/I),A=Math.floor(x/I);for(let R=P;R<=A;R++){const $=R*I*a.scale/n;if($>f){const F=[],V={center:{x:o.x,y:o.y},radius:$};if([{p1:{x:0,y:0},p2:{x:c,y:0}},{p1:{x:c,y:0},p2:{x:c,y:h}},{p1:{x:c,y:h},p2:{x:0,y:h}},{p1:{x:0,y:h},p2:{x:0,y:0}}].forEach(D=>{ka(D,V).forEach(k=>{k.x>=0&&k.x<=c&&k.y>=0&&k.y<=h&&F.push(k)})}),F.length>=2){let D=F[0],N=F[1],k=0;for(let Y=0;Y<F.length;Y++)for(let X=Y+1;X<F.length;X++){const z=(F[Y].x-F[X].x)**2+(F[Y].y-F[X].y)**2;z>k&&(k=z,D=F[Y],N=F[X])}e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(N.x,N.y),e.stroke()}}else e.beginPath(),e.arc(o.x,o.y,$,0,Be),e.stroke()}};if(S(d.interval1,d.alpha1),S(d.interval2,d.alpha2),!l||!Array.isArray(l))return;const v={x:c/2,y:h/2},b=Math.min(c,h)/4,T=Math.sqrt((o.x-v.x)**2+(o.y-v.y)**2),_=b+T;if(_<ec||!uc(o.x,o.y,_,c,h))return;const C=_>f;let E=null;if(C){const I={x:0,y:0,w:c,h},w={x:o.x,y:o.y,r:_},L=ia(w,I);if(L.length>=2){let P=L[0],A=L[1],R=0;for(let F=0;F<L.length;F++)for(let V=F+1;V<L.length;V++){const B=(L[F].x-L[V].x)**2+(L[F].y-L[V].y)**2;B>R&&(R=B,P=L[F],A=L[V])}const O=(Math.atan2(o.y-P.y,P.x-o.x)*180/Math.PI+360)%360,$=(Math.atan2(o.y-A.y,A.x-o.x)*180/Math.PI+360)%360;E={minAngle:Math.min(O,$),maxAngle:Math.max(O,$),isFullCircle:!1},Math.abs(O-$)>180&&(E={minAngle:Math.max(O,$),maxAngle:Math.min(O,$)+360,isFullCircle:!1})}}else E=hc(o,_,c,h);if(!E)return;const M=new Set;l.forEach(I=>{const w=I.alpha;if(w<Ul||_*(I.angle*Math.PI/180)<tc*.5)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${w*i})`,e.lineWidth=Zn*zd;let P;if(E.isFullCircle){P=[];for(let A=0;A<360;A+=I.angle)P.push(A)}else{if(P=[],E.ranges&&Array.isArray(E.ranges))E.ranges.forEach(A=>{let[R,O]=A;if(C){const B=[...[{x:0,y:0},{x:c,y:0},{x:c,y:h},{x:0,y:h}].map(k=>(Math.atan2(o.y-k.y,k.x-o.x)*180/Math.PI+360)%360),R,O].sort((k,Y)=>k-Y),D=Math.min(...B)-I.angle*2,N=Math.max(...B)+I.angle*2;R=D,O=N}const $=Hi(I.angle,R,O);P.push(...$)});else if(E.minAngle!==void 0&&E.maxAngle!==void 0){let A=E.minAngle,R=E.maxAngle;if(C){const F=[...[{x:0,y:0},{x:c,y:0},{x:c,y:h},{x:0,y:h}].map(D=>(Math.atan2(o.y-D.y,D.x-o.x)*180/Math.PI+360)%360),A,R].sort((D,N)=>D-N),V=Math.min(...F)-I.angle*2,B=Math.max(...F)+I.angle*2;A=V,R=B}P=Hi(I.angle,A,R)}P=[...new Set(P)]}P.forEach(A=>{if(A=Math.round(A*1e10)/1e10,M.has(A))return;const R=A*Math.PI/180,O={x:o.x+m*a.scale/n*Math.cos(R),y:o.y-m*a.scale/n*Math.sin(R)},$={x:o.x+x*a.scale/n*Math.cos(R),y:o.y-x*a.scale/n*Math.sin(R)};e.beginPath(),e.moveTo(O.x,O.y),e.lineTo($.x,$.y),e.stroke(),M.add(A)})})}function mf(e,{gridDisplayMode:t,canvas:n,dpr:s,viewTransform:i,gridAlpha:o,colors:r},a,d,l,c){if(t===ii)return;e.save();const h=a({x:0,y:0}),f=n.width/s,u=n.height/s;if(t===_a){const p=d({x:0,y:0}),g=d({x:f,y:u}),y=Math.hypot(Math.max(Math.abs(p.x),Math.abs(g.x)),Math.max(Math.abs(p.y),Math.abs(g.y)));yf(e,{canvas:n,dpr:s,colors:r,gridAlpha:o},h,y,i,l,c)}else{const p=(g,y)=>{if(!g||y<fr)return;const m=`rgba(${r.grid.join(",")}, ${y*o})`,x=d({x:0,y:u}),S=d({x:f,y:0}),v=Math.floor(x.x/g),b=Math.ceil(S.x/g),T=Math.floor(x.y/g),_=Math.ceil(S.y/g);if(t===wa){e.strokeStyle=m,e.lineWidth=Zn;for(let C=v;C<=b;C++){const E=C*g,M=a({x:E,y:0}).x;e.beginPath(),e.moveTo(M,0),e.lineTo(M,u),e.stroke()}for(let C=T;C<=_;C++){const E=C*g,M=a({x:0,y:E}).y;e.beginPath(),e.moveTo(0,M),e.lineTo(f,M),e.stroke()}}else if(t===Pa){e.fillStyle=m;const C=Sl*s;for(let E=v;E<=b;E++){const M=E*g;for(let I=T;I<=_;I++){const w=I*g,L=a({x:M,y:w});e.beginPath(),e.arc(L.x,L.y,C,0,Be),e.fill()}}}else if(t===Aa){e.fillStyle=m;const C=Sl*s,E=g*Ia,M=Math.floor(x.y/E),I=Math.ceil(S.y/E);for(let w=M;w<=I;w++){const L=w*E,A=w%2!==0?g/2:0;for(let R=v;R<=b;R++){const $=R*g+A,F=a({x:$,y:L});e.beginPath(),e.arc(F.x,F.y,C,0,Be),e.fill()}}}};p(l.interval1,l.alpha1),p(l.interval2,l.alpha2)}e.restore()}function Na(e,t,n,s,i,o,r=!1){e.save(),e.strokeStyle=o,e.lineWidth=Zn,e.setLineDash(r?Kl:[]);const a=-n,d=-s;let l=ft(s-n);e.beginPath(),e.arc(t.x,t.y,i,a,d,l>0),e.stroke(),e.restore()}function Oa(e,{info:t,colors:n,idPrefix:s,startVertexScreen:i},o,r,a){if(!t||!t.edge)return;const{edge:d,fraction:l,snapPoint:c}=t,h=r(d.id1),f=r(d.id2);if(!h||!f)return;const u=o(h),p=o(f),g=o(c),y=n.feedbackSnapped,m=Vh({x:-(p.y-u.y),y:p.x-u.x});let x=1;i&&(x=(p.x-u.x)*(i.y-u.y)-(p.y-u.y)*(i.x-u.x)>0?-1:1);const S=Lo,v={x:(u.x+g.x)/2,y:(u.y+g.y)/2},b={x:v.x+x*m.x*S,y:v.y+x*m.y*S},T=yn(l,.001,8);a({id:`${s}-1`,content:T,x:b.x,y:b.y,color:y,fontSize:Hr,options:{textAlign:"center",textBaseline:"middle"}});const _={x:(g.x+p.x)/2,y:(g.y+p.y)/2},C={x:_.x+x*m.x*S,y:_.y+x*m.y*S},E=yn(1-l,.001,8);a({id:`${s}-2`,content:E,x:C.x,y:C.y,color:y,fontSize:Hr,options:{textAlign:"center",textBaseline:"middle"}})}function xf(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:s,isDragConfirmed:i,dragPreviewVertices:o,colors:r,edgesVisible:a,snappedEdgeIds:d,currentAltPressed:l,interpolationStyle:c,getInterpolationStyleById:h,edgeColorMode:f="fixed",edgeColorExpression:u="x",edgeWeightExpression:p="1-r"},g,y,m){e.lineWidth=As;const x=ht(r.defaultStroke,{r:255,g:255,b:255,a:1}),S=b=>{const T=b?.color||r.vertex||r.defaultStroke;return ht(T,x)},v=(b,T,_,C)=>{const E=gs(b,f);if(E==="inherit_vertices"&&_&&C){const M=S(_),I=S(C),w=b.weightExpression||p,L=ie(_,C)||1,P=T*L,A=(1-T)*L,R=P/L,O=A/L,$=mt(w,{x:0,y:0,r:R,a:0},1),F=mt(w,{x:0,y:0,r:O,a:0},1);return ao([M,I],[$,F])}if(E==="colormap"&&b.colormapItem){const M=b.colorExpression||u,I=mt(M,{x:T},T),w=We(b.colormapItem,I);return ht(w,x)}return ht(b.color||r.defaultStroke,x)};t.forEach(b=>{const T=y(b.id1),_=y(b.id2);if(!T||!_||T.type!==Bn||_.type!==Bn)return;const C=m(b),E=n.includes(C),M=d&&d.has(C)&&d.get(C).some(k=>k.copyIndex===void 0||k.copyIndex===0),I=!l&&C===s;if(!a&&!E&&!M&&!I)return;let w=T,L=_;if(i&&o&&o.length>0){const k=o.find(X=>X&&X.id===T.id),Y=o.find(X=>X&&X.id===_.id);k&&(w=k),Y&&(L=Y)}const P=b.interpolationStyleId&&h?h(b.interpolationStyleId):null;P&&P.type;const A=new Map;i&&o&&o.length>0&&o.forEach(k=>{!k||!k.id||A.set(k.originalId||k.id,k)});let O=Wi(b,P,w,L,t,k=>A.get(k)||y(k),g);const $=gs(b,f);O.length===2&&($==="inherit_vertices"||$==="colormap")&&(O=zi(O));const F=O.map(k=>g(k));if(F.length<2)return;const V=F[0],B=F[F.length-1],D=g(w),N=g(L);e.beginPath(),e.moveTo(F[0].x,F[0].y);for(let k=1;k<F.length;k++)e.lineTo(F[k].x,F[k].y);if($==="colormap"||$==="inherit_vertices"){let k=0;for(let X=1;X<F.length;X++)k+=Math.hypot(F[X].x-F[X-1].x,F[X].y-F[X-1].y);let Y=0;for(let X=1;X<F.length;X++){const z=F[X-1],G=F[X],W=Math.hypot(G.x-z.x,G.y-z.y),H=k>0?Y/k:0,q=k>0?(Y+W)/k:1,K=(H+q)/2,ne=v(b,K,w,L);e.strokeStyle=`rgba(${Math.round(ne.r)},${Math.round(ne.g)},${Math.round(ne.b)},${ne.a})`,e.beginPath(),e.moveTo(z.x,z.y),e.lineTo(G.x,G.y),e.setLineDash([]),e.lineWidth=As,e.stroke(),Y+=W}}else if(b.colormapItem){const k=e.createLinearGradient(V.x,V.y,B.x,B.y),Y=We(b.colormapItem,b.gradientStart),X=We(b.colormapItem,b.gradientEnd);k.addColorStop(0,Y),k.addColorStop(1,X),e.strokeStyle=k,e.setLineDash([]),e.lineWidth=As,e.stroke()}else e.strokeStyle=b.color||r.defaultStroke,e.setLineDash([]),e.lineWidth=As,e.stroke();if(E||M||I){if(e.save(),e.globalAlpha=Ns,e.lineCap="round",e.lineJoin="round",E||M||I){const k=M?r.feedbackSnapped:r.selectionGlow,Y=Ni,X=N.x-D.x,z=N.y-D.y,G=Math.hypot(X,z);if(e.strokeStyle=k,e.lineWidth=ms,G>ue){const W=-z/G,H=X/G,q=W*Y,K=H*Y;e.beginPath(),e.arc(D.x,D.y,Y,Math.atan2(K,q),Math.atan2(-K,-q)),e.lineTo(N.x-q,N.y-K),e.arc(N.x,N.y,Y,Math.atan2(-K,-q),Math.atan2(K,q)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(D.x,D.y,Y,0,Be),e.stroke()}e.restore()}}),e.setLineDash([]),e.strokeStyle=r.defaultStroke,e.globalAlpha=1}function Ki(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:r,activeCenterId:a,colors:d,verticesVisible:l=!0,isHovered:c=!1,snappedVertexIds:h,isDragConfirmed:f,dragPreviewVertices:u,currentAltPressed:p}=n;let g=t,y=!1,m=null,x;if(f&&u){const T=u.find(_=>_&&(_.id===t.id||_.originalId===t.id));T&&(g=T,x=T.transformIndex)}if(h&&g.originalId&&h.has(g.originalId)){const _=h.get(g.originalId).find(C=>C.copyIndex===x);_&&(y=!0,m=_.type)}else if(h&&!g.originalId&&h.has(g.id)){const _=h.get(g.id).find(C=>C.copyIndex===x);_&&(y=!0,m=_.type)}let S;if(g.type===Bn){if(S=o.includes(g.id),!l&&!S&&!c&&!y&&!(p&&c))return}else S=r.includes(g.id);const v=s(g);switch(g.type){case Bn:e.beginPath(),e.arc(v.x,v.y,$e,0,Be),e.fillStyle=g.color||d.vertex,e.fill();break;case rn:case $n:case Sn:case Qn:const T=dr*2,_={type:g.type,x:v.x-T/2,y:v.y-T/2,width:T,height:T};br(e,_,d);break}const b={...n,isSnapped:y,snapType:m};La(e,g,b,s)}function Sf(e,{altHoverInfo:t,colors:n},s,i,o){if(!t)return;const{point:r,element:a,shiftKey:d,fraction:l}=t,c=s(r),h=n.feedbackSnapped,f=n.feedbackSnapped;e.save(),e.shadowColor=f,e.shadowBlur=Ea,e.globalAlpha=Ns,e.beginPath();const u=$e+Xi;e.arc(c.x,c.y,u,0,Be),e.strokeStyle=f,e.lineWidth=ms,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(c.x,c.y,$e,0,Be),e.fillStyle=h,e.fill(),e.restore(),a.type==="edge"&&d&&If(e,{info:{edge:a.edge,fraction:l,snapPoint:r},colors:n},s,i,o)}function If(e,{info:t,colors:n},s,i,o){Oa(e,{info:t,colors:n,idPrefix:"alt-snap-label"},s,i,o)}function bf(e,{info:t,colors:n},s,i,o){if(!t||!t.startVertex)return;const r=s(t.startVertex);Oa(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:r},s,i,o)}function vf(e,{info:t,colors:n},s,i,o){Oa(e,{info:t,colors:n,idPrefix:"center-snap-label"},s,i,o)}function Mf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:r,currentPos:a,rotation:d,isSnapping:l,snapType:c}=t,h=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(o),u=i(r),p=i(a);if(e.save(),e.lineWidth=xn,e.strokeStyle=h,e.setLineDash(qn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!s||s&&c==="projection"){const y=ut(r,o,d,1),m=i(y);e.beginPath(),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.stroke()}if(Math.abs(d)>ba){e.setLineDash([]);const y=ie(f,u),m=Math.atan2(u.y-f.y,u.x-f.x),x=-d,S=d>0;e.beginPath(),e.arc(f.x,f.y,y,m,m+x,S),e.stroke()}e.restore()}function Ef(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:r,scale:a,isSnapping:d,snapType:l,currentPos:c}=t,h=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(o),u=i(r),p=i(c);if(e.save(),e.lineWidth=xn,e.strokeStyle=h,e.setLineDash(qn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!s){const x=ie(f,p),S=Math.atan2(u.y-f.y,u.x-f.x),v=Math.atan2(p.y-f.y,p.x-f.x);let b=v-S;b>Math.PI?b-=2*Math.PI:b<-Math.PI&&(b+=2*Math.PI);const T=b<0;e.beginPath(),e.arc(f.x,f.y,x,S,v,T),e.stroke()}const y={x:o.x+(r.x-o.x)*a,y:o.y+(r.y-o.y)*a},m=i(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(m.x,m.y),e.stroke(),e.restore()}function Tf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:r,currentPos:a,scale:d,startVector:l,isSnapping:c,snapType:h,projectionSource:f}=t,u=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,p=i(o),g=i(r),y=i(a);e.save(),e.lineWidth=xn,e.strokeStyle=u,e.setLineDash(qn),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(g.x,g.y),e.stroke();const m=ut(r,o,0,d,!0,l),x=i(m);if((!s||s&&h==="projection")&&(e.setLineDash(qn),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(x.x,x.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(x.x,x.y),e.stroke(),c&&h==="projection"&&f){const v=i(f),b=o,T={x:o.x+l.x,y:o.y+l.y},_=sc(f,b,T),C=i(_);e.setLineDash(qn),e.beginPath(),e.moveTo(v.x,v.y),e.lineTo(C.x,C.y),e.stroke()}e.restore()}function Cf(e,{transformIndicatorData:t,colors:n},s){const{center:i,startPos:o,rotation:r,scale:a,isSnapping:d}=t,l=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,c=s(i),h=s(o);e.save(),e.lineWidth=xn,e.strokeStyle=l,e.setLineDash(qn),e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(h.x,h.y),e.stroke();const f={x:i.x+(o.x-i.x)*a,y:i.y+(o.y-i.y)*a},u=s(f);if(e.setLineDash([]),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(r)>ba){const p=ie(c,u),g=Math.atan2(h.y-c.y,h.x-c.x),y=-r,m=r>0;e.beginPath(),e.arc(c.x,c.y,p,g,g+y,m),e.stroke()}e.restore()}function wf(e,t,{transformIndicatorData:n,colors:s,coordSystemTransformIndicatorData:i,currentShiftPressed:o},r,a){if(n){const{isSnapping:d,snapType:l,transformType:c}=n;switch(e.save(),e.lineWidth=xn,c){case Sn:Cf(e,{transformIndicatorData:n,colors:s},r);break;case rn:Mf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},r);break;case $n:Ef(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},r);break;case Qn:Tf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},r);break}d&&l==="projection"&&o&&Pf(e,{transformIndicatorData:n,colors:s},r),e.restore(),Af(t,{transformIndicatorData:n,colors:s},r,a)}i&&_f(t,{coordSystemTransformIndicatorData:i,colors:s},r,a)}function Pf(e,{transformIndicatorData:t,colors:n},s){const{transformType:i,projectionSource:o,projectionCenter:r,projectionPoint:a,currentPos:d}=t;if(i!==Sn){if(e.setLineDash(qn),e.strokeStyle=n.feedbackSnapped,i===rn&&a){const l=s(d),c=s(a),h=s(o);e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(c.x,c.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(c.x,c.y),e.stroke()}else if(i===$n&&r){const l=s(r),c=s(o),h=s(d),f=ie(l,c);let u=Math.atan2(c.y-l.y,c.x-l.x),p=Math.atan2(h.y-l.y,h.x-l.x);const g=2*Math.PI;u=(u+g)%g,p=(p+g)%g;const y=(p-u+g)%g,x=(u-p+g)%g<y;e.beginPath(),e.arc(l.x,l.y,f,u,p,x),e.stroke()}}}function Af(e,{transformIndicatorData:t,colors:n},s,i){const{center:o,startPos:r,rotation:a,scale:d,isSnapping:l,snapType:c,snappedScaleValue:h,transformType:f}=t,u=s(o),p=s(r),g=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(f===$n||f===Sn||f===Qn){let y;const m=h!==null?h:d;c==="projection"||c==="merge"&&f===Sn?y=`\\times ${parseFloat(m.toFixed(Nr)).toString()}`:l&&h!==null?y=`\\times ${yn(h,Ds,fh)}`:y=`\\times ${parseFloat(m.toFixed(Nr)).toString()}`;const S=(u.x+p.x)/2,v=(u.y+p.y)/2,b=Math.atan2(p.y-u.y,p.x-u.x),T=b-Math.PI/2,_=S+Math.cos(T)*pl,C=v+Math.sin(T)*pl;let E=b*(180/Math.PI);(E>90||E<-90)&&(E+=180),i({id:"transform-scale-indicator",content:y,x:_,y:C,color:g,fontSize:En,options:{textAlign:"center",textBaseline:"bottom",rotation:E}})}else i({id:"transform-scale-indicator",content:"",x:0,y:0,color:g,fontSize:En,options:{}});if((f===rn||f===Sn)&&Math.abs(a)>ba){const y=a*(180/Math.PI),m=`${parseFloat(y.toFixed(Nr)).toString()}^{\\circ}`,x={x:p.x-u.x,y:p.y-u.y},S=Math.atan2(x.y,x.x)+-a/2,b=Math.hypot(x.x,x.y)+hh,T=u.x+b*Math.cos(S),_=u.y+b*Math.sin(S);let C=S*(180/Math.PI);(C>90||C<-90)&&(C+=180),i({id:"transform-angle-indicator",content:m,x:T,y:_,color:g,fontSize:En,options:{rotation:C}})}else i({id:"transform-angle-indicator",content:"",x:0,y:0,color:g,fontSize:En,options:{}})}function _f(e,{coordSystemTransformIndicatorData:t,colors:n},s,i){const{edgeFraction:o,orthogonalDistanceFraction:r,v1:a,v2:d,snapPosition:l}=t;let c="",h={x:0,y:0};if(r!==void 0){c=yn(r,.001,8);const f=s(l.origin),u=s(l.closest),p=(f.x+u.x)/2,g=(f.y+u.y)/2,y=Math.atan2(u.y-f.y,u.x-f.x);h.x=p+Math.cos(y+Math.PI/2)*Lo,h.y=g+Math.sin(y+Math.PI/2)*Lo}else if(o!==void 0){const f=s(a),u=s(d),p=s(l),g=Math.atan2(u.y-f.y,u.x-f.x),y=Math.cos(g+Math.PI/2)*Lo,m=Math.sin(g+Math.PI/2)*Lo;h.x=p.x+y,h.y=p.y+m,c=yn(o,.001,8)}c&&i({id:"coord-system-edge-fraction",content:c,x:h.x,y:h.y,color:n.feedbackSnapped,fontSize:Hr,options:{textAlign:"center",textBaseline:"middle"}})}function Df(e,t,n,s,{showAngles:i,showDistances:o,viewTransform:r,mousePos:a,colors:d}){if(!i&&!o||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,c=s(a);if(ie(l,c)<ue)return;const f=d.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,p=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const g=n(l),y=p+u;if(e.save(),e.lineWidth=xn,e.strokeStyle=f,i&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>ue){const m=po+e.lineWidth/2,x={x:l.x+Math.cos(p)*(m/r.scale),y:l.y+Math.sin(p)*(m/r.scale)},S=n(x);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(S.x,S.y),e.setLineDash(Rd),e.stroke(),Na(e,g,p,y,po,f,!1)}e.restore()}function gc(e,t,n,s,i,{showDistances:o,showAngles:r,currentShiftPressed:a,distanceSigFigs:d,angleSigFigs:l,angleDisplayMode:c,viewTransform:h,frozenReference_D_du:f,gridDisplayMode:u,frozenReference_A_rad:p,colors:g,lastGridState:y},m,x,S){if(!r&&!o||i.distance<ue){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const v=m(n),{angle:b,distance:T,lengthSnapFactor:_,angleSnapFactor:C,angleTurn:E,gridToGridSquaredSum:M,gridInterval:I,snapType:w}=i,{offsetAngleRad:L,isFirstSegmentBeingDrawn:P,currentSegmentReferenceD:A}=x,R=i.snapped||a?g.feedbackSnapped:g.geometryInfoText,O=Math.atan2(s.y-n.y,s.x-n.x);if(T*h.scale/window.devicePixelRatio<Ql){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const $=r&&T>ue&&(P||Math.abs(E)>ue);if(o){let F="",V=i.gridInterval||null;if(!V&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&(V=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),a&&i.snapped)if(P)if(w==="grid"&&M!==null&&V)if(M===0)F="0";else{const[B,D]=ks(M),N=V*B,k=parseFloat(N.toFixed(10));F=Rs(k,D)}else if(w==="geometric"&&_!==null){const B=_*A;F=yn(B,Ds,eo),(F===B.toFixed(2)||F===String(Math.round(B)))&&(F=bt(B,d))}else if(w==="vertex"||w==="edge_fraction"||w==="edge"){let B=!1;if(V){const D=i.x-n.x,N=i.y-n.y,k=D/V,Y=N/V;if(Math.abs(k-Math.round(k))<1e-5&&Math.abs(Y-Math.round(Y))<1e-5){const X=Math.round(k),z=Math.round(Y),G=X*X+z*z;if(G===0)F="0";else{const[W,H]=ks(G),q=V*W,K=parseFloat(q.toFixed(10));F=Rs(K,H)}B=!0}}B||(F=bt(T,d))}else F=bt(T,d);else if(w==="geometric"&&_!==null)F=Js(_,"D");else if(w==="grid"&&M!==null&&V&&f!==null&&f>ue){const D=V*Math.sqrt(M)/f;let N=!1;for(const k of jn)if(Math.abs(D-k)<ue){F=Js(k,"D"),N=!0;break}if(!N)if(M===0)F="0";else{const[k,Y]=ks(M),X=V*k,z=parseFloat(X.toFixed(10));F=Rs(z,Y)}}else if(w==="vertex"||w==="edge_fraction"||w==="edge")if(f!==null&&f>ue){const B=T/f;let D=!1;for(const N of jn)if(Math.abs(B-N)<ue){F=Js(N,"D"),D=!0;break}D||(F=bt(T,d))}else F=bt(T,d);else F=bt(T,d);else if(!P&&f!==null&&f>ue){const B=T/f;let D=!1;for(const N of jn)if(Math.abs(B-N)<ue){F=Js(N,"D"),D=!0;break}D||(F=bt(T,d))}else F=bt(T,d);if(F){const B=m(n),D=m(s),N=Math.atan2(D.y-B.y,D.x-B.x),k=(B.x+D.x)/2,Y=(B.y+D.y)/2;let X;if($){const H=P?-O:-E;H<0&&H>-Math.PI||H>Math.PI?X=N-Math.PI/2:X=N+Math.PI/2}else X=N-Math.PI/2,Math.sin(X)>0&&(X+=Math.PI);const z=k+Math.cos(X)*hs,G=Y+Math.sin(X)*hs;let W=N*($o/Math.PI);(W>ql||W<-90)&&(W+=$o),S({id:"snap-dist",content:F,x:z,y:G,color:R,fontSize:En,options:{rotation:W}},t)}else S({id:"snap-dist",content:"",x:0,y:0})}else S({id:"snap-dist",content:"",x:0,y:0});if($){const F=P?0:L;Na(e,v,F,O,po,R),e.save(),e.beginPath();const V=po+e.lineWidth/2,B={x:n.x+V/h.scale*Math.cos(F),y:n.y+V/h.scale*Math.sin(F)},D=m(B);e.moveTo(v.x,v.y),e.lineTo(D.x,D.y),e.strokeStyle=R,e.setLineDash(kd),e.lineWidth=xn,e.stroke(),e.restore();let N="";const k=!P&&p!==null&&Math.abs(p)>ue,Y=x.currentSegmentReferenceA_for_display,X=P?O:E;if(c===Os){let z=ft(X)*(180/Math.PI);a&&!P&&i.snapped&&w==="geometric"&&C!==null||a&&k&&C!==null&&i.snapped&&w!=="geometric"?N=Js(C,"A"):Math.abs(z)>Vi&&(N=`${bt(z,l)}^{\\circ}`)}else if(c===ri){let z=ft(X);if(a&&!P&&i.snapped&&w==="geometric"&&C!==null&&Y){const G=yn(C*(Y/Math.PI),Ds,eo);G==="0"?N="0":G==="1"?N=Gt:G==="-1"?N=`-${Gt}`:N=`${G}${Gt}`}else if(a&&k&&C!==null&&i.snapped&&w!=="geometric"&&Y){const G=yn(C*(Y/Math.PI),Ds,eo);G==="0"?N="0":G==="1"?N=Gt:G==="-1"?N=`-${Gt}`:N=`${G}${Gt}`}else if(Math.abs(z)>Vi){const G=yn(z/Math.PI,Ds,eo);G!==z.toFixed(2)?G==="0"?N="0":G==="1"?N=Gt:G==="-1"?N=`-${Gt}`:N=`${G}${Gt}`:N=bt(z,l)}}if(N){const z=-F,G=-O,W=Math.cos(z)+Math.cos(G),H=Math.sin(z)+Math.sin(G),q=Math.atan2(H,W),K=$i;let ne=q*(180/Math.PI);const he={x:K*Math.cos(q),y:K*Math.sin(q)},ae={x:v.x+he.x,y:v.y+he.y};(ne>90||ne<-90)&&(ne+=180),S({id:"snap-angle",content:N,x:ae.x,y:ae.y,color:R,fontSize:En,options:{rotation:ne}},t)}else S({id:"snap-angle",content:"",x:0,y:0})}else S({id:"snap-angle",content:"",x:0,y:0})}function kf(e,t,{showAngles:n,showDistances:s,viewTransform:i,mousePos:o,frozenReference_D_du:r,distanceSigFigs:a,angleSigFigs:d,angleDisplayMode:l,colors:c},h,f,u){const p=Ql/i.scale;let g=-1;if(t.frozen_Origin_Data_to_display){const I=t.frozen_Origin_Data_to_display,w=h(o);g=ie(I,w)}if(!n&&!s||!t.frozen_Origin_Data_to_display||g<p)return;const y=c.frozenReference,m=t.frozen_Origin_Data_to_display,x=t.displayAngleA_valueRad_for_A_equals_label,S=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,v=t.frozen_D_du_to_display,b=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,T=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!m)return;const _=S+x,C={x:m.x+v*Math.cos(_),y:m.y+v*Math.sin(_)},E=f(m),M=f(C);if(s&&v!==null&&v>p){let I="";if(b!==null&&b>0&&T){const[F,V]=ks(b),B=T*F,D=parseFloat(B.toFixed(10));I=`${ml}${Rs(D,V)}`}else{const F=v/Jr;I=`${ml}${bt(F,a)}`}const w=Math.atan2(M.y-E.y,M.x-E.x),L=(E.x+M.x)/2,P=(E.y+M.y)/2;let A=w*($o/Math.PI);(A>ql||A<-90)&&(A+=$o);let R;x!==null&&Math.abs(x)>ue?-x<0?R=w-Math.PI/2:R=w+Math.PI/2:(R=w-Math.PI/2,Math.sin(R)>0&&(R+=Math.PI));const O=L+Math.cos(R)*Bi,$=P+Math.sin(R)*Bi;u({id:"ref-dist",content:I,x:O,y:$,color:y,fontSize:Zr,options:{rotation:A}},e)}if(n&&x!==null&&Math.abs(x)>ue){const I=-S,w=-(S+x),L=Math.cos(I)+Math.cos(w),P=Math.sin(I)+Math.sin(w),A=Math.atan2(P,L),R=$i,O=E.x+Math.cos(A)*R,$=E.y+Math.sin(A)*R;let F=A*(180/Math.PI);(F>90||F<-90)&&(F+=180);let V="";if(l===Os){let B=x*($o/Math.PI);V=`${_o}${bt(B,d)}^{\\circ}`}else l===ri&&(V=`${_o}${yn(x/Math.PI,Ds,eo)}${Gt}`,V===`${_o}1${Gt}`&&(V=Gt),V===`${_o}-1${Gt}`&&(V=`-${Gt}`),V===`${_o}0${Gt}`&&(V="0"));u({id:"ref-angle",content:V,x:O,y:$,color:y,fontSize:Zr,options:{rotation:F}},e)}}function Rf(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:s,ghostVertexPosition:i,gridDisplayMode:o,lastGridState:r,angleDisplayMode:a,canvas:d,dpr:l,mousePos:c,colors:h,useScientific:f},u,p){if(t===yr||!c||!n)return;let g;s&&i?g=i:g=u(c);let y=1;o!==ii&&r&&r.interval1&&(y=r.interval1);let m=y;r&&r.interval2&&r.interval2<m&&(m=r.interval2);let x,S=1;m>=1e4?(S=100,x=0):m>=1e3?(S=10,x=0):m>=100?(S=1,x=0):m>=10?x=1:x=Math.max(0,-Math.floor(Math.log10(m)))+2;const T=(I=>1)(m)+2,_=I=>{if(f){const w=T-1,P=Math.abs(I).toExponential(w).split("e");let A=P[0],R=parseInt(P[1],10);return`${I<0?"-":""}${A} \\cdot 10^{${R}}`}else return S>1?(Math.round(I/S)*S).toFixed(x):I.toFixed(x)},C=Math.min(x,uh);let E="";switch(t){case Ca:{let I=_(g.x);g.x>=0&&!I.includes("cdot")&&(I=`${js}${I}`);let w=_(g.y);g.y>=0&&!w.includes("cdot")&&(w=`${js}${w}`),E=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${I} \\\\ ${w} \\end{pmatrix*}`;break}case zo:{let I=_(g.x);g.x>=0&&!I.includes("cdot")&&(I=`${js}${I}`);const w=Math.abs(g.y);let L=_(w);const P=g.y<0?"-":"+";E=`z = ${I} ${P} ${L}${Ei}`;break}case mr:{const I=Math.hypot(g.x,g.y),w=Math.atan2(g.y,g.x);let L=_(I);I>=0&&!L.includes("cdot")&&(L=`${js}${L}`);let P;if(a===Os){let A=Bh(w*180/Math.PI);P=A.toFixed(C),A>=0&&(P=`${js}${P}`),P+="^{\\circ}"}else{let A=ft(w);P=A.toFixed(C),A>=0&&(P=`${js}${P}`)}E=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${L} \\\\ ${P} \\end{pmatrix*}`;break}}const M=d.width/l;p({id:"mouse-coord-text",content:E,x:M-ul,y:ul,color:h.mouseCoords,fontSize:gh,options:{textAlign:"right",textBaseline:"top"}})}function pc(e,t,n,s){e.save();const i=t.x+t.width/2,o=t.y+t.height/2,r=t.width/2*.6;if(e.strokeStyle=s.uiIcon,e.fillStyle=s.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(i,o,r*.7,0,2*Math.PI),e.fill();for(let a=0;a<8;a++){const d=a/8*2*Math.PI,l=i+Math.cos(d)*(r*.85),c=o+Math.sin(d)*(r*.85),h=i+Math.cos(d)*(r*1.1),f=o+Math.sin(d)*(r*1.1);e.beginPath(),e.moveTo(l,c),e.lineTo(h,f),e.stroke()}}else e.beginPath(),e.arc(i,o,r,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i-5,o-3,r,0,2*Math.PI),e.fillStyle=s.background,e.fill();e.restore()}function Lf(e,t,n,s,i,o,r){const a=s?r.uiIconSelected:r.uiIconDefault,d={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(d.x,d.y);const l=t.width/Co;e.scale(l,l),e.translate(-16,-16);const c=0;e.strokeStyle=a,e.lineWidth=Fn,e.lineCap="round",e.beginPath(),e.moveTo(0+c,32),e.lineTo(32+c,32),e.moveTo(0+c,32),e.lineTo(0+c,0),e.stroke(),e.fillStyle=a;const h={x:16+c,y:16};let f={x:16+c,y:8},u="";switch(n){case Ca:e.setLineDash(Rr),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(h.x,32),e.moveTo(h.x,h.y),e.lineTo(0+c,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Un,0,Be),e.fill(),u="(x,y)";break;case zo:e.setLineDash(Rr),e.beginPath(),e.moveTo(0+c,32),e.lineTo(h.x,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Un,0,Be),e.fill(),u="x+iy";break;case mr:e.setLineDash(Rr),e.beginPath(),e.moveTo(0+c,32),e.lineTo(h.x,h.y),e.stroke(),e.beginPath(),e.arc(0+c,32,8,-Math.atan2(32-h.y,h.x-(0+c)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Un,0,Be),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const p="icon-label-coords",g=s?r.uiTextSelected:r.uiTextDefault;o({id:p,content:u,x:d.x+(f.x-16)*l,y:d.y+(f.y-16)*l,color:g,fontSize:Ma,options:{textAlign:"center",textBaseline:"middle"}},i)}}function yc(e,t,n,s,i,o,r){const a=s?r.uiIconSelected:r.uiIconDefault,d={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(d.x,d.y);const c=t.width/Co;e.scale(c,c),e.translate(-16,-16),e.strokeStyle=a,e.lineWidth=Fn;const h={x:32,y:32},f={x:0,y:32},u={x:16,y:0};e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke();let p="",g={x:20,y:22};if(n!==Ho){e.beginPath();const y=Math.atan2(u.y-f.y,u.x-f.x);e.arc(f.x,f.y,8,y,0),e.stroke(),n===Os?p="60^\\circ":n===ri&&(p="\\frac{\\pi}{3}",l=2)}if(e.restore(),p){const y="icon-label-angles",m=s?r.uiTextSelected:r.uiTextDefault;o({id:y,content:p,x:d.x+(g.x-16)*c,y:d.y+(g.y-20)*c,color:m,fontSize:Ma+l,options:{textAlign:"center",textBaseline:"middle"}},i)}}function mc(e,t,n,s,i,o,r){const a=s?r.uiIconSelected:r.uiIconDefault,d={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(d.x,d.y);const l=t.width/Co;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=a,e.lineWidth=Fn,e.beginPath(),e.moveTo(0,32),e.lineTo(32,32),e.stroke();let c="",h={x:16,y:22};if(n===Ko&&(c="3.14"),e.restore(),c){const f="icon-label-distances",u=s?r.uiTextSelected:r.uiTextDefault;o({id:f,content:c,x:d.x+(h.x-16)*l,y:d.y+(h.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function Nf(e,t,n,s,i){const o=s?i.uiIconSelected:i.uiIconDefault,r={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(r.x,r.y);const a=t.width/Co;switch(e.scale(a,a),e.translate(-16,-16),e.strokeStyle=o,e.fillStyle=o,e.lineWidth=Fn,n){case wa:e.strokeRect(0,0,32,32),e.beginPath(),e.moveTo(0,16),e.lineTo(32,16),e.moveTo(16,0),e.lineTo(16,32),e.stroke();break;case Pa:e.strokeRect(0,0,32,32),e.beginPath(),[8,16,24].forEach(h=>{[8,16,24].forEach(f=>{e.moveTo(h,f),e.arc(h,f,Un,0,Be)})}),e.fill();break;case Aa:e.strokeRect(0,0,32,32);const d=8,l=16,c=16;e.beginPath(),e.arc(l,c,Un,0,Be);for(let h=0;h<6;h++){const f=Math.PI/3*h,u=l+d*Math.cos(f),p=c+d*Math.sin(f);e.moveTo(u,p),e.arc(u,p,Un,0,Be)}e.fill();break;case _a:e.beginPath(),e.arc(16,16,14,0,Be),e.stroke(),e.beginPath(),e.arc(16,16,7,0,Be),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case ii:e.strokeRect(2,2,28,28);break}e.restore()}function br(e,t,n){const s={x:t.x+t.width/2,y:t.y+t.height/2},i=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=Fn,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(s.x,s.y),t.type){case rn:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();const r=i*.25,a=i*Math.cos(o),d=i*Math.sin(o);e.save(),e.translate(a,d),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-r,-r*.5),e.moveTo(0,0),e.lineTo(-r,r*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),c=i*Math.sin(Math.PI+o);e.save(),e.translate(l,c),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-r,-r*.5),e.moveTo(0,0),e.lineTo(-r,r*.5),e.stroke(),e.restore();break}case $n:{const o=i*.8,r=i*.25;e.beginPath(),e.moveTo(-o,0),e.lineTo(o,0),e.moveTo(0,-o),e.lineTo(0,o),e.stroke(),[{x:o,y:0,dirX:1,dirY:0},{x:-o,y:0,dirX:-1,dirY:0},{x:0,y:-o,dirX:0,dirY:-1},{x:0,y:o,dirX:0,dirY:1}].forEach(d=>{e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(d.x-d.dirX*r+d.dirY*r*.5,d.y-d.dirY*r-d.dirX*r*.5),e.moveTo(d.x,d.y),e.lineTo(d.x-d.dirX*r-d.dirY*r*.5,d.y-d.dirY*r+d.dirX*r*.5),e.stroke()});break}case Sn:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();let r=i*.25;const a=i*Math.cos(o),d=i*Math.sin(o);e.save(),e.translate(a,d),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-r,-r*.5),e.moveTo(0,0),e.lineTo(-r,r*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),c=i*Math.sin(Math.PI+o);e.save(),e.translate(l,c),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-r,-r*.5),e.moveTo(0,0),e.lineTo(-r,r*.5),e.stroke(),e.restore();const h=i*.8;r=i*.25,e.beginPath(),e.moveTo(-h,0),e.lineTo(h,0),e.moveTo(0,-h),e.lineTo(0,h),e.stroke(),[{x:h,y:0,dirX:1,dirY:0},{x:-h,y:0,dirX:-1,dirY:0},{x:0,y:-h,dirX:0,dirY:-1},{x:0,y:h,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*r+u.dirY*r*.5,u.y-u.dirY*r-u.dirX*r*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*r-u.dirY*r*.5,u.y-u.dirY*r+u.dirX*r*.5),e.stroke()});break}case Qn:{const o=i*.8,r=i*.25;e.beginPath(),e.moveTo(-o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(o/Math.sqrt(2),o/Math.sqrt(2)),e.moveTo(o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(-o/Math.sqrt(2),o/Math.sqrt(2)),e.stroke(),[{x:o/Math.sqrt(2),y:-o/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-o/Math.sqrt(2),y:o/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(d=>{e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(d.x-d.dirX*r+d.dirY*r*.5,d.y-d.dirY*r-d.dirX*r*.5),e.moveTo(d.x,d.y),e.lineTo(d.x-d.dirX*r-d.dirY*r*.5,d.y-d.dirY*r+d.dirX*r*.5),e.stroke()});break}}e.restore()}function Of(e,t,n){const s=t.x+t.width/2,i=t.y+t.height/2,o=t.width*.6,r=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=Fn,e.lineCap="round",e.beginPath(),e.ellipse(s,i,o/2,r/2,0,0,2*Math.PI),e.stroke();const a=r*.3;e.beginPath(),e.arc(s,i,a,0,2*Math.PI),e.fill(),e.restore()}function Ff(e,t,n,s){const{canvasUI:i,colors:o,allColors:r,namedColors:a,colorAssignments:d,activeColorTargets:l,lastSelectedSwatchIndex:c,verticesVisible:h,edgesVisible:f,facesVisible:u,isDraggingColorTarget:p,draggedColorTargetInfo:g,mousePos:y}=n,m=o.checkerboardColor1,x=o.checkerboardColor2;function S(C){const E=C.height/3,M=Math.ceil(C.width/E);for(let I=0;I<3;I++)for(let w=0;w<M;w++){e.fillStyle=(I+w)%2===0?m:x;const L=C.x+w*E,P=C.y+I*E,A=Math.min(E,C.x+C.width-L),R=Math.min(E,C.y+C.height-P);A>0&&R>0&&e.fillRect(L,P,A,R)}}const v=i.randomColorButton;if(v){e.fillStyle="#000000",e.fillRect(v.x,v.y,v.width,v.height),e.strokeStyle=o.uiDefault,e.lineWidth=Yn,e.strokeRect(v.x,v.y,v.width,v.height);const C=v.x+v.width/2,E=v.y+v.height/2,M=v.width*.35,I=8;for(let w=0;w<I;w++){const L=w/I*2*Math.PI,P=(w+1)/I*2*Math.PI,A=w/I*360;e.fillStyle=`hsl(${A}, 70%, 60%)`,e.beginPath(),e.moveTo(C,E),e.arc(C,E,M,L,P),e.closePath(),e.fill()}e.fillStyle=o.background,e.beginPath(),e.arc(C,E,M*.4,0,2*Math.PI),e.fill()}const b=i.removeColorButton;b&&(e.strokeStyle=o.uiDefault,e.lineWidth=Yn,e.strokeRect(b.x,b.y,b.width,b.height),e.beginPath(),e.moveTo(b.x+dn,b.y+b.height/2),e.lineTo(b.x+b.width-dn,b.y+b.height/2),e.stroke()),i.colorSwatches.forEach(C=>{const E=C.item;let M=!1;if(E&&E.type==="color"){const I=es(E.value);I&&I.a<1&&(M=!0)}else E&&E.type==="colormap"&&E.vertices.some(I=>I.alpha!==void 0&&I.alpha<1)&&(M=!0);if(M&&S(C),E&&E.type==="colormap"){const I=e.createLinearGradient(C.x,C.y,C.x+C.width,C.y);E.vertices.forEach(w=>{let L=w.color;typeof L=="string"&&(L=a[L]||[0,0,0]),I.addColorStop(w.pos,`rgba(${L.join(",")},${w.alpha||1})`)}),e.fillStyle=I}else E&&(e.fillStyle=E.value);e.fillRect(C.x,C.y,C.width,C.height)});const T=i.addColorButton;if(T&&(e.strokeStyle=o.uiDefault,e.lineWidth=Yn,e.strokeRect(T.x,T.y,T.width,T.height),e.beginPath(),e.moveTo(T.x+T.width/2,T.y+dn),e.lineTo(T.x+T.width/2,T.y+T.height-dn),e.moveTo(T.x+dn,T.y+T.height/2),e.lineTo(T.x+T.width-dn,T.y+T.height/2),e.stroke()),i.colorTargetIcons){const C=I=>{let w=d[I];return p&&g&&g.target===I&&g.previewColorIndex!==void 0&&(w=g.previewColorIndex),w},E=I=>{let w=C(I);const L=w===-1?null:r[w],P={};if(I===nt)P.vertexState=h?"filled":"disabled",w===-1?P.vertexColor=Qs:L&&L.type==="color"?P.vertexColor=L.value:L&&L.type==="colormap"&&(P.vertexColormapItem=L);else if(I===qe)P.edgeState=f?"solid":"disabled",w===-1?P.edgeColor=Qs:L&&L.type==="color"?P.edgeColor=L.value:L&&L.type==="colormap"&&(P.edgeColormapItem=L);else if(I===at)P.faceState=u?"filled":"disabled",w===-1?P.faceColor=Qs:L&&L.type==="color"?P.faceColor=L.value:L&&L.type==="colormap"&&(P.faceColormapItem=L);else if(I===qt){w===-1?P.textColor=Qs:L&&L.type==="color"?P.textColor=L.value:L&&L.type==="colormap"&&(P.textColor=We(L,.5));const A=C(at);if(A===w){const R=A===-1?null:r[A];R?R.type==="color"?P.faceColorForContrast=R.value:R.type==="colormap"&&(P.faceColorForContrast=We(R,.5)):P.faceColorForContrast=Qs}}return P};[at,qe,nt,qt].forEach(I=>{const w=i.colorTargetIcons.find(L=>L.target===I);if(w){l.includes(I);const L=E(I);if(p&&g&&g.target===at&&I===at){const P=i.colorSwatches.find(A=>y.x>=A.x&&y.x<=A.x+A.width&&y.y>=A.y&&y.y<=A.y+A.height);if(P&&P.item.type==="colormap"){const A=zh((y.x-P.x)/P.width,0,1);L.faceColor=We(P.item,A),L.faceState="filled"}}I===qt?Yf(e,w,L,o,!1):jo(e,w,L,o,!1)}})}const _=new Set;if(c!=null){const C=i.colorSwatches.find(E=>E.index===c);if(C){const M=i.colorTargetIcons.find(w=>w.x+w.width/2>=C.x&&w.x+w.width/2<=C.x+C.width),I=M?Math.min(M.y,C.y):C.y;e.strokeStyle=o.selectionGlow,e.lineWidth=Yn,e.strokeRect(C.x-2,I-2,C.width+4,C.y+C.height-I+4),_.add(c)}}l.forEach(C=>{let E=d[C];if(p&&g&&g.target===C&&g.previewColorIndex!==void 0&&(E=g.previewColorIndex),E===-1||_.has(E))return;const M=i.colorSwatches.find(I=>I.index===E);if(M){const I=Object.keys(d).filter(L=>{let P=d[L];return p&&g&&g.target===L&&g.previewColorIndex!==void 0&&(P=g.previewColorIndex),P===M.index&&l.includes(L)}),w=i.colorTargetIcons.filter(L=>I.includes(L.target));if(w.length>0){const L=Math.min(...w.map(F=>F.y));e.strokeStyle=o.selectionGlow,e.lineWidth=Yn;const P=2,A=M.x-P,R=L-P,O=M.width+P*2,$=M.y+M.height-R+P;e.strokeRect(A,R,O,$),_.add(E)}}})}function Bf(e,t,n,s){const{canvasUI:i,colors:o,allColors:r,activeThemeName:a,edgeColorMode:d,faceColorMode:l,selectedEdgeModes:c,selectedFaceModes:h,edgeWeightExpression:f,faceVertexWeightExpression:u,faceEdgeWeightExpression:p,faceColorExpression:g,edgeColorExpression:y,angleDisplayMode:m}=n,x=i.colorModeIcons||[];if(!x.length)return;const S=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"],v=c&&c.length>0?c:[d],b=h&&h.length>0?h:[l];r&&r.find(C=>C&&C.type==="colormap");const _={type:"colormap",vertices:[{pos:0,color:[255,0,0],alpha:1},{pos:.5,color:[0,255,0],alpha:1},{pos:1,color:[0,0,255],alpha:1}],isCyclic:!1};x.forEach(C=>{e.save(),e.strokeStyle=o.uiIcon,e.fillStyle=o.uiIcon,e.lineWidth=Fn;const E={vertexState:"none",edgeState:"none",faceState:"none",faceColor:o.uiIcon,edgeColor:o.uiIcon,vertexColor:o.uiIcon};if(C.group==="edge"){const M={...E,edgeState:"solid",edgeWeightExpression:f,angleDisplayMode:m};C.mode==="inherit_vertices"&&(M.vertexState="filled",M.vertexColors=S,M.edgeVertexColors=S),C.mode==="colormap"&&(M.edgeColormapItem=_,M.edgeExpression=y,M.edgeColormapEdges=null);const I=v.includes(C.mode);jo(e,C,M,o,I)}else if(C.group==="face"){const M={...E,faceState:"filled",vertexWeightExpression:u,edgeWeightExpression:p,angleDisplayMode:m};C.mode==="inherit_vertices"&&(M.vertexState="filled",M.faceVertexColors=S,M.vertexColors=S,M.edgeVertexColors=S),C.mode==="inherit_edges"&&(M.edgeState="solid",M.edgeColors=S,M.faceEdgeColors=S),C.mode==="colormap_xy"&&(M.faceColormapItem=_,M.faceExpression=g);const I=b.includes(C.mode);jo(e,C,M,o,I)}e.restore()})}function $f(e,t,n,s){const i=(n?.vertices||[]).filter(_=>_&&_.type==="regular");if(!i.length){e.save(),e.fillStyle=s.uiIconDefault,e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width*.08,0,2*Math.PI),e.fill(),e.restore();return}let o=1/0,r=1/0,a=-1/0,d=-1/0;i.forEach(_=>{_.x<o&&(o=_.x),_.y<r&&(r=_.y),_.x>a&&(a=_.x),_.y>d&&(d=_.y)});const l=3,c=Math.max(t.width-l*2,1),h=Math.max(t.height-l*2,1),f=Math.max(a-o,1e-6),u=Math.max(d-r,1e-6),p=Math.min(c/f,h/u),g=(o+a)/2,y=(r+d)/2,m=t.x+t.width/2,x=t.y+t.height/2,S=_=>({x:m+(_.x-g)*p,y:x+(_.y-y)*p}),v=n?.edges||[],b=n?.faces||[],T=new Map(i.map(_=>[_.id,_]));e.save(),e.lineWidth=1,b.length>0&&(e.fillStyle=s.uiIconDefault,e.globalAlpha=.2,b.forEach(_=>{const C=(_.vertexIds||[]).map(M=>T.get(M)).filter(Boolean);if(C.length<3)return;e.beginPath();const E=S(C[0]);e.moveTo(E.x,E.y);for(let M=1;M<C.length;M++){const I=S(C[M]);e.lineTo(I.x,I.y)}e.closePath(),e.fill()}),e.globalAlpha=1),e.strokeStyle=s.uiIconDefault,v.forEach(_=>{const C=T.get(_.id1),E=T.get(_.id2);if(!C||!E)return;const M=S(C),I=S(E);e.beginPath(),e.moveTo(M.x,M.y),e.lineTo(I.x,I.y),e.stroke()}),e.fillStyle=s.uiIconDefault,i.forEach(_=>{const C=S(_);e.beginPath(),e.arc(C.x,C.y,1.2,0,2*Math.PI),e.fill()}),e.restore()}function Vf(e,t){const{canvasUI:n,colors:s,sessions:i,activeSessionIndex:o,selectedSessionIndex:r}=t,a=n.removeSessionButton;a&&(e.strokeStyle=s.uiDefault,e.lineWidth=Yn,e.strokeRect(a.x,a.y,a.width,a.height),e.beginPath(),e.moveTo(a.x+dn,a.y+a.height/2),e.lineTo(a.x+a.width-dn,a.y+a.height/2),e.stroke()),(n.sessionIcons||[]).forEach(l=>{const c=l.index===r,h=l.index===o;e.save(),e.strokeStyle=c?s.selectionGlow:s.uiDefault,e.lineWidth=Vo,e.strokeRect(l.x,l.y,l.width,l.height),h&&!c&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Vo,e.strokeRect(l.x+2,l.y+2,l.width-4,l.height-4)),$f(e,l,l.session?.state,s),e.restore()});const d=n.addSessionButton;d&&(e.strokeStyle=s.uiDefault,e.lineWidth=Yn,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width/2,d.y+dn),e.lineTo(d.x+d.width/2,d.y+d.height-dn),e.moveTo(d.x+dn,d.y+d.height/2),e.lineTo(d.x+d.width-dn,d.y+d.height/2),e.stroke())}function Xf(e,t,{verticesVisible:n,edgesVisible:s,facesVisible:i,colorAssignments:o,allColors:r},a){const d=!n&&!s&&!i,l={vertexState:n||d?"filled":"hidden",edgeState:s||d?"solid":"hidden",faceState:i||d?"filled":"hidden",showAllDisabled:d},c=o[nt];if(c!==-1){const u=r[c];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=a.vertex;const h=o[qe];if(h!==-1){const u=r[h];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=a.edge;const f=o[at];if(f!==-1){const u=r[f];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=a.face;jo(e,t,l,a)}function No(e){const t={x:e.x+e.width/2,y:e.y+e.height/2},s=26*(e.width/Co),i=s*Math.sqrt(3)/2,o=[{x:t.x,y:t.y-i/1.5},{x:t.x-s/2,y:t.y+i/3},{x:t.x+s/2,y:t.y+i/3}],r=new Path2D;r.moveTo(o[0].x,o[0].y),r.lineTo(o[1].x,o[1].y),r.lineTo(o[2].x,o[2].y),r.closePath();const a=Math.min(o[0].x,o[1].x,o[2].x),d=Math.max(o[0].x,o[1].x,o[2].x),l=Math.min(o[0].y,o[1].y,o[2].y),c=Math.max(o[0].y,o[1].y,o[2].y);return{vertices:o,facePath:r,bounds:{x:a,y:l,w:d-a,h:c-l}}}function jo(e,t,n,s,i=!1){const{vertexState:o="none",edgeState:r="none",faceState:a="none",faceColor:d,edgeColor:l,vertexColor:c,vertexColors:h,edgeVertexColors:f,edgeColors:u,faceColormapItem:p,faceExpression:g,faceVertexColors:y,faceEdgeColors:m,vertexWeightExpression:x,edgeWeightExpression:S="1-r",edgeColormapItem:v,edgeExpression:b,edgeColormapEdges:T,angleDisplayMode:_="degrees",showAllDisabled:C=!1}=n;e.save();const{vertices:E,facePath:M}=No(t),I=R=>R?Array.isArray(R)?{r:R[0],g:R[1],b:R[2],a:1}:es(R):{r:0,g:0,b:0,a:1},w=(R,O)=>{const $=O.reduce((N,k)=>N+k,0)||1;let F=0,V=0,B=0,D=0;return R.forEach((N,k)=>{const Y=O[k]/$;F+=Y*N.r,V+=Y*N.g,B+=Y*N.b,D+=Y*N.a}),{r:F,g:V,b:B,a:D}},L=(R,O,$,F,V)=>{const B=Math.max(1,Math.ceil(O.w)),D=Math.max(1,Math.ceil(O.h)),N=document.createElement("canvas");N.width=B,N.height=D;const k=N.getContext("2d"),Y=k.createImageData(B,D),X=Y.data,z=R[0],G=R[1],W=R[2],H=(G.y-W.y)*(z.x-W.x)+(W.x-G.x)*(z.y-W.y),q=F.map(I),K=[[z,G],[G,W],[W,z]];for(let ne=0;ne<D;ne++)for(let he=0;he<B;he++){const ae=O.x+he+.5,se=O.y+ne+.5,Q=((G.y-W.y)*(ae-W.x)+(W.x-G.x)*(se-W.y))/H,ee=((W.y-z.y)*(ae-W.x)+(z.x-W.x)*(se-W.y))/H,te=1-Q-ee,ce=(ne*B+he)*4;if(Q>=-.001&&ee>=-.001&&te>=-.001){let fe;if($==="vertices")if(V){const Ee=R.map(Se=>{const ve=ae-Se.x,Qe=se-Se.y,lt=Math.hypot(ve,Qe),Dn=Math.atan2(Qe,ve),qs=_==="degrees"?(Dn*180/Math.PI+360)%360:(Dn+Be)%Be;return mt(V,{x:ve,y:Qe,r:lt,a:qs},1)});fe=w(q,Ee)}else fe={r:Q*q[0].r+ee*q[1].r+te*q[2].r,g:Q*q[0].g+ee*q[1].g+te*q[2].g,b:Q*q[0].b+ee*q[1].b+te*q[2].b,a:Q*q[0].a+ee*q[1].a+te*q[2].a};else{const Ee=K.map(Se=>{const ve=gt({x:ae,y:se},Se[0],Se[1]);return V?mt(V,{x:0,y:0,r:ve.distance,a:0},1):1/Math.max(ve.distance,1e-4)});fe=w(q,Ee)}X[ce]=Math.round(fe.r),X[ce+1]=Math.round(fe.g),X[ce+2]=Math.round(fe.b),X[ce+3]=Math.round((fe.a??1)*255)}else X[ce+3]=0}k.putImageData(Y,0,0),e.drawImage(N,O.x,O.y)},P=(R,O,$,F)=>{const V=Math.max(1,Math.ceil(O.w)),B=Math.max(1,Math.ceil(O.h)),D=document.createElement("canvas");D.width=V,D.height=B;const N=D.getContext("2d"),k=N.createImageData(V,B),Y=k.data,X=R[0],z=R[1],G=R[2],W=(z.y-G.y)*(X.x-G.x)+(G.x-z.x)*(X.y-G.y),H={x:(X.x+z.x+G.x)/3,y:(X.y+z.y+G.y)/3},K=(Math.hypot(z.x-X.x,z.y-X.y)||1)/2;for(let ne=0;ne<B;ne++)for(let he=0;he<V;he++){const ae=O.x+he+.5,se=O.y+ne+.5,Q=((z.y-G.y)*(ae-G.x)+(G.x-z.x)*(se-G.y))/W,ee=((G.y-X.y)*(ae-G.x)+(X.x-G.x)*(se-G.y))/W,te=1-Q-ee,ce=(ne*V+he)*4;if(Q>=-.001&&ee>=-.001&&te>=-.001){const fe=(ae-H.x)/K,Ee=(se-H.y)/K,Se=Math.hypot(fe,Ee),ve=Math.atan2(Ee,fe),Qe=_==="degrees"?(ve*180/Math.PI+360)%360:(ve+Be)%Be,lt=mt(F,{x:fe,y:Ee,r:Se,a:Qe},0),Dn=We($,lt),qs=es(Dn)||{r:0,g:0,b:0,a:1};Y[ce]=Math.round(qs.r),Y[ce+1]=Math.round(qs.g),Y[ce+2]=Math.round(qs.b),Y[ce+3]=Math.round((qs.a??1)*255)}else Y[ce+3]=0}N.putImageData(k,0,0),e.drawImage(D,O.x,O.y)};if(a==="filled"){let R=!1;if(p&&p.type==="colormap"&&g){const{bounds:O}=No(t);P(E,O,p,g),R=!0}else if(p&&p.type==="colormap"){const O=e.createLinearGradient(E[1].x,0,E[2].x,0);p.vertices.forEach($=>{const F=$.color,V=$.alpha!==void 0?$.alpha:1,B=`rgba(${F.join(",")},${V})`;O.addColorStop($.pos,B)}),e.fillStyle=O}else if(y&&y.length>=3){const{bounds:O}=No(t);L(E,O,"vertices",y,x),R=!0}else if(m&&m.length>=3){const{bounds:O}=No(t);L(E,O,"edges",m,S),R=!0}else e.fillStyle=d||s.face;R||e.fill(M)}else a==="disabled"&&(e.fillStyle=Jd,e.fill(M));(r==="solid"||r==="disabled")&&(e.lineWidth=Fn,e.setLineDash([]),[[0,1],[1,2],[2,0]].forEach((O,$)=>{const[F,V]=O,B=E[F],D=E[V];if(u&&u.length>=3)e.strokeStyle=u[$];else if(f&&f.length>=3&&S){const N=e.createLinearGradient(B.x,B.y,D.x,D.y),k=5,Y=ie(B,D)||1;for(let X=0;X<k;X++){const z=X/(k-1),G=z*Y,W=(1-z)*Y,H=G/Y,q=W/Y,K=mt(S,{r:H,a:0},1),ne=mt(S,{r:q,a:0},1),he=w([I(f[F]),I(f[V])],[K,ne]);N.addColorStop(z,`rgba(${Math.round(he.r)},${Math.round(he.g)},${Math.round(he.b)},${he.a??1})`)}e.strokeStyle=N}else if(v&&v.type==="colormap"&&r==="solid"){const N=b&&b.trim()?b:"x",k=!T||T.includes($),Y=e.createLinearGradient(B.x,B.y,D.x,D.y),X=k?5:2;for(let z=0;z<X;z++){const G=X===1?.5:z/(X-1),W=k?mt(N,{x:G},G):G,H=We(v,W);Y.addColorStop(G,H)}e.strokeStyle=Y}else if(f&&f.length>=3){const N=e.createLinearGradient(B.x,B.y,D.x,D.y);N.addColorStop(0,f[F]),N.addColorStop(1,f[V]),e.strokeStyle=N}else r==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||s.edge;e.beginPath(),e.moveTo(B.x,B.y),e.lineTo(D.x,D.y),e.stroke()})),(o==="filled"||o==="disabled")&&(e.lineWidth=Fn,E.forEach((R,O)=>{let $=h&&h[O]||c||s.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&o==="filled"){const V=E.length>1?O/(E.length-1):.5;$=We(n.vertexColormapItem,V)}o==="disabled"&&($="#808080");const F=new Path2D;F.moveTo(R.x+Un*2,R.y),F.arc(R.x,R.y,Un*2,0,2*Math.PI),e.fillStyle=$,e.setLineDash([]),e.fill(F)})),C?(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(o==="disabled"||r==="disabled"||a==="disabled")&&(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),i&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Yn,e.setLineDash([]),e.strokeRect(t.x-2,t.y-2,t.width+4,t.height+4)),e.restore()}function Yf(e,t,n,s,i=!1){e.save();const o={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(o.x,o.y);const r=t.width/Co;e.scale(r,r),e.translate(-16,-16);let a=n.textColor||s.uiTextDefault;if(n.faceColorForContrast){const d=es(n.faceColorForContrast);a=(.2126*d.r+.7152*d.g+.0722*d.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=a,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function qi(e,t,n,s,i,o,r,a,d,l,c,h={}){if(!t||t.length<3)return;e.save(),e.beginPath(),t.forEach((I,w)=>{w===0?e.moveTo(I.x,I.y):e.lineTo(I.x,I.y)}),e.closePath(),l&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(I=>{const w=a.find(L=>L.id===I);if(w){const L=w.vertexIds.map(P=>d(P)).filter(P=>P&&P.type==="regular");if(L.length>=3){const A=(c?xs(L,c,!0,i):L).map(R=>i(R));e.moveTo(A[0].x,A[0].y),A.slice(1).forEach(R=>{e.lineTo(R.x,R.y)}),e.closePath()}}});const{faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x",edgeWeightExpression:m="1-r",faceVertexWeightExpression:x="1/(r+0.001)",faceEdgeWeightExpression:S="1/(r+0.001)",angleDisplayMode:v="degrees"}=h,b=qo(n,f),T=n?.vertexIds?n.vertexIds.map(I=>d(I)).filter(Boolean):[],_=I=>I?.color||s.face,C=ht(s.face,{r:255,g:255,b:255,a:1}),E=(I,w,L)=>{const P=e.createPattern(I,"no-repeat"),A=i(w.origin),R=Cn({x:1,y:0},w),O=Cn({x:0,y:1},w),$=i(R),F=i(O),V=$.x-A.x,B=$.y-A.y,D=F.x-A.x,N=F.y-A.y,k=I.width,Y=Math.max(L?.width||0,1e-6),X=Math.max(L?.height||0,1e-6),z=Y/(k-1),G=X/(k-1),W=V*z,H=B*z,q=D*G,K=N*G,ne={x:L?.minX||0,y:L?.minY||0},he=Cn(ne,w),ae=i(he),se=ae.x,Q=ae.y,ee=new DOMMatrix([W,H,q,K,se,Q]);return P.setTransform(ee),P},M=(I,w)=>{const P=document.createElement("canvas");P.width=64,P.height=64;const A=P.getContext("2d"),R=A.createImageData(64,64),O=R.data,$=1/63,F=T.filter(K=>K.type==="regular"),V=F.map(K=>Do(K,w));let B=1/0,D=1/0,N=-1/0,k=-1/0,Y=1;V.forEach(K=>{!Number.isFinite(K.x)||!Number.isFinite(K.y)||(B=Math.min(B,K.x),D=Math.min(D,K.y),N=Math.max(N,K.x),k=Math.max(k,K.y),Y=Math.max(Y,Math.hypot(K.x,K.y)))}),(!Number.isFinite(B)||!Number.isFinite(D)||!Number.isFinite(N)||!Number.isFinite(k))&&(B=-1,D=-1,N=1,k=1);const X={minX:B,minY:D,width:Math.max(N-B,1e-6),height:Math.max(k-D,1e-6),maxRadius:Math.max(Y,1e-6)},z=F.map(K=>ht(_(K),C)),G=K=>({x:(K.x-B)/X.width,y:(K.y-D)/X.height}),W=V.map(G),H=[];if(n?.vertexIds&&n.vertexIds.length>1)for(let K=0;K<n.vertexIds.length;K++){const ne=n.vertexIds[K],he=n.vertexIds[(K+1)%n.vertexIds.length],ae=r?.find(ee=>ee.id1===ne&&ee.id2===he||ee.id1===he&&ee.id2===ne)||{id1:ne,id2:he},se=d(ae.id1),Q=d(ae.id2);se&&Q&&H.push({edge:ae,mode:gs(ae,u),v1:se,v2:Q,v1Local:Do(se,w),v2Local:Do(Q,w),v1Norm:G(Do(se,w)),v2Norm:G(Do(Q,w))})}const q=(K,ne)=>{const{edge:he,v1:ae,v2:se,mode:Q}=K;if(Q==="inherit_vertices"&&ae&&se){const ee=ht(_(ae),C),te=ht(_(se),C),ce=he.weightExpression||m,fe=ie(ae,se)||1,Ee=ne*fe,Se=(1-ne)*fe,ve=Ee/fe,Qe=Se/fe,lt=mt(ce,{x:0,y:0,r:ve,a:0},1),Dn=mt(ce,{x:0,y:0,r:Qe,a:0},1);return ao([ee,te],[lt,Dn])}if(Q==="colormap"&&he.colormapItem){const ee=he.colorExpression||y,te=mt(ee,{x:ne},ne),ce=We(he.colormapItem,te);return ht(ce,C)}return ht(he.color||s.edge,C)};for(let K=0;K<64;K++)for(let ne=0;ne<64;ne++){const he=X.minX+ne*$*X.width,ae=X.minY+K*$*X.height,se=Vr((he-X.minX)/X.width),Q=Vr((ae-X.minY)/X.height);let ee=C;if(I==="colormap_xy"||I==="colormap_polar")if(n?.colormapItem){const ce=Math.hypot(he,ae);let fe=Math.atan2(ae,he);fe<0&&(fe+=Be);const Ee=v==="degrees"?fe*(180/Math.PI):fe,Se=n?.colorExpression||p||g||"x",ve=mt(Se,{x:se,y:Q,r:ce,a:Ee},se);if(Array.isArray(n.colormapItem.vertices)&&n.colormapItem.vertices.length===1){const lt=We(n.colormapItem,0);ee=ht(lt,C)}else if(n.colormapItem.isCyclic){const lt=We(n.colormapItem,ve);ee=ht(lt,C)}else if(ve<0)ee={...C,a:0};else if(ve>1){const lt=We(n.colormapItem,1);ee=ht(lt,C)}else{const lt=We(n.colormapItem,ve);ee=ht(lt,C)}}else ee=C;else if(I==="inherit_vertices"&&V.length>0){const ce=n.vertexWeightExpression||x,fe=W.map(Ee=>{const Se=se-Ee.x,ve=Q-Ee.y,Qe=Math.hypot(Se,ve),lt=Math.atan2(ve,Se),Dn=v==="degrees"?(lt*180/Math.PI+360)%360:(lt+Be)%Be;return mt(ce,{x:Se,y:ve,r:Qe,a:Dn},1)});ee=ao(z,fe)}else if(I==="inherit_edges"&&H.length>0){const ce=n.edgeWeightExpression||S,fe=H.map(Se=>{const ve=gt({x:se,y:Q},Se.v1Norm,Se.v2Norm);return mt(ce,{x:0,y:0,r:ve.distance,a:0},1)}),Ee=H.map(Se=>{const ve=gt({x:se,y:Q},Se.v1Norm,Se.v2Norm);return q(Se,ve.t)});ee=ao(Ee,fe)}const te=(K*64+ne)*4;O[te]=Math.round(ee.r),O[te+1]=Math.round(ee.g),O[te+2]=Math.round(ee.b),O[te+3]=Math.round(Vr(ee.a)*255)}return A.putImageData(R,0,0),{canvas:P,bounds:X}};if(b==="fixed")e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");else if(n.localCoordSystem){const I=M(b,n.localCoordSystem),w=E(I.canvas,n.localCoordSystem,I.bounds);e.fillStyle=w||n?.color||s.face,e.fill(l?"evenodd":"nonzero")}else n?.colormapItem&&n.localCoordSystem,e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");e.restore()}function Gf(e,t,n,s,i,o){const{angleDisplayMode:r,distanceDisplayMode:a,colors:d}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":yc(e,l,r,r!==Ho,s,i,d);break;case"distances":mc(e,l,a,a===Ko,s,i,d);break}}function Wf(e,t,n,s){const{canvasUI:i,colorAssignments:o,allColors:r,colors:a}=n,d=l=>{if(!o||!r)return a.uiIcon;const c=o[l];if(c===-1)return Qs;const h=r[c];return h&&h.type==="color"?h.value:a.uiIcon};d(nt),d(qe),d(at),i.visibilityIcons.forEach(l=>{Gf(e,l,n,t,s)})}function xc(e,t,n,s){const i={x:t.x+t.width*.22,y:t.y+t.height*.78},o={x:t.x+t.width*.22,y:t.y+t.height*.22},r={x:t.x+t.width*.78,y:t.y+t.height*.22},a=[i,o,r],l=!s||s.type==="linear"?a:xs(a,s,!1,null),c=(h,f)=>{const u=Math.atan2(f.y-h.y,f.x-h.x),p=t.width*.08,g={x:f.x-Math.cos(u)*p+Math.cos(u+Math.PI/2)*p*.6,y:f.y-Math.sin(u)*p+Math.sin(u+Math.PI/2)*p*.6},y={x:f.x-Math.cos(u)*p+Math.cos(u-Math.PI/2)*p*.6,y:f.y-Math.sin(u)*p+Math.sin(u-Math.PI/2)*p*.6};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(g.x,g.y),e.lineTo(y.x,y.y),e.closePath(),e.fill()};e.save(),e.strokeStyle=n.uiIcon,e.lineWidth=va,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let h=1;h<l.length;h++)e.lineTo(l[h].x,l[h].y);e.stroke(),e.fillStyle=n.uiIcon,a.forEach(h=>{e.beginPath(),e.arc(h.x,h.y,Un+.5,0,Math.PI*2),e.fill()}),s?.linearStyle==="arrows"&&(c(i,o),c(o,r)),e.restore()}function zf(e,t,n,s){const{canvasUI:i,colors:o,activeInterpolationStyleId:r,selectedInterpolationStyleId:a,interpolationStyles:d}=n;i.interpolationIcons.forEach(l=>{const c={x:l.x,y:l.y,width:l.width,height:l.height};if(l.type==="interpolationStyle"){const h=l.styleId===(a||r);e.strokeStyle=o.uiDefault,e.lineWidth=Vo,e.strokeRect(c.x,c.y,c.width,c.height),h&&(e.strokeStyle=o.selectionGlow,e.lineWidth=Yn,e.strokeRect(c.x-2,c.y-2,c.width+4,c.height+4));const f=d.find(p=>p.id===l.styleId);xc(e,c,o,f);const u=f?.name||"";u&&u.toLowerCase()!=="linear"&&s({id:`interpolation-label-${l.styleId}`,content:u.length>6?`${u.slice(0,6)}...`:u,x:c.x+c.width/2,y:c.y+c.height+10,color:o.uiTextDefault,fontSize:Ma,options:{textAlign:"center",textBaseline:"top"}},t)}else l.type==="interpolationRemove"?(e.strokeStyle=o.uiDefault,e.lineWidth=Vo,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width*.25,c.y+c.height/2),e.lineTo(c.x+c.width*.75,c.y+c.height/2),e.strokeStyle=o.uiIcon,e.lineWidth=va,e.stroke()):l.type==="interpolationAdd"&&(e.strokeStyle=o.uiDefault,e.lineWidth=Vo,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width/2,c.y+c.height*.25),e.lineTo(c.x+c.width/2,c.y+c.height*.75),e.moveTo(c.x+c.width*.25,c.y+c.height/2),e.lineTo(c.x+c.width*.75,c.y+c.height/2),e.stroke())})}function Hf(e,t,n,s){const{canvasUI:i,colors:o,activeThemeName:r,colorAssignments:a,allColors:d,verticesVisible:l,edgesVisible:c,facesVisible:h}=n,f=i.toolbarButton;e.strokeStyle=o.uiDefault,e.lineWidth=jl,e.beginPath();for(let b=0;b<3;b++){const T=f.y+5+b*10;e.moveTo(f.x+4,T),e.lineTo(f.x+f.width-4,T)}e.stroke();const u=i.colorToolButton;u&&Xf(e,u,{verticesVisible:l,edgesVisible:c,facesVisible:h,colorAssignments:a,allColors:d},o);const p=i.colorModeToolButton;if(p){const b=p,T={x:b.x,y:b.y,width:b.width,height:b.height};(C=>{const{vertices:E}=No(C),M=[[E[0],E[1]],[E[1],E[2]],[E[2],E[0]]],I=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"];M.forEach((w,L)=>{e.strokeStyle=I[L],e.lineWidth=2,e.beginPath(),e.moveTo(w[0].x,w[0].y),e.lineTo(w[1].x,w[1].y),e.stroke()})})(T),e.fillStyle="#ffffff",jo(e,T,{edgeState:"none",faceState:"filled",vertexState:"none",faceColor:"#ffffff"},o)}const g=i.transformToolButton;g&&s({id:"transform-tool-label",content:rh,x:g.x+g.width/2,y:g.y+g.height/2,color:o.uiIcon,fontSize:ih,options:{textAlign:"center",textBaseline:"middle"}},t);const y=i.interpolationToolButton;y&&xc(e,y,o);const m=i.displayToolButton;if(m){e.strokeStyle=o.uiDefault,e.fillStyle=o.uiDefault,e.lineWidth=va;const b=m.width-ah;for(let T=0;T<3;T++){const _=m.y+lh+T*ch;e.beginPath(),e.moveTo(m.x+6,_),e.lineTo(m.x+6+b,_),e.stroke(),e.beginPath(),e.arc(m.x+6+b*(T/2),_,dh,0,2*Math.PI),e.fill()}}const x=i.visibilityToolButton;x&&Of(e,x,o);const S=i.sessionsToolButton;if(S){e.save(),e.strokeStyle=o.uiDefault,e.lineWidth=Fn;const b=6,T=Math.min(S.width,S.height)-b*2,_=S.x+b,C=S.y+b;e.strokeRect(_+4,C+2,T,T),e.strokeRect(_,C+6,T,T),e.restore()}const v=i.themeToggleButton;v&&pc(e,v,r,o)}function Kf(e,t){const{canvasUI:n,colors:s}=t;n.transformIcons.forEach(i=>{br(e,i,s)})}function qf(e,t,n,s){const{canvasUI:i,colors:o,coordsDisplayMode:r,gridDisplayMode:a,angleDisplayMode:d,distanceDisplayMode:l,activeThemeName:c}=n;i.displayIcons.forEach(h=>{const f={x:h.x,y:h.y,width:h.width,height:h.height};switch(h.group){case"coords":Lf(e,f,r,r!==yr,t,s,o);break;case"grid":Nf(e,f,a,a!==ii,o);break;case"angles":yc(e,f,d,d!==Ho,t,s,o);break;case"distances":mc(e,f,l,l===Ko,t,s,o);break;case"theme":pc(e,f,c,o);break}})}function Uf(e,t,n,s){const{dpr:i,isToolbarExpanded:o,isColorPaletteExpanded:r,isColorModePanelExpanded:a,isInterpolationPanelExpanded:d,isTransformPanelExpanded:l,isDisplayPanelExpanded:c,isVisibilityPanelExpanded:h,isSessionsPanelExpanded:f,isPlacingTransform:u,placingTransformType:p,placingSnapPos:g,mousePos:y,colors:m}=n;if(e.save(),e.resetTransform(),e.scale(i,i),o)Hf(e,t,n,s);else{const x=n.canvasUI.toolbarButton;e.strokeStyle=m.uiDefault,e.lineWidth=jl,e.beginPath();for(let S=0;S<3;S++){const v=x.y+5+S*10;e.moveTo(x.x+4,v),e.lineTo(x.x+x.width-4,v)}e.stroke()}if(r&&Ff(e,t,n),a&&Bf(e,t,n),d&&zf(e,t,n,s),l&&Kf(e,n),c&&qf(e,t,n,s),h&&Wf(e,t,n,s),f&&Vf(e,n),u){const x=g||y;if(x){const S=Lr/2,v={type:p,x:x.x-S,y:x.y-S,width:Lr,height:Lr};br(e,v,m)}}e.restore()}function Ol(e,t,n,s,{showDistances:i,distanceSigFigs:o,colors:r,lastGridState:a,currentShiftPressed:d},l,c,h,f,u=null,p=null,g=null){!i||n.length===0||n.forEach(y=>{const m=s.find(x=>c(x)===y);if(m){let x=l(m.id1),S=l(m.id2);if(u){const v=u.find(T=>T.id===m.id1),b=u.find(T=>T.id===m.id2);v&&(x=v),b&&(S=b)}if(x&&S&&x.type==="regular"&&S.type==="regular"){let v;const b=u&&g;if(m.labelMode==="exact"&&m.exactValue){const[A,R]=ks(m.exactValue.g2gSquaredSum);let O=m.exactValue.gridInterval*A;if(b&&g.transformType!==rn){const $=g.snappedScaleValue!==null?g.snappedScaleValue:g.scale;O*=$}v=Rs(parseFloat(O.toFixed(10)),R)}else v=bt(ie(x,S),o);const T=h(x),_=h(S),C=(T.x+_.x)/2,E=(T.y+_.y)/2,M=Math.atan2(_.y-T.y,_.x-T.x);let I=M-Math.PI/2;Math.sin(I)>0&&(I+=Math.PI);const w=C+Math.cos(I)*hs,L=E+Math.sin(I)*hs;let P=M*(180/Math.PI);(P>90||P<-90)&&(P+=180),f({id:`selected-edge-dist-${y}`,content:v,x:w,y:L,color:`rgba(${r.feedbackDefault.join(",")}, 1.0)`,fontSize:En,options:{rotation:P}})}}})}function jf(e,t,n,s){e.save(),e.strokeStyle=s.mouseCoords,e.lineWidth=xn,e.setLineDash(qn);const i=Math.min(t.x,n.x),o=Math.min(t.y,n.y),r=Math.abs(t.x-n.x),a=Math.abs(t.y-n.y);e.strokeRect(i,o,r,a),e.restore()}function no(e,t,n,s,{lastGridState:i,showDistances:o,showAngles:r,distanceSigFigs:a,angleDisplayMode:d,angleSigFigs:l,currentShiftPressed:c,viewTransform:h,colors:f},u,p,g,y=!1,m=null,x=null,S=[],v=!1,b=[],T=null,_=new Map){const C=y?f.feedbackSnapped:`rgba(${f.feedbackDefault.join(",")}, 1.0)`,E=new Map(s.map(V=>[V.id,{...V}])),M=V=>E.get(V),I=M(n);if(!I)return;const w=p(I.id).map(M).filter(Boolean),L=u(I),P=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,R=(_.get(n)||[]).find(V=>V.type==="projection"&&V.projectionLine);if(R){const[V,B]=R.projectionLine,D=u(V),N=u(B),k={x:N.x-D.x,y:N.y-D.y},Y=Math.hypot(k.x,k.y);if(Y>0){const X={x:k.x/Y,y:k.y/Y},z=1e4,G={x:D.x-X.x*z,y:D.y-X.y*z},W={x:D.x+X.x*z,y:D.y+X.y*z};e.save(),e.strokeStyle=C,e.lineWidth=xn,e.setLineDash(Kl),e.beginPath(),e.moveTo(G.x,G.y),e.lineTo(W.x,W.y),e.stroke(),e.restore()}}const O=(V,B)=>{if(!V||!B||B<=0)return!1;const D=B*1e-6,N=Math.abs(V.x/B-Math.round(V.x/B))<D,k=Math.abs(V.y/B-Math.round(V.y/B))<D;return N&&k},$=w.every(V=>S.includes(V.id)),F=b.find(V=>V.id===n);if(!T&&v&&c&&$&&F&&ie(F,I)>ue){const V=u(F),B=L,D=Math.atan2(B.y-V.y,B.x-V.x),N=Math.atan2(I.y-F.y,I.x-F.x);if(o){let k;const Y=P&&O(F,P),X=P&&O(I,P);if(Y&&X){const ne=I.x-F.x,he=I.y-F.y,ae=Math.round(ne/P),se=Math.round(he/P),Q=ae*ae+se*se;if(Q===0)k="0";else{const[ee,te]=ks(Q),ce=P*ee,fe=parseFloat(ce.toFixed(10));k=Rs(fe,te)}}else{const ne=a+2;k=bt(ie(F,I),ne)}const z=(V.x+B.x)/2,G=(V.y+B.y)/2;let W;r&&Math.abs(N)>ue?-N<0?W=D-Math.PI/2:W=D+Math.PI/2:(W=D-Math.PI/2,Math.sin(W)>0&&(W+=Math.PI));const H=z+Math.cos(W)*hs,q=G+Math.sin(W)*hs;let K=D*(180/Math.PI);(K>90||K<-90)&&(K+=180),x({id:`drag-dist-vector-${I.id}`,content:k,x:H,y:q,color:C,fontSize:En,options:{rotation:K}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=C,e.lineWidth=xn,e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(B.x,B.y),e.stroke(),e.restore(),r&&Math.abs(D)>ue){Na(e,V,0,N,po,C);let k;if(d===Os?k=`${bt(N*(180/Math.PI),l)}^{\\circ}`:k=bt(N,l),k){const Y=-N/2,X=$i,z={x:X*Math.cos(Y),y:X*Math.sin(Y)},G={x:V.x+z.x,y:V.y+z.y};let W=Y*(180/Math.PI);(W>90||W<-90)&&(W+=180),x({id:`drag-angle-vector-${I.id}`,content:k,x:G.x,y:G.y,color:C,fontSize:En,options:{rotation:W}},t)}}}if(o&&w.forEach(V=>{const B=S.includes(V.id);if(!v||!B){const D=I,N=V,k=g({id1:D.id,id2:N.id});let Y;if(P&&O(D,P)&&O(N,P)){const se=D.x-N.x,Q=D.y-N.y,ee=Math.round(se/P),te=Math.round(Q/P),ce=ee*ee+te*te;if(ce===0)Y="0";else{const[fe,Ee]=ks(ce),Se=P*fe,ve=parseFloat(Se.toFixed(10));Y=Rs(ve,Ee)}}else{const se=ie(D,N);Y=bt(se,a)}const z=u(D),G=u(N),W=(z.x+G.x)/2,H=(z.y+G.y)/2,q=Math.atan2(G.y-z.y,G.x-z.x);let K=q-Math.PI/2;Math.sin(K)>0&&(K+=Math.PI);const ne=W+Math.cos(K)*hs,he=H+Math.sin(K)*hs;let ae=q*(180/Math.PI);(ae>90||ae<-90)&&(ae+=180),x({id:`drag-dist-${k}`,content:Y,x:ne,y:he,color:C,fontSize:En,options:{rotation:ae}})}}),r&&w.length>=2&&(!v||w.some(V=>!S.includes(V.id)))){const V=[...w].sort((B,D)=>{const N=Math.atan2(B.y-I.y,B.x-I.x),k=Math.atan2(D.y-I.y,D.x-I.x);return N-k});for(let B=0;B<V.length;B++){const D=V[B],N=V[(B+1)%V.length],k=S.includes(D.id),Y=S.includes(N.id);if(!(!v||!k||!Y))continue;const z={x:D.x-I.x,y:D.y-I.y},G={x:N.x-I.x,y:N.y-I.y},W=Math.atan2(z.y,z.x),H=Math.atan2(G.y,G.x);let q=H-W;if(q<0&&(q+=2*Math.PI),q<ue)continue;const K=W+q/2;e.save(),e.strokeStyle=C,e.lineWidth=xn,e.beginPath(),e.arc(L.x,L.y,po,-W,-H,!1),e.stroke(),e.restore();let ne;if(d===Os?ne=`${bt(q*(180/Math.PI),l)}^{\\circ}`:d===ri&&(c?(ne=yn(q/Math.PI,.015,32)+"\\pi",ne.startsWith("1\\pi")&&(ne="\\pi"),ne.startsWith("-1\\pi")&&(ne="-\\pi"),ne==="0\\pi"&&(ne="0")):ne=bt(q,l)),ne){const he=`drag-angle-${I.id}-${D.id}-${N.id}`,ae={x:I.x+Math.cos(K),y:I.y+Math.sin(K)},se=u(ae),Q=Math.atan2(se.y-L.y,se.x-L.x),ee=$i,te={x:ee*Math.cos(Q),y:ee*Math.sin(Q)},ce={x:L.x+te.x,y:L.y+te.y};let fe=Q*(180/Math.PI);(fe>90||fe<-90)&&(fe+=180),x({id:he,content:ne,x:ce.x,y:ce.y,color:C,fontSize:En,options:{rotation:fe}},t)}}}}function Jf(e,t,n,s,{showAngles:i,angleSigFigs:o,angleDisplayMode:r,currentShiftPressed:a,distanceSigFigs:d,viewTransform:l,lastGridState:c,colors:h},f,u,p,g,y){!i||n.length===0||n.forEach(m=>{const x=s.find(S=>u(S)===m);if(x){const S=f(x.id1),v=f(x.id2);if(S&&v&&S.type==="regular"&&v.type==="regular"){const b={lastGridState:c,showDistances:!1,showAngles:!0,distanceSigFigs:d,angleDisplayMode:r,angleSigFigs:o,currentShiftPressed:a,viewTransform:l,colors:h};no(e,t,S.id,[S,v],b,p,g,u,!1,null,y),no(e,t,v.id,[S,v],b,p,g,u,!1,null,y)}}})}function Sc(e,{allFaces:t,selectedFaceIds:n,colors:s,isDragConfirmed:i,dragPreviewVertices:o,initialDragVertexStates:r,transformIndicatorData:a,highlightedEdgeForSnap:d,draggedFaceId:l,coordSystemSnapAngle:c,coordSystemSnapType:h,coordSystemSnapScale:f,initialCoordSystemStates:u},p,g){if(n.length>mh)return;const y=new Set(n);y.size!==0&&y.forEach(m=>{const x=t.find(v=>v.id===m);if(!x||!x.localCoordSystem)return;let S=x.localCoordSystem;if(i&&x.vertexIds.some(v=>o.some(b=>b.id===v))){const v=u.get(x.id);S=Uo(x,{initialSystem:v,dragPreviewVertices:o,initialDragVertexStates:r,findVertexById:g,transformIndicatorData:a})}if(l===m&&c!==null){const v=T=>{if(i&&o){const _=o.find(C=>C&&C.id===T);if(_)return _}return g(T)},b=p(S.origin);if(h==="edge"&&d!==null){const T=x.vertexIds.map(_=>v(_)).filter(_=>_&&_.type==="regular");if(d<T.length){const _=T[d],C=T[(d+1)%T.length],E=p(_),M=p(C);e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(E.x,E.y),e.lineTo(M.x,M.y),e.stroke(),e.restore()}}else if(h==="cardinal"){const _=b.x+Math.cos(-c)*100,C=b.y+Math.sin(-c)*100,E=b.x-Math.cos(-c)*100,M=b.y-Math.sin(-c)*100;e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(E,M),e.lineTo(_,C),e.stroke(),e.restore()}}Zf(e,S,s,p,f)})}function Zf(e,t,n,s,i=null){const o=s(t.origin),r=Cn({x:1,y:0},t),a=Cn({x:0,y:1},t),d=s(r),l=s(a);e.save(),e.lineWidth=ms,e.lineCap="round";const c=(u,p,g,y)=>{e.strokeStyle=g,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(p.x,p.y),e.stroke(),e.fillStyle=y;const m=Math.atan2(p.y-u.y,p.x-u.x);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(p.x-Ye*Math.cos(m-pn),p.y-Ye*Math.sin(m-pn)),e.lineTo(p.x-Ye*Math.cos(m+pn),p.y-Ye*Math.sin(m+pn)),e.closePath(),e.fill()},h=i!==null?n.feedbackSnapped:n.coordSysX,f=i!==null?n.feedbackSnapped:n.coordSysY;c(o,d,h,h),c(o,l,f,f),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(o.x,o.y,Zd,0,2*Math.PI),e.fill(),e.restore()}const Qf=6,eu=500,tu=300,Fl=8;function Xr(e,t){return{x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}}function Bl(e,t){const n=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.hypot(n,s)}function kn(e,t,n,s,i){const{shiftKey:o,ctrlKey:r,altKey:a,metaKey:d}=i||{};return{button:n,clientX:t.clientX,clientY:t.clientY,shiftKey:!!o,ctrlKey:!!r,metaKey:!!d,altKey:!!a,target:e,preventDefault:()=>s.preventDefault(),stopPropagation:()=>s.stopPropagation()}}function nu({canvas:e,onMouseDown:t,onMouseMove:n,onMouseUp:s,onPinchZoom:i,onPan:o,getModifiers:r,isHoverMode:a,getHoverTarget:d,getUiTargetAt:l}){let c=null,h=null,f=null,u=!1,p=!1,g=0,y=null,m=null,x=!1,S=!1,v=null,b=0;const T=()=>typeof r=="function"?r():{},_=()=>typeof a=="function"?a():!1,C=()=>typeof d=="function"?d():null,E=A=>typeof l=="function"?l(A):null,M=()=>{f&&(clearTimeout(f),f=null),u=!1},I=(A,R)=>{M(),f=setTimeout(()=>{u=!0;const O=kn(e,A,2,R,T());t(O)},eu)},w=A=>{if(!(!A.touches||A.touches.length===0)){if(A.preventDefault(),A.touches.length===1){const R=A.touches[0];if(c=R.identifier,h={x:R.clientX,y:R.clientY},m={x:R.clientX,y:R.clientY},p=!1,g=0,y=null,x=!1,S=!1,v=null,_()){const O=kn(e,R,0,A,T());n(O);const $=E({x:R.clientX,y:R.clientY}),F=C();if($||F&&F.type&&F.type!=="canvas"){const V=kn(e,R,0,A,T());t(V)}else x=!0}else{I(R,A);const O=kn(e,R,0,A,T());t(O)}return}if(A.touches.length===2){if(M(),S=_()&&x&&!!m,b=Date.now(),v=Xr(A.touches[0],A.touches[1]),c!==null&&h){const $=A.touches[0],F=kn(e,$,0,A,T());s(F)}p=!0,c=null;const[R,O]=A.touches;g=Bl(R,O),y=Xr(R,O)}}},L=A=>{if(!(!A.touches||A.touches.length===0)){if(A.preventDefault(),p&&A.touches.length>=2){const[R,O]=A.touches,$=Bl(R,O),F=Xr(R,O);if(S&&v){const V=Math.hypot(F.x-v.x,F.y-v.y),B=Math.abs($-g);(V>Fl||B>Fl)&&(S=!1)}if(!S){if(g>0){const V=$/g;Number.isFinite(V)&&V!==1&&i(V,F)}if(y){const V=F.x-y.x,B=F.y-y.y;(V!==0||B!==0)&&o({x:V,y:B})}}g=$,y=F;return}if(A.touches.length===1&&c!==null){const R=A.touches[0],O=R.clientX-(h?.x??R.clientX),$=R.clientY-(h?.y??R.clientY);Math.hypot(O,$)>Qf&&M(),h={x:R.clientX,y:R.clientY},m={x:R.clientX,y:R.clientY};const F=kn(e,R,0,A,T());n(F)}}},P=A=>{if(A.preventDefault(),p&&A.touches.length<2&&(p=!1,g=0,y=null),S&&m){if(Date.now()-b<=tu){const O={clientX:m.x,clientY:m.y},$=kn(e,O,0,A,T()),F=kn(e,O,0,A,T());t($),s(F)}}else if(c!==null&&!_()){const R=Array.from(A.changedTouches).find(O=>O.identifier===c)||A.changedTouches[0];if(R)if(u){const O=kn(e,R,2,A,T());s(O)}else{const O=kn(e,R,0,A,T());s(O)}}M(),S=!1,v=null,c=A.touches.length===1?A.touches[0].identifier:null,A.touches.length===0&&(h=null,m=null)};return e.style.touchAction="none",e.addEventListener("touchstart",w,{passive:!1}),e.addEventListener("touchmove",L,{passive:!1}),e.addEventListener("touchend",P,{passive:!1}),e.addEventListener("touchcancel",P,{passive:!1}),()=>{M(),e.removeEventListener("touchstart",w),e.removeEventListener("touchmove",L),e.removeEventListener("touchend",P),e.removeEventListener("touchcancel",P)}}class su{constructor(){this.appMode="static",this.mode="idle",this.dragAction=null,this.selection={transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set},this.hoverTarget={type:"canvas",id:null},this.modifiers={shift:!1,ctrl:!1,alt:!1},this.marqueeRect={active:!1,startX:0,startY:0,endX:0,endY:0},this.lastClickTime=0,this.lastClickTarget={type:null,id:null},this.clickCount=0,this.selectionBeforeClick=null,this.zoomLevel=1,this.activeTransformationObjectId=null,this.lastMouseX=0,this.lastMouseY=0,this.textInput={active:!1,x:0,y:0,value:""},this.touchTimerId=null,this.initialTouchData=null}clearGeometricSelection(){this.selection.vertices.clear(),this.selection.edges.clear(),this.selection.faces.clear(),this.selection.text.clear()}clearTransformationObjectSelection(){this.selection.transformationObjects.clear(),this.activeTransformationObjectId=null}clearSelection(){this.clearGeometricSelection(),this.clearTransformationObjectSelection(),this.selection.ui.clear()}}const ou=300,iu=500,$l=1.1,Vl=.2,Xl=5,Ne={IDLE:"idle",DRAWING:"drawing",DRAGGING:"dragging",SELECTING:"selecting",TYPING:"typing"},Ie={VERTEX:"vertex",EDGE:"edge",FACE:"face",TEXT:"text",TRANSFORMATION_OBJECT:"transformationObject",MANIFOLD:"manifold",UI:"ui",CANVAS:"canvas"},Xn={[Ie.VERTEX]:"vertices",[Ie.EDGE]:"edges",[Ie.FACE]:"faces",[Ie.TEXT]:"text",[Ie.TRANSFORMATION_OBJECT]:"transformationObjects",[Ie.MANIFOLD]:"manifolds",[Ie.UI]:"ui"},Wn={PANNING:"panning",MARQUEE_SELECT:"marqueeSelect",RIGID_DRAG:"rigidDrag"};function rs(e,t,n){if(t===Ie.UI)return;const s=Xn[t];if(!s){console.warn(`No selection key for type: ${t}`);return}const i=e.selection[s];if(!i){console.warn(`No selection set for type: ${t} (key: ${s})`);return}const o=e.modifiers.ctrl&&!e.modifiers.shift;n.forEach(r=>{o&&i.has(r)?i.delete(r):i.add(r)})}function ru(e,t,n){const{originalSelection:s}=e.dragAction;if(!s)return;const i=n&&n.ctrlKey,o=n&&n.shiftKey,{startX:r,startY:a,endX:d,endY:l}=e.marqueeRect,c={minX:Math.min(r,d),maxX:Math.max(r,d),minY:Math.min(a,l),maxY:Math.max(a,l)},h=t.getEntitiesInRect(c),f=new Set(s.vertices),u=new Set(s.edges),p=new Set(s.faces),g=new Set(s.text),y=new Set(s.transformationObjects),m={[Xn[Ie.VERTEX]]:f,[Xn[Ie.EDGE]]:u,[Xn[Ie.FACE]]:p,[Xn[Ie.TEXT]]:g,[Xn[Ie.TRANSFORMATION_OBJECT]]:y},x=i&&!o;!i&&!o?e.clearGeometricSelection():(e.selection.vertices=new Set(s.vertices),e.selection.edges=new Set(s.edges),e.selection.faces=new Set(s.faces),e.selection.text=new Set(s.text),e.selection.transformationObjects=new Set(s.transformationObjects)),h.length>0&&h.forEach(v=>{const b=Xn[v.type];if(!b||!e.selection[b])return;const T=e.selection[b],C=m[b]?.has(v.id);x&&C?T.delete(v.id):T.add(v.id)})}function au(e,t,n,s){if(e.mode===Ne.TYPING){s.preventDefault(),s.key==="Enter"||s.key==="Escape"?(n.stopTyping(e),e.mode=Ne.IDLE):s.key==="Backspace"?n.backspace(e):s.key.length===1&&n.updateText(e,s.key);return}if(s.key==="Shift"&&(e.modifiers.shift=!0),s.key==="Control"&&(e.modifiers.ctrl=!0),s.key==="Alt"&&(e.modifiers.alt=!0),e.modifiers.ctrl&&(s.key==="a"||s.key==="A")){s.preventDefault(),e.clearGeometricSelection(),document.querySelectorAll(".proxy-entity").forEach(i=>{const o=i.dataset.type,r=i.dataset.id,a=Xn[o];if(a&&o!==Ie.TRANSFORMATION_OBJECT&&o!==Ie.UI){const d=e.selection[a];d&&d.add(r)}}),e.clickCount=0,e.selectionBeforeClick=null;return}(s.key==="Escape"||s.key==="Esc")&&(e.mode=Ne.IDLE,e.dragAction=null,e.clearSelection(),e.activeTransformationObjectId=null,e.marqueeRect.active=!1,e.clickCount=0,e.selectionBeforeClick=null),s.key.length===1&&!s.ctrlKey&&!s.metaKey&&(e.mode===Ne.IDLE||e.mode===Ne.DRAWING)&&(s.preventDefault(),e.mode=Ne.TYPING,n.startTyping(e),n.updateText(e,s.key))}function lu(e,t,n,s){s.key==="Shift"&&(e.modifiers.shift=!1),s.key==="Control"&&(e.modifiers.ctrl=!1),s.key==="Alt"&&(e.modifiers.alt=!1)}function Ic(e,t,n,s){let i=e.zoomLevel;s.deltaY<0?i*=$l:s.deltaY>0&&(i/=$l),i<Vl&&(i=Vl),i>Xl&&(i=Xl),e.zoomLevel=i}function bc(e,t,n,s){e.hoverTarget={type:s.type,id:s.id}}function vc(e,t,n,s){e.hoverTarget.id===s.id&&(e.hoverTarget={type:Ie.CANVAS,id:null})}function cu(e,t,n,s){e.appMode=s.mode}function du(e,t,n,s){e.mode===Ne.TYPING&&(n.stopTyping(e),e.mode=Ne.IDLE),s.button===0&&e.hoverTarget.type===Ie.CANVAS&&(e.clickCount=0,e.selectionBeforeClick=null,e.dragAction={hasMoved:!1,button:0})}function Ui(e){return e?{transformationObjects:new Set(e.transformationObjects),vertices:new Set(e.vertices),edges:new Set(e.edges),faces:new Set(e.faces),text:new Set(e.text),ui:new Set(e.ui)}:{transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set}}function Mc(e,t,n,s){if(e.mode===Ne.TYPING&&(n.stopTyping(e),e.mode=Ne.IDLE),s.button===0){if(e.modifiers.alt){e.mode=Ne.DRAWING,e.clickCount=0,e.selectionBeforeClick=null;return}const i=Date.now(),{type:o,id:r}=s,a=Xn[o];if(!a){console.warn(`Unknown entity type for selection: ${o}`);return}const d=e.selection[a],l=d&&d.has(r),c=o===Ie.VERTEX||o===Ie.EDGE||o===Ie.FACE||o===Ie.TEXT,h=o===Ie.TRANSFORMATION_OBJECT;if(e.lastClickTarget.id===r&&i-e.lastClickTime<ou?e.clickCount++:(e.clickCount=1,e.selectionBeforeClick=Ui(e.selection)),e.lastClickTime=i,e.lastClickTarget={type:o,id:r},o===Ie.UI){e.clickCount=0,e.selectionBeforeClick=null;return}if(e.clickCount===1)e.modifiers.ctrl||e.modifiers.shift?rs(e,o,[r]):l||(c?e.clearGeometricSelection():h&&e.clearTransformationObjectSelection(),rs(e,o,[r]));else if(e.selection=Ui(e.selectionBeforeClick),c)if(e.clickCount===2){const f=t.getNeighbors(r),u={};f.forEach(p=>{const g=t.getEntityType(p);!g||g===Ie.UI||(u[g]||(u[g]=[]),u[g].push(p))});for(const p in u)rs(e,p,u[p]);rs(e,o,[r])}else{const f=t.getAllConnected(r),u=[];f.forEach(p=>{t.getEntityType(p)===o&&u.push(p)}),rs(e,o,u)}else h&&rs(e,o,[r]);if(h){const f=e.selection.transformationObjects;f.has(r)?e.activeTransformationObjectId=r:e.activeTransformationObjectId===r&&(e.activeTransformationObjectId=f.size>0?Array.from(f)[f.size-1]:null)}e.clickCount>=3&&(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction={hasMoved:!1,button:0,draggedEntityType:o,draggedEntityId:r,wasAlreadySelected:l}}}function Ec(e,t,n,s){if(e.lastMouseX=s.clientX,e.lastMouseY=s.clientY,e.mode===Ne.TYPING&&(e.textInput.x=s.clientX,e.textInput.y=s.clientY),!!e.dragAction){if(!e.dragAction.hasMoved)if(e.dragAction.hasMoved=!0,e.clickCount>0&&e.selectionBeforeClick&&(e.selection=Ui(e.selectionBeforeClick)),e.clickCount=0,e.selectionBeforeClick=null,e.dragAction.button===0)if(e.dragAction.draggedEntityType){const i=t.getDragType(e);i?(e.dragAction.type=i,e.mode=Ne.DRAGGING):e.dragAction.type=Wn.PANNING}else e.dragAction.type=Wn.PANNING,!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection();else e.dragAction.button===2&&(e.dragAction.type=Wn.MARQUEE_SELECT,e.mode=Ne.SELECTING,e.marqueeRect.active=!0,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY);e.dragAction&&e.dragAction.type===Wn.MARQUEE_SELECT&&(e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY,ru(e,t,s))}}function Tc(e,t,n,s){if(s.button===0){if(e.dragAction&&e.dragAction.button===0)if(e.dragAction.hasMoved)e.mode=Ne.IDLE;else{const i=e.dragAction.draggedEntityType;if(i){const o=i===Ie.VERTEX||i===Ie.EDGE||i===Ie.FACE||i===Ie.TEXT,r=i===Ie.TRANSFORMATION_OBJECT;e.clickCount===1&&e.dragAction.wasAlreadySelected&&!s.shiftKey&&!s.ctrlKey&&(o?(e.clearGeometricSelection(),rs(e,i,[e.dragAction.draggedEntityId])):r&&(e.clearTransformationObjectSelection(),rs(e,i,[e.dragAction.draggedEntityId]),e.activeTransformationObjectId=e.dragAction.draggedEntityId))}else!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==Ne.DRAWING&&(e.mode=Ne.DRAWING)}else e.dragAction||e.hoverTarget.type===Ie.CANVAS&&(!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==Ne.DRAWING&&(e.mode=Ne.DRAWING));e.clickCount>0&&(!e.dragAction||!e.dragAction.hasMoved)||(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction=null}}function hu(e,t,n,s){e.mode===Ne.TYPING&&(n.stopTyping(e),e.mode=Ne.IDLE),e.clickCount=0,e.selectionBeforeClick=null,(e.mode===Ne.IDLE||e.mode===Ne.DRAWING)&&(e.dragAction={hasMoved:!1,button:2,originalMode:e.mode,originalSelection:Ui(e.selection)},e.marqueeRect.startX=s.clientX,e.marqueeRect.startY=s.clientY,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY)}function ra(e,t,n,s){e.dragAction&&e.dragAction.button===2?e.dragAction.hasMoved?e.mode=e.dragAction.originalMode:(!s.shiftKey&&!s.ctrlKey&&(e.clearSelection(),e.activeTransformationObjectId=null),e.mode=Ne.IDLE):e.dragAction||(e.mode=Ne.IDLE),e.dragAction=null,e.marqueeRect.active=!1}function fu(e,t,n,s){if(e.mode===Ne.TYPING){n.stopTyping(e),e.mode=Ne.IDLE;return}const i=s.event;i.touches.length===1?(e.lastMouseX=i.touches[0].clientX,e.lastMouseY=i.touches[0].clientY,clearTimeout(e.touchTimerId),e.initialTouchData={clientX:i.touches[0].clientX,clientY:i.touches[0].clientY,targetType:s.type,targetId:s.id},e.touchTimerId=setTimeout(()=>{e.touchTimerId=null;const o=e.initialTouchData.targetType,r=e.initialTouchData.targetId;o===Ie.CANVAS?e.dragAction={hasMoved:!1,button:0}:Mc(e,t,n,{type:o,id:r,button:0}),e.hoverTarget={type:Ie.CANVAS,id:null}},iu),s.type!==Ie.CANVAS&&bc(e,t,n,{type:s.type,id:s.id})):i.touches.length===2&&(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,e.dragAction={hasMoved:!1,button:0,type:Wn.PANNING,startDistance:Math.hypot(i.touches[0].clientX-i.touches[1].clientX,i.touches[0].clientY-i.touches[1].clientY),startCenter:{x:(i.touches[0].clientX+i.touches[1].clientX)/2,y:(i.touches[0].clientY+i.touches[1].clientY)/2},originalMode:e.mode},e.mode=Ne.DRAGGING,e.clearGeometricSelection())}function uu(e,t,n,s){const i=s.touches;if(i.length===1){const o=i[0].clientX,r=i[0].clientY;if(e.lastMouseX=o,e.lastMouseY=r,e.touchTimerId&&(clearTimeout(e.touchTimerId),e.touchTimerId=null),e.dragAction&&e.dragAction.button===0){Ec(e,t,n,{clientX:o,clientY:r,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl});return}}else if(i.length===2&&e.dragAction&&e.dragAction.type===Wn.PANNING){e.dragAction.hasMoved=!0;const o=Math.hypot(i[0].clientX-i[1].clientX,i[0].clientY-i[1].clientY),r={x:(i[0].clientX+i[1].clientX)/2,y:(i[0].clientY+i[1].clientY)/2},a=o/e.dragAction.startDistance,d=Math.log(a)*100;r.x-e.dragAction.startCenter.x,r.y-e.dragAction.startCenter.y,d!==0&&Ic(e,t,n,{deltaY:-d}),e.lastMouseX=r.x,e.lastMouseY=r.y}}function gu(e,t,n,s){e.touchTimerId?(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,ra(e,t,n,{shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}),e.mode===Ne.IDLE&&!e.modifiers.shift&&!e.modifiers.ctrl&&e.clearSelection()):e.dragAction&&e.dragAction.button===0?Tc(e,t,n,{button:0,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}):e.hoverTarget={type:Ie.CANVAS,id:null},e.dragAction&&e.dragAction.button===2&&ra(e,t,n,{}),e.dragAction=null,e.marqueeRect.active=!1,vc(e,t,n,{id:e.hoverTarget.id})}const pu={keyDown:au,keyUp:lu,wheel:Ic,hoverStart:bc,hoverEnd:vc,appModeChange:cu,mouseDown:du,entityMouseDown:Mc,mouseMove:Ec,mouseUp:Tc,rightMouseDown:hu,rightMouseUp:ra,touchStart:fu,touchMove:uu,touchEnd:gu};function yu(e,t,n,s,i){const o=pu[s];o&&o(e,t,n,i)}const Ce=document.getElementById("drawingCanvas"),Le=Ce.getContext("2d",{willReadFrequently:!0}),yt=document.getElementById("html-overlay"),je=window.devicePixelRatio||1,Jo=new Map,Fa=cs,bi=8,Yr={x:12,y:-12},mu={x:8,y:-8};let Lt={activeId:null,inputEl:null};const wn={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0,radiusMode:"relative",radiusValue:.25},Ba="platonic-play",ji=1,Gr=`${Ba}.user-id`;let vn=null,vi=null,Cc=!1,ls,so,In=[JSON.parse(JSON.stringify(wn))],$s=wn.id;const U={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,colorModeToolButton:null,colorModeIcons:[],colorModeExprFields:[],colorModePanelBounds:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[],sessionsToolButton:null,sessionIcons:[],addSessionButton:null,removeSessionButton:null,sessionsPanelBounds:null};let Pt,oo=null,io=null,jt=null,aa=[],Ji=null,Zo=null,Nn=new Map,Rn=null,zn=null,mo=null,ai=null,Vs=null,Gn=null,lo=!1,Wt=null,Ve=[],Jt=null,Ss=null,wt=null,ts=null,Qo=!1,li=null,Mn=!1,vr=!1,un=!1,Mt=!1,gn=!1,Xs="regular",Ze="lines",nn="degrees",Ci="on",Zi=!0,Qi=!0,ns=!0,bn=null,Ut=null,Vt=null,er=null,tr=!1,fs=!1,xe=[],j=[],re=[],He=[],Is=new Map,Et=new Map,Me=[],be=[],me=[],De=[],it=null,oe={x:0,y:0},bs=null,us=!1,xt=!1,nr=!1,Yo=null,Ln=!1,an=!1,xo=null,pt=[],fn=0,as=!0,Vn=!0,dt=null,wi=4,Ps=3,xu=.5,et=null,Ht=!1,ze=!1,Jn=!1,Pn=!1,sn=-1,tn={x:0,y:0},Wr={x:0,y:0},ye=[],sr={x:0,y:0},de=null,we=gr,ot=!1,It=null,ei=null,_e=[],ro=[],la=[],ke=!1,zt={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},Te={targetId:null,type:null,count:0,timestamp:0},Mi={id:null,timestamp:0},_t=[],Xe=[],Nt=0,Ot=0,Go=null,or=[],Tt="colormap",At="colormap_xy",On="x",vs="x",Ls="r",ss="1-r",Ms="1/(r+0.001)",Es="1/(r+0.001)",ko={},Ro={},ca={},da={},Hn=null,Kn=null,Dt=!1,Ao=!1,ln=null,Pi=!1,Bt=null;function Su(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,s=Array.prototype.splice;_t.pop=function(){return e.call(this)},_t.push=function(...i){return t.call(this,...i)},_t.shift=function(){return n.call(this)},_t.splice=function(...i){return s.call(this,...i)}}let ha=!1,ps=[],Ke=null,Ge=[],Kt="",on=null,Ys=[],Ai=0,Z={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},ge={scale:jd,offsetX:0,offsetY:0},Zt={angle1:30,angle2:15,alpha1:1,alpha2:0},$a=new Set,ti="dark",tt=[],ys=!1,vt=null,Wo=!1,_i=null,Oe={[nt]:0,[qe]:1,[at]:2,[qt]:0},os=!1,An=null,ir=null,co=new Set;const Pe=new su,wc={getEntitiesInRect:e=>{const t=[],n=s=>s.x>=e.minX&&s.x<=e.maxX&&s.y>=e.minY&&s.y<=e.maxY;return xe.forEach(s=>{const i=Ae(s);n(i)&&t.push({type:s.type==="regular"?Ie.VERTEX:Ie.TRANSFORMATION_OBJECT,id:s.id})}),j.forEach(s=>{const i=J(s.id1),o=J(s.id2);if(!i||!o)return;const r=Ae({x:(i.x+o.x)/2,y:(i.y+o.y)/2});n(r)&&t.push({type:Ie.EDGE,id:le(s)})}),re.forEach(s=>{const i=s.vertexIds.map(a=>J(a)).filter(Boolean);if(i.length<3)return;const o=i.reduce((a,d)=>({x:a.x+d.x,y:a.y+d.y}),{x:0,y:0}),r=Ae({x:o.x/i.length,y:o.y/i.length});n(r)&&t.push({type:Ie.FACE,id:pe(s)})}),He.forEach(s=>{const i=s.screenBounds;if(!i)return;const o={x:(i.left+i.right)/2,y:(i.top+i.bottom)/2};n(o)&&t.push({type:Ie.TEXT,id:s.id})}),t},getNeighbors:e=>{if(J(e))return hn(e,j);const n=j.find(o=>le(o)===e);if(n)return[n.id1,n.id2];const s=re.find(o=>pe(o)===e);if(s)return[...s.vertexIds];const i=He.find(o=>o.id===e);return i&&i.anchorId?[i.anchorId]:[]},getAllConnected:e=>{const t=wc.getEntityType(e);if(t===Ie.VERTEX||t===Ie.TRANSFORMATION_OBJECT)return Ws(e);if(t===Ie.EDGE){const n=j.find(i=>le(i)===e);if(!n)return[];const s=new Set(Ws(n.id1));return j.filter(i=>s.has(i.id1)&&s.has(i.id2)).map(i=>le(i))}if(t===Ie.FACE){const n=re.find(o=>pe(o)===e);if(!n)return[];const s=new Set([pe(n)]),i=[n];for(;i.length>0;){const o=i.shift();re.forEach(r=>{const a=pe(r);s.has(a)||r.vertexIds.some(d=>o.vertexIds.includes(d))&&(s.add(a),i.push(r))})}return Array.from(s)}return[e]},getEntityType:e=>{const t=J(e);return t?t.type==="regular"?Ie.VERTEX:Ie.TRANSFORMATION_OBJECT:j.some(n=>le(n)===e)?Ie.EDGE:re.some(n=>pe(n)===e)?Ie.FACE:He.some(n=>n.id===e)?Ie.TEXT:null},getDragType:e=>e.selection.vertices.size>0||e.selection.edges.size>0||e.selection.faces.size>0||e.selection.text.size>0||e.selection.transformationObjects.size>0?Wn.RIGID_DRAG:null},Iu={startTyping:()=>{Lt.activeId||ga("")},updateText:(e,t)=>{if(!Lt.activeId){ga(t);return}const n=Lt.inputEl;if(n)n.value+=t;else{const s=bo(Lt.activeId);s&&(s.content=`${s.content||""}${t}`)}e.textInput.value=Lt.inputEl?Lt.inputEl.value:""},backspace:e=>{const t=Lt.inputEl;t&&(t.value=t.value.slice(0,-1),e.textInput.value=t.value)},stopTyping:()=>{Fo(!0)}};function mn(e,t){yu(Pe,wc,Iu,e,t)}function Xt(){Lt.activeId?Pe.mode=Ne.TYPING:Pn?Pe.mode=Ne.SELECTING:ze||Jn||fs||os?Pe.mode=Ne.DRAGGING:ot?Pe.mode=Ne.DRAWING:Pe.mode=Ne.IDLE,Pe.modifiers.shift=ke,Pe.modifiers.ctrl=Ao,Pe.modifiers.alt=Dt,Pe.selection.vertices=new Set(Me),Pe.selection.edges=new Set(be),Pe.selection.faces=new Set(me),Pe.selection.text=new Set(De),Pe.selection.transformationObjects=new Set(Ge),Pe.activeTransformationObjectId=it,er?Pe.hoverTarget={type:Ie.TEXT,id:er}:bn?Pe.hoverTarget={type:Ie.VERTEX,id:bn}:Ut?Pe.hoverTarget={type:Ie.EDGE,id:Ut}:Vt?Pe.hoverTarget={type:Ie.FACE,id:Vt}:Pe.hoverTarget={type:Ie.CANVAS,id:null},Pe.marqueeRect={active:Pn,startX:sr.x,startY:sr.y,endX:oe.x,endY:oe.y},Pe.zoomLevel=ge.scale,Pe.lastMouseX=oe.x,Pe.lastMouseY=oe.y;const e=Lt.inputEl;Pe.textInput.active=!!Lt.activeId,Pe.textInput.x=oe.x,Pe.textInput.y=oe.y,Pe.textInput.value=e?e.value:"",Ht?Pe.dragAction={hasMoved:ze,button:sn,type:Pn?Wn.MARQUEE_SELECT:Jn?Wn.PANNING:null}:Pe.dragAction=null}function Yl(e,t){e&&(e.classList.toggle("active",t),e.setAttribute("aria-pressed",t?"true":"false"))}function bu(e,t){const n={key:e,shiftKey:e==="Shift",ctrlKey:e==="Control",metaKey:!1,altKey:e==="Alt",repeat:!1,target:document.body,preventDefault:()=>{},stopPropagation:()=>{}};t?nd(n):sd(n)}function vu(){const e=document.getElementById("mobile-controls");if(!e)return;const t=e.querySelector('[data-mod="hover"]'),n=e.querySelector('[data-mod="shift"]'),s=e.querySelector('[data-mod="ctrl"]'),i=e.querySelector('[data-mod="alt"]'),o=()=>{Pi=!Pi,Yl(t,Pi),Xt()},r=(a,d,l)=>{const c=!l;Yl(a,c),bu(d,c)};t&&t.addEventListener("click",o),n&&n.addEventListener("click",()=>r(n,"Shift",ke)),s&&s.addEventListener("click",()=>r(s,"Control",Ao)),i&&i.addEventListener("click",()=>r(i,"Alt",Dt))}function Mu(e){return nc(e,U,{isToolbarExpanded:us,isColorPaletteExpanded:xt,isColorModePanelExpanded:gn,isInterpolationPanelExpanded:un,isTransformPanelExpanded:Ln,isDisplayPanelExpanded:Mn,isVisibilityPanelExpanded:vr,isSessionsPanelExpanded:Mt})}function Cs(){qh(re,J)}function Mr(){return Hh(ti,Ed)}function Je(e,t=0,n=1){let s=Oe[e];(s<0||s>=we.length)&&(s=0);const i=we[s];if(i?.type==="color")return i.value;if(i?.type==="colormap"){const r=n>1?t/(n-1):.5;return We(i,r)}const o=Mr();return e===nt?o.vertex:e===qe?o.edge:e===at?o.face:e===qt?o.uiTextDefault||o.geometryInfoText:o.vertex}function rr(e){return[]}function So(){const e=new Set(be);return Array.from(Pe.selection.edges||[]).forEach(n=>e.add(n)),Array.from(e)}function Io(){const e=new Set(me);return Array.from(Pe.selection.faces||[]).forEach(n=>e.add(n)),Array.from(e)}function ho(){const e=So();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=j.find(i=>le(i)===n);s&&t.add(Va(s))}),Array.from(t)}function fo(){const e=Io();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=re.find(i=>pe(i)===n);s&&t.add(Xa(s))}),Array.from(t)}function Pc(){const e=So();if(e.length>0){const n=Ut?j.find(s=>le(s)===Ut):null;if(n&&e.includes(le(n))){const s=Va(n);ho().includes(s)&&(Hn=s)}ho().includes(Hn)||(Hn=ho()[0]||Hn)}const t=Io();if(t.length>0){const n=Vt?re.find(s=>pe(s)===Vt):null;if(n&&t.includes(pe(n))){const s=Xa(n);fo().includes(s)&&(Kn=s)}fo().includes(Kn)||(Kn=fo()[0]||Kn)}}function Va(e){return e?.colorMode||Tt}function Xa(e){return e?.colorMode||At}function Eu(e){return e?e.type==="color"?!0:e.type==="colormap"?Array.isArray(e.vertices)&&e.vertices.length===1:!1:!1}function Ac(e){if(!e)return null;if(e.type==="colormap")return e;if(e.type==="color"){const t=es(e.value);return{type:"colormap",vertices:[{pos:0,color:t?[Math.round(t.r),Math.round(t.g),Math.round(t.b)]:[255,255,255],alpha:1}],isCyclic:!1}}return null}function is(e,t){if(e.colorMode=t,t==="colormap"){const n=we[Oe[qe]],s=Ac(n);if(s){e.colormapItem=e.colormapItem||s,e.gradientStart=e.gradientStart??0,e.gradientEnd=e.gradientEnd??1,delete e.color;return}e.color=Je(qe),delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd;return}delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd}function ci(e,t){if(e.colorMode=t,t==="colormap_xy"){const n=we[Oe[at]],s=Ac(n);if(s){e.colormapItem=e.colormapItem||s,e.colormapDistribution=e.colormapDistribution||"x",delete e.color;return}e.color=Je(at),delete e.colormapItem,delete e.colormapDistribution;return}delete e.colormapItem,delete e.colormapDistribution}function Tu(e,t=null){(t||So()).forEach(s=>{const i=j.find(o=>le(o)===s);i&&is(i,e)})}function Cu(e,t=null){(t||Io()).forEach(s=>{const i=re.find(o=>pe(o)===s);i&&ci(i,e)})}function fa(){j.forEach(e=>{const t=e.colorMode||Tt;is(e,t)}),re.forEach(e=>{const t=e.colorMode||At;ci(e,t)})}function Ya(){tt.forEach(e=>{const t=Oe[e];if(e===nt){const n=we[t];if(n&&n.type==="colormap"){const s=Me.map(i=>J(i)).filter(i=>i&&i.type==="regular");s.forEach((i,o)=>{const r=s.length>1?o/(s.length-1):.5;i.color=We(n,r)})}else Me.forEach(s=>{const i=J(s);i&&i.type==="regular"&&(i.color=Je(nt))})}else if(e===qe){const n=we[t];be.forEach((s,i)=>{const o=j.find(d=>le(d)===s);if(!o)return;const r=Va(o);if(r==="inherit_vertices")return;if(r==="colormap"&&n&&n.type==="colormap"){const d=be.length,l=d>1?i/d:0,c=d>1?(i+1)/d:1;o.gradientStart=l,o.gradientEnd=c,o.colormapItem=n,delete o.color;return}const a=n&&n.type==="colormap"?We(n,.5):Je(qe);o.color=a,delete o.gradientStart,delete o.gradientEnd,delete o.colormapItem})}else if(e===at){const n=Oe[e],s=we[n];me.forEach(i=>{const o=re.find(d=>pe(d)===i);if(!o)return;const r=Xa(o);if(r==="inherit_vertices"||r==="inherit_edges")return;if(r==="colormap_xy"&&s&&s.type==="colormap"){o.colormapItem=s,o.colormapDistribution="x",delete o.color;return}const a=s&&s.type==="colormap"?We(s,.5):Je(at);o.color=a,delete o.colormapItem,delete o.colormapDistribution})}else if(e===qt){const n=we[t];if(n&&n.type==="colormap")De.forEach((s,i)=>{const o=bo(s);if(!o)return;const r=De.length>1?i/(De.length-1):.5;o.color=We(n,r)});else{const s=Je(qt);De.forEach(i=>{const o=bo(i);o&&(o.color=s)})}}})}function Ct({id:e,content:t,x:n,y:s,color:i,fontSize:o,options:r={}}){$a.add(e);let a=Jo.get(e);if(a){if(!a.contentEl||!a.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),a.textContent="",a.appendChild(u),a.contentEl=u,a.katexEl=p,a.katexContent=null,a.style.pointerEvents="none"}}else{a=document.createElement("div"),a.style.position="absolute",a.style.fontFamily="KaTeX_Main, Times New Roman, serif",a.style.whiteSpace="nowrap",a.style.lineHeight="1",a.style.display="inline-block",a.style.padding="0",a.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),a.appendChild(u),a.contentEl=u,a.katexEl=p,yt.appendChild(a),Jo.set(e,a)}let d="-50%",l="-50%",c="center";switch(r.textAlign){case"left":d="0%";break;case"right":d="-100%";break}switch(r.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}r.textAlign==="left"&&r.textBaseline==="top"?c="top left":r.textAlign==="right"&&r.textBaseline==="top"?c="top right":r.textAlign==="left"&&r.textBaseline==="bottom"?c="bottom left":r.textAlign==="right"&&r.textBaseline==="bottom"&&(c="bottom right"),a.style.left=`${n}px`,a.style.top=`${s}px`,a.style.transformOrigin=c,a.style.transform=`translate(${d}, ${l}) rotate(${r.rotation||0}deg)`,a.style.display="inline-block",a.style.background="transparent",a.style.border="none",a.style.borderRadius="0",a.style.padding="0",a.style.minHeight="0",a.style.alignItems="",a.style.justifyContent="",a.style.color=i,a.style.fontSize=`${o}px`;const h=t==null?"":String(t),f=Md(h);if(a.katexContent!==f){const u=a.katexEl||a.contentEl||a;vd(u,f),a.katexContent=f}}function Gl(e,{placeholder:t,onChange:n}){if(e)return e;const s=document.createElement("div");s.style.position="absolute",s.style.display="none",s.style.boxSizing="border-box",s.style.pointerEvents="auto",s.style.fontFamily='Consolas, Monaco, "Courier New", monospace',s.style.fontSize=`${gl}px`,s.style.padding=`${oh}px ${Zl}px`,s.style.borderRadius=`${sh}px`,s.style.border=`${Jl}px solid rgba(0,0,0,0.3)`,s.style.background="transparent",s.style.alignItems="center",s.style.gap="4px";const i=document.createElement("div");i.style.display="inline-flex",i.style.alignItems="center",i.style.whiteSpace="nowrap",i.style.lineHeight="1",i.style.pointerEvents="none";const o=document.createElement("input");o.type="text",o.placeholder=t,o.style.flex="1",o.style.minWidth="0",o.style.border="none",o.style.outline="none",o.style.background="transparent",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize=`${gl}px`,o.style.color="#111111",o.style.height="100%",o.style.lineHeight="1",o.style.pointerEvents="auto";const r=()=>{n&&n(o.value)};return o.addEventListener("input",r),o.addEventListener("blur",r),o.addEventListener("keydown",a=>{a.key==="Enter"&&(r(),o.blur())}),s.appendChild(i),s.appendChild(o),yt.appendChild(s),{container:s,label:i,input:o,labelText:""}}function wu(e){const t=e.match(/[A-Za-z_][A-Za-z0-9_]*/g);return t||[]}function zr(e,t){const n=(e||"").trim();return n?wu(n).every(i=>t.includes(i)):!0}function Pu(){const e=ho(),t=fo();e.length>0&&(e.includes(Hn)||e[0]),t.length>0&&(t.includes(Kn)||t[0]);const n=()=>{const E=So();if(E.length===0)return null;if(Ut){const I=j.find(w=>le(w)===Ut);if(I&&E.includes(le(I)))return I}return j.find(I=>le(I)===E[0])||null},s=()=>{const E=Io();if(E.length===0)return null;if(Vt){const I=re.find(w=>pe(w)===Vt);if(I&&E.includes(pe(I)))return I}return re.find(I=>pe(I)===E[0])||null},i=E=>{const M=Oe[E],I=M>=0?we[M]:null;return Eu(I)?"1":"x"},o=E=>E==="edge"?"1-r":"1/(r+0.001)",r=E=>!E||typeof E!="string"?o("edge"):E.replace(/\bx\b/g,"r"),a=E=>!E||typeof E!="string"?i(qe):zr(E,["x"])?E:i(qe),d=(E,M)=>{E.labelText!==M&&(E.label.textContent=M,E.labelText=M)},l=(E,M)=>(ko[E]=Gl(ko[E],{placeholder:E==="inherit_vertices"?"r":"x",onChange:M}),ko[E]),c=(E,M)=>(Ro[E]=Gl(Ro[E],{placeholder:"x",onChange:M}),Ro[E]),h=(E,M)=>E==="inherit_vertices"?r(M?.weightExpression||ss||o("edge")):a(M?.colorExpression||On||i(qe)),f=(E,M)=>E==="inherit_edges"?M?.edgeWeightExpression||Es||o("face_edge"):E==="inherit_vertices"?M?.vertexWeightExpression||Ms||o("face_vertex"):M?.colorExpression||vs||Ls||i(at),u=(E,M)=>{const I=M.trim(),w=E==="inherit_vertices",L=w?r(I):a(I);if(!zr(L,w?["r"]:["x"])){const R=ko[E];R&&(R.input.value=h(E,n()));return}const A=So();A.length>0?A.forEach(R=>{const O=j.find($=>le($)===R);O&&(E==="inherit_vertices"?O.weightExpression=L||o("edge"):O.colorExpression=L||i(qe))}):E==="inherit_vertices"?ss=L||o("edge"):On=L||i(qe),en()},p=(E,M)=>{const I=M.trim();if(!zr(I,E==="inherit_edges"?["r"]:["x","y","r","a"])){const P=Ro[E];P&&(P.input.value=f(E,s()));return}const L=Io();L.length>0?L.forEach(P=>{const A=re.find(R=>pe(R)===P);A&&(E==="inherit_edges"?A.edgeWeightExpression=I||o("face_edge"):E==="inherit_vertices"?A.vertexWeightExpression=I||o("face_vertex"):A.colorExpression=I||i(at))}):E==="inherit_edges"?Es=I||o("face_edge"):E==="inherit_vertices"?Ms=I||o("face_vertex"):vs=I||i(at),en()},g=ti==="light",y=g?"#000000":"#ffffff",m=g?"#000000":"#ffffff",x=Mr().background;if(Object.values(ko).forEach(E=>{E.container.style.display="none"}),Object.values(Ro).forEach(E=>{E.container.style.display="none"}),!gn||!U.colorModeIcons.length)return;const S=[{mode:"inherit_vertices",label:"w(r)=",minWidth:"3ch"},{mode:"colormap",label:"c(x)=",minWidth:"3ch"}],v=[{mode:"inherit_vertices",label:"w(x,y,r,a) =",minWidth:"9ch"},{mode:"inherit_edges",label:"w(r) =",minWidth:"9ch"},{mode:"colormap_xy",label:"c(x,y,r,a) =",minWidth:"9ch"}];let b=!1;const T=(E,M,I)=>{const w=U.colorModeExprFields.find(N=>N.group===E&&N.mode===M.mode);if(!w)return;const L=E==="edge"?l(M.mode,N=>u(M.mode,N)):c(M.mode,N=>p(M.mode,N));if(d(L,M.label),!I){L.container.style.display="none";return}document.activeElement!==L.input&&(E==="edge"?L.input.value=h(M.mode,n()):L.input.value=f(M.mode,s()));const P=2;L.container.style.left=`${w.x-P}px`,L.container.style.top=`${w.y-P}px`,L.container.style.width=`${w.width+P*2}px`,L.container.style.height=`${w.height+P*2}px`,L.container.style.padding=`0 ${Zl}px`,L.container.style.border=`${Jl}px solid ${m}`,L.container.style.background=x,L.container.style.color=y;const A=Math.max(10,Math.floor(w.height*.64));L.container.style.fontSize=`${A}px`,L.input.style.fontSize=`${A}px`,L.input.style.color=y,L.input.style.minWidth=M.minWidth,L.input.style.height=`${w.height+P*2}px`,L.input.style.lineHeight=`${w.height+P*2}px`,L.container.style.display="flex";const R=w.baseWidth||w.width,O=w.stepWidth||R,$=L.label.getBoundingClientRect().width,F=L.input.scrollWidth,V=$+F+8,B=Math.max(0,Math.ceil((V-R)/O)),D=R+B*O;E==="edge"?ca[M.mode]!==D&&(ca[M.mode]=D,b=!0):da[M.mode]!==D&&(da[M.mode]=D,b=!0)},_=e.length>0?e:[Tt],C=t.length>0?t:[At];if(S.forEach(E=>T("edge",E,_.includes(E.mode))),v.forEach(E=>T("face",E,C.includes(E.mode))),b){za();return}}function Au(e,t,n){const s=es(e),i=es(t),o=Math.max(0,Math.min(1,n)),r=Math.round(s.r*(1-o)+i.r*o),a=Math.round(s.g*(1-o)+i.g*o),d=Math.round(s.b*(1-o)+i.b*o),l=s.a;return`rgba(${r}, ${a}, ${d}, ${l})`}function _u(){for(const[e,t]of Jo.entries())$a.has(e)||(t.remove(),Jo.delete(e))}function uo(e){return{x:e.x*je/ge.scale,y:-e.y*je/ge.scale}}function bo(e){return He.find(t=>t.id===e)}function Ga(e,t,n,s=null){if(!e||!t||!n)return null;const i={x:n.x-t.x,y:n.y-t.y},o=Math.hypot(i.x,i.y);if(o<1e-6)return null;let r={x:-i.y/o,y:i.x/o};if(s&&s.length>=3){const a={x:(t.x+n.x)/2,y:(t.y+n.y)/2},d=s.reduce((h,f)=>({x:h.x+f.x,y:h.y+f.y}),{x:0,y:0});d.x/=s.length,d.y/=s.length;const l={x:d.x-a.x,y:d.y-a.y};r.x*l.x+r.y*l.y>0&&(r={x:-r.x,y:-r.y})}return{normalData:r,edgeLen:o}}function _c(e){const t=j.find(l=>le(l)===e);if(!t)return uo(bi);const n=J(t.id1),s=J(t.id2);if(!n||!s)return uo(bi);const i=re.filter(l=>{const c=l.vertexIds||[];for(let h=0;h<c.length;h++){const f=c[h],u=c[(h+1)%c.length];if(f===t.id1&&u===t.id2||f===t.id2&&u===t.id1)return!0}return!1});let o=null;i.length===1&&(o=(i[0].vertexIds||[]).map(c=>J(c)).filter(Boolean));const r=Ga(t,n,s,o);if(!r)return uo(bi);const a=r.normalData,d=bi*je/ge.scale;return{x:a.x*d,y:a.y*d}}function Di(e,t){const n=j.find(l=>le(l)===e);if(!n||!t)return null;const s=J(n.id1),i=J(n.id2);if(!s||!i)return null;const o=Ga(n,s,i);if(!o)return null;const{normalData:r,edgeLen:a}=o;return a<1e-6?null:(t.x*r.x+t.y*r.y)/a}function ua(e){const t=J(e);if(!t)return{offset:uo(Yr),align:"left",baseline:"middle"};const s=hn(e,j).map(f=>J(f)).filter(Boolean);let i={x:1,y:0};if(s.length===2){const f={x:s[0].x-t.x,y:s[0].y-t.y},u={x:s[1].x-t.x,y:s[1].y-t.y},p=Math.hypot(f.x,f.y),g=Math.hypot(u.x,u.y);if(p>1e-6&&g>1e-6){const y={x:f.x/p,y:f.y/p},m={x:u.x/g,y:u.y/g},x={x:y.x+m.x,y:y.y+m.y},S=Math.hypot(x.x,x.y);S>1e-6?i={x:-x.x/S,y:-x.y/S}:i={x:-y.y,y:y.x}}}const o=Ae(t),r=Ae({x:t.x+i.x,y:t.y+i.y});let a={x:r.x-o.x,y:r.y-o.y};const d=Math.hypot(a.x,a.y);d>1e-6?(a.x/=d,a.y/=d):a={x:1,y:0};const l=Math.hypot(Yr.x,Yr.y),c={x:a.x*l,y:a.y*l},h=a.x>=0?"left":"right";return{offset:uo(c),align:h,baseline:"middle"}}function ni(e){return In.find(t=>t.id===e)||null}function vo(){return ni($s)||In[0]||wn}function ki(e){e&&($s=e,en())}function Dc(){const e=new Set(be),t=new Set(me),n=new Set(Me),s=new Set,i=o=>{const r=o||wn.id;s.add(r)};return e.size>0&&j.forEach(o=>{const r=le(o);e.has(r)&&i(o.interpolationStyleId)}),t.size>0&&re.forEach(o=>{const r=pe(o);r&&t.has(r)&&i(o.interpolationStyleId)}),e.size===0&&t.size===0&&n.size>0&&(j.forEach(o=>{(n.has(o.id1)||n.has(o.id2))&&i(o.interpolationStyleId)}),re.forEach(o=>{o.vertexIds&&o.vertexIds.some(r=>n.has(r))&&i(o.interpolationStyleId)})),s.size===1?[...s][0]:null}function Du(e){if(!e)return;const t=new Set(be),n=new Set(me),s=new Set(Me);let i=!1;t.size>0&&j.forEach(o=>{const r=le(o);t.has(r)&&(o.interpolationStyleId=e,i=!0)}),n.size>0&&re.forEach(o=>{const r=pe(o);r&&n.has(r)&&(o.interpolationStyleId=e,i=!0)}),t.size===0&&n.size===0&&s.size>0&&(j.forEach(o=>{(s.has(o.id1)||s.has(o.id2))&&(o.interpolationStyleId=e,i=!0)}),re.forEach(o=>{o.vertexIds&&o.vertexIds.some(r=>s.has(r))&&(o.interpolationStyleId=e,i=!0)})),i&&en()}function ku(){const e=new Set(be),t=new Set(me),n=new Set(Me);let s=!1;e.size>0&&j.forEach(i=>{const o=le(i);e.has(o)&&(delete i.interpolationStyleId,s=!0)}),t.size>0&&re.forEach(i=>{const o=pe(i);o&&t.has(o)&&(delete i.interpolationStyleId,s=!0)}),e.size===0&&t.size===0&&n.size>0&&(j.forEach(i=>{(n.has(i.id1)||n.has(i.id2))&&(delete i.interpolationStyleId,s=!0)}),re.forEach(i=>{i.vertexIds&&i.vertexIds.some(o=>n.has(o))&&(delete i.interpolationStyleId,s=!0)})),s&&en()}function Gs(e){const t=vo();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function Ru(e){const t=vo();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function Oo(e){if(!e)return null;const t=new Map;ze&&Array.isArray(_e)&&_e.length>0&&_e.forEach(s=>{if(!s||!s.id)return;const i=s.originalId||s.id;t.set(i,s)});const n=s=>t.has(s)?t.get(s):J(s);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const s=n(e.anchorId);return s?{anchor:{x:s.x,y:s.y}}:null}if(e.anchorType==="edge"){const s=j.find(g=>le(g)===e.anchorId);if(!s)return null;const i=n(s.id1),o=n(s.id2);if(!i||!o)return null;const r={x:(i.x+o.x)/2,y:(i.y+o.y)/2},a=Math.atan2(o.y-i.y,o.x-i.x),d=Ae(i),l=Ae(o),c=Math.atan2(l.y-d.y,l.x-d.x),h=re.filter(g=>{const y=g.vertexIds||[];for(let m=0;m<y.length;m++){const x=y[m],S=y[(m+1)%y.length];if(x===s.id1&&S===s.id2||x===s.id2&&S===s.id1)return!0}return!1});let f=null;h.length===1&&(f=(h[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=Ga(s,i,o,f),p=u?u.normalData:null;return{anchor:r,edgeAngleRad:a,edgeAngleRadScreen:c,edgeNormalData:p,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const s=re.find(r=>pe(r)===e.anchorId);if(!s)return null;const i=s.vertexIds.map(r=>n(r)).filter(r=>r&&r.type==="regular");return i.length<3?null:{anchor:{x:i.reduce((r,a)=>r+a.x,0)/i.length,y:i.reduce((r,a)=>r+a.y,0)/i.length}}}return null}function kc(){return de?.finalSnapResult?.finalDelta?de.finalSnapResult.finalDelta:de?.textFinalDelta?de.textFinalDelta:_e.length>0&&ye.length>0?{x:_e[0].x-ye[0].x,y:_e[0].y-ye[0].y}:null}function Rc(e){const t=Oo(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=_c(e.anchorId);const l=Di(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let s={x:t.anchor.x+n.x,y:t.anchor.y+n.y},i=e.rotationDeg||0,o=e.scale||1,r="center",a="middle";if(e.anchorType==="vertex"){const l=ua(e.anchorId);r=e.vertexAlign||l.align||"left",a=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(r="center",a="middle",typeof t.edgeAngleRadScreen=="number"?i+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(i+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(r="left",a="top");e.anchorType==="edge"&&(i>90||i<-90)&&(i+=180,i>180&&(i-=360),a="top");const d=De.includes(e.id);if(ze&&d)if(et){const{center:l,rotation:c,scale:h,directionalScale:f,startVector:u}=et;s=ut(s,l,c,h,f,u),i-=c*(180/Math.PI),o*=h}else{const l=kc();l&&(s={x:s.x+l.x,y:s.y+l.y})}return{id:e.id,content:e.content||"",position:s,rotationDeg:i,scale:o,textAlign:r,textBaseline:a}}function Lu(e){const t=yt.getBoundingClientRect(),n=[];He.forEach(s=>{const i=Rc(s);if(!i){n.push(s.id);return}const o=Ae(i.position),r=`text-${i.id}`,a=De.includes(s.id),d=s.color||Je(qt)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",c=Au(d,l,.35);Ct({id:r,content:i.content,x:o.x,y:o.y,color:a?c:d,fontSize:(s.fontSize||Fa)*i.scale,options:{textAlign:i.textAlign,textBaseline:i.textBaseline,rotation:i.rotationDeg}});const h=Jo.get(r);if(h){const f=h.contentEl||h;f.style.outline="none",f.style.textShadow="none",f.style.color=a?c:d;const p=(h.katexEl||f).getBoundingClientRect();s.screenBounds={left:p.left-t.left,top:p.top-t.top,right:p.right-t.left,bottom:p.bottom-t.top}}}),n.length>0&&(He=He.filter(s=>!n.includes(s.id)),De=De.filter(s=>!n.includes(s)))}function Lc(e){for(let t=He.length-1;t>=0;t--){const n=He[t],s=n.screenBounds;if(s&&e.x>=s.left&&e.x<=s.right&&e.y>=s.top&&e.y<=s.bottom)return n}return null}function Nc(e,t=""){if(!Lt.inputEl){const o=document.createElement("input");o.type="text",o.style.position="absolute",o.style.zIndex="5",o.style.pointerEvents="auto",o.style.fontFamily="KaTeX_Main, Times New Roman, serif",o.style.fontSize=`${e.fontSize||Fa}px`,o.style.border="1px solid rgba(255, 255, 255, 0.4)",o.style.borderRadius="4px",o.style.padding="2px 4px",o.style.background="rgba(0, 0, 0, 0.6)",o.style.color="#ffffff",o.style.outline="none",o.addEventListener("keydown",r=>{r.key==="Enter"?(r.preventDefault(),Fo(!0)):r.key==="Escape"&&(r.preventDefault(),Fo(!1))}),o.addEventListener("mouseleave",()=>Fo(!0)),o.addEventListener("blur",()=>Fo(!0)),yt.appendChild(o),Lt.inputEl=o}const n=Rc(e);if(!n)return;const s=Ae(n.position),i=Lt.inputEl;i.value=t||e.content||"",i.style.left=`${s.x}px`,i.style.top=`${s.y}px`,i.style.transform="translate(-10%, -10%)",i.style.display="block",Lt.activeId=e.id,i.focus(),i.setSelectionRange(i.value.length,i.value.length)}function Fo(e){const t=Lt.inputEl;if(!t)return;const n=Lt.activeId;if(n&&e){const s=bo(n);if(s){st();const i=t.value.trim();!i&&s.isDraft?(He=He.filter(o=>o.id!==s.id),De=De.filter(o=>o!==s.id)):(s.content=i||s.content||"",delete s.isDraft)}}t.style.display="none",Lt.activeId=null}function ga(e=""){let t="canvas",n=null,s={x:0,y:0},i=Re(oe);if(bn)t="vertex",n=bn,s=ua(n).offset;else if(Ut)t="edge",n=Ut,s=_c(n);else if(Vt)t="face",n=Vt;else{const r=uo(mu);i={x:i.x+r.x,y:i.y+r.y}}const o={id:$t(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?i:null,offset:t==="canvas"?{x:0,y:0}:s,rotationDeg:0,scale:1,fontSize:Fa,color:Je(qt),isDraft:!0};if(t==="vertex"){const r=ua(n);o.vertexAlign=r.align,o.vertexBaseline=r.baseline}He.push(o),De=[o.id],Nc(o,e)}function Wa(e,t,n){const s=new Set(Pe.selection.transformationObjects);let i=Pe.activeTransformationObjectId;if(n)if(s.has(e)){if(s.delete(e),i===e){const o=Array.from(s);i=o.length>0?o[o.length-1]:null}}else s.add(e),i=e;else s.has(e)||s.add(e),i=e;Pe.selection.transformationObjects=s,Pe.activeTransformationObjectId=i,Ge=Array.from(s),it=i}function Ri(e){const t=_n(e,Ze,Z.interval1,Zt,!0);if(xe.forEach(s=>{s.type==="regular"&&t.push({x:s.x,y:s.y,isGridVertex:!1})}),j.forEach(s=>{const i=J(s.id1),o=J(s.id2);if(i&&o&&i.type==="regular"&&o.type==="regular"){const r={x:(i.x+o.x)/2,y:(i.y+o.y)/2,isGridVertex:!1};t.push(r)}}),t.length===0)return null;const n=(s,i)=>(s.x-i.x)**2+(s.y-i.y)**2;return t.reduce((s,i)=>{const o=n(e,s);return n(e,i)<o?i:s})}function Qt(){const e=new Set(xe.map(r=>r.id)),t=new Set,n=[];for(const r of e)if(!t.has(r)){const a=Ws(r),d=new Set(a);n.push(d),a.forEach(l=>t.add(l))}const s=r=>[...r].sort().join(","),i=[],o=new Set;aa.forEach(r=>{const a=s(r);for(let d=0;d<n.length;d++){if(o.has(d))continue;const l=n[d];if(a===s(l)){i.push(l),o.add(d);break}}});for(let r=0;r<n.length;r++)o.has(r)||i.push(n[r]);aa=i}function Wl(e,t,n=!1,s=[],i=1){if(n&&s.length>0&&[...e].some(f=>s.some(u=>u.id===f))&&i>1)return;const a=re.filter(f=>f.vertexIds.every(u=>e.has(u))),d=n?_e:[];af(Le,{allFaces:a,allEdges:j,facesVisible:ns,isDragConfirmed:n,dragPreviewVertices:d,transformIndicatorData:n?et:null,initialDragVertexStates:s,colors:t,initialCoordSystemStates:Nn,interpolationStyle:vo(),getInterpolationStyleById:ni,faceColorMode:At,edgeColorMode:Tt,faceColorExpression:vs,faceColorPolarExpression:Ls,edgeColorExpression:On,edgeWeightExpression:ss,faceVertexWeightExpression:Ms,faceEdgeWeightExpression:Es,angleDisplayMode:nn},Ae,J);const c=j.filter(f=>e.has(f.id1)&&e.has(f.id2));xf(Le,{allEdges:c,selectedEdgeIds:be,hoveredEdgeId:Ut,isDragConfirmed:n,dragPreviewVertices:d,colors:t,edgesVisible:Qi,snappedEdgeIds:Is,currentAltPressed:Dt,interpolationStyle:vo(),getInterpolationStyleById:ni,edgeColorMode:Tt,edgeColorExpression:On,edgeWeightExpression:ss},Ae,J,le),xe.filter(f=>e.has(f.id)).forEach(f=>{let u=f;if(n&&d.length>0){const g=d.find(y=>y&&(y.id===f.id||y.originalId===f.id));g&&(u=g)}let p=!1;Et.has(f.id)&&Et.get(f.id).some(y=>y.copyIndex===void 0)&&(p=!0),Ki(Le,u,{selectedVertexIds:Me,selectedCenterIds:Ge,activeCenterId:it,colors:t,verticesVisible:Zi,isHovered:bn===f.id,isSnapped:p,snappedVertexIds:Et,isDragConfirmed:n,dragPreviewVertices:d,currentAltPressed:Dt},Ae)})}function di(e,t,n,s=!1,i=null){const o=Re(t),r=i||si(e.id),a=hr/ge.scale,d=ur/ge.scale,l=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z?.interval1,c=$e*2/ge.scale,h=$e/ge.scale,f=$e*2/ge.scale,u=$e*2/ge.scale,p=ot&&Ve.length>=1;if(n){const g=[];let y=!1;for(const S of xe)if(S.id!==e.id&&S.type==="regular"&&ie(o,S)<a){y=!0;break}if(!y)for(const S of j){const v=J(S.id1),b=J(S.id2);if(v&&b&&v.type==="regular"&&b.type==="regular"&&gt(o,v,b).distance<d){y=!0;break}}if(p){if(xe.forEach(I=>{if(I.id!==e.id&&I.type==="regular"){const w=ie(o,I);g.push({priority:1,dist:w,pos:I,snapType:"vertex",targetVertex:I})}}),j.forEach(I=>{const w=J(I.id1),L=J(I.id2);w&&L&&w.type==="regular"&&L.type==="regular"&&w.id!==e.id&&L.id!==e.id&&gt(o,w,L).distance<h*1.5&&Sa.forEach(A=>{const R={x:w.x+A*(L.x-w.x),y:w.y+A*(L.y-w.y)},O=ie(o,R);g.push({priority:2,dist:O,pos:R,snapType:"edge_fraction",targetEdge:I,fraction:A})})}),Ze!=="none"&&l){const I=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;I&&_n(o,Ze,I,Zt,!0).forEach(L=>{const P=ie(o,L);g.push({priority:3,dist:P,pos:L,snapType:"grid"})})}const S=r.currentSegmentReferenceA_for_display,v=r.currentSegmentReferenceD,b=new Set([0,...pr.flatMap(I=>[I,-I])]),_=Array.from(b).sort((I,w)=>I-w).map(I=>({factor:I,angle:Tn(r.offsetAngleRad+I*S),turn:ft(I*S)})),C=ie(e,o),E=[];if([0,...jn].forEach(I=>E.push({factor:I,dist:I*v})),v>ue){const I=C/v,w=Math.round(I),L=Math.round(I*2)/2;[w,L].forEach(P=>{P>=0&&!E.some(A=>Math.abs(A.factor-P)<ue)&&E.push({factor:P,dist:P*v})})}if(E.sort((I,w)=>I.dist-w.dist),_.length>0&&E.length>0)for(const I of _)for(const w of E){if(w.dist<ue&&(I.factor!==0||E.length>1))continue;const L={x:e.x+w.dist*Math.cos(I.angle),y:e.y+w.dist*Math.sin(I.angle)},P=ie(o,L);g.push({priority:4,dist:P,pos:L,snapType:"geometric",lengthSnapFactor:w.factor,angleSnapFactor:I.factor,angleTurn:I.turn})}}else if(!y&&Ze!=="none"&&l){const S=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;if(S){const v=_n(o,Ze,S,Zt,!0);if(v.length>0){const b=v.sort((T,_)=>ie(o,T)-ie(o,_))[0];g.push({priority:3,dist:ie(o,b),pos:b,snapType:"grid"})}}}let m=null;if(g.length>0)if(!p)m=g[0];else{let S=!1;for(let v=1;v<=3;v++){let b;v===1?b=c:v===2?b=h:b=f;const T=g.filter(_=>_.priority===v&&_.dist<b);if(T.length>0){m=T.sort((_,C)=>_.dist-C.dist)[0],S=!0;break}}if(!S){const v=g.filter(b=>b.priority===4);if(v.length>0){const b=v.sort((T,_)=>T.dist-_.dist)[0];b.dist<u&&(m=b)}}m||(m=g.sort((v,b)=>v.dist-b.dist)[0])}if(m){const S=Math.atan2(m.pos.y-e.y,m.pos.x-e.x)||0,v=parseFloat(ie(e,m.pos).toFixed(10));let b=null,T=null;if(m.snapType==="grid"&&l){const C=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;if(C){const E=m.pos.x-e.x,M=m.pos.y-e.y,I=C*1e-5;if(Ze==="triangular"){const w=C*Ia,L=M/w,P=Math.round(L),A=P%2!==0?C/2:0,R=(E-A)/C;if(Math.abs(L-P)<I/w&&Math.abs(R-Math.round(R))<I/C){const O=P,$=Math.round(R);b=$*$+$*O+O*O,T=C}}else{const w=E/C,L=M/C;if(Math.abs(w-Math.round(w))<I/C&&Math.abs(L-Math.round(L))<I/C){const P=Math.round(w),A=Math.round(L);b=P*P+A*A,T=C}}}}let _=m.angleTurn!=null?m.angleTurn:ft(S-r.offsetAngleRad);return{x:parseFloat(m.pos.x.toFixed(yl)),y:parseFloat(m.pos.y.toFixed(yl)),angle:S*(180/Math.PI),distance:v,snapped:!0,snapType:m.snapType,targetEdge:m.targetEdge,fraction:m.fraction,targetVertex:m.targetVertex,gridSnapped:m.snapType==="grid",lengthSnapFactor:m.lengthSnapFactor||null,angleSnapFactor:m.angleSnapFactor||null,angleTurn:_,gridToGridSquaredSum:b,gridInterval:T}}const x=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:x*(180/Math.PI),distance:ie(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:ft(x-r.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const g=[];for(const x of xe)if(x.id!==e.id&&x.type==="regular"){const S=ie(o,x);S<a&&g.push({priority:1,dist:S,pos:x,snapType:"vertex",targetVertex:x})}for(const x of j){const S=J(x.id1),v=J(x.id2);if(S&&v&&S.type==="regular"&&v.type==="regular"){const b=gt(o,S,v);b.distance<d&&b.onSegmentStrict&&g.push({priority:2,dist:b.distance,pos:{x:b.x,y:b.y},snapType:"edge",targetEdge:x})}}let y=null;if(g.length>0){y=g.sort((S,v)=>S.priority!==v.priority?S.priority-v.priority:S.dist-v.dist)[0];const x=y.priority===1?c:h;y.dist>x&&(y=null)}if(y){const x=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:x*(180/Math.PI),distance:ie(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:ft(x-r.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const m=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:m*(180/Math.PI),distance:ie(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:ft(m-r.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function Nu(e,t,n){const s=[],i=hr/ge.scale,o=ur/ge.scale;if(xe.forEach(r=>{if(r.id!==e.id&&r.type==="regular"){const a=ie(t,r);a<i&&s.push({priority:1,dist:a,pos:r,snapType:"vertex",targetVertex:r})}}),j.forEach(r=>{if(r.id1===e.id||r.id2===e.id)return;const a=J(r.id1),d=J(r.id2);if(a&&d&&a.type==="regular"&&d.type==="regular"){const l=gt(t,a,d);l.distance<o&&l.onSegmentStrict&&s.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:r})}}),s.length>0){const r=s.sort((a,d)=>a.priority!==d.priority?a.priority-d.priority:a.dist-d.dist)[0];return{pos:r.pos,snapped:!0,snapType:r.snapType,targetEdge:r.targetEdge,targetVertex:r.targetVertex}}return{pos:t,snapped:!1}}function Ou(){we=we.map(e=>e.type==="color"?{...e,value:Wh(e.value)}:e)}function Fu(){U.toolbarButton={id:"toolbar-button",x:ct,y:ct,width:eh,height:th,type:"menuButton"}}function Oc(){const e=Ce.height/je;U.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:Ue,height:e,type:"toolbar"};const t=ct;let n=U.toolbarButton.y+U.toolbarButton.height+nh;U.colorToolButton={id:"color-tool-button",type:"toolButton",x:ct,y:n,width:Ue-2*ct,height:Rt},n+=Rt+t,U.colorModeToolButton={id:"color-mode-tool-button",type:"toolButton",x:ct,y:n,width:Ue-2*ct,height:Rt},n+=Rt+t,U.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:ct,y:n,width:Ue-2*ct,height:Rt},n+=Rt+t,U.transformToolButton={id:"transform-tool-button",type:"toolButton",x:ct,y:n,width:Ue-2*ct,height:Rt},n+=Rt+t,U.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:ct,y:n,width:Ue-2*ct,height:Rt},n+=Rt+t,U.sessionsToolButton={id:"sessions-tool-button",type:"toolButton",x:ct,y:n,width:Ue-2*ct,height:Rt}}function kt(){U.colorSwatches=[],U.colorTargetIcons=[];const e=ys&&vt,t=(()=>{if(!e)return we.map((x,S)=>S);const u=we.length,p=Math.max(0,Math.min(u-1,vt.originalIndex)),g=Math.max(0,Math.min(u-1,vt.previewIndex??p)),y=we.map((x,S)=>S),[m]=y.splice(p,1);return y.splice(g,0,m),y})(),n=oi,s=Hs+wo,i=s-n,o=n*2+i,r=Ue+ct,l=U.colorToolButton.y+Rt/2-n/2+-2;let c=r;U.removeColorButton={id:"remove-color-button",type:"button",x:c+(s-n)/2,y:l,width:n,height:n},c+=s;const h=u=>!u||u.type!=="colormap"?!1:Array.isArray(u.vertices)&&u.vertices.length>1;t.forEach((u,p)=>{const g=we[u],y=h(g),m=y?o:n;U.colorSwatches.push({id:`swatch-${u}`,type:"colorSwatch",x:c+(s-n)/2,y:l,width:m,height:n,index:u,positionIndex:p,item:g}),c+=y?s*2:s}),U.addColorButton={id:"add-color-button",type:"button",x:c+(s-n)/2,y:l,width:n,height:n},Object.entries(Oe).forEach(([u,p])=>{const g=n*.75,y=U.colorSwatches.find(m=>m.index===p);y&&U.colorTargetIcons.push({id:`target-icon-${u}`,type:"colorTargetIcon",target:u,x:y.x+(y.width-g)/2,y:y.y-g-5,width:g,height:g})});const f=[...U.colorSwatches,U.removeColorButton,U.addColorButton,...U.colorTargetIcons].filter(Boolean);if(f.length>0){const u=Math.min(...f.map(m=>m.y)),p=Math.max(...f.map(m=>m.x+m.width)),g=Math.max(...f.map(m=>m.y+m.height)),y=5;U.colorPaletteBounds={x:Ue,y:u-y,width:p-Ue+y,height:g-u+y*2}}else U.colorPaletteBounds=null}function za(){if(U.colorModeIcons=[],!U.colorModeToolButton)return;const e=Ue+ct,t=U.colorModeToolButton.y+Rt/2,n=oi,i=t-n/2+-2,o=Hs+wo,r=o-n,a=n*2+r,d=n*5+r*4,l=(o-n)/2,c=["inherit_vertices","colormap"],h=["inherit_vertices","inherit_edges","colormap_xy"],f=ho(),u=fo(),p=f.length>0,g=u.length>0,y=p?f.includes(Hn)?Hn:f[0]:Tt,m=g?u.includes(Kn)?Kn:u[0]:At,x=f.length>0?f:[y],S=u.length>0?u:[m];U.colorModeExprFields=[];let v=e;const b=(C,E)=>{U.colorModeIcons.push({id:`${C}-color-mode-${E}`,type:"colorModeIcon",group:C,mode:E,x:v+l,y:i,width:n,height:n})},T=(C,E,M,I)=>{U.colorModeExprFields.push({id:`${C}-color-expr-${E}`,type:"colorModeExprField",group:C,mode:E,x:v+o+l,y:i,width:M,height:n,baseWidth:I,stepWidth:o}),v=v+o+l+M+l};c.forEach(C=>{if(b("edge",C),x.includes(C)){const E=ca[C]||a;T("edge",C,E,a)}else v+=o}),h.forEach(C=>{if(b("face",C),S.includes(C)){const E=da[C]||d;T("face",C,E,d)}else v+=o});const _=[...U.colorModeIcons,...U.colorModeExprFields].filter(Boolean);if(_.length>0){const C=Math.min(..._.map(w=>w.y)),E=Math.max(..._.map(w=>w.x+w.width)),M=Math.max(..._.map(w=>w.y+w.height)),I=5;U.colorModePanelBounds={x:Ue,y:C-I,width:E-Ue+I,height:M-C+I*2}}else U.colorModePanelBounds=null}function Ha(){if(U.interpolationIcons=[],!U.interpolationToolButton)return;const e=Ue+ct,t=U.interpolationToolButton.y+Rt/2,n=oi,i=t-n/2+-2,o=Hs+wo;let r=e;U.interpolationIcons.push({id:"interpolation-remove",type:"interpolationRemove",x:r+(o-n)/2,y:i,width:n,height:n}),r+=o,In.forEach(d=>{U.interpolationIcons.push({id:`interpolation-${d.id}`,type:"interpolationStyle",styleId:d.id,x:r+(o-n)/2,y:i,width:n,height:n}),r+=o}),U.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:r+(o-n)/2,y:i,width:n,height:n});const a=U.interpolationIcons.filter(Boolean);if(a.length>0){const d=Math.min(...a.map(f=>f.y)),l=Math.max(...a.map(f=>f.x+f.width)),c=Math.max(...a.map(f=>f.y+f.height)),h=5;U.interpolationPanelBounds={x:Ue,y:d-h,width:l-Ue+h,height:c-d+h*2}}else U.interpolationPanelBounds=null}function Bu(){if(U.displayIcons=[],!U.visibilityToolButton)return;const e=Hs+wo,t=Ue+ct,n=U.visibilityToolButton.y+Rt/2,s=oi,o=n-s/2+-2;let r=t;if(["coords","grid","angles","distances","theme"].forEach(d=>{U.displayIcons.push({id:`display-icon-${d}`,group:d,x:r+(e-s)/2,y:o,width:s,height:s}),r+=e}),U.displayIcons.length>0){const d=U.displayIcons[0],l=U.displayIcons[U.displayIcons.length-1],c=5;U.displayPanelBounds={x:Ue,y:d.y-c,width:l.x+l.width-Ue+c,height:d.height+c*2}}else U.displayPanelBounds=null}function hi(){if(U.sessionIcons=[],!U.sessionsToolButton)return;const e=Ue+ct,t=U.sessionsToolButton.y+Rt/2,n=oi,i=t-n/2+-2,o=Hs+wo;let r=e;U.removeSessionButton={id:"remove-session-button",type:"button",x:r+(o-n)/2,y:i,width:n,height:n},r+=o,Xe.forEach((d,l)=>{U.sessionIcons.push({id:`session-${d.id}`,type:"sessionIcon",x:r+(o-n)/2,y:i,width:n,height:n,index:l,session:d}),r+=o}),U.addSessionButton={id:"add-session-button",type:"button",x:r+(o-n)/2,y:i,width:n,height:n};const a=[...U.sessionIcons,U.removeSessionButton,U.addSessionButton].filter(Boolean);if(a.length>0){const d=Math.min(...a.map(f=>f.y)),l=Math.max(...a.map(f=>f.x+f.width)),c=Math.max(...a.map(f=>f.y+f.height)),h=5;U.sessionsPanelBounds={x:Ue,y:d-h,width:l-Ue+h,height:c-d+h*2}}else U.sessionsPanelBounds=null}function $u(){U.transformIcons=[];const e=Hs,t=e+wo,n=Ue+ct,i=U.transformToolButton.y+Rt/2-e/2,o=[rn,$n,Sn,Qn];let r=n;if(o.forEach(a=>{U.transformIcons.push({id:`transform-icon-${a}`,type:a,x:r+(t-e)/2,y:i,width:e,height:e}),r+=t}),U.transformIcons.length>0){const a=U.transformIcons[0],d=U.transformIcons[U.transformIcons.length-1],l=5;U.transformPanelBounds={x:Ue,y:a.y-l,width:d.x+d.width-Ue+l,height:a.height+l*2}}else U.transformPanelBounds=null}function pa(e){e<0||e>=we.length||we.length<=1||(we.splice(e,1),Bt!==null&&(Bt===e?Bt=Math.min(e,we.length-1):Bt>e&&(Bt-=1)),Object.keys(Oe).forEach(t=>{Oe[t]>e?Oe[t]--:Oe[t]===e&&(Oe[t]=Math.min(e,we.length-1))}),kt())}function Vu(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}we.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(we.push(e),xt&&kt())}function Fc(e,t=[]){const n=J(e);if(!n)return null;for(let s=j.length-1;s>=0;s--){const i=j[s],o=le(i);if(t.includes(o))continue;let r=null;if(i.id1===e?r=i.id2:i.id2===e&&(r=i.id1),r){const a=J(r);if(a){const d=n.x-a.x,l=n.y-a.y;return{p1:a,p2:n,angleRad:Math.atan2(l,d),length:Math.sqrt(d*d+l*l),edgeId:o}}}}return null}function st(){const e=ui();we.length,we[0]?.value,xe.length,_t.push(e),_t.length>Ta&&_t.shift(),ps=[],en()}function Ka(e){const t=U.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!us)return!1;const n=[];U.mainToolbar&&n.push(U.mainToolbar),xt&&U.colorPaletteBounds&&n.push(U.colorPaletteBounds),un&&U.interpolationPanelBounds&&n.push(U.interpolationPanelBounds),Ln&&U.transformPanelBounds&&n.push(U.transformPanelBounds),Mn&&U.displayPanelBounds&&n.push(U.displayPanelBounds),Mt&&U.sessionsPanelBounds&&n.push(U.sessionsPanelBounds),gn&&U.colorModePanelBounds&&n.push(U.colorModePanelBounds);for(const i of n)if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;const s=[];xt&&U.colorPaletteBounds&&s.push(U.colorPaletteBounds),un&&U.interpolationPanelBounds&&s.push(U.interpolationPanelBounds),Ln&&U.transformPanelBounds&&s.push(U.transformPanelBounds),Mn&&U.displayPanelBounds&&s.push(U.displayPanelBounds),Mt&&U.sessionsPanelBounds&&s.push(U.sessionsPanelBounds),gn&&U.colorModePanelBounds&&s.push(U.colorModePanelBounds),s.sort((i,o)=>i.y-o.y);for(let i=0;i<s.length-1;i++){const o=s[i],r=s[i+1],a=o.y+o.height,d=r.y;if(e.y>a&&e.y<d){const l=Ue,c=o.x+o.width-l,h=r.x+r.width-l,f=Math.min(c,h),u=l+f;if(e.x<Ue||e.x>=l&&e.x<=u)return!0}}return!1}function fi(e){xe=JSON.parse(JSON.stringify(e.vertices)),j=JSON.parse(JSON.stringify(e.edges)),re=JSON.parse(JSON.stringify(e.faces||[])),He=JSON.parse(JSON.stringify(e.textElements||[])),Me=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),be=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),me=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),De=JSON.parse(JSON.stringify(e.selectedTextIds||[])),Ge=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),tt=JSON.parse(JSON.stringify(e.activeColorTargets||[])),In=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(wn))],$s=e.activeInterpolationStyleId||In[0]?.id||wn.id,we=e.allColors?JSON.parse(JSON.stringify(e.allColors)):gr.map(n=>typeof n=="string"?{type:"color",value:n}:n),Oe=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[nt]:0,[qe]:1,[at]:2,[qt]:0},Tt=e.edgeColorMode||"colormap",At=e.faceColorMode||"colormap_xy",On=e.edgeColorExpression||"x",vs=e.faceColorExpression||"x",Ls=e.faceColorPolarExpression||"r",!e.edgeWeightExpression||e.edgeWeightExpression==="1/(r+0.001)"?ss="1-r":ss=normalizeEdgeWeightExpression(e.edgeWeightExpression),On=normalizeEdgeColorExpression(e.edgeColorExpression||On||getDefaultExpression(qe)),j.forEach(n=>{n?.weightExpression&&(n.weightExpression=normalizeEdgeWeightExpression(n.weightExpression)),n?.colorExpression&&(n.colorExpression=normalizeEdgeColorExpression(n.colorExpression))}),Ms=e.faceVertexWeightExpression||Ms,Es=e.faceEdgeWeightExpression||Es,j.forEach(n=>{(!n.directionFrom||!n.directionTo)&&(n.directionFrom=n.id1,n.directionTo=n.id2)}),Tt==="fixed"&&(Tt="colormap"),At==="fixed"&&(At="colormap_xy"),At==="colormap_polar"&&(At="colormap_xy",(!e.faceColorExpression||e.faceColorExpression.trim()==="")&&Ls&&(vs=Ls)),re.forEach(n=>{n.colorMode==="fixed"&&(n.colorMode="colormap_xy"),n.colorMode==="colormap_polar"&&(n.colorMode="colormap_xy")}),j.forEach(n=>{n.colorMode==="fixed"&&(n.colorMode="colormap")}),Oe[qt]===void 0&&(Oe[qt]=0),fa(),it=e.activeCenterId!==void 0?e.activeCenterId:null,ot=e.isDrawingMode!==void 0?e.isDrawingMode:!1,It=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,Jt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,Ss=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,wt=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,ts=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,bs=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,co=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,Ht=!1,ze=!1,Pn=!1,Jn=!1,_e=[],ei=null,sn=-1,Te={targetId:null,type:null,count:0,timestamp:0},Ce.style.cursor="crosshair",xt&&kt();const t=ui();_t.length===0&&_t.push(t),en()}function ui(){return{vertices:JSON.parse(JSON.stringify(xe)),edges:JSON.parse(JSON.stringify(j)),faces:JSON.parse(JSON.stringify(re)),textElements:JSON.parse(JSON.stringify(He)),selectedVertexIds:JSON.parse(JSON.stringify(Me)),selectedEdgeIds:JSON.parse(JSON.stringify(be)),selectedFaceIds:JSON.parse(JSON.stringify(me)),selectedTextIds:JSON.parse(JSON.stringify(De)),selectedCenterIds:JSON.parse(JSON.stringify(Ge)),activeColorTargets:JSON.parse(JSON.stringify(tt)),interpolationStyles:JSON.parse(JSON.stringify(In)),activeInterpolationStyleId:$s,colorAssignments:JSON.parse(JSON.stringify(Oe)),edgeColorMode:Tt,faceColorMode:At,edgeColorExpression:On,faceColorExpression:vs,faceColorPolarExpression:Ls,edgeWeightExpression:ss,faceVertexWeightExpression:Ms,faceEdgeWeightExpression:Es,allColors:JSON.parse(JSON.stringify(we)),activeCenterId:it,isDrawingMode:ot,previewLineStartVertexId:It,frozenReference_A_rad:Jt,frozenReference_A_baseRad:Ss,frozenReference_D_du:wt,frozenReference_Origin_Data:ts,frozenReference_D_g2g:bs,deletedFaceIds:new Set(co)}}function Bc(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function Xu(){try{const e=new URLSearchParams(window.location.search);return Bc(e.get("user"))}catch{return""}}function $c(){if(vn)return vn;const e=Xu();if(e){vn=e;try{localStorage.setItem(Gr,vn)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return vn}try{vn=localStorage.getItem(Gr)}catch{vn=null}if(!vn){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}vn=Bc(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(Gr,vn)}catch(s){console.warn("Could not persist user id to localStorage.",s)}}return vn}function Vc(){const e=$c();return`${Ba}.state.v${ji}.${e}`}function Xc(){const e=$c();return`${Ba}.sessions.v${ji}.${e}`}function Yc(){return{vertices:[],edges:[],faces:[],textElements:[],selectedVertexIds:[],selectedEdgeIds:[],selectedFaceIds:[],selectedTextIds:[],selectedCenterIds:[],activeColorTargets:[],interpolationStyles:[JSON.parse(JSON.stringify(wn))],activeInterpolationStyleId:wn.id,colorAssignments:{[nt]:0,[qe]:1,[at]:2,[qt]:0},edgeColorMode:"colormap",faceColorMode:"colormap_xy",edgeColorExpression:"x",faceColorExpression:"x",faceColorPolarExpression:"r",allColors:gr.map(e=>typeof e=="string"?{type:"color",value:e}:e),activeCenterId:null,isDrawingMode:!1,previewLineStartVertexId:null,frozenReference_A_rad:null,frozenReference_A_baseRad:null,frozenReference_D_du:null,frozenReference_Origin_Data:null,frozenReference_D_g2g:null,deletedFaceIds:[]}}function gi(){if(!Xe.length)return;const e=Xe[Nt];e&&(e.state=Ua())}function qa(e,t=""){return{id:$t(),name:t,state:JSON.parse(JSON.stringify(e))}}function Ua(){const e=ui();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function Gc(){if(!window.localStorage)return;const e=Vc(),t={version:ji,savedAt:Date.now(),state:Ua()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}if(Xe.length>0){gi();const n=Xc(),s={version:ji,savedAt:Date.now(),activeSessionIndex:Nt,sessions:Xe.map(i=>({...i,state:JSON.parse(JSON.stringify(i.state))}))};try{localStorage.setItem(n,JSON.stringify(s))}catch(i){console.warn("Could not persist sessions to localStorage.",i)}}}function en(){window.localStorage&&(vi&&clearTimeout(vi),vi=setTimeout(()=>{vi=null,Gc()},300))}function Yu(){if(!window.localStorage)return!1;const e=Vc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(fi(n.state),Qt(),Cc=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function Gu(){if(!window.localStorage)return!1;const e=Xc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!Array.isArray(n.sessions)||n.sessions.length===0?!1:(Xe=n.sessions.map(s=>({id:s.id||$t(),name:s.name||"",state:s.state||Yc()})),Nt=Math.min(Math.max(n.activeSessionIndex||0,0),Xe.length-1),Ot=Nt,_t=[],ps=[],fi(Xe[Nt].state),Qt(),Cc=!0,!0)}catch(t){return console.warn("Could not load sessions from localStorage.",t),!1}}function Wu(){const e=Ua();Xe=[qa(e,"World 1")],Nt=0,Ot=0}function Ks(e){e<0||e>=Xe.length||(gi(),Nt=e,Ot=e,_t=[],ps=[],fi(Xe[Nt].state),Qt(),Mt&&hi(),en())}function zu(){gi();const e=qa(Yc(),`World ${Xe.length+1}`),t=Ot!==null?Ot+1:Xe.length;Xe.splice(t,0,e),Ks(t)}function Hu(){if(!Go||!Go.state)return;gi();const e=qa(Go.state,`World ${Xe.length+1}`),t=Ot!==null?Ot+1:Xe.length;Xe.splice(t,0,e),Ks(t)}function Wc(e){if(e<0||e>=Xe.length||(gi(),Xe.length===1))return;const t=e<Xe.length-1?e:e-1,[n]=Xe.splice(e,1);or.push({session:n,index:e}),Nt===e?(Nt=-1,Ot=-1,Ks(Math.max(0,Math.min(t,Xe.length-1)))):(Nt>e&&(Nt-=1),Ot>e&&(Ot-=1),Mt&&hi(),en())}function Ku(){if(!or.length)return!1;const{session:e,index:t}=or.pop(),n=Math.max(0,Math.min(t,Xe.length));return Xe.splice(n,0,e),Ks(n),!0}function qu(){if(!Xe.length)return;const e=(Ot+1)%Xe.length;Ks(e)}function Uu(){if(!Xe.length)return;const e=(Ot-1+Xe.length)%Xe.length;Ks(e)}function ar(){re.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=re.map(t=>{const n=t.vertexIds.map(s=>J(s));return n.some(s=>!s)?null:{face:t,vertices:n,area:Math.abs(xr(n))}}).filter(Boolean);e.forEach(t=>{let n=null,s=1/0;e.forEach(i=>{if(t.face.id===i.face.id||i.area<=t.area)return;const o=t.face.vertexIds,r=o.map(d=>J(d));if(r.some(d=>!d))return;if(Qh(r,i.vertices)){const d=new Set(o),l=j.filter(h=>d.has(h.id1)&&d.has(h.id2));!ef(l,i.vertices,J)&&i.area<s&&(s=i.area,n=i.face)}}),n&&(t.face.parentFaceId=n.id)}),re.forEach(t=>{if(t.parentFaceId){const n=re.find(s=>s.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function Re(e){const t=e.x*je,n=e.y*je,s=Ce.height;return{x:(t-ge.offsetX)/ge.scale,y:(s-n-ge.offsetY)/ge.scale}}function Ae(e){const t=Ce.height,n=e.x*ge.scale+ge.offsetX,s=t-(e.y*ge.scale+ge.offsetY);return{x:n/je,y:s/je}}function J(e){return xe.find(t=>t.id===e)}function Ws(e){if(!J(e))return[];const t=new Set,n=[e],s=[];for(t.add(e);n.length>0;){const i=n.shift();s.push(i),hn(i,j).forEach(o=>{t.has(o)||(t.add(o),n.push(o))})}return s}function Mo(e){const t=Re(e),n=$e*2/ge.scale,s=(dr+$e)/ge.scale;for(let i=xe.length-1;i>=0;i--){const o=xe[i];if(o.type!=="regular"&&ie(t,o)<s)return o}for(let i=xe.length-1;i>=0;i--){const o=xe[i];if(o.type==="regular"&&ie(t,o)<n)return o}return null}function Eo(e){const t=Re(e),n=ur/ge.scale;for(let s=j.length-1;s>=0;s--){const i=j[s],o=J(i.id1),r=J(i.id2);if(o&&r&&o.type==="regular"&&r.type==="regular"){const a=gt(t,o,r);if(a.distance<n&&a.onSegmentStrict)return i}}return null}function To(e){const t=Re(e),n=[];for(const o of re){if(o.color==="transparent")continue;const r=o.vertexIds.map(a=>J(a)).filter(a=>a&&a.type==="regular");r.length<3||Fs(t,r)&&n.push(o)}if(n.length===0)return null;let s=null,i=1/0;for(const o of n){let r=!1;if(o.childFaceIds&&o.childFaceIds.length>0)for(const a of o.childFaceIds){const d=re.find(l=>l.id===a);if(d&&d.color==="transparent"){const l=d.vertexIds.map(c=>J(c)).filter(Boolean);if(l.length>=3&&Fs(t,l)){r=!0;break}}}if(!r){const a=o.vertexIds.map(d=>J(d));if(a.every(Boolean)){const d=Math.abs(xr(a));d<i&&(i=d,s=o)}}}return s}function ya(e){return j.filter(t=>t.id1===e||t.id2===e)}function ju(){Me.length===0&&be.length===0&&Ge.length===0||(st(),zc(),pi())}function zc(){const e=new Set(Me);it&&e.add(it);const t=[];me.length>0&&me.forEach(o=>{const r=re.find(a=>pe(a)===o);r&&(t.push(r),r.vertexIds.forEach(a=>e.add(a)))}),be.forEach(o=>{const[r,a]=o.split(go);e.add(r),e.add(a)}),zt.vertices=Array.from(e).map(o=>{const r=J(o);return r?{...r}:null}).filter(o=>o),zt.edges=[],j.forEach(o=>{e.has(o.id1)&&e.has(o.id2)&&zt.edges.push({...o})}),zt.faces=t.map(o=>JSON.parse(JSON.stringify(o)));const n=new Set(De),s=new Set(me),i=new Set(be);zt.texts=He.filter(o=>{if(n.has(o.id))return!0;if(o.anchorType==="vertex")return e.has(o.anchorId);if(o.anchorType==="edge"){if(i.has(o.anchorId))return!0;const r=j.find(a=>le(a)===o.anchorId);return r?e.has(r.id1)&&e.has(r.id2):!1}if(o.anchorType==="face"){if(s.has(o.anchorId))return!0;const r=re.find(a=>pe(a)===o.anchorId);return r?r.vertexIds.every(a=>e.has(a)):!1}return!1}).map(o=>JSON.parse(JSON.stringify(o))),zt.referenceVertex=Re(oe)}function Ju(){if(zt.vertices.length===0||!zt.referenceVertex)return;st();const e=Re(oe),t=e.x-zt.referenceVertex.x,n=e.y-zt.referenceVertex.y,s=new Map,i=[];let o=null;Ts(),zt.vertices.forEach(d=>{const l=$t(),c={...d,id:l,x:d.x+t,y:d.y+n};xe.push(c),s.set(d.id,l),c.type==="regular"?i.push(l):o=l}),zt.edges.forEach(d=>{const l=s.get(d.id1),c=s.get(d.id2);l&&c&&j.push({...d,id1:l,id2:c})});const r=[];zt.faces.forEach(d=>{const l=d.vertexIds.map(c=>s.get(c)).filter(Boolean);if(l.length===d.vertexIds.length){const c={...d,id:pe({vertexIds:l}),vertexIds:l};c.localCoordSystem&&(c.localCoordSystem.origin.x+=t,c.localCoordSystem.origin.y+=n,c.localCoordSystem.attachedToVertex&&(c.localCoordSystem.attachedToVertex=s.get(c.localCoordSystem.attachedToVertex)),c.localCoordSystem.attachedToEdge&&(c.localCoordSystem.attachedToEdge.v1=s.get(c.localCoordSystem.attachedToEdge.v1),c.localCoordSystem.attachedToEdge.v2=s.get(c.localCoordSystem.attachedToEdge.v2)),c.localCoordSystem.rotationAlignedToEdge&&(c.localCoordSystem.rotationAlignedToEdge.v1=s.get(c.localCoordSystem.rotationAlignedToEdge.v1),c.localCoordSystem.rotationAlignedToEdge.v2=s.get(c.localCoordSystem.rotationAlignedToEdge.v2)),c.localCoordSystem.scaleAttachedToEdge&&(c.localCoordSystem.scaleAttachedToEdge.v1=s.get(c.localCoordSystem.scaleAttachedToEdge.v1),c.localCoordSystem.scaleAttachedToEdge.v2=s.get(c.localCoordSystem.scaleAttachedToEdge.v2))),c.parentFaceId=null,c.childFaceIds=[],re.push(c),r.push(c.id)}}),Cs();const a=[];zt.texts.forEach(d=>{const l=JSON.parse(JSON.stringify(d));if(l.id=$t(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const c=s.get(l.anchorId);if(!c)return;l.anchorId=c}else if(l.anchorType==="edge"){const c=j.find(u=>le(u)===l.anchorId);if(!c)return;const h=s.get(c.id1),f=s.get(c.id2);if(!h||!f)return;l.anchorId=le({id1:h,id2:f})}else if(l.anchorType==="face"){const c=re.find(f=>pe(f)===l.anchorId);if(!c)return;const h=c.vertexIds.map(f=>s.get(f));if(!h.every(Boolean))return;l.anchorId=pe({vertexIds:h})}He.push(l),a.push(l.id)}),Me=i,be=zt.edges.map(d=>le({id1:s.get(d.id1),id2:s.get(d.id2)})),me=r,De=a,it=o,Qt()}function pi(){const e=new Set(Me),t=new Set(Ge),n=new Set(be),s=new Set(me),i=new Set(De);if(e.size===0&&t.size===0&&n.size===0&&s.size===0&&i.size===0)return;if(st(),s.size>0){const l=new Set;re.forEach(c=>{const h=c.id||pe(c);s.has(h)&&(co.add(h),c.childFaceIds&&c.childFaceIds.length>0&&c.childFaceIds.forEach(f=>{const u=re.find(p=>p.id===f);u&&(u.parentFaceId=null)}),c.parentFaceId?c.color="transparent":l.add(h))}),l.size>0&&(re=re.filter(c=>!l.has(c.id||pe(c))))}const o=[...j];if(n.size>0&&(j=j.filter(l=>!n.has(le(l)))),e.size>0){const l=JSON.parse(JSON.stringify(j)),c=[],h=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1,f=new Set(e);for(;f.size>0;){const u=f.values().next().value,p=new Set,g=[u];for(;g.length>0;){const S=g.shift();f.has(S)&&(p.add(S),f.delete(S),hn(S,j).forEach(b=>{f.has(b)&&g.push(b)}))}const y=j.filter(S=>p.has(S.id1)&&!p.has(S.id2)||p.has(S.id2)&&!p.has(S.id1)),m=new Set;y.forEach(S=>{p.has(S.id1)||m.add(S.id1),p.has(S.id2)||m.add(S.id2)});const x=Array.from(m);if(x.length===2){const[S,v]=x,b=J(S),T=J(v),_=j.some(C=>C.id1===S&&C.id2===v||C.id1===v&&C.id2===S);if(b&&T&&!_){const C=Bs(b,T,h,Je);is(C,Tt),Gs(C),c.push(C)}}}xe=xe.filter(u=>!e.has(u.id)),j=j.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),c.length>0&&(j.push(...c),zs(l,j),Cs())}zs(o,j),t.size>0&&(xe=xe.filter(l=>!t.has(l.id))),i.size>0&&(He=He.filter(l=>!i.has(l.id)));const r=new Set(xe.map(l=>l.id)),a=new Set(j.map(l=>le(l))),d=new Set(re.map(l=>pe(l)));He=He.filter(l=>l.anchorType==="vertex"?r.has(l.anchorId):l.anchorType==="edge"?a.has(l.anchorId):l.anchorType==="face"?d.has(l.anchorId):!0),De=De.filter(l=>He.some(c=>c.id===l)),Ts(),Qt()}function lr(e,t){let n=ge.scale*t;n<dl&&(n=dl),n>hl&&(n=hl);const s=n/ge.scale,i=e.x*je,o=e.y*je;ge.offsetX=i*(1-s)+ge.offsetX*s,ge.offsetY=(Ce.height-o)*(1-s)+ge.offsetY*s,ge.scale=n}function Zu(e){ge.offsetX+=e.x*je,ge.offsetY-=e.y*je}function si(e){let t=0,n,s=Math.PI/2,i=!0;const o=J(e);if(!o)return i=!0,Ze!=="none"&&Z.interval1?n=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1:n=Jr,wt!==null&&(n=wt),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const r=Fc(o.id);return r?(i=!1,t=r.angleRad,n=wt!==null?wt:r.length,Jt!==null?Math.abs(Jt)<ue?s=kr:s=Math.abs(Jt):s=kr):(i=!0,Ze!=="none"&&Z.interval1?n=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1:n=Jr,wt!==null&&(n=wt),t=0,s=kr),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:Jt,displayAngleA_originVertexData_for_A_equals_label:ts,frozen_A_baseRad_to_display:Ss,frozen_D_du_to_display:wt,frozen_D_g2g_to_display:bs}}function zl(e,t,n){if(!e||!t)return null;const s=Math.atan2(t.y-e.y,t.x-e.x),i=ie(e,t);let o=0,r=!0;for(let d=n.length-1;d>=0;d--){const l=n[d];let c=null;if(l.id1===e.id&&J(l.id2)?.type==="regular"?c=l.id2:l.id2===e.id&&J(l.id1)?.type==="regular"&&(c=l.id1),c&&c!==t.id){const h=J(c);if(h){o=Math.atan2(e.y-h.y,e.x-h.x),r=!1;break}}}const a=ft(s-o);return{startVertex:e,endVertex:t,absoluteAngleRad:s,length:i,precedingSegmentAbsoluteAngleRad:o,turnAngleRad:a,isFirstSegmentOfLine:r}}function Hc(e,t){const n=new Set,s=[e],i=new Set([e]);for(;s.length>0;){const o=s.shift(),r=t.find(a=>a.id===o);r&&(r.vertexIds.forEach(a=>n.add(a)),r.childFaceIds&&r.childFaceIds.forEach(a=>{i.has(a)||(i.add(a),s.push(a))}))}return Array.from(n)}function Qu(){const e=Me.filter(i=>{const o=J(i);return o&&o.type==="regular"});if(e.length<2)return;st();const t=JSON.parse(JSON.stringify(j));let n=!1;const s=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;for(let i=0;i<e.length;i++)for(let o=i+1;o<e.length;o++){const r=e[i],a=e[o];if(!j.some(l=>l.id1===r&&l.id2===a||l.id1===a&&l.id2===r)){const l=J(r),c=J(a);if(l&&c){const h=Bs(l,c,s,Je);is(h,Tt),Gs(h),j.push(h),n=!0}}}n&&ns&&(zs(t,j),re.forEach(i=>{i.colorMode=i.colorMode||At,ci(i,i.colorMode)}),Cs()),Qt()}function Yt(e=[],t=[],n=[],s,i,o=!1,r=[]){if(o)Wa(e[0],s,i);else{let a=new Set(Pe.selection.vertices),d=new Set(Pe.selection.edges),l=new Set(Pe.selection.faces),c=new Set(Pe.selection.text);s?(e.forEach(h=>a.add(h)),t.forEach(h=>d.add(h)),n.forEach(h=>l.add(h)),r.forEach(h=>c.add(h))):i?(e.forEach(h=>{a.has(h)?a.delete(h):a.add(h)}),t.forEach(h=>{d.has(h)?d.delete(h):d.add(h)}),n.forEach(h=>{l.has(h)?l.delete(h):l.add(h)}),r.forEach(h=>{c.has(h)?c.delete(h):c.add(h)})):(a=new Set(e),d=new Set(t),l=new Set(n),c=new Set(r)),Pe.selection.vertices=a,Pe.selection.edges=d,Pe.selection.faces=l,Pe.selection.text=c,Me=Array.from(a),be=Array.from(d),me=Array.from(l),De=Array.from(c)}ja(),Pc()}function eg(e,t,n,s,i=0){const o={x:n.x-e.x,y:n.y-e.y},r={x:t.x-e.x,y:t.y-e.y},a=Math.hypot(o.x,o.y),d=Math.hypot(r.x,r.y),l=Math.atan2(o.y,o.x),c=Math.atan2(r.y,r.x);let h=0,f=1,u=!1;if(s===rn)f=1,h=Dl(l,c,i);else if(s===$n)h=0,a>ue&&(f=d/a);else if(s===Sn)h=Dl(l,c,i),a>ue&&(f=d/a);else if(s===Qn&&(u=!0,h=0,a>ue)){const p={x:o.x/a,y:o.y/a};f=(r.x*p.x+r.y*p.y)/a}return{rotation:h,scale:f,directionalScale:u}}function zs(e,t){if(!ns){re=[],co.clear();return}const n=new Set(e.map(g=>le(g))),s=new Set(t.map(g=>le(g))),i=t.filter(g=>!n.has(le(g))),o=e.filter(g=>!s.has(le(g)));if(i.length===0&&o.length===0)return;const r=new Set;i.forEach(g=>{r.add(g.id1),r.add(g.id2)}),o.forEach(g=>{r.add(g.id1),r.add(g.id2)});const a=new Set,d=new Set;for(const g of r)d.has(g)||Ws(g).forEach(m=>{a.add(m),d.add(m)});const l=j.filter(g=>a.has(g.id1)&&a.has(g.id2)),c=re.filter(g=>g.vertexIds.every(y=>a.has(y))),h=Ir(l,J),f=new Set(c.map(g=>g.id));re=re.filter(g=>!f.has(g.id));let u=h;if(h.length>1){const g=h.map(y=>{const m=y.vertexIds.map(x=>J(x));return m.some(x=>!x)?null:{face:y,area:Math.abs(xr(m))}}).filter(Boolean);if(g.length>1){g.sort((x,S)=>S.area-x.area);const y=g[0],m=g.slice(1).reduce((x,S)=>x+S.area,0);Math.abs(y.area-m)<ue&&(u=g.slice(1).map(x=>x.face))}}const p=new Set(i.map(g=>le(g)));u.forEach(g=>{let y=!1;if(i.length>0)for(let m=0;m<g.vertexIds.length;m++){const x=g.vertexIds[m],S=g.vertexIds[(m+1)%g.vertexIds.length],v=le({id1:x,id2:S});if(p.has(v)){y=!0;break}}if(co.has(g.id))if(y)co.delete(g.id);else return;g.colorMode=g.colorMode||At,ci(g,g.colorMode),g.interpolationStyleId||Ru(g),g.parentFaceId=null,g.childFaceIds=[],re.push(g)}),Cs()}function Kc(e,t,n,s){const i=J(e.id1),o=J(e.id2);if(!i||!o)return null;const r=[...j],a={id:$t(),x:t.x,y:t.y,type:"regular",color:s(nt)};xe.push(a),j=j.filter(h=>le(h)!==le(e));const d=Bs(i,a,n,s),l=Bs(a,o,n,s),c=e?.colorMode||Tt;return is(d,c),is(l,c),Gs(d),Gs(l),j.push(d),j.push(l),ns&&zs(r,j),a}function tg(e,t,n,s,i){const o=ut(n,e,s,i,!1,null),r={x:n.x-e.x,y:n.y-e.y},a=2*$e/ge.scale,d=t.filter(c=>c.type==="regular"),l=[];if(d.length>0){const c=xe.filter(f=>f.type==="regular"&&!t.some(u=>u.id===f.id)),h=parseInt(Kt||"1",10)||1;for(let f=1;f<=h;f++)d.forEach(u=>{c.forEach(p=>{const g={x:u.x-e.x,y:u.y-e.y},y={x:p.x-e.x,y:p.y-e.y},m=Math.hypot(g.x,g.y),x=Math.hypot(y.x,y.y);if(m>ue){const S=Math.pow(x/m,1/f);let v=Math.atan2(y.y,y.x)-Math.atan2(g.y,g.x);const T=(v+Math.round((s*f-v)/(2*Math.PI))*(2*Math.PI))/f,_=ut(n,e,T,S,!1,r),C=ie(o,_);l.push({dist:C,rotation:T,scale:S,pos:_})}})})}if(l.length>0){const c=l.sort((h,f)=>h.dist-f.dist)[0];if(c.dist<a)return{...c,snapped:!0,snapType:"merge",snappedScaleValue:c.scale}}if(ke){const c=[],h=[],f=pr.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).sort((x,S)=>Math.abs(ft(s-x))-Math.abs(ft(s-S))),u=jn.filter(x=>x>0).sort((x,S)=>Math.abs(i-x)-Math.abs(i-S)),p=f.slice(0,2),g=u.slice(0,2);p.forEach(x=>{g.forEach(S=>{const v=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI),b=ut(n,e,v,S,!1,r);c.push({dist:ie(o,b),rotation:v,scale:S,pos:b})})});const y=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;if(y){const x=_n(o,Ze,y,Zt,!0),S=Math.hypot(r.x,r.y);x.forEach(v=>{if(S>ue){const b={x:v.x-e.x,y:v.y-e.y},T=Math.hypot(b.x,b.y)/S,_=Math.atan2(b.y,b.x)-Math.atan2(r.y,r.x),C=_+Math.round((s-_)/(2*Math.PI))*(2*Math.PI);h.push({dist:ie(o,v),rotation:C,scale:T,pos:v})}})}const m=[...c,...h].sort((x,S)=>x.dist-S.dist)[0];return{...m,snapped:!0,snapType:"geometric",snappedScaleValue:m.scale}}return{rotation:s,scale:i,pos:o,snapped:!1}}function ng(e,t,n,s,i){const o=parseInt(Kt||"1",10);let r=[];const a=Math.hypot(n.x-e.x,n.y-e.y),d=2*$e/ge.scale,l=t.filter(g=>g.type==="regular"),c=xe.filter(g=>g.type==="regular"&&!t.some(y=>y.id===g.id));if(Array.from({length:o},(g,y)=>y+1).forEach(g=>{l.forEach(y=>{c.forEach(m=>{const x={x:y.x-e.x,y:y.y-e.y},S={x:m.x-e.x,y:m.y-e.y};if(Math.abs(Math.hypot(x.x,x.y)-Math.hypot(S.x,S.y))<ue){let v=Math.atan2(S.y,S.x)-Math.atan2(x.y,x.x);const b=v+Math.round((s*g-v)/(2*Math.PI))*(2*Math.PI);r.push({rotation:b/g,priority:Math.abs(ft(b/g-s)),snapType:"merge"})}})})}),ke){pr.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).forEach(x=>{const S=Math.abs(ft(s-x)),v=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI);r.push({rotation:v,priority:S,snapType:"geometric"})});const y=new Set(t.map(x=>x.id));let m=xe.filter(x=>x.type==="regular"&&!y.has(x.id));if(Z){const x=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;x&&m.push(..._n(i,Ze,x,Zt,!0))}m.forEach(x=>{const S=ie(i,x);if(S<hr/ge.scale){const v=Math.atan2(n.y-e.y,n.x-e.x),b=Math.atan2(x.y-e.y,x.x-e.x),T=ft(b-v),_=T+Math.round((s-T)/(2*Math.PI))*(2*Math.PI);r.push({rotation:_,priority:S/1e3,snapType:"projection",projectionSource:x})}})}if(r.length===0)return{rotation:s,snapped:!1,snapType:null};r.sort((g,y)=>g.priority-y.priority);const f=r[0];if(f.snapType==="merge"){const g=ut(n,e,f.rotation,1,!1,null);if(ie(i,g)>d)return{rotation:s,snapped:!1,snapType:null}}const u=ut(n,e,f.rotation,1,!1,null);let p=null;return f.snapType==="projection"&&(p={x:e.x+a*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation),y:e.y+a*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation)}),{rotation:f.rotation,pos:u,snapped:!0,snapType:f.snapType,projectionSource:f.projectionSource||null,projectionPoint:p}}function sg(e,t,n,s){const i=Re(oe),o=2*$e/ge.scale,r=t.filter(d=>d.type==="regular"),a=[];if(r.length>0){const d=xe.filter(h=>h.type==="regular"&&!t.some(f=>f.id===h.id)),l=o/100,c=parseInt(Kt||"1",10);for(let h=1;h<=c;h++)r.forEach(f=>{d.forEach(u=>{const p={x:f.x-e.x,y:f.y-e.y},g={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(p.x,p.y),m=Math.hypot(g.x,g.y);if(y>ue){const x=Math.atan2(p.y,p.x),S=Math.atan2(g.y,g.y);if(Math.abs(ft(x-S))<l){const v=Math.pow(m/y,1/h),b=ut(n,e,0,v,!1,null);a.push({scale:v,dist:ie(i,b)})}}})})}if(a.length>0){const d=a.sort((l,c)=>l.dist-c.dist)[0];if(d.dist<o){const l=ut(n,e,0,d.scale,!1,null);return{...d,pos:l,snapped:!0,snapType:"merge"}}}if(ke){let d,l,c=1,h=1/0;jn.forEach(g=>{const y=Math.abs(s-g);y<h&&(h=y,c=g)});const f=ut(n,e,0,c,!1,null);d={scale:c,pos:f,dist:ie(i,f),snapType:"geometric",snappedScaleValue:c};const u=new Set(t.map(g=>g.id)),p=xe.filter(g=>g.type==="regular"&&!u.has(g.id));if(Z){const g=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;g&&p.push(..._n(i,Ze,g,Zt,!0))}if(p.length>0){const g=p.reduce((x,S)=>ie(i,x)<ie(i,S)?x:S),y=Math.hypot(n.x-e.x,n.y-e.y),m=ie(e,g);if(y>ue){const x=m/y,S=Math.atan2(n.y-e.y,n.x-e.x),v={x:e.x+m*Math.cos(S),y:e.y+m*Math.sin(S)};l={scale:x,pos:v,dist:ie(i,v),snapType:"projection",snappedScaleValue:x,projectionSource:g}}}return l&&ie(i,l.projectionSource)<o?{...l,snapped:!0}:{...d,snapped:!0}}return{scale:s,snapped:!1,snapType:null}}function og(e,t,n,s,i,o){let r=[];const a=2*$e/ge.scale;if(t.filter(l=>l.type==="regular"),ke){let l=null,c=null,h=1,f=1/0;[...jn,...jn.map(m=>-m)].forEach(m=>{const x=Math.abs(s-m);x<f&&(f=x,h=m)});const p=ut(n,e,0,h,!0,i);l={scale:h,pos:p,dist:ie(o,p),snapType:"geometric",snappedScaleValue:h};const g=new Set(t.map(m=>m.id)),y=xe.filter(m=>m.type==="regular"&&!g.has(m.id));if(Z){const m=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;m&&y.push(..._n(o,Ze,m,Zt,!0))}if(y.length>0){const m=y.reduce((S,v)=>ie(o,v)<ie(o,S)?v:S),x=Math.hypot(i.x,i.y);if(x>ue){const S={x:i.x/x,y:i.y/x},v=T=>(T.x-e.x)*S.x+(T.y-e.y)*S.y,b=v(n);if(Math.abs(b)>ue){const _=v(m)/b,C=ut(n,e,0,_,!0,i);c={scale:_,pos:C,dist:ie(o,C),snapType:"projection",snappedScaleValue:_,projectionSource:m}}}}c&&ie(o,c.projectionSource)<a?r.push({...c,priority:0}):r.push({...l,priority:1})}return r.length===0?{scale:s,snapped:!1,snapType:null}:{...r.sort((l,c)=>l.priority-c.priority)[0],snapped:!0}}function ig(e){const t=Ce.width/je,n=Ce.height/je,{grid1Interval:s,grid2Interval:i,alpha1:o,alpha2:r}=sf(ge.scale);Z={interval1:s,interval2:i,alpha1:o,alpha2:r,scale:ge.scale},Zt=of(ge,t,n,Ae),mf(Le,{gridDisplayMode:Ze,canvas:Ce,dpr:je,viewTransform:ge,gridAlpha:xu,colors:e},Ae,Re,Z,Zt);let a={useScientific:!1};return Xs!==yr&&(a=uf(Le,yt,{canvas:Ce,dpr:je,coordsDisplayMode:Xs,viewTransform:ge,angleDisplayMode:nn,colors:e},Ae,Re,Z,Zt,Ct)),a}function rg(e){const t=ze&&ye.length===1&&!et&&ye[0].type==="regular",n=parseInt(Kt||"1",10)||1;if(aa.forEach(s=>{if(!(ze&&ye.length>0&&[...s].some(o=>ye.some(r=>r.id===o)))){Wl(s,e,!1,[],0);return}t||n>1||Wl(s,e,!0,ye,n)}),xe.forEach(s=>{if(s.type!=="regular"){const i=ze&&ye.some(l=>l.id===s.id);let o=s,r=!1,a=i?0:void 0;if(i&&!t&&_e.length>0){const l=_e.find(c=>c&&c.originalId===s.id&&c.transformIndex===0);l&&(o=l)}if(Et){const l=s.originalId||s.id;Et.has(l)&&Et.get(l).find(f=>f.copyIndex===a)&&(r=!0)}const d={selectedVertexIds:[],selectedCenterIds:Ge,activeCenterId:it,colors:e,verticesVisible:!0,isHovered:bn===s.id&&!Dt,isSnapped:r,snappedVertexIds:Et,isDragConfirmed:ze,dragPreviewVertices:_e,currentAltPressed:Dt};Ki(Le,o,d,Ae)}}),ze){const s={copyCount:n,isDragConfirmed:ze,initialDragVertexStates:ye,dragPreviewVertices:_e,transformIndicatorData:et,allEdges:j,allFaces:re,findVertexById:J,findNeighbors:i=>findNeighbors(i),findAllVerticesInSubgraph:i=>Ws(i),colors:e,edgeColorMode:Tt,faceColorMode:At,edgeColorExpression:On,faceColorExpression:vs,faceColorPolarExpression:Ls,edgeWeightExpression:ss,faceVertexWeightExpression:Ms,faceEdgeWeightExpression:Es,angleDisplayMode:nn,initialCoordSystemStates:Nn,getInterpolationStyleById:ni,snappedEdgesInfo:Is,snappedVertexIds:Et};t?cf(Le,s,Ae):n>1&&lf(Le,s,Ae)}}function ag(e,t){Rf(yt,{coordsDisplayMode:Xs,isMouseOverCanvas:Qo,currentShiftPressed:ke,ghostVertexPosition:Ke,gridDisplayMode:Ze,lastGridState:Z,angleDisplayMode:nn,canvas:Ce,dpr:je,mousePos:oe,colors:e,useScientific:t.useScientific},Re,Ct),Pu();const n={dpr:je,canvasUI:U,isToolbarExpanded:us,isColorPaletteExpanded:xt,isColorModePanelExpanded:gn,isInterpolationPanelExpanded:un,isTransformPanelExpanded:Ln,isDisplayPanelExpanded:Mn,isVisibilityPanelExpanded:vr,isSessionsPanelExpanded:Mt,isPlacingTransform:an,placingTransformType:xo,placingSnapPos:li,mousePos:oe,allColors:we,activeThemeName:ti,colors:e,verticesVisible:Zi,edgesVisible:Qi,facesVisible:ns,coordsDisplayMode:Xs,gridDisplayMode:Ze,angleDisplayMode:nn,distanceDisplayMode:Ci,namedColors:ls.namedColors,colorAssignments:Oe,activeColorTargets:tt,lastSelectedSwatchIndex:Bt,interpolationStyles:In,activeInterpolationStyleId:$s,sessions:Xe,activeSessionIndex:Nt,selectedSessionIndex:Ot,edgeColorMode:Tt,faceColorMode:At,edgeColorExpression:On,faceColorExpression:vs,edgeWeightExpression:ss,faceVertexWeightExpression:Ms,faceEdgeWeightExpression:Es,selectedEdgeModes:ho(),selectedFaceModes:fo(),isDraggingColorTarget:lo,draggedColorTargetInfo:Wt};n.selectedInterpolationStyleId=Dc(),Uf(Le,yt,n,Ct)}function qc(){$a.clear();const e=Mr();rf(Le,{canvas:Ce,dpr:je,colors:e}),rg(e),dc(Le,{allFaces:re,hoveredFaceId:Vt,selectedFaceIds:me,colors:e,isDragConfirmed:ze,dragPreviewVertices:_e,currentAltPressed:Dt},Ae,J,pe),me.length>0&&Sc(Le,{allFaces:re,selectedFaceIds:me,colors:e,isDragConfirmed:ze,dragPreviewVertices:_e,initialDragVertexStates:ye,transformIndicatorData:et,highlightedEdgeForSnap:zn,draggedFaceId:ai,coordSystemSnapAngle:mo,coordSystemSnapType:Vs,coordSystemSnapScale:Gn,initialCoordSystemStates:Nn},Ae,J),zg(e),Lu(e),Sf(Le,{altHoverInfo:dt,colors:e},Ae,J,Ct);const t=ig(e);ag(e,t),_u()}function Uc(){if(!Ve||Ve.length<2)return;const e=Oe[nt];if(e===-1)return;const t=we[e];if(!t||t.type!=="colormap")return;const n=Ve.length;Ve.forEach((s,i)=>{const o=J(s);if(o&&o.type==="regular"){const r=n>1?i/(n-1):.5;o.color=We(t,r)}})}function jc(){if(!Ve||Ve.length<2)return;const e=Oe[qe];if(e===-1)return;const t=we[e];if(!t||t.type!=="colormap")return;const s=Ve.length-1;for(let i=0;i<s;i++){const o=Ve[i],r=Ve[i+1],a=j.find(d=>d.id1===o&&d.id2===r||d.id1===r&&d.id2===o);if(a){const d=i/s,l=(i+1)/s;a.gradientStart=d,a.gradientEnd=l,a.colormapItem=t,delete a.colormapOffset,delete a.color}}}function lg(e,t,n){if(!xt)return!1;const s=U.removeColorButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height){if(we.length>1&&tt.length>0){const o=tt[tt.length-1],r=Oe[o];r>=0&&(st(),pa(r))}else we.length>1&&Bt!==null&&Bt>=0&&Bt<we.length&&(st(),pa(Bt));return!0}const i=U.addColorButton;return i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height?(nr=!1,Yo=null,ls.show(),!0):!1}function ja(){const e=[];return me.length>0&&e.push(at),be.length>0&&e.push(qe),Me.length>0&&e.push(nt),De.length>0&&e.push(qt),e.length>0?(tt=e,Bt=null,xt&&kt(),!0):!1}function Ts(){if(on&&clearTimeout(on),Kt="",on=null,ys&&(we=vt.originalAllColors,Oe=vt.originalAssignments,kt(),_t.length>0&&_t.pop(),ys=!1,vt=null),ot){ot=!1,It=null,Jt=null,Ss=null,wt=null,bs=null,ts=null,pt=[],fn=0,Ve=[],Ji=null,Zo=null;return}an&&(an=!1,xo=null,li=null),Me=[],be=[],me=[],Ge=[],De=[],it=null,tt=[],xt&&kt(),Rn=null,Ht=!1,ze=!1,Pn=!1,tr=!1,fs=!1,Jn=!1,_e=[],ye=[],ei=null,sn=-1,Te={targetId:null,type:null,count:0,timestamp:0},Ce.style.cursor="crosshair",et=null,Ys=[],Ke=null,zn=null,mo=null,ai=null,Vs=null,Rn=null,dt=null}function cg(){if(!ot||!It||pt.length===0)return;st();const e=J(It);if(!e){Ts();return}const t=Fc(e.id);if(!t){Ts();return}const n=t.angleRad;if(pt.length===1)return;const s=pt.length-1,i=(fn-1)%s+1,o=pt[i],r=o.length;let a;if(i===pt.length-1){const m=pt.length>2?1:0;a=pt[m].turn}else a=o.turn;let d,l;if(i===pt.length-1){const m=[pt[0].endVertexColor,pt[1].endVertexColor],x=(fn-1)%m.length;l=m[x];const S=fn%m.length;d=m[S],e.color=l}else d=o.endVertexColor;const c=Tn(n+a),h=e.x+r*Math.cos(c),f=e.y+r*Math.sin(c);let u=null,p=!1;const g=$e*2/ge.scale;for(const m of xe)if(m.type==="regular"&&ie({x:h,y:f},m)<g){u=m,p=!0;break}p||(u={id:$t(),x:h,y:f,type:"regular",color:d},xe.push(u)),j.some(m=>m.id1===e.id&&m.id2===u.id||m.id2===e.id&&m.id1===u.id)||j.push({id1:e.id,id2:u.id,color:Je(qe)}),ns&&(re=Ir(j,J),Cs()),Ve.push(u.id),window.currentDrawingPath=Ve,Uc(),jc(),It=u.id,fn++,fn>=pt.length&&(fn=1),wt=null,bs=null,Jt=null,Ss=null,ts=null}function Jc(){qc(),requestAnimationFrame(Jc)}function dg(e){if(me.length===0)return!1;const t=Po(e,Ce);for(const n of me){const s=re.find(o=>o.id===n);if(!s||!s.localCoordSystem)continue;const i=$h(t,s,Ae);if(i)return os=!0,An=i,ai=s.id,ir=hg(s),i.type==="center"&&(s.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function hg(e){const t=[],n=[],s=[],i=[],o=[];e.vertexIds.forEach(r=>{const a=J(r);a&&a.type==="regular"&&t.push({...a,id:r})});for(let r=0;r<t.length;r++){const a=t[r],d=t[(r+1)%t.length];n.push({x:(a.x+d.x)/2,y:(a.y+d.y)/2,v1:a.id,v2:d.id}),s.push(a.id,d.id),o.push(Math.atan2(d.y-a.y,d.x-a.x))}return re.forEach(r=>{r.id!==e.id&&r.localCoordSystem&&i.push(r.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:s,faceCenters:i,edgeAngles:o}}function ma(e,t){const n=e.vertexIds[t],s=e.vertexIds[(t+1)%e.vertexIds.length],i=J(n),o=J(s);return i&&o?{v1Id:n,v2Id:s,edgeAngle:Math.atan2(o.y-i.y,o.x-i.x)}:null}function fg(e,t){if(e.length===0||t&&t.transformType===rn||!t)return;const i=new Set;e.forEach(r=>{ya(r).forEach(a=>i.add(a))});const o=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;i.forEach(r=>{const a=J(r.id1),d=J(r.id2);if(!a||!d)return;const l=a.x-d.x,c=a.y-d.y,h=l/o,f=c/o,u=1e-5;if(o&&Math.abs(h-Math.round(h))<u&&Math.abs(f-Math.round(f))<u){r.labelMode="exact";const g=Math.round(h),y=Math.round(f);r.exactValue={g2gSquaredSum:g*g+y*y,gridInterval:o}}else r.labelMode="decimal",delete r.exactValue})}function ug(){if(jt){st();let e=re.find(t=>t.id===jt);if(e)e.color=Je(at),ar();else{const n=Ir(j,J).find(s=>s.id===jt);n&&(n.color=Je(at),re.push(n),ar(),Cs())}jt=null}Pt.style.display="none"}function gg(e,t){const n=[],s=t.find(r=>r.id===e);if(!s)return[];const i=[...s.childFaceIds||[]],o=new Set(s.childFaceIds);for(;i.length>0;){const r=i.shift(),a=t.find(d=>d.id===r);a&&(n.push(a),a.childFaceIds&&a.childFaceIds.forEach(d=>{o.has(d)||(o.add(d),i.push(d))}))}return n}function pg(e,t,n,s,i){if(!t.isCustom){const l=e.vertexIds.map(c=>s.find(h=>h.id===c)||i(c)).filter(c=>c&&c.type==="regular");if(l.length>=3){const c=Sr(l);c&&(e.localCoordSystem.origin=c.center,e.localCoordSystem.scale=c.radius)}return}let o={...t.origin},r=t.angle,a=t.scale;if(e.localCoordSystem.attachedToVertex){const l=s.find(c=>c.id===e.localCoordSystem.attachedToVertex);l&&(o={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.attachedToEdge.v1)||i(e.localCoordSystem.attachedToEdge.v1),c=s.find(h=>h.id===e.localCoordSystem.attachedToEdge.v2)||i(e.localCoordSystem.attachedToEdge.v2);l&&c&&(o={x:l.x+e.localCoordSystem.attachedToEdge.t*(c.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(c.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v1)||i(e.localCoordSystem.rotationAlignedToEdge.v1),c=s.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v2)||i(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&c){const h=Math.atan2(c.y-l.y,c.x-l.x),f=e.localCoordSystem.rotationAlignedToEdge.originalAngle,p=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-f;r=Tn(h+p),e.localCoordSystem.rotationAlignedToEdge.originalAngle=h,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=r}}if(e.localCoordSystem.scaleAttachedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v1)||i(e.localCoordSystem.scaleAttachedToEdge.v1),c=s.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v2)||i(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&c){const h=ie(l,c);a=h*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=h}}const d=e.vertexIds.map(l=>s.find(c=>c.id===l)||i(l)).filter(l=>l&&l.type==="regular");d.length>=3&&(e.localCoordSystem.origin=yo(o,d),e.localCoordSystem.angle=r,e.localCoordSystem.scale=Math.max(.01,a),e.localCoordSystem.isCustom=!0)}function yg(e,t){const n=new Map;return e.forEach(s=>{const i=[...new Set(s.vertexIds.map(o=>t(o)))];if(i.length>=3){const o=pe({vertexIds:i});if(s.localCoordSystem&&s.localCoordSystem.isCustom){const r=JSON.parse(JSON.stringify(s.localCoordSystem));r.attachedToVertex&&(r.attachedToVertex=t(r.attachedToVertex)),r.attachedToEdge&&(r.attachedToEdge.v1=t(r.attachedToEdge.v1),r.attachedToEdge.v2=t(r.attachedToEdge.v2)),r.rotationAlignedToEdge&&(r.rotationAlignedToEdge.v1=t(r.rotationAlignedToEdge.v1),r.rotationAlignedToEdge.v2=t(r.rotationAlignedToEdge.v2)),r.scaleAttachedToEdge&&(r.scaleAttachedToEdge.v1=t(r.scaleAttachedToEdge.v1),r.scaleAttachedToEdge.v2=t(r.scaleAttachedToEdge.v2)),n.set(o,r)}}}),n}function mg(e){Pt.innerHTML="",Pt.style.display="none",oe=Po(e,Ce);const t=Mo(oe),n=t?null:Eo(oe),s=!t&&!n?To(oe):null;if(t||n||s){let c=!1;t?c=Me.includes(t.id):n?c=be.includes(le(n)):s&&(c=me.includes(pe(s))),c||(Me=[],be=[],me=[],Ge=[],De=[],t?Me=[t.id]:n?be=[le(n)]:s&&(me=[pe(s)]))}else Ts();const o=Re(oe);let r=[];jt=null,io=null,oo=null;const a=(Me.length>0?1:0)+(be.length>0?1:0)+(me.length>0?1:0),d=Mo(oe),l=d?null:Eo(oe);if(d&&d.type==="regular"){oo=d.id;const c=a>1?"Remove Geometry":"Remove Vertex";r.push({text:c,handler:Ag})}else if(l){io=le(l);const c=a>1?"Remove Geometry":"Remove Edge";r.push({text:c,handler:_g})}else{const c=To(oe);if(c){jt=pe(c);const h=a>1?"Remove Geometry":"Remove Face";r.push({text:h,handler:Dg}),c.childFaceIds&&c.childFaceIds.length>0&&r.push({text:"Remove Face and Children",handler:Pg})}else{const h=Ir(j,J);let f=null,u=1/0;h.forEach(p=>{const g=p.vertexIds.map(y=>J(y));if(g.every(Boolean)&&Fs(o,g)){const y=Math.abs(xr(g));y<u&&(u=y,f=p)}}),f&&(jt=f.id||pe(f),r.push({text:"Add Face",handler:ug}))}}if(r.length>0){const c=document.createElement("ul");r.forEach(h=>{const f=document.createElement("li");f.textContent=h.text,f.addEventListener("click",h.handler),c.appendChild(f)}),Pt.appendChild(c),Pt.style.left=`${e.clientX-cl}px`,Pt.style.top=`${e.clientY-cl}px`,Pt.style.display="block"}}function xg(e){if(Mn){for(const t of U.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[yr,Ca,zo,mr];Xs=n[(n.indexOf(Xs)+1)%n.length];break;case"grid":const s=[wa,Pa,Aa,_a,ii];Ze=s[(s.indexOf(Ze)+1)%s.length];break;case"angles":const i=[Os,ri,Ho];nn=i[(i.indexOf(nn)+1)%i.length],as=nn!==Ho;break;case"distances":const o=[Ko,Th];Ci=o[(o.indexOf(Ci)+1)%o.length],Vn=Ci===Ko;break;case"theme":Eg();break}return!0}}return!1}function Sg(e){if(!un)return!1;for(const t of U.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationRemove"){const n=be.length>0||me.length>0||Me.length>0;n&&ku();const s=Dc()||$s;return s&&s!==wn.id?(In=In.filter(i=>i.id!==s),$s===s&&ki(wn.id),Ha(),en()):n||ki(wn.id),!0}if(t.type==="interpolationAdd")return so?.initialize?.(),so?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(Mi.id===t.styleId&&n-Mi.timestamp<Oi){const i=ni(t.styleId);return i&&(so?.initialize?.(),so?.show(i)),Mi={id:null,timestamp:0},!0}return Mi={id:t.styleId,timestamp:n},(be.length>0||me.length>0||Me.length>0)&&Du(t.styleId),ki(t.styleId),!0}}return!1}function Ig(e){if(!gn)return!1;for(const t of U.colorModeIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.group==="edge"){const n=So();n.length>0?(Tu(t.mode,n),Hn=t.mode):(Tt=t.mode,fa())}else if(t.group==="face"){const n=Io();n.length>0?(Cu(t.mode,n),Kn=t.mode):(At=t.mode,fa()),Cs()}return kt(),za(),en(),!0}return!1}function bg(e,t=!1,n=!1){const s=U.toolbarButton;if(e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return us=!us,us?Oc():(xt=!1,gn=!1,un=!1,Ln=!1,Mn=!1,vr=!1,Mt=!1,tt=[]),!0;if(us){const i=U.colorToolButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return wg(),!0;const o=U.colorModeToolButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return gn=!gn,gn&&za(),!0;const r=U.interpolationToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return un=!un,un&&Ha(),!0;const a=U.transformToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return Ln=!Ln,Ln&&$u(),!0;const d=U.visibilityToolButton;if(d&&e.x>=d.x&&e.x<=d.x+d.width&&e.y>=d.y&&e.y<=d.y+d.height)return Mn=!Mn,Mn&&Bu(),!0;const l=U.sessionsToolButton;if(l&&e.x>=l.x&&e.x<=l.x+l.width&&e.y>=l.y&&e.y<=l.y+l.height)return Mt=!Mt,Mt&&(Ot=Nt,hi()),!0}if(xt&&lg(e)||gn&&Ig(e)||un&&Sg(e))return!0;if(Ln){for(const i of U.transformIcons)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return an?xo=i.type:(an=!0,xo=i.type,Ce.style.cursor="none"),!0}if(Mn&&xg(e))return!0;if(Mt&&U.sessionsPanelBounds){const i=U.sessionsPanelBounds;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return qu(),!0}return!!Ka(e)}function vg(){if(_t.length===0)return;const e=ui();we.length,we[0]?.value,xe.length,ps.push(e),ps.length>Ta&&ps.shift();const t=_t.pop();fi(t),we.length,we[0]?.value,xe.length,Qt()}function Mg(){if(ps.length===0)return;const e=ui();_t.push(e),_t.length>Ta&&_t.shift();const t=ps.pop();fi(t),Qt()}function Ja(e,t){const n=Re(e),s=Mo(e),i=s?null:Eo(e),o=!s&&!i?To(e):null;if(s)dt={point:{x:s.x,y:s.y},element:{type:"vertex",id:s.id},shiftKey:t};else if(i){const r=J(i.id1),a=J(i.id2);if(r&&a){let d,l;const c=gt(n,r,a);if(t){const h=ic(c,r,a);d=h.point,l=h.fraction}else d={x:c.x,y:c.y},l=c.t;dt={point:d,element:{type:"edge",edge:i},shiftKey:t,fraction:l}}}else o?dt={point:n,element:{type:"face",id:pe(o)},shiftKey:t}:dt=null;bn=null,Ut=null,Vt=null}function Eg(){st(),ti=ti==="dark"?"light":"dark",Ou(),xt&&kt()}function Tg(e){if(!os||!An)return!1;const t=Po(e,Ce),n=Re(t),s=An,i=s.face,o=i.localCoordSystem,r=i.vertexIds.map(a=>J(a)).filter(a=>a&&a.type==="regular"&&a.x!==void 0&&a.y!==void 0);if(s.type==="center"){let a,d={snapped:!1};if(e.shiftKey){if(d=Gh(n,ir,Ze,Z,Zt),d.snapped){if(a=d.snapPoint,d.snapType==="edge"){const l=d.edgeInfo,c=J(l.v1),h=J(l.v2);c&&h&&(a=d.snapPoint,Rn=null)}}else{const l=Sr(r);a=l?l.center:r[0]}s.type==="center"&&(Ke=a)}else a=n,Ke=null,Rn=null;r.length>0&&r.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(a=yo(a,r),Ke&&(Ke=yo(Ke,r))),o.origin.x=a.x,o.origin.y=a.y,o.isCustom=!0,d.snapped?(o.attachedToVertex=d.vertexId||null,o.attachedToEdge=d.edgeInfo||null):(o.attachedToVertex=null,o.attachedToEdge=null)}else if(s.type==="x_axis"||s.type==="y_axis"){const a={x:n.x-o.origin.x,y:n.y-o.origin.y};let d=Math.atan2(a.y,a.x),l=Math.hypot(a.x,a.y);if(zn=null,mo=null,Vs=null,Ys=[],Ke=null,Rn=null,Gn=null,e.shiftKey){const c=Xh(n,o.origin,!0,ir);if(c.snapped){d=c.angle,mo=d,Vs=c.snapType;const h={x:Math.cos(d),y:Math.sin(d)},f={x:n.x-o.origin.x,y:n.y-o.origin.y},u=f.x*h.x+f.y*h.y;if(c.snapType==="vertex_direction"){const p=J(c.targetVertexId);p&&(l=ie(o.origin,p),Gn=l)}else if(c.edgeIndex!==null){zn=c.edgeIndex;const p=ma(i,c.edgeIndex);if(p){const g=Math.abs(ft(d-p.edgeAngle))>Math.PI/4&&Math.abs(ft(d-p.edgeAngle))<3*Math.PI/4;if(s.type==="x_axis"&&g){const y=J(p.v1Id),m=J(p.v2Id);if(y&&m){const x=sc(o.origin,y,m),S=x.distance,v=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};v.forEach(_=>{const C=S*_,E=Math.abs(u-C);E<b.dist&&(b={scale:C,dist:E,fraction:_})});const T=15/ge.scale;b.dist<T?(l=b.scale,Gn=l,Rn={orthogonalDistanceFraction:b.fraction,v1:y,v2:m,snapPosition:{origin:o.origin,closest:x}}):(l=u>0?u:0,Gn=l)}}else{const y=Yh(o.origin,s.type==="y_axis"?d-Math.PI/2:d,{alignedEdgeInfo:p},i,J,u,ge,s.type);if(y.snapped){if(l=y.scale,Gn=l,y.edgeFraction!==null){const m={x:o.origin.x+l*Math.cos((s.type==="y_axis",d)),y:o.origin.y+l*Math.sin((s.type==="y_axis",d))};Rn={edgeFraction:y.edgeFraction,v1:J(p.v1Id),v2:J(p.v2Id),snapPosition:m}}}else l=u>0?u:0}}}}else l=Math.hypot(a.x,a.y)}s.type==="y_axis"?o.angle=d-Math.PI/2:o.angle=d,l>.01&&(o.scale=l),o.isCustom=!0}return!0}function Cg(){if(os){const e=An,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const s=Ld;let i=null,o=null,r=1/0,a={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(d=>{const l=J(d);if(l&&l.type==="regular"){const c=ie(n.origin,l);c<r&&(r=c,c<s&&(i=d))}}),!i){for(let d=0;d<t.vertexIds.length;d++){const l=J(t.vertexIds[d]),c=J(t.vertexIds[(d+1)%t.vertexIds.length]);if(l&&c&&l.type==="regular"&&c.type==="regular"){const h=gt(n.origin,l,c);h.distance<a.dist&&(a={dist:h.distance,t:h.t,v1:l.id,v2:c.id})}}if(a.dist<s){const d=ie(J(a.v1),J(a.v2));d>ue&&(o={v1:a.v1,v2:a.v2,t:a.t,originalLength:d,scaleRatio:n.scale/d})}}n.attachedToVertex=i,n.attachedToEdge=o}if(e.type==="x_axis"||e.type==="y_axis"){let s=!1,i=!1;if(Vs==="edge"&&zn!==null){const o=ma(t,zn);o&&(n.rotationAlignedToEdge={v1:o.v1Id,v2:o.v2Id,originalAngle:o.edgeAngle,originalSystemAngle:n.angle},s=!0)}if(Gn!==null&&n.rotationAlignedToEdge){const o=ma(t,zn);if(o){const r=J(o.v1Id),a=J(o.v2Id);if(r&&a){const d=ie(r,a);d>ue&&(n.scaleAttachedToEdge={v1:o.v1Id,v2:o.v2Id,scaleRatio:n.scale/d,originalLength:d},i=!0)}}}s||(n.rotationAlignedToEdge=null),i||(n.scaleAttachedToEdge=null)}return Gn=null,Rn=null,os=!1,An=null,ir=null,zn=null,mo=null,Vs=null,ai=null,Ke=null,Ys=[],!0}return!1}function wg(){xt=!xt,xt&&kt()}function Pg(){if(jt){st();const e=re.find(t=>t.id===jt);if(e){const t=gg(e.id,re),n=new Set(t.map(o=>o.id)),s=new Set;t.forEach(o=>{o.vertexIds.forEach(r=>s.add(r))}),xe=xe.filter(o=>!s.has(o.id)),j=j.filter(o=>!s.has(o.id1)&&!s.has(o.id2));const i=new Set([e.id,...n]);re=re.filter(o=>!i.has(o.id)),Ts()}jt=null}Pt.style.display="none"}function Ag(){oo&&(st(),Me.includes(oo)||(be=[],me=[],Ge=[],De=[],Me=[oo]),pi(),oo=null),Pt.style.display="none"}function _g(){io&&(st(),be.includes(io)||(Me=[],me=[],Ge=[],De=[],be=[io]),pi(),io=null),Pt.style.display="none"}function Dg(){jt&&(st(),me.includes(jt)||(Me=[],be=[],Ge=[],De=[],me=[jt]),pi(),jt=null),Pt.style.display="none"}function kg(e){const t=nc(oe,U,{isToolbarExpanded:us,isColorPaletteExpanded:xt,isColorModePanelExpanded:gn,isInterpolationPanelExpanded:un,isTransformPanelExpanded:Ln,isDisplayPanelExpanded:Mn,isVisibilityPanelExpanded:vr,isSessionsPanelExpanded:Mt});if(an&&(!t||t.type!=="transformIcon")){st();const h=Re(oe),f=ke?Ri(h):h,u={id:$t(),x:f.x,y:f.y,type:xo};xe.push(u),Ge=[u.id],it=u.id,Me=[],be=[],me=[],De=[],an=!1,xo=null,li=null,Ce.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!ot){Ja(oe,e.shiftKey);const h=dt&&dt.element.type==="vertex"?J(dt.element.id):null,f=dt&&dt.element.type==="edge"?dt.element.edge:null,u=dt&&dt.element.type==="face"?re.find(p=>pe(p)===dt.element.id):null;if(h||f||u){st(),Me=[],be=[],me=[],Ge=[],De=[],it=null,tt=[],xt&&kt();const p=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z?.interval1;if(h&&h.type==="regular")ot=!0,It=h.id,pt=[],fn=0,Ve=[h.id],window.currentDrawingPath=Ve;else if(f&&dt){let g=dt.point;if(e.shiftKey){const m=J(f.id1),x=J(f.id2);if(m&&x){const S=Re(oe),v=gt(S,m,x);g=ic(v,m,x).point}}const y=Kc(f,g,p,Je);y&&(ot=!0,It=y.id,pt=[],fn=0,Ve=[y.id],window.currentDrawingPath=Ve,Qt())}else if(u&&dt){const g=dt.point;let y=Je(nt);const m=Oe[nt];if(m!==-1){const S=we[m];S&&S.type==="colormap"&&(y=We(S,0))}const x={id:$t(),...g,type:"regular",color:y};xe.push(x),ot=!0,It=x.id,pt=[],fn=0,Ve=[x.id],window.currentDrawingPath=Ve,Qt()}Ht=!1,e.preventDefault();return}}if(Ht=!0,ze=!1,Jn=!1,xt){const h=(U.colorTargetIcons||[]).filter(f=>oe.x>=f.x&&oe.x<=f.x+f.width&&oe.y>=f.y&&oe.y<=f.y+f.height);if(h.length>0){const f=h[h.length-1],{element:u,shiftKey:p,ctrlKey:g}={element:f,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};p?tt.includes(u.target)||tt.push(u.target):g?tt.includes(u.target)?tt=tt.filter(y=>y!==u.target):tt.push(u.target):tt=[u.target],kt(),de={target:"ui_icon_click",element:{...f,type:"colorTargetIcon"}},Ce.style.cursor="default";return}for(const f of U.colorSwatches)if(oe.x>=f.x&&oe.x<=f.x+f.width&&oe.y>=f.y&&oe.y<=f.y+f.height){de={target:"ui_swatch",element:{...f}},Ce.style.cursor="default";return}}if(Mt){const h=U.removeSessionButton;if(h&&oe.x>=h.x&&oe.x<=h.x+h.width&&oe.y>=h.y&&oe.y<=h.y+h.height){de={target:"ui_session_remove"},Ce.style.cursor="default";return}const f=U.addSessionButton;if(f&&oe.x>=f.x&&oe.x<=f.x+f.width&&oe.y>=f.y&&oe.y<=f.y+f.height){de={target:"ui_session_add"},Ce.style.cursor="default";return}for(const u of U.sessionIcons)if(oe.x>=u.x&&oe.x<=u.x+u.width&&oe.y>=u.y&&oe.y<=u.y+u.height){Ot=u.index,Mt&&hi(),de={target:"ui_session",element:{...u}},Ce.style.cursor="default";return}}if(bg(oe,e.shiftKey,e.ctrlKey||e.metaKey)){de=null,Ht=!1,ze=!1,Ce.style.cursor="default";return}if(dg(e)){de={target:"coord_system"};return}const n=Lc(oe);let s=n?null:Mo(oe),i=!n&&!s?Eo(oe):null,o=!n&&!s&&!i?To(oe):null;if(n)mn("entityMouseDown",{type:Ie.TEXT,id:n.id,button:e.button});else if(s){const h=s.type==="regular"?Ie.VERTEX:Ie.TRANSFORMATION_OBJECT;mn("entityMouseDown",{type:h,id:s.id,button:e.button})}else i?mn("entityMouseDown",{type:Ie.EDGE,id:le(i),button:e.button}):o&&mn("entityMouseDown",{type:Ie.FACE,id:pe(o),button:e.button});const r=e.shiftKey||e.ctrlKey||e.metaKey,a=n||s||i||o;let d=!1;n?d=De.includes(n.id):s?d=Me.includes(s.id)||Ge.includes(s.id):i?d=be.includes(le(i)):o&&(d=me.includes(pe(o))),!ot&&!r&&a&&!d&&(n?Yt([],[],[],!1,!1,!1,[n.id]):s?Yt([s.id],[],[],!1,!1,s.type!=="regular"):i?Yt([],[le(i)],[],!1,!1):o&&Yt([],[],[pe(o)],!1,!1));let l=null;if(n)l=Re(oe);else if(s)l=s;else if(i){const h=J(i.id1),f=J(i.id2);l=gt(Re(oe),h,f)}else o&&(l=Re(oe));const c=it&&(Me.length>0||be.length>0||me.length>0||De.length>0);ye=[],_e=[],de={targetVertex:s,dragHandle:l,targetEdge:i,targetFace:o,targetText:n,target:a||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:c},s&&s.type!=="regular"&&(fs=!0,Wa(s.id,e.shiftKey,e.ctrlKey||e.metaKey))}function Rg(){st();const e=[...Me],t=[...be],n=[...me],s=[...Ge],i=it;Me=[],be=[],me=[],Ge=[],De=[],it=null;const o=parseInt(Kt,10)||1;let r=null;const a=ze&&ye.length===1&&de?.finalSnapResult?.snapType==="edge",d=new Set(ro.map(y=>y.id));if(d.size>0){const y=new Map(ro.map(E=>[E.id,E])),m=new Set(e);t.forEach(E=>{const[M,I]=E.split(go);M&&m.add(M),I&&m.add(I)}),n.forEach(E=>{const M=re.find(I=>pe(I)===E);M&&Hc(M.id,re).forEach(w=>m.add(w))});const x=et?null:kc(),{center:S,rotation:v=0,scale:b=1,directionalScale:T=!1,startVector:_}=et||{},C=-v*(180/Math.PI);He.forEach(E=>{if(!d.has(E.id))return;const M=y.get(E.id)||E,I=Oo(M);if(M.anchorType!=="canvas"&&!I)return;const w=M.anchorType==="canvas"?M.position||E.position:I.anchor,L=M.anchorType==="canvas"?{x:0,y:0}:M.offset||{x:0,y:0},P=M.anchorType==="canvas"?M.position||E.position||{x:0,y:0}:{x:w.x+L.x,y:w.y+L.y},A=(()=>{if(M.anchorType==="vertex")return m.has(M.anchorId);if(M.anchorType==="edge"){if(t.includes(M.anchorId))return!0;const R=j.find(O=>le(O)===M.anchorId);return R?m.has(R.id1)&&m.has(R.id2):!1}if(M.anchorType==="face"){if(n.includes(M.anchorId))return!0;const R=re.find(O=>pe(O)===M.anchorId);return R?R.vertexIds.every(O=>m.has(O)):!1}return!1})();if(et){const R=ut(P,S,v,b,T,_);if(E.rotationDeg=(M.rotationDeg||0)+C,E.scale=(M.scale||1)*b,M.anchorType==="canvas")E.position=R;else{const O=A?ut(w,S,v,b,T,_):w,$={x:R.x-O.x,y:R.y-O.y};if(E.offset=$,E.anchorType==="edge"){const F=Di(E.anchorId,$);typeof F=="number"&&(E.edgeOffsetFactor=F)}}}else if(x){if(M.anchorType==="canvas"){const R=M.position||E.position||{x:0,y:0};E.position={x:R.x+x.x,y:R.y+x.y}}else if(!A){const R=M.offset||{x:0,y:0},O={x:R.x+x.x,y:R.y+x.y};if(E.offset=O,E.anchorType==="edge"){const $=Di(E.anchorId,O);typeof $=="number"&&(E.edgeOffsetFactor=$)}}}})}if(a){const y=de.finalSnapResult,m=ye[0].id,x=y.targetEdge,S=J(m);if(S&&x){const v=JSON.parse(JSON.stringify(j)),b=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;S.x=y.pos.x,S.y=y.pos.y,j=j.filter(I=>le(I)!==le(x));const T=J(x.id1),_=J(x.id2),C=Bs(T,S,b,Je),E=Bs(_,S,b,Je),M=x?.colorMode||Tt;is(C,M),is(E,M),Gs(C),Gs(E),j.push(C),j.push(E),zs(v,j)}}else if(et){const{center:y,rotation:m,scale:x,directionalScale:S,startPos:v}=et,b={x:v.x-y.x,y:v.y-y.y},T=na(y,m,x,S,b),_=(E,M)=>Ti(E,T,M),C=(E,M)=>{if(!E)return null;const I=m*M,w=Math.pow(x,M),L=oc(T,M),P=ta(L,E.origin),A=JSON.parse(JSON.stringify(E));if(A.origin=P,S){const R=Cn({x:1,y:0},E),O=ta(L,R);A.scale=Math.max(.01,ie(P,O))}else A.angle=Tn(E.angle+I),A.scale=E.scale*w;return A};if(o>1){const E=ye.filter(D=>D.type==="regular"),M=new Set(E.map(D=>D.id)),I=new Set(me),w=new Set(be);me.forEach(D=>{const N=re.find(k=>pe(k)===D);N&&N.vertexIds.forEach(k=>M.add(k))});const L=new Set;me.forEach(D=>{const N=re.find(k=>pe(k)===D);if(N)for(let k=0;k<N.vertexIds.length;k++){const Y=N.vertexIds[k],X=N.vertexIds[(k+1)%N.vertexIds.length];L.add(le({id1:Y,id2:X}))}});const P=j.filter(D=>{const N=le(D);return w.has(N)||L.has(N)?!0:M.has(D.id1)&&M.has(D.id2)}),A=me.length>0?re.filter(D=>I.has(pe(D))):re.filter(D=>D.vertexIds.every(N=>M.has(N))),R=j.filter(D=>M.has(D.id1)&&!M.has(D.id2)||M.has(D.id2)&&!M.has(D.id1)),O=[],$=[],F=[];r={vertices:[],edges:[],faces:[],texts:[]};const V=new Set(De),B=He.filter(D=>{if(V.has(D.id))return!0;if(D.anchorType==="vertex")return M.has(D.anchorId);if(D.anchorType==="edge"){const N=j.find(k=>le(k)===D.anchorId);return N?M.has(N.id1)&&M.has(N.id2):!1}if(D.anchorType==="face"){if(I.has(D.anchorId))return!0;const N=re.find(k=>pe(k)===D.anchorId);return N?N.vertexIds.every(k=>M.has(k)):!1}return!1});for(let D=1;D<o;D++){const N=new Map,k=[],Y=[],X=[],z=[];E.forEach(G=>{const W=_(G,D),H={...G,...W,id:$t()};O.push(H),N.set(G.id,H.id),k.push(H.id)}),P.forEach(G=>{const W=N.get(G.id1),H=N.get(G.id2);if(W&&H){const q=G.directionFrom===G.id2?H:W,K=G.directionFrom===G.id2?W:H,ne={...G,id1:W,id2:H,directionFrom:q,directionTo:K};$.push(ne),Y.push(le(ne))}}),R.forEach(G=>{const W=M.has(G.id1)?G.id2:G.id1,H=M.has(G.id1)?G.id1:G.id2,q=N.get(H);if(q){const K=q,ne=W,he=G.directionFrom===G.id2?ne:K,ae=G.directionFrom===G.id2?K:ne,se={...G,id1:K,id2:ne,directionFrom:he,directionTo:ae};$.push(se)}}),A.forEach(G=>{const W=Nn.get(G.id)||G.localCoordSystem,H=G.vertexIds.map(q=>N.get(q));if(H.every(Boolean)){const q=JSON.parse(JSON.stringify(G));if(q.id=pe({vertexIds:H}),q.vertexIds=H,q.localCoordSystem&&W){const K=C(W,D);K&&(q.localCoordSystem=K)}F.push(q),X.push(q.id)}}),B.forEach(G=>{const W=JSON.parse(JSON.stringify(G));W.id=$t();const H=-m*(180/Math.PI)*D,q=Math.pow(x,D);if(W.rotationDeg=(G.rotationDeg||0)+H,W.scale=(G.scale||1)*q,G.anchorType==="canvas"){if(!W.position)return;W.position=_(W.position,D)}else if(G.anchorType==="vertex"){const K=N.get(G.anchorId);if(!K)return;const ne=Oo(G),he=ne?ne.anchor:null;if(he){const ae=G.offset||{x:0,y:0},se={x:he.x+ae.x,y:he.y+ae.y},Q=_(he,D),ee=_(se,D);W.offset={x:ee.x-Q.x,y:ee.y-Q.y}}W.anchorId=K}else if(G.anchorType==="edge"){const K=j.find(Q=>le(Q)===G.anchorId);if(!K)return;const ne=N.get(K.id1),he=N.get(K.id2);if(!ne||!he)return;const ae=Oo(G),se=ae?ae.anchor:null;if(se){const Q=G.offset||{x:0,y:0},ee={x:se.x+Q.x,y:se.y+Q.y},te=_(se,D),ce=_(ee,D),fe={x:ce.x-te.x,y:ce.y-te.y};W.offset=fe;const Ee=le({id1:ne,id2:he}),Se=Di(Ee,fe);typeof Se=="number"&&(W.edgeOffsetFactor=Se)}W.anchorId=le({id1:ne,id2:he})}else if(G.anchorType==="face"){const K=re.find(se=>pe(se)===G.anchorId);if(!K)return;const ne=K.vertexIds.map(se=>N.get(se));if(!ne.every(Boolean))return;const he=Oo(G),ae=he?he.anchor:null;if(ae){const se=G.offset||{x:0,y:0},Q={x:ae.x+se.x,y:ae.y+se.y},ee=_(ae,D),te=_(Q,D);W.offset={x:te.x-ee.x,y:te.y-ee.y}}W.anchorId=pe({vertexIds:ne})}He.push(W),V.has(G.id)&&z.push(W.id)}),D===1&&(r={vertices:k,edges:Y,faces:X,texts:z})}xe.push(...O),j.push(...$),re.push(...F)}else ye.forEach(E=>{const M=J(E.id);if(M){const I=_(E,1);M.x=I.x,M.y=I.y}})}else if(_e.length>0){const y=de.finalSnapResult&&de.finalSnapResult.snapped?de.finalSnapResult.finalDelta:{x:_e[0].x-ye[0].x,y:_e[0].y-ye[0].y},m=ye.filter(x=>x.type==="regular");if(o>1&&m.length>0){const x=new Set(m.map(P=>P.id)),S=new Set(me),v=new Set(be);me.forEach(P=>{const A=re.find(R=>pe(R)===P);A&&A.vertexIds.forEach(R=>x.add(R))});const b=new Set;me.forEach(P=>{const A=re.find(R=>pe(R)===P);if(A)for(let R=0;R<A.vertexIds.length;R++){const O=A.vertexIds[R],$=A.vertexIds[(R+1)%A.vertexIds.length];b.add(le({id1:O,id2:$}))}});const T=j.filter(P=>{const A=le(P);return v.has(A)||b.has(A)?!0:x.has(P.id1)&&x.has(P.id2)}),_=me.length>0?re.filter(P=>S.has(pe(P))):re.filter(P=>P.vertexIds.every(A=>x.has(A))),C=j.filter(P=>x.has(P.id1)&&!x.has(P.id2)||x.has(P.id2)&&!x.has(P.id1)),E=[],M=[],I=[];r={vertices:[],edges:[],faces:[],texts:[]};const w=new Set(De),L=He.filter(P=>{if(w.has(P.id))return!0;if(P.anchorType==="vertex")return x.has(P.anchorId);if(P.anchorType==="edge"){const A=j.find(R=>le(R)===P.anchorId);return A?x.has(A.id1)&&x.has(A.id2):!1}if(P.anchorType==="face"){if(S.has(P.anchorId))return!0;const A=re.find(R=>pe(R)===P.anchorId);return A?A.vertexIds.every(R=>x.has(R)):!1}return!1});for(let P=1;P<o;P++){const A=new Map,R=[],O=[],$=[],F=[];m.forEach(V=>{const B={x:V.x+y.x*P,y:V.y+y.y*P},D={...V,...B,id:$t()};E.push(D),A.set(V.id,D.id),R.push(D.id)}),T.forEach(V=>{const B=A.get(V.id1),D=A.get(V.id2);if(B&&D){const N=V.directionFrom===V.id2?D:B,k=V.directionFrom===V.id2?B:D,Y={...V,id1:B,id2:D,directionFrom:N,directionTo:k};M.push(Y),O.push(le(Y))}}),C.forEach(V=>{const B=x.has(V.id1)?V.id2:V.id1,D=x.has(V.id1)?V.id1:V.id2,N=A.get(D);if(N){const k=N,Y=B,X=V.directionFrom===V.id2?Y:k,z=V.directionFrom===V.id2?k:Y,G={...V,id1:k,id2:Y,directionFrom:X,directionTo:z};M.push(G)}}),_.forEach(V=>{const B=Nn.get(V.id),D=V.vertexIds.map(N=>A.get(N));if(D.every(Boolean)){const N=JSON.parse(JSON.stringify(V));if(N.id=pe({vertexIds:D}),N.vertexIds=D,N.localCoordSystem&&B){const k={x:y.x*P,y:y.y*P};N.localCoordSystem.origin.x=B.origin.x+k.x,N.localCoordSystem.origin.y=B.origin.y+k.y}I.push(N),$.push(N.id)}}),L.forEach(V=>{const B=JSON.parse(JSON.stringify(V));if(B.id=$t(),V.anchorType==="canvas"){if(!B.position)return;B.position={x:B.position.x+y.x*P,y:B.position.y+y.y*P}}else if(V.anchorType==="vertex"){const D=A.get(V.anchorId);if(!D)return;B.anchorId=D}else if(V.anchorType==="edge"){const D=j.find(Y=>le(Y)===V.anchorId);if(!D)return;const N=A.get(D.id1),k=A.get(D.id2);if(!N||!k)return;B.anchorId=le({id1:N,id2:k})}else if(V.anchorType==="face"){const D=re.find(k=>pe(k)===V.anchorId);if(!D)return;const N=D.vertexIds.map(k=>A.get(k));if(!N.every(Boolean))return;B.anchorId=pe({vertexIds:N})}He.push(B),w.has(V.id)&&F.push(B.id)}),P===1&&(r={vertices:R,edges:O,faces:$,texts:F})}xe.push(...E),j.push(...M),re.push(...I)}else o===1&&ye.forEach(x=>{const S=J(x.id);S&&(S.x=x.x+y.x,S.y=x.y+y.y)})}const l=new Set(ye.map(y=>y.id)),c=re.filter(y=>y.vertexIds.some(m=>l.has(m)));c.length>0&&c.forEach(y=>{const m=Nn.get(y.id);if(y.localCoordSystem&&m){const x=new Set(y.vertexIds),S=new Set(ye.map(b=>b.id));if([...x].every(b=>S.has(b))){if(et){const{center:b,rotation:T,scale:_,directionalScale:C,startPos:E}=et,M={x:E.x-b.x,y:E.y-b.y},I=ut(m.origin,b,T,_,C,M);if(y.localCoordSystem.origin=I,C){const w=Cn({x:1,y:0},m),L=ut(w,b,T,_,C,M);y.localCoordSystem.scale=ie(I,L)}else y.localCoordSystem.angle=Tn(m.angle+T),y.localCoordSystem.scale=m.scale*_}else if(o===1){const b=de.finalSnapResult&&de.finalSnapResult.snapped?de.finalSnapResult.finalDelta:{x:_e[0].x-ye[0].x,y:_e[0].y-ye[0].y};y.localCoordSystem.origin.x=m.origin.x+b.x,y.localCoordSystem.origin.y=m.origin.y+b.y}}else{const b=y.vertexIds.map(T=>J(T)).filter(Boolean);pg(y,m,ye,b,J)}}}),fg(Array.from(l),et);const{vertexMerges:h,edgeSplits:f}=jg(xe,j,ge),u=new Map;xe.forEach(y=>u.set(y.id,y.id));const p=y=>{if(!u.has(y)||u.get(y)===y)return y;const m=p(u.get(y));return u.set(y,m),m};h.forEach((y,m)=>{const x=p(m),S=p(y);x!==S&&u.set(S,x)});const g=new Set;if(xe.forEach(y=>{const m=p(y.id);y.id!==m&&g.add(y.id)}),g.size>0||f.size>0){const y=JSON.parse(JSON.stringify(j)),m=yg(re,p);j.forEach(x=>{x.id1=p(x.id1),x.id2=p(x.id2)}),xe=xe.filter(x=>!g.has(x.id)),j=j.filter((x,S,v)=>x.id1!==x.id2&&S===v.findIndex(b=>le(b)===le(x))),zs(y,j),re.forEach(x=>{const S=m.get(x.id);S&&(x.localCoordSystem=S)}),Cs()}o>1&&r?(Me=e.length>0?r.vertices.map(y=>p(y)):[],be=t.length>0?r.edges:[],me=n.length>0?r.faces:[],De=ro.length>0?r.texts:[]):o===1&&(Me=e.map(y=>p(y)),be=t,me=n,De=ro.map(y=>y.id).filter(y=>He.some(m=>m.id===y))),Ge=s,it=i,ar(),Qt()}function Lg(e){const{shiftKey:t,ctrlKey:n,targetVertex:s,targetEdge:i,targetFace:o,targetText:r}=e,a=J(It);if(ot&&a){st();const d=JSON.parse(JSON.stringify(j)),l=di(a,oe,t);let c=null;const h=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;if(l.snapType==="vertex"&&l.targetVertex)c=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)c=Kc(l.targetEdge,{x:l.x,y:l.y},h,Je);else{let f=Je(nt);const u=Oe[nt];if(u!==-1){const p=we[u];p&&p.type==="colormap"&&(f=We(p,.5))}c={id:$t(),x:l.x,y:l.y,type:"regular",color:f},xe.push(c)}if(c){if(!j.some(p=>p.id1===a.id&&p.id2===c.id||p.id2===a.id&&p.id1===c.id)){const p=Bs(a,c,h,Je);is(p,Tt),Gs(p),j.push(p),zs(d,j),ar(),re.forEach(g=>{g.colorMode=g.colorMode||At,ci(g,g.colorMode)})}const u=zl(a,c,j);u&&(pt.length>0&&(pt[pt.length-1].turn=u.turnAngleRad),pt.push({length:u.length,turn:0,endVertexColor:c.color}),fn=pt.length-1,ts=u.startVertex,wt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,bs=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Jt=u.turnAngleRad,Ss=u.precedingSegmentAbsoluteAngleRad),Ve.push(c.id),window.currentDrawingPath=Ve,Uc(),jc(),Qt(),It=c.id}if(t&&c&&l){const f=zl(a,c,j);f&&(ts=f.startVertex,wt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):f.length,bs=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Jt=f.turnAngleRad,Ss=f.precedingSegmentAbsoluteAngleRad)}Te.count=0}else if(e.target==="canvas"){st();const d=Ke||Re(oe);let l=Je(nt);const c=Oe[nt];if(c!==-1){const f=we[c];f&&f.type==="colormap"&&(l=We(f,0))}const h={id:$t(),...d,type:"regular",color:l};xe.push(h),ot=!0,It=h.id,pt=[],fn=0,Ve=[h.id],window.currentDrawingPath=Ve,Qt()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(r||s||i||o)){st();const l=r?r.id:o?pe(o):i?le(i):s.id;let c;switch(r?c="text":o?c="face":s&&s.type!=="regular"?c="center":s?c="vertex":i&&(c="edge"),l&&Te.targetId===l&&Date.now()-Te.timestamp<Oi?Te.count++:Te.count=1,Te.targetId=l,Te.type=c,Te.timestamp=Date.now(),Te.count){case 1:Te.type==="text"?Yt([],[],[],t,n,!1,[Te.targetId]):Te.type==="face"?Yt([],[],[Te.targetId],t,n):Te.type==="edge"?Yt([],[Te.targetId],[],t,n):Te.type==="vertex"?Yt([Te.targetId],[],[],t,n):Te.type==="center"&&Wa(Te.targetId,t,n);break;case 2:if(Te.type==="text"){const h=bo(Te.targetId);h&&Nc(h,h.content||"")}else if(Te.type==="vertex"){const h=hn(Te.targetId,j);Yt([Te.targetId,...h],[],[],t,n)}else if(Te.type==="edge"){const h=j.find(f=>le(f)===Te.targetId);if(h){const f=[...ya(h.id1),...ya(h.id2)];Yt([],Array.from(new Set(f.map(u=>le(u)))),[],t,n)}}else if(Te.type==="face"){const h=re.find(f=>pe(f)===Te.targetId);if(h){const f=[],u=new Set;for(let p=0;p<h.vertexIds.length;p++){const g=h.vertexIds[p],y=h.vertexIds[(p+1)%h.vertexIds.length];u.add(le({id1:g,id2:y}))}re.forEach(p=>{if(pe(p)!==pe(h))for(let g=0;g<p.vertexIds.length;g++){const y=p.vertexIds[g],m=p.vertexIds[(g+1)%p.vertexIds.length];if(u.has(le({id1:y,id2:m}))){f.push(pe(p));break}}}),Yt([],[],[pe(h),...f],t,n)}}break;case 3:if(Te.type==="vertex"||Te.type==="edge"||Te.type==="face"){let h;if(Te.type==="vertex")h=Te.targetId;else if(Te.type==="edge")h=Te.targetId.split(go)[0];else if(Te.type==="face"){const f=re.find(u=>pe(u)===Te.targetId);f&&(h=f.vertexIds[0])}if(h){const f=new Set(Ws(h));if(Te.type==="vertex")Yt(Array.from(f),[],[],t,n);else if(Te.type==="edge"){const u=j.filter(p=>f.has(p.id1)&&f.has(p.id2)).map(p=>le(p));Yt([],u,[],t,n)}else if(Te.type==="face"){const u=re.filter(p=>p.vertexIds.every(g=>f.has(g))).map(p=>pe(p));Yt([],[],u,t,n)}}}Te.count=0;break}ja()}}}function Ng(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),s=`icon-${t.target}`;if(Te.targetId===s&&n-Te.timestamp<Oi){switch(st(),t.target){case nt:Zi=!Zi;break;case qe:Qi=!Qi;break;case at:ns=!ns;break}kt(),Te.count=0}Te.targetId=s,Te.timestamp=n,Bt=null;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),s=`swatch-${t.index}`;if(!(Me.length>0||be.length>0||me.length>0||De.length>0)&&tt.length===0?Bt=t.index:Bt=null,Te.targetId===s&&n-Te.timestamp<Oi){nr=!0,Yo=t.index;const o=we[t.index];let r;if(o.type==="color"){const a=es(o.value);r={type:"colormap",points:[{pos:.5,alpha:a.a,color:[a.r,a.g,a.b],order:1}]}}else o.type==="colormap"&&(r={type:"colormap",points:o.vertices.map(a=>({pos:a.pos,alpha:a.alpha!==void 0?a.alpha:1,color:Array.isArray(a.color)?[...a.color]:[a.color.r||0,a.color.g||0,a.color.b||0],order:a.order||1})),isCyclic:o.isCyclic===!0});ls.show(void 0,void 0,r),Te.count=0}else tt.length>0&&(st(),tt.forEach(o=>Oe[o]=t.index),Ya(),kt(),Bt=null);Te.targetId=s,Te.timestamp=n;return}if(e.target==="ui_session"){const{element:t}=e;t&&t.index!==void 0&&Ks(t.index);return}if(e.target==="ui_session_add"){zu();return}if(e.target==="ui_session_remove"){Nt!==null&&Nt>=0&&Wc(Nt);return}}function Og(e){if(lo||ys||Wo){if(lo){if(U.colorTargetIcons.find(n=>n.target===Wt.target)){const n=U.colorSwatches,s=ac(oe,n);s&&(Oe[Wt.target]=s.index,rr(Wt.target).forEach(i=>{Oe[i]=s.index}),Ya())}}else if(ys){const t=U.removeColorButton;if(t&&oe.x>=t.x&&oe.x<=t.x+t.width&&oe.y>=t.y&&oe.y<=t.y+t.height&&we.length>1){const s=we.indexOf(vt.item);s!==-1&&pa(s)}else if(vt&&vt.previewIndex!==null&&vt.previewIndex!==void 0){const s=vt.originalIndex,i=vt.previewIndex;if(s!==i&&s>=0&&i>=0){const o=[...vt.originalAllColors],[r]=o.splice(s,1);o.splice(i,0,r),we=o;const a={...vt.originalAssignments};Object.keys(a).forEach(d=>{const l=a[d];l===s?a[d]=i:s<i&&l>s&&l<=i?a[d]=l-1:s>i&&l>=i&&l<s&&(a[d]=l+1)}),Oe=a}}}else if(Wo){const t=U.removeSessionButton;t&&oe.x>=t.x&&oe.x<=t.x+t.width&&oe.y>=t.y&&oe.y<=t.y+t.height&&_i&&Wc(_i.index)}lo=!1,Wt=null,ys=!1,vt=null,Wo=!1,_i=null,xt&&kt(),Mt&&hi()}else ze?Rg():de&&(typeof de.target=="string"&&de.target.startsWith("ui")?Ng(de):Lg(de));ed()}function Fg(e){Ht=!0,Pn=!1,sr=tn,de={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function Bg(e){if(ze&&Pn){const t=Re({x:Math.min(tn.x,oe.x),y:Math.min(tn.y,oe.y)}),n=Re({x:Math.max(tn.x,oe.x),y:Math.max(tn.y,oe.y)}),s=Math.min(t.x,n.x),i=Math.max(t.x,n.x),o=Math.min(t.y,n.y),r=Math.max(t.y,n.y),a=xe.filter(f=>f.type==="regular"&&f.x>=s&&f.x<=i&&f.y>=o&&f.y<=r).map(f=>f.id),d=xe.filter(f=>f.type!=="regular"&&f.x>=s&&f.x<=i&&f.y>=o&&f.y<=r).map(f=>f.id),l=new Set(a),c=j.filter(f=>l.has(f.id1)&&l.has(f.id2)).map(f=>le(f)),h=re.filter(f=>f.vertexIds.every(u=>l.has(u))).map(f=>pe(f));de.shiftKey?(Me=[...new Set([...Me,...a])],be=[...new Set([...be,...c])],me=[...new Set([...me,...h])],Ge=[...new Set([...Ge,...d])]):de.ctrlKey?(a.forEach(f=>{const u=Me.indexOf(f);u>-1?Me.splice(u,1):Me.push(f)}),c.forEach(f=>{const u=be.indexOf(f);u>-1?be.splice(u,1):be.push(f)}),h.forEach(f=>{const u=me.indexOf(f);u>-1?me.splice(u,1):me.push(f)}),d.forEach(f=>{const u=Ge.indexOf(f);u>-1?Ge.splice(u,1):Ge.push(f)})):(Me=a,be=c,me=h,Ge=d),ja(),Pc()}else{if(Mt&&U.sessionsPanelBounds){const n=U.sessionsPanelBounds;if(oe.x>=n.x&&oe.x<=n.x+n.width&&oe.y>=n.y&&oe.y<=n.y+n.height){Uu();return}}mg(e);const t=Me.length>0||be.length>0||me.length>0||De.length>0;Bt=null,t||(tt=[]),xt&&kt()}}function $g(e){e.preventDefault();const t=Po(e,Ce),n=e.deltaY>0?1/1.15:1.15;lr(t,n),mn("wheel",e),Xt()}function Vg(){Qo=!0,Xt()}function Xg(){Qo=!1,qc(),Xt()}function Yg(e){e.preventDefault(),Xt()}function Gg(e,t){const n=parseInt(Kt||"1",10)||1,s=$e*2/ge.scale,i=$e*2/ge.scale,o=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z?.interval1;if(ke){const d=Re(tn),l=ei?.id||ye[0]?.id,c=si(l||null),h=[];if(Ze!=="none"&&o){const b=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;b&&_n(t,Ze,b,Zt,!0).forEach(_=>{const C=ie(t,_);h.push({priority:1,dist:C,pos:_,snapType:"grid"})})}const f=c.currentSegmentReferenceA_for_display,u=c.currentSegmentReferenceD,p=new Set([0,...pr.flatMap(b=>[b,-b])]),y=Array.from(p).sort((b,T)=>b-T).map(b=>({factor:b,angle:Tn(c.offsetAngleRad+b*f),turn:ft(b*f)})),m=ie(d,t),x=[];if([0,...jn].forEach(b=>x.push({factor:b,dist:b*u})),u>ue){const b=m/u,T=Math.round(b),_=Math.round(b*2)/2;[T,_].forEach(C=>{C>=0&&!x.some(E=>Math.abs(E.factor-C)<ue)&&x.push({factor:C,dist:C*u})})}if(x.sort((b,T)=>b.dist-T.dist),y.length>0&&x.length>0)for(const b of y)for(const T of x){if(T.dist<ue&&(b.factor!==0||x.length>1))continue;const _={x:d.x+T.dist*Math.cos(b.angle),y:d.y+T.dist*Math.sin(b.angle)},C=ie(t,_);h.push({priority:2,dist:C,pos:_,snapType:"geometric",lengthSnapFactor:T.factor,angleSnapFactor:b.factor,angleTurn:b.turn})}let v=null;if(h.length>0){const b=h.filter(T=>T.priority===1&&T.dist<s);if(b.length>0)v=b.sort((T,_)=>T.dist-_.dist)[0];else{const T=h.filter(_=>_.priority===2);if(T.length>0){const _=T.sort((C,E)=>C.dist-E.dist)[0];_.dist<i&&(v=_)}}}v&&(e={x:v.pos.x-d.x,y:v.pos.y-d.y})}if(ke&&Ze!=="none"&&o){const d=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;if(d){let l=null;ye.forEach(c=>{if(!c||c.type!=="regular")return;const h={x:c.x+e.x,y:c.y+e.y},f=_n(h,Ze,d,Zt,!0);if(!f.length)return;const u=f.sort((g,y)=>ie(h,g)-ie(h,y))[0],p=ie(h,u);if(p<s){const g={x:u.x-h.x,y:u.y-h.y};(!l||p<l.dist)&&(l={dist:p,correction:g})}}),l&&(e={x:e.x+l.correction.x,y:e.y+l.correction.y})}}const r=nf(ye,xe,j,J,e,n,ge),a=r.finalDelta;ye.forEach(d=>{const l=_e.find(c=>c&&c.id===d.id);l&&(l.x=d.x+a.x,l.y=d.y+a.y)}),Qa(a,r),de.finalSnapResult=r}function Wg(e,t){if(_e.length===0||ye.length===0)return;const n=ye[0],s=Re(e),i=hr/ge.scale,o=ur/ge.scale,r=$e*2/ge.scale,a=$e/ge.scale,d=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z?.interval1;let l=null;const c=u=>{if(!l){l=u;return}if(u.priority!==l.priority){u.priority<l.priority&&(l=u);return}u.dist<l.dist&&(l=u)};if(Zo=null,t){for(const u of xe)if(u.id!==n.id&&u.type==="regular"){const p=ie(s,u);p<i&&c({priority:1,dist:p,pos:u,snapType:"vertex"})}for(const u of j){const p=J(u.id1),g=J(u.id2);p&&g&&p.type==="regular"&&g.type==="regular"&&gt(s,p,g).distance<a*1.5&&Sa.forEach(m=>{const x={x:p.x+m*(g.x-p.x),y:p.y+m*(g.y-p.y)},S=ie(s,x);c({priority:2,dist:S,pos:x,snapType:"edge_fraction",targetEdge:u,fraction:m})})}}else{for(const u of xe)if(u.id!==n.id&&u.type==="regular"){const p=ie(s,u);p<i&&c({priority:1,dist:p,pos:u,snapType:"vertex"})}for(const u of j){const p=J(u.id1),g=J(u.id2);if(p&&g&&p.type==="regular"&&g.type==="regular"){const y=gt(s,p,g);y.distance<o&&y.onSegmentStrict&&c({priority:2,dist:y.distance,pos:{x:y.x,y:y.y},snapType:"edge"})}}}if(!l&&Ze!=="none"&&d){const u=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;if(u){const p=_n(s,Ze,u,Zt,!0);if(p.length>0){const g=p.sort((y,m)=>ie(s,y)-ie(s,m))[0];l={priority:3,dist:ie(s,g),pos:g,snapType:"grid"}}}}const h=l?t?!0:l.priority===1?l.dist<=r:l.priority===2?l.dist<=a:!1:!1,f=h&&l?l.pos:s;_e[0].x=f.x,_e[0].y=f.y,h&&l?(Ke={x:l.pos.x,y:l.pos.y},ln=l.snapType,t&&l.snapType==="edge_fraction"&&(Zo={edge:l.targetEdge,fraction:l.fraction,snapPoint:{x:l.pos.x,y:l.pos.y}})):(Ke=null,ln=null)}function zg(e){if(ns&&xe.length>0&&(dc(Le,{allFaces:re,hoveredFaceId:Vt,selectedFaceIds:me,colors:e,isDragConfirmed:ze,dragPreviewVertices:_e,currentAltPressed:Dt},Ae,J,pe),me.length>0&&Sc(Le,{allFaces:re,selectedFaceIds:me,colors:e,isDragConfirmed:ze,dragPreviewVertices:_e,initialDragVertexStates:ye,transformIndicatorData:et,highlightedEdgeForSnap:zn,draggedFaceId:ai,coordSystemSnapAngle:mo,coordSystemSnapType:Vs,coordSystemSnapScale:Gn,initialCoordSystemStates:Nn},Ae,J)),ot&&ke&&(wt!==null||Jt!==null)&&Ve.length>=1&&ts){const s=J(ts.id);if(s){const i={frozen_Origin_Data_to_display:s,displayAngleA_valueRad_for_A_equals_label:Jt,frozen_A_baseRad_to_display:Ss,frozen_D_du_to_display:wt,frozen_D_g2g_to_display:bs};Df(Le,i,Ae,Re,{showAngles:as,showDistances:Vn,viewTransform:ge,mousePos:oe,colors:e}),kf(yt,i,{showAngles:as,showDistances:Vn,viewTransform:ge,mousePos:oe,frozenReference_D_du:wt,distanceSigFigs:Ps,angleDisplayMode:nn,colors:e},Re,Ae,Ct)}}const t={lastGridState:Z,showDistances:Vn,showAngles:as,distanceSigFigs:Ps,angleDisplayMode:nn,angleSigFigs:wi,currentShiftPressed:ke,viewTransform:ge,colors:e};if(ze){const s=new Set(ye.map(r=>r.id));let i=!1;if(ye.length>0){const r=new Set(Ws(ye[0].id));i=!(s.size===r.size&&[...s].every(a=>r.has(a)))}const o=xe.map(r=>_e.find(d=>d.id===r.id)||r);if(i&&ke)ye.forEach(r=>{hn(r.id,j).some(d=>!s.has(d))&&no(Le,yt,r.id,o,t,Ae,d=>hn(d,j),le,ke,null,Ct,Me,!0,ye,it,Et)});else if(de&&(de.targetVertex||de.targetEdge||de.targetFace)){const r=de.targetVertex?de.targetVertex.id:ye[0]?.id;if(r&&no(Le,yt,r,o,t,Ae,a=>hn(a,j),le,ke,null,Ct,Me,!0,ye,it,Et),de.targetEdge&&Ol(Le,yt,be,j,{showDistances:Vn,distanceSigFigs:Ps,colors:e,lastGridState:Z,currentShiftPressed:ke},J,le,Ae,Ct,_e,ye,et),de.targetFace&&ke){const d=re.find(l=>pe(l)===pe(de.targetFace))?.vertexIds?.[0]||ye[0]?.id;d&&no(Le,yt,d,o,t,Ae,l=>hn(l,j),le,ke,null,Ct,Me,!0,ye,it,Et)}}}else(Vn||as)&&!ot&&!(parseInt(Kt||"1",10)>1&&ze)&&!an&&(Me.length>0&&Me.length<=ph&&Me.forEach(s=>{no(Le,yt,s,xe,{...t,currentShiftPressed:!1},Ae,i=>hn(i,j),le,!1,null,Ct,Me,!1,[],it)}),be.length>0&&be.length<=yh&&(Ol(Le,yt,be,j,{showDistances:Vn,distanceSigFigs:Ps,colors:e,lastGridState:Z},J,le,Ae,Ct,_e,ye,et),Jf(Le,yt,be,j,{showAngles:as,angleSigFigs:wi,angleDisplayMode:nn,currentShiftPressed:ke,distanceSigFigs:Ps,viewTransform:ge,lastGridState:Z,colors:e},J,le,Ae,s=>hn(s,j),Ct)));const n=!Dt&&(bn||Ut||Vt);if(ot&&It&&!n){const s=J(It);if(s){const i=si(s.id),o=di(s,oe,ke);let r=Je(qe),a=null;const d=Oe[qe];if(d!==-1){const h=we[d];if(h&&h.type==="colormap"&&Ve&&Ve.length>=1){const f=Ve.length,u=Ve.length-1,p=f>1?u/(f-1):0,g=f>1?(u+1)/f:1;a={colormapItem:h,startT:p,endT:g}}}fc(Le,{startVertex:s,snappedData:o,isShiftPressed:ke,currentColor:Je(nt),nextCreationColor:Je(nt),nextEdgeColor:r,colors:e,edgeColormapInfo:a,interpolationStyle:vo()},Ae);const l={x:o.x,y:o.y};gc(Le,yt,s,l,o,{showDistances:Vn,showAngles:as,currentShiftPressed:ke,distanceSigFigs:Ps,angleSigFigs:wi,angleDisplayMode:nn,viewTransform:ge,frozenReference_D_du:wt,gridDisplayMode:Ze,frozenReference_A_rad:Jt,colors:e},Ae,i,Ct)}}if(Ke&&!n){const s={...Ke,id:"ghost",type:"regular"};Ki(Le,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:ln==="vertex"||ln==="edge_fraction"||ln==="edge"?ln:null,currentAltPressed:Dt},Ae)}if(Pn&&ze&&jf(Le,sr,oe,e),bf(Le,{info:{...Ji,startVertex:J(It)},colors:e},Ae,J,Ct),vf(Le,{info:Zo,colors:e},Ae,J,Ct),(et||Rn)&&wf(Le,yt,{transformIndicatorData:et,colors:e,coordSystemTransformIndicatorData:Rn,currentShiftPressed:ke},Ae,Ct),Ke&&!n){const s={...Ke,id:"ghost",type:"regular"},i=ln==="vertex"||ln==="edge_fraction"||ln==="edge";i?Ki(Le,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:i?ln:null,currentAltPressed:Dt},Ae):Ra(Le,s,{colors:e,verticesVisible:!0,isSnapped:!0},Ae)}}function Hg(e){if(bn=null,Ut=null,Vt=null,er=null,Ke=null,ln=null,!Ht){if(!Dt){const o=Lc(e);if(o){er=o.id;return}}const t=Mo(e),n=t?null:Eo(e),s=!t&&!n?To(e):null,i=t||n||s;if(Dt)i?Ja(e,ke):dt=null,bn=null,Ut=null,Vt=null;else if(t?bn=t.id:n?Ut=le(n):s&&(Vt=s.id),ke&&!i){Re(e);const o=di({id:"dummy_start",x:0,y:0},e,!0);o.snapped&&(Ke={x:o.x,y:o.y},ln=o.snapType)}}}function Kg(e){if(It){const t=J(It);if(t)if(ke){const n=di(t,e,ke);Ji=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else Ji=null}Ke=null}function qg(e,t,n,s){const i=eg(n,e,t,s,Ai);let o={},r={},a=!1;if(s===rn)o=ng(n,ye,t,i.rotation,e),r={rotation:o.rotation,scale:1,directionalScale:!1},Ai=i.rotation;else if(s===$n)o=sg(n,ye,t,i.scale),r={rotation:0,scale:o.scale||i.scale,directionalScale:!1};else if(s===Sn)o=tg(n,ye,t,i.rotation,i.scale),r={rotation:o.rotation,scale:o.scale,directionalScale:!1},Ai=i.rotation;else if(s===Qn){const m={x:t.x-n.x,y:t.y-n.y};o=og(n,ye,t,i.scale,m,e),r={rotation:0,scale:o.scale||i.scale,directionalScale:!0}}const d=parseInt(Kt||"1",10)||1,l={x:t.x-n.x,y:t.y-n.y},c=(m,x,S)=>{const v=na(n,S.rotation||0,S.scale||1,S.directionalScale,l);return Ti(m,v,x)},h=(m,x,S,v,b)=>{if(!m||!x||!S)return null;const T=v===void 0?S:S-v;if(T===0)return null;const _={x:m.x-n.x,y:m.y-n.y},C={x:x.x-n.x,y:x.y-n.y},E=Math.hypot(_.x,_.y),M=Math.hypot(C.x,C.y),I=Math.atan2(_.y,_.x),w=Math.atan2(C.y,C.x),L=(A,R)=>A+Math.round((R-A)/(2*Math.PI))*(2*Math.PI),P=$e/ge.scale;if(s===rn)return E<ue||Math.abs(M-E)>P?null:{rotation:L((w-I)/T,b.rotation||0),scale:1,directionalScale:!1};if(s===$n){if(E<ue)return null;const A=Math.abs(ft(w-I)),R=P/Math.max(E,1e-6);if(A>R)return null;const O=M/E;if(!Number.isFinite(O))return null;const $=Math.pow(O,1/T);return Number.isFinite($)?{rotation:0,scale:$,directionalScale:!1}:null}if(s===Sn){if(E<ue)return null;const A=L((w-I)/T,b.rotation||0),R=M/E;if(!Number.isFinite(R))return null;const O=Math.pow(R,1/T);return Number.isFinite(O)?{rotation:A,scale:O,directionalScale:!1}:null}if(s===Qn){const A=Math.hypot(l.x,l.y);if(A<ue)return null;const R={x:l.x/A,y:l.y/A},O=_.x*R.x+_.y*R.y,$=C.x*R.x+C.y*R.y,F={x:_.x-O*R.x,y:_.y-O*R.y},V={x:C.x-$*R.x,y:C.y-$*R.y};if(ie(F,V)>P||Math.abs(O)<ue)return null;const B=$/O;if(B<=0||!Number.isFinite(B))return null;const D=Math.pow(B,1/T);return Number.isFinite(D)?{rotation:0,scale:D,directionalScale:!0}:null}return null},f=tf(ye,xe,j,J,d,ge,{...i,directionalScale:r.directionalScale},c,h);!(o.snapped&&o.snapType==="merge")&&f.snapped&&(r={rotation:f.finalTransform.rotation,scale:f.finalTransform.scale,directionalScale:f.finalTransform.directionalScale},o={snapped:!0,snapType:f.bestSnap?.type||"edge",snappedScaleValue:null},a=!0),a?(Qa({},f),de.finalSnapResult=f):(Et.clear(),Is.clear(),de.finalSnapResult=null),o.snapped&&o.snapType==="projection"&&o.projectionSource&&(Ke=o.projectionSource);const u=na(n,r.rotation,r.scale,r.directionalScale,l),p=Ti(t,u,1);if(et={center:n,startPos:t,currentPos:o.pos||p,rotation:r.rotation,scale:r.scale,isSnapping:o.snapped||!1,transformType:s,directionalScale:r.directionalScale,snappedScaleValue:o.snappedScaleValue||null,gridToGridInfo:o.gridToGridInfo||null,gridPoint:o.gridPoint||null,nearbyVertex:o.nearbyVertex||null,projectionPoint:o.projectionPoint||null,projectionSource:o.projectionSource||null,snapType:o.snapType||null,projectionCenter:o.snapType==="projection"?n:null,projectionHandleInitial:o.projectionHandleInitial||null,startVector:l},_e=ye.map(m=>{const x=Ti(m,u,1);return{...m,x:x.x,y:x.y}}),o.snapped&&o.snapType==="merge"&&o.mergingVertex&&o.mergeTarget){const m=ye.find(x=>x.id===o.mergingVertex.id);if(m){const x=_e.find(S=>S.id===m.id);if(x){const S={x:o.mergeTarget.x-x.x,y:o.mergeTarget.y-x.y};_e.forEach(v=>{v.x+=S.x,v.y+=S.y}),et.currentPos&&(et.currentPos.x+=S.x,et.currentPos.y+=S.y)}}}const g=$e*2/ge.scale,y=xe.filter(m=>m.type==="regular"&&!ye.some(x=>x.id===m.id));_e.forEach(m=>{m.type==="regular"&&y.forEach(x=>{ie(m,x)<g&&Ys.push({x:x.x,y:x.y})})});for(let m=0;m<_e.length;m++)for(let x=m+1;x<_e.length;x++){const S=_e[m],v=_e[x];S.type==="regular"&&v.type==="regular"&&ie(S,v)<g&&Ys.push({x:(S.x+v.x)/2,y:(S.y+v.y)/2})}}function Ug(e){if(lo&&Wt){const t=U.colorTargetIcons.find(n=>n.target===Wt.target);if(t){const n=[...U.colorSwatches],s=ac(e,n);s?(t.x=s.x+(s.width-t.width)/2,t.y=s.y-t.height-5,Wt.previewColorIndex=s.index,rr(Wt.target).forEach(i=>{const o=U.colorTargetIcons.find(r=>r.target===i);o&&(o.x=t.x,o.y=t.y)})):(t.x=e.x-Wt.offsetX,t.y=e.y-Wt.offsetY,Wt.previewColorIndex=Wt.originalColorIndex,rr(Wt.target).forEach(i=>{const o=U.colorTargetIcons.find(r=>r.target===i);o&&(o.x=t.x,o.y=t.y)}))}return!0}if(ys){const t=vt.originalIndex,n=U.colorSwatches.filter(i=>i.index!==t);let s=n.length;for(let i=0;i<n.length;i++){const o=n[i],r=o.x+o.width/2;if(e.x<r){s=i;break}}return vt.previewIndex!==s&&(vt.previewIndex=s,kt()),!0}return!!Wo}function Za(){if(Ht||ot){dt=null,Ke=null,bn=null,Ut=null,Vt=null;return}Dt?Ja(oe,ke):(dt=null,Hg(oe))}function Zc(e){if(oe=Po(e,Ce),ke=e.shiftKey,Dt=e.altKey,Ao=e.ctrlKey||e.metaKey,Ka(oe)?Ce.style.cursor="default":an?Ce.style.cursor="none":Jn||ze?Ce.style.cursor="grabbing":Ce.style.cursor="crosshair",Ht){if(de&&de.target==="ui")return;if(!ze&&ie(oe,tn)>$d&&!ot){if(ze=!0,de&&de.target==="coord_system")return;if(ei=de.dragHandle,tr=de.target==="edge",de.target==="ui_icon_click"){lo=!0;const t=de.element.target;Wt={target:t,offsetX:oe.x-de.element.x,offsetY:oe.y-de.element.y,originalColorIndex:Oe[t],previewColorIndex:Oe[t]},de.target="ui_icon_drag",tt=[t,...rr()]}else if(de.target==="ui_swatch")st(),ys=!0,vt={index:de.element.index,item:de.element.item,offsetX:oe.x-de.element.x,originalIndex:de.element.index,originalAllColors:JSON.parse(JSON.stringify(we)),originalAssignments:JSON.parse(JSON.stringify(Oe)),previewIndex:de.element.index};else if(de.target==="ui_session")Wo=!0,_i={index:de.element.index,session:de.element.session,offsetX:oe.x-de.element.x,offsetY:oe.y-de.element.y},de.target="ui_session_drag";else if(sn===2){Pn=!0;return}else if(de.target==="canvas")Jn=!0,Wr={x:ge.offsetX,y:ge.offsetY},Ce.style.cursor="move";else{Ce.style.cursor="grabbing",fs=de.targetVertex&&de.targetVertex.type!=="regular"&&!de.isTransformDrag;let n;if(fs)n=[de.targetVertex];else{let i=new Set(Me);be.forEach(o=>{const[r,a]=o.split(go);i.add(r),i.add(a)}),me.forEach(o=>{const r=re.find(a=>pe(a)===o);r&&Hc(r.id,re).forEach(d=>i.add(d))}),n=Array.from(i).map(o=>J(o)).filter(o=>o&&o.type==="regular")}if(fs&&de.targetVertex.type===rn){const i=de.targetVertex,o=Re(tn),r={x:o.x-i.x,y:o.y-i.y};de.initialRotationStartAngle=Math.atan2(r.y,r.x),Ai=0}const s=De.map(i=>bo(i)).filter(Boolean);if(n.length>0||s.length>0){ye=JSON.parse(JSON.stringify(n)),_e=JSON.parse(JSON.stringify(n)),ro=JSON.parse(JSON.stringify(s)),la=JSON.parse(JSON.stringify(s)),Nn.clear();const i=new Set(ye.map(o=>o.id));re.forEach(o=>{o.vertexIds.some(r=>i.has(r))&&o.localCoordSystem&&Nn.set(o.id,JSON.parse(JSON.stringify(o.localCoordSystem)))})}}}if(ze){if(Jn){const t=oe.x-tn.x,n=oe.y-tn.y;ge.offsetX=Wr.x+t*je,ge.offsetY=Wr.y-n*je}else if(!Pn){if(Ug(oe)||Tg(e))return;if(it&&(Me.length>0||be.length>0||me.length>0||De.length>0)&&!tr){const n=J(it);let s=ei;!s&&ye.length>0&&(s=ye.find(i=>i.type==="regular"&&ie(i,n)>1e-6)||ye.find(i=>i.type==="regular")),n&&s&&qg(Re(oe),s,n,n.type)}else if(fs&&_e.length>0)Wg(oe,ke);else if(_e.length>0){const n=ye.length===1&&ye[0].type==="regular",s=Re(oe);if(n){const i=ye[0];hn(i.id,j).filter(r=>!ye.some(a=>a.id===r)).map(r=>J(r));const o=Nu(i,s);if(_e[0].x=o.pos.x,_e[0].y=o.pos.y,Et.clear(),Is.clear(),o.snapped){const r={copyIndex:0,type:o.snapType,projectionLine:o.projectionLine};Et.set(i.id,[r]),o.targetEdge&&Is.set(le(o.targetEdge),[{copyIndex:0,type:"external_to_static"}])}de.finalSnapResult={...o,finalDelta:{x:o.pos.x-i.x,y:o.pos.y-i.y}}}else{const i=Re(tn),o={x:s.x-i.x,y:s.y-i.y};Gg(o,s)}}else if(la.length>0){const n=Re(tn),s=Re(oe),i={x:s.x-n.x,y:s.y-n.y};de.textFinalDelta=i}}}}else ot?Kg(oe):Za();mn("mouseMove",{clientX:e.clientX,clientY:e.clientY,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey}),Xt()}function Qa(e,t){if(Et.clear(),Is.clear(),!t||!t.snapped)return;const n=(s,i,o,r)=>{if(i===void 0)return;let a;if(o===void 0)a=void 0;else if(o===-1)a=0;else if(o>=0)a=o;else return;(a===void 0||a>=0)&&(s.has(i)||s.set(i,[]),s.get(i).some(d=>d.copyIndex===a&&d.type===r)||s.get(i).push({copyIndex:a,type:r}))};t.mergePairs.forEach(s=>{n(Et,s.source.originalId,s.source.transformIndex,"vertex"),n(Et,s.target.originalId,s.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:s,targetEdge:i})=>{n(Et,s.originalId,s.transformIndex,"edge"),n(Is,i.originalEdgeId,i.transformIndex,"vertex_on_edge")})}function jg(e,t,n){const s=2*$e/n.scale,i=new Map,o=new Map,r=new Map;e.forEach(c=>r.set(c.id,c.id));const a=c=>{if(!r.has(c)||r.get(c)===c)return c;const h=a(r.get(c));return r.set(c,h),h};for(let c=0;c<e.length;c++)for(let h=c+1;h<e.length;h++){const f=e[c],u=e[h];if(f.type==="regular"&&u.type==="regular"&&ie(f,u)<s){const p=a(f.id),g=a(u.id);p!==g&&r.set(g,p)}}e.forEach(c=>{const h=a(c.id);c.id!==h&&i.set(c.id,h)});const d=new Set(i.keys()),l=new Map(e.map(c=>[c.id,c]));return t.forEach(c=>{const h=a(c.id1),f=a(c.id2);if(h===f)return;const u=l.get(h),p=l.get(f);!u||!p||e.forEach(g=>{if(g.type!=="regular"||d.has(g.id)||g.id===h||g.id===f)return;const y=gt(g,u,p);if(y.distance<s&&y.onSegmentStrict){const m=le({id1:h,id2:f});o.has(m)||o.set(m,{edge:{id1:h,id2:f},pointsToInsert:[]}),o.get(m).pointsToInsert.push(g)}})}),{vertexMerges:i,edgeSplits:o}}function Qc(e){os?Cg():sn===0?Og():sn===2&&Bg(e),os||ed(),Ka(oe)?Ce.style.cursor="default":an||(Ce.style.cursor="crosshair"),en(),sn===2?mn("rightMouseUp",e):sn===0&&mn("mouseUp",e),Xt()}function ed(){on&&clearTimeout(on),Kt="",on=null,Ht=!1,ze=!1,Pn=!1,tr=!1,fs=!1,Jn=!1,_e=[],ye=[],la=[],ro=[],Zo=null,de=null,et=null,Ys=[],Ke=null,Is.clear(),Et.clear(),Nn.clear(),sn=-1}function td(e){on&&clearTimeout(on),Kt="",on=null,Pt.style.display==="block"&&(Pt.style.display="none");const t=e.target;if(t&&(t.tagName==="INPUT"||t.closest(".katex"))){e.stopPropagation(),Xt();return}if((ot||an)&&e.button===2){Ts(),e.preventDefault(),Xt();return}oe=Po(e,Ce),tn={...oe},sn=e.button,sn===0?(kg(e),mn("mouseDown",e)):sn===2&&(Fg(e),mn("rightMouseDown",e)),Xt()}function nd(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;const t=()=>{mn("keyDown",e),Xt()};if((e.key==="Control"||e.key==="Meta")&&(Ao=!0),e.key==="Alt"&&!e.repeat&&(e.preventDefault(),Dt=!0,Za()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!ot&&!an&&!Ht){e.preventDefault(),ga(e.key),Xt();return}const s=e.ctrlKey||e.metaKey;if(s&&(e.key==="a"||e.key==="A")){e.preventDefault();const o=xe.filter(l=>l.type==="regular").map(l=>l.id),r=j.map(l=>le(l)),a=re.map(l=>pe(l)),d=He.map(l=>l.id);Yt(o,r,a,!1,!1,!1,d),Ge=xe.filter(l=>l.type!=="regular").map(l=>l.id),it=Ge.length>0?Ge[Ge.length-1]:null,t();return}if(e.key==="Shift"&&!ke){ke=!0;const o=Re(oe);if(an){const r=Ri(o);r&&(li=Ae(r),Ke=r)}else if(ot&&It){const r=J(It);if(r){const a=Mr(),d=si(r.id),l=di(r,oe,ke);let c=Je(qe),h=null;const f=Oe[qe];if(f!==-1){const p=we[f];if(p&&p.type==="colormap"&&Ve&&Ve.length>=1){const g=Ve.length,y=Ve.length-1,m=g>1?y/(g-1):0,x=g>1?(y+1)/g:1;h={colormapItem:p,startT:m,endT:x}}}fc(Le,{startVertex:r,snappedData:l,isShiftPressed:ke,currentColor:Je(nt),nextCreationColor:Je(nt),nextEdgeColor:c,colors:a,edgeColormapInfo:h,interpolationStyle:vo()},Ae),gc(Le,yt,r,l,l,{showDistances:Vn,showAngles:as,currentShiftPressed:ke,distanceSigFigs:Ps,angleSigFigs:wi,angleDisplayMode:nn,viewTransform:ge,frozenReference_D_du:wt,gridDisplayMode:Ze,frozenReference_A_rad:Jt,colors:a},Ae,d,Ct)}}else if(!Ht)if(os&&An&&An.type==="center"){const r=Ri(o);if(r){Ke=r;const a=An.face,d=a.localCoordSystem,l=a.vertexIds.map(h=>J(h)).filter(h=>h&&h.type==="regular"),c=yo(r,l);d.origin.x=c.x,d.origin.y=c.y,d.isCustom=!0}}else{const r=Mo(oe),a=r?null:Eo(oe),d=!r&&!a?To(oe):null;!r&&!a&&!d?Ke=Ri(o):Ke=null}}if(Ht&&sn===0&&(de?.targetVertex||de?.targetEdge||de?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(on),on===null||Kt.length>=2?Kt=e.key:Kt+=e.key;const o=parseInt(Kt,10)||1;if(de?.finalSnapResult?.finalDelta){const r=de.finalSnapResult.finalDelta,a={delta:r},l=cc(ye,xe,j,J,o,ge,a,(c,h,f=a)=>({x:c.x+f.delta.x*h,y:c.y+f.delta.y*h}));Qa(r,l),de.finalSnapResult={...l,finalDelta:r}}on=setTimeout(()=>{on=null},500)}if(s&&e.key.toLowerCase()===_h){e.preventDefault(),ot&&It&&cg(),t();return}if(!(Ht&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(s&&[El,Cl,Tl,Fr,wl,Pl,Ml,bl,vl].includes(e.key.toLowerCase())))){if(Qo&&s&&(e.key===bl||e.key===vl)){e.preventDefault();const o={x:Ce.width/je/2,y:Ce.height/je/2};lr(o,fl),t();return}if(Qo&&s&&e.key===Ml){e.preventDefault();const o={x:Ce.width/je/2,y:Ce.height/je/2};lr(o,1/fl),t();return}if(e.key===Ch)e.preventDefault(),Qu();else if(e.key===wh)Ts();else if(e.key===Ph||e.key===Ah)e.preventDefault(),pi();else if(s&&e.key.toLowerCase()===El){if(Mt&&Xe[Ot]){e.preventDefault(),Go=JSON.parse(JSON.stringify(Xe[Ot])),t();return}e.preventDefault(),zc()}else if(s&&e.key.toLowerCase()===Cl)e.preventDefault(),ju();else if(s&&e.key.toLowerCase()===Tl){if(Mt&&Go){e.preventDefault(),Hu(),t();return}e.preventDefault(),Ju()}else if(s&&e.key.toLowerCase()===Fr&&!e.shiftKey){if(Mt&&or.length>0){e.preventDefault(),Ku(),t();return}e.preventDefault(),vg()}else if(s&&(e.key.toLowerCase()===wl||e.shiftKey&&e.key.toLowerCase()===Fr))e.preventDefault(),Mg();else if(s&&e.key.toLowerCase()===Pl&&!ha){e.preventDefault(),st(),Me=xe.filter(r=>r.type==="regular").map(r=>r.id),be=j.map(r=>le(r)),me=re.map(r=>r.id),Ge=xe.filter(r=>r.type!=="regular").map(r=>r.id),it=null;const o=[];me.length>0&&o.push(at),be.length>0&&o.push(qe),Me.length>0&&o.push(nt),De.length>0&&o.push(qt),o.length>0&&(tt=o,xt&&kt())}t()}}function sd(e){const t=()=>{mn("keyUp",e),Xt()};if(e.key==="Shift"&&(ke=!1,Ke=null,li=null,Ys=[],os&&An&&An.type==="center")){const n=Re(oe),s=An.face,i=s.localCoordSystem,o=s.vertexIds.map(a=>J(a)).filter(a=>a&&a.type==="regular"),r=yo(n,o);i.origin.x=r.x,i.origin.y=r.y,i.isCustom=!0}e.key==="Alt"&&(Dt=!1,Za()),(e.key==="Control"||e.key==="Meta")&&(Ao=!1),en(),t()}function od(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,s=t.offsetHeight;Ce.width=n*je,Ce.height=s*je,Ce.style.width=`${n}px`,Ce.style.height=`${s}px`,yt&&(yt.style.width=`${n}px`,yt.style.height=`${s}px`)}function Jg(){Su(),we=gr.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),Fu(),Oc(),od(),vu(),nu({canvas:Ce,onMouseDown:td,onMouseMove:Zc,onMouseUp:Qc,onPinchZoom:(n,s)=>{lr(s,n),Xt()},onPan:n=>{Zu(n),Xt()},getModifiers:()=>({shiftKey:ke,ctrlKey:Ao,altKey:Dt}),isHoverMode:()=>Pi,getHoverTarget:()=>Pe.hoverTarget,getUiTargetAt:Mu}),ls=new cd,ls.initialize(),document.body.appendChild(ls.getElement());const e=ls.getElement();e.addEventListener("mouseenter",()=>{ha=!0}),e.addEventListener("mouseleave",()=>{ha=!1}),ls.getElement().addEventListener("select",n=>{const s=n.detail,i=Jh(s);if(i){if(nr&&Yo!==null)we[Yo]=i;else{Vu(i);const o=we.length-1;tt.forEach(r=>{Oe[r]=o})}Ya(),nr=!1,Yo=null,kt()}}),so=new Sd({container:document.body,onSelect:n=>{if(!n)return;const s={...n};s.id||(s.id=$t());const i=In.findIndex(o=>o.id===s.id);i>=0?In[i]=s:In.push(s),ki(s.id),un&&Ha(),en()}}),so.initialize(),ge.scale=70,ge.offsetX=Ce.width/2,ge.offsetY=Ce.height/2,Xs="regular",Pt=document.getElementById("context-menu"),window.addEventListener("click",()=>{Pt&&(Pt.style.display="none")}),Pt.addEventListener("mouseleave",()=>{Pt.style.display="none"}),Gu()||(Yu()||st(),Wu()),Jc(),Qt(),Xt()}Ce.addEventListener("wheel",$g,{passive:!1});Ce.addEventListener("mouseenter",Vg);Ce.addEventListener("mouseleave",Xg);window.addEventListener("contextmenu",Yg);Ce.addEventListener("mousemove",Zc);Ce.addEventListener("mouseup",Qc);Ce.addEventListener("mousedown",td);window.addEventListener("keyup",sd);window.addEventListener("keydown",nd);window.addEventListener("resize",od);window.addEventListener("beforeunload",()=>{Gc()});window.addEventListener("load",Jg);

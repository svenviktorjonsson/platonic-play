(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const la="#3b82f6",ca="#4a5568",da="#718096",Xc=300,ha="#242c3a",Hs=2,Fr=3,De=9,fa=12,Yc=5,Br=8,it=8,$r=.9,Vr=5,ni=[4,4],Gc={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},zc={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class Hc{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=Gc,this.namedColormaps=zc,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,s=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,o=1;if(s&&s.type==="colormap"&&(s.points||s.controlPoints)){this.state.isCyclic=s.isCyclic===!0;let a=JSON.parse(JSON.stringify(s.controlPoints||s.points));if(a.length===1){a[0].pos=.5;const r=a[0].color,c=r[0]/255,l=r[1]/255,d=r[2]/255;i=(c+l+d)/3,o=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(r=>{const c=r.color,l=r.alpha!==void 0?r.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,l,r.pos,r.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=o,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async s=>{const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch preset file at ${s}: Status ${i.status}`);return await i.json()},n=s=>{try{const i=localStorage.getItem(s);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:s}=t.dataset;if(s==="named_colors"||s==="custom_colors"){let i;if(s==="named_colors"?i=this.namedColors[n]:i=this.customColors[n]?.rgb,!i){console.error(`RGB undefined for ${n} in ${s}`);return}this.applyColorToSelection(i)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const i=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(i==="Cancel"||i==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,s)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,s=t[1]/255,i=t[2]/255;if(this.state.selectedPointIds.size===0){const o=this.state.points.length;o>0&&this.state.points.forEach(c=>{c.pos=c.pos*(o/(o+1))});const a=o===0?.5:1,r=this.createPointFromRgb(n,s,i,1,a,1);this.state.points.push(r),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const r=this.convertRgbToCurrentColorspace(n,s,i);a.hsPos=r.hsPos,a.originalHsPos={...r.hsPos},a.lightness=r.lightness}});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}loadColormap(t,n,s=!1){s||this.saveState();const i=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!i||!i.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const o=i.points.map(a=>{let r=[0,0,0];typeof a.color=="string"?r=this.namedColors[a.color]||this.customColors[a.color]?.rgb||r:Array.isArray(a.color)&&(r=a.color);const c=r[0]/255,l=r[1]/255,d=r[2]/255,f=a.alpha??1;return this.createPointFromRgb(c,l,d,f,a.pos,a.order)});this.state.points=o,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=(L,k={})=>{const R=document.createElement(L);if(k.id){R.id=k.id;const X=k.id.replace(/-(\w)/g,(z,B)=>B.toUpperCase());this.elements[X]=R}return k.className&&(R.className=k.className),k.text&&(R.textContent=k.text),k.type&&(R.type=k.type),k.placeholder&&(R.placeholder=k.placeholder),R};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),s=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const o=t("div",{id:"selected-color-section",className:"control-section"}),a=t("div",{id:"current-colormap-section",className:"control-section"}),r=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),r.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(r,c);const d=t("h2",{className:"panel-header",text:"Lightness"}),f=t("div",{id:"lightness-slider-container",className:"canvas-container"}),h=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});f.append(t("canvas",{id:"lightness-bg-canvas"}),h),s.append(d,f);const u=t("h2",{className:"panel-header",text:"Alpha"}),p=t("div",{id:"alpha-slider-container",className:"canvas-container"}),g=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});p.append(t("canvas",{id:"alpha-bg-canvas"}),g),i.append(u,p);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const m=t("div",{className:"preset-category-header"});m.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(m,t("div",{className:"preset-items-container"}));const x=t("h3",{className:"section-title",text:"Selected Color"}),S=t("div",{className:"preview-container"});S.append(t("canvas",{id:"selected-color-preview-canvas"}));const I=t("div",{className:"space-y-2"}),b=t("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const E=t("div");E.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const T=t("div");T.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const M=t("div");M.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),b.append(E,T,M),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const P=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),A=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),v=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(P,A,v),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const w=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),_=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(w,_);const C=t("h3",{className:"input-label",text:"Interpolation"});C.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const D=t("div",{className:"interpolation-grid"});D.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),D.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),I.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,C,D),o.append(x,S,I);const O=t("h3",{className:"section-title text-center",text:"Current Colormap"}),F=t("div",{className:"preview-container"});F.append(t("canvas",{id:"colormap-preview-canvas"}));const V=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const N=t("div",{className:"button-row"});N.append(this.elements.reverseButton,this.elements.cycleButton),V.append(N,this.elements.closeButton,this.elements.selectButton),a.append(O,F,V),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const $=t("div",{id:"modal-dialog",className:"modal-dialog"});$.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),$.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append($),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,s,this.elements.colorsPresetsWrapper,o,i,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(h,"lightness"),this.createInteractiveCanvas(g,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const s=i=>{const o=i.target.closest(".preset-item");o&&(i.type==="click"?this.handlePresetClick(o):i.type==="contextmenu"&&o.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,o.dataset.name,o.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",s),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",s),this.elements.colormapsPresetsWrapper.addEventListener("click",s),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",s),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const o=this.state.points,a=o.length,r=(u,p)=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(g);return{pos:parseFloat((p!==void 0?p:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let p=0;p<u;p++){const g=o[p],y=o[(p+1)%a];i.push(r(g));const m=Math.max(g.order,y.order);if(m===0){let x=g.pos,S=y.pos;this.state.isCyclic&&S<x&&(S+=1);const I=x+(S-x)*.5;i.push(r(g,this.wrapPositionCyclic(I-1e-6))),i.push(r(y,this.wrapPositionCyclic(I)))}else if(m===3){const S=g.pos;let I=y.pos;this.state.isCyclic&&I<S&&(I+=1);const b=I-S;for(let E=1;E<16;E++){const T=E/16,M=S+T*b,P=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(M));if(P){const A=this.abstractToRgb(P.u,P.v,P.lightness),v=this.clampColor(A);i.push({pos:parseFloat(this.wrapPositionCyclic(M).toFixed(6)),alpha:parseFloat(P.alpha.toFixed(4)),color:[v.r,v.g,v.b],order:P.order})}}}}this.state.isCyclic||i.push(r(o[a-1]))}const c=new Map;i.forEach(u=>c.set(u.pos,u));let l=Array.from(c.values()).sort((u,p)=>u.pos-p.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const d=this.state.points.map(u=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),g=this.clampColor(p);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[g.r,g.g,g.b],order:u.order}}),f={points:l,controlPoints:d,isCyclic:this.state.isCyclic},h=new CustomEvent("select",{detail:f,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(h)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,s){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const o={Rename:()=>this.handlePresetAction("rename",n,s),Delete:()=>this.handlePresetAction("delete",n,s)};for(const[a,r]of Object.entries(o)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=r,i.appendChild(c)}i.style.left=`${t.clientX}px`,i.style.top=`${t.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,s){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(s==="custom_colors"&&delete this.customColors[n],s==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(s),this.populatePresets());else if(t==="rename"){const i=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(i&&i!==n){const o=s==="custom_colors"?this.customColors:this.customColormaps;if(o[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}o[i]=o[n],delete o[n],this.saveCustomPresets(s),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const s=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!s)return!1;if(t==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const o=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),a=this.clampColor(o);this.customColors[s]={rgb:[a.r,a.g,a.b],alpha:i.alpha}}else{const i=this.state.points.map(o=>{const a=this.abstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness),r=this.clampColor(a);return{pos:o.pos,alpha:o.alpha,color:[r.r,r.g,r.b],order:o.order}});this.customColormaps[s]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=s,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(o,a)=>{const r=document.createElement("div");r.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=o;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=a,r.appendChild(c),r.appendChild(l),r},n=(o,a,r,c)=>{Object.keys(a).sort().forEach(l=>{const d=document.createElement("div");d.className="preset-item",d.dataset.name=l,d.dataset.type=r,d.dataset.custom=c;const f=document.createElement("canvas");f.className="preset-icon",r.includes("colormap")?(f.width=64,f.height=16):(f.width=16,f.height=16);const h=document.createElement("span");if(h.textContent=l,d.appendChild(f),d.appendChild(h),o.appendChild(d),r==="named_colors"||r==="custom_colors"){const u=a[l],p=c?u.rgb:u;this.drawColorIcon(f,p)}else this.drawColormapIcon(f,a[l].points,this.namedColors,this.customColors)})},s=document.createElement("div");s.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(s),n(s,this.namedColors,"named_colors",!1),n(s,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),n(i,this.namedColormaps,"named_colormaps",!1),n(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,s,i){const o=n.map(d=>{let f=[0,0,0];typeof d.color=="string"?f=s[d.color]||(i[d.color]?i[d.color].rgb:[0,0,0]):Array.isArray(d.color)&&(f=d.color);const{hsPos:h,lightness:u}=this.convertRgbToCurrentColorspace(f[0]/255,f[1]/255,f[2]/255);return{id:Math.random(),hsPos:h,originalHsPos:{...h},lightness:u,alpha:d.alpha??1,pos:d.pos,order:1}}).sort((d,f)=>d.pos-f.pos),a=this.state.points;this.state.points=o;const r=t.getContext("2d"),{width:c,height:l}=t;if(this.drawCheckerboard(r),this.state.points.length>0)for(let d=0;d<c;d++){const f=d/(c-1),h=this.getInterpolatedPropertiesAt(f);if(!h)continue;const u=this.clampAbstractPoint(h.u,h.v,h.lightness),p=this.abstractToRgb(u.u,u.v,h.lightness),{r:g,g:y,b:m}=this.clampColor(p);r.fillStyle=`rgba(${g}, ${y}, ${m}, ${h.alpha})`,r.fillRect(d,0,1,l)}this.state.points=a}showPrompt(t,n,s=null){return new Promise(i=>{const{modalOverlay:o,modalTitle:a,modalInputContainer:r,modalInput:c,modalButtons:l}=this.elements,d=document.querySelectorAll("[data-tick-canvas]");d.forEach(f=>f.style.display="none"),a.textContent=t,l.innerHTML="",s?(c.value=s.value||"",c.placeholder=s.placeholder||"",r.classList.remove("hidden")):r.classList.add("hidden"),n.forEach(f=>{const h=document.createElement("button");h.className=`modal-button ${f==="Save"||f==="Delete"||f==="Rename"?"modal-button-primary":"modal-button-secondary"}`,h.textContent=f,h.onclick=()=>{o.classList.add("hidden"),d.forEach(u=>u.style.display=""),i(s?c.value:f)},l.appendChild(h)}),o.classList.remove("hidden"),s&&c.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(s=>s.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(s=>Math.abs(s.pos)<1e-6),n=this.state.points.some(s=>Math.abs(s.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(o=>({id:o.id,pos:o.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(o=>{o.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const s=t.getContext("2d");s.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,s.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,s,i,o,a){const{hsPos:r,lightness:c}=this.convertRgbToCurrentColorspace(t,n,s);return{id:Date.now()+Math.random(),hsPos:r,originalHsPos:{...r},lightness:c,alpha:i,pos:o,order:a}}convertRgbToCurrentColorspace(t,n,s){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),lightness:(t+n+s)/3};{const i=this.rgbToHsl(t,n,s);return{hsPos:this.rgbToHslDiConeAbstract(t,n,s),lightness:i.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:d,clientHeight:f}=l.container;(l.c.width!==d||l.c.height!==f)&&(l.c.width=d,l.c.height=f)});const i=this.elements.hsBgCanvas,o=this.elements.interactiveCanvases.hs,a=i.parentElement,r=a.clientWidth,c=a.clientHeight;[i,o].forEach(l=>{l&&(l.width=r,l.height=c,l.style.width=`${r}px`,l.style.height=`${c}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(i=>{let o;n==="RGB_CUBE"?o=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):o=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let a,r;if(t==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(o),r=(o.r+o.g+o.b)/3;else{const c=this.rgbToHsl(o.r,o.g,o.b);a=this.rgbToHslDiConeAbstract(o.r,o.g,o.b),r=c.l}i.hsPos=a,i.originalHsPos={...a},i.lightness=r});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const s=Date.now(),i=this.elements.interactiveCanvases[n];if(!i)return;const o=i.getBoundingClientRect(),a=i.width/o.width,r=i.height/o.height,c=(t.clientX-o.left)*a,l=(t.clientY-o.top)*r,d={x:c,y:l};let f=!1,h=null,u=!1;if(n==="hs")h=this.findHitPointHS(c,l);else{const m=this.findHitPointSlider(c,l,n);h=m.hitPoint,u=m.hitLine}if(s-this.lastClickTime<Xc&&h&&h.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=s,this.lastClickTarget=h?h.id:null,h){this.state.viewLightness=h.lightness,this.state.viewAlpha=h.alpha;const m=t.ctrlKey||t.metaKey,x=t.shiftKey;!this.state.selectedPointIds.has(h.id)&&!m&&!x&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(h.id),this.state.lastSelectedPointId=h.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=i,this.state.activeDrag.pointId=h?h.id:null,h){const m=new Map;if(n==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:x,offsetX:S,offsetY:I}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const E=b.hsPos.u*x+S,T=b.hsPos.v*x+I;this.state.activeDrag.initialPointPositions.set(b.id,{x:E,y:T})}})}else this.state.points.forEach(x=>{this.state.selectedPointIds.has(x.id)&&m.set(x.id,{lightness:x.lightness-h.lightness,alpha:x.alpha-h.alpha,pos:x.pos-h.pos})}),this.state.activeDrag.offsets=m}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const g=m=>{const x=(m.clientX-o.left)*a,S=(m.clientY-o.top)*r,I=Math.sqrt((x-d.x)**2+(S-d.y)**2);!f&&I>Yc&&(f=!0,h&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(m)},y=m=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y),f||this.handleClick(c,l,n,h,m),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",g),document.addEventListener("mouseup",y)}handleClick(t,n,s,i,o){const{shiftKey:a,ctrlKey:r,metaKey:c}=o,l=r||c;if(i){const{selectedPointIds:d}=this.state,f=i.id;if(this.clickCount===3)this.state.points.forEach(h=>d.add(h.id)),this.state.lastSelectedPointId=f;else if(this.clickCount===2){const h=this.state.points.findIndex(p=>p.id===f);d.clear(),[h-1,h,h+1].forEach(p=>{p>=0&&p<this.state.points.length&&d.add(this.state.points[p].id)}),this.state.lastSelectedPointId=f}else l?d.has(f)?(d.delete(f),this.state.lastSelectedPointId===f&&(this.state.lastSelectedPointId=d.size>0?Array.from(d)[0]:null)):(d.add(f),this.state.lastSelectedPointId=f):a?(d.add(f),this.state.lastSelectedPointId=f):(d.clear(),d.add(f),this.state.lastSelectedPointId=f)}else if(s==="hs")this.createNewPointHS(t,n);else if(s==="lightness"||s==="alpha"){const d=this.elements.interactiveCanvases[s],f=Math.ceil(De*2.2),h=d.height-2*f,p=(d.height-f-n)/h,g=Math.max(0,Math.min(1,p));s==="lightness"?this.state.viewLightness=g:this.state.viewAlpha=g}this.drawAll()}findHitPointHS(t,n){const s=Math.ceil(De*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=o,c=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;for(const d of this.state.points){const f=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,h=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(f>=a-De&&f<=a+c+De&&h>=r-De&&h<=r+l+De&&Math.sqrt((t-f)**2+(n-h)**2)<=fa)return d}return null}handleInputChange(t,n){const s=t.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(n==="lightness"||n==="alpha"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[n]=o,n==="lightness"&&this.constrainPointToValidArea(a))}),i=!0)}else if(n==="position"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=o)}),this.sortPoints(),i=!0)}if(i){const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,s,i,o,a,r=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),s=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(s))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,s=Math.max(0,Math.min(255,s))/255;const c=this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),l=(t+n+s)/3;this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...c},d.originalHsPos={...c},d.lightness=l)}),r=!0}else{if(i=parseFloat(this.elements.hslHInput.value),o=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(i)||isNaN(o))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),o=Math.max(0,Math.min(1,o));const c=this.hslToRgb(i,o,a),l=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...l},d.originalHsPos={...l})}),r=!0}if(r){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const s=document.createElement("canvas");s.className=`interactive-canvas ${n}-interactive`,s.dataset.type=n,t.appendChild(s),this.elements.interactiveCanvases[n]=s}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:s,pointId:i}=this.state.activeDrag,o=s,a=o.getBoundingClientRect(),r=o.width/a.width,c=o.height/a.height,l=(t.clientX-a.left)*r,d=(t.clientY-a.top)*c;n.endsWith("-line")?this.handleLineDrag(d,o.height,n):i&&this.handlePointDrag(l,d,o,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),s=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:s}}rgbToHslDiConeAbstract(t,n,s){const i=this.rgbToHsl(t,n,s),o=1-Math.abs(2*i.l-1),a=i.s*o,r=i.h*2*Math.PI,c=a*Math.cos(r),l=a*Math.sin(r);return{u:c,v:l}}hslDiConeAbstractToRgb(t,n,s){const i=(Math.atan2(n,t)/(2*Math.PI)+1)%1,o=Math.sqrt(t*t+n*n),a=s,r=1-Math.abs(2*a-1);if(r<1e-9)return{r:a,g:a,b:a};const c=o/r;return this.hslToRgb(i,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,s=n&&n.tagName==="INPUT",i=t.ctrlKey||t.metaKey;if(i&&t.key==="z"){t.preventDefault(),this.undo();return}if(i&&t.key==="y"){t.preventDefault(),this.redo();return}if(s){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(i&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(o=>this.state.selectedPointIds.add(o.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(o=>!this.state.selectedPointIds.has(o.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,s,i=null){let o=t,a=Vr+1;const r=Math.ceil(De*2.2),c=Math.ceil(it/2),l=r+c,d=n-l-r,f=n-r;return this.state.points.forEach(h=>{if(h.id===i)return;const u=f-h[s]*d,p=Math.abs(t-u);p<Vr&&p<a&&(o=u,a=p)}),o}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:s}=this.state,i=this.elements.hsBgCanvas.width,o=this.elements.hsBgCanvas.height;if(i===0||o===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=ha,a.fillRect(0,0,i,o);const r=Math.ceil(De*2.2),c=Math.ceil(it/2),l=r+c,d=i-l-r,f=o-l-r;if(d<=0||f<=0)return;const h=s==="RGB_CUBE"?Math.min(d,f)/(Math.sqrt(2/3)*2)*$r:Math.min(d,f)/2*$r;this.state.transform.scale=h,this.state.transform.offsetX=i/2,this.state.transform.offsetY=o/2;const u=l,p=l,g=d,y=f,m=it,x=Math.round(g/m),S=Math.round(y/m),I=g/x,b=y/S;for(let A=0;A<S;A++)for(let v=0;v<x;v++){const w=u+v*I,_=p+A*b;(A+v)%2===0?a.fillStyle=da:a.fillStyle=ca,a.fillRect(w,_,I,b)}if(s==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const v=i/2,w=o/2,_=t<.5?0:255;a.fillStyle=`rgba(${_}, ${_}, ${_}, ${n})`,a.fillRect(Math.floor(v),Math.floor(w),1,1);return}const E=a.createImageData(g,y),T=E.data;for(let A=0;A<y;A++)for(let v=0;v<g;v++){const w=u+v,_=p+A,C=(w-this.state.transform.offsetX)/this.state.transform.scale,D=(_-this.state.transform.offsetY)/this.state.transform.scale,{r:O,g:F,b:V}=this.abstractToRgb(C,D,t),N=(A*g+v)*4;this.isValidColor(O,F,V)&&(T[N]=Math.round(O*255),T[N+1]=Math.round(F*255),T[N+2]=Math.round(V*255),T[N+3]=255)}const M=document.createElement("canvas");M.width=g,M.height=y,M.getContext("2d").putImageData(E,0,0),a.globalAlpha=n,a.drawImage(M,u,p),a.globalAlpha=1}evaluateCubicSpline(t,n){const s=this.state.points,i=s.length;if(t<0||t>=i)return null;let o,a,r,c;if(this.state.isCyclic){const u=p=>{const g=(p%i+i)%i;return s[g]};t===i-1?(o=u(t-1),a=u(t),r=u(0),c=u(1)):(o=u(t-1),a=u(t),r=u(t+1),c=u(t+2))}else a=s[t],r=s[t+1],o=t>0?s[t-1]:s[t],c=t+2<i?s[t+2]:s[t+1];const l=n,d=l*l,f=d*l,h=(u,p,g,y)=>.5*(2*p+(-u+g)*l+(2*u-5*p+4*g-y)*d+(-u+3*p-3*g+y)*f);return{u:h(o.hsPos.u,a.hsPos.u,r.hsPos.u,c.hsPos.u),v:h(o.hsPos.v,a.hsPos.v,r.hsPos.v,c.hsPos.v),lightness:h(o.lightness,a.lightness,r.lightness,c.lightness),alpha:h(o.alpha,a.alpha,r.alpha,c.alpha),order:2}}isValidColor(t,n,s){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&s>=-.001&&s<=1.001}drawSliderBackgrounds(){const t=Math.ceil(De*2.2),n=Math.ceil(it/2),s=t+n,i=this.elements.lightnessBgCanvas.getContext("2d"),o=this.elements.lightnessBgCanvas;i.fillStyle=ha,i.fillRect(0,0,o.width,o.height);const a=s,r=o.width-t,c=s,l=o.height-t,d=r-a,f=l-c;if(f>0&&d>0){const I=i.createLinearGradient(0,c,0,l);I.addColorStop(0,"white"),I.addColorStop(1,"black"),i.fillStyle=I,i.fillRect(a,c,d,f)}const h=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;h.fillStyle=ha,h.fillRect(0,0,u.width,u.height);const p=s,g=u.width-t,y=s,m=u.height-t,x=g-p,S=m-y;if(S>0&&x>0){const I=it,b=Math.round(x/I),E=Math.ceil(S/I),T=x/b,M=I,P=m-E*M;for(let v=0;v<E;v++)for(let w=0;w<b;w++){const _=p+w*T,C=P+v*M;if(C<m&&C+M>y){(v+w)%2===0?h.fillStyle=da:h.fillStyle=ca;const D=Math.max(C,y),O=Math.min(C+M,m)-D;O>0&&h.fillRect(_,D,T,O)}}const A=h.createLinearGradient(0,y,0,m);A.addColorStop(0,"white"),A.addColorStop(1,"rgba(255,255,255,0)"),h.fillStyle=A,h.fillRect(p,y,x,S)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=la,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(De*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=o,c=t.width-o-s,l=t.height-o-s;if(this.state.points.length>1){const d=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let f=0;f<d;f++){const h=this.state.points[f],u=this.state.points[(f+1)%this.state.points.length];if(Math.max(h.order,u.order)===0)continue;let g=h.pos,y=u.pos;this.state.isCyclic&&y<g&&(y+=1);const m=y-g;if(m<1e-9)continue;const x=Math.max(10,Math.ceil(m*100)),S=[];for(let b=0;b<=x;b++){const E=g+b/x*m,T=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(E));if(!T)continue;const M=this.clampAbstractPoint(T.u,T.v,T.lightness),P=M.u*this.state.transform.scale+this.state.transform.offsetX,A=M.v*this.state.transform.scale+this.state.transform.offsetY;S.push({x:P,y:A,isOnPlane:Math.abs(T.lightness-this.state.viewLightness)<1e-10})}if(S.length<2)continue;const I=S.every(b=>b.isOnPlane);n.strokeStyle="black",n.lineWidth=Hs,n.globalAlpha=I?.7:.4,n.setLineDash(I?[]:ni),n.beginPath(),n.moveTo(S[0].x,S[0].y);for(let b=1;b<S.length;b++)n.lineTo(S[b].x,S[b].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(a,r,c,l),n.clip(),this.state.points.forEach(d=>{const f=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,h=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(f>=a-De&&f<=a+c+De&&h>=r-De&&h<=r+l+De){const u=this.abstractToRgb(d.hsPos.u,d.hsPos.v,d.lightness),{r:p,g,b:y}=this.clampColor(u),m=this.state.selectedPointIds.has(d.id),x=d.id===this.state.lastSelectedPointId,S=Math.abs(d.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),d.order){case 0:this._drawCircle(n,f,h,De);break;case 1:this._drawDroplet(n,f,h,De);break;case 3:this._drawTriangle(n,f,h,De);break;default:this._drawCircle(n,f,h,De)}n.globalAlpha=d.alpha,n.fillStyle=`rgb(${p}, ${g}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=m?la:"black",n.lineWidth=x?Fr:Hs,n.setLineDash(S?[]:ni),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(De*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=t.width-s,c=o,l=t.height-s,d=r-a,f=l-c;let h=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(h=p.lightness)}const u=l-h*f;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.lightness*f,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:I}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),E=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,I,b,E,p.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=Hs;const s=this.state.points,i=s.length;if(n==="hs"){t.restore();return}const o=Math.ceil(De*2.2),a=Math.ceil(it/2),r=o+a,c=r,l=t.canvas.height-o,d=t.canvas.width-r-o,f=l-r,h=c+d;if(d<=0){t.restore();return}const u=this.state.isCyclic?i:i-1;for(let p=0;p<u;p++){const g=s[p],y=s[(p+1)%i],m=Math.max(g.order,y.order),x=this.state.isCyclic&&p===i-1;if(m===0){const S=l-g[n]*f,I=l-y[n]*f,b=c+g.pos*d,E=c+y.pos*d;if(x&&g.pos>y.pos){let T=g.pos,M=y.pos+1;const P=T+(M-T)*.5,A=c+(P-Math.floor(P))*d,v=this.getInterpolatedPropertiesAt(g.pos),w=this.getInterpolatedPropertiesAt(y.pos);if(v){const _=this.abstractToRgb(v.u,v.v,v.lightness),C=this.clampColor(_);t.strokeStyle=`rgba(${C.r},${C.g},${C.b},${v.alpha})`,t.setLineDash([]),P>1?(t.beginPath(),t.moveTo(b,S),t.lineTo(h,S),t.stroke(),t.beginPath(),t.moveTo(c,S),t.lineTo(A,S),t.stroke()):(t.beginPath(),t.moveTo(b,S),t.lineTo(A,S),t.stroke())}if(w){const _=this.abstractToRgb(w.u,w.v,w.lightness),C=this.clampColor(_);t.strokeStyle=`rgba(${C.r},${C.g},${C.b},${w.alpha})`,t.setLineDash([]),P>1?(t.beginPath(),t.moveTo(A,I),t.lineTo(E,I),t.stroke()):(t.beginPath(),t.moveTo(A,I),t.lineTo(h,I),t.stroke(),t.beginPath(),t.moveTo(c,I),t.lineTo(E,I),t.stroke())}t.beginPath(),t.setLineDash(ni),t.strokeStyle="black",t.moveTo(A,S),t.lineTo(A,I),t.stroke()}else if(!x){let T=g.pos,M=y.pos;const P=T+(M-T)*.5,A=c+P*d,v=this.getInterpolatedPropertiesAt(g.pos),w=this.getInterpolatedPropertiesAt(y.pos);if(v){const _=this.abstractToRgb(v.u,v.v,v.lightness),C=this.clampColor(_);t.strokeStyle=`rgba(${C.r},${C.g},${C.b},${v.alpha})`,t.setLineDash([]);const D=p===0&&!this.state.isCyclic?c:b;t.beginPath(),t.moveTo(D,S),t.lineTo(A,S),t.stroke()}if(w){const _=this.abstractToRgb(w.u,w.v,w.lightness),C=this.clampColor(_);t.strokeStyle=`rgba(${C.r},${C.g},${C.b},${w.alpha})`,t.setLineDash([]);const D=p===u-1&&!this.state.isCyclic?h:E;t.beginPath(),t.moveTo(A,I),t.lineTo(D,I),t.stroke()}t.beginPath(),t.setLineDash(ni),t.strokeStyle="black",t.moveTo(A,S),t.lineTo(A,I),t.stroke()}}else if(t.setLineDash([]),x&&g.pos>y.pos){const S=l-g[n]*f,I=l-y[n]*f,b=c+g.pos*d,E=c+y.pos*d,T=1-g.pos;if(T>1e-6){const M=t.createLinearGradient(b,0,h,0),P=Math.max(2,Math.ceil(T*20));for(let w=0;w<=P;w++){const _=g.pos+w/P*T,C=this.getInterpolatedPropertiesAt(_);if(C){const D=this.abstractToRgb(C.u,C.v,C.lightness),{r:O,g:F,b:V}=this.clampColor(D);M.addColorStop(w/P,`rgba(${O}, ${F}, ${V}, ${C.alpha})`)}}const A=this.getInterpolatedPropertiesAt(1),v=A?l-A[n]*f:S;t.beginPath(),t.moveTo(b,S),t.lineTo(h,v),t.strokeStyle=M,t.stroke()}if(y.pos>1e-6){const M=t.createLinearGradient(c,0,E,0),P=Math.max(2,Math.ceil(y.pos*20));for(let w=0;w<=P;w++){const _=w/P*y.pos,C=this.getInterpolatedPropertiesAt(_);if(C){const D=this.abstractToRgb(C.u,C.v,C.lightness),{r:O,g:F,b:V}=this.clampColor(D);M.addColorStop(w/P,`rgba(${O}, ${F}, ${V}, ${C.alpha})`)}}const A=this.getInterpolatedPropertiesAt(0),v=A?l-A[n]*f:I;t.beginPath(),t.moveTo(c,v),t.lineTo(E,I),t.strokeStyle=M,t.stroke()}}else if(!x){const S=c+g.pos*d,I=c+y.pos*d,b=(E,T,M,P)=>{const A=T-E;if(Math.abs(A)<1e-9)return;const v=t.createLinearGradient(M,0,P,0),w=Math.ceil(Math.abs(P-M)/2);for(let _=0;_<=w;_++){const C=E+_/w*A,D=this.getInterpolatedPropertiesAt(C);if(!D)continue;const O=this.abstractToRgb(D.u,D.v,D.lightness),{r:F,g:V,b:N}=this.clampColor(O);v.addColorStop(_/w,`rgba(${F}, ${V}, ${N}, ${D.alpha})`)}t.beginPath();for(let _=0;_<=w;_++){const C=E+_/w*A,D=this.getInterpolatedPropertiesAt(C);if(!D)continue;const O=Math.max(0,Math.min(1,C)),F=c+O*d,V=l-D[n]*f;_===0?t.moveTo(F,V):t.lineTo(F,V)}t.strokeStyle=v,t.stroke()};if(p===0&&!this.state.isCyclic&&Math.abs(g.pos)>=1e-6){const E=this.getInterpolatedPropertiesAt(g.pos);if(E){const T=this.abstractToRgb(E.u,E.v,E.lightness),{r:M,g:P,b:A}=this.clampColor(T);t.strokeStyle=`rgba(${M}, ${P}, ${A}, ${E.alpha})`;const v=l-E[n]*f;t.beginPath(),t.moveTo(c,v),t.lineTo(S,v),t.stroke()}}if(b(g.pos,y.pos,S,I),p===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const E=this.getInterpolatedPropertiesAt(y.pos);if(E){const T=this.abstractToRgb(E.u,E.v,E.lightness),{r:M,g:P,b:A}=this.clampColor(T);t.strokeStyle=`rgba(${M}, ${P}, ${A}, ${E.alpha})`;const v=l-E[n]*f;t.beginPath(),t.moveTo(I,v),t.lineTo(h,v),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const s=t.lightness<.05||t.lightness>.95,i=n.lightness<.05||n.lightness>.95;if(s&&i)return!0;const o=10;for(let a=0;a<=o;a++){const r=a/o,c=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*r,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*r,d=t.lightness+(n.lightness-t.lightness)*r,f=this.abstractToRgb(c,l,d);if(!this.isValidColor(f.r,f.g,f.b))return!1}return!0}drawInterpolatedPath(t,n,s,i){const o=s.pos-n.pos;if(o<1e-6)return;const a=Math.max(2,Math.ceil(o*t.canvas.width/4));let r=!1;for(let c=0;c<=a;c++){const l=n.pos+c/a*o,d=this.getInterpolatedPropertiesAt(l);if(!d)continue;const f=this.clampAbstractPoint(d.u,d.v,d.lightness),h=f.u*this.state.transform.scale+this.state.transform.offsetX,u=f.v*this.state.transform.scale+this.state.transform.offsetY;!r||c===0?(t.moveTo(h,u),r=!0):t.lineTo(h,u)}}drawHSSegment(t,n,s,i,o){let a=n.pos,r=s.pos;this.state.isCyclic&&r<a&&(r+=1);const c=r-a;if(c<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(c*t.canvas.width/8)),d=[];for(let h=0;h<=l;h++){const u=a+h/l*c,p=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!p)continue;const g=this.clampAbstractPoint(p.u,p.v,p.lightness),y=g.u*this.state.transform.scale+this.state.transform.offsetX,m=g.v*this.state.transform.scale+this.state.transform.offsetY,x=Math.abs(p.lightness-this.state.viewLightness)<1e-10;d.push({x:y,y:m,isOnPlane:x,u:g.u,v:g.v})}if(d.length<2)return;if(d.every(h=>h.isOnPlane)){t.strokeStyle="black",t.lineWidth=Hs,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let h=1;h<d.length;h++)t.lineTo(d[h].x,d[h].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=Hs,t.globalAlpha=.4;const h=Math.sqrt((s.hsPos.u-n.hsPos.u)**2+(s.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+h*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let p=1;p<d.length;p++)t.lineTo(d[p].x,d[p].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const s=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<s;i++){const o=this.state.points[i],a=this.state.points[(i+1)%this.state.points.length];if(Math.max(o.order,a.order)===0)continue;const c=Math.abs(o.lightness-this.state.viewLightness)<1e-10,l=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&l)continue;const d=o.lightness,f=a.lightness,h=this.state.viewLightness;if(d<h&&f>h||d>h&&f<h){const u=this.findLightnessIntersection(o,a,h);if(u!==null){let p=a.pos-o.pos;this.state.isCyclic&&a.pos<o.pos&&(p+=1);const g=o.pos+u*p,y=this.getInterpolatedPropertiesAt(g);if(!y)continue;const m=this.clampAbstractPoint(y.u,y.v,y.lightness),x=m.u*this.state.transform.scale+this.state.transform.offsetX,S=m.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(x,S,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,s){const i=t.lightness,o=n.lightness;if(Math.abs(o-i)<1e-10)return null;if(Math.max(t.order,n.order)===1){const f=(s-i)/(o-i);return f>0&&f<1?f:null}let r=0,c=1;const l=25;for(let f=0;f<l;f++){const h=(r+c)/2,u=t.pos+(n.pos-t.pos)*h,p=this.getInterpolatedPropertiesAt(u);if(!p)break;if(Math.abs(p.lightness-s)<1e-10)return h;p.lightness<s?o>i?r=h:c=h:o>i?c=h:r=h}const d=(r+c)/2;return d>.01&&d<.99?d:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const s=t.canvas,i=Math.ceil(De*2.2),o=Math.ceil(it/2),a=i+o;t.save(),t.strokeStyle="white",t.lineWidth=1;const r=a,c=s.width-i,l=a,d=s.height-i,f=c-r,h=d-l;this.clearTickLabels(s);const u=[0,.2,.4,.6,.8,1],p=["0","0.2","0.4","0.6","0.8","1"],g=s.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,m=window.pageYOffset||document.documentElement.scrollTop;for(let x=0;x<u.length;x++){const S=u[x],I=Math.floor(r+S*f)+.5;S===0?(t.beginPath(),t.moveTo(I,l),t.lineTo(I,d+5),t.stroke()):(t.beginPath(),t.moveTo(I,d),t.lineTo(I,d+5),t.stroke());const b=g.left+y+I,E=g.top+m+d+8;this.createKaTeXLabel(p[x],b,E,"bottom",s)}for(let x=0;x<u.length;x++){const S=u[x],I=Math.floor(d-S*h)+.5;S===0?(t.beginPath(),t.moveTo(r-5,I),t.lineTo(c,I),t.stroke()):(t.beginPath(),t.moveTo(r-5,I),t.lineTo(r,I),t.stroke());const b=g.left+y+r-8,E=g.top+m+I;this.createKaTeXLabel(p[x],b,E,"left",s)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(s=>s.remove())}createKaTeXLabel(t,n,s,i,o){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,katex.render(t,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,s,i,o)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(De*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=t.width-s,c=o,l=t.height-s,d=r-a,f=l-c;let h=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(h=p.alpha)}const u=l-h*f;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.alpha*f,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:I}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),E=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,I,b,E,p.order)})}_drawCircle(t,n,s,i){t.arc(n,s,i,0,2*Math.PI)}_drawJoukowsky(t,n,s,i,o){const r=[];let c=1/0,l=-1/0,d=1/0,f=-1/0;for(let m=0;m<=50;m++){const x=m/50*2*Math.PI,S=Math.cos(x),I=Math.sin(x),b=1-o+o*S,E=o*I,T=b*b+E*E;if(Math.abs(T)<1e-9)continue;const M=o*I-o*I/T,P=o*S+b/T;r.push({x:M,y:P}),M<c&&(c=M),M>l&&(l=M),P<d&&(d=P),P>f&&(f=P)}const h=f-d,u=i*2.5/h,p=(l+c)/2,g=(f+d)/2;t.beginPath();const y=r[0];t.moveTo(n+(y.x-p)*u,s-(y.y-g)*u);for(let m=1;m<r.length;m++){const x=r[m];t.lineTo(n+(x.x-p)*u,s-(x.y-g)*u)}t.closePath()}_drawDroplet(t,n,s,i){this._drawJoukowsky(t,n,s,i,.6666666666666666)}_drawTriangle(t,n,s,i){const o=i*1.4;t.moveTo(n,s-o),t.lineTo(n+o*Math.sqrt(3)/2,s+o/2),t.lineTo(n-o*Math.sqrt(3)/2,s+o/2),t.closePath()}drawPoint(t,n,s,i,o,a,r,c,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,s,De);break;case 1:this._drawDroplet(t,n,s,De);break;case 3:this._drawTriangle(t,n,s,De);break;default:this._drawCircle(t,n,s,De)}t.fillStyle=`rgb(${i}, ${o}, ${a})`,t.fill(),t.strokeStyle=r?la:"black",t.lineWidth=c?Fr:Hs,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,s=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){s||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!s){const{lightness:o,hsPos:a}=t,r=this.abstractToRgb(a.u,a.v,o);if(i){const{r:c,g:l,b:d}=this.clampColor(r);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=d}else{const c=this.rgbToHsl(r.r,r.g,r.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:s}=t.parentElement;(t.width!==n||t.height!==s)&&(t.width=n,t.height=s);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),this.drawCheckerboard(i);const o=this.getLastSelectedPoint();if(o){const{hsPos:a,lightness:r,alpha:c}=o,l=this.abstractToRgb(a.u,a.v,r),{r:d,g:f,b:h}=this.clampColor(l);i.fillStyle=`rgba(${d}, ${f}, ${h}, ${c})`,i.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,s=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let i=0;i<n;i++){const o=i/(n-1),a=this.getInterpolatedPropertiesAt(o);if(!a)continue;const r=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(r.u,r.v,a.lightness),{r:l,g:d,b:f}=this.clampColor(c);t.fillStyle=`rgba(${l}, ${d}, ${f}, ${a.alpha})`,t.fillRect(i,0,1,s)}}getInterpolatedPropertiesAt(t){const n=this.state.points,s=n.length;if(s===0)return null;if(s===1){const h=n[0];return{u:h.hsPos.u,v:h.hsPos.v,lightness:h.lightness,alpha:h.alpha,order:h.order}}const i=this.state.isCyclic,o=i?(t%1+1)%1:t;let a,r,c=-1;for(let h=0;h<s-1;h++)if(o>=n[h].pos&&o<=n[h+1].pos){c=h,a=n[h],r=n[h+1];break}if(c===-1)if(i)c=s-1,a=n[s-1],r=n[0];else{const h=o<n[0].pos?n[0]:n[s-1];return{u:h.hsPos.u,v:h.hsPos.v,lightness:h.lightness,alpha:h.alpha,order:h.order}}if(!a||!r)return null;let l=r.pos-a.pos;if(i&&c===s-1&&(l+=1),Math.abs(l)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let d;i&&c===s-1?d=o>=a.pos?(o-a.pos)/l:(o+1-a.pos)/l:d=(o-a.pos)/l;const f=Math.max(a.order,r.order);if(f===0){const h=d<.5?a:r;return{u:h.hsPos.u,v:h.hsPos.v,lightness:h.lightness,alpha:h.alpha,order:h.order}}if(f===3){const h=this.evaluateCubicSpline(c,d);if(h){const u=Math.max(0,Math.min(1,h.lightness)),p=Math.max(0,Math.min(1,h.alpha)),g=this.clampAbstractPoint(h.u,h.v,u);return{u:g.u,v:g.v,lightness:u,alpha:p,order:2}}}return{u:a.hsPos.u+(r.hsPos.u-a.hsPos.u)*d,v:a.hsPos.v+(r.hsPos.v-a.hsPos.v)*d,lightness:a.lightness+(r.lightness-a.lightness)*d,alpha:a.alpha+(r.alpha-a.alpha)*d,order:1}}abstractToRgb(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,s);const i=this.rgbCubeAbstractToRgb(t,n,s);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE"){const h=Math.sqrt(t*t+n*n),u=1-Math.abs(2*s-1);return h>u&&u>1e-6?{u:t/h*u,v:n/h*u}:{u:t,v:n}}if(s<=.01||s>=.99)return{u:0,v:0};let{r:i,g:o,b:a}=this.abstractToRgb(t,n,s);if(this.isValidColor(i,o,a))return{u:t,v:n};let r=0,c=0,l=1/0;const d=Math.max(Math.abs(t),Math.abs(n),.5),f=50;for(let h=0;h<=f;h++)for(let u=0;u<=f;u++){const p=t+(h/f-.5)*2*d,g=n+(u/f-.5)*2*d,y=this.abstractToRgb(p,g,s);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((p-t)**2+(g-n)**2);m<l&&(l=m,r=p,c=g)}}return l<1/0?{u:r,v:c}:{u:0,v:0}}hslToRgb(t,n,s){if(n===0)return{r:s,g:s,b:s};const i=s<.5?s*(1+n):s+n-s*n,o=2*s-i,a=(d,f,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<1/6?d+(f-d)*6*h:h<1/2?f:h<2/3?d+(f-d)*(2/3-h)*6:d),r=a(o,i,t+1/3),c=a(o,i,t),l=a(o,i,t-1/3);return{r,g:c,b:l}}rgbToHsl(t,n,s){const i=Math.max(t,n,s),o=Math.min(t,n,s);let a=0,r=0,c=(i+o)/2;if(i!==o){const l=i-o;switch(r=c>.5?l/(2-i-o):l/(i+o),i){case t:a=(n-s)/l+(n<s?6:0);break;case n:a=(s-t)/l+2;break;case s:a=(t-n)/l+4;break}a/=6}return{h:a,s:r,l:c}}drawCheckerboard(t){const n=t.canvas.width,s=t.canvas.height,i=n/it,o=s/it;t.fillStyle=ca,t.fillRect(0,0,n,s),t.fillStyle=da;for(let a=0;a<o;a++)for(let r=0;r<i;r++)(a+r)%2===0&&t.fillRect(r*it,a*it,it,it)}findClosestValidPoint(t,n,s){const i=Math.ceil(De*2.2),o=Math.ceil(it/2),a=i+o,r=a,c=a,l=this.elements.hsBgCanvas.width-a-i,d=this.elements.hsBgCanvas.height-a-i,f=Math.max(r,Math.min(r+l,t)),h=Math.max(c,Math.min(c+d,n)),{scale:u,offsetX:p,offsetY:g}=this.state.transform,y=(f-p)/u,m=(h-g)/u,x=this.abstractToRgb(y,m,s);if(this.isValidColor(x.r,x.g,x.b))return{x:f,y:h};if(this.state.colorSpace==="HSL_DI_CONE"){const S=Math.sqrt(y*y+m*m),I=1-Math.abs(2*s-1);if(S>I&&I>1e-6){const b=y/S*I,E=m/S*I;return{x:b*u+p,y:E*u+g}}return{x:f,y:h}}return this.findClosestPointOnRgbGamut(y,m,s,u,p,g,r,c,l,d)}getGamutVerticesRgb(t){const n=[],s=r=>r>=-1e-6&&r<=1.000001,i=(r,c)=>Math.abs(r.r-c.r)<1e-6&&Math.abs(r.g-c.g)<1e-6&&Math.abs(r.b-c.b)<1e-6,o=(r,c,l)=>{if(s(r)&&s(c)&&s(l)){const d={r,g:c,b:l};n.some(f=>i(f,d))||n.push(d)}},a=3*t;return o(a,0,0),o(0,a,0),o(0,0,a),o(1,a-1,0),o(1,0,a-1),o(a-1,1,0),o(0,1,a-1),o(a-1,0,1),o(0,a-1,1),o(1,1,a-2),o(1,a-2,1),o(a-2,1,1),n}rgbCubeAbstractToRgb(t,n,s){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},o={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=s+t*i.x+n*o.x,r=s+t*i.y+n*o.y,c=s+t*i.z+n*o.z;return{r:a,g:r,b:c}}findClosestPointOnRgbGamut(t,n,s,i,o,a,r,c,l,d){let f=t,h=n,u=1/0;const p=.5,g=50;for(let x=0;x<=g;x++)for(let S=0;S<=g;S++){const I=t+(x/g-.5)*2*p,b=n+(S/g-.5)*2*p,E=this.abstractToRgb(I,b,s);if(this.isValidColor(E.r,E.g,E.b)){const T=Math.sqrt((I-t)**2+(b-n)**2);T<u&&(u=T,f=I,h=b)}}if(u<1/0){const x=this.refineClosestPoint(t,n,f,h,s);f=x.u,h=x.v}const y=f*i+o,m=h*i+a;return{x:Math.max(r,Math.min(r+l,y)),y:Math.max(c,Math.min(c+d,m))}}refineClosestPoint(t,n,s,i,o){let a=s,r=i,c=.02;for(let l=0;l<5;l++){let d=!1;const f=20;for(let h=0;h<=f;h++)for(let u=0;u<=f;u++){const p=a+(h/f-.5)*2*c,g=r+(u/f-.5)*2*c,y=this.abstractToRgb(p,g,o);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((a-t)**2+(r-n)**2);Math.sqrt((p-t)**2+(g-n)**2)<m&&(a=p,r=g,d=!0)}}if(c*=.5,!d)break}return{u:a,v:r}}findClosestPointOnPolygon(t,n){let s=null,i=1/0;for(let o=0;o<n.length;o++){const a=n[o],r=n[(o+1)%n.length],c=r.x-a.x,l=r.y-a.y;let d;if(c===0&&l===0)d=a;else{const h=((t.x-a.x)*c+(t.y-a.y)*l)/(c*c+l*l);h<0?d=a:h>1?d=r:d={x:a.x+h*c,y:a.y+h*l}}const f=(t.x-d.x)**2+(t.y-d.y)**2;f<i&&(i=f,s=d)}return s}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const s=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=s.u,t.hsPos.v=s.v}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(De*2.2),a=Math.ceil(it/2),r=o+a,c=i.height-r-o,l=i.height-o,d=s==="lightness"?l-this.state.viewLightness*c:l-this.state.viewAlpha*c;let f=Math.abs(n-d)<=Br,h=null;for(let u=0;u<this.state.points.length;u++){const p=this.state.points[u],g=i.width-r-o,y=r+p.pos*g,m=s==="lightness"?l-p.lightness*c:l-p.alpha*c;if(Math.sqrt((t-y)**2+(n-m)**2)<=fa){h=p;break}}return{hitPoint:h,hitLine:f}}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(De*2.2),a=i.height-2*o,r=i.height-o,c=s==="lightness"?r-this.state.viewLightness*a:r-this.state.viewAlpha*a;let l=Math.abs(n-c)<=Br,d=null;for(let f=0;f<this.state.points.length;f++){const h=this.state.points[f],u=i.width-2*o,p=o+h.pos*u,g=s==="lightness"?r-h.lightness*a:r-h.alpha*a;if(Math.sqrt((t-p)**2+(n-g)**2)<=fa){d=h;break}}return{hitPoint:d,hitLine:l}}createNewPointHS(t,n){const s=Math.ceil(De*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=o,c=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;if(t<a||t>a+c||n<r||n>r+l)return;const d=(t-this.state.transform.offsetX)/this.state.transform.scale,f=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:h,viewAlpha:u}=this.state,{r:p,g,b:y}=this.abstractToRgb(d,f,h);if(this.isValidColor(p,g,y)){this.markAsDirty();const m=this.state.points.length;m>0&&this.state.points.forEach(S=>{S.pos=S.pos-S.pos/m});const x={id:Date.now(),hsPos:{u:d,v:f},originalHsPos:{u:d,v:f},lightness:h,alpha:u,pos:m===0?.5:1,order:1};this.state.points.push(x),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(x.id),this.state.lastSelectedPointId=x.id,this.drawAll()}}handleLineDrag(t,n,s){const i=s.startsWith("lightness")?"lightness":"alpha",o=s.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(De*2.2),r=Math.ceil(it/2),c=a+r,l=n-c-a,f=(this.findSnapPosition(t,n,i)-c)/l,h=Math.max(0,Math.min(1,1-f));this.state[o]=h,this.drawAll()}handlePointDrag(t,n,s,i){const o=this.getPointById(this.state.activeDrag.pointId);o&&(i==="hs"?this.handleHSPointDrag(t,n):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(o,t,n,s,i),this.drawAll())}handleHSPointDrag(t,n){const{startX:s,startY:i,initialPointPositions:o}=this.state.activeDrag,{scale:a,offsetX:r,offsetY:c}=this.state.transform,l=Math.ceil(De*2.2),d=Math.ceil(it/2),f=l+d,h=f,u=f,p=this.elements.hsBgCanvas.width-f-l,g=this.elements.hsBgCanvas.height-f-l,y=t-s,m=n-i;this.state.points.forEach(x=>{if(o.has(x.id)){const S=o.get(x.id),I=S.x+y,b=S.y+m,E=Math.max(h,Math.min(h+p,I)),T=Math.max(u,Math.min(u+g,b)),M=this.findClosestValidPoint(E,T,x.lightness),P=(M.x-r)/a,A=(M.y-c)/a;x.hsPos={u:P,v:A};const v=this.abstractToRgb(P,A,x.lightness);this.isValidColor(v.r,v.g,v.b)&&(x.originalHsPos={u:P,v:A})}})}adjustPointForNewLightness(t,n){const s=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(s.r,s.g,s.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}handleSliderPointDrag(t,n,s,i,o){const{offsets:a}=this.state.activeDrag,r=Math.ceil(De*2.2),c=Math.ceil(it/2),l=r+c;i.width-r,i.height-r;const d=this.findSnapPosition(s,i.height,o,t.id),f=l,h=i.width-r,u=l,p=i.height-r,g=h-f,y=p-u,m=(d-u)/y,x=Math.max(0,Math.min(1,1-m));let S=(n-f)/g,I=S;this.state.isCyclic?(S<0?I=1+S:S>1&&(I=S-1),I=this.wrapPositionCyclic(I)):I=Math.max(0,Math.min(1,S));for(const b of this.state.points)if(a.has(b.id)){const E=a.get(b.id),T=x+E[o];let M=I+E.pos;if(this.state.isCyclic?M=this.wrapPositionCyclic(M):M=Math.max(0,Math.min(1,M)),b.pos=M,o==="lightness"){const P=Math.max(0,Math.min(1,T));b.lightness=P;const A=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,P);if(this.isValidColor(A.r,A.g,A.b))b.hsPos={...b.originalHsPos};else{const v=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,P);b.hsPos.u=v.u,b.hsPos.v=v.v}this.state.viewLightness=P}else b.alpha=Math.max(0,Math.min(1,T)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const Wc=[5,4],er=16,Kc=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],Xr=e=>{const t=[{power:3,value:e[0]},{power:2,value:e[1]},{power:1,value:e[2]},{power:0,value:e[3]}],n=s=>Number(s.toFixed(6));return t.filter(s=>Math.abs(s.value)>1e-10).map((s,i)=>{const o=s.value<0?"-":"+",a=Math.abs(s.value),r=n(a),c=s.power===0?"":`t^${s.power}`,l=s.power===0?`${r}`:`${r}${c}`;return i===0?s.value<0?`-${l}`:`${l}`:`${o} ${l}`}).join(" ").replace(/t\^1\b/g,"t")},qc=(e,t,n,s,i)=>{const o=[t.x,n.x,s.x,i.x],a=[t.y,n.y,s.y,i.y],r=e.map(l=>l.reduce((d,f,h)=>d+f*o[h],0)),c=e.map(l=>l.reduce((d,f,h)=>d+f*a[h],0));return{x:r,y:c}},jc=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c};function Uc(e,t=!1,n=er){if(e.length<2)return e;const s=[],i=e.length,o=t?i:i-1;for(let a=0;a<o;a++){const r=e[a],c=e[(a+1)%i],l=a===0?0:1;for(let d=l;d<=n;d++){const f=d/n;s.push({x:r.x+(c.x-r.x)*f,y:r.y+(c.y-r.y)*f})}}return s}const an=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},vi=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Jc=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},Ms=(e,t,n,s,i,o,a,r=null)=>{const c=i*.5;if(c<=1e-6)return;const l={x:c,y:c},d=Math.PI,f=-Math.PI/2,h=Jc(d,f),u=Math.max(2,o);for(let p=a?0:1;p<=u;p++){const g=p/u,y=d+h*g,m={x:l.x+Math.cos(y)*c,y:l.y+Math.sin(y)*c},x={x:t.x+n.x*m.x+s.x*m.y,y:t.y+n.y*m.x+s.y*m.y};r?r(x):e.push(x)}};function Yr(e,t=!1,n="relative",s=0,i=er,o=!1,a=!1,r=!1,c=!1){if(e.length<2)return e;if(s<=1e-6)return t?[...e,e[0]]:[...e];const l=e.length,d=[],f=[],h=n==="fixed"?"absolute":n,u=h==="absolute"?"relative":h,p=I=>{const b=e[(I-1+l)%l],E=e[I],T=e[(I+1)%l],M=vi(b,E),P=vi(T,E),A=Math.hypot(M.x,M.y),v=Math.hypot(P.x,P.y);if(A<=1e-6||v<=1e-6)return null;let w,_,C;const D=Math.min(A,v)*.5;if(u==="absolute"?(w=Math.max(0,Math.min(1,s)),_=an(P),C=an(M)):(h==="absolute"?w=Math.max(0,Math.min(s,D))*2:w=Math.max(0,Math.min(1,s)),_=h==="absolute"?an(P):P,C=h==="absolute"?an(M):M),w<=1e-6)return null;const O=w*.5,F=r?-O:h==="absolute"?A*.5:.5,V=r?-O:h==="absolute"?v*.5:.5,N={x:E.x+C.x*F,y:E.y+C.y*F},$={x:E.x+_.x*V,y:E.y+_.y*V},L=an(C),k=an(_),R={x:L.x+k.x,y:L.y+k.y},X=Math.hypot(R.x,R.y),z=X>1e-6?{x:R.x/X,y:R.y/X}:{x:0,y:0},B=h==="absolute"?O:O*Math.min(A,v),Y={x:E.x-z.x*(B/Math.sqrt(2)),y:E.y-z.y*(B/Math.sqrt(2))},G={x:-L.y,y:L.x},W={x:-k.y,y:k.x},oe=G.x*z.x+G.y*z.y<0?{x:-G.x,y:-G.y}:G,U=W.x*z.x+W.y*z.y<0?{x:-W.x,y:-W.y}:W,te=(h==="absolute"?O:O*A)/Math.sqrt(2),J=(h==="absolute"?O:O*v)/Math.sqrt(2),Q={x:E.x+L.x*(A*.5)+oe.x*te,y:E.y+L.y*(A*.5)+oe.y*te},ee={x:E.x+k.x*(v*.5)+U.x*J,y:E.y+k.y*(v*.5)+U.y*J},ne={x:E.x+C.x*O,y:E.y+C.y*O},ie={x:E.x+_.x*O,y:E.y+_.y*O};return{index:I,origin:E,axisX:_,axisY:C,baseScale:w,radius:O,edgeInIndex:(I-1+l)%l,edgeOutIndex:I,midIn:N,midOut:$,arcStart:ne,arcEnd:ie,bisectorOuter:Y,midInOrtho:Q,midOutOrtho:ee}},g=(I,b=null,E=null)=>{if(!c){d.push({x:I.x,y:I.y});return}d.push({x:I.x,y:I.y,tag:b||void 0,edgeIndex:E??void 0})},y=I=>g(I,"arc"),m=(I,b)=>{!r||I.radius<=1e-6||(b?(g(I.midInOrtho,"line",I.edgeInIndex),g(I.bisectorOuter,"corner")):(g(I.bisectorOuter,"corner"),g(I.midOutOrtho,"line",I.edgeOutIndex)))};if(t){for(let b=0;b<l;b++){const E=p(b);E&&f.push(E)}if(!f.length)return[...e,e[0]];if(r){const b=f[0];g(b.arcStart,"line",b.edgeInIndex),Ms(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!1,y);for(let E=1;E<f.length;E++){const T=f[E];g(T.arcStart,"line",T.edgeInIndex),Ms(d,T.origin,T.axisX,T.axisY,T.baseScale,i,!1,y)}return g({...b.arcStart},"line",b.edgeInIndex),d}const I=f[0];return g(I.midIn,"line",I.edgeInIndex),m(I,!0),f.forEach((b,E)=>{E>0&&(g(b.midIn,"line",b.edgeInIndex),m(b,!0)),Ms(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!0,y),m(b,!1),g(b.midOut,"line",b.edgeOutIndex),g(b.origin,"corner")}),g({...I.midIn},"line",I.edgeInIndex),d}if(u==="absolute"){for(let E=1;E<l-1;E++){const T=p(E);T&&f.push(T)}if(!f.length)return[...e];const I=f[0];g(e[0],"line",0),I&&g(I.midIn,"line",I.edgeInIndex),m(I,!0),f.forEach((E,T)=>{T>0&&(g(E.midIn,"line",E.edgeInIndex),m(E,!0)),Ms(d,E.origin,E.axisX,E.axisY,E.baseScale,i,!0,y),m(E,!1),g(E.midOut,"line",E.edgeOutIndex)});const b=f[f.length-1];return b&&g(b.midOut,"line",b.edgeOutIndex),g(e[l-1],"line",l-2),d}if(r){for(let b=1;b<l-1;b++){const E=p(b);E&&f.push(E)}if(!f.length)return[...e];g(e[0],"line",0);const I=f[0];g(I.arcStart,"line",I.edgeInIndex),Ms(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!1,y);for(let b=1;b<f.length;b++){const E=f[b];g(E.arcStart,"line",E.edgeInIndex),Ms(d,E.origin,E.axisX,E.axisY,E.baseScale,i,!1,y)}return g(e[l-1],"line",l-2),d}for(let I=1;I<l-1;I++){const b=p(I);b&&f.push(b)}if(!f.length)return[...e];const x=f[0],S=f[f.length-1];return g(e[0],"line",0),g(x.midIn,"line",x.edgeInIndex),f.forEach((I,b)=>{b>0&&g(I.midIn,"line",I.edgeInIndex),m(I,!0),Ms(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!0,y),m(I,!1),g(I.midOut,"line",I.edgeOutIndex)}),g(S.midOut,"line",S.edgeOutIndex),g(e[l-1],"line",l-2),d}function Zc(e,t=!1,n="relative",s=0){if(e.length<3)return[];if(s<=1e-6)return[];const i=e.length,o=[],a=n==="fixed"?"absolute":n,r=a==="absolute"?"relative":a,c=t?i:i-1;for(let l=1;l<c;l++){const d=e[(l-1+i)%i],f=e[l],h=e[(l+1)%i],u=vi(d,f),p=vi(h,f),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)continue;const m=Math.min(g,y)*.5;let x,S,I;if(r==="absolute"){const z=Math.min(g,y);x=Math.max(0,Math.min(s,z*.5))*2,S=an(p),I=an(u)}else x=a==="absolute"?Math.max(0,Math.min(s,m))*2:Math.max(0,Math.min(1,s)),S=a==="absolute"?an(p):p,I=a==="absolute"?an(u):u;if(x<=1e-6)continue;const b=x*.5,E=an(I),T=an(S),M={x:E.x+T.x,y:E.y+T.y},P=Math.hypot(M.x,M.y),A=P>1e-6?{x:M.x/P,y:M.y/P}:{x:0,y:0},v=a==="absolute"?b:b*Math.min(g,y),w=t?(()=>{let z=0;for(let B=0;B<i;B++){const Y=e[B],G=e[(B+1)%i];z+=Y.x*G.y-G.x*Y.y}return z})():1,_=(f.x-d.x)*(h.y-f.y)-(f.y-d.y)*(h.x-f.x),D=(w>=0?_>=0:_<=0)?-1:1,O={x:f.x+A.x*v*D,y:f.y+A.y*v*D},F={x:-E.y,y:E.x},V={x:-T.y,y:T.x},N=F.x*A.x+F.y*A.y<0?{x:-F.x,y:-F.y}:F,$=V.x*A.x+V.y*A.y<0?{x:-V.x,y:-V.y}:V,L=(a==="absolute"?b:b*g)/Math.sqrt(2),k=(a==="absolute"?b:b*y)/Math.sqrt(2),R={x:f.x+E.x*(g*.5)+N.x*L,y:f.y+E.y*(g*.5)+N.y*L},X={x:f.x+T.x*(y*.5)+$.x*k,y:f.y+T.y*(y*.5)+$.y*k};o.push(O,R,X)}return o}function Gr(e,t=.5,n=!1,s=er,i={}){if(e.length<2)return e;const o=[],a=Math.max(0,Math.min(1,t)),r=(1-a)*.5,c=Kc(r),l=i?.logSegments??!1,d=i?.label??"Catmull-Rom",f=(u,p,g,y,m)=>{const x=m*m,S=x*m,I=2*S-3*x+1,b=S-2*x+m,E=-2*S+3*x,T=S-x;return{x:I*u.x+b*g.x+E*p.x+T*y.x,y:I*u.y+b*g.y+E*p.y+T*y.y}};return jc(e,n).forEach(({index:u,p0:p,p1:g,p2:y,p3:m})=>{if(l){const b=qc(c,p,g,y,m);console.groupCollapsed(`${d} segment ${u}`),console.log("Matrix M (rows t^3,t^2,t,1; cols P0..P3):",c),console.log("P0..P3:",p,g,y,m),console.log(`tension: ${a}, tau: ${r}`),console.log("P(t) = [t^3 t^2 t 1] * M * [P0 P1 P2 P3]"),console.log(`x(t) = ${Xr(b.x)}`),console.log(`y(t) = ${Xr(b.y)}`),console.groupEnd()}const x=u===0?0:1,S={x:(y.x-p.x)*r,y:(y.y-p.y)*r},I={x:(m.x-g.x)*r,y:(m.y-g.y)*r};for(let b=x;b<=s;b++){const E=b/s;o.push(f(g,y,S,I,E))}}),o}const Qc={id:null,preset:"closed",type:"spline",mode:"piecewise",order:3,tension:.5,radiusMode:"absolute",radiusValue:.5,relRadiusValue:.5,absRadiusValue:.5,linearStyle:"lines",nurbsDegree:3,pointHandling:"anchor"},ji=500,qs=e=>Math.max(0,Math.min(1,e)),Al=e=>Math.max(0,Math.min(ji,e)),si=e=>{const t=qs(Number(e)||0);return t*t*ji},zr=e=>{const t=Al(Number(e)||0);return Math.sqrt(t/ji)},Hr=[{id:"closed",label:"Closed"},{id:"open",label:"Open"},{id:"figure8",label:"Figure 8"},{id:"branching",label:"Branching"},{id:"branching4",label:"Branching (4)"},{id:"branching5",label:"Branching (5)"}],ed=[{id:"linear",label:"Linear"},{id:"spline",label:"Spline"},{id:"radius",label:"Radius"}];class td{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:this._createStyle(),previewPoints:this._createDefaultPresetPoints()},this.wrapper=null,this.elements={},this.previewCards=new Map,this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this._renderAllPreviews())}show(t=null){this.state.style=this._normalizeStyle(t),this._updateUIFromState(),this.wrapper.style.display="block",requestAnimationFrame(()=>{this._renderAllPreviews()})}hide(){this.wrapper&&(this.wrapper.style.display="none")}_createStyle(){return{...Qc,id:`style_${Date.now()}`}}_normalizeStyle(t){const n=this._createStyle();if(!t)return n;const i=Number(t.order)===3?3:1;let o=t.type==="px_radius"?"abs_radius":t.type,a=t.radiusMode==="fixed"?"absolute":t.radiusMode,r=t.pointHandling;o==="cubic_spline"?(o="spline",r="anchor"):o==="circular_arc"?o="radius":o==="linear"&&(o="linear"),o==="catmull"?(o="spline",r="anchor"):o==="nurbs"?(o="spline",r="control"):o==="linear"?(o="spline",r="anchor"):o==="rel_radius"?(o="radius",a="relative"):o==="abs_radius"&&(o="radius",a="absolute");const c=t.relRadiusValue??(a==="relative"?qs(t.radiusValue):n.relRadiusValue),l=t.absRadiusValue??(a==="absolute"?zr(t.radiusValue):n.absRadiusValue),d=a==="relative"?c:si(l);return o||(t.mode==="radius"?o="radius":i===3&&t.tension!==void 0?(o="spline",r="anchor"):i===3?o="spline":(o="spline",r="anchor")),{...n,...t,id:t.id||n.id,preset:t.preset||n.preset,order:i,type:o||n.type,radiusMode:a||n.radiusMode,radiusValue:d,relRadiusValue:c,absRadiusValue:l,linearStyle:t.linearStyle||n.linearStyle,nurbsDegree:t.nurbsDegree||n.nurbsDegree,pointHandling:o==="spline"?"anchor":r??t.pointHandling??n.pointHandling}}_createDefaultPresetPoints(){const t={x:.6,y:.25},n={x:.55,y:.45},s={x:.55,y:.5},i=[{x:.2,y:.2},{x:.8,y:.25},{x:.7,y:.6},{x:.5,y:.45},{x:.3,y:.75}],o=[{x:.05,y:.8},{x:.25,y:.4},{x:.45,y:.7},{x:.65,y:.2},{x:.85,y:.55}],a=[{x:.72,y:.5},{x:.61,y:.31},{x:.39,y:.31},{x:.28,y:.5},{x:.39,y:.69},{x:.61,y:.69},{x:.5,y:.5}];return{closed:{vertices:i,edges:i.map((r,c)=>[c,(c+1)%i.length])},open:{vertices:o,edges:o.slice(0,-1).map((r,c)=>[c,c+1])},figure8:{vertices:a,edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0],[0,6],[6,3]],faces:[[0,1,2,3,4,5]]},branching:[[{x:.1,y:.85},{x:.3,y:.6},{x:.5,y:.4},t],[t,{x:.75,y:.15},{x:.9,y:.1}],[t,{x:.75,y:.35},{x:.9,y:.45}]],branching4:{in:[[{x:.12,y:.15},{x:.32,y:.3},n],[{x:.18,y:.75},{x:.35,y:.58},n]],out:[[n,{x:.75,y:.25},{x:.92,y:.2}],[n,{x:.75,y:.6},{x:.9,y:.72}]]},branching5:{in:[[{x:.1,y:.25},{x:.32,y:.38},s],[{x:.18,y:.8},{x:.35,y:.64},s]],out:[[s,{x:.78,y:.25},{x:.92,y:.2}],[s,{x:.78,y:.5},{x:.92,y:.52}],[s,{x:.78,y:.78},{x:.9,y:.85}]]}}}_initializeDOM(){const t=(T,M={})=>{const P=document.createElement(T);if(M.id){P.id=M.id;const A=M.id.replace(/-(\w)/g,(v,w)=>w.toUpperCase());this.elements[A]=P}return M.className&&(P.className=M.className),M.text&&(P.textContent=M.text),M.type&&(P.type=M.type),M.value!==void 0&&(P.value=M.value),M.attrs&&Object.entries(M.attrs).forEach(([A,v])=>P.setAttribute(A,v)),P};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"interpolation-editor-layout"}),s=t("div",{className:"editor-panel preview-panel"});s.append(t("div",{className:"panel-header",text:"Preview Presets"}));const i=t("div",{className:"preview-list"});Hr.forEach(T=>{const M=t("button",{className:"preview-card",attrs:{"data-preset":T.id,type:"button"}}),P=t("div",{className:"preview-card-label",text:T.label}),A=t("canvas",{className:"preview-card-canvas"});M.append(A,P),i.append(M),this.previewCards.set(T.id,{card:M,canvas:A})}),s.append(i);const o=t("div",{className:"editor-panel type-panel"});o.append(t("div",{className:"panel-header",text:"Interpolation Type"}));const a=t("div",{className:"toggle-stack",id:"type-list"});ed.forEach(T=>{const M=t("button",{className:"toggle-row",text:T.label,attrs:{"data-type":T.id,type:"button"}});a.append(M)}),o.append(a);const r=t("div",{className:"editor-panel params-panel"});r.append(t("div",{className:"panel-header",text:"Parameters"}));const c=t("div",{className:"param-section",id:"tension-section"});c.append(t("div",{className:"section-caption",text:"Catmull-Rom tension."}));const l=t("div",{className:"param-row"});this.elements.tensionSlider=t("input",{id:"tension-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.tensionInput=t("input",{id:"tension-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),l.append(this.elements.tensionSlider,this.elements.tensionInput),c.append(l);const d=t("div",{className:"param-section",id:"linear-section"});d.append(t("div",{className:"section-caption",text:"Linear marker style."}));const f=t("div",{className:"param-row"}),h=t("div",{className:"toggle-group",id:"linear-style-toggle"});h.append(t("button",{className:"toggle-button",text:"Lines",attrs:{"data-linear-style":"lines",type:"button"}}),t("button",{className:"toggle-button",text:"Arrows",attrs:{"data-linear-style":"arrows",type:"button"}})),f.append(h),d.append(f);const u=t("div",{className:"param-section",id:"handling-section"});u.append(t("div",{className:"section-caption",text:"Point handling."}));const p=t("div",{className:"param-row"}),g=t("div",{className:"toggle-group",id:"point-handling-toggle"});g.append(t("button",{className:"toggle-button",text:"Control",attrs:{"data-point-handling":"control",type:"button"}}),t("button",{className:"toggle-button",text:"Anchor",attrs:{"data-point-handling":"anchor",type:"button"}}),t("button",{className:"toggle-button",text:"Mixed",attrs:{"data-point-handling":"mixed",type:"button"}})),p.append(g),u.append(p);const y=t("div",{className:"param-section",id:"radius-section"});y.append(t("div",{className:"section-caption",text:"Clamped to half each adjacent edge."}));const m=t("div",{className:"param-row"});this.elements.radiusSlider=t("input",{id:"radius-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.radiusInput=t("input",{id:"radius-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),m.append(this.elements.radiusSlider,this.elements.radiusInput),y.append(m);const x=t("div",{className:"toggle-group",id:"radius-mode-toggle"});x.append(t("button",{className:"toggle-button",text:"Relative",attrs:{"data-radius-mode":"relative",type:"button"}}),t("button",{className:"toggle-button",text:"Absolute",attrs:{"data-radius-mode":"absolute",type:"button"}})),y.append(x);const S=t("div",{className:"param-section",id:"nurbs-section"});S.append(t("div",{className:"section-caption",text:"NURBS degree."}));const I=t("div",{className:"param-row"});this.elements.nurbsDegreeSlider=t("input",{id:"nurbs-degree-slider",type:"range",attrs:{min:"2",max:"5",step:"1"}}),this.elements.nurbsDegreeInput=t("input",{id:"nurbs-degree-input",type:"number",attrs:{min:"2",max:"5",step:"1"}}),I.append(this.elements.nurbsDegreeSlider,this.elements.nurbsDegreeInput),S.append(I),r.append(d,u,c,y,S);const b=t("div",{className:"editor-panel actions-panel"});b.append(t("div",{className:"panel-header",text:"Actions"}));const E=t("div",{className:"button-row"});this.elements.closeButton=t("button",{id:"close-button",className:"editor-button secondary",text:"Close",attrs:{type:"button"}}),this.elements.selectButton=t("button",{id:"select-button",className:"editor-button primary",text:"Select",attrs:{type:"button"}}),E.append(this.elements.closeButton,this.elements.selectButton),b.append(E),n.append(s,o,r,b),this.wrapper.append(n),this.container.appendChild(this.wrapper)}_setupEventListeners(){window.addEventListener("resize",()=>{this.wrapper&&this.wrapper.style.display!=="none"&&this._renderAllPreviews()}),this.previewCards.forEach((o,a)=>{o.card.addEventListener("click",()=>{this._setStyle({preset:a})}),o.canvas.addEventListener("mousedown",r=>{this._handlePreviewMouseDown(r,a)})}),this.wrapper.querySelector("#type-list").querySelectorAll(".toggle-row").forEach(o=>{o.addEventListener("click",()=>{this._applyTypeSelection(o.dataset.type)})}),this.wrapper.querySelector("#linear-style-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({linearStyle:o.dataset.linearStyle})})}),this.wrapper.querySelector("#point-handling-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({pointHandling:o.dataset.pointHandling})})}),this.elements.radiusSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyRadiusValue(a,!0)}),this.elements.radiusInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyRadiusValue(a,!1)}),this.wrapper.querySelector("#radius-mode-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._applyRadiusMode(o.dataset.radiusMode)})}),this.elements.tensionSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyTensionValue(a,!0)}),this.elements.tensionInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyTensionValue(a,!1)}),this.elements.nurbsDegreeSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyNurbsDegreeValue(a,!0)}),this.elements.nurbsDegreeInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyNurbsDegreeValue(a,!1)}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{this.onSelect(this._exportStyleForHost()),this.hide()}),window.addEventListener("mousemove",o=>{this._handlePreviewMouseMove(o)}),window.addEventListener("mouseup",()=>{this._handlePreviewMouseUp()})}_setStyle(t){this.state.style={...this.state.style,...t},this._updateUIFromState(),this._renderAllPreviews()}_exportStyleForHost(){const{id:t,name:n,type:s,tension:i,radiusMode:o,radiusValue:a,pointHandling:r,order:c,preset:l,mode:d,linearStyle:f}=this.state.style,h={id:t,name:n,order:c,preset:l,mode:d,linearStyle:f};return s==="spline"?{...h,type:"cubic_spline",cornerHandling:"pass_through",tension:Number(i??.5)}:s==="radius"?{...h,type:"circular_arc",cornerHandling:r==="mixed"?"mixed":"cut_all",radiusMode:o,radiusValue:a}:{...h,type:"linear",cornerHandling:"pass_through"}}_applyRadiusValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};if(s.radiusMode==="relative"){const i=qs(t);s.radiusValue=i,s.relRadiusValue=i}else{const i=n?qs(t):zr(t);s.absRadiusValue=i,s.radiusValue=si(i)}this.state.style=s,n?this.elements.radiusInput.value=s.radiusValue.toFixed(s.radiusMode==="absolute"?0:2):this.elements.radiusSlider.value=s.radiusMode==="absolute"?s.absRadiusValue:s.radiusValue,this._updateUIFromState(),this._renderAllPreviews()}_applyTensionValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.tension=Math.max(0,Math.min(1,t)),this.state.style=s,n?this.elements.tensionInput.value=s.tension.toFixed(2):this.elements.tensionSlider.value=s.tension,this._updateUIFromState(),this._renderAllPreviews()}_applyRadiusMode(t){if(t!=="relative"&&t!=="absolute")return;const n={...this.state.style};n.radiusMode=t,t==="relative"?n.radiusValue=n.relRadiusValue??n.radiusValue:n.radiusValue=si(n.absRadiusValue??n.radiusValue),this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_applyNurbsDegreeValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.nurbsDegree=Math.max(2,Math.min(5,Math.round(t))),this.state.style=s,n?this.elements.nurbsDegreeInput.value=s.nurbsDegree:this.elements.nurbsDegreeSlider.value=s.nurbsDegree,this._updateUIFromState()}_applyTypeSelection(t){const n={...this.state.style,type:t};switch(t){case"linear":n.mode="piecewise",n.order=1,n.pointHandling="anchor";break;case"spline":n.mode="piecewise",n.order=3,n.pointHandling="anchor";break;case"radius":n.mode="radius",n.radiusMode=n.radiusMode||"relative",n.radiusValue=n.radiusMode==="relative"?n.relRadiusValue??n.radiusValue:si(n.absRadiusValue??n.radiusValue),n.pointHandling=n.pointHandling==="mixed"?"mixed":"control";break}this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_updateUIFromState(){const{preset:t,mode:n,order:s,radiusMode:i,radiusValue:o,tension:a,type:r,linearStyle:c,nurbsDegree:l,pointHandling:d}=this.state.style;this.previewCards.forEach((y,m)=>{y.card.classList.toggle("is-active",m===t)}),this.wrapper.querySelectorAll("#type-list .toggle-row").forEach(y=>{y.classList.toggle("is-active",y.dataset.type===r)}),this.wrapper.querySelectorAll("#linear-style-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.linearStyle===c)}),this.wrapper.querySelectorAll("#point-handling-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.pointHandling===d)});const f=this.wrapper.querySelector("#linear-section"),h=this.wrapper.querySelector("#handling-section"),u=this.wrapper.querySelector("#tension-section"),p=this.wrapper.querySelector("#radius-section"),g=this.wrapper.querySelector("#nurbs-section");f.classList.toggle("is-hidden",r!=="linear"),h.classList.toggle("is-hidden",!0),u.classList.toggle("is-hidden",r!=="spline"),p.classList.toggle("is-hidden",r!=="radius"),g.classList.toggle("is-hidden",!0),this.wrapper.querySelectorAll("#radius-mode-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.radiusMode===i)}),i==="absolute"?(this.elements.radiusSlider.value=qs(this.state.style.absRadiusValue),this.elements.radiusInput.value=Al(o).toFixed(0),this.elements.radiusInput.min="0",this.elements.radiusInput.max=String(ji),this.elements.radiusInput.step="1"):(this.elements.radiusSlider.value=qs(o),this.elements.radiusInput.value=Number(this.elements.radiusSlider.value).toFixed(2),this.elements.radiusInput.min="0",this.elements.radiusInput.max="1",this.elements.radiusInput.step="0.01"),this.elements.tensionSlider.value=Math.max(0,Math.min(1,a)),this.elements.tensionInput.value=Number(a).toFixed(2),this.elements.nurbsDegreeSlider.value=l,this.elements.nurbsDegreeInput.value=l}_renderAllPreviews(){Hr.forEach(t=>{const n=this.previewCards.get(t.id);n&&this._renderPreviewCard(n.canvas,t.id,t.id===this.state.style.preset)})}_renderPreviewCard(t,n,s){const i=t.getBoundingClientRect(),o=window.devicePixelRatio||1,a=Math.max(1,Math.floor(i.width*o)),r=Math.max(1,Math.floor(i.height*o));(t.width!==a||t.height!==r)&&(t.width=a,t.height=r);const c=t.getContext("2d");c.save(),c.scale(o,o),c.clearRect(0,0,i.width,i.height),c.fillStyle="#1f2937",c.fillRect(0,0,i.width,i.height),this._drawPreset(c,i.width,i.height,n,s),c.restore()}_drawPreset(t,n,s,i,o){const r=n-32,c=s-32,l=v=>({x:16+v.x*r,y:16+v.y*c}),d=this._getPresetPoints(i),f=o?"#3b82f6":"#6b7280",h=o?"#60a5fa":"#94a3b8";t.lineWidth=this._getStrokeWidth(),t.lineJoin=this.state.style.mode==="radius"?"round":"miter",t.lineCap="round",t.strokeStyle=f;const u=[],p=new Set,g=new Set,y=v=>{p.has(v)||(p.add(v),u.push(v))},m=this.state.style.mode==="radius"&&i==="branching",x=(v,w,_)=>{const C=_.x-w.x,D=_.y-w.y,O=v.x-w.x,F=v.y-w.y,V=C*C+D*D;return V<1e-6?0:(O*C+F*D)/V},S=v=>{if(!v)return 0;const w=Math.hypot(v.b.x-v.a.x,v.b.y-v.a.y);return w<=1e-6?0:this.state.style.radiusMode==="relative"?Math.max(0,Math.min(.5,this.state.style.radiusValue*.5)):Math.max(0,Math.min(.5,this.state.style.radiusValue/w))},I=(v,w,_,C,D)=>{if(v.length<3||!C)return v;const O=S(C),F=_?D?0:.5:O,V=_?1-O:D?1:.5,N=v.filter($=>{if($.tag==="line"&&$.edgeIndex!==void 0){if($.edgeIndex!==w)return!0;const L=x($,C.a,C.b);return L>=F&&L<=V}return $.tag!=="line"});return N.length>=2,N},b=d.faces&&d.vertices?d.vertices:null,E=d.faces||null,T=!!(b&&E&&E.length);let M=null,P=null;const A=Math.hypot(r,c);if(d.paths.forEach((v,w)=>{const _=v.points,C=_.map(l);if(_.forEach(y),w===0&&i==="closed"&&(console.groupCollapsed("anchor-control-debug"),console.log("mode",this.state.style.mode),console.log("type",this.state.style.type),console.log("pointHandling",this.state.style.pointHandling),console.log("radiusMode",this.state.style.radiusMode),console.log("radiusValue",this.state.style.radiusValue)),C.length>=2){t.save(),t.lineWidth=Math.max(1,this._getStrokeWidth()*.6),t.strokeStyle="#94a3b8",t.lineCap="round",t.lineJoin="round",t.setLineDash(Wc);const O=[];for(let F=0;F<C.length-1;F++)m&&i==="branching"&&w===0&&F===C.length-2||O.push([C[F],C[F+1]]);v.closed&&O.push([C[C.length-1],C[0]]),O.forEach(([F,V])=>{const N=Math.round(F.x),$=Math.round(F.y),L=Math.round(V.x),k=Math.round(V.y),R=`${N}:${$}`,X=`${L}:${k}`,z=R<X?`${R}|${X}`:`${X}|${R}`;g.has(z)||(g.add(z),t.beginPath(),t.moveTo(F.x,F.y),t.lineTo(V.x,V.y),t.stroke())}),t.restore()}let D=this._getInterpolatedPoints(C,v.closed,A);if(D.length<2){w===0&&i==="closed"&&(console.log("drawPoints empty"),console.groupEnd());return}if(w===0&&i==="closed"){const O=D.reduce((V,N)=>({x:Math.min(V.x,N.x),y:Math.min(V.y,N.y)}),{x:1/0,y:1/0}),F=D.reduce((V,N)=>({x:Math.max(V.x,N.x),y:Math.max(V.y,N.y)}),{x:-1/0,y:-1/0});console.log("drawPoints bounds",{min:O,max:F}),console.groupEnd()}if(m){const O=6+this.state.style.order*4,F=this.state.style.pointHandling==="control";D=Yr(C,v.closed,this.state.style.radiusMode,this.state.style.radiusValue,O,!1,!1,F,!0);const V=v.trueEndpointStart===!0,N=v.trueEndpointEnd===!0;if(w===0){const $=C.length>=2?{a:C[0],b:C[1]}:null;D=I(D,0,!0,$,V);const L=C.length>=2?{a:C[C.length-2],b:C[C.length-1]}:null;D=I(D,C.length-2,!1,L,N)}else{const $=C.length>=2?{a:C[0],b:C[1]}:null,L=C.length>=2?{a:C[C.length-2],b:C[C.length-1]}:null;D=I(D,0,!0,$,V),D=I(D,C.length-2,!1,L,N)}if(D.length<2)return;D=D.map($=>({x:$.x,y:$.y}))}if(this.state.style.mode!=="radius"&&(this.state.style.type!=="spline"||v.forceTrim)){if(v.trimFromPoint){const O=l(v.trimFromPoint);let F=0,V=1/0;D.forEach((N,$)=>{const L=Math.hypot(N.x-O.x,N.y-O.y);L<V&&(V=L,F=$)}),D=D.slice(F),!D.length||Math.hypot(D[0].x-O.x,D[0].y-O.y)>1e-6?D.unshift(O):D[0]=O}if(v.trimToPoint){const O=l(v.trimToPoint);let F=0,V=1/0;D.forEach((N,$)=>{const L=Math.hypot(N.x-O.x,N.y-O.y);L<V&&(V=L,F=$)}),D=D.slice(0,F+1),!D.length||Math.hypot(D[D.length-1].x-O.x,D[D.length-1].y-O.y)>1e-6?D.push(O):D[D.length-1]=O}}if(!(D.length<2)){if(t.beginPath(),t.moveTo(D[0].x,D[0].y),D.slice(1).forEach(O=>t.lineTo(O.x,O.y)),v.closed&&(this.state.style.mode!=="radius"||this.state.style.radiusValue<=1e-6)&&t.closePath(),t.stroke(),v.isBoundary&&v.closed?(M=D,P=new Set(_)):!T&&i==="closed"&&v.closed&&!Object.prototype.hasOwnProperty.call(v,"isBoundary")&&(M=D),this.state.style.mode==="radius"&&this.state.style.pointHandling==="anchor"){const O=Zc(C,v.closed,this.state.style.radiusMode,this.state.style.radiusValue);O.length&&(t.save(),t.fillStyle="#f87171",O.forEach(F=>{t.beginPath(),t.arc(F.x,F.y,3,0,Math.PI*2),t.fill()}),t.restore())}this.state.style.type==="linear"&&this.state.style.linearStyle==="arrows"&&this._drawEdgeArrows(t,C,v.closed)}}),M&&M.length>=2&&(t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)",t.beginPath(),t.moveTo(M[0].x,M[0].y),M.slice(1).forEach(v=>t.lineTo(v.x,v.y)),t.closePath(),t.fill(),t.restore()),T){t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)";let v=!1;E.forEach(w=>{if(!Array.isArray(w)||w.length<3)return;const _=w.map(F=>b[F]).filter(Boolean);if(_.length<3)return;const C=P?_.every(F=>P.has(F)):!1;if(C&&M&&!v){t.beginPath(),t.moveTo(M[0].x,M[0].y),M.slice(1).forEach(F=>t.lineTo(F.x,F.y)),t.closePath(),t.fill(),v=!0;return}if(C&&M)return;const D=_.map(l),O=this._getInterpolatedPoints(D,!0,A);!O||O.length<2||(t.beginPath(),t.moveTo(O[0].x,O[0].y),O.slice(1).forEach(F=>t.lineTo(F.x,F.y)),t.closePath(),t.fill())}),t.restore()}t.fillStyle=h,u.map(l).forEach(v=>{t.beginPath(),t.arc(v.x,v.y,3.5,0,Math.PI*2),t.fill()})}_getStrokeWidth(){return 2}_drawEdgeArrows(t,n,s){if(n.length<2)return;const i=10,o=6,a=n.length,r=s?a:a-1;t.save(),t.fillStyle=t.strokeStyle;for(let c=0;c<r;c++){const l=n[c],d=n[(c+1)%a],f=d.x-l.x,h=d.y-l.y,u=Math.hypot(f,h);if(u<.001)continue;const p=f/u,g=h/u,y=d,m={x:y.x-p*i,y:y.y-g*i},x={x:m.x+-g*(o/2),y:m.y+p*(o/2)},S={x:m.x+g*(o/2),y:m.y-p*(o/2)};t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(x.x,x.y),t.lineTo(S.x,S.y),t.closePath(),t.fill()}t.restore()}_getInterpolatedPoints(t,n,s=1){const{mode:i,order:o,type:a,pointHandling:r,nurbsDegree:c,radiusMode:l,radiusValue:d}=this.state.style;if(i==="radius"||t.length<2){if(i==="radius"){const u=6+o*4,p=d;return p<=1e-6?t:Yr(t,n,l,p,u,!1,!1,r==="control")}return t}const f=4+o*4;if(a==="linear"||o===1)return Uc(t,n,f);if(t.length<3)return t;const h=this.state.style.tension??.5;return Gr(t,h,n,f)}_buildControlCatmullTargets(t,n){if(t.length<2)return t;const s=[],i=t.length,o=n?i:i-1;n||s.push(t[0]);for(let a=0;a<o;a++){const r=t[a],c=t[(a+1)%i];s.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5})}return n||s.push(t[i-1]),s}_buildMixedCatmullTargets(t,n){if(t.length<2)return t;const s=this._getPathOrientation(t,n),i=[],o=t.length;for(let a=0;a<o;a++){if(!n&&(a===0||a===o-1)){i.push(t[a]);continue}const r=t[(a-1+o)%o],c=t[a],l=t[(a+1)%o],d=(c.x-r.x)*(l.y-c.y)-(c.y-r.y)*(l.x-c.x);(s>=0?d>=0:d<=0)?i.push(c):(i.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5}),i.push({x:(c.x+l.x)*.5,y:(c.y+l.y)*.5}))}return i}_buildMixedControlPoints(t,n,s){if(t.length<3)return t;const i=this._getPathOrientation(t,n),o=Math.max(0,s-1),a=[];n?t.length:t.length-1;for(let r=0;r<t.length;r++){const c=(r-1+t.length)%t.length,l=(r+1)%t.length,d=t[c],f=t[r],h=t[l],u=(f.x-d.x)*(h.y-f.y)-(f.y-d.y)*(h.x-f.x),g=!n&&(r===0||r===t.length-1)||(i>=0?u>=0:u<=0);if(a.push(f),g)for(let y=0;y<o;y++)a.push({x:f.x,y:f.y})}return a}_getPathOrientation(t,n){if(!n)return 1;let s=0;for(let i=0;i<t.length;i++){const o=t[(i+1)%t.length];s+=t[i].x*o.y-o.x*t[i].y}return s}_getPresetPoints(t){const n=this.state.previewPoints[t];if(n&&n.vertices&&n.edges)return this._buildPathsFromGraph(n);if(t==="open")return{paths:this.state.previewPoints.open.map(s=>({closed:!1,points:s}))};if(t==="branching"){const s=this.state.previewPoints.branching[0]||[],i=s.length>=1?s[s.length-1]:null,o=s.length>=2?s[s.length-2]:null,a=this.state.style.type==="spline",r=a?s.slice(Math.max(0,s.length-3)):s.slice(Math.max(0,s.length-2));return{paths:this.state.previewPoints.branching.map((c,l)=>{if(l===0)return{closed:!1,points:c,trimToPoint:a?o:null,forceTrim:a,trueEndpointStart:!0,trueEndpointEnd:!1};const d=[...r],f=c[0],u=i&&f&&Math.abs(f.x-i.x)<1e-6&&Math.abs(f.y-i.y)<1e-6?c.slice(1):c;return d.push(...u),{closed:!1,points:d,trimFromPoint:a?o:i,forceTrim:a,trueEndpointStart:!1,trueEndpointEnd:!0}})}}if(t==="branching4"){const s=this.state.previewPoints.branching4;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[],a=d=>{const f=Math.hypot(d.x,d.y);return f>1e-6?{x:d.x/f,y:d.y/f}:{x:0,y:0}},r=i.map(d=>{if(d.length<2)return null;const f=d[d.length-1],h=d[d.length-2];return a({x:f.x-h.x,y:f.y-h.y})}),c=o.map(d=>{if(d.length<2)return null;const f=d[0],h=d[1];return a({x:h.x-f.x,y:h.y-f.y})});if(i.length!==1&&o.length!==1){const d=[];if(i.length===2&&o.length===2){const h=this.dragState?.presetId==="branching4"&&this.dragState.pointIndex!==null,u=A=>h?(this.branching4Pairing||(this.branching4Pairing=A),this.branching4Pairing):(this.branching4Pairing=null,A),p=r.map(A=>A?{x:-A.x,y:-A.y}:null),g=A=>Math.atan2(A.y,A.x),y=(A,v)=>{const w=p[A],_=c[v];return!w||!_?-1/0:w.x*_.x+w.y*_.y},m=(A,v)=>A.x*v.y-A.y*v.x,S=[{type:"in",idx:0,dir:p[0]},{type:"in",idx:1,dir:p[1]},{type:"out",idx:0,dir:c[0]},{type:"out",idx:1,dir:c[1]}].filter(A=>A.dir).slice().sort((A,v)=>g(A.dir)-g(v.dir)),I=S.map((A,v)=>A.type==="in"?v:null).filter(A=>A!==null),b=I.length===2&&(Math.abs(I[0]-I[1])===1||Math.abs(I[0]-I[1])===3),E=A=>y(0,A[0])+y(1,A[1]),T=[0,1],M=[1,0];let P=T;if(b){const A=(C,D)=>{const O=Math.abs(C-D);return Math.min(O,4-O)},v=C=>S.findIndex(D=>D.type==="out"&&D.idx===C),w=C=>S.findIndex(D=>D.type==="in"&&D.idx===C),_=C=>{const D=A(w(0),v(C[0])),O=A(w(1),v(C[1]));return D+O};P=_(M)>_(T)?M:T}else{const A=E(T),v=E(M);if(v===A&&this.state.style.type==="spline"){const w=_=>{const C=p[0]&&c[_[0]]?Math.sign(m(p[0],c[_[0]])):0,D=p[1]&&c[_[1]]?Math.sign(m(p[1],c[_[1]])):0;return(C<0?1:0)+(D<0?1:0)};P=w(M)>w(T)?M:T}else P=v>A?M:T}return P=u(P),i.forEach((A,v)=>{const w=P[v],_=o[w],C=_[0]===A[A.length-1]?_.slice(1):_;d.push({closed:!1,points:[...A,...C]})}),{paths:d}}const f=new Set;return i.forEach((h,u)=>{let p=-1,g=-1/0;const y=r[u];if(o.forEach((m,x)=>{if(f.has(x))return;const S=c[x];if(!y||!S)return;const I=y.x*S.x+y.y*S.y;I>g&&(g=I,p=x)}),p>=0){f.add(p);const m=o[p],x=m[0]===h[h.length-1]?m.slice(1):m;d.push({closed:!1,points:[...h,...x]})}else d.push({closed:!1,points:h})}),o.forEach((h,u)=>{f.has(u)||d.push({closed:!1,points:h})}),{paths:d}}const l=[];return i.length===1?o.forEach(d=>{const f=i[0],h=d[0]===f[f.length-1]?d.slice(1):d;l.push({closed:!1,points:[...f,...h]})}):i.forEach(d=>{const f=o[0],h=f[0]===d[d.length-1]?f.slice(1):f;l.push({closed:!1,points:[...d,...h]})}),{paths:l}}if(t==="branching5"){const s=this.state.previewPoints.branching5;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[];return{paths:[...i.map(r=>({closed:!1,points:r})),...o.map(r=>({closed:!1,points:r}))]}}return{paths:[{closed:!0,points:this.state.previewPoints.closed[0]}]}}_buildPathsFromGraph(t){const n=t.vertices||[],s=t.edges||[];if(!n.length||!s.length)return{paths:[]};const i=new Map,o=new Map,a=new Map;s.forEach(([k,R])=>{i.has(k)||i.set(k,[]),i.get(k).push(R),o.has(R)||o.set(R,[]),o.get(R).push(k),a.set(k,(a.get(k)||0)+1),a.set(R,(a.get(R)||0)+1)});const r=new Map,c=new Map,l=(k,R)=>k<R?`${k}-${R}`:`${R}-${k}`;s.forEach(([k,R])=>{const X=l(k,R);c.has(X)||c.set(X,[k,R]),r.has(k)||r.set(k,new Set),r.has(R)||r.set(R,new Set),r.get(k).add(R),r.get(R).add(k)});const d=(k,R)=>Math.atan2(n[R].y-n[k].y,n[R].x-n[k].x),f=new Map;n.forEach((k,R)=>{const X=[...r.get(R)||[]];X.sort((z,B)=>d(R,z)-d(R,B)),f.set(R,X)});const h=(k,R)=>{const X=f.get(R)||[];if(!X.length)return null;const z=X.indexOf(k);return z<0?X[0]:X[(z-1+X.length)%X.length]},p=(()=>{const k=[],R=new Set,X=(z,B)=>`${z}->${B}`;return c.forEach(([z,B])=>{[[z,B],[B,z]].forEach(([Y,G])=>{const W=X(Y,G);if(R.has(W))return;const oe=[];let U=Y,te=G,J=0;for(;J++<s.length*4;){R.add(X(U,te)),oe.push(U);const Q=h(U,te);if(Q==null)break;const ee=te,ne=Q;if(U=ee,te=ne,U===Y&&te===G)break}oe.length>=3&&k.push(oe)})}),k})(),g=k=>[...k].sort((R,X)=>R-X).join("_"),y=[],m=new Set;p.forEach(k=>{const R=g(k);m.has(R)||(m.add(R),y.push(k))});const x=k=>{let R=0;for(let X=0;X<k.length;X++){const z=n[k[X]],B=n[k[(X+1)%k.length]];R+=z.x*B.y-B.x*z.y}return R*.5};let S=null;if(y.length){let k=null,R=-1/0;y.forEach(X=>{const z=Math.abs(x(X));z>R&&(R=z,k=X)}),S=k}const I=new Set(S||[]),b=new Set;if(S&&S.length>=2)for(let k=0;k<S.length;k++){const R=S[k],X=S[(k+1)%S.length];b.add(l(R,X))}const E=new Map,T=k=>Math.atan2(k.y,k.x),M=(k,R)=>k.x*R.y-k.y*R.x,P=(k,R)=>k.x*R.x+k.y*R.y,A=(k,R)=>({x:R.x-k.x,y:R.y-k.y}),v=k=>{const R=Math.hypot(k.x,k.y);return R>1e-6?{x:k.x/R,y:k.y/R}:{x:0,y:0}};n.forEach((k,R)=>{if(I.has(R))return;const X=o.get(R)||[],z=i.get(R)||[];if(X.length===2&&z.length===2){const B=X.map(le=>v(A(n[le],n[R]))),Y=z.map(le=>v(A(n[R],n[le]))),G=B.map(le=>({x:-le.x,y:-le.y})),W=(le,me)=>P(G[le],Y[me]),oe=[0,1],U=[1,0],te=W(0,0)+W(1,1),J=W(0,1)+W(1,0),ee=[{type:"in",idx:0,dir:G[0]},{type:"in",idx:1,dir:G[1]},{type:"out",idx:0,dir:Y[0]},{type:"out",idx:1,dir:Y[1]}].filter(le=>le.dir).slice().sort((le,me)=>T(le.dir)-T(me.dir)),ne=ee.map((le,me)=>le.type==="in"?me:null).filter(le=>le!==null),ie=ne.length===2&&(Math.abs(ne[0]-ne[1])===1||Math.abs(ne[0]-ne[1])===3);let de=oe;if(ie){const le=(qe,Ht)=>{const on=Math.abs(qe-Ht);return Math.min(on,4-on)},me=qe=>ee.findIndex(Ht=>Ht.type==="out"&&Ht.idx===qe),Te=qe=>ee.findIndex(Ht=>Ht.type==="in"&&Ht.idx===qe),ot=qe=>{const Ht=le(Te(0),me(qe[0])),on=le(Te(1),me(qe[1]));return Ht+on};de=ot(U)>ot(oe)?U:oe}else if(J===te&&this.state.style.type==="spline"){const le=me=>{const Te=Math.sign(M(G[0],Y[me[0]])),ot=Math.sign(M(G[1],Y[me[1]]));return(Te<0?1:0)+(ot<0?1:0)};de=le(U)>le(oe)?U:oe}else de=J>te?U:oe;X.forEach((le,me)=>{const Te=z[de[me]];E.set(`${le}->${R}`,Te)})}});const w=n.map((k,R)=>R).filter(k=>(o.get(k)||[]).length===0),_=[],C=new Set,D=(k,R)=>`${k}->${R}`,O=(k,R)=>b.has(l(k,R)),F=(k,R,X,z=!1)=>{const B=D(k,R);if(C.has(B)){_.push([...X,R]);return}C.add(B);const Y=[...X,R];if(!z&&I.has(R)&&Y.length>1){_.push(Y);return}const G=i.get(R)||[],W=o.get(R)||[],oe=E.get(`${k}->${R}`);if(oe!==void 0){if(Y.includes(oe)){_.push(Y);return}F(R,oe,Y);return}if(G.length===0){_.push(Y);return}if(W.length===2&&G.length>2){_.push(Y);return}if(W.length===1&&G.length>1){G.forEach(U=>{!z&&O(R,U)||F(R,U,Y,z)});return}if(W.length<=1&&G.length===1){if(!z&&O(R,G[0])){_.push(Y);return}F(R,G[0],Y,z);return}G.forEach(U=>{!z&&O(R,U)||F(R,U,Y,z)})};let V=null;if(S&&S.length>=3)V=[...S,S[0]],_.push(V),s.forEach(([k,R])=>{O(k,R)&&C.add(D(k,R))}),s.forEach(([k,R])=>{const X=D(k,R);C.has(X)||F(k,R,[k],!1)});else if(w.length)w.forEach(k=>{(i.get(k)||[]).forEach(X=>F(k,X,[k]))});else{const k=s[0]?.[0];k!==void 0&&(i.get(k)||[]).forEach(X=>F(k,X,[k]))}const N=_.map(k=>{const R=k.length>2&&k[0]===k[k.length-1],X=R?k.slice(0,-1):k,z=X.map(U=>n[U]),B=X[0],Y=X[X.length-1],G=a.get(B)||0,W=a.get(Y)||0,oe=k===V;return{closed:R,points:z,isBoundary:oe,trueEndpointStart:G===1,trueEndpointEnd:W===1,trimFromPoint:!oe&&this.state.style.type==="spline"&&G>2?n[B]:null,trimToPoint:!oe&&this.state.style.type==="spline"&&W>2?n[Y]:null,forceTrim:!oe&&this.state.style.type==="spline"}}),$=S?g(S):null,L=y.filter(k=>g(k)!==$);return{paths:N,vertices:n,faces:L}}_handlePreviewMouseDown(t,n){const s=this._findHitPoint(t,n);s&&(this.dragState=s,t.preventDefault())}_handlePreviewMouseMove(t){const{presetId:n,pathIndex:s,pointIndex:i,vertexIndex:o,ioType:a,ioIndex:r}=this.dragState;if(n===null)return;const c=this.previewCards.get(n);if(!c)return;const{x:l,y:d}=this._getNormalizedPoint(t,c.canvas),f={x:Math.max(0,Math.min(1,l)),y:Math.max(0,Math.min(1,d))},h=this.state.previewPoints[n];if(h&&h.in&&h.out&&a&&Number.isInteger(r)){const x=h[a]?.[r]?.[i];x&&(x.x=f.x,x.y=f.y,this._renderAllPreviews());return}if(h&&h.vertices&&h.edges){Number.isInteger(o)&&h.vertices[o]&&(h.vertices[o].x=f.x,h.vertices[o].y=f.y,h.pathOverrides&&delete h.pathOverrides,this._renderAllPreviews());return}const p=(h&&h.vertices&&h.edges?h.pathOverrides?.map(y=>y.points):this.state.previewPoints[n])?.[s];if(!p)return;const g=p[i];g?(g.x=f.x,g.y=f.y):p[i]=f,this._renderAllPreviews()}_handlePreviewMouseUp(){this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}_findHitPoint(t,n){const s=this.previewCards.get(n);if(!s)return null;const o=s.canvas.getBoundingClientRect(),a=t.clientX-o.left,r=t.clientY-o.top,c=16,l=o.width-c*2,d=o.height-c*2,f=8,h=this.state.previewPoints[n];if(h&&h.in&&h.out){const p=[...h.in.map((g,y)=>({points:g,ioType:"in",ioIndex:y})),...h.out.map((g,y)=>({points:g,ioType:"out",ioIndex:y}))];for(let g=0;g<p.length;g++){const{points:y,ioType:m,ioIndex:x}=p[g];for(let S=0;S<y.length;S++){const I=c+y[S].x*l,b=c+y[S].y*d;if(Math.hypot(a-I,r-b)<=f)return{presetId:n,pathIndex:g,pointIndex:S,vertexIndex:null,ioType:m,ioIndex:x}}}return null}const u=h&&h.vertices&&h.edges?this._getPresetPoints(n).paths.map(p=>p.points):this.state.previewPoints[n];for(let p=0;p<u.length;p++){const g=u[p];for(let y=0;y<g.length;y++){const m=c+g[y].x*l,x=c+g[y].y*d;if(Math.hypot(a-m,r-x)<=f){let S=null;return h&&h.vertices&&h.edges&&(S=h.vertices.indexOf(g[y]),S<0&&(S=null)),{presetId:n,pathIndex:p,pointIndex:y,vertexIndex:S,ioType:null,ioIndex:null}}}}return null}_getNormalizedPoint(t,n){const s=n.getBoundingClientRect(),i=16,o=s.width-i*2,a=s.height-i*2,r=(t.clientX-s.left-i)/o,c=(t.clientY-s.top-i)/a;return{x:r,y:c}}}function Co(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function nd(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,s=[];let i=0,o;for(;(o=n.exec(t))!==null;){const c=o[0],l=o.index;l>i&&s.push({type:"text",content:t.substring(i,l)}),c==="\\$"?s.push({type:"text",content:"$"}):s.push({type:"math",content:c}),i=l+c.length}i<t.length&&s.push({type:"text",content:t.substring(i)});const a=[];let r=null;for(const c of s)c.type==="text"?r===null?r={type:"text",content:c.content}:r.content+=c.content:(r!==null&&(a.push(r),r=null),a.push(c));return r!==null&&a.push(r),a.length===0&&s.length===1&&s[0].type==="text"?s:a}function sd(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let s=null,i=!1;if(t&&t[1]?.trim()?(s=t[1].trim(),i=!0):n&&n[1]?.trim()&&(s=n[1].trim(),i=!1),s===null)return`<span class="text-segment">${Co(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(s,{throwOnError:!1,displayMode:i,output:"html",strict:"warn"})}catch(o){return console.error("KaTeX renderToString unexpected error:",o),`<span class="katex-error" title="${Co(o.message||"Unknown KaTeX error")}">${Co(e)}</span>`}}function od(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const s=t==null?"":String(t);let i="";try{i=nd(s).map(a=>a.type==="text"?`<span class="text-segment">${Co(a.content)}</span>`:a.type==="math"?sd(a.content):"").join("")}catch(o){console.error("Error processing string segments for rendering:",o,s),i=`<span class="katex-error" title="${Co(String(o.message||"Unknown error"))}">Error</span>`}e.innerHTML=i}function id(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const s=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let i;const o=[];for(s.lastIndex=0;(i=s.exec(e))!==null;){const[,h,u,p,g,y,m,x,S,I,b,E]=i;let T={};if(h){const M=h.split("_"),P=M[0].slice(1),A=M[1].slice(1);T={type:"backslashSubscript",value:`\\mathrm{${P}}_\\mathrm{${A}}`}}else if(u)T={type:"doubleBackslash",value:"\\\\"};else if(p)T={type:"command",value:p};else if(g)T={type:"backslashLetter",value:g.slice(1)};else if(y){T={type:"word",value:y};const M=o[o.length-1],P=o[o.length-2],A=M?.type==="other"&&M.value==="{"&&P?.type==="command";T.isArgument=A}else m?T={type:"number",value:m}:x?T={type:"dollar",value:"\\$"}:S?T={type:"ampersand",value:"&"}:I?T={type:"space",value:" "}:b?T={type:"newline",value:"\\\\"}:E&&(T={type:"other",value:E});T.type&&o.push(T)}const a=["a","I"],r=["+","-","=","*","/","<",">"],c=(h,u)=>{let p=h+u;for(;p>=0&&p<o.length;){if(o[p].type!=="space")return o[p];p+=u}return null},l=h=>h?h.type==="other"&&r.includes(h.value):!1,d=h=>h?h.type==="backslashLetter"||h.type==="word"&&h.value.length===1&&!a.includes(h.value):!1;let f="";for(let h=0;h<o.length;h++){const u=o[h];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":f+=u.value;break;case"other":["#","%"].includes(u.value)?f+="\\"+u.value:f+=u.value;break;case"backslashLetter":f+=u.value;break;case"word":if(u.isArgument)f+=u.value;else if(u.value.length>1)f+=`\\mathrm{${u.value}}`;else{const x=o[h-1],S=o[h-2],I=x?.type==="other"&&x.value==="(",b=I&&S?.type==="space",E=I&&S?.type!=="space",T=c(h,-1),M=c(h,1),P=l(T)||l(M);b?f+=`\\mathrm{${u.value}}`:a.includes(u.value)?P||E?f+=u.value:f+=`\\mathrm{${u.value}}`:f+=u.value}break;case"space":let g=!0;const y=c(h,-1),m=c(h,1);if(!y||!m)g=!0;else{const x=d(y),S=d(m),I=l(y),b=l(m);(I||b)&&(g=!1),x&&S&&(g=!1)}f+=g?"\\ ":" ";break;default:f+=u.value;break}}if(f.endsWith("\\ ")){const h=f.match(/(\\ )+$/);if(h){const u=h[0].length/2,p="\\,".repeat(u);f=f.replace(/(\\ )+$/,p)}}return f===""?"":`$$${f}$$`}const ad={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},rd={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},Wr=5,Eo=25,Aa=20,ld=20,cd=.1,_l=[1/4,1/3,1/2,2/3,3/4],_a=4,Gs=30,Ke=5,Ui=Gs/2,tr=10,Ts=2,Kn=1,zn=[6,6],Dl=[3,3],ua=360,wo=180,kl=90,He=2*Math.PI,Ji=.01,nr=Math.sqrt(3)/2,dd=400,hd=Math.PI/3,fd=1.5,fn=Math.PI/6,ud=1.5,gd=[2,3],pd=[1,3],yd=.01,md=8,xd=5,Sd=Math.PI/24,Id=15,ao="_EDGE_",Mi=300,bd=3,sr=7,Kr=1e-15,qr=1e13,jr=1.15,vd=1e-5,Md=1-1e-5,or=.001,Rl=.01,Ed=.95,Td=100,Cd=1.5,wd=.5,Pd=1.5,ut=4,Ei=.9,ns=24,Cs=10,ss=8,Rt=20,$e=12,Da=5,ka=20,Ra=10,La=5,ga=20,pa=12,Ad="\\phantom{-}0",hi="i",oi="r",_d="\\mathrm{Re}",Dd="\\mathrm{Im}",kd=80,Oa=1,ya=Math.PI/2,Rd="#808080",js="rgba(128, 128, 128, 1)",Ld=4,Od=.25,lt=10,Xe=56,Ho=35,Ur=10,Nd=36,Fd=30,wt=40,Bd=20,xo=32,ir=2,Rn=1.5,ma=[2,4],Hn=1.5,ar=10,Ll=3,So=15,$d=4,Na=1,Jr=12,Fa=6,Vd=2,Xd=24,Yd="T",Gd=12,zd=10,Hd=10,Wd=3,Fn=2,Po=2,rn=7,xa=30,Zi=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],Sa=4,vn=12,ro=30,os=18,pn=1,Ol=1.5,Ba=11,Ti=18,Ci=60,Nl=20,Fl=8,Kd=20,Zr=18,$a=1e6,Va=1e-6,wi=1e-5,ws=.015,Us=32,qd=10,Qr=16,jd=12,Ud=14,Ws="\\hphantom{-}",Vt="\\pi",el="\\delta = ",vo="\\theta = ",rr=15,Ds=.8,Pi=3,us=2,Jd=1,Zd=3,Qd=1,eh=140,tl=.4,th=.9,ii=.05,nh=10,nl=1.5,Ia=[15,5,1],sl=80,sh=.01,ye=1e-9,lr=50,oh=6,ih=10,cr=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let s=1;s<=n*4;s++)e.add(s/n);return Array.from(e).sort((n,s)=>n-s)})();function ah(e,t){const n=new Set;n.add(0);for(let s=1;s<=e;s++)for(let i=1;i<=s*t;i++)n.add(i/s);return Array.from(n).sort((s,i)=>s-i)}const as=ah(oh,ih),Ln="regular",xn=" transformation_rotation",Zn=" transformation_scale",Mn="transformation_rotate_scale",bs="transformation_directional_scale",Qi="none",dr="regular",Lo="complex",ea="polar",Wo="none",hr="lines",fr="points",ur="triangular",gr="polar",ks="degrees",Ko="radians",Oo="none",No="on",rh="none",lh=" ",ch="Escape",dh="Delete",hh="Backspace",fh="r",ol="=",il="+",al="-",rl="c",ll="v",cl="x",ba="z",dl="y",hl="a",Ue="vertex",Je="edge",at="face",Gt="text",uh=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],gh=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c},fl=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},ul=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),ph=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},Ao=(e,t=!1)=>{const n=[],s=e.length,i=t?s:s-1;for(let o=0;o<i;o++)n.push({type:"line",a:e[o],b:e[(o+1)%s]});return n},yh=(e,t=!1,n=.5)=>{const i=(1-Math.max(0,Math.min(1,n)))*.5,o=uh(i),a=[];return gh(e,t).forEach(({p0:c,p1:l,p2:d,p3:f})=>{const h=[c.x,l.x,d.x,f.x],u=[c.y,l.y,d.y,f.y],p=o.map(y=>y.reduce((m,x,S)=>m+x*h[S],0)),g=o.map(y=>y.reduce((m,x,S)=>m+x*u[S],0));a.push({type:"cubic",coeffX:p,coeffY:g})}),a},mh=(e,t,n,s)=>{if(e.length<2||s<=1e-6)return Ao(e,t);const i=e.length,o=n==="fixed"?"absolute":n,a=[],r=l=>{const d=e[(l-1+i)%i],f=e[l],h=e[(l+1)%i],u=ul(d,f),p=ul(h,f),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)return null;const m=Math.min(g,y)*.5;let x,S,I;if(o==="absolute"?(x=Math.max(0,Math.min(s,m))*2,S=fl(p),I=fl(u)):(x=Math.max(0,Math.min(1,s)),S=p,I=u),x<=1e-6)return null;const b=x*.5,E=o==="absolute"?g*.5:.5,T=o==="absolute"?y*.5:.5,M={x:f.x+I.x*E,y:f.y+I.y*E},P={x:f.x+S.x*T,y:f.y+S.y*T},A={x:f.x+I.x*b,y:f.y+I.y*b},v={x:f.x+S.x*b,y:f.y+S.y*b},w=Math.PI,_=-Math.PI/2,C=ph(w,_);return{origin:f,axisX:S,axisY:I,baseScale:x,midIn:M,midOut:P,arcStart:A,arcEnd:v,startAngle:w,sweep:C}};if(t){const l=[];for(let d=0;d<i;d++){const f=r(d);f&&l.push(f)}return l.length?(a.push({type:"line",a:l[0].midIn,b:l[0].arcStart}),l.forEach(d=>{a.push({type:"affineArc",origin:d.origin,axisX:d.axisX,axisY:d.axisY,baseScale:d.baseScale,startAngle:d.startAngle,sweep:d.sweep}),a.push({type:"line",a:d.arcEnd,b:d.midOut})}),a.push({type:"line",a:l[l.length-1].midOut,b:l[0].midIn}),a):Ao(e,!0)}const c=[];for(let l=1;l<i-1;l++){const d=r(l);d&&c.push(d)}return c.length?(a.push({type:"line",a:e[0],b:c[0].midIn}),c.forEach(l=>{a.push({type:"line",a:l.midIn,b:l.arcStart}),a.push({type:"affineArc",origin:l.origin,axisX:l.axisX,axisY:l.axisY,baseScale:l.baseScale,startAngle:l.startAngle,sweep:l.sweep}),a.push({type:"line",a:l.arcEnd,b:l.midOut})}),a.push({type:"line",a:c[c.length-1].midOut,b:e[i-1]}),a):Ao(e,!1)};function xh(e,t,n=!1){return!t||e.length<2?[]:t.type==="linear"?Ao(e,n):t.type==="cubic_spline"?yh(e,n,t.tension??.5):t.type==="circular_arc"?mh(e,n,t.radiusMode??"relative",t.radiusValue??0):Ao(e,n)}function Sh(e,t){const n=[];return e.forEach((s,i)=>{const o=(a,r=!1)=>{i>0,n.push(a)};if(s.type==="line"){const a=s.a,r=s.b,c=t?t(a):a,l=t?t(r):r,d=Math.hypot(l.x-c.x,l.y-c.y),f=Math.max(2,Math.ceil(d/8));for(let h=0;h<=f;h++){const u=h/f;o({x:a.x+(r.x-a.x)*u,y:a.y+(r.y-a.y)*u},h===0)}return}if(s.type==="cubic"){const a=s.coeffX,r=s.coeffY,c=g=>({x:((a[0]*g+a[1])*g+a[2])*g+a[3],y:((r[0]*g+r[1])*g+r[2])*g+r[3]}),l=c(0),d=c(1),f=t?t(l):l,h=t?t(d):d,u=Math.hypot(h.x-f.x,h.y-f.y),p=Math.max(4,Math.ceil(u/6));for(let g=0;g<=p;g++){const y=g/p;o(c(y),g===0)}return}if(s.type==="affineArc"){const{origin:a,axisX:r,axisY:c,baseScale:l,startAngle:d,sweep:f}=s,h=l*.5,u={x:h,y:h},p=24;for(let g=0;g<=p;g++){const y=g/p,m=d+f*y,x={x:u.x+Math.cos(m)*h,y:u.y+Math.sin(m)*h};o({x:a.x+r.x*x.x+c.x*x.y,y:a.y+r.y*x.x+c.y*x.y},g===0)}}}),n}function gs(e,t,n=!1,s=null){const i=xh(e,t,n);return i.length?Sh(i,s):e}function xt(e,t,n=!1){if(e===0)return"0";const s=Math.abs(e),i=e<0?"-":"";let o;if(n||s>=$a||s!==0&&s<Va){if(e===0)return"0";const r=s.toExponential(Math.max(0,t-1)).split("e");let c=parseFloat(r[0]).toString(),l=parseInt(r[1],10);o=`${c} \\cdot 10^{${l}}`}else{const a=s<1?0:Math.floor(Math.log10(s))+1;let r;if(s===0)r=t-1;else if(s<1){let d=0,f=s;for(;f<1&&d<t+5;)f*=10,d++;r=Math.max(0,d-1+t)}else r=Math.max(0,t-a);let c=s.toFixed(r),l=parseFloat(c);if(Math.abs(l)===0&&e!==0)return"0";o=Math.abs(l).toString()}return i+o}function pr(e,t){return t===0?e:pr(t,e%t)}function re(e){return e.id1<e.id2?`${e.id1}${ao}${e.id2}`:`${e.id2}${ao}${e.id1}`}function ai(e,t,n,s,i,o){const a=i-n,r=o-s,c=a*a+r*r;if(c===0){const p=e-n,g=t-s;return Math.sqrt(p*p+g*g)}let l=-((n-e)*a+(s-t)*r)/c;l<0&&(l=0),l>1&&(l=1);const d=n+l*a,f=s+l*r,h=e-d,u=t-f;return Math.sqrt(h*h+u*u)}function fe(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function ps(e,t,n,s,i=!1){const o=[];if(t==="none"||!n||n<=0)return o;if(t==="polar"){const a=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,r=Math.hypot(e.x,e.y),c=Math.round(r/n)*n;s.forEach(l=>{if(l.alpha>.01&&l.angle>0){const d=l.angle,h=Math.round(a/d)*d*Math.PI/180;o.push({x:c*Math.cos(h),y:c*Math.sin(h),isGridPoint:!0})}})}else if(t==="triangular"){const a=n*nr,r=e.x/n-e.y/(n*Math.sqrt(3)),c=e.y/a;let l=Math.round(r),d=Math.round(c),f=Math.round(-r-c);const h=Math.abs(l-r),u=Math.abs(d-c),p=Math.abs(f-(-r-c));h>u&&h>p?l=-d-f:u>p&&(d=-l-f);const g=l*n+d*n/2,y=d*a;o.push({x:g,y,isGridPoint:!0})}else if(i){const a=Math.floor(e.x/n)*n,r=Math.floor(e.y/n)*n;o.push({x:a,y:r,isGridPoint:!0},{x:a+n,y:r,isGridPoint:!0},{x:a,y:r+n,isGridPoint:!0},{x:a+n,y:r+n,isGridPoint:!0})}else o.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return o}function Ut(){return crypto.randomUUID()}function $n(e){for(;e<0;)e+=He;for(;e>=He;)e-=He;return e}function gl(e,t,n=0){let s=t-e,i=Math.round((n-s)/(2*Math.PI));return s+i*(2*Math.PI)}function pt(e){return e=$n(e),e>Math.PI&&(e-=He),e}function Ih(e){for(;e<0;)e+=ua;for(;e>=ua;)e-=ua;return e}function yr(e,t){const{p1:n,p2:s}=e,{center:i,radius:o}=t,a={x:s.x-n.x,y:s.y-n.y},r={x:n.x-i.x,y:n.y-i.y},c=a.x*a.x+a.y*a.y,l=2*(r.x*a.x+r.y*a.y),d=r.x*r.x+r.y*r.y-o*o;let f=l*l-4*c*d;if(f<0)return[];f=Math.sqrt(f);const h=(-l-f)/(2*c),u=(-l+f)/(2*c);return[{x:n.x+h*a.x,y:n.y+h*a.y},{x:n.x+u*a.x,y:n.y+u*a.y}]}function Ps(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let s=2;s*s<=n;s++)for(;n%(s*s)===0;)n/=s*s,t*=s;return[t,n]}function As(e,t,n=""){const s=n?`\\${n}`:"";return t===1?e===1&&n?s:`${e}${s}`:e===1?`\\sqrt{${t}}${s}`:`${e}\\sqrt{${t}}${s}`}function ae(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function un(e,t=ws,n=Us){if(Math.abs(e)<wi)return"0";const s=e<0?"-":"",i=Math.abs(e);if(Math.abs(i-Math.round(i))<t){const r=Math.round(i);return s+r.toString()}const o=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[r,c]of o)if(c<=n&&Math.abs(i-r/c)<t)return s+`${r}/${c}`;for(let r=1;r<=n;r++){const c=Math.round(i*r);if(!(c===0&&i>wi)&&Math.abs(i-c/r)<t/r){const l=pr(c,r),d=c/l,f=r/l;return f===1?s+`${d}`:s+`${d}/${f}`}}let a=2;return i<.01?a=3:i<.1?a=2:i<10?a=1:a=0,s+i.toFixed(a)}function Rs(e,t){if(t.length<3)return!1;const n=e.x,s=e.y;let i=!1;for(let o=0,a=t.length-1;o<t.length;a=o++){const r=t[o].x,c=t[o].y,l=t[a].x,d=t[a].y;if(r===n&&c===s||c===d&&c===s&&n>=Math.min(r,l)&&n<=Math.max(r,l)||r===l&&r===n&&s>=Math.min(c,d)&&s<=Math.max(c,d))return!0;c>s!=d>s&&n<(l-r)*(s-c)/(d-c)+r&&(i=!i)}return i}function ys(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function bh(e,t,n){const s=t.localCoordSystem;if(!s)return null;const i=n(s.origin),o=md;if(ae(e,i)<o)return{face:t,type:"center"};const a=xd,r=kn({x:1,y:0},s),c=n(r);if(Dt(e,i,c).distance<a)return{face:t,type:"x_axis"};const d=kn({x:0,y:1},s),f=n(d);return Dt(e,i,f).distance<a?{face:t,type:"y_axis"}:null}function lo(e,t){if(Rs(e,t))return e;let n=e,s=1/0;for(let i=0;i<t.length;i++){const o=t[i],a=t[(i+1)%t.length],r=Dt(e,o,a);r.distance<s&&(s=r.distance,n={x:r.x,y:r.y})}return n}function Bl(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:s,isColorModePanelExpanded:i,isInterpolationPanelExpanded:o,isTransformPanelExpanded:a,isDisplayPanelExpanded:r,isVisibilityPanelExpanded:c,isSessionsPanelExpanded:l}){const d=(f,h)=>h?f.x>=h.x&&f.x<=h.x+h.width&&f.y>=h.y&&f.y<=h.y+h.height:!1;if(s){for(const f of t.colorTargetIcons||[])if(d(e,f))return{...f,type:"colorTargetIcon"};for(const f of t.colorSwatches||[])if(d(e,f))return{...f,type:"colorSwatch"};if(d(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(d(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(d(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(d(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(i){for(const f of t.colorModeIcons||[])if(d(e,f))return{...f,type:"colorModeIcon"}}if(a){for(const f of t.transformIcons||[])if(d(e,f))return{...f,type:"transformIcon"}}if(o){for(const f of t.interpolationIcons||[])if(d(e,f))return{...f,type:"interpolationIcon"}}if(r){for(const f of t.displayIcons||[])if(d(e,f))return{...f,type:"displayIcon"}}if(c){for(const f of t.visibilityIcons||[])if(d(e,f))return{...f,type:"visibilityIcon"}}if(l){for(const f of t.sessionIcons||[])if(d(e,f))return{...f,type:"sessionIcon"};if(d(e,t.removeSessionButton))return{...t.removeSessionButton,type:"button"};if(d(e,t.addSessionButton))return{...t.addSessionButton,type:"button"}}if(n){if(d(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(d(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(d(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(d(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(d(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(d(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"};if(d(e,t.sessionsToolButton))return{...t.sessionsToolButton,type:"toolButton"};if(d(e,t.colorModeToolButton))return{...t.colorModeToolButton,type:"toolButton"}}return d(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function vh(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function Dt(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y,distance:ae(e,t),onSegmentStrict:!0,t:0};let c=(o*s+a*i)/r;const l=c>vd&&c<Md,d=Math.max(0,Math.min(1,c)),f=t.x+d*s,h=t.y+d*i,u=ae(e,{x:f,y:h});return{x:f,y:h,distance:u,onSegmentStrict:l,t:d}}function $l(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y,distance:ae(e,t)};let c=(o*s+a*i)/r;const l=t.x+c*s,d=t.y+c*i,f=ae(e,{x:l,y:d});return{x:l,y:d,distance:f}}function Fo(e,t={},n=0){if(!e||typeof e!="string")return n;const s=e.trim();if(!s)return n;try{const i={...t},o=Object.keys(i),a=o.map(l=>i[l]),c=new Function(...o,`'use strict'; return (${s});`)(...a);return Number.isFinite(c)?c:n}catch{return n}}function Io(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function va(e,t,n){e/=255,t/=255,n/=255;const s=Math.max(e,t,n),i=Math.min(e,t,n);let o,a,r=(s+i)/2;if(s===i)o=a=0;else{const c=s-i;switch(a=r>.5?c/(2-s-i):c/(s+i),s){case e:o=(t-n)/c+(t<n?6:0);break;case t:o=(n-e)/c+2;break;case n:o=(e-t)/c+4;break}o/=6}return[o,a,r]}function Mh(e,t,n,s,i=null){const o=Math.atan2(e.y-t.y,e.x-t.x);if(!s)return{angle:o,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=Sd;let r={angle:o,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},l=(f,h,u=null,p=null)=>{const g=pt(f),y=Math.abs(pt(o-g));if(y<a){const m=c[h],x=r.snapType?c[r.snapType]:1/0;m<x?r={angle:g,difference:y,edgeIndex:u,snapType:h,targetVertexId:p}:m===x&&y<r.difference&&(r={angle:g,difference:y,edgeIndex:u,snapType:h,targetVertexId:p})}};return s.edgeAngles&&s.edgeAngles.forEach((f,h)=>{[f,f+Math.PI/2,f-Math.PI/2,f+Math.PI].forEach(u=>{l(u,"edge",h)})}),s.vertices&&s.vertices.forEach(f=>{if(ae(t,f)>ye){const h=Math.atan2(f.y-t.y,f.x-t.x);l(h,"vertex_direction",null,f.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(f=>l(f,"cardinal")),{angle:r.angle,edgeIndex:r.edgeIndex,snapType:r.snapType,snapped:r.difference<1/0,targetVertexId:r.targetVertexId}}function Eh(e,t,n,s,i,o=null,a=null,r="x_axis"){if(!o||!a||!n.alignedEdgeInfo)return{snapped:!1};const c=Id/a.scale;let l=[];const{v1Id:d,v2Id:f}=n.alignedEdgeInfo,h=i(d),u=i(f);if(h&&u&&h.type==="regular"&&u.type==="regular"){const g=ae(h,u);[.25,1/3,.5,2/3,.75,1].forEach(m=>{const x=g*m,S=Math.abs(o-x);l.push({scale:x,distance:S,type:"edge_fraction",priority:m===.5?1:m===1?2:3,fraction:m})})}if(l.length===0)return{snapped:!1};l.sort((g,y)=>g.priority!==y.priority?g.priority-y.priority:g.distance-y.distance);const p=l.find(g=>g.distance<c);return p?{snapped:!0,scale:p.scale,snapType:"edge_fraction",edgeFraction:p.fraction}:{snapped:!1}}function Th(e,t,n,s,i){let o=null,a=1/0;if(t&&(t.vertices&&t.vertices.forEach(r=>{const c=ae(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:r,snapType:"vertex",vertexId:r.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(r=>{const c=ae(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:{x:r.x,y:r.y},snapType:"edge",edgeInfo:{v1:r.v1,v2:r.v2}})}),t.faceCenters&&t.faceCenters.forEach(r=>{const c=ae(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:r,snapType:"faceCenter"})})),n&&n!=="none"&&s&&s.interval1){const r=s.alpha2>s.alpha1&&s.interval2?s.interval2:s.interval1;ps(e,n,r,i,!0).forEach(l=>{const d=ae(e,l);d<a&&(a=d,o={snapped:!0,snapPoint:l,snapType:"grid"})})}return o||{snapped:!1}}function Ch(e){if(Array.isArray(e)){const[t,n,s]=va(e[0],e[1],e[2]),i=1-s,[o,a,r]=Ma(t,n,i);return[o,a,r]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,s,i,o]=t,a=parseInt(n),r=parseInt(s),c=parseInt(i),[l,d,f]=va(a,r,c),h=1-f,[u,p,g]=Ma(l,d,h);return`rgba(${u}, ${p}, ${g}, ${o})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16),[i,o,a]=va(t,n,s),r=1-a,[c,l,d]=Ma(i,o,r);return`#${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function ta(e){let t=0;const n=e.length;for(let s=0;s<n;s++){const i=(s+1)%n;t+=e[s].x*e[i].y,t-=e[i].x*e[s].y}return t/2}function wh(e,t,n){return Math.max(t,Math.min(n,e))}function Ph(e,t){return e==="light"?rd:t}function Ma(e,t,n){let s,i,o;if(t===0)s=i=o=n;else{const a=(l,d,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<.16666666666666666?l+(d-l)*6*f:f<.5?d:f<.6666666666666666?l+(d-l)*(6*(.6666666666666666-f)):l),r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;s=a(c,r,e+1/3),i=a(c,r,e),o=a(c,r,e-1/3)}return[Math.round(s*255),Math.round(i*255),Math.round(o*255)]}function Ks(e,t){const n=un(e,.001),s=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${s}`;if(n==="1")return s;if(n==="-1")return`-${s}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${s}`;if(n.includes("/")){let i="",o=n;o.startsWith("-")&&(i="-",o=o.substring(1));const a=o.split("/"),r=a[0],c=a[1];return r==="1"?`${i}\\frac{1}{${c}}${s}`:`${i}\\frac{${r}}{${c}}${s}`}return`${n}${s}`}function nt(e,t,n,s,i,o){const a={x:e.x-t.x,y:e.y-t.y};if(i){const r=Math.hypot(o.x,o.y);if(r>ye){const c={x:o.x/r,y:o.y/r},l=a.x*c.x+a.y*c.y,d={x:a.x-l*c.x,y:a.y-l*c.y},f=l*s,h={x:f*c.x+d.x,y:f*c.y+d.y};return{x:t.x+h.x,y:t.y+h.y}}return{x:e.x,y:e.y}}else{let r={...a};r.x*=s,r.y*=s;const c=r.x,l=r.y;return r.x=c*Math.cos(n)-l*Math.sin(n),r.y=c*Math.sin(n)+l*Math.cos(n),{x:t.x+r.x,y:t.y+r.y}}}function na(e){if(e.length<3)return null;if(e.length===3){const[t,n,s]=e,i=ae(n,s),o=ae(t,s),a=ae(t,n),r=i+o+a;if(r<ye)return null;const c=(i*t.x+o*n.x+a*s.x)/r,l=(i*t.y+o*n.y+a*s.y)/r,f=2*(Math.abs((n.x-t.x)*(s.y-t.y)-(s.x-t.x)*(n.y-t.y))/2)/r;return{center:{x:c,y:l},radius:f}}return _h(e)}function Ah(e,t,n){const s=_l.reduce((o,a)=>Math.abs(a-e.t)<Math.abs(o-e.t)?a:o),i={x:t.x+s*(n.x-t.x),y:t.y+s*(n.y-t.y)};return{fraction:s,point:i}}function _h(e){if(e.length<3)return null;let t={x:e.reduce((i,o)=>i+o.x,0)/e.length,y:e.reduce((i,o)=>i+o.y,0)/e.length};Rs(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,s=pl(t,e);for(let i=0;i<ld;i++){let o=!1;const a=s*cd,r=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of r){const l={x:n.x+c.x,y:n.y+c.y};if(Rs(l,e)){const d=pl(l,e);d>s&&(n=l,s=d,o=!0)}}if(!o)break}return{center:n,radius:Math.max(s,ye)}}function pl(e,t){let n=1/0;for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length],a=Vl(e,i,o);n=Math.min(n,a)}return n}function Vl(e,t,n){return Dt(e,t,n).distance}function Dh(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=yl(n,t);else if(!n.localCoordSystem.isCustom){const s=yl(n,t);s&&(n.localCoordSystem.origin=s.origin,n.localCoordSystem.scale=s.scale)}})}function kh(e,t,n){const s=[e];let i=e,o=t;const a=n.size+2;for(let r=0;r<a;r++){if(s.push(o),o===e)return s.pop(),s;const c=n.get(o);if(!c||c.length<1)return null;const l=c.indexOf(i);if(l===-1)return null;const d=(l+1)%c.length,f=c[d];i=o,o=f}return null}function Rh(e,t,n){if(e.length<=1)return e;const s=new Set(t.map(i=>[i.id1,i.id2].sort().join("_")));return e.filter(i=>{const o=i.vertexIds;if(o.length<3)return!1;for(let a=0;a<o.length;a++)for(let r=a+2;r<o.length;r++){if(a===0&&r===o.length-1)continue;const c=o[a],l=o[r],d=[c,l].sort().join("_");if(s.has(d))return!1}return!0})}function sa(e,t){const n=new Map,s=new Map;e.forEach(l=>{const d=t(l.id1),f=t(l.id2);!d||!f||d.type!=="regular"||f.type!=="regular"||(s.has(d.id)||s.set(d.id,d),s.has(f.id)||s.set(f.id,f),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,d]of n.entries()){const f=s.get(l);f&&d.sort((h,u)=>{const p=s.get(h),g=s.get(u);if(!p||!g)return 0;const y=Math.atan2(p.y-f.y,p.x-f.x),m=Math.atan2(g.y-f.y,g.x-f.x);return y-m})}const i=[],o=new Set;for(const[l,d]of n.entries())for(const f of d){const h=`${l}->${f}`;if(o.has(h))continue;const u=kh(l,f,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const m=u[y],x=u[(y+1)%u.length];o.add(`${m}->${x}`)}const g={vertexIds:u};g.id=fe(g),i.push(g)}}const a=Rh(i,e),r=[],c=new Set;return a.forEach(l=>{const d=[...l.vertexIds].sort().join("_");c.has(d)||(r.push(l),c.add(d))}),r}function Ls(e,t,n,s){const i={id1:e.id,id2:t.id,directionFrom:e.id,directionTo:t.id},o=e.x-t.x,a=e.y-t.y,r=o/n,c=a/n,l=1e-5;if(n&&Math.abs(r-Math.round(r))<l&&Math.abs(c-Math.round(c))<l){i.labelMode="exact";const f=Math.round(r),h=Math.round(c);i.exactValue={g2gSquaredSum:f*f+h*h,gridInterval:n}}else i.labelMode="decimal";return i.color=s(Je),i}function Xl(e,t){let n=null,s=1/0;return t.forEach(i=>{if(!i)return;const o=Math.abs(e.x-(i.x+i.width/2));o<s&&o<i.width/2+lt&&(s=o,n=i)}),n}function Lh(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function Be(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],p=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${p})`}Number.isFinite(t)||(t=0),e.isCyclic?t=(t%1+1)%1:t=Math.max(0,Math.min(1,t));let s=n[0],i=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){s=n[u],i=n[u+1];break}const o=i.pos-s.pos,a=o>0?(t-s.pos)/o:0,r=Math.round(s.color[0]+(i.color[0]-s.color[0])*a),c=Math.round(s.color[1]+(i.color[1]-s.color[1])*a),l=Math.round(s.color[2]+(i.color[2]-s.color[2])*a),d=s.alpha!==void 0?s.alpha:1,f=i.alpha!==void 0?i.alpha:1,h=d+(f-d)*a;return`rgba(${r},${c},${l},${h})`}function yl(e,t){const n=e.vertexIds.map(i=>t(i)).filter(i=>i&&i.type==="regular");if(n.length<3)return null;const s=na(n);return s?{origin:{...s.center},angle:0,scale:s.radius,isCustom:!1,showCoordSystem:!1}:null}function Mo(e,t){if(!t)return e;const n={x:e.x-t.origin.x,y:e.y-t.origin.y},s=Math.cos(-t.angle),i=Math.sin(-t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return t.scale===0?{x:0,y:0}:{x:o.x/t.scale,y:o.y/t.scale}}function In(e,t){const n=new Set;return t.forEach(s=>{s.id1===e?n.add(s.id2):s.id2===e&&n.add(s.id1)}),Array.from(n)}function kn(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},s=Math.cos(t.angle),i=Math.sin(t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return{x:o.x+t.origin.x,y:o.y+t.origin.y}}function Oh(e,t,n,s){const i=(e.x-t.x)*(n.y-s.y)-(e.y-t.y)*(n.x-s.x);if(Math.abs(i)<ye)return null;const o=((e.x-n.x)*(n.y-s.y)-(e.y-n.y)*(n.x-s.x))/i,a=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/i;return o>ye&&o<1-ye&&a>ye&&a<1-ye?{x:e.x+o*(t.x-e.x),y:e.y+o*(t.y-e.y)}:null}function Nh(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length];if(Vl(n,i,o)<ye)return!1}if(!Rs(n,t))return!1}return!0}function Fh(e,t,n){const s=[];for(let i=0;i<t.length;i++)s.push({p1:t[i],p2:t[(i+1)%t.length]});for(const i of e){const o=n(i.id1),a=n(i.id2);if(!(!o||!a)){for(const r of s)if(Oh(o,a,r.p1,r.p2))return!0}}return!1}function ml(e,t,n){const s=[];for(const i of e)for(const o of t){if(i.originalId===o.originalId&&i.transformIndex===o.transformIndex)continue;const a=ae(i,o);a<n&&s.push({dist:a,sourceVertex:i,targetVertex:o,correctionVector:{x:o.x-i.x,y:o.y-i.y},type:"vertex-vertex"})}return s}function ri(e,t,n){const s=[];for(const i of e)for(const o of t){if(!o||!o.originalEdge||!o.p1||!o.p2)continue;const a=i.transformIndex===o.transformIndex,r=i.originalId===o.originalEdge.id1||i.originalId===o.originalEdge.id2;if(a&&r)continue;const c=Dt(i,o.p1,o.p2);c.distance<n&&c.onSegmentStrict&&s.push({dist:c.distance,sourceVertex:i,targetEdge:o,snapPoint:{x:c.x,y:c.y},correctionVector:{x:c.x-i.x,y:c.y-i.y},type:"vertex-to-edge"})}return s}function Yl(e,t,n,s,i,o,a,r){const c=Ke*2/o.scale,l=Ke/o.scale,d=String(Ln).trim(),f=e.filter(B=>(B&&B.type?String(B.type).trim():"undefined")===d);if(f.length===0||i<=0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const h=new Set(e.map(B=>B.id)),u=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const Y=B,G=B;f.forEach(W=>{u.push({...r(W,Y,a),originalId:W.id,transformIndex:G,type:"regular"})})}const p=t.filter(B=>B.type==="regular"&&!h.has(B.id)).map(B=>({...B,originalId:B.id,transformIndex:void 0})),g=n.filter(B=>h.has(B.id1)&&h.has(B.id2)),y=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const Y=B,G=u.filter(W=>W.transformIndex===Y);G.length>0&&g.forEach(W=>{const oe=G.find(te=>te.originalId===W.id1),U=G.find(te=>te.originalId===W.id2);oe&&U&&y.push({p1:oe,p2:U,originalEdge:W,transformIndex:Y,originalEdgeId:re(W)})})}const m=n.filter(B=>!h.has(B.id1)||!h.has(B.id2)).map(B=>({p1:s(B.id1),p2:s(B.id2),originalEdge:B,transformIndex:void 0,originalEdgeId:re(B)})).filter(B=>B.p1&&B.p2),x=[...p,...u],S=[...m,...y],I=ml(u,x,c),b=ri(u,S,l),T=ri(p,y,l).map(B=>({dist:B.dist,sourceEdge:B.targetEdge,targetVertex:B.sourceVertex,correctionVector:{x:B.sourceVertex.x-B.snapPoint.x,y:B.sourceVertex.y-B.snapPoint.y},type:"edge-to-vertex"})),M=[...I,...b,...T];if(M.length===0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const P={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};M.sort((B,Y)=>{const G=P[B.type]??99,W=P[Y.type]??99;return G!==W?G-W:B.dist-Y.dist});const A=M[0];let v={...A.correctionVector};const w=A.sourceVertex?A.sourceVertex.transformIndex:A.sourceEdge.transformIndex,_=A.targetVertex?A.targetVertex.transformIndex:A.targetEdge?A.targetEdge.transformIndex:void 0;let C;_===void 0?C=w:C=w-_;let D={x:0,y:0};Math.abs(C)>1e-9?(D.x=v.x/C,D.y=v.y/C):D={x:0,y:0};const O={...a,delta:{x:a.delta.x+D.x,y:a.delta.y+D.y}},F=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const Y=B,G=B;f.forEach(W=>{F.push({...r(W,Y,O),id:`final_${W.id}_${B}`,originalId:W.id,transformIndex:G,type:"regular"})})}const V=p.map(B=>({...B})),N=[...V,...F],$=ml(F,N,ye),L=m.map(B=>({...B})),k=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const Y=B,G=F.filter(W=>W.transformIndex===Y);G.length>0&&g.forEach(W=>{const oe=G.find(te=>te.originalId===W.id1),U=G.find(te=>te.originalId===W.id2);oe&&U&&k.push({p1:oe,p2:U,originalEdge:W,transformIndex:Y,originalEdgeId:re(W)})})}const R=[...L,...k],X=ri(F,R,ye),z=ri(V,k,ye);return{snapped:!0,finalTransform:O,bestSnap:A,mergePairs:$.map(B=>({source:{originalId:B.sourceVertex.originalId,transformIndex:B.sourceVertex.transformIndex},target:{originalId:B.targetVertex.originalId,transformIndex:B.targetVertex.transformIndex}})),edgeSnaps:[...X,...z].map(B=>({sourceVertex:{originalId:B.sourceVertex.originalId,transformIndex:B.sourceVertex.transformIndex},targetEdge:{originalEdgeId:B.targetEdge.originalEdgeId,transformIndex:B.targetEdge.transformIndex}}))}}function Bh(e,t,n,s,i,o,a){const r={delta:i},l=Yl(e,t,n,s,o,a,r,(d,f,h=r)=>({x:d.x+h.delta.x*f,y:d.y+h.delta.y*f}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const Ea=e=>Math.max(0,Math.min(1,e)),dt=(e,t)=>{const n=ys(e);return n||t},Xa=e=>`rgba(${Math.round(e.r)},${Math.round(e.g)},${Math.round(e.b)},${e.a??1})`,Nt=(e,t,n)=>e+(t-e)*n,xl=(e,t)=>{let n=0,s=0,i=0,o=0,a=0;return e.forEach((r,c)=>{const l=t[c]||0;a+=l,n+=r.r*l,s+=r.g*l,i+=r.b*l,o+=r.a*l}),a<=0?{r:0,g:0,b:0,a:1}:{r:n/a,g:s/a,b:i/a,a:o/a}};function Ai(e,t,n,s,i,o,a){if(!t)return[n,s];const r=e.directionFrom||e.id1,c=e.directionTo||e.id2,l=o(r)||n,d=o(c)||s,f={x:d.x-l.x,y:d.y-l.y},h=Math.hypot(f.x,f.y)||1;f.x/=h,f.y/=h;const u=e.interpolationStyleId||null,p=(A,v)=>{const w=[];return i.forEach(_=>{_.id1===e.id1&&_.id2===e.id2||_.id1===e.id2&&_.id2===e.id1||(_.id1===A&&_.id2!==v&&w.push(_),_.id2===A&&_.id1!==v&&w.push(_))}),w},g=(A,v,w)=>{const _=p(A,v).filter(N=>(N.interpolationStyleId||null)===u);if(_.length!==1)return null;const C=_[0],O=[C.id1===A?C.id2:C.id1];let F=null,V=w?-1/0:1/0;return O.forEach(N=>{const $=o(N);if(!$||$.type!==Ln)return;const L=o(A);if(!L)return;const k={x:$.x-L.x,y:$.y-L.y},R=Math.hypot(k.x,k.y);if(R<=ye)return;const X=k.x/R*f.x+k.y/R*f.y;w?X>V&&(V=X,F=$):X<V&&(V=X,F=$)}),F},y=g(r,c,!1),m=g(c,r,!0),x=[l,d];y&&x.unshift(y),m&&x.push(m);const S=gs(x,t,!1,a);if(!S||S.length<2)return[n,s];let I=0,b=S.length-1,E=1/0,T=1/0;if(S.forEach((A,v)=>{const w=ae(A,n);w<E&&(E=w,I=v);const _=ae(A,s);_<T&&(T=_,b=v)}),I===b)return[n,s];const M=Math.min(I,b),P=Math.max(I,b);return S.slice(M,P+1)}function $h(e){const t=eh/e;let n=Math.pow(10,Math.floor(Math.log10(t))),s=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-s)<ye||n===0)&&(s=n===0?.001:n*10,n===0&&(n=1e-4));const i=n,o=s;let a=0;o>i&&i>0&&(a=(Math.log10(t)-Math.log10(i))/(Math.log10(o)-Math.log10(i)));let r=(a-tl)/(th-tl);r=Math.max(0,Math.min(1,r)),r=r*r*(3-2*r);let c=1-r,l=r;c<ii?c=0:c>1-ii&&(c=1),l<ii?l=0:l>1-ii&&(l=1);const d=c+l;return d>0&&d!==2&&(c/=d,l/=d),{grid1Interval:i,grid2Interval:o,alpha1:c,alpha2:l}}function Vh(e,t,n,s){const i=s({x:0,y:0}),o={x:t/2,y:n/2},a=ae(i,o);let r;a<1e-6?r=sl:r=sl/a*(180/Math.PI),(isNaN(r)||r<=ye)&&(r=ye);const c=[];let l=[...Ia],d=l[l.length-1];const f=1e-15;for(;d>f;)d/=10,l.includes(d)||l.push(d);l.sort((y,m)=>m-y);let h=null,u=null;for(let y=l.length-1;y>=0;y--){const m=l[y];if(r<m){h={angle:m,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!h&&l.length>0?(h={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!h&&l.length===0&&(h={angle:Ia[0],alpha:1}),c.push(h),u){const y=Math.log10(h.angle),m=Math.log10(u.angle),x=Math.log10(r);let S;m===y?S=0:S=(x-y)/(m-y),S=Math.max(0,Math.min(1,S));const I=S*S*(3-2*S);I>sh&&(u.alpha=I,c.push(u))}const p=[],g=new Set;c.sort((y,m)=>m.angle-y.angle);for(const y of c)g.has(y.angle)||(p.push(y),g.add(y.angle));return p.length===0&&p.push({angle:Ia[0],alpha:1}),p}function Gl(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:s,colors:i,isDragConfirmed:o,dragPreviewVertices:a,currentAltPressed:r},c,l,d){if(!n&&s.length===0)return;const f=new Map;o&&a&&a.forEach(u=>{if(u&&u.id){const p=u.originalId||u.id;f.set(p,u)}});const h=u=>o&&f.has(u)?f.get(u):l(u);t.forEach(u=>{const p=d(u),g=s.includes(p),y=!r&&p===n;if(o&&u.vertexIds.some(m=>f.has(m)),(g||y)&&u.color!=="transparent"){e.save(),e.fillStyle=i.selectionGlow,e.globalAlpha=Od,e.beginPath();const m=u.vertexIds.map(S=>h(S)).filter(S=>S&&S.type==="regular");if(m.length<3){e.restore();return}m.map(S=>c(S)).forEach((S,I)=>{I===0?e.moveTo(S.x,S.y):e.lineTo(S.x,S.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(S=>{const I=t.find(b=>b.id===S);if(I){const b=I.vertexIds.map(E=>h(E)).filter(E=>E&&E.type==="regular");if(b.length>=3){const E=b.map(T=>c(T));e.moveTo(E[0].x,E[0].y),E.slice(1).forEach(T=>e.lineTo(T.x,T.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function mr(e,t,{colors:n,verticesVisible:s=!0,isSnapped:i=!1},o){if(t.type===Ln&&!s&&!i)return;const a=o(t);switch(t.type){case Ln:e.beginPath(),e.arc(a.x,a.y,Ke,0,He),e.fillStyle=i?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case xn:case Zn:case Mn:case bs:const r=Ui*2,c={type:t.type,x:a.x-r/2,y:a.y-r/2,width:r,height:r};oa(e,c,n);break}}function zl(e,t,n,s){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=s)return{ranges:[[0,360]],isFullCircle:!0};const i={left:0,right:n,top:0,bottom:s};if(e.x+t<i.left||e.x-t>i.right||e.y+t<i.top||e.y-t>i.bottom)return null;const o=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(o.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const r=[];if(o.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const g=u.x-e.x,y=u.y-e.y,m=Math.atan2(-y,g),x=m<0?m+2*Math.PI:m;r.push(x*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{yr({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(g=>{const y=g.x-e.x,m=g.y-e.y,x=Math.atan2(-m,y),S=x<0?x+2*Math.PI:x;r.push(S*180/Math.PI)})}),r.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(r.map(u=>Math.round(u*1e6)/1e6))].sort((u,p)=>u-p);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let d=0,f=0,h=0;for(let u=0;u<l.length;u++){const p=l[u],g=l[(u+1)%l.length];let y;u===l.length-1?y=360-p+g:y=g-p,y>d&&(d=y,f=p,h=g)}return h>f?{ranges:[[h,f+360]],isFullCircle:!1}:{ranges:[[h,f]],isFullCircle:!1}}function Xh(e,{canvas:t,dpr:n,colors:s}){const i=t.width/n,o=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=s.background,e.fillRect(0,0,i,o)}function rs(e,t){return e?.colorMode||t}function Bo(e,t){return e?.colorMode||t}function Yh(e,{allFaces:t,allEdges:n,facesVisible:s,isDragConfirmed:i,dragPreviewVertices:o,transformIndicatorData:a,initialDragVertexStates:r,colors:c,initialCoordSystemStates:l,interpolationStyle:d,getInterpolationStyleById:f,faceColorMode:h="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x",angleDisplayMode:m="degrees"},x,S){if(!s||!t||!c||!e)return;const I=T=>S(T);t.filter(T=>!T.parentFaceId).forEach(T=>{if(!T||!T.vertexIds||T.vertexIds.length<3)return;const M=T.vertexIds.map(_=>I(_)).filter(_=>_&&_.type==="regular");if(M.length<3)return;const P=T.interpolationStyleId&&f?f(T.interpolationStyleId):null,v=(P?gs(M,P,!0,x):M).map(_=>x(_));let w=T;T.localCoordSystem,v.every(_=>_&&typeof _.x=="number"&&typeof _.y=="number")&&ki(e,v,w,c,x,S,n,t,I,!0,d,{faceColorMode:Bo(T,h),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y,angleDisplayMode:m})}),t.filter(T=>T.parentFaceId&&T.color!=="transparent").forEach(T=>{if(!T||!T.vertexIds||T.vertexIds.length<3)return;const M=T.vertexIds.map(_=>I(_)).filter(_=>_&&_.type==="regular");if(M.length<3)return;const P=T.interpolationStyleId&&f?f(T.interpolationStyleId):null,v=(P?gs(M,P,!0,x):M).map(_=>x(_));let w=T;T.localCoordSystem,v.every(_=>_&&typeof _.x=="number"&&typeof _.y=="number")&&ki(e,v,w,c,x,S,n,t,I,!1,d,{faceColorMode:Bo(T,h),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y,angleDisplayMode:m})})}function xr(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:s,findVertexById:i,transformIndicatorData:o}){if(!t)return e.localCoordSystem;const a=new Set(e.vertexIds),r=new Set(s.map(p=>p.id));if([...a].every(p=>r.has(p))){const p=JSON.parse(JSON.stringify(t));if(o){const{center:g,rotation:y,scale:m,directionalScale:x,startPos:S}=o,I={x:S.x-g.x,y:S.y-g.y};if(p.origin=nt(t.origin,g,y,m,x,I),x){const b=kn({x:1,y:0},t),E=nt(b,g,y,m,x,I);p.scale=ae(p.origin,E)}else p.angle=$n(t.angle+y),p.scale=t.scale*m}else if(s.length>0&&n.length>0){const g=s.find(m=>a.has(m.id)),y=g?n.find(m=>m.id===g.id):null;if(y){const m=y.x-g.x,x=y.y-g.y;p.origin.x+=m,p.origin.y+=x}}return p}const l=e.vertexIds.map(p=>n.find(g=>g&&g.id===p)||i(p)).filter(p=>p&&p.type==="regular");if(!t.isCustom){const p=na(l);if(p){const g=o?o.rotation:0;return{...t,origin:p.center,scale:p.radius,angle:$n(t.angle+g)}}return t}const d=JSON.parse(JSON.stringify(t));if(o){const{center:p,rotation:g,scale:y,directionalScale:m,startPos:x}=o,S={x:x.x-p.x,y:x.y-p.y};if(d.origin=nt(t.origin,p,g,y,m,S),m){const I=kn({x:1,y:0},t),b=nt(I,p,g,y,m,S);d.scale=ae(d.origin,b)}else d.angle=$n(t.angle+g),d.scale=t.scale*y}let f={...d.origin},h=d.angle,u=d.scale;if(d.attachedToVertex){if(r.has(d.attachedToVertex)){const p=n.find(g=>g.id===d.attachedToVertex);p&&(f={...p})}}else if(d.attachedToEdge&&(r.has(d.attachedToEdge.v1)||r.has(d.attachedToEdge.v2))){const p=n.find(y=>y.id===d.attachedToEdge.v1)||i(d.attachedToEdge.v1),g=n.find(y=>y.id===d.attachedToEdge.v2)||i(d.attachedToEdge.v2);p&&g&&(f={x:p.x+d.attachedToEdge.t*(g.x-p.x),y:p.y+d.attachedToEdge.t*(g.y-p.y)})}if(d.rotationAlignedToEdge&&(r.has(d.rotationAlignedToEdge.v1)||r.has(d.rotationAlignedToEdge.v2))){const p=n.find(y=>y.id===d.rotationAlignedToEdge.v1)||i(d.rotationAlignedToEdge.v1),g=n.find(y=>y.id===d.rotationAlignedToEdge.v2)||i(d.rotationAlignedToEdge.v2);if(p&&g){const y=Math.atan2(g.y-p.y,g.x-p.x),{originalAngle:m,originalSystemAngle:x}=d.rotationAlignedToEdge,S=x-m;h=$n(y+S)}}if(d.scaleAttachedToEdge&&(r.has(d.scaleAttachedToEdge.v1)||r.has(d.scaleAttachedToEdge.v2))){const p=n.find(y=>y.id===d.scaleAttachedToEdge.v1)||i(d.scaleAttachedToEdge.v1),g=n.find(y=>y.id===d.scaleAttachedToEdge.v2)||i(d.scaleAttachedToEdge.v2);p&&g&&(u=ae(p,g)*d.scaleAttachedToEdge.scaleRatio)}return l.length>=3?d.origin=lo(f,l):d.origin=f,d.angle=h,d.scale=Math.max(.01,u),d}function Gh(e,t,n){const{copyCount:s,isDragConfirmed:i,initialDragVertexStates:o,dragPreviewVertices:a,transformIndicatorData:r,allEdges:c,allFaces:l,findVertexById:d,colors:f,snappedEdgesInfo:h,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",faceColorExpression:m="x",faceColorPolarExpression:x="r",angleDisplayMode:S="degrees",initialCoordSystemStates:I=new Map,getInterpolationStyleById:b}=t,E=o.length===1&&!r&&o[0].type==="regular";if(!i||!o.length||s<=0||E)return;const T=o.filter(w=>w.type==="regular");if(T.length===0)return;const M=new Set(T.map(w=>w.id)),P=c.filter(w=>M.has(w.id1)&&M.has(w.id2)),A=c.filter(w=>M.has(w.id1)&&!M.has(w.id2)||M.has(w.id2)&&!M.has(w.id1)),v=l.filter(w=>w.vertexIds.every(_=>M.has(_)));e.save(),e.globalAlpha=1;for(let w=0;w<s;w++){w+=s==1;const _=w,C=w;let D;const O=new Map;if(r){const{center:L,rotation:k,scale:R,directionalScale:X,startPos:z}=r,B={x:z.x-L.x,y:z.y-L.y};D=T.map(Y=>{const G=nt(Y,L,k*C,Math.pow(R,C),X,B);return{...Y,...G,id:`preview_${Y.id}_${_}`,originalId:Y.id,transformIndex:_}})}else{const L=a.length>0?a[0].x-o[0].x:0,k=a.length>0?a[0].y-o[0].y:0;D=T.map(R=>({...R,x:R.x+L*C,y:R.y+k*C,id:`preview_${R.id}_${_}`,originalId:R.id,transformIndex:_}))}if(!D||D.length===0)continue;D.forEach(L=>O.set(L.originalId,L)),v.forEach(L=>{const k=L.vertexIds.map(R=>O.get(R)).filter(Boolean);if(k.length===L.vertexIds.length){const R=L.interpolationStyleId&&b?b(L.interpolationStyleId):null,z=(R?gs(k,R,!0,n):k).map(Y=>n(Y));let B=L;if(L.localCoordSystem){const Y=I.get(L.id)||L.localCoordSystem,G=xr(L,{initialSystem:Y,dragPreviewVertices:a,initialDragVertexStates:o,findVertexById:d,transformIndicatorData:r});B={...L,localCoordSystem:G}}ki(e,z,B,f,n,d,c,[],Y=>O.get(Y),!1,null,{faceColorMode:Bo(L,g),edgeColorMode:p,faceColorExpression:m,faceColorPolarExpression:x,edgeColorExpression:y,angleDisplayMode:S})}}),e.setLineDash([]),e.lineWidth=Ts;const F=dt(f.edge,{r:255,g:255,b:255,a:1}),V=L=>dt(L?.color||f.vertex||f.edge,F),N=(L,k,R,X)=>{const z=rs(L,p);if(z==="inherit_vertices"&&R&&X){const B=V(R),Y=V(X);return{r:Nt(B.r,Y.r,k),g:Nt(B.g,Y.g,k),b:Nt(B.b,Y.b,k),a:Nt(B.a,Y.a,k)}}if(z==="colormap"&&L.colormapItem){const B=L.colorExpression||y,Y=Fo(B,{x:k},k),G=Be(L.colormapItem,Y);return dt(G,F)}return dt(L.color||f.edge,F)},$=L=>O.get(L)||d(L);P.forEach(L=>{const k=O.get(L.id1),R=O.get(L.id2);if(k&&R){const X=L.interpolationStyleId&&b?b(L.interpolationStyleId):null,B=Ai(L,X,k,R,c,$,n).map(te=>n(te));if(B.length<2)return;const Y=B[0],G=B[B.length-1],W=rs(L,p);if(W==="inherit_vertices"||W==="colormap"){V(k),V(R);let te=0;for(let Q=1;Q<B.length;Q++)te+=Math.hypot(B[Q].x-B[Q-1].x,B[Q].y-B[Q-1].y);let J=0;for(let Q=1;Q<B.length;Q++){const ee=B[Q-1],ne=B[Q],ie=Math.hypot(ne.x-ee.x,ne.y-ee.y),de=te>0?J/te:0,le=te>0?(J+ie)/te:1,me=(de+le)/2,Te=N(L,me,k,R);e.strokeStyle=Xa(Te),e.beginPath(),e.moveTo(ee.x,ee.y),e.lineTo(ne.x,ne.y),e.stroke(),J+=ie}}else if(L.colormapItem){let te=0;for(let Q=1;Q<B.length;Q++)te+=Math.hypot(B[Q].x-B[Q-1].x,B[Q].y-B[Q-1].y);let J=0;for(let Q=1;Q<B.length;Q++){const ee=B[Q-1],ne=B[Q],ie=Math.hypot(ne.x-ee.x,ne.y-ee.y),de=te>0?J/te:0,le=te>0?(J+ie)/te:1,me=(de+le)/2,Te=L.gradientStart+(L.gradientEnd-L.gradientStart)*me,ot=Be(L.colormapItem,Te);e.strokeStyle=ot,e.beginPath(),e.moveTo(ee.x,ee.y),e.lineTo(ne.x,ne.y),e.stroke(),J+=ie}}else{e.strokeStyle=L.color||f.edge,e.beginPath(),e.moveTo(B[0].x,B[0].y);for(let te=1;te<B.length;te++)e.lineTo(B[te].x,B[te].y);e.stroke()}const oe=re(L);if((h?.get(oe)||[]).some(te=>te.copyIndex===_)){e.save(),e.strokeStyle=f.feedbackSnapped,e.globalAlpha=Ds,e.lineWidth=us,e.lineCap="round",e.lineJoin="round";const te=G.x-Y.x,J=G.y-Y.y,Q=Math.hypot(te,J),ee=_a;if(Q>ye){const ne=-J/Q,ie=te/Q,de=ne*ee,le=ie*ee;e.beginPath(),e.arc(Y.x,Y.y,ee,Math.atan2(le,de),Math.atan2(-le,-de)),e.lineTo(G.x-de,G.y-le),e.arc(G.x,G.y,ee,Math.atan2(-le,-de),Math.atan2(le,de)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(Y.x,Y.y,ee,0,He),e.stroke();e.restore()}}}),A.forEach(L=>{const k=M.has(L.id1)?L.id2:L.id1,R=M.has(L.id1)?L.id1:L.id2,X=O.get(R),z=d(k);if(X&&z){const B=L.interpolationStyleId&&b?b(L.interpolationStyleId):null,G=Ai(L,B,X,z,c,$,n).map(Q=>n(Q));if(G.length<2)return;const W=G[0],oe=G[G.length-1],U=rs(L,p);if(U==="inherit_vertices"||U==="colormap"){V(X),V(z);let Q=0;for(let ne=1;ne<G.length;ne++)Q+=Math.hypot(G[ne].x-G[ne-1].x,G[ne].y-G[ne-1].y);let ee=0;for(let ne=1;ne<G.length;ne++){const ie=G[ne-1],de=G[ne],le=Math.hypot(de.x-ie.x,de.y-ie.y),me=Q>0?ee/Q:0,Te=Q>0?(ee+le)/Q:1,ot=(me+Te)/2,qe=N(L,ot,X,z);e.strokeStyle=Xa(qe),e.beginPath(),e.moveTo(ie.x,ie.y),e.lineTo(de.x,de.y),e.stroke(),ee+=le}}else if(L.colormapItem){let Q=0;for(let ne=1;ne<G.length;ne++)Q+=Math.hypot(G[ne].x-G[ne-1].x,G[ne].y-G[ne-1].y);let ee=0;for(let ne=1;ne<G.length;ne++){const ie=G[ne-1],de=G[ne],le=Math.hypot(de.x-ie.x,de.y-ie.y),me=Q>0?ee/Q:0,Te=Q>0?(ee+le)/Q:1,ot=(me+Te)/2,qe=L.gradientStart+(L.gradientEnd-L.gradientStart)*ot,Ht=Be(L.colormapItem,qe);e.strokeStyle=Ht,e.beginPath(),e.moveTo(ie.x,ie.y),e.lineTo(de.x,de.y),e.stroke(),ee+=le}}else{e.strokeStyle=L.color||f.edge,e.beginPath(),e.moveTo(G[0].x,G[0].y);for(let Q=1;Q<G.length;Q++)e.lineTo(G[Q].x,G[Q].y);e.stroke()}const te=re(L);if((h?.get(te)||[]).some(Q=>Q.copyIndex===_)){e.save(),e.strokeStyle=f.feedbackSnapped,e.globalAlpha=Ds,e.lineWidth=us,e.lineCap="round",e.lineJoin="round";const Q=oe.x-W.x,ee=oe.y-W.y,ne=Math.hypot(Q,ee),ie=_a;if(ne>ye){const de=-ee/ne,le=Q/ne,me=de*ie,Te=le*ie;e.beginPath(),e.arc(W.x,W.y,ie,Math.atan2(Te,me),Math.atan2(-Te,-me)),e.lineTo(oe.x-me,oe.y-Te),e.arc(oe.x,oe.y,ie,Math.atan2(-Te,-me),Math.atan2(Te,me)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(W.x,W.y,ie,0,He),e.stroke();e.restore()}}}),D.forEach(L=>{const k=L.originalId,R=u.get(k)||[],X=R.some(Y=>Y.copyIndex===_),z=R.find(Y=>Y.copyIndex===_),B=z?z.type:null;mr(e,L,{colors:f,verticesVisible:!0,isSnapped:!1},n),X&&Sr(e,L,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:f,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:B,currentAltPressed:!1},n)})}e.restore()}function Sr(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,isSnapped:f=!1,snapType:h=null,currentAltPressed:u}=n;if(u&&d)return;let p;if(t.type===Ln){if(p=o.includes(t.id),!l&&!p&&!d&&!f)return}else p=a.includes(t.id);if(p||d||f){const y=s(t);e.save();let m=c.selectionGlow;t.id===r&&t.type!=="regular"?m=c.activeCenterGlow:f?m=c.feedbackSnapped:d&&(m=c.selectionGlow),e.shadowColor=m,e.shadowBlur=rr,e.globalAlpha=Ds,e.strokeStyle=m,e.lineWidth=us,e.beginPath();let x;t.type===Ln?x=Ke+Pi:x=Ui+Pi,e.arc(y.x,y.y,x,0,He),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function zh(e,t,n){const{copyCount:s=1,initialDragVertexStates:i,dragPreviewVertices:o,allEdges:a,allFaces:r,findVertexById:c,findNeighbors:l,findAllVerticesInSubgraph:d,colors:f,snappedEdgesInfo:h,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",faceColorExpression:m="x",faceColorPolarExpression:x="r",angleDisplayMode:S="degrees",initialCoordSystemStates:I=new Map,getInterpolationStyleById:b}=t;if(!i||i.length!==1||!o||o.length===0)return;const E=i[0];for(let T=0;T<s;T++){T+=s==1;const M=T,P=T;let A;const v=o.length>0?o[0].x-i[0].x:0,w=o.length>0?o[0].y-i[0].y:0;A={x:E.x+v*P,y:E.y+w*P};const _={...E,...A,originalId:E.id,transformIndex:M},C=new Set(d(E.id)),D=a.filter(L=>C.has(L.id1)&&C.has(L.id2)),O=r.filter(L=>L.vertexIds.every(k=>C.has(k))),F=L=>L===E.id?_:C.has(L)?c(L):null;O.forEach(L=>{const k=L.vertexIds.map(F).filter(Boolean);if(k.length>=3){const R=L.interpolationStyleId&&b?b(L.interpolationStyleId):null,z=(R?gs(k,R,!0,n):k).map(Y=>n(Y));let B=L;if(L.localCoordSystem){const Y=I.get(L.id)||L.localCoordSystem,G=xr(L,{initialSystem:Y,dragPreviewVertices:o,initialDragVertexStates:i,findVertexById:c,transformIndicatorData:null});B={...L,localCoordSystem:G}}ki(e,z,B,f,n,c,a,r,F,!0,null,{faceColorMode:Bo(L,g),edgeColorMode:p,faceColorExpression:m,faceColorPolarExpression:x,edgeColorExpression:y,angleDisplayMode:S})}}),e.save(),e.lineWidth=Ts,e.setLineDash([]);const V=dt(f.edge,{r:255,g:255,b:255,a:1}),N=L=>dt(L?.color||f.vertex||f.edge,V),$=(L,k,R,X)=>{const z=rs(L,p);if(z==="inherit_vertices"&&R&&X){const B=N(R),Y=N(X);return{r:Nt(B.r,Y.r,k),g:Nt(B.g,Y.g,k),b:Nt(B.b,Y.b,k),a:Nt(B.a,Y.a,k)}}if(z==="colormap"&&L.colormapItem){const B=L.colorExpression||y,Y=Fo(B,{x:k},k),G=Be(L.colormapItem,Y);return dt(G,V)}return dt(L.color||f.edge,V)};D.forEach(L=>{const k=F(L.id1),R=F(L.id2);if(k&&R){const X=L.interpolationStyleId&&b?b(L.interpolationStyleId):null,Y=Ai(L,X,k,R,a,J=>F(J),n).map(J=>n(J));if(Y.length<2)return;const G=Y[0],W=Y[Y.length-1],oe=rs(L,p);if(oe==="inherit_vertices"||oe==="colormap"){let J=0;for(let ee=1;ee<Y.length;ee++)J+=Math.hypot(Y[ee].x-Y[ee-1].x,Y[ee].y-Y[ee-1].y);let Q=0;for(let ee=1;ee<Y.length;ee++){const ne=Y[ee-1],ie=Y[ee],de=Math.hypot(ie.x-ne.x,ie.y-ne.y),le=J>0?Q/J:0,me=J>0?(Q+de)/J:1,Te=(le+me)/2,ot=$(L,Te,k,R);e.strokeStyle=Xa(ot),e.beginPath(),e.moveTo(ne.x,ne.y),e.lineTo(ie.x,ie.y),e.stroke(),Q+=de}}else if(L.colormapItem){let J=0;for(let ee=1;ee<Y.length;ee++)J+=Math.hypot(Y[ee].x-Y[ee-1].x,Y[ee].y-Y[ee-1].y);let Q=0;for(let ee=1;ee<Y.length;ee++){const ne=Y[ee-1],ie=Y[ee],de=Math.hypot(ie.x-ne.x,ie.y-ne.y),le=J>0?Q/J:0,me=J>0?(Q+de)/J:1,Te=(le+me)/2,ot=L.gradientStart+(L.gradientEnd-L.gradientStart)*Te,qe=Be(L.colormapItem,ot);e.strokeStyle=qe,e.beginPath(),e.moveTo(ne.x,ne.y),e.lineTo(ie.x,ie.y),e.stroke(),Q+=de}}else{e.strokeStyle=L.color||f.edge,e.beginPath(),e.moveTo(Y[0].x,Y[0].y);for(let J=1;J<Y.length;J++)e.lineTo(Y[J].x,Y[J].y);e.stroke()}const U=re(L);if((h?.get(U)||[]).some(J=>J.copyIndex===M)){e.save(),e.strokeStyle=f.feedbackSnapped,e.globalAlpha=Ds,e.lineWidth=us,e.lineCap="round",e.lineJoin="round";const J=W.x-G.x,Q=W.y-G.y,ee=Math.hypot(J,Q),ne=_a;if(ee>ye){const ie=-Q/ee,de=J/ee,le=ie*ne,me=de*ne;e.beginPath(),e.arc(G.x,G.y,ne,Math.atan2(me,le),Math.atan2(-me,-le)),e.lineTo(W.x-le,W.y-me),e.arc(W.x,W.y,ne,Math.atan2(-me,-le),Math.atan2(me,le)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(G.x,G.y,ne,0,He),e.stroke();e.restore()}}}),e.restore(),C.forEach(L=>{const k=F(L);if(!k)return;const R=L===E.id,X=u.get(E.id)||[],z=R&&X.some(W=>W.copyIndex===M),B=R?X.find(W=>W.copyIndex===M):null,Y=B?B.type:null,G={...k,id:`preview_${k.originalId||k.id}_${M}`,originalId:k.originalId||k.id,transformIndex:M};mr(e,G,{colors:f,verticesVisible:!0,isSnapped:!1},n),z&&Sr(e,G,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:f,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:Y,currentAltPressed:!1},n)})}}function Hl(e,{startVertex:t,snappedData:n,isShiftPressed:s,currentColor:i,nextCreationColor:o,nextEdgeColor:a,colors:r,edgeColormapInfo:c,interpolationStyle:l},d){const f=d(t),h=d(n);e.save();let u=[{x:t.x,y:t.y},{x:n.x,y:n.y}];if(l&&l.type&&l.type!=="linear"?(u=gs(u,l,!1,null),e.setLineDash([])):e.setLineDash(zn),c&&c.colormapItem){const m=e.createLinearGradient(f.x,f.y,h.x,h.y),x=Be(c.colormapItem,c.startT),S=Be(c.colormapItem,c.endT);m.addColorStop(0,x),m.addColorStop(1,S),e.strokeStyle=m}else n.snapped||s?e.strokeStyle=r.feedbackSnapped:e.strokeStyle=a;e.lineWidth=Ts;const g=u.map(m=>d(m));e.beginPath(),e.moveTo(g[0].x,g[0].y);for(let m=1;m<g.length;m++)e.lineTo(g[m].x,g[m].y);if(e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(h.x,h.y,Ke,0,He),n.snapped?e.fillStyle=r.feedbackSnapped:e.fillStyle=o,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=r.feedbackSnapped,e.shadowBlur=rr,e.globalAlpha=Ds,e.strokeStyle=r.feedbackSnapped,e.lineWidth=us;const m=Ke+Pi;e.beginPath(),e.arc(h.x,h.y,m,0,He),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function _i(e,t,n){const s=[];if(n>360){const o=n-360,a=Math.floor(t/e)*e;for(let r=a;r<360;r+=e)r>=t&&s.push(r);for(let r=0;r<=o+e;r+=e)r<=o&&s.push(r)}else{const o=Math.floor(t/e)*e;for(let a=o;a<=n+e;a+=e)a>=t&&a<=n&&a>=0&&a<360&&s.push(a)}return[...new Set(s)].sort((o,a)=>o-a)}function Hh(e,t,n){return e.x>=-20&&e.x<=t+Rt&&e.y>=-20&&e.y<=n+Rt}function Wh(e,t,n,s,i,{canvas:o,dpr:a,viewTransform:r,angleDisplayMode:c,colors:l},d,f){if(typeof d!="function"||typeof n!="function")return;const h=d({x:0,y:0}),u=o.width/a,p=o.height/a,g={x:u/2,y:p/2},y=Math.min(u,p)/4,m=ae(h,g),x=y+m;if(x<Nl||!Wl(h.x,h.y,x,u,p))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=pn;const S=Math.min(u,p)*400,I=x>S;let b=null;if(I){const w={x:0,y:0,w:u,h:p},_={x:h.x,y:h.y,r:x},C=Ya(_,w);if(C.length>=2){let D=C[0],O=C[1],F=0;for(let $=0;$<C.length;$++)for(let L=$+1;L<C.length;L++){const k=(C[$].x-C[L].x)**2+(C[$].y-C[L].y)**2;k>F&&(F=k,D=C[$],O=C[L])}e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(O.x,O.y),e.stroke();const V=(Math.atan2(h.y-D.y,D.x-h.x)*180/Math.PI+360)%360,N=(Math.atan2(h.y-O.y,O.x-h.x)*180/Math.PI+360)%360;b={minAngle:Math.min(V,N),maxAngle:Math.max(V,N),isFullCircle:!1},Math.abs(V-N)>180&&(b={minAngle:Math.max(V,N),maxAngle:Math.min(V,N)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(h.x,h.y,x,0,2*Math.PI),e.stroke(),b=zl(h,x,u,p);if(e.restore(),!b)return;const E=x/(r.scale/a),T=new Set,M=new Map;f.forEach(w=>{const _=w.alpha;if(_<Rl||x*(w.angle*Math.PI/180)<Fl*.5)return;const D=`rgba(${l.feedbackDefault.join(",")}, ${_*Ed})`;let O;if(b.isFullCircle){O=[];for(let F=0;F<360;F+=w.angle)O.push(F)}else O=[],b.ranges&&Array.isArray(b.ranges)?b.ranges.forEach(F=>{const[V,N]=F,$=_i(w.angle,V,N);O.push(...$)}):b.minAngle!==void 0&&b.maxAngle!==void 0&&(O=_i(w.angle,b.minAngle,b.maxAngle)),O=[...new Set(O)];O.forEach(F=>{if(F=Math.round(F*1e10)/1e10,c==="degrees"){if(T.has(F))return}else if(c==="radians"){const X=`${F}-${w.angle}`;if(M.has(X))return}const V=F*Math.PI/180,N={x:h.x+(x+Ti)*Math.cos(V),y:h.y-(x+Ti)*Math.sin(V)},$=Td;if(!(N.x>-$&&N.x<u+$&&N.y>-$&&N.y<p+$))return;let k={textAlign:"center",textBaseline:"middle"};if(c==="radians"&&(k={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=D,e.lineWidth=Kn,F%90===0&&F<360){const X={x:h.x+x*Math.cos(V),y:h.y-x*Math.sin(V)};let z;const B=ut*1.5;switch(F){case 0:z={x:Math.SQRT1_2,y:-Math.SQRT1_2},k={textAlign:"left",textBaseline:"bottom"};break;case 90:z={x:Math.SQRT1_2,y:-Math.SQRT1_2},k={textAlign:"left",textBaseline:"bottom"};break;case 180:z={x:-Math.SQRT1_2,y:-Math.SQRT1_2},k={textAlign:"right",textBaseline:"bottom"};break;case 270:z={x:Math.SQRT1_2,y:Math.SQRT1_2},k={textAlign:"left",textBaseline:"top"};break}const Y={x:X.x+z.x*B,y:X.y+z.y*B};e.lineWidth=Cd,e.beginPath(),e.moveTo(X.x,X.y),e.lineTo(Y.x,Y.y),e.stroke(),N.x=Y.x,N.y=Y.y}else{const X={x:h.x+(x-Ke)*Math.cos(V),y:h.y-(x-Ke)*Math.sin(V)},z={x:h.x+(x+Ke)*Math.cos(V),y:h.y-(x+Ke)*Math.sin(V)};Hh(z,u,p)&&(e.beginPath(),e.moveTo(X.x,X.y),e.lineTo(z.x,z.y),e.stroke())}e.restore();let R="";if(c==="degrees"){let X=Math.max(0,(w.angle.toString().split(".")[1]||"").length);w.angle<1&&(X=Math.max(X,Math.ceil(-Math.log10(w.angle))+1));const z=Math.round(F*Math.pow(10,X))/Math.pow(10,X),B=parseFloat(z.toFixed(X));R=`${Math.round(B*1e10)/1e10}^{\\circ}`}else if(F===0&&c==="radians")R="0";else if(F!==0)if(w.angle<=5){const z=F*Math.PI/180,B=Math.max(0,(w.angle.toString().split(".")[1]||"").length),Y=Math.max(3,B+2);let G=z.toFixed(Y);G=parseFloat(G).toString(),parseFloat(G)!==0&&(R=G)}else{const z=F,B=180,Y=pr(z,B),G=z/Y,W=B/Y;W===1?G===1?R="\\pi":G===-1?R="-\\pi":R=`${G}\\pi`:G===1?R=`\\frac{\\pi}{${W}}`:G===-1?R=`-\\frac{\\pi}{${W}}`:G<0?R=`-\\frac{${Math.abs(G)}\\pi}{${W}}`:R=`\\frac{${G}\\pi}{${W}}`}if(R){const X=c==="radians"?`circ-label-${F}-${w.angle}-${E.toExponential(15)}`:`circ-label-${F}-${E.toExponential(15)}`;if(n({id:X,content:R,x:N.x,y:N.y,color:D,fontSize:Ba,options:k}),c==="degrees")T.add(F);else{const z=`${F}-${w.angle}`;M.set(z,{levelAngle:w.angle,alpha:_,labelId:X})}}})});const P=l.feedbackDefault;let A=-1/0;const v={x:h.x+x,y:h.y};if(v.x>-20&&v.x<u+Rt&&v.y>-20&&v.y<p+Rt)A=0;else{const w={x:0,y:0,w:u,h:p},_={x:h.x,y:h.y,r:x},C=Ya(_,w);if(C.length>0){let D=-1/0;C.forEach(F=>{const V=Math.atan2(h.y-F.y,F.x-h.x),N=V>=0?V:V+2*Math.PI,$={x:h.x+x*Math.cos(N),y:h.y-x*Math.sin(N)},L=Rt;$.x>-L&&$.x<u+L&&$.y>-L&&$.y<p+L&&N>D&&(D=N)}),[{x:0,y:0},{x:w.w,y:0},{x:w.w,y:w.h},{x:0,y:w.h}].forEach(F=>{if(ae(F,h)<_.r){const V=Math.atan2(h.y-F.y,F.x-h.x),N=V>=0?V:V+2*Math.PI,$={x:h.x+x*Math.cos(N),y:h.y-x*Math.sin(N)},L=Rt;$.x>-L&&$.x<u+L&&$.y>-L&&$.y<p+L&&N>D&&(D=N)}}),D>-1/0&&(A=D)}}if(A>-1/0){const w=A,_={x:h.x+x*Math.cos(w),y:h.y-x*Math.sin(w)},C={x:-Math.sin(w),y:-Math.cos(w)},D={x:Math.cos(w),y:-Math.sin(w)},O={x:_.x-$e*C.x+$e/2*D.x,y:_.y-$e*C.y+$e/2*D.y},F={x:_.x-$e*C.x-$e/2*D.x,y:_.y-$e*C.y-$e/2*D.y};e.save(),e.fillStyle=`rgba(${P.join(",")}, 1.0)`,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(O.x,O.y),e.lineTo(F.x,F.y),e.closePath(),e.fill(),e.restore();let V;if(w===0)V={x:_.x-ga,y:_.y+pa+$e};else{const N={x:-Math.cos(w),y:Math.sin(w)};V={x:_.x+N.x*(pa+$e)+C.x*ga,y:_.y+N.y*(pa+$e)+C.y*ga}}n({id:"theta-label-sticky",content:"\\theta",x:V.x,y:V.y,color:`rgba(${P.join(",")}, 1.0)`,fontSize:ns,options:{textAlign:"center",textBaseline:"middle"}})}}function Ya(e,t){const{x:n,y:s,r:i}=e,{x:o,y:a,w:r,h:c}=t,l=[],d={center:{x:n,y:s},radius:i},f=(h,u,p,g)=>{yr({p1:{x:h,y:u},p2:{x:p,y:g}},d).forEach(x=>{const S=p-h,I=g-u;let b;Math.abs(S)>Math.abs(I)?b=(x.x-h)/S:b=(x.y-u)/I,b>=0&&b<=1&&l.push({x:x.x,y:x.y})})};return f(o,a,o+r,a),f(o+r,a,o+r,a+c),f(o+r,a+c,o,a+c),f(o,a+c,o,a),l}function Wl(e,t,n,s,i){return!(e+n<0||e-n>s||t+n<0||t-n>i)}function Kh(e,t,n,s,i,o,a){const r=`rgba(${a.axisTickLabel.join(",")}, ${Ei})`,c=ut*fd;e.save(),e.strokeStyle=r,e.lineWidth=ud,e.setLineDash([]);const l=c,d=l/Math.tan(hd),f=t.x-d,h=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(f,h),e.stroke(),e.restore(),o({id:"tick-label-origin",content:Ad,x:t.x-ut-ss,y:t.y+ut+ss,color:r,fontSize:Cs,options:{textAlign:"right",textBaseline:"top"}})}function qh(e,t,{canvas:n,dpr:s,coordsDisplayMode:i,viewTransform:o,angleDisplayMode:a,colors:r},c,l,d,f,h){e.save();const u=n.width/s,p=n.height/s,g=c({x:0,y:0}),y=(S,I,b,E)=>{e.beginPath(),e.moveTo(S,I),e.lineTo(b,E),e.stroke();const T=Math.atan2(E-I,b-S);e.beginPath(),e.moveTo(b,E),e.lineTo(b-$e*Math.cos(T-fn),E-$e*Math.sin(T-fn)),e.lineTo(b-$e*Math.cos(T+fn),E-$e*Math.sin(T+fn)),e.closePath(),e.fill()},m=(S,I,b,E,T)=>{const M=new Map,P=new Map,A=(V,N,$)=>{if(!V||N<Ji)return;const L=l({x:0,y:0}),k=l({x:u,y:p}),R=V*ye;{const X=Math.floor(L.x/V),z=Math.ceil(k.x/V),B=Math.floor(k.y/V),Y=Math.ceil(L.y/V);for(let G=X;G<=z;G++){const W=G*V;if(Math.abs(W)<R)continue;const oe=M.get(W);oe?$?M.set(W,{alpha:Math.max(oe.alpha,N),isCoarser:!0}):oe.isCoarser||M.set(W,{alpha:Math.max(oe.alpha,N),isCoarser:!1}):M.set(W,{alpha:N,isCoarser:$})}for(let G=B;G<=Y;G++){const W=G*V;if(Math.abs(W)<R)continue;const oe=P.get(W);oe?$?P.set(W,{alpha:Math.max(oe.alpha,N),isCoarser:!0}):oe.isCoarser||P.set(W,{alpha:Math.max(oe.alpha,N),isCoarser:!1}):P.set(W,{alpha:N,isCoarser:$})}}},v=!b||S>=b;A(S,I,v),A(b,E,!v);let w=!1;const _=V=>{const N=Math.abs(V);(N>=$a||N>0&&N<Va)&&(w=!0)};M.forEach((V,N)=>_(N)),P.forEach((V,N)=>_(N));const C=l({x:0,y:0}),D=l({x:u,y:p});_(C.x),_(C.y),_(D.x),_(D.y);const O=S||b||1,F=O>0?Math.max(0,-Math.floor(Math.log10(O))):0;return M.forEach((V,N)=>{const $=V.isCoarser?1:V.alpha,L=`rgba(${r.axisTickLabel.join(",")}, ${Ei*$})`;e.strokeStyle=L,e.lineWidth=Kn;{const k=c({x:N,y:0}).x;e.beginPath(),e.moveTo(k,g.y),e.lineTo(k,g.y+ut),e.stroke();let R;if(w){const z=Math.log10(Math.abs(N)),B=Math.floor(z),Y=O/Math.pow(10,B),G=Math.max(0,-Math.floor(Math.log10(Y))+1),oe=Math.abs(N).toExponential(G).split("e");let U=oe[0];U=U.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let te=parseInt(oe[1],10);R=`${N<0?"-":""}${U} \\cdot 10^{${te}}`}else R=N.toFixed(F).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");h({id:((z,B)=>`${z}-${B.toExponential(15)}`)("tick-label-x",N),content:R,x:k,y:g.y+ut+ss,color:L,fontSize:Cs,options:{textAlign:"center",textBaseline:"top"}})}}),P.forEach((V,N)=>{const $=V.isCoarser?1:V.alpha,L=`rgba(${r.axisTickLabel.join(",")}, ${Ei*$})`;e.strokeStyle=L,e.lineWidth=Kn;const k=c({x:0,y:N}).y;let R;if(w){const z=Math.log10(Math.abs(N)),B=Math.floor(z),Y=O/Math.pow(10,B),G=Math.max(0,-Math.floor(Math.log10(Y))+1),oe=Math.abs(N).toExponential(G).split("e");let U=oe[0];U=U.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let te=parseInt(oe[1],10);R=`${N<0?"-":""}${U} \\cdot 10^{${te}}`}else R=N.toFixed(F).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");i===Lo&&Math.abs(N)>ye&&(R==="1"?R=hi:R==="-1"?R=`-${hi}`:R+=hi),e.beginPath(),e.moveTo(g.x,k),e.lineTo(g.x-ut,k),e.stroke(),h({id:((z,B)=>`${z}-${B.toExponential(15)}`)("tick-label-y",N),content:R,x:g.x-ut-ss,y:k,color:L,fontSize:Cs,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:w}};e.lineWidth=Pd,e.strokeStyle=r.axis,e.fillStyle=r.axis;let x={useScientific:!1};if(i===ea){const{interval1:S,interval2:I,alpha1:b,alpha2:E}=d;Uh(e,t,{canvas:n,dpr:s,colors:r},c,h);let T=!1;const M=v=>{const w=Math.abs(v);(w>=$a||w>0&&w<Va)&&(T=!0)},P=l({x:0,y:0}),A=l({x:u,y:p});M(P.x),M(P.y),M(A.x),M(A.y),jh(e,t,{canvas:n,dpr:s,colors:r},c,l,d,h,T),Wh(e,t,h,0,0,{canvas:n,dpr:s,viewTransform:o,angleDisplayMode:a,colors:r},c,f),x={useScientific:T}}else{g.y>0&&g.y<p&&y(0,g.y,u,g.y),g.x>0&&g.x<u&&y(g.x,p,g.x,0);let S="x",I="y";i===Lo&&(S=_d,I=Dd),h({id:"axis-label-x",content:S,x:u-$e-ka,y:g.y-Da,color:r.axis,fontSize:ns,options:{textAlign:"center",textBaseline:"bottom"}}),h({id:"axis-label-y",content:I,x:g.x+Ra,y:$e+La,color:r.axis,fontSize:ns,options:{textAlign:"left",textBaseline:"middle"}}),x=m(d.interval1,d.alpha1,d.interval2,d.alpha2)}return Kh(e,g,u,p,i,h,r),e.restore(),x}function jh(e,t,{canvas:n,dpr:s,colors:i},o,a,r,c,l){const d=n.width/s,f=n.height/s,h=o({x:0,y:0}),u=h.y>-20&&h.y<f+Rt,p=h.x>-20&&h.x<d+Rt;if(!u&&!p)return;const{interval1:g,interval2:y,alpha1:m,alpha2:x}=r,S=new Map,I=g||y||1,b=I>0?Math.max(0,-Math.floor(Math.log10(I))):0,E=(M,P,A)=>{if(!M||P<Ji)return;let v=0;if(u){const O=a({x:0,y:h.y}),F=a({x:d,y:h.y});v=Math.max(v,Math.abs(O.x),Math.abs(F.x))}if(p){const O=a({x:h.x,y:0}),F=a({x:h.x,y:f});v=Math.max(v,Math.abs(O.y),Math.abs(F.y))}v*=1.1;const w=1,_=Math.ceil(v/M),D=Math.min(_,w+1e3);for(let O=w;O<=D;O++){const F=O*M;let V=!1;if(u){const N=o({x:F,y:0}).x,$=o({x:-F,y:0}).x;(N>=-20&&N<=d+Rt||$>=-20&&$<=d+Rt)&&(V=!0)}if(!V&&p){const N=o({x:0,y:F}).y,$=o({x:0,y:-F}).y;(N>=-20&&N<=f+Rt||$>=-20&&$<=f+Rt)&&(V=!0)}if(V){const N=S.get(F);N?A?S.set(F,{alpha:Math.max(N.alpha,P),isCoarser:!0}):N.isCoarser||S.set(F,{alpha:Math.max(N.alpha,P),isCoarser:!1}):S.set(F,{alpha:P,isCoarser:A})}}},T=!y||g>=y;E(g,m,T),E(y,x,!T),S.forEach((M,P)=>{const A=M.isCoarser?1:M.alpha,v=`rgba(${i.axisTickLabel.join(",")}, ${Ei*A})`;e.strokeStyle=v,e.lineWidth=Kn;let w;if(l){const C=Math.log10(Math.abs(P)),D=Math.floor(C),O=I/Math.pow(10,D),F=Math.max(0,-Math.floor(Math.log10(O))+1),N=Math.abs(P).toExponential(F).split("e");let $=N[0];$=$.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let L=parseInt(N[1],10);w=`${P<0?"-":""}${$} \\cdot 10^{${L}}`}else w=P.toFixed(b).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const _=P.toExponential(15);if(u){const C=o({x:P,y:0});C.x>-20&&C.x<d+Rt&&(e.beginPath(),e.moveTo(C.x,h.y-ut/2),e.lineTo(C.x,h.y+ut/2),e.stroke(),c({id:`polartick-r-x-${_}`,content:w,x:C.x,y:h.y+ut+ss,color:v,fontSize:Cs,options:{textAlign:"center",textBaseline:"top"}}));const D=o({x:-P,y:0});D.x>-20&&D.x<d+Rt&&(e.beginPath(),e.moveTo(D.x,h.y-ut/2),e.lineTo(D.x,h.y+ut/2),e.stroke(),c({id:`polartick-r-negx-${_}`,content:w,x:D.x,y:h.y+ut+ss,color:v,fontSize:Cs,options:{textAlign:"center",textBaseline:"top"}}))}if(p){const C=o({x:0,y:P});C.y>-20&&C.y<f+Rt&&(e.beginPath(),e.moveTo(h.x-ut/2,C.y),e.lineTo(h.x+ut/2,C.y),e.stroke(),c({id:`polartick-r-posy-${_}`,content:w,x:h.x-ut-ss,y:C.y,color:v,fontSize:Cs,options:{textAlign:"right",textBaseline:"middle"}}));const D=o({x:0,y:-P});D.y>-20&&D.y<f+Rt&&(e.beginPath(),e.moveTo(h.x-ut/2,D.y),e.lineTo(h.x+ut/2,D.y),e.stroke(),c({id:`polartick-r-negy-${_}`,content:w,x:h.x-ut-ss,y:D.y,color:v,fontSize:Cs,options:{textAlign:"right",textBaseline:"middle"}}))}})}function Uh(e,t,{canvas:n,dpr:s,colors:i},o,a){const r=n.width/s,c=n.height/s,l=o({x:0,y:0}),d=(g,y,m,x)=>{e.beginPath(),e.moveTo(g,y),e.lineTo(m,x),e.stroke();const S=Math.atan2(x-y,m-g);e.beginPath(),e.moveTo(m,x),e.lineTo(m-$e*Math.cos(S-fn),x-$e*Math.sin(S-fn)),e.lineTo(m-$e*Math.cos(S+fn),x-$e*Math.sin(S+fn)),e.closePath(),e.fill()};e.lineWidth=Kn;const f=r>l.x,h=0<l.x,u=0<l.y,p=c>l.y;f&&(d(l.x,l.y,r,l.y),a({id:"axis-label-r-posx",content:oi,x:r-$e-ka,y:l.y-Da,color:i.axis,fontSize:ns,options:{textAlign:"center",textBaseline:"bottom"}})),h&&(d(l.x,l.y,0,l.y),a({id:"axis-label-r-negx",content:oi,x:$e+ka,y:l.y-Da,color:i.axis,fontSize:ns,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(d(l.x,l.y,l.x,0),a({id:"axis-label-r-posy",content:oi,x:l.x+Ra,y:$e+La,color:i.axis,fontSize:ns,options:{textAlign:"left",textBaseline:"middle"}})),p&&(d(l.x,l.y,l.x,c),a({id:"axis-label-r-negy",content:oi,x:l.x+Ra,y:c-$e-La,color:i.axis,fontSize:ns,options:{textAlign:"left",textBaseline:"middle"}}))}function Jh(e,{canvas:t,dpr:n,colors:s,gridAlpha:i},o,a,r,c,l){const d=t.width/n,f=t.height/n,h=Math.min(d,f)*dd;let u,p;if(o.x>=0&&o.x<=d&&o.y>=0&&o.y<=f)u=0;else{const v=[ai(o.x,o.y,0,0,d,0),ai(o.x,o.y,d,0,d,f),ai(o.x,o.y,d,f,0,f),ai(o.x,o.y,0,f,0,0)];u=Math.min(...v)}const y=[{x:0,y:0},{x:d,y:0},{x:d,y:f},{x:0,y:f}].map(v=>Math.sqrt((v.x-o.x)**2+(v.y-o.y)**2));p=Math.max(...y);const m=u*n/r.scale,x=p*n/r.scale,S=(v,w)=>{if(!v||w<Ji||v*r.scale/n<nh)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${w*i})`,e.lineWidth=Kn;const C=m===0?1:Math.ceil(m/v),D=Math.floor(x/v);for(let O=C;O<=D;O++){const V=O*v*r.scale/n;if(V>h){const N=[],$={center:{x:o.x,y:o.y},radius:V};if([{p1:{x:0,y:0},p2:{x:d,y:0}},{p1:{x:d,y:0},p2:{x:d,y:f}},{p1:{x:d,y:f},p2:{x:0,y:f}},{p1:{x:0,y:f},p2:{x:0,y:0}}].forEach(k=>{yr(k,$).forEach(X=>{X.x>=0&&X.x<=d&&X.y>=0&&X.y<=f&&N.push(X)})}),N.length>=2){let k=N[0],R=N[1],X=0;for(let z=0;z<N.length;z++)for(let B=z+1;B<N.length;B++){const Y=(N[z].x-N[B].x)**2+(N[z].y-N[B].y)**2;Y>X&&(X=Y,k=N[z],R=N[B])}e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(R.x,R.y),e.stroke()}}else e.beginPath(),e.arc(o.x,o.y,V,0,He),e.stroke()}};if(S(c.interval1,c.alpha1),S(c.interval2,c.alpha2),!l||!Array.isArray(l))return;const I={x:d/2,y:f/2},b=Math.min(d,f)/4,E=Math.sqrt((o.x-I.x)**2+(o.y-I.y)**2),T=b+E;if(T<Nl||!Wl(o.x,o.y,T,d,f))return;const M=T>h;let P=null;if(M){const v={x:0,y:0,w:d,h:f},w={x:o.x,y:o.y,r:T},_=Ya(w,v);if(_.length>=2){let C=_[0],D=_[1],O=0;for(let N=0;N<_.length;N++)for(let $=N+1;$<_.length;$++){const L=(_[N].x-_[$].x)**2+(_[N].y-_[$].y)**2;L>O&&(O=L,C=_[N],D=_[$])}const F=(Math.atan2(o.y-C.y,C.x-o.x)*180/Math.PI+360)%360,V=(Math.atan2(o.y-D.y,D.x-o.x)*180/Math.PI+360)%360;P={minAngle:Math.min(F,V),maxAngle:Math.max(F,V),isFullCircle:!1},Math.abs(F-V)>180&&(P={minAngle:Math.max(F,V),maxAngle:Math.min(F,V)+360,isFullCircle:!1})}}else P=zl(o,T,d,f);if(!P)return;const A=new Set;l.forEach(v=>{const w=v.alpha;if(w<Rl||T*(v.angle*Math.PI/180)<Fl*.5)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${w*i})`,e.lineWidth=Kn*wd;let C;if(P.isFullCircle){C=[];for(let D=0;D<360;D+=v.angle)C.push(D)}else{if(C=[],P.ranges&&Array.isArray(P.ranges))P.ranges.forEach(D=>{let[O,F]=D;if(M){const L=[...[{x:0,y:0},{x:d,y:0},{x:d,y:f},{x:0,y:f}].map(X=>(Math.atan2(o.y-X.y,X.x-o.x)*180/Math.PI+360)%360),O,F].sort((X,z)=>X-z),k=Math.min(...L)-v.angle*2,R=Math.max(...L)+v.angle*2;O=k,F=R}const V=_i(v.angle,O,F);C.push(...V)});else if(P.minAngle!==void 0&&P.maxAngle!==void 0){let D=P.minAngle,O=P.maxAngle;if(M){const N=[...[{x:0,y:0},{x:d,y:0},{x:d,y:f},{x:0,y:f}].map(k=>(Math.atan2(o.y-k.y,k.x-o.x)*180/Math.PI+360)%360),D,O].sort((k,R)=>k-R),$=Math.min(...N)-v.angle*2,L=Math.max(...N)+v.angle*2;D=$,O=L}C=_i(v.angle,D,O)}C=[...new Set(C)]}C.forEach(D=>{if(D=Math.round(D*1e10)/1e10,A.has(D))return;const O=D*Math.PI/180,F={x:o.x+m*r.scale/n*Math.cos(O),y:o.y-m*r.scale/n*Math.sin(O)},V={x:o.x+x*r.scale/n*Math.cos(O),y:o.y-x*r.scale/n*Math.sin(O)};e.beginPath(),e.moveTo(F.x,F.y),e.lineTo(V.x,V.y),e.stroke(),A.add(D)})})}function Zh(e,{gridDisplayMode:t,canvas:n,dpr:s,viewTransform:i,gridAlpha:o,colors:a},r,c,l,d){if(t===Wo)return;e.save();const f=r({x:0,y:0}),h=n.width/s,u=n.height/s;if(t===gr){const p=c({x:0,y:0}),g=c({x:h,y:u}),y=Math.hypot(Math.max(Math.abs(p.x),Math.abs(g.x)),Math.max(Math.abs(p.y),Math.abs(g.y)));Jh(e,{canvas:n,dpr:s,colors:a,gridAlpha:o},f,y,i,l,d)}else{const p=(g,y)=>{if(!g||y<Ji)return;const m=`rgba(${a.grid.join(",")}, ${y*o})`,x=c({x:0,y:u}),S=c({x:h,y:0}),I=Math.floor(x.x/g),b=Math.ceil(S.x/g),E=Math.floor(x.y/g),T=Math.ceil(S.y/g);if(t===hr){e.strokeStyle=m,e.lineWidth=Kn;for(let M=I;M<=b;M++){const P=M*g,A=r({x:P,y:0}).x;e.beginPath(),e.moveTo(A,0),e.lineTo(A,u),e.stroke()}for(let M=E;M<=T;M++){const P=M*g,A=r({x:0,y:P}).y;e.beginPath(),e.moveTo(0,A),e.lineTo(h,A),e.stroke()}}else if(t===fr){e.fillStyle=m;const M=nl*s;for(let P=I;P<=b;P++){const A=P*g;for(let v=E;v<=T;v++){const w=v*g,_=r({x:A,y:w});e.beginPath(),e.arc(_.x,_.y,M,0,He),e.fill()}}}else if(t===ur){e.fillStyle=m;const M=nl*s,P=g*nr,A=Math.floor(x.y/P),v=Math.ceil(S.y/P);for(let w=A;w<=v;w++){const _=w*P,D=w%2!==0?g/2:0;for(let O=I;O<=b;O++){const V=O*g+D,N=r({x:V,y:_});e.beginPath(),e.arc(N.x,N.y,M,0,He),e.fill()}}}};p(l.interval1,l.alpha1),p(l.interval2,l.alpha2)}e.restore()}function Ir(e,t,n,s,i,o,a=!1){e.save(),e.strokeStyle=o,e.lineWidth=Kn,e.setLineDash(a?Dl:[]);const r=-n,c=-s;let l=pt(s-n);e.beginPath(),e.arc(t.x,t.y,i,r,c,l>0),e.stroke(),e.restore()}function Kl(e,{info:t,colors:n,idPrefix:s,startVertexScreen:i},o,a,r){if(!t||!t.edge)return;const{edge:c,fraction:l,snapPoint:d}=t,f=a(c.id1),h=a(c.id2);if(!f||!h)return;const u=o(f),p=o(h),g=o(d),y=n.feedbackSnapped,m=vh({x:-(p.y-u.y),y:p.x-u.x});let x=1;i&&(x=(p.x-u.x)*(i.y-u.y)-(p.y-u.y)*(i.x-u.x)>0?-1:1);const S=Eo,I={x:(u.x+g.x)/2,y:(u.y+g.y)/2},b={x:I.x+x*m.x*S,y:I.y+x*m.y*S},E=un(l,.001,8);r({id:`${s}-1`,content:E,x:b.x,y:b.y,color:y,fontSize:Aa,options:{textAlign:"center",textBaseline:"middle"}});const T={x:(g.x+p.x)/2,y:(g.y+p.y)/2},M={x:T.x+x*m.x*S,y:T.y+x*m.y*S},P=un(1-l,.001,8);r({id:`${s}-2`,content:P,x:M.x,y:M.y,color:y,fontSize:Aa,options:{textAlign:"center",textBaseline:"middle"}})}function Qh(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:s,isDragConfirmed:i,dragPreviewVertices:o,colors:a,edgesVisible:r,snappedEdgeIds:c,currentAltPressed:l,interpolationStyle:d,getInterpolationStyleById:f,edgeColorMode:h="fixed",edgeColorExpression:u="x"},p,g,y){e.lineWidth=Ts;const m=dt(a.defaultStroke,{r:255,g:255,b:255,a:1}),x=I=>{const b=I?.color||a.vertex||a.defaultStroke;return dt(b,m)},S=(I,b,E,T)=>{const M=rs(I,h);if(M==="inherit_vertices"&&E&&T){const P=x(E),A=x(T);return{r:Nt(P.r,A.r,b),g:Nt(P.g,A.g,b),b:Nt(P.b,A.b,b),a:Nt(P.a,A.a,b)}}if(M==="colormap"&&I.colormapItem){const P=I.colorExpression||u,A=Fo(P,{x:b},b),v=Be(I.colormapItem,A);return dt(v,m)}return dt(I.color||a.defaultStroke,m)};t.forEach(I=>{const b=g(I.id1),E=g(I.id2);if(!b||!E||b.type!==Ln||E.type!==Ln)return;const T=y(I),M=n.includes(T),P=c&&c.has(T)&&c.get(T).some(X=>X.copyIndex===void 0||X.copyIndex===0),A=!l&&T===s;if(!r&&!M&&!P&&!A)return;let v=b,w=E;const _=I.interpolationStyleId&&f?f(I.interpolationStyleId):null,C=_&&_.type!=="linear",D=new Map,V=Ai(I,_,v,w,t,X=>D.get(X)||g(X),p).map(X=>p(X));if(V.length<2)return;const N=V[0],$=V[V.length-1],L=p(v),k=p(w);e.beginPath(),e.moveTo(V[0].x,V[0].y);for(let X=1;X<V.length;X++)e.lineTo(V[X].x,V[X].y);const R=rs(I,h);if(R==="colormap"||R==="inherit_vertices"){let X=0;for(let B=1;B<V.length;B++)X+=Math.hypot(V[B].x-V[B-1].x,V[B].y-V[B-1].y);let z=0;for(let B=1;B<V.length;B++){const Y=V[B-1],G=V[B],W=Math.hypot(G.x-Y.x,G.y-Y.y),oe=X>0?z/X:0,U=X>0?(z+W)/X:1,te=(oe+U)/2,J=S(I,te,v,w);e.strokeStyle=`rgba(${Math.round(J.r)},${Math.round(J.g)},${Math.round(J.b)},${J.a})`,e.beginPath(),e.moveTo(Y.x,Y.y),e.lineTo(G.x,G.y),e.setLineDash([]),e.lineWidth=Ts,e.stroke(),z+=W}}else if(I.colormapItem){const X=e.createLinearGradient(N.x,N.y,$.x,$.y),z=Be(I.colormapItem,I.gradientStart),B=Be(I.colormapItem,I.gradientEnd);X.addColorStop(0,z),X.addColorStop(1,B),e.strokeStyle=X,e.setLineDash([]),e.lineWidth=Ts,e.stroke()}else e.strokeStyle=I.color||a.defaultStroke,e.setLineDash([]),e.lineWidth=Ts,e.stroke();if(M||P||A){const X=C?[L,k]:V;e.save(),e.strokeStyle=P?a.feedbackSnapped:a.selectionGlow,e.globalAlpha=Ds,e.lineWidth=us,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(X[0].x,X[0].y);for(let z=1;z<X.length;z++)e.lineTo(X[z].x,X[z].y);e.stroke(),e.restore()}}),e.setLineDash([]),e.strokeStyle=a.defaultStroke,e.globalAlpha=1}function Di(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,snappedVertexIds:f,isDragConfirmed:h,dragPreviewVertices:u,currentAltPressed:p}=n;let g=t,y=!1,m=null,x;if(h&&u){const E=u.find(T=>T&&(T.id===t.id||T.originalId===t.id));E&&(g=E,x=E.transformIndex)}if(f&&g.originalId&&f.has(g.originalId)){const T=f.get(g.originalId).find(M=>M.copyIndex===x);T&&(y=!0,m=T.type)}else if(f&&!g.originalId&&f.has(g.id)){const T=f.get(g.id).find(M=>M.copyIndex===x);T&&(y=!0,m=T.type)}let S;if(g.type===Ln){if(S=o.includes(g.id),!l&&!S&&!d&&!y&&!(p&&d))return}else S=a.includes(g.id);const I=s(g);switch(g.type){case Ln:e.beginPath(),e.arc(I.x,I.y,Ke,0,He),e.fillStyle=g.color||c.vertex,e.fill();break;case xn:case Zn:case Mn:case bs:const E=Ui*2,T={type:g.type,x:I.x-E/2,y:I.y-E/2,width:E,height:E};oa(e,T,c);break}const b={...n,isSnapped:y,snapType:m};Sr(e,g,b,s)}function ef(e,{altHoverInfo:t,colors:n},s,i,o){if(!t)return;const{point:a,element:r,shiftKey:c,fraction:l}=t,d=s(a),f=n.feedbackSnapped,h=n.feedbackSnapped;e.save(),e.shadowColor=h,e.shadowBlur=rr,e.globalAlpha=Ds,e.beginPath();const u=Ke+Pi;e.arc(d.x,d.y,u,0,He),e.strokeStyle=h,e.lineWidth=us,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(d.x,d.y,Ke,0,He),e.fillStyle=f,e.fill(),e.restore(),r.type==="edge"&&c&&tf(e,{info:{edge:r.edge,fraction:l,snapPoint:a},colors:n},s,i,o)}function tf(e,{info:t,colors:n},s,i,o){Kl(e,{info:t,colors:n,idPrefix:"alt-snap-label"},s,i,o)}function nf(e,{info:t,colors:n},s,i,o){if(!t||!t.startVertex)return;const a=s(t.startVertex);Kl(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:a},s,i,o)}function sf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,currentPos:r,rotation:c,isSnapping:l,snapType:d}=t,f=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,h=i(o),u=i(a),p=i(r);if(e.save(),e.lineWidth=pn,e.strokeStyle=f,e.setLineDash(zn),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),!s||s&&d==="projection"){const y=nt(a,o,c,1),m=i(y);e.beginPath(),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.stroke()}if(Math.abs(c)>or){e.setLineDash([]);const y=ae(h,u),m=Math.atan2(u.y-h.y,u.x-h.x),x=-c,S=c>0;e.beginPath(),e.arc(h.x,h.y,y,m,m+x,S),e.stroke()}e.restore()}function of(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,scale:r,isSnapping:c,snapType:l,currentPos:d}=t,f=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,h=i(o),u=i(a),p=i(d);if(e.save(),e.lineWidth=pn,e.strokeStyle=f,e.setLineDash(zn),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),!s){const x=ae(h,p),S=Math.atan2(u.y-h.y,u.x-h.x),I=Math.atan2(p.y-h.y,p.x-h.x);let b=I-S;b>Math.PI?b-=2*Math.PI:b<-Math.PI&&(b+=2*Math.PI);const E=b<0;e.beginPath(),e.arc(h.x,h.y,x,S,I,E),e.stroke()}const y={x:o.x+(a.x-o.x)*r,y:o.y+(a.y-o.y)*r},m=i(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(m.x,m.y),e.stroke(),e.restore()}function af(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,currentPos:r,scale:c,startVector:l,isSnapping:d,snapType:f,projectionSource:h}=t,u=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,p=i(o),g=i(a),y=i(r);e.save(),e.lineWidth=pn,e.strokeStyle=u,e.setLineDash(zn),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(g.x,g.y),e.stroke();const m=nt(a,o,0,c,!0,l),x=i(m);if((!s||s&&f==="projection")&&(e.setLineDash(zn),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(x.x,x.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(x.x,x.y),e.stroke(),d&&f==="projection"&&h){const I=i(h),b=o,E={x:o.x+l.x,y:o.y+l.y},T=$l(h,b,E),M=i(T);e.setLineDash(zn),e.beginPath(),e.moveTo(I.x,I.y),e.lineTo(M.x,M.y),e.stroke()}e.restore()}function rf(e,{transformIndicatorData:t,colors:n},s){const{center:i,startPos:o,rotation:a,scale:r,isSnapping:c}=t,l=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,d=s(i),f=s(o);e.save(),e.lineWidth=pn,e.strokeStyle=l,e.setLineDash(zn),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(f.x,f.y),e.stroke();const h={x:i.x+(o.x-i.x)*r,y:i.y+(o.y-i.y)*r},u=s(h);if(e.setLineDash([]),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(a)>or){const p=ae(d,u),g=Math.atan2(f.y-d.y,f.x-d.x),y=-a,m=a>0;e.beginPath(),e.arc(d.x,d.y,p,g,g+y,m),e.stroke()}e.restore()}function lf(e,t,{transformIndicatorData:n,colors:s,coordSystemTransformIndicatorData:i,currentShiftPressed:o},a,r){if(n){const{isSnapping:c,snapType:l,transformType:d}=n;switch(e.save(),e.lineWidth=pn,d){case Mn:rf(e,{transformIndicatorData:n,colors:s},a);break;case xn:sf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break;case Zn:of(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break;case bs:af(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break}c&&l==="projection"&&o&&cf(e,{transformIndicatorData:n,colors:s},a),e.restore(),df(t,{transformIndicatorData:n,colors:s},a,r)}i&&hf(t,{coordSystemTransformIndicatorData:i,colors:s},a,r)}function cf(e,{transformIndicatorData:t,colors:n},s){const{transformType:i,projectionSource:o,projectionCenter:a,projectionPoint:r,currentPos:c}=t;if(i!==Mn){if(e.setLineDash(zn),e.strokeStyle=n.feedbackSnapped,i===xn&&r){const l=s(c),d=s(r),f=s(o);e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(d.x,d.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(d.x,d.y),e.stroke()}else if(i===Zn&&a){const l=s(a),d=s(o),f=s(c),h=ae(l,d);let u=Math.atan2(d.y-l.y,d.x-l.x),p=Math.atan2(f.y-l.y,f.x-l.x);const g=2*Math.PI;u=(u+g)%g,p=(p+g)%g;const y=(p-u+g)%g,x=(u-p+g)%g<y;e.beginPath(),e.arc(l.x,l.y,h,u,p,x),e.stroke()}}}function df(e,{transformIndicatorData:t,colors:n},s,i){const{center:o,startPos:a,rotation:r,scale:c,isSnapping:l,snapType:d,snappedScaleValue:f,transformType:h}=t,u=s(o),p=s(a),g=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(h===Zn||h===Mn||h===bs){let y;const m=f!==null?f:c;d==="projection"||d==="merge"&&h===Mn?y=`\\times ${parseFloat(m.toFixed(Sa)).toString()}`:l&&f!==null?y=`\\times ${un(f,ws,qd)}`:y=`\\times ${parseFloat(m.toFixed(Sa)).toString()}`;const S=(u.x+p.x)/2,I=(u.y+p.y)/2,b=Math.atan2(p.y-u.y,p.x-u.x),E=b-Math.PI/2,T=S+Math.cos(E)*Zr,M=I+Math.sin(E)*Zr;let P=b*(180/Math.PI);(P>90||P<-90)&&(P+=180),i({id:"transform-scale-indicator",content:y,x:T,y:M,color:g,fontSize:vn,options:{textAlign:"center",textBaseline:"bottom",rotation:P}})}else i({id:"transform-scale-indicator",content:"",x:0,y:0,color:g,fontSize:vn,options:{}});if((h===xn||h===Mn)&&Math.abs(r)>or){const y=r*(180/Math.PI),m=`${parseFloat(y.toFixed(Sa)).toString()}^{\\circ}`,x={x:p.x-u.x,y:p.y-u.y},S=Math.atan2(x.y,x.x)+-r/2,b=Math.hypot(x.x,x.y)+Kd,E=u.x+b*Math.cos(S),T=u.y+b*Math.sin(S);let M=S*(180/Math.PI);(M>90||M<-90)&&(M+=180),i({id:"transform-angle-indicator",content:m,x:E,y:T,color:g,fontSize:vn,options:{rotation:M}})}else i({id:"transform-angle-indicator",content:"",x:0,y:0,color:g,fontSize:vn,options:{}})}function hf(e,{coordSystemTransformIndicatorData:t,colors:n},s,i){const{edgeFraction:o,orthogonalDistanceFraction:a,v1:r,v2:c,snapPosition:l}=t;let d="",f={x:0,y:0};if(a!==void 0){d=un(a,.001,8);const h=s(l.origin),u=s(l.closest),p=(h.x+u.x)/2,g=(h.y+u.y)/2,y=Math.atan2(u.y-h.y,u.x-h.x);f.x=p+Math.cos(y+Math.PI/2)*Eo,f.y=g+Math.sin(y+Math.PI/2)*Eo}else if(o!==void 0){const h=s(r),u=s(c),p=s(l),g=Math.atan2(u.y-h.y,u.x-h.x),y=Math.cos(g+Math.PI/2)*Eo,m=Math.sin(g+Math.PI/2)*Eo;f.x=p.x+y,f.y=p.y+m,d=un(o,.001,8)}d&&i({id:"coord-system-edge-fraction",content:d,x:f.x,y:f.y,color:n.feedbackSnapped,fontSize:Aa,options:{textAlign:"center",textBaseline:"middle"}})}function ff(e,t,n,s,{showAngles:i,showDistances:o,viewTransform:a,mousePos:r,colors:c}){if(!i&&!o||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,d=s(r);if(ae(l,d)<ye)return;const h=c.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,p=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const g=n(l),y=p+u;if(e.save(),e.lineWidth=pn,e.strokeStyle=h,i&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>ye){const m=ro+e.lineWidth/2,x={x:l.x+Math.cos(p)*(m/a.scale),y:l.y+Math.sin(p)*(m/a.scale)},S=n(x);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(S.x,S.y),e.setLineDash(pd),e.stroke(),Ir(e,g,p,y,ro,h,!1)}e.restore()}function ql(e,t,n,s,i,{showDistances:o,showAngles:a,currentShiftPressed:r,distanceSigFigs:c,angleSigFigs:l,angleDisplayMode:d,viewTransform:f,frozenReference_D_du:h,gridDisplayMode:u,frozenReference_A_rad:p,colors:g,lastGridState:y},m,x,S){if(!a&&!o||i.distance<ye){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const I=m(n),{angle:b,distance:E,lengthSnapFactor:T,angleSnapFactor:M,angleTurn:P,gridToGridSquaredSum:A,gridInterval:v,snapType:w}=i,{offsetAngleRad:_,isFirstSegmentBeingDrawn:C,currentSegmentReferenceD:D}=x,O=i.snapped||r?g.feedbackSnapped:g.geometryInfoText,F=Math.atan2(s.y-n.y,s.x-n.x);if(E*f.scale/window.devicePixelRatio<Ol){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const V=a&&E>ye&&(C||Math.abs(P)>ye);if(o){let N="",$=i.gridInterval||null;if(!$&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&($=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),r&&i.snapped)if(C)if(w==="grid"&&A!==null&&$)if(A===0)N="0";else{const[L,k]=Ps(A),R=$*L,X=parseFloat(R.toFixed(10));N=As(X,k)}else if(w==="geometric"&&T!==null){const L=T*D;N=un(L,ws,Us),(N===L.toFixed(2)||N===String(Math.round(L)))&&(N=xt(L,c))}else if(w==="vertex"||w==="edge_fraction"||w==="edge"){let L=!1;if($){const k=i.x-n.x,R=i.y-n.y,X=k/$,z=R/$;if(Math.abs(X-Math.round(X))<1e-5&&Math.abs(z-Math.round(z))<1e-5){const B=Math.round(X),Y=Math.round(z),G=B*B+Y*Y;if(G===0)N="0";else{const[W,oe]=Ps(G),U=$*W,te=parseFloat(U.toFixed(10));N=As(te,oe)}L=!0}}L||(N=xt(E,c))}else N=xt(E,c);else if(w==="geometric"&&T!==null)N=Ks(T,"D");else if(w==="grid"&&A!==null&&$&&h!==null&&h>ye){const k=$*Math.sqrt(A)/h;let R=!1;for(const X of as)if(Math.abs(k-X)<ye){N=Ks(X,"D"),R=!0;break}if(!R)if(A===0)N="0";else{const[X,z]=Ps(A),B=$*X,Y=parseFloat(B.toFixed(10));N=As(Y,z)}}else if(w==="vertex"||w==="edge_fraction"||w==="edge")if(h!==null&&h>ye){const L=E/h;let k=!1;for(const R of as)if(Math.abs(L-R)<ye){N=Ks(R,"D"),k=!0;break}k||(N=xt(E,c))}else N=xt(E,c);else N=xt(E,c);else if(!C&&h!==null&&h>ye){const L=E/h;let k=!1;for(const R of as)if(Math.abs(L-R)<ye){N=Ks(R,"D"),k=!0;break}k||(N=xt(E,c))}else N=xt(E,c);if(N){const L=m(n),k=m(s),R=Math.atan2(k.y-L.y,k.x-L.x),X=(L.x+k.x)/2,z=(L.y+k.y)/2;let B;if(V){const oe=C?-F:-P;oe<0&&oe>-Math.PI||oe>Math.PI?B=R-Math.PI/2:B=R+Math.PI/2}else B=R-Math.PI/2,Math.sin(B)>0&&(B+=Math.PI);const Y=X+Math.cos(B)*os,G=z+Math.sin(B)*os;let W=R*(wo/Math.PI);(W>kl||W<-90)&&(W+=wo),S({id:"snap-dist",content:N,x:Y,y:G,color:O,fontSize:vn,options:{rotation:W}},t)}else S({id:"snap-dist",content:"",x:0,y:0})}else S({id:"snap-dist",content:"",x:0,y:0});if(V){const N=C?0:_;Ir(e,I,N,F,ro,O),e.save(),e.beginPath();const $=ro+e.lineWidth/2,L={x:n.x+$/f.scale*Math.cos(N),y:n.y+$/f.scale*Math.sin(N)},k=m(L);e.moveTo(I.x,I.y),e.lineTo(k.x,k.y),e.strokeStyle=O,e.setLineDash(gd),e.lineWidth=pn,e.stroke(),e.restore();let R="";const X=!C&&p!==null&&Math.abs(p)>ye,z=x.currentSegmentReferenceA_for_display,B=C?F:P;if(d===ks){let Y=pt(B)*(180/Math.PI);r&&!C&&i.snapped&&w==="geometric"&&M!==null||r&&X&&M!==null&&i.snapped&&w!=="geometric"?R=Ks(M,"A"):Math.abs(Y)>wi&&(R=`${xt(Y,l)}^{\\circ}`)}else if(d===Ko){let Y=pt(B);if(r&&!C&&i.snapped&&w==="geometric"&&M!==null&&z){const G=un(M*(z/Math.PI),ws,Us);G==="0"?R="0":G==="1"?R=Vt:G==="-1"?R=`-${Vt}`:R=`${G}${Vt}`}else if(r&&X&&M!==null&&i.snapped&&w!=="geometric"&&z){const G=un(M*(z/Math.PI),ws,Us);G==="0"?R="0":G==="1"?R=Vt:G==="-1"?R=`-${Vt}`:R=`${G}${Vt}`}else if(Math.abs(Y)>wi){const G=un(Y/Math.PI,ws,Us);G!==Y.toFixed(2)?G==="0"?R="0":G==="1"?R=Vt:G==="-1"?R=`-${Vt}`:R=`${G}${Vt}`:R=xt(Y,l)}}if(R){const Y=-N,G=-F,W=Math.cos(Y)+Math.cos(G),oe=Math.sin(Y)+Math.sin(G),U=Math.atan2(oe,W),te=Ci;let J=U*(180/Math.PI);const Q={x:te*Math.cos(U),y:te*Math.sin(U)},ee={x:I.x+Q.x,y:I.y+Q.y};(J>90||J<-90)&&(J+=180),S({id:"snap-angle",content:R,x:ee.x,y:ee.y,color:O,fontSize:vn,options:{rotation:J}},t)}else S({id:"snap-angle",content:"",x:0,y:0})}else S({id:"snap-angle",content:"",x:0,y:0})}function uf(e,t,{showAngles:n,showDistances:s,viewTransform:i,mousePos:o,frozenReference_D_du:a,distanceSigFigs:r,angleSigFigs:c,angleDisplayMode:l,colors:d},f,h,u){const p=Ol/i.scale;let g=-1;if(t.frozen_Origin_Data_to_display){const v=t.frozen_Origin_Data_to_display,w=f(o);g=ae(v,w)}if(!n&&!s||!t.frozen_Origin_Data_to_display||g<p)return;const y=d.frozenReference,m=t.frozen_Origin_Data_to_display,x=t.displayAngleA_valueRad_for_A_equals_label,S=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,I=t.frozen_D_du_to_display,b=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,E=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!m)return;const T=S+x,M={x:m.x+I*Math.cos(T),y:m.y+I*Math.sin(T)},P=h(m),A=h(M);if(s&&I!==null&&I>p){let v="";if(b!==null&&b>0&&E){const[N,$]=Ps(b),L=E*N,k=parseFloat(L.toFixed(10));v=`${el}${As(k,$)}`}else{const N=I/Oa;v=`${el}${xt(N,r)}`}const w=Math.atan2(A.y-P.y,A.x-P.x),_=(P.x+A.x)/2,C=(P.y+A.y)/2;let D=w*(wo/Math.PI);(D>kl||D<-90)&&(D+=wo);let O;x!==null&&Math.abs(x)>ye?-x<0?O=w-Math.PI/2:O=w+Math.PI/2:(O=w-Math.PI/2,Math.sin(O)>0&&(O+=Math.PI));const F=_+Math.cos(O)*Ti,V=C+Math.sin(O)*Ti;u({id:"ref-dist",content:v,x:F,y:V,color:y,fontSize:Ba,options:{rotation:D}},e)}if(n&&x!==null&&Math.abs(x)>ye){const v=-S,w=-(S+x),_=Math.cos(v)+Math.cos(w),C=Math.sin(v)+Math.sin(w),D=Math.atan2(C,_),O=Ci,F=P.x+Math.cos(D)*O,V=P.y+Math.sin(D)*O;let N=D*(180/Math.PI);(N>90||N<-90)&&(N+=180);let $="";if(l===ks){let L=x*(wo/Math.PI);$=`${vo}${xt(L,c)}^{\\circ}`}else l===Ko&&($=`${vo}${un(x/Math.PI,ws,Us)}${Vt}`,$===`${vo}1${Vt}`&&($=Vt),$===`${vo}-1${Vt}`&&($=`-${Vt}`),$===`${vo}0${Vt}`&&($="0"));u({id:"ref-angle",content:$,x:F,y:V,color:y,fontSize:Ba,options:{rotation:N}},e)}}function gf(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:s,ghostVertexPosition:i,gridDisplayMode:o,lastGridState:a,angleDisplayMode:r,canvas:c,dpr:l,mousePos:d,colors:f,useScientific:h},u,p){if(t===Qi||!d||!n)return;let g;s&&i?g=i:g=u(d);let y=1;o!==Wo&&a&&a.interval1&&(y=a.interval1);let m=y;a&&a.interval2&&a.interval2<m&&(m=a.interval2);let x,S=1;m>=1e4?(S=100,x=0):m>=1e3?(S=10,x=0):m>=100?(S=1,x=0):m>=10?x=1:x=Math.max(0,-Math.floor(Math.log10(m)))+2;const E=(v=>1)(m)+2,T=v=>{if(h){const w=E-1,C=Math.abs(v).toExponential(w).split("e");let D=C[0],O=parseInt(C[1],10);return`${v<0?"-":""}${D} \\cdot 10^{${O}}`}else return S>1?(Math.round(v/S)*S).toFixed(x):v.toFixed(x)},M=Math.min(x,jd);let P="";switch(t){case dr:{let v=T(g.x);g.x>=0&&!v.includes("cdot")&&(v=`${Ws}${v}`);let w=T(g.y);g.y>=0&&!w.includes("cdot")&&(w=`${Ws}${w}`),P=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${v} \\\\ ${w} \\end{pmatrix*}`;break}case Lo:{let v=T(g.x);g.x>=0&&!v.includes("cdot")&&(v=`${Ws}${v}`);const w=Math.abs(g.y);let _=T(w);const C=g.y<0?"-":"+";P=`z = ${v} ${C} ${_}${hi}`;break}case ea:{const v=Math.hypot(g.x,g.y),w=Math.atan2(g.y,g.x);let _=T(v);v>=0&&!_.includes("cdot")&&(_=`${Ws}${_}`);let C;if(r===ks){let D=Ih(w*180/Math.PI);C=D.toFixed(M),D>=0&&(C=`${Ws}${C}`),C+="^{\\circ}"}else{let D=pt(w);C=D.toFixed(M),D>=0&&(C=`${Ws}${C}`)}P=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${_} \\\\ ${C} \\end{pmatrix*}`;break}}const A=c.width/l;p({id:"mouse-coord-text",content:P,x:A-Ur,y:Ur,color:f.mouseCoords,fontSize:Ud,options:{textAlign:"right",textBaseline:"top"}})}function jl(e,t,n,s){e.save();const i=t.x+t.width/2,o=t.y+t.height/2,a=t.width/2*.6;if(e.strokeStyle=s.uiIcon,e.fillStyle=s.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(i,o,a*.7,0,2*Math.PI),e.fill();for(let r=0;r<8;r++){const c=r/8*2*Math.PI,l=i+Math.cos(c)*(a*.85),d=o+Math.sin(c)*(a*.85),f=i+Math.cos(c)*(a*1.1),h=o+Math.sin(c)*(a*1.1);e.beginPath(),e.moveTo(l,d),e.lineTo(f,h),e.stroke()}}else e.beginPath(),e.arc(i,o,a,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i-5,o-3,a,0,2*Math.PI),e.fillStyle=s.background,e.fill();e.restore()}function pf(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/xo;e.scale(l,l),e.translate(-16,-16);const d=0;e.strokeStyle=r,e.lineWidth=Rn,e.lineCap="round",e.beginPath(),e.moveTo(0+d,32),e.lineTo(32+d,32),e.moveTo(0+d,32),e.lineTo(0+d,0),e.stroke(),e.fillStyle=r;const f={x:16+d,y:16};let h={x:16+d,y:8},u="";switch(n){case dr:e.setLineDash(ma),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(f.x,32),e.moveTo(f.x,f.y),e.lineTo(0+d,f.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(f.x,f.y,Hn,0,He),e.fill(),u="(x,y)";break;case Lo:e.setLineDash(ma),e.beginPath(),e.moveTo(0+d,32),e.lineTo(f.x,f.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(f.x,f.y,Hn,0,He),e.fill(),u="x+iy";break;case ea:e.setLineDash(ma),e.beginPath(),e.moveTo(0+d,32),e.lineTo(f.x,f.y),e.stroke(),e.beginPath(),e.arc(0+d,32,8,-Math.atan2(32-f.y,f.x-(0+d)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(f.x,f.y,Hn,0,He),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const p="icon-label-coords",g=s?a.uiTextSelected:a.uiTextDefault;o({id:p,content:u,x:c.x+(h.x-16)*l,y:c.y+(h.y-16)*l,color:g,fontSize:ar,options:{textAlign:"center",textBaseline:"middle"}},i)}}function Ul(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(c.x,c.y);const d=t.width/xo;e.scale(d,d),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=Rn;const f={x:32,y:32},h={x:0,y:32},u={x:16,y:0};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke();let p="",g={x:20,y:22};if(n!==Oo){e.beginPath();const y=Math.atan2(u.y-h.y,u.x-h.x);e.arc(h.x,h.y,8,y,0),e.stroke(),n===ks?p="60^\\circ":n===Ko&&(p="\\frac{\\pi}{3}",l=2)}if(e.restore(),p){const y="icon-label-angles",m=s?a.uiTextSelected:a.uiTextDefault;o({id:y,content:p,x:c.x+(g.x-16)*d,y:c.y+(g.y-20)*d,color:m,fontSize:ar+l,options:{textAlign:"center",textBaseline:"middle"}},i)}}function Jl(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/xo;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=Rn,e.beginPath(),e.moveTo(0,32),e.lineTo(32,32),e.stroke();let d="",f={x:16,y:22};if(n===No&&(d="3.14"),e.restore(),d){const h="icon-label-distances",u=s?a.uiTextSelected:a.uiTextDefault;o({id:h,content:d,x:c.x+(f.x-16)*l,y:c.y+(f.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function yf(e,t,n,s,i){const o=s?i.uiIconSelected:i.uiIconDefault,a={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(a.x,a.y);const r=t.width/xo;switch(e.scale(r,r),e.translate(-16,-16),e.strokeStyle=o,e.fillStyle=o,e.lineWidth=Rn,n){case hr:e.strokeRect(0,0,32,32),e.beginPath(),e.moveTo(0,16),e.lineTo(32,16),e.moveTo(16,0),e.lineTo(16,32),e.stroke();break;case fr:e.strokeRect(0,0,32,32),e.beginPath(),[8,16,24].forEach(f=>{[8,16,24].forEach(h=>{e.moveTo(f,h),e.arc(f,h,Hn,0,He)})}),e.fill();break;case ur:e.strokeRect(0,0,32,32);const c=8,l=16,d=16;e.beginPath(),e.arc(l,d,Hn,0,He);for(let f=0;f<6;f++){const h=Math.PI/3*f,u=l+c*Math.cos(h),p=d+c*Math.sin(h);e.moveTo(u,p),e.arc(u,p,Hn,0,He)}e.fill();break;case gr:e.beginPath(),e.arc(16,16,14,0,He),e.stroke(),e.beginPath(),e.arc(16,16,7,0,He),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Wo:e.strokeRect(2,2,28,28);break}e.restore()}function oa(e,t,n){const s={x:t.x+t.width/2,y:t.y+t.height/2},i=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=Rn,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(s.x,s.y),t.type){case xn:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();const a=i*.25,r=i*Math.cos(o),c=i*Math.sin(o);e.save(),e.translate(r,c),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),d=i*Math.sin(Math.PI+o);e.save(),e.translate(l,d),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();break}case Zn:{const o=i*.8,a=i*.25;e.beginPath(),e.moveTo(-o,0),e.lineTo(o,0),e.moveTo(0,-o),e.lineTo(0,o),e.stroke(),[{x:o,y:0,dirX:1,dirY:0},{x:-o,y:0,dirX:-1,dirY:0},{x:0,y:-o,dirX:0,dirY:-1},{x:0,y:o,dirX:0,dirY:1}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}case Mn:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();let a=i*.25;const r=i*Math.cos(o),c=i*Math.sin(o);e.save(),e.translate(r,c),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),d=i*Math.sin(Math.PI+o);e.save(),e.translate(l,d),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const f=i*.8;a=i*.25,e.beginPath(),e.moveTo(-f,0),e.lineTo(f,0),e.moveTo(0,-f),e.lineTo(0,f),e.stroke(),[{x:f,y:0,dirX:1,dirY:0},{x:-f,y:0,dirX:-1,dirY:0},{x:0,y:-f,dirX:0,dirY:-1},{x:0,y:f,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a+u.dirY*a*.5,u.y-u.dirY*a-u.dirX*a*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a-u.dirY*a*.5,u.y-u.dirY*a+u.dirX*a*.5),e.stroke()});break}case bs:{const o=i*.8,a=i*.25;e.beginPath(),e.moveTo(-o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(o/Math.sqrt(2),o/Math.sqrt(2)),e.moveTo(o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(-o/Math.sqrt(2),o/Math.sqrt(2)),e.stroke(),[{x:o/Math.sqrt(2),y:-o/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-o/Math.sqrt(2),y:o/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}}e.restore()}function mf(e,t,n){const s=t.x+t.width/2,i=t.y+t.height/2,o=t.width*.6,a=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=Rn,e.lineCap="round",e.beginPath(),e.ellipse(s,i,o/2,a/2,0,0,2*Math.PI),e.stroke();const r=a*.3;e.beginPath(),e.arc(s,i,r,0,2*Math.PI),e.fill(),e.restore()}function xf(e,t,n,s){const{canvasUI:i,colors:o,allColors:a,namedColors:r,colorAssignments:c,activeColorTargets:l,lastSelectedSwatchIndex:d,verticesVisible:f,edgesVisible:h,facesVisible:u,isDraggingColorTarget:p,draggedColorTargetInfo:g,mousePos:y}=n,m=o.checkerboardColor1,x=o.checkerboardColor2;function S(M){const P=M.height/3,A=Math.ceil(M.width/P);for(let v=0;v<3;v++)for(let w=0;w<A;w++){e.fillStyle=(v+w)%2===0?m:x;const _=M.x+w*P,C=M.y+v*P,D=Math.min(P,M.x+M.width-_),O=Math.min(P,M.y+M.height-C);D>0&&O>0&&e.fillRect(_,C,D,O)}}const I=i.randomColorButton;if(I){e.fillStyle="#000000",e.fillRect(I.x,I.y,I.width,I.height),e.strokeStyle=o.uiDefault,e.lineWidth=Fn,e.strokeRect(I.x,I.y,I.width,I.height);const M=I.x+I.width/2,P=I.y+I.height/2,A=I.width*.35,v=8;for(let w=0;w<v;w++){const _=w/v*2*Math.PI,C=(w+1)/v*2*Math.PI,D=w/v*360;e.fillStyle=`hsl(${D}, 70%, 60%)`,e.beginPath(),e.moveTo(M,P),e.arc(M,P,A,_,C),e.closePath(),e.fill()}e.fillStyle=o.background,e.beginPath(),e.arc(M,P,A*.4,0,2*Math.PI),e.fill()}const b=i.removeColorButton;b&&(e.strokeStyle=o.uiDefault,e.lineWidth=Fn,e.strokeRect(b.x,b.y,b.width,b.height),e.beginPath(),e.moveTo(b.x+rn,b.y+b.height/2),e.lineTo(b.x+b.width-rn,b.y+b.height/2),e.stroke()),i.colorSwatches.forEach(M=>{const P=M.item;let A=!1;if(P&&P.type==="color"){const v=ys(P.value);v&&v.a<1&&(A=!0)}else P&&P.type==="colormap"&&P.vertices.some(v=>v.alpha!==void 0&&v.alpha<1)&&(A=!0);if(A&&S(M),P&&P.type==="colormap"){const v=e.createLinearGradient(M.x,M.y,M.x+M.width,M.y);P.vertices.forEach(w=>{let _=w.color;typeof _=="string"&&(_=r[_]||[0,0,0]),v.addColorStop(w.pos,`rgba(${_.join(",")},${w.alpha||1})`)}),e.fillStyle=v}else P&&(e.fillStyle=P.value);e.fillRect(M.x,M.y,M.width,M.height)});const E=i.addColorButton;if(E&&(e.strokeStyle=o.uiDefault,e.lineWidth=Fn,e.strokeRect(E.x,E.y,E.width,E.height),e.beginPath(),e.moveTo(E.x+E.width/2,E.y+rn),e.lineTo(E.x+E.width/2,E.y+E.height-rn),e.moveTo(E.x+rn,E.y+E.height/2),e.lineTo(E.x+E.width-rn,E.y+E.height/2),e.stroke()),i.colorTargetIcons){const M=v=>{let w=c[v];return p&&g&&g.target===v&&g.previewColorIndex!==void 0&&(w=g.previewColorIndex),w},P=v=>{let w=M(v);const _=w===-1?null:a[w],C={};if(v===Ue)C.vertexState=f?"filled":"disabled",w===-1?C.vertexColor=js:_&&_.type==="color"?C.vertexColor=_.value:_&&_.type==="colormap"&&(C.vertexColormapItem=_);else if(v===Je)C.edgeState=h?"solid":"disabled",w===-1?C.edgeColor=js:_&&_.type==="color"?C.edgeColor=_.value:_&&_.type==="colormap"&&(C.edgeColormapItem=_);else if(v===at)C.faceState=u?"filled":"disabled",w===-1?C.faceColor=js:_&&_.type==="color"?C.faceColor=_.value:_&&_.type==="colormap"&&(C.faceColormapItem=_);else if(v===Gt){w===-1?C.textColor=js:_&&_.type==="color"?C.textColor=_.value:_&&_.type==="colormap"&&(C.textColor=Be(_,.5));const D=M(at);if(D===w){const O=D===-1?null:a[D];O?O.type==="color"?C.faceColorForContrast=O.value:O.type==="colormap"&&(C.faceColorForContrast=Be(O,.5)):C.faceColorForContrast=js}}return C};[at,Je,Ue,Gt].forEach(v=>{const w=i.colorTargetIcons.find(_=>_.target===v);if(w){l.includes(v);const _=P(v);if(p&&g&&g.target===at&&v===at){const C=i.colorSwatches.find(D=>y.x>=D.x&&y.x<=D.x+D.width&&y.y>=D.y&&y.y<=D.y+D.height);if(C&&C.item.type==="colormap"){const D=wh((y.x-C.x)/C.width,0,1);_.faceColor=Be(C.item,D),_.faceState="filled"}}v===Gt?Mf(e,w,_,o,!1):$o(e,w,_,o,!1)}})}const T=new Set;if(d!=null){const M=i.colorSwatches.find(P=>P.index===d);if(M){const A=i.colorTargetIcons.find(w=>w.x+w.width/2>=M.x&&w.x+w.width/2<=M.x+M.width),v=A?Math.min(A.y,M.y):M.y;e.strokeStyle=o.selectionGlow,e.lineWidth=Fn,e.strokeRect(M.x-2,v-2,M.width+4,M.y+M.height-v+4),T.add(d)}}l.forEach(M=>{let P=c[M];if(p&&g&&g.target===M&&g.previewColorIndex!==void 0&&(P=g.previewColorIndex),P===-1||T.has(P))return;const A=i.colorSwatches.find(v=>v.index===P);if(A){const v=Object.keys(c).filter(_=>{let C=c[_];return p&&g&&g.target===_&&g.previewColorIndex!==void 0&&(C=g.previewColorIndex),C===A.index&&l.includes(_)}),w=i.colorTargetIcons.filter(_=>v.includes(_.target));if(w.length>0){const _=Math.min(...w.map(N=>N.y));e.strokeStyle=o.selectionGlow,e.lineWidth=Fn;const C=2,D=A.x-C,O=_-C,F=A.width+C*2,V=A.y+A.height-O+C;e.strokeRect(D,O,F,V),T.add(P)}}})}function Sf(e,t,n,s){const{canvasUI:i,colors:o,allColors:a,activeThemeName:r,edgeColorMode:c,faceColorMode:l,selectedEdgeModes:d,selectedFaceModes:f}=n,h=i.colorModeIcons||[];if(!h.length)return;const u=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"],p=d&&d.length>0?d:[c],g=f&&f.length>0?f:[l],y=()=>a&&a.find(m=>m&&m.type==="colormap")||null;h.forEach(m=>{e.save(),e.strokeStyle=o.uiIcon,e.fillStyle=o.uiIcon,e.lineWidth=Rn;const x={vertexState:"none",edgeState:"none",faceState:"none",faceColor:o.uiIcon,edgeColor:o.uiIcon,vertexColor:o.uiIcon};if(m.group==="edge"){const S={...x,edgeState:"solid"};m.mode==="inherit_vertices"&&(S.vertexState="filled",S.vertexColors=u,S.edgeVertexColors=u),m.mode==="colormap"&&(S.edgeColormapItem=y());const I=p.includes(m.mode);$o(e,m,S,o,I)}else if(m.group==="face"){const S={...x,faceState:"filled"};m.mode==="inherit_vertices"&&(S.vertexState="solid",S.faceVertexColors=u,S.vertexColors=u),m.mode==="inherit_edges"&&(S.edgeState="solid",S.edgeColors=u,S.faceEdgeColors=u),m.mode==="colormap_xy"&&(S.faceColormapItem=y());const I=g.includes(m.mode);$o(e,m,S,o,I)}e.restore()})}function If(e,t,n,s){const i=(n?.vertices||[]).filter(T=>T&&T.type==="regular");if(!i.length){e.save(),e.fillStyle=s.uiIconDefault,e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width*.08,0,2*Math.PI),e.fill(),e.restore();return}let o=1/0,a=1/0,r=-1/0,c=-1/0;i.forEach(T=>{T.x<o&&(o=T.x),T.y<a&&(a=T.y),T.x>r&&(r=T.x),T.y>c&&(c=T.y)});const l=3,d=Math.max(t.width-l*2,1),f=Math.max(t.height-l*2,1),h=Math.max(r-o,1e-6),u=Math.max(c-a,1e-6),p=Math.min(d/h,f/u),g=(o+r)/2,y=(a+c)/2,m=t.x+t.width/2,x=t.y+t.height/2,S=T=>({x:m+(T.x-g)*p,y:x+(T.y-y)*p}),I=n?.edges||[],b=n?.faces||[],E=new Map(i.map(T=>[T.id,T]));e.save(),e.lineWidth=1,b.length>0&&(e.fillStyle=s.uiIconDefault,e.globalAlpha=.2,b.forEach(T=>{const M=(T.vertexIds||[]).map(A=>E.get(A)).filter(Boolean);if(M.length<3)return;e.beginPath();const P=S(M[0]);e.moveTo(P.x,P.y);for(let A=1;A<M.length;A++){const v=S(M[A]);e.lineTo(v.x,v.y)}e.closePath(),e.fill()}),e.globalAlpha=1),e.strokeStyle=s.uiIconDefault,I.forEach(T=>{const M=E.get(T.id1),P=E.get(T.id2);if(!M||!P)return;const A=S(M),v=S(P);e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(v.x,v.y),e.stroke()}),e.fillStyle=s.uiIconDefault,i.forEach(T=>{const M=S(T);e.beginPath(),e.arc(M.x,M.y,1.2,0,2*Math.PI),e.fill()}),e.restore()}function bf(e,t){const{canvasUI:n,colors:s,sessions:i,activeSessionIndex:o,selectedSessionIndex:a}=t,r=n.removeSessionButton;r&&(e.strokeStyle=s.uiDefault,e.lineWidth=Fn,e.strokeRect(r.x,r.y,r.width,r.height),e.beginPath(),e.moveTo(r.x+rn,r.y+r.height/2),e.lineTo(r.x+r.width-rn,r.y+r.height/2),e.stroke()),(n.sessionIcons||[]).forEach(l=>{const d=l.index===a,f=l.index===o;e.save(),e.strokeStyle=d?s.selectionGlow:s.uiDefault,e.lineWidth=Po,e.strokeRect(l.x,l.y,l.width,l.height),f&&!d&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Po,e.strokeRect(l.x+2,l.y+2,l.width-4,l.height-4)),If(e,l,l.session?.state,s),e.restore()});const c=n.addSessionButton;c&&(e.strokeStyle=s.uiDefault,e.lineWidth=Fn,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width/2,c.y+rn),e.lineTo(c.x+c.width/2,c.y+c.height-rn),e.moveTo(c.x+rn,c.y+c.height/2),e.lineTo(c.x+c.width-rn,c.y+c.height/2),e.stroke())}function vf(e,t,{verticesVisible:n,edgesVisible:s,facesVisible:i,colorAssignments:o,allColors:a},r){const c=!n&&!s&&!i,l={vertexState:n||c?"filled":"hidden",edgeState:s||c?"solid":"hidden",faceState:i||c?"filled":"hidden",showAllDisabled:c},d=o[Ue];if(d!==-1){const u=a[d];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=r.vertex;const f=o[Je];if(f!==-1){const u=a[f];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=r.edge;const h=o[at];if(h!==-1){const u=a[h];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=r.face;$o(e,t,l,r)}function fi(e){const t={x:e.x+e.width/2,y:e.y+e.height/2},s=26*(e.width/xo),i=s*Math.sqrt(3)/2,o=[{x:t.x,y:t.y-i/1.5},{x:t.x-s/2,y:t.y+i/3},{x:t.x+s/2,y:t.y+i/3}],a=new Path2D;a.moveTo(o[0].x,o[0].y),a.lineTo(o[1].x,o[1].y),a.lineTo(o[2].x,o[2].y),a.closePath();const r=Math.min(o[0].x,o[1].x,o[2].x),c=Math.max(o[0].x,o[1].x,o[2].x),l=Math.min(o[0].y,o[1].y,o[2].y),d=Math.max(o[0].y,o[1].y,o[2].y);return{vertices:o,facePath:a,bounds:{x:r,y:l,w:c-r,h:d-l}}}function $o(e,t,n,s,i=!1){const{vertexState:o="none",edgeState:a="none",faceState:r="none",faceColor:c,edgeColor:l,vertexColor:d,vertexColors:f,edgeVertexColors:h,edgeColors:u,faceColormapItem:p,faceVertexColors:g,faceEdgeColors:y,showAllDisabled:m=!1}=n;e.save();const{vertices:x,facePath:S}=fi(t),I=T=>T?Array.isArray(T)?{r:T[0],g:T[1],b:T[2],a:1}:ys(T):{r:0,g:0,b:0,a:1},b=(T,M,P,A)=>{const v=Math.max(1,Math.ceil(M.w)),w=Math.max(1,Math.ceil(M.h)),_=document.createElement("canvas");_.width=v,_.height=w;const C=_.getContext("2d"),D=C.createImageData(v,w),O=D.data,F=T[0],V=T[1],N=T[2],$=(V.y-N.y)*(F.x-N.x)+(N.x-V.x)*(F.y-N.y),L=A.map(I),k=[[F,V],[V,N],[N,F]];for(let R=0;R<w;R++)for(let X=0;X<v;X++){const z=M.x+X+.5,B=M.y+R+.5,Y=((V.y-N.y)*(z-N.x)+(N.x-V.x)*(B-N.y))/$,G=((N.y-F.y)*(z-N.x)+(F.x-N.x)*(B-N.y))/$,W=1-Y-G,oe=(R*v+X)*4;if(Y>=-.001&&G>=-.001&&W>=-.001){let U=0,te=0,J=0,Q=1;if(P==="vertices")U=Y*L[0].r+G*L[1].r+W*L[2].r,te=Y*L[0].g+G*L[1].g+W*L[2].g,J=Y*L[0].b+G*L[1].b+W*L[2].b;else{const ee=k.map((ie,de)=>{const le=Dt({x:z,y:B},ie[0],ie[1]);return{weight:1/Math.max(le.distance,1e-4),edgeIndex:de}}),ne=ee.reduce((ie,de)=>ie+de.weight,0)||1;ee.forEach(ie=>{const de=L[ie.edgeIndex],le=ie.weight/ne;U+=le*de.r,te+=le*de.g,J+=le*de.b})}O[oe]=Math.round(U),O[oe+1]=Math.round(te),O[oe+2]=Math.round(J),O[oe+3]=Math.round(Q*255)}else O[oe+3]=0}C.putImageData(D,0,0),e.drawImage(_,M.x,M.y)};if(r==="filled"){if(p&&p.type==="colormap"){const T=e.createLinearGradient(x[1].x,0,x[2].x,0);p.vertices.forEach(M=>{const P=M.color,A=M.alpha!==void 0?M.alpha:1,v=`rgba(${P.join(",")},${A})`;T.addColorStop(M.pos,v)}),e.fillStyle=T}else if(g&&g.length>=3){const{bounds:T}=fi(t);b(x,T,"vertices",g)}else if(y&&y.length>=3){const{bounds:T}=fi(t);b(x,T,"edges",y)}else e.fillStyle=c||s.face;!g&&!y&&e.fill(S)}else r==="disabled"&&(e.fillStyle=Rd,e.fill(S));if(a==="solid"||a==="disabled"){e.lineWidth=Rn,e.setLineDash([]);const T=[[0,1],[1,2],[2,0]];T.forEach((M,P)=>{const[A,v]=M,w=x[A],_=x[v];if(u&&u.length>=3)e.strokeStyle=u[P];else if(n.edgeColormapItem&&n.edgeColormapItem.type==="colormap"&&a==="solid"){const C=e.createLinearGradient(w.x,w.y,_.x,_.y),D=T.length>1?P/(T.length-1):.5,O=Math.max(0,Math.min(1,D)),F=Math.max(0,Math.min(1,D+.3)),V=Be(n.edgeColormapItem,O),N=Be(n.edgeColormapItem,F);C.addColorStop(0,V),C.addColorStop(1,N),e.strokeStyle=C}else if(h&&h.length>=3){const C=e.createLinearGradient(w.x,w.y,_.x,_.y);C.addColorStop(0,h[A]),C.addColorStop(1,h[v]),e.strokeStyle=C}else a==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||s.edge;e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(_.x,_.y),e.stroke()})}(o==="filled"||o==="disabled")&&(e.lineWidth=Rn,x.forEach((T,M)=>{let P=f&&f[M]||d||s.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&o==="filled"){const v=x.length>1?M/(x.length-1):.5;P=Be(n.vertexColormapItem,v)}o==="disabled"&&(P="#808080");const A=new Path2D;A.moveTo(T.x+Hn*2,T.y),A.arc(T.x,T.y,Hn*2,0,2*Math.PI),e.fillStyle=P,e.setLineDash([]),e.fill(A)})),m?(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(o==="disabled"||a==="disabled"||r==="disabled")&&(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),i&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Fn,e.setLineDash([]),e.strokeRect(t.x-2,t.y-2,t.width+4,t.height+4)),e.restore()}function Mf(e,t,n,s,i=!1){e.save();const o={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(o.x,o.y);const a=t.width/xo;e.scale(a,a),e.translate(-16,-16);let r=n.textColor||s.uiTextDefault;if(n.faceColorForContrast){const c=ys(n.faceColorForContrast);r=(.2126*c.r+.7152*c.g+.0722*c.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=r,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function ki(e,t,n,s,i,o,a,r,c,l,d,f={}){if(!t||t.length<3)return;e.save(),e.beginPath(),t.forEach((M,P)=>{P===0?e.moveTo(M.x,M.y):e.lineTo(M.x,M.y)}),e.closePath(),l&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(M=>{const P=r.find(A=>A.id===M);if(P){const A=P.vertexIds.map(v=>c(v)).filter(v=>v&&v.type==="regular");if(A.length>=3){const w=(d?gs(A,d,!0,i):A).map(_=>i(_));e.moveTo(w[0].x,w[0].y),w.slice(1).forEach(_=>{e.lineTo(_.x,_.y)}),e.closePath()}}});const{faceColorMode:h="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x",angleDisplayMode:m="degrees"}=f,x=Bo(n,h),S=n?.vertexIds?n.vertexIds.map(M=>c(M)).filter(Boolean):[],I=M=>M?.color||s.face,b=dt(s.face,{r:255,g:255,b:255,a:1}),E=(M,P,A)=>{const v=e.createPattern(M,"no-repeat"),w=i(P.origin),_=kn({x:1,y:0},P),C=kn({x:0,y:1},P),D=i(_),O=i(C),F=D.x-w.x,V=D.y-w.y,N=O.x-w.x,$=O.y-w.y,L=M.width,k=Math.max(A?.width||0,1e-6),R=Math.max(A?.height||0,1e-6),X=k/(L-1),z=R/(L-1),B=F*X,Y=V*X,G=N*z,W=$*z,oe={x:A?.minX||0,y:A?.minY||0},U=kn(oe,P),te=i(U),J=te.x,Q=te.y,ee=new DOMMatrix([B,Y,G,W,J,Q]);return v.setTransform(ee),v},T=(M,P)=>{const v=document.createElement("canvas");v.width=64,v.height=64;const w=v.getContext("2d"),_=w.createImageData(64,64),C=_.data,D=1/63,O=S.filter(U=>U.type==="regular"),F=O.map(U=>Mo(U,P));let V=1/0,N=1/0,$=-1/0,L=-1/0,k=1;F.forEach(U=>{!Number.isFinite(U.x)||!Number.isFinite(U.y)||(V=Math.min(V,U.x),N=Math.min(N,U.y),$=Math.max($,U.x),L=Math.max(L,U.y),k=Math.max(k,Math.hypot(U.x,U.y)))}),(!Number.isFinite(V)||!Number.isFinite(N)||!Number.isFinite($)||!Number.isFinite(L))&&(V=-1,N=-1,$=1,L=1);const R={minX:V,minY:N,width:Math.max($-V,1e-6),height:Math.max(L-N,1e-6),maxRadius:Math.max(k,1e-6)},X=.02,z=2,B=O.map(U=>dt(I(U),b)),Y=U=>({x:(U.x-V)/R.width,y:(U.y-N)/R.height}),G=F.map(Y),W=[];if(n?.vertexIds&&n.vertexIds.length>1)for(let U=0;U<n.vertexIds.length;U++){const te=n.vertexIds[U],J=n.vertexIds[(U+1)%n.vertexIds.length],Q=a?.find(ie=>ie.id1===te&&ie.id2===J||ie.id1===J&&ie.id2===te)||{id1:te,id2:J},ee=c(Q.id1),ne=c(Q.id2);ee&&ne&&W.push({edge:Q,mode:rs(Q,u),v1:ee,v2:ne,v1Local:Mo(ee,P),v2Local:Mo(ne,P),v1Norm:Y(Mo(ee,P)),v2Norm:Y(Mo(ne,P))})}const oe=(U,te)=>{const{edge:J,v1:Q,v2:ee,mode:ne}=U;if(ne==="inherit_vertices"&&Q&&ee){const ie=dt(I(Q),b),de=dt(I(ee),b);return{r:Nt(ie.r,de.r,te),g:Nt(ie.g,de.g,te),b:Nt(ie.b,de.b,te),a:Nt(ie.a,de.a,te)}}if(ne==="colormap"&&J.colormapItem){const ie=J.colorExpression||y,de=Fo(ie,{x:te},te),le=Be(J.colormapItem,de);return dt(le,b)}return dt(J.color||s.edge,b)};for(let U=0;U<64;U++)for(let te=0;te<64;te++){const J=R.minX+te*D*R.width,Q=R.minY+U*D*R.height,ee=Ea((J-R.minX)/R.width),ne=Ea((Q-R.minY)/R.height);let ie=b;if(M==="colormap_xy"||M==="colormap_polar")if(n?.colormapItem){const le=Math.hypot(J,Q);let me=Math.atan2(Q,J);me<0&&(me+=He);const Te=m==="degrees"?me*(180/Math.PI):me,ot=n?.colorExpression||p||g||"x",qe=Fo(ot,{x:ee,y:ne,r:le,a:Te},ee);if(Array.isArray(n.colormapItem.vertices)&&n.colormapItem.vertices.length===1){const on=Be(n.colormapItem,0);ie=dt(on,b)}else if(n.colormapItem.isCyclic){const on=Be(n.colormapItem,qe);ie=dt(on,b)}else if(qe<0)ie={...b,a:0};else if(qe>1){const on=Be(n.colormapItem,1);ie=dt(on,b)}else{const on=Be(n.colormapItem,qe);ie=dt(on,b)}}else ie=b;else if(M==="inherit_vertices"&&F.length>0){const le=G.map(me=>{const Te=ee-me.x,ot=ne-me.y,qe=Math.hypot(Te,ot);return 1/Math.pow(Math.max(qe,X),z)});ie=xl(B,le)}else if(M==="inherit_edges"&&W.length>0){const le=W.map(Te=>{const ot=Dt({x:ee,y:ne},Te.v1Norm,Te.v2Norm);return 1/Math.pow(Math.max(ot.distance,X),z)}),me=W.map((Te,ot)=>{const qe=Dt({x:ee,y:ne},Te.v1Norm,Te.v2Norm);return oe(Te,qe.t)});ie=xl(me,le)}const de=(U*64+te)*4;C[de]=Math.round(ie.r),C[de+1]=Math.round(ie.g),C[de+2]=Math.round(ie.b),C[de+3]=Math.round(Ea(ie.a)*255)}return w.putImageData(_,0,0),{canvas:v,bounds:R}};if(x==="fixed")e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");else if(n.localCoordSystem){const M=T(x,n.localCoordSystem),P=E(M.canvas,n.localCoordSystem,M.bounds);e.fillStyle=P||n?.color||s.face,e.fill(l?"evenodd":"nonzero")}else n?.colormapItem&&n.localCoordSystem,e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");e.restore()}function Ef(e,t,n,s,i,o){const{angleDisplayMode:a,distanceDisplayMode:r,colors:c}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":Ul(e,l,a,a!==Oo,s,i,c);break;case"distances":Jl(e,l,r,r===No,s,i,c);break}}function Tf(e,t,n,s){const{canvasUI:i,colorAssignments:o,allColors:a,colors:r}=n,c=l=>{if(!o||!a)return r.uiIcon;const d=o[l];if(d===-1)return js;const f=a[d];return f&&f.type==="color"?f.value:r.uiIcon};c(Ue),c(Je),c(at),i.visibilityIcons.forEach(l=>{Ef(e,l,n,t,s)})}function Zl(e,t,n,s){const i={x:t.x+t.width*.22,y:t.y+t.height*.78},o={x:t.x+t.width*.22,y:t.y+t.height*.22},a={x:t.x+t.width*.78,y:t.y+t.height*.22},r=[i,o,a],l=!s||s.type==="linear"?r:gs(r,s,!1,null),d=(f,h)=>{const u=Math.atan2(h.y-f.y,h.x-f.x),p=t.width*.08,g={x:h.x-Math.cos(u)*p+Math.cos(u+Math.PI/2)*p*.6,y:h.y-Math.sin(u)*p+Math.sin(u+Math.PI/2)*p*.6},y={x:h.x-Math.cos(u)*p+Math.cos(u-Math.PI/2)*p*.6,y:h.y-Math.sin(u)*p+Math.sin(u-Math.PI/2)*p*.6};e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(g.x,g.y),e.lineTo(y.x,y.y),e.closePath(),e.fill()};e.save(),e.strokeStyle=n.uiIcon,e.lineWidth=ir,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let f=1;f<l.length;f++)e.lineTo(l[f].x,l[f].y);e.stroke(),e.fillStyle=n.uiIcon,r.forEach(f=>{e.beginPath(),e.arc(f.x,f.y,Hn+.5,0,Math.PI*2),e.fill()}),s?.linearStyle==="arrows"&&(d(i,o),d(o,a)),e.restore()}function Cf(e,t,n,s){const{canvasUI:i,colors:o,activeInterpolationStyleId:a,selectedInterpolationStyleId:r,interpolationStyles:c}=n;i.interpolationIcons.forEach(l=>{const d={x:l.x,y:l.y,width:l.width,height:l.height};if(l.type==="interpolationStyle"){const f=l.styleId===(r||a);e.strokeStyle=o.uiDefault,e.lineWidth=Po,e.strokeRect(d.x,d.y,d.width,d.height),f&&(e.strokeStyle=o.selectionGlow,e.lineWidth=Fn,e.strokeRect(d.x-2,d.y-2,d.width+4,d.height+4));const h=c.find(p=>p.id===l.styleId);Zl(e,d,o,h);const u=h?.name||"";u&&u.toLowerCase()!=="linear"&&s({id:`interpolation-label-${l.styleId}`,content:u.length>6?`${u.slice(0,6)}...`:u,x:d.x+d.width/2,y:d.y+d.height+10,color:o.uiTextDefault,fontSize:ar,options:{textAlign:"center",textBaseline:"top"}},t)}else l.type==="interpolationRemove"?(e.strokeStyle=o.uiDefault,e.lineWidth=Po,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.strokeStyle=o.uiIcon,e.lineWidth=ir,e.stroke()):l.type==="interpolationAdd"&&(e.strokeStyle=o.uiDefault,e.lineWidth=Po,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width/2,d.y+d.height*.25),e.lineTo(d.x+d.width/2,d.y+d.height*.75),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.stroke())})}function wf(e,t,n,s){const{canvasUI:i,colors:o,activeThemeName:a,colorAssignments:r,allColors:c,verticesVisible:l,edgesVisible:d,facesVisible:f}=n,h=i.toolbarButton;e.strokeStyle=o.uiDefault,e.lineWidth=Ll,e.beginPath();for(let b=0;b<3;b++){const E=h.y+5+b*10;e.moveTo(h.x+4,E),e.lineTo(h.x+h.width-4,E)}e.stroke();const u=i.colorToolButton;u&&vf(e,u,{verticesVisible:l,edgesVisible:d,facesVisible:f,colorAssignments:r,allColors:c},o);const p=i.colorModeToolButton;if(p){const b=p,E={x:b.x,y:b.y,width:b.width,height:b.height};(M=>{const{vertices:P}=fi(M),A=[[P[0],P[1]],[P[1],P[2]],[P[2],P[0]]],v=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"];A.forEach((w,_)=>{e.strokeStyle=v[_],e.lineWidth=2,e.beginPath(),e.moveTo(w[0].x,w[0].y),e.lineTo(w[1].x,w[1].y),e.stroke()})})(E),e.fillStyle="#ffffff",$o(e,E,{edgeState:"none",faceState:"filled",vertexState:"none",faceColor:"#ffffff"},o)}const g=i.transformToolButton;g&&s({id:"transform-tool-label",content:Yd,x:g.x+g.width/2,y:g.y+g.height/2,color:o.uiIcon,fontSize:Xd,options:{textAlign:"center",textBaseline:"middle"}},t);const y=i.interpolationToolButton;y&&Zl(e,y,o);const m=i.displayToolButton;if(m){e.strokeStyle=o.uiDefault,e.fillStyle=o.uiDefault,e.lineWidth=ir;const b=m.width-Gd;for(let E=0;E<3;E++){const T=m.y+zd+E*Hd;e.beginPath(),e.moveTo(m.x+6,T),e.lineTo(m.x+6+b,T),e.stroke(),e.beginPath(),e.arc(m.x+6+b*(E/2),T,Wd,0,2*Math.PI),e.fill()}}const x=i.visibilityToolButton;x&&mf(e,x,o);const S=i.sessionsToolButton;if(S){e.save(),e.strokeStyle=o.uiDefault,e.lineWidth=Rn;const b=6,E=Math.min(S.width,S.height)-b*2,T=S.x+b,M=S.y+b;e.strokeRect(T+4,M+2,E,E),e.strokeRect(T,M+6,E,E),e.restore()}const I=i.themeToggleButton;I&&jl(e,I,a,o)}function Pf(e,t){const{canvasUI:n,colors:s}=t;n.transformIcons.forEach(i=>{oa(e,i,s)})}function Af(e,t,n,s){const{canvasUI:i,colors:o,coordsDisplayMode:a,gridDisplayMode:r,angleDisplayMode:c,distanceDisplayMode:l,activeThemeName:d}=n;i.displayIcons.forEach(f=>{const h={x:f.x,y:f.y,width:f.width,height:f.height};switch(f.group){case"coords":pf(e,h,a,a!==Qi,t,s,o);break;case"grid":yf(e,h,r,r!==Wo,o);break;case"angles":Ul(e,h,c,c!==Oo,t,s,o);break;case"distances":Jl(e,h,l,l===No,t,s,o);break;case"theme":jl(e,h,d,o);break}})}function _f(e,t,n,s){const{dpr:i,isToolbarExpanded:o,isColorPaletteExpanded:a,isColorModePanelExpanded:r,isInterpolationPanelExpanded:c,isTransformPanelExpanded:l,isDisplayPanelExpanded:d,isVisibilityPanelExpanded:f,isSessionsPanelExpanded:h,isPlacingTransform:u,placingTransformType:p,placingSnapPos:g,mousePos:y,colors:m}=n;if(e.save(),e.resetTransform(),e.scale(i,i),o)wf(e,t,n,s);else{const x=n.canvasUI.toolbarButton;e.strokeStyle=m.uiDefault,e.lineWidth=Ll,e.beginPath();for(let S=0;S<3;S++){const I=x.y+5+S*10;e.moveTo(x.x+4,I),e.lineTo(x.x+x.width-4,I)}e.stroke()}if(a&&xf(e,t,n),r&&Sf(e,t,n),c&&Cf(e,t,n,s),l&&Pf(e,n),d&&Af(e,t,n,s),f&&Tf(e,t,n,s),h&&bf(e,n),u){const x=g||y;if(x){const S=xa/2,I={type:p,x:x.x-S,y:x.y-S,width:xa,height:xa};oa(e,I,m)}}e.restore()}function Sl(e,t,n,s,{showDistances:i,distanceSigFigs:o,colors:a,lastGridState:r,currentShiftPressed:c},l,d,f,h,u=null,p=null,g=null){!i||n.length===0||n.forEach(y=>{const m=s.find(x=>d(x)===y);if(m){let x=l(m.id1),S=l(m.id2);if(u){const I=u.find(E=>E.id===m.id1),b=u.find(E=>E.id===m.id2);I&&(x=I),b&&(S=b)}if(x&&S&&x.type==="regular"&&S.type==="regular"){let I;const b=u&&g;if(m.labelMode==="exact"&&m.exactValue){const[D,O]=Ps(m.exactValue.g2gSquaredSum);let F=m.exactValue.gridInterval*D;if(b&&g.transformType!==xn){const V=g.snappedScaleValue!==null?g.snappedScaleValue:g.scale;F*=V}I=As(parseFloat(F.toFixed(10)),O)}else I=xt(ae(x,S),o);const E=f(x),T=f(S),M=(E.x+T.x)/2,P=(E.y+T.y)/2,A=Math.atan2(T.y-E.y,T.x-E.x);let v=A-Math.PI/2;Math.sin(v)>0&&(v+=Math.PI);const w=M+Math.cos(v)*os,_=P+Math.sin(v)*os;let C=A*(180/Math.PI);(C>90||C<-90)&&(C+=180),h({id:`selected-edge-dist-${y}`,content:I,x:w,y:_,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:vn,options:{rotation:C}})}}})}function Df(e,t,n,s){e.save(),e.strokeStyle=s.mouseCoords,e.lineWidth=pn,e.setLineDash(zn);const i=Math.min(t.x,n.x),o=Math.min(t.y,n.y),a=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);e.strokeRect(i,o,a,r),e.restore()}function _o(e,t,n,s,{lastGridState:i,showDistances:o,showAngles:a,distanceSigFigs:r,angleDisplayMode:c,angleSigFigs:l,currentShiftPressed:d,viewTransform:f,colors:h},u,p,g,y=!1,m=null,x=null,S=[],I=!1,b=[],E=null,T=new Map){const M=y?h.feedbackSnapped:`rgba(${h.feedbackDefault.join(",")}, 1.0)`,P=new Map(s.map($=>[$.id,{...$}])),A=$=>P.get($),v=A(n);if(!v)return;const w=p(v.id).map(A).filter(Boolean),_=u(v),C=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,O=(T.get(n)||[]).find($=>$.type==="projection"&&$.projectionLine);if(O){const[$,L]=O.projectionLine,k=u($),R=u(L),X={x:R.x-k.x,y:R.y-k.y},z=Math.hypot(X.x,X.y);if(z>0){const B={x:X.x/z,y:X.y/z},Y=1e4,G={x:k.x-B.x*Y,y:k.y-B.y*Y},W={x:k.x+B.x*Y,y:k.y+B.y*Y};e.save(),e.strokeStyle=M,e.lineWidth=pn,e.setLineDash(Dl),e.beginPath(),e.moveTo(G.x,G.y),e.lineTo(W.x,W.y),e.stroke(),e.restore()}}const F=($,L)=>{if(!$||!L||L<=0)return!1;const k=L*1e-6,R=Math.abs($.x/L-Math.round($.x/L))<k,X=Math.abs($.y/L-Math.round($.y/L))<k;return R&&X},V=w.every($=>S.includes($.id)),N=b.find($=>$.id===n);if(!E&&I&&d&&V&&N&&ae(N,v)>ye){const $=u(N),L=_,k=Math.atan2(L.y-$.y,L.x-$.x),R=Math.atan2(v.y-N.y,v.x-N.x);if(o){let X;const z=C&&F(N,C),B=C&&F(v,C);if(z&&B){const J=v.x-N.x,Q=v.y-N.y,ee=Math.round(J/C),ne=Math.round(Q/C),ie=ee*ee+ne*ne;if(ie===0)X="0";else{const[de,le]=Ps(ie),me=C*de,Te=parseFloat(me.toFixed(10));X=As(Te,le)}}else{const J=r+2;X=xt(ae(N,v),J)}const Y=($.x+L.x)/2,G=($.y+L.y)/2;let W;a&&Math.abs(R)>ye?-R<0?W=k-Math.PI/2:W=k+Math.PI/2:(W=k-Math.PI/2,Math.sin(W)>0&&(W+=Math.PI));const oe=Y+Math.cos(W)*os,U=G+Math.sin(W)*os;let te=k*(180/Math.PI);(te>90||te<-90)&&(te+=180),x({id:`drag-dist-vector-${v.id}`,content:X,x:oe,y:U,color:M,fontSize:vn,options:{rotation:te}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=M,e.lineWidth=pn,e.beginPath(),e.moveTo($.x,$.y),e.lineTo(L.x,L.y),e.stroke(),e.restore(),a&&Math.abs(k)>ye){Ir(e,$,0,R,ro,M);let X;if(c===ks?X=`${xt(R*(180/Math.PI),l)}^{\\circ}`:X=xt(R,l),X){const z=-R/2,B=Ci,Y={x:B*Math.cos(z),y:B*Math.sin(z)},G={x:$.x+Y.x,y:$.y+Y.y};let W=z*(180/Math.PI);(W>90||W<-90)&&(W+=180),x({id:`drag-angle-vector-${v.id}`,content:X,x:G.x,y:G.y,color:M,fontSize:vn,options:{rotation:W}},t)}}}if(o&&w.forEach($=>{const L=S.includes($.id);if(!I||!L){const k=v,R=$,X=g({id1:k.id,id2:R.id});let z;if(C&&F(k,C)&&F(R,C)){const ne=k.x-R.x,ie=k.y-R.y,de=Math.round(ne/C),le=Math.round(ie/C),me=de*de+le*le;if(me===0)z="0";else{const[Te,ot]=Ps(me),qe=C*Te,Ht=parseFloat(qe.toFixed(10));z=As(Ht,ot)}}else{const ne=ae(k,R);z=xt(ne,r)}const Y=u(k),G=u(R),W=(Y.x+G.x)/2,oe=(Y.y+G.y)/2,U=Math.atan2(G.y-Y.y,G.x-Y.x);let te=U-Math.PI/2;Math.sin(te)>0&&(te+=Math.PI);const J=W+Math.cos(te)*os,Q=oe+Math.sin(te)*os;let ee=U*(180/Math.PI);(ee>90||ee<-90)&&(ee+=180),x({id:`drag-dist-${X}`,content:z,x:J,y:Q,color:M,fontSize:vn,options:{rotation:ee}})}}),a&&w.length>=2&&(!I||w.some($=>!S.includes($.id)))){const $=[...w].sort((L,k)=>{const R=Math.atan2(L.y-v.y,L.x-v.x),X=Math.atan2(k.y-v.y,k.x-v.x);return R-X});for(let L=0;L<$.length;L++){const k=$[L],R=$[(L+1)%$.length],X=S.includes(k.id),z=S.includes(R.id);if(!(!I||!X||!z))continue;const Y={x:k.x-v.x,y:k.y-v.y},G={x:R.x-v.x,y:R.y-v.y},W=Math.atan2(Y.y,Y.x),oe=Math.atan2(G.y,G.x);let U=oe-W;if(U<0&&(U+=2*Math.PI),U<ye)continue;const te=W+U/2;e.save(),e.strokeStyle=M,e.lineWidth=pn,e.beginPath(),e.arc(_.x,_.y,ro,-W,-oe,!1),e.stroke(),e.restore();let J;if(c===ks?J=`${xt(U*(180/Math.PI),l)}^{\\circ}`:c===Ko&&(d?(J=un(U/Math.PI,.015,32)+"\\pi",J.startsWith("1\\pi")&&(J="\\pi"),J.startsWith("-1\\pi")&&(J="-\\pi"),J==="0\\pi"&&(J="0")):J=xt(U,l)),J){const Q=`drag-angle-${v.id}-${k.id}-${R.id}`,ee={x:v.x+Math.cos(te),y:v.y+Math.sin(te)},ne=u(ee),ie=Math.atan2(ne.y-_.y,ne.x-_.x),de=Ci,le={x:de*Math.cos(ie),y:de*Math.sin(ie)},me={x:_.x+le.x,y:_.y+le.y};let Te=ie*(180/Math.PI);(Te>90||Te<-90)&&(Te+=180),x({id:Q,content:J,x:me.x,y:me.y,color:M,fontSize:vn,options:{rotation:Te}},t)}}}}function kf(e,t,n,s,{showAngles:i,angleSigFigs:o,angleDisplayMode:a,currentShiftPressed:r,distanceSigFigs:c,viewTransform:l,lastGridState:d,colors:f},h,u,p,g,y){!i||n.length===0||n.forEach(m=>{const x=s.find(S=>u(S)===m);if(x){const S=h(x.id1),I=h(x.id2);if(S&&I&&S.type==="regular"&&I.type==="regular"){const b={lastGridState:d,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:o,currentShiftPressed:r,viewTransform:l,colors:f};_o(e,t,S.id,[S,I],b,p,g,u,!1,null,y),_o(e,t,I.id,[S,I],b,p,g,u,!1,null,y)}}})}function Ql(e,{allFaces:t,selectedFaceIds:n,colors:s,isDragConfirmed:i,dragPreviewVertices:o,initialDragVertexStates:a,transformIndicatorData:r,highlightedEdgeForSnap:c,draggedFaceId:l,coordSystemSnapAngle:d,coordSystemSnapType:f,coordSystemSnapScale:h,initialCoordSystemStates:u},p,g){if(n.length>Qd)return;const y=new Set(n);y.size!==0&&y.forEach(m=>{const x=t.find(I=>I.id===m);if(!x||!x.localCoordSystem)return;let S=x.localCoordSystem;if(i&&x.vertexIds.some(I=>o.some(b=>b.id===I))){const I=u.get(x.id);S=xr(x,{initialSystem:I,dragPreviewVertices:o,initialDragVertexStates:a,findVertexById:g,transformIndicatorData:r})}if(l===m&&d!==null){const I=E=>{if(i&&o){const T=o.find(M=>M&&M.id===E);if(T)return T}return g(E)},b=p(S.origin);if(f==="edge"&&c!==null){const E=x.vertexIds.map(T=>I(T)).filter(T=>T&&T.type==="regular");if(c<E.length){const T=E[c],M=E[(c+1)%E.length],P=p(T),A=p(M);e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(A.x,A.y),e.stroke(),e.restore()}}else if(f==="cardinal"){const T=b.x+Math.cos(-d)*100,M=b.y+Math.sin(-d)*100,P=b.x-Math.cos(-d)*100,A=b.y-Math.sin(-d)*100;e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(P,A),e.lineTo(T,M),e.stroke(),e.restore()}}Rf(e,S,s,p,h)})}function Rf(e,t,n,s,i=null){const o=s(t.origin),a=kn({x:1,y:0},t),r=kn({x:0,y:1},t),c=s(a),l=s(r);e.save(),e.lineWidth=us,e.lineCap="round";const d=(u,p,g,y)=>{e.strokeStyle=g,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(p.x,p.y),e.stroke(),e.fillStyle=y;const m=Math.atan2(p.y-u.y,p.x-u.x);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(p.x-$e*Math.cos(m-fn),p.y-$e*Math.sin(m-fn)),e.lineTo(p.x-$e*Math.cos(m+fn),p.y-$e*Math.sin(m+fn)),e.closePath(),e.fill()},f=i!==null?n.feedbackSnapped:n.coordSysX,h=i!==null?n.feedbackSnapped:n.coordSysY;d(o,c,f,f),d(o,l,h,h),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(o.x,o.y,Ld,0,2*Math.PI),e.fill(),e.restore()}const Lf=6,Of=500,Nf=300,Il=8;function Ta(e,t){return{x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}}function bl(e,t){const n=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.hypot(n,s)}function Pn(e,t,n,s,i){const{shiftKey:o,ctrlKey:a,altKey:r,metaKey:c}=i||{};return{button:n,clientX:t.clientX,clientY:t.clientY,shiftKey:!!o,ctrlKey:!!a,metaKey:!!c,altKey:!!r,target:e,preventDefault:()=>s.preventDefault(),stopPropagation:()=>s.stopPropagation()}}function Ff({canvas:e,onMouseDown:t,onMouseMove:n,onMouseUp:s,onPinchZoom:i,onPan:o,getModifiers:a,isHoverMode:r,getHoverTarget:c,getUiTargetAt:l}){let d=null,f=null,h=null,u=!1,p=!1,g=0,y=null,m=null,x=!1,S=!1,I=null,b=0;const E=()=>typeof a=="function"?a():{},T=()=>typeof r=="function"?r():!1,M=()=>typeof c=="function"?c():null,P=D=>typeof l=="function"?l(D):null,A=()=>{h&&(clearTimeout(h),h=null),u=!1},v=(D,O)=>{A(),h=setTimeout(()=>{u=!0;const F=Pn(e,D,2,O,E());t(F)},Of)},w=D=>{if(!(!D.touches||D.touches.length===0)){if(D.preventDefault(),D.touches.length===1){const O=D.touches[0];if(d=O.identifier,f={x:O.clientX,y:O.clientY},m={x:O.clientX,y:O.clientY},p=!1,g=0,y=null,x=!1,S=!1,I=null,T()){const F=Pn(e,O,0,D,E());n(F);const V=P({x:O.clientX,y:O.clientY}),N=M();if(V||N&&N.type&&N.type!=="canvas"){const $=Pn(e,O,0,D,E());t($)}else x=!0}else{v(O,D);const F=Pn(e,O,0,D,E());t(F)}return}if(D.touches.length===2){if(A(),S=T()&&x&&!!m,b=Date.now(),I=Ta(D.touches[0],D.touches[1]),d!==null&&f){const V=D.touches[0],N=Pn(e,V,0,D,E());s(N)}p=!0,d=null;const[O,F]=D.touches;g=bl(O,F),y=Ta(O,F)}}},_=D=>{if(!(!D.touches||D.touches.length===0)){if(D.preventDefault(),p&&D.touches.length>=2){const[O,F]=D.touches,V=bl(O,F),N=Ta(O,F);if(S&&I){const $=Math.hypot(N.x-I.x,N.y-I.y),L=Math.abs(V-g);($>Il||L>Il)&&(S=!1)}if(!S){if(g>0){const $=V/g;Number.isFinite($)&&$!==1&&i($,N)}if(y){const $=N.x-y.x,L=N.y-y.y;($!==0||L!==0)&&o({x:$,y:L})}}g=V,y=N;return}if(D.touches.length===1&&d!==null){const O=D.touches[0],F=O.clientX-(f?.x??O.clientX),V=O.clientY-(f?.y??O.clientY);Math.hypot(F,V)>Lf&&A(),f={x:O.clientX,y:O.clientY},m={x:O.clientX,y:O.clientY};const N=Pn(e,O,0,D,E());n(N)}}},C=D=>{if(D.preventDefault(),p&&D.touches.length<2&&(p=!1,g=0,y=null),S&&m){if(Date.now()-b<=Nf){const F={clientX:m.x,clientY:m.y},V=Pn(e,F,0,D,E()),N=Pn(e,F,0,D,E());t(V),s(N)}}else if(d!==null&&!T()){const O=Array.from(D.changedTouches).find(F=>F.identifier===d)||D.changedTouches[0];if(O)if(u){const F=Pn(e,O,2,D,E());s(F)}else{const F=Pn(e,O,0,D,E());s(F)}}A(),S=!1,I=null,d=D.touches.length===1?D.touches[0].identifier:null,D.touches.length===0&&(f=null,m=null)};return e.style.touchAction="none",e.addEventListener("touchstart",w,{passive:!1}),e.addEventListener("touchmove",_,{passive:!1}),e.addEventListener("touchend",C,{passive:!1}),e.addEventListener("touchcancel",C,{passive:!1}),()=>{A(),e.removeEventListener("touchstart",w),e.removeEventListener("touchmove",_),e.removeEventListener("touchend",C),e.removeEventListener("touchcancel",C)}}class Bf{constructor(){this.appMode="static",this.mode="idle",this.dragAction=null,this.selection={transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set},this.hoverTarget={type:"canvas",id:null},this.modifiers={shift:!1,ctrl:!1,alt:!1},this.marqueeRect={active:!1,startX:0,startY:0,endX:0,endY:0},this.lastClickTime=0,this.lastClickTarget={type:null,id:null},this.clickCount=0,this.selectionBeforeClick=null,this.zoomLevel=1,this.activeTransformationObjectId=null,this.lastMouseX=0,this.lastMouseY=0,this.textInput={active:!1,x:0,y:0,value:""},this.touchTimerId=null,this.initialTouchData=null}clearGeometricSelection(){this.selection.vertices.clear(),this.selection.edges.clear(),this.selection.faces.clear(),this.selection.text.clear()}clearTransformationObjectSelection(){this.selection.transformationObjects.clear(),this.activeTransformationObjectId=null}clearSelection(){this.clearGeometricSelection(),this.clearTransformationObjectSelection(),this.selection.ui.clear()}}const $f=300,Vf=500,vl=1.1,Ml=.2,El=5,Ae={IDLE:"idle",DRAWING:"drawing",DRAGGING:"dragging",SELECTING:"selecting",TYPING:"typing"},ue={VERTEX:"vertex",EDGE:"edge",FACE:"face",TEXT:"text",TRANSFORMATION_OBJECT:"transformationObject",MANIFOLD:"manifold",UI:"ui",CANVAS:"canvas"},Nn={[ue.VERTEX]:"vertices",[ue.EDGE]:"edges",[ue.FACE]:"faces",[ue.TEXT]:"text",[ue.TRANSFORMATION_OBJECT]:"transformationObjects",[ue.MANIFOLD]:"manifolds",[ue.UI]:"ui"},Vn={PANNING:"panning",MARQUEE_SELECT:"marqueeSelect",RIGID_DRAG:"rigidDrag"};function Qn(e,t,n){if(t===ue.UI)return;const s=Nn[t];if(!s){console.warn(`No selection key for type: ${t}`);return}const i=e.selection[s];if(!i){console.warn(`No selection set for type: ${t} (key: ${s})`);return}const o=e.modifiers.ctrl&&!e.modifiers.shift;n.forEach(a=>{o&&i.has(a)?i.delete(a):i.add(a)})}function Xf(e,t,n){const{originalSelection:s}=e.dragAction;if(!s)return;const i=n&&n.ctrlKey,o=n&&n.shiftKey,{startX:a,startY:r,endX:c,endY:l}=e.marqueeRect,d={minX:Math.min(a,c),maxX:Math.max(a,c),minY:Math.min(r,l),maxY:Math.max(r,l)},f=t.getEntitiesInRect(d),h=new Set(s.vertices),u=new Set(s.edges),p=new Set(s.faces),g=new Set(s.text),y=new Set(s.transformationObjects),m={[Nn[ue.VERTEX]]:h,[Nn[ue.EDGE]]:u,[Nn[ue.FACE]]:p,[Nn[ue.TEXT]]:g,[Nn[ue.TRANSFORMATION_OBJECT]]:y},x=i&&!o;!i&&!o?e.clearGeometricSelection():(e.selection.vertices=new Set(s.vertices),e.selection.edges=new Set(s.edges),e.selection.faces=new Set(s.faces),e.selection.text=new Set(s.text),e.selection.transformationObjects=new Set(s.transformationObjects)),f.length>0&&f.forEach(I=>{const b=Nn[I.type];if(!b||!e.selection[b])return;const E=e.selection[b],M=m[b]?.has(I.id);x&&M?E.delete(I.id):E.add(I.id)})}function Yf(e,t,n,s){if(e.mode===Ae.TYPING){s.preventDefault(),s.key==="Enter"||s.key==="Escape"?(n.stopTyping(e),e.mode=Ae.IDLE):s.key==="Backspace"?n.backspace(e):s.key.length===1&&n.updateText(e,s.key);return}if(s.key==="Shift"&&(e.modifiers.shift=!0),s.key==="Control"&&(e.modifiers.ctrl=!0),s.key==="Alt"&&(e.modifiers.alt=!0),e.modifiers.ctrl&&(s.key==="a"||s.key==="A")){s.preventDefault(),e.clearGeometricSelection(),document.querySelectorAll(".proxy-entity").forEach(i=>{const o=i.dataset.type,a=i.dataset.id,r=Nn[o];if(r&&o!==ue.TRANSFORMATION_OBJECT&&o!==ue.UI){const c=e.selection[r];c&&c.add(a)}}),e.clickCount=0,e.selectionBeforeClick=null;return}(s.key==="Escape"||s.key==="Esc")&&(e.mode=Ae.IDLE,e.dragAction=null,e.clearSelection(),e.activeTransformationObjectId=null,e.marqueeRect.active=!1,e.clickCount=0,e.selectionBeforeClick=null),s.key.length===1&&!s.ctrlKey&&!s.metaKey&&(e.mode===Ae.IDLE||e.mode===Ae.DRAWING)&&(s.preventDefault(),e.mode=Ae.TYPING,n.startTyping(e),n.updateText(e,s.key))}function Gf(e,t,n,s){s.key==="Shift"&&(e.modifiers.shift=!1),s.key==="Control"&&(e.modifiers.ctrl=!1),s.key==="Alt"&&(e.modifiers.alt=!1)}function ec(e,t,n,s){let i=e.zoomLevel;s.deltaY<0?i*=vl:s.deltaY>0&&(i/=vl),i<Ml&&(i=Ml),i>El&&(i=El),e.zoomLevel=i}function tc(e,t,n,s){e.hoverTarget={type:s.type,id:s.id}}function nc(e,t,n,s){e.hoverTarget.id===s.id&&(e.hoverTarget={type:ue.CANVAS,id:null})}function zf(e,t,n,s){e.appMode=s.mode}function Hf(e,t,n,s){e.mode===Ae.TYPING&&(n.stopTyping(e),e.mode=Ae.IDLE),s.button===0&&e.hoverTarget.type===ue.CANVAS&&(e.clickCount=0,e.selectionBeforeClick=null,e.dragAction={hasMoved:!1,button:0})}function Ri(e){return e?{transformationObjects:new Set(e.transformationObjects),vertices:new Set(e.vertices),edges:new Set(e.edges),faces:new Set(e.faces),text:new Set(e.text),ui:new Set(e.ui)}:{transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set}}function sc(e,t,n,s){if(e.mode===Ae.TYPING&&(n.stopTyping(e),e.mode=Ae.IDLE),s.button===0){if(e.modifiers.alt){e.mode=Ae.DRAWING,e.clickCount=0,e.selectionBeforeClick=null;return}const i=Date.now(),{type:o,id:a}=s,r=Nn[o];if(!r){console.warn(`Unknown entity type for selection: ${o}`);return}const c=e.selection[r],l=c&&c.has(a),d=o===ue.VERTEX||o===ue.EDGE||o===ue.FACE||o===ue.TEXT,f=o===ue.TRANSFORMATION_OBJECT;if(e.lastClickTarget.id===a&&i-e.lastClickTime<$f?e.clickCount++:(e.clickCount=1,e.selectionBeforeClick=Ri(e.selection)),e.lastClickTime=i,e.lastClickTarget={type:o,id:a},o===ue.UI){e.clickCount=0,e.selectionBeforeClick=null;return}if(e.clickCount===1)e.modifiers.ctrl||e.modifiers.shift?Qn(e,o,[a]):l||(d?e.clearGeometricSelection():f&&e.clearTransformationObjectSelection(),Qn(e,o,[a]));else if(e.selection=Ri(e.selectionBeforeClick),d)if(e.clickCount===2){const h=t.getNeighbors(a),u={};h.forEach(p=>{const g=t.getEntityType(p);!g||g===ue.UI||(u[g]||(u[g]=[]),u[g].push(p))});for(const p in u)Qn(e,p,u[p]);Qn(e,o,[a])}else{const h=t.getAllConnected(a),u=[];h.forEach(p=>{t.getEntityType(p)===o&&u.push(p)}),Qn(e,o,u)}else f&&Qn(e,o,[a]);if(f){const h=e.selection.transformationObjects;h.has(a)?e.activeTransformationObjectId=a:e.activeTransformationObjectId===a&&(e.activeTransformationObjectId=h.size>0?Array.from(h)[h.size-1]:null)}e.clickCount>=3&&(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction={hasMoved:!1,button:0,draggedEntityType:o,draggedEntityId:a,wasAlreadySelected:l}}}function oc(e,t,n,s){if(e.lastMouseX=s.clientX,e.lastMouseY=s.clientY,e.mode===Ae.TYPING&&(e.textInput.x=s.clientX,e.textInput.y=s.clientY),!!e.dragAction){if(!e.dragAction.hasMoved)if(e.dragAction.hasMoved=!0,e.clickCount>0&&e.selectionBeforeClick&&(e.selection=Ri(e.selectionBeforeClick)),e.clickCount=0,e.selectionBeforeClick=null,e.dragAction.button===0)if(e.dragAction.draggedEntityType){const i=t.getDragType(e);i?(e.dragAction.type=i,e.mode=Ae.DRAGGING):e.dragAction.type=Vn.PANNING}else e.dragAction.type=Vn.PANNING,!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection();else e.dragAction.button===2&&(e.dragAction.type=Vn.MARQUEE_SELECT,e.mode=Ae.SELECTING,e.marqueeRect.active=!0,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY);e.dragAction&&e.dragAction.type===Vn.MARQUEE_SELECT&&(e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY,Xf(e,t,s))}}function ic(e,t,n,s){if(s.button===0){if(e.dragAction&&e.dragAction.button===0)if(e.dragAction.hasMoved)e.mode=Ae.IDLE;else{const i=e.dragAction.draggedEntityType;if(i){const o=i===ue.VERTEX||i===ue.EDGE||i===ue.FACE||i===ue.TEXT,a=i===ue.TRANSFORMATION_OBJECT;e.clickCount===1&&e.dragAction.wasAlreadySelected&&!s.shiftKey&&!s.ctrlKey&&(o?(e.clearGeometricSelection(),Qn(e,i,[e.dragAction.draggedEntityId])):a&&(e.clearTransformationObjectSelection(),Qn(e,i,[e.dragAction.draggedEntityId]),e.activeTransformationObjectId=e.dragAction.draggedEntityId))}else!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==Ae.DRAWING&&(e.mode=Ae.DRAWING)}else e.dragAction||e.hoverTarget.type===ue.CANVAS&&(!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==Ae.DRAWING&&(e.mode=Ae.DRAWING));e.clickCount>0&&(!e.dragAction||!e.dragAction.hasMoved)||(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction=null}}function Wf(e,t,n,s){e.mode===Ae.TYPING&&(n.stopTyping(e),e.mode=Ae.IDLE),e.clickCount=0,e.selectionBeforeClick=null,(e.mode===Ae.IDLE||e.mode===Ae.DRAWING)&&(e.dragAction={hasMoved:!1,button:2,originalMode:e.mode,originalSelection:Ri(e.selection)},e.marqueeRect.startX=s.clientX,e.marqueeRect.startY=s.clientY,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY)}function Ga(e,t,n,s){e.dragAction&&e.dragAction.button===2?e.dragAction.hasMoved?e.mode=e.dragAction.originalMode:(!s.shiftKey&&!s.ctrlKey&&(e.clearSelection(),e.activeTransformationObjectId=null),e.mode=Ae.IDLE):e.dragAction||(e.mode=Ae.IDLE),e.dragAction=null,e.marqueeRect.active=!1}function Kf(e,t,n,s){if(e.mode===Ae.TYPING){n.stopTyping(e),e.mode=Ae.IDLE;return}const i=s.event;i.touches.length===1?(e.lastMouseX=i.touches[0].clientX,e.lastMouseY=i.touches[0].clientY,clearTimeout(e.touchTimerId),e.initialTouchData={clientX:i.touches[0].clientX,clientY:i.touches[0].clientY,targetType:s.type,targetId:s.id},e.touchTimerId=setTimeout(()=>{e.touchTimerId=null;const o=e.initialTouchData.targetType,a=e.initialTouchData.targetId;o===ue.CANVAS?e.dragAction={hasMoved:!1,button:0}:sc(e,t,n,{type:o,id:a,button:0}),e.hoverTarget={type:ue.CANVAS,id:null}},Vf),s.type!==ue.CANVAS&&tc(e,t,n,{type:s.type,id:s.id})):i.touches.length===2&&(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,e.dragAction={hasMoved:!1,button:0,type:Vn.PANNING,startDistance:Math.hypot(i.touches[0].clientX-i.touches[1].clientX,i.touches[0].clientY-i.touches[1].clientY),startCenter:{x:(i.touches[0].clientX+i.touches[1].clientX)/2,y:(i.touches[0].clientY+i.touches[1].clientY)/2},originalMode:e.mode},e.mode=Ae.DRAGGING,e.clearGeometricSelection())}function qf(e,t,n,s){const i=s.touches;if(i.length===1){const o=i[0].clientX,a=i[0].clientY;if(e.lastMouseX=o,e.lastMouseY=a,e.touchTimerId&&(clearTimeout(e.touchTimerId),e.touchTimerId=null),e.dragAction&&e.dragAction.button===0){oc(e,t,n,{clientX:o,clientY:a,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl});return}}else if(i.length===2&&e.dragAction&&e.dragAction.type===Vn.PANNING){e.dragAction.hasMoved=!0;const o=Math.hypot(i[0].clientX-i[1].clientX,i[0].clientY-i[1].clientY),a={x:(i[0].clientX+i[1].clientX)/2,y:(i[0].clientY+i[1].clientY)/2},r=o/e.dragAction.startDistance,c=Math.log(r)*100;a.x-e.dragAction.startCenter.x,a.y-e.dragAction.startCenter.y,c!==0&&ec(e,t,n,{deltaY:-c}),e.lastMouseX=a.x,e.lastMouseY=a.y}}function jf(e,t,n,s){e.touchTimerId?(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,Ga(e,t,n,{shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}),e.mode===Ae.IDLE&&!e.modifiers.shift&&!e.modifiers.ctrl&&e.clearSelection()):e.dragAction&&e.dragAction.button===0?ic(e,t,n,{button:0,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}):e.hoverTarget={type:ue.CANVAS,id:null},e.dragAction&&e.dragAction.button===2&&Ga(e,t,n,{}),e.dragAction=null,e.marqueeRect.active=!1,nc(e,t,n,{id:e.hoverTarget.id})}const Uf={keyDown:Yf,keyUp:Gf,wheel:ec,hoverStart:tc,hoverEnd:nc,appModeChange:zf,mouseDown:Hf,entityMouseDown:sc,mouseMove:oc,mouseUp:ic,rightMouseDown:Wf,rightMouseUp:Ga,touchStart:Kf,touchMove:qf,touchEnd:jf};function Jf(e,t,n,s,i){const o=Uf[s];o&&o(e,t,n,i)}const ve=document.getElementById("drawingCanvas"),ke=ve.getContext("2d",{willReadFrequently:!0}),gt=document.getElementById("html-overlay"),Ye=window.devicePixelRatio||1,Vo=new Map,br=ns,li=8,Ca={x:12,y:-12},Zf={x:8,y:-8};let Pt={activeId:null,inputEl:null};const En={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0,radiusMode:"relative",radiusValue:.25},vr="platonic-play",Li=1,wa=`${vr}.user-id`;let Sn=null,ci=null,ac=!1,ts,Js,yn=[JSON.parse(JSON.stringify(En))],Os=En.id;const H={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,colorModeToolButton:null,colorModeIcons:[],colorModeExprFields:[],colorModePanelBounds:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[],sessionsToolButton:null,sessionIcons:[],addSessionButton:null,removeSessionButton:null,sessionsPanelBounds:null};let bt,Zs=null,Qs=null,Wt=null,za=[],Oi=null,ms=new Map,_n=null,Xn=null,co=null,qo=null,Ns=null,Bn=null,to=!1,Xt=null,Le=[],Kt=null,xs=null,It=null,qn=null,Xo=!1,jo=null,bn=!1,ia=!1,dn=!1,vt=!1,hn=!1,Fs="regular",yt="lines",Qt="degrees",ui="on",Ni=!0,Fi=!0,jn=!0,mn=null,zt=null,Ft=null,Bi=null,$i=!1,_s=!1,pe=[],K=[],se=[],We=[],Bs=new Map,At=new Map,be=[],Se=[],ge=[],Pe=[],rt=null,j={x:0,y:0},Ss=null,is=!1,ft=!1,Vi=!1,Do=null,Dn=!1,sn=!1,ho=null,ht=[],ln=0,es=!0,On=!0,ct=null,gi=4,Es=3,Qf=.5,tt=null,qt=!1,Ve=!1,Wn=!1,Tn=!1,en=-1,cn={x:0,y:0},Pa={x:0,y:0},xe=[],Xi={x:0,y:0},ce=null,Me=Zi,st=!1,mt=null,Yi=null,we=[],eo=[],Ha=[],Re=!1,Yt={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},Ie={targetId:null,type:null,count:0,timestamp:0},di={id:null,timestamp:0},Mt=[],Ne=[],nn=0,kt=0,ko=null,Gi=[],Tt="colormap",_t="colormap_xy",ls="x",cs="x",ds="r",Qe=null,et=null,pi=null,yi=null,Yn=null,Gn=null,Et=!1,bo=!1,An=null,mi=!1,Ot=null;function eu(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,s=Array.prototype.splice;Mt.pop=function(){return e.call(this)},Mt.push=function(...i){return t.call(this,...i)},Mt.shift=function(){return n.call(this)},Mt.splice=function(...i){return s.call(this,...i)}}let Wa=!1,hs=[],ze=null,Fe=[],jt="",tn=null,$s=[],xi=0,Z={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},he={scale:kd,offsetX:0,offsetY:0},Cn={angle1:30,angle2:15,alpha1:1,alpha2:0},Mr=new Set,Yo="dark",je=[],fs=!1,St=null,Ro=!1,Si=null,_e={[Ue]:0,[Je]:1,[at]:2,[Gt]:0},Un=!1,wn=null,zi=null,no=new Set;const Ee=new Bf,rc={getEntitiesInRect:e=>{const t=[],n=s=>s.x>=e.minX&&s.x<=e.maxX&&s.y>=e.minY&&s.y<=e.maxY;return pe.forEach(s=>{const i=Ce(s);n(i)&&t.push({type:s.type==="regular"?ue.VERTEX:ue.TRANSFORMATION_OBJECT,id:s.id})}),K.forEach(s=>{const i=q(s.id1),o=q(s.id2);if(!i||!o)return;const a=Ce({x:(i.x+o.x)/2,y:(i.y+o.y)/2});n(a)&&t.push({type:ue.EDGE,id:re(s)})}),se.forEach(s=>{const i=s.vertexIds.map(r=>q(r)).filter(Boolean);if(i.length<3)return;const o=i.reduce((r,c)=>({x:r.x+c.x,y:r.y+c.y}),{x:0,y:0}),a=Ce({x:o.x/i.length,y:o.y/i.length});n(a)&&t.push({type:ue.FACE,id:fe(s)})}),We.forEach(s=>{const i=s.screenBounds;if(!i)return;const o={x:(i.left+i.right)/2,y:(i.top+i.bottom)/2};n(o)&&t.push({type:ue.TEXT,id:s.id})}),t},getNeighbors:e=>{if(q(e))return In(e,K);const n=K.find(o=>re(o)===e);if(n)return[n.id1,n.id2];const s=se.find(o=>fe(o)===e);if(s)return[...s.vertexIds];const i=We.find(o=>o.id===e);return i&&i.anchorId?[i.anchorId]:[]},getAllConnected:e=>{const t=rc.getEntityType(e);if(t===ue.VERTEX||t===ue.TRANSFORMATION_OBJECT)return Xs(e);if(t===ue.EDGE){const n=K.find(i=>re(i)===e);if(!n)return[];const s=new Set(Xs(n.id1));return K.filter(i=>s.has(i.id1)&&s.has(i.id2)).map(i=>re(i))}if(t===ue.FACE){const n=se.find(o=>fe(o)===e);if(!n)return[];const s=new Set([fe(n)]),i=[n];for(;i.length>0;){const o=i.shift();se.forEach(a=>{const r=fe(a);s.has(r)||a.vertexIds.some(c=>o.vertexIds.includes(c))&&(s.add(r),i.push(a))})}return Array.from(s)}return[e]},getEntityType:e=>{const t=q(e);return t?t.type==="regular"?ue.VERTEX:ue.TRANSFORMATION_OBJECT:K.some(n=>re(n)===e)?ue.EDGE:se.some(n=>fe(n)===e)?ue.FACE:We.some(n=>n.id===e)?ue.TEXT:null},getDragType:e=>e.selection.vertices.size>0||e.selection.edges.size>0||e.selection.faces.size>0||e.selection.text.size>0||e.selection.transformationObjects.size>0?Vn.RIGID_DRAG:null},tu={startTyping:()=>{Pt.activeId||Ua("")},updateText:(e,t)=>{if(!Pt.activeId){Ua(t);return}const n=Pt.inputEl;if(n)n.value+=t;else{const s=go(Pt.activeId);s&&(s.content=`${s.content||""}${t}`)}e.textInput.value=Pt.inputEl?Pt.inputEl.value:""},backspace:e=>{const t=Pt.inputEl;t&&(t.value=t.value.slice(0,-1),e.textInput.value=t.value)},stopTyping:()=>{To(!0)}};function gn(e,t){Jf(Ee,rc,tu,e,t)}function Bt(){Pt.activeId?Ee.mode=Ae.TYPING:Tn?Ee.mode=Ae.SELECTING:Ve||Wn||_s||Un?Ee.mode=Ae.DRAGGING:st?Ee.mode=Ae.DRAWING:Ee.mode=Ae.IDLE,Ee.modifiers.shift=Re,Ee.modifiers.ctrl=bo,Ee.modifiers.alt=Et,Ee.selection.vertices=new Set(be),Ee.selection.edges=new Set(Se),Ee.selection.faces=new Set(ge),Ee.selection.text=new Set(Pe),Ee.selection.transformationObjects=new Set(Fe),Ee.activeTransformationObjectId=rt,Bi?Ee.hoverTarget={type:ue.TEXT,id:Bi}:mn?Ee.hoverTarget={type:ue.VERTEX,id:mn}:zt?Ee.hoverTarget={type:ue.EDGE,id:zt}:Ft?Ee.hoverTarget={type:ue.FACE,id:Ft}:Ee.hoverTarget={type:ue.CANVAS,id:null},Ee.marqueeRect={active:Tn,startX:Xi.x,startY:Xi.y,endX:j.x,endY:j.y},Ee.zoomLevel=he.scale,Ee.lastMouseX=j.x,Ee.lastMouseY=j.y;const e=Pt.inputEl;Ee.textInput.active=!!Pt.activeId,Ee.textInput.x=j.x,Ee.textInput.y=j.y,Ee.textInput.value=e?e.value:"",qt?Ee.dragAction={hasMoved:Ve,button:en,type:Tn?Vn.MARQUEE_SELECT:Wn?Vn.PANNING:null}:Ee.dragAction=null}function Tl(e,t){e&&(e.classList.toggle("active",t),e.setAttribute("aria-pressed",t?"true":"false"))}function nu(e,t){const n={key:e,shiftKey:e==="Shift",ctrlKey:e==="Control",metaKey:!1,altKey:e==="Alt",repeat:!1,target:document.body,preventDefault:()=>{},stopPropagation:()=>{}};t?Bc(n):$c(n)}function su(){const e=document.getElementById("mobile-controls");if(!e)return;const t=e.querySelector('[data-mod="hover"]'),n=e.querySelector('[data-mod="shift"]'),s=e.querySelector('[data-mod="ctrl"]'),i=e.querySelector('[data-mod="alt"]'),o=()=>{mi=!mi,Tl(t,mi),Bt()},a=(r,c,l)=>{const d=!l;Tl(r,d),nu(c,d)};t&&t.addEventListener("click",o),n&&n.addEventListener("click",()=>a(n,"Shift",Re)),s&&s.addEventListener("click",()=>a(s,"Control",bo)),i&&i.addEventListener("click",()=>a(i,"Alt",Et))}function ou(e){return Bl(e,H,{isToolbarExpanded:is,isColorPaletteExpanded:ft,isColorModePanelExpanded:hn,isInterpolationPanelExpanded:dn,isTransformPanelExpanded:Dn,isDisplayPanelExpanded:bn,isVisibilityPanelExpanded:ia,isSessionsPanelExpanded:vt})}function vs(){Dh(se,q)}function aa(){return Ph(Yo,ad)}function Ge(e,t=0,n=1){let s=_e[e];(s<0||s>=Me.length)&&(s=0);const i=Me[s];if(i?.type==="color")return i.value;if(i?.type==="colormap"){const a=n>1?t/(n-1):.5;return Be(i,a)}const o=aa();return e===Ue?o.vertex:e===Je?o.edge:e===at?o.face:e===Gt?o.uiTextDefault||o.geometryInfoText:o.vertex}function Hi(e){return[]}function fo(){const e=new Set(Se);return Array.from(Ee.selection.edges||[]).forEach(n=>e.add(n)),Array.from(e)}function uo(){const e=new Set(ge);return Array.from(Ee.selection.faces||[]).forEach(n=>e.add(n)),Array.from(e)}function so(){const e=fo();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=K.find(i=>re(i)===n);s&&t.add(Er(s))}),Array.from(t)}function oo(){const e=uo();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=se.find(i=>fe(i)===n);s&&t.add(Tr(s))}),Array.from(t)}function lc(){const e=fo();if(e.length>0){const n=zt?K.find(s=>re(s)===zt):null;if(n&&e.includes(re(n))){const s=Er(n);so().includes(s)&&(Yn=s)}so().includes(Yn)||(Yn=so()[0]||Yn)}const t=uo();if(t.length>0){const n=Ft?se.find(s=>fe(s)===Ft):null;if(n&&t.includes(fe(n))){const s=Tr(n);oo().includes(s)&&(Gn=s)}oo().includes(Gn)||(Gn=oo()[0]||Gn)}}function Er(e){return e?.colorMode||Tt}function Tr(e){return e?.colorMode||_t}function iu(e){return e?e.type==="color"?!0:e.type==="colormap"?Array.isArray(e.vertices)&&e.vertices.length===1:!1:!1}function cc(e){if(!e)return null;if(e.type==="colormap")return e;if(e.type==="color"){const t=ys(e.value);return{type:"colormap",vertices:[{pos:0,color:t?[Math.round(t.r),Math.round(t.g),Math.round(t.b)]:[255,255,255],alpha:1}],isCyclic:!1}}return null}function Jn(e,t){if(e.colorMode=t,t==="colormap"){const n=Me[_e[Je]],s=cc(n);if(s){e.colormapItem=e.colormapItem||s,e.gradientStart=e.gradientStart??0,e.gradientEnd=e.gradientEnd??1,delete e.color;return}e.color=Ge(Je),delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd;return}delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd}function Uo(e,t){if(e.colorMode=t,t==="colormap_xy"){const n=Me[_e[at]],s=cc(n);if(s){e.colormapItem=e.colormapItem||s,e.colormapDistribution=e.colormapDistribution||"x",delete e.color;return}e.color=Ge(at),delete e.colormapItem,delete e.colormapDistribution;return}delete e.colormapItem,delete e.colormapDistribution}function au(e,t=null){(t||fo()).forEach(s=>{const i=K.find(o=>re(o)===s);i&&Jn(i,e)})}function ru(e,t=null){(t||uo()).forEach(s=>{const i=se.find(o=>fe(o)===s);i&&Uo(i,e)})}function Ka(){K.forEach(e=>{const t=e.colorMode||Tt;Jn(e,t)}),se.forEach(e=>{const t=e.colorMode||_t;Uo(e,t)})}function Cr(){je.forEach(e=>{const t=_e[e];if(e===Ue){const n=Me[t];if(n&&n.type==="colormap"){const s=be.map(i=>q(i)).filter(i=>i&&i.type==="regular");s.forEach((i,o)=>{const a=s.length>1?o/(s.length-1):.5;i.color=Be(n,a)})}else be.forEach(s=>{const i=q(s);i&&i.type==="regular"&&(i.color=Ge(Ue))})}else if(e===Je){const n=Me[t];Se.forEach((s,i)=>{const o=K.find(c=>re(c)===s);if(!o)return;const a=Er(o);if(a==="inherit_vertices")return;if(a==="colormap"&&n&&n.type==="colormap"){const c=Se.length,l=c>1?i/c:0,d=c>1?(i+1)/c:1;o.gradientStart=l,o.gradientEnd=d,o.colormapItem=n,delete o.color;return}const r=n&&n.type==="colormap"?Be(n,.5):Ge(Je);o.color=r,delete o.gradientStart,delete o.gradientEnd,delete o.colormapItem})}else if(e===at){const n=_e[e],s=Me[n];ge.forEach(i=>{const o=se.find(c=>fe(c)===i);if(!o)return;const a=Tr(o);if(a==="inherit_vertices"||a==="inherit_edges")return;if(a==="colormap_xy"&&s&&s.type==="colormap"){o.colormapItem=s,o.colormapDistribution="x",delete o.color;return}const r=s&&s.type==="colormap"?Be(s,.5):Ge(at);o.color=r,delete o.colormapItem,delete o.colormapDistribution})}else if(e===Gt){const n=Me[t];if(n&&n.type==="colormap")Pe.forEach((s,i)=>{const o=go(s);if(!o)return;const a=Pe.length>1?i/(Pe.length-1):.5;o.color=Be(n,a)});else{const s=Ge(Gt);Pe.forEach(i=>{const o=go(i);o&&(o.color=s)})}}})}function Lt({id:e,content:t,x:n,y:s,color:i,fontSize:o,options:a={}}){Mr.add(e);let r=Vo.get(e);if(r){if(!r.contentEl||!r.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.textContent="",r.appendChild(u),r.contentEl=u,r.katexEl=p,r.katexContent=null,r.style.pointerEvents="none"}}else{r=document.createElement("div"),r.style.position="absolute",r.style.fontFamily="KaTeX_Main, Times New Roman, serif",r.style.whiteSpace="nowrap",r.style.lineHeight="1",r.style.display="inline-block",r.style.padding="0",r.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.appendChild(u),r.contentEl=u,r.katexEl=p,gt.appendChild(r),Vo.set(e,r)}let c="-50%",l="-50%",d="center";switch(a.textAlign){case"left":c="0%";break;case"right":c="-100%";break}switch(a.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}a.textAlign==="left"&&a.textBaseline==="top"?d="top left":a.textAlign==="right"&&a.textBaseline==="top"?d="top right":a.textAlign==="left"&&a.textBaseline==="bottom"?d="bottom left":a.textAlign==="right"&&a.textBaseline==="bottom"&&(d="bottom right"),r.style.left=`${n}px`,r.style.top=`${s}px`,r.style.transformOrigin=d,r.style.transform=`translate(${c}, ${l}) rotate(${a.rotation||0}deg)`,r.style.display="inline-block",r.style.background="transparent",r.style.border="none",r.style.borderRadius="0",r.style.padding="0",r.style.minHeight="0",r.style.alignItems="",r.style.justifyContent="",r.style.color=i,r.style.fontSize=`${o}px`;const f=t==null?"":String(t),h=id(f);if(r.katexContent!==h){const u=r.katexEl||r.contentEl||r;od(u,h),r.katexContent=h}}function Cl(e,{placeholder:t,onChange:n}){if(e)return e;const s=document.createElement("div");s.style.position="absolute",s.style.display="none",s.style.boxSizing="border-box",s.style.pointerEvents="auto",s.style.fontFamily='Consolas, Monaco, "Courier New", monospace',s.style.fontSize=`${Jr}px`,s.style.padding=`${Vd}px ${Fa}px`,s.style.borderRadius=`${$d}px`,s.style.border=`${Na}px solid rgba(0,0,0,0.3)`,s.style.background="transparent",s.style.alignItems="center",s.style.gap="4px";const i=document.createElement("div");i.style.display="inline-flex",i.style.alignItems="center",i.style.whiteSpace="nowrap",i.style.lineHeight="1",i.style.pointerEvents="none";const o=document.createElement("input");return o.type="text",o.placeholder=t,o.style.flex="1",o.style.minWidth="0",o.style.border="none",o.style.outline="none",o.style.background="transparent",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize=`${Jr}px`,o.style.color="#111111",o.style.height="100%",o.style.lineHeight="1",o.style.pointerEvents="auto",o.addEventListener("input",()=>{n&&n(o.value)}),s.appendChild(i),s.appendChild(o),gt.appendChild(s),{container:s,label:i,input:o,labelText:""}}function lu(e){const t=e.match(/[A-Za-z_][A-Za-z0-9_]*/g);return t||[]}function wl(e,t){const n=(e||"").trim();return n?lu(n).every(i=>t.includes(i)):!0}function cu(){const e=so(),t=oo(),n=e.length>0?e.includes(Yn)?Yn:e[0]:Tt,s=t.length>0?t.includes(Gn)?Gn:t[0]:_t,i=()=>{const h=fo();if(h.length===0)return null;if(zt){const p=K.find(g=>re(g)===zt);if(p&&h.includes(re(p)))return p}return K.find(p=>re(p)===h[0])||null},o=()=>{const h=uo();if(h.length===0)return null;if(Ft){const p=se.find(g=>fe(g)===Ft);if(p&&h.includes(fe(p)))return p}return se.find(p=>fe(p)===h[0])||null},a=h=>{const u=_e[h],p=u>=0?Me[u]:null;return iu(p)?"1":"x"},r=(h,u)=>{h.labelText!==u&&(h.label.textContent=u,h.labelText=u)};n!=="colormap"&&(pi=null),s!=="colormap_xy"&&(yi=null),Qe=Cl(Qe,{placeholder:"x",onChange:h=>{const u=h.trim();if(!wl(u,["x"])){Qe.input.value=ls||"x";return}const p=fo();p.length>0?p.forEach(g=>{const y=K.find(m=>re(m)===g);y&&(y.colorExpression=u||a(Je))}):ls=u||a(Je),Zt()}}),et=Cl(et,{placeholder:"x",onChange:h=>{const u=h.trim();if(!wl(u,["x","y","r","a"])){et.input.value=cs||ds||"x";return}const g=uo();g.length>0?g.forEach(y=>{const m=se.find(x=>fe(x)===y);m&&(m.colorExpression=u||a(at))}):cs=u||a(at),Zt()}});const c=Yo==="light",l=c?"#000000":"#ffffff",d=c?"#000000":"#ffffff",f=aa().background;if(Qe.container.style.display="none",et.container.style.display="none",!(!hn||!H.colorModeIcons.length)){if(n==="colormap"){const h=H.colorModeExprFields.find(u=>u.group==="edge");if(h){if(r(Qe,"c(x)="),document.activeElement!==Qe.input){const T=i()?.colorExpression||ls||a(Je);Qe.input.value=T}const p=2;Qe.container.style.left=`${h.x-p}px`,Qe.container.style.top=`${h.y-p}px`,Qe.container.style.width=`${h.width+p*2}px`,Qe.container.style.height=`${h.height+p*2}px`,Qe.container.style.padding=`0 ${Fa}px`,Qe.container.style.border=`${Na}px solid ${d}`,Qe.container.style.background=f,Qe.container.style.color=l;const g=Math.max(10,Math.floor(h.height*.64));Qe.container.style.fontSize=`${g}px`,Qe.input.style.fontSize=`${g}px`,Qe.input.style.color=l,Qe.input.style.minWidth="3ch",Qe.input.style.height=`${h.height+p*2}px`,Qe.input.style.lineHeight=`${h.height+p*2}px`,Qe.container.style.display="flex";const y=h.baseWidth||h.width,m=h.expandedWidth||h.width,x=Qe.label.getBoundingClientRect().width,S=Qe.input.scrollWidth,b=x+S+8>y?m:y;if(pi!==b){pi=b,Wi();return}}}if(s==="colormap_xy"){const h=H.colorModeExprFields.find(u=>u.group==="face");if(h){if(r(et,"c(x,y,r,a) ="),document.activeElement!==et.input){const T=o()?.colorExpression||cs||ds||a(at);et.input.value=T}const p=2;et.container.style.left=`${h.x-p}px`,et.container.style.top=`${h.y-p}px`,et.container.style.width=`${h.width+p*2}px`,et.container.style.height=`${h.height+p*2}px`,et.container.style.padding=`0 ${Fa}px`,et.container.style.border=`${Na}px solid ${d}`,et.container.style.background=f,et.container.style.color=l;const g=Math.max(10,Math.floor(h.height*.64));et.container.style.fontSize=`${g}px`,et.input.style.fontSize=`${g}px`,et.input.style.color=l,et.input.style.minWidth="9ch",et.input.style.height=`${h.height+p*2}px`,et.input.style.lineHeight=`${h.height+p*2}px`,et.container.style.display="flex";const y=h.baseWidth||h.width,m=h.expandedWidth||h.width,x=et.label.getBoundingClientRect().width,S=et.input.scrollWidth,b=x+S+8>y?m:y;if(yi!==b){yi=b,Wi();return}}}}}function du(e,t,n){const s=ys(e),i=ys(t),o=Math.max(0,Math.min(1,n)),a=Math.round(s.r*(1-o)+i.r*o),r=Math.round(s.g*(1-o)+i.g*o),c=Math.round(s.b*(1-o)+i.b*o),l=s.a;return`rgba(${a}, ${r}, ${c}, ${l})`}function hu(){for(const[e,t]of Vo.entries())Mr.has(e)||(t.remove(),Vo.delete(e))}function io(e){return{x:e.x*Ye/he.scale,y:-e.y*Ye/he.scale}}function go(e){return We.find(t=>t.id===e)}function wr(e,t,n,s=null){if(!e||!t||!n)return null;const i={x:n.x-t.x,y:n.y-t.y},o=Math.hypot(i.x,i.y);if(o<1e-6)return null;let a={x:-i.y/o,y:i.x/o};if(s&&s.length>=3){const r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},c=s.reduce((f,h)=>({x:f.x+h.x,y:f.y+h.y}),{x:0,y:0});c.x/=s.length,c.y/=s.length;const l={x:c.x-r.x,y:c.y-r.y};a.x*l.x+a.y*l.y>0&&(a={x:-a.x,y:-a.y})}return{normalData:a,edgeLen:o}}function dc(e){const t=K.find(l=>re(l)===e);if(!t)return io(li);const n=q(t.id1),s=q(t.id2);if(!n||!s)return io(li);const i=se.filter(l=>{const d=l.vertexIds||[];for(let f=0;f<d.length;f++){const h=d[f],u=d[(f+1)%d.length];if(h===t.id1&&u===t.id2||h===t.id2&&u===t.id1)return!0}return!1});let o=null;i.length===1&&(o=(i[0].vertexIds||[]).map(d=>q(d)).filter(Boolean));const a=wr(t,n,s,o);if(!a)return io(li);const r=a.normalData,c=li*Ye/he.scale;return{x:r.x*c,y:r.y*c}}function qa(e,t){const n=K.find(l=>re(l)===e);if(!n||!t)return null;const s=q(n.id1),i=q(n.id2);if(!s||!i)return null;const o=wr(n,s,i);if(!o)return null;const{normalData:a,edgeLen:r}=o;return r<1e-6?null:(t.x*a.x+t.y*a.y)/r}function ja(e){const t=q(e);if(!t)return{offset:io(Ca),align:"left",baseline:"middle"};const s=In(e,K).map(h=>q(h)).filter(Boolean);let i={x:1,y:0};if(s.length===2){const h={x:s[0].x-t.x,y:s[0].y-t.y},u={x:s[1].x-t.x,y:s[1].y-t.y},p=Math.hypot(h.x,h.y),g=Math.hypot(u.x,u.y);if(p>1e-6&&g>1e-6){const y={x:h.x/p,y:h.y/p},m={x:u.x/g,y:u.y/g},x={x:y.x+m.x,y:y.y+m.y},S=Math.hypot(x.x,x.y);S>1e-6?i={x:-x.x/S,y:-x.y/S}:i={x:-y.y,y:y.x}}}const o=Ce(t),a=Ce({x:t.x+i.x,y:t.y+i.y});let r={x:a.x-o.x,y:a.y-o.y};const c=Math.hypot(r.x,r.y);c>1e-6?(r.x/=c,r.y/=c):r={x:1,y:0};const l=Math.hypot(Ca.x,Ca.y),d={x:r.x*l,y:r.y*l},f=r.x>=0?"left":"right";return{offset:io(d),align:f,baseline:"middle"}}function Go(e){return yn.find(t=>t.id===e)||null}function zo(){return Go(Os)||yn[0]||En}function Ii(e){e&&(Os=e,Zt())}function hc(){const e=new Set(Se),t=new Set(ge),n=new Set(be),s=new Set,i=o=>{const a=o||En.id;s.add(a)};return e.size>0&&K.forEach(o=>{const a=re(o);e.has(a)&&i(o.interpolationStyleId)}),t.size>0&&se.forEach(o=>{const a=fe(o);a&&t.has(a)&&i(o.interpolationStyleId)}),e.size===0&&t.size===0&&n.size>0&&(K.forEach(o=>{(n.has(o.id1)||n.has(o.id2))&&i(o.interpolationStyleId)}),se.forEach(o=>{o.vertexIds&&o.vertexIds.some(a=>n.has(a))&&i(o.interpolationStyleId)})),s.size===1?[...s][0]:null}function fu(e){if(!e)return;const t=new Set(Se),n=new Set(ge),s=new Set(be);let i=!1;t.size>0&&K.forEach(o=>{const a=re(o);t.has(a)&&(o.interpolationStyleId=e,i=!0)}),n.size>0&&se.forEach(o=>{const a=fe(o);a&&n.has(a)&&(o.interpolationStyleId=e,i=!0)}),t.size===0&&n.size===0&&s.size>0&&(K.forEach(o=>{(s.has(o.id1)||s.has(o.id2))&&(o.interpolationStyleId=e,i=!0)}),se.forEach(o=>{o.vertexIds&&o.vertexIds.some(a=>s.has(a))&&(o.interpolationStyleId=e,i=!0)})),i&&Zt()}function uu(){const e=new Set(Se),t=new Set(ge),n=new Set(be);let s=!1;e.size>0&&K.forEach(i=>{const o=re(i);e.has(o)&&(delete i.interpolationStyleId,s=!0)}),t.size>0&&se.forEach(i=>{const o=fe(i);o&&t.has(o)&&(delete i.interpolationStyleId,s=!0)}),e.size===0&&t.size===0&&n.size>0&&(K.forEach(i=>{(n.has(i.id1)||n.has(i.id2))&&(delete i.interpolationStyleId,s=!0)}),se.forEach(i=>{i.vertexIds&&i.vertexIds.some(o=>n.has(o))&&(delete i.interpolationStyleId,s=!0)})),s&&Zt()}function Vs(e){const t=zo();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function gu(e){const t=zo();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function fc(e){if(!e)return null;const t=new Map;Ve&&Array.isArray(we)&&we.length>0&&we.forEach(s=>{if(!s||!s.id)return;const i=s.originalId||s.id;t.set(i,s)});const n=s=>t.has(s)?t.get(s):q(s);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const s=n(e.anchorId);return s?{anchor:{x:s.x,y:s.y}}:null}if(e.anchorType==="edge"){const s=K.find(g=>re(g)===e.anchorId);if(!s)return null;const i=n(s.id1),o=n(s.id2);if(!i||!o)return null;const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2},r=Math.atan2(o.y-i.y,o.x-i.x),c=Ce(i),l=Ce(o),d=Math.atan2(l.y-c.y,l.x-c.x),f=se.filter(g=>{const y=g.vertexIds||[];for(let m=0;m<y.length;m++){const x=y[m],S=y[(m+1)%y.length];if(x===s.id1&&S===s.id2||x===s.id2&&S===s.id1)return!0}return!1});let h=null;f.length===1&&(h=(f[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=wr(s,i,o,h),p=u?u.normalData:null;return{anchor:a,edgeAngleRad:r,edgeAngleRadScreen:d,edgeNormalData:p,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const s=se.find(a=>fe(a)===e.anchorId);if(!s)return null;const i=s.vertexIds.map(a=>n(a)).filter(a=>a&&a.type==="regular");return i.length<3?null:{anchor:{x:i.reduce((a,r)=>a+r.x,0)/i.length,y:i.reduce((a,r)=>a+r.y,0)/i.length}}}return null}function uc(){return ce?.finalSnapResult?.finalDelta?ce.finalSnapResult.finalDelta:ce?.textFinalDelta?ce.textFinalDelta:we.length>0&&xe.length>0?{x:we[0].x-xe[0].x,y:we[0].y-xe[0].y}:null}function gc(e){const t=fc(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=dc(e.anchorId);const l=qa(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let s={x:t.anchor.x+n.x,y:t.anchor.y+n.y},i=e.rotationDeg||0,o=e.scale||1,a="center",r="middle";if(e.anchorType==="vertex"){const l=ja(e.anchorId);a=e.vertexAlign||l.align||"left",r=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(a="center",r="middle",typeof t.edgeAngleRadScreen=="number"?i+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(i+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(a="left",r="top");e.anchorType==="edge"&&(i>90||i<-90)&&(i+=180,i>180&&(i-=360),r="top");const c=Pe.includes(e.id);if(Ve&&c)if(tt){const{center:l,rotation:d,scale:f,directionalScale:h,startVector:u}=tt;s=nt(s,l,d,f,h,u),i-=d*(180/Math.PI),o*=f}else{const l=uc();l&&(s={x:s.x+l.x,y:s.y+l.y})}return{id:e.id,content:e.content||"",position:s,rotationDeg:i,scale:o,textAlign:a,textBaseline:r}}function pu(e){const t=gt.getBoundingClientRect(),n=[];We.forEach(s=>{const i=gc(s);if(!i){n.push(s.id);return}const o=Ce(i.position),a=`text-${i.id}`,r=Pe.includes(s.id),c=s.color||Ge(Gt)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",d=du(c,l,.35);Lt({id:a,content:i.content,x:o.x,y:o.y,color:r?d:c,fontSize:(s.fontSize||br)*i.scale,options:{textAlign:i.textAlign,textBaseline:i.textBaseline,rotation:i.rotationDeg}});const f=Vo.get(a);if(f){const h=f.contentEl||f;h.style.outline="none",h.style.textShadow="none",h.style.color=r?d:c;const p=(f.katexEl||h).getBoundingClientRect();s.screenBounds={left:p.left-t.left,top:p.top-t.top,right:p.right-t.left,bottom:p.bottom-t.top}}}),n.length>0&&(We=We.filter(s=>!n.includes(s.id)),Pe=Pe.filter(s=>!n.includes(s)))}function pc(e){for(let t=We.length-1;t>=0;t--){const n=We[t],s=n.screenBounds;if(s&&e.x>=s.left&&e.x<=s.right&&e.y>=s.top&&e.y<=s.bottom)return n}return null}function yc(e,t=""){if(!Pt.inputEl){const o=document.createElement("input");o.type="text",o.style.position="absolute",o.style.zIndex="5",o.style.pointerEvents="auto",o.style.fontFamily="KaTeX_Main, Times New Roman, serif",o.style.fontSize=`${e.fontSize||br}px`,o.style.border="1px solid rgba(255, 255, 255, 0.4)",o.style.borderRadius="4px",o.style.padding="2px 4px",o.style.background="rgba(0, 0, 0, 0.6)",o.style.color="#ffffff",o.style.outline="none",o.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),To(!0)):a.key==="Escape"&&(a.preventDefault(),To(!1))}),o.addEventListener("mouseleave",()=>To(!0)),o.addEventListener("blur",()=>To(!0)),gt.appendChild(o),Pt.inputEl=o}const n=gc(e);if(!n)return;const s=Ce(n.position),i=Pt.inputEl;i.value=t||e.content||"",i.style.left=`${s.x}px`,i.style.top=`${s.y}px`,i.style.transform="translate(-10%, -10%)",i.style.display="block",Pt.activeId=e.id,i.focus(),i.setSelectionRange(i.value.length,i.value.length)}function To(e){const t=Pt.inputEl;if(!t)return;const n=Pt.activeId;if(n&&e){const s=go(n);if(s){Ze();const i=t.value.trim();!i&&s.isDraft?(We=We.filter(o=>o.id!==s.id),Pe=Pe.filter(o=>o!==s.id)):(s.content=i||s.content||"",delete s.isDraft)}}t.style.display="none",Pt.activeId=null}function Ua(e=""){let t="canvas",n=null,s={x:0,y:0},i=Oe(j);if(mn)t="vertex",n=mn,s=ja(n).offset;else if(zt)t="edge",n=zt,s=dc(n);else if(Ft)t="face",n=Ft;else{const a=io(Zf);i={x:i.x+a.x,y:i.y+a.y}}const o={id:Ut(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?i:null,offset:t==="canvas"?{x:0,y:0}:s,rotationDeg:0,scale:1,fontSize:br,color:Ge(Gt),isDraft:!0};if(t==="vertex"){const a=ja(n);o.vertexAlign=a.align,o.vertexBaseline=a.baseline}We.push(o),Pe=[o.id],yc(o,e)}function Pr(e,t,n){const s=new Set(Ee.selection.transformationObjects);let i=Ee.activeTransformationObjectId;if(n)if(s.has(e)){if(s.delete(e),i===e){const o=Array.from(s);i=o.length>0?o[o.length-1]:null}}else s.add(e),i=e;else s.has(e)||s.add(e),i=e;Ee.selection.transformationObjects=s,Ee.activeTransformationObjectId=i,Fe=Array.from(s),rt=i}function bi(e){const t=ps(e,yt,Z.interval1,Cn,!0);if(pe.forEach(s=>{s.type==="regular"&&t.push({x:s.x,y:s.y,isGridVertex:!1})}),K.forEach(s=>{const i=q(s.id1),o=q(s.id2);if(i&&o&&i.type==="regular"&&o.type==="regular"){const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2,isGridVertex:!1};t.push(a)}}),t.length===0)return null;const n=(s,i)=>(s.x-i.x)**2+(s.y-i.y)**2;return t.reduce((s,i)=>{const o=n(e,s);return n(e,i)<o?i:s})}function Jt(){const e=new Set(pe.map(a=>a.id)),t=new Set,n=[];for(const a of e)if(!t.has(a)){const r=Xs(a),c=new Set(r);n.push(c),r.forEach(l=>t.add(l))}const s=a=>[...a].sort().join(","),i=[],o=new Set;za.forEach(a=>{const r=s(a);for(let c=0;c<n.length;c++){if(o.has(c))continue;const l=n[c];if(r===s(l)){i.push(l),o.add(c);break}}});for(let a=0;a<n.length;a++)o.has(a)||i.push(n[a]);za=i}function yu(e,t,n=!1,s=[],i=1){if(n&&s.length>0&&[...e].some(l=>s.some(d=>d.id===l)))return;const o=se.filter(c=>c.vertexIds.every(l=>e.has(l)));Yh(ke,{allFaces:o,allEdges:K,facesVisible:jn,isDragConfirmed:!1,dragPreviewVertices:[],transformIndicatorData:null,initialDragVertexStates:[],colors:t,initialCoordSystemStates:new Map,interpolationStyle:zo(),getInterpolationStyleById:Go,faceColorMode:_t,edgeColorMode:Tt,faceColorExpression:cs,faceColorPolarExpression:ds,edgeColorExpression:ls,angleDisplayMode:Qt},Ce,q);const a=K.filter(c=>e.has(c.id1)&&e.has(c.id2));Qh(ke,{allEdges:a,selectedEdgeIds:Se,hoveredEdgeId:zt,isDragConfirmed:!1,dragPreviewVertices:[],colors:t,edgesVisible:Fi,snappedEdgeIds:Bs,currentAltPressed:Et,interpolationStyle:zo(),getInterpolationStyleById:Go,edgeColorMode:Tt,edgeColorExpression:ls},Ce,q,re),pe.filter(c=>e.has(c.id)).forEach(c=>{let l=!1;At.has(c.id)&&At.get(c.id).some(f=>f.copyIndex===void 0)&&(l=!0),Di(ke,c,{selectedVertexIds:be,selectedCenterIds:Fe,activeCenterId:rt,colors:t,verticesVisible:Ni,isHovered:mn===c.id,isSnapped:l,snappedVertexIds:At,isDragConfirmed:!1,dragPreviewVertices:[],currentAltPressed:Et},Ce)})}function Jo(e,t,n,s=!1,i=null){const o=Oe(t),a=i||Rr(e.id),r=tr/he.scale,c=sr/he.scale,l=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z?.interval1,d=Ke*2/he.scale,f=Ke/he.scale,h=Ke*2/he.scale,u=Ke*2/he.scale,p=st&&Le.length>=1;if(n){const g=[];let y=!1;for(const S of pe)if(S.id!==e.id&&S.type==="regular"&&ae(o,S)<r){y=!0;break}if(!y)for(const S of K){const I=q(S.id1),b=q(S.id2);if(I&&b&&I.type==="regular"&&b.type==="regular"&&Dt(o,I,b).distance<c){y=!0;break}}if(p){if(pe.forEach(v=>{if(v.id!==e.id&&v.type==="regular"){const w=ae(o,v);g.push({priority:1,dist:w,pos:v,snapType:"vertex",targetVertex:v})}}),K.forEach(v=>{const w=q(v.id1),_=q(v.id2);w&&_&&w.type==="regular"&&_.type==="regular"&&w.id!==e.id&&_.id!==e.id&&Dt(o,w,_).distance<f*1.5&&_l.forEach(D=>{const O={x:w.x+D*(_.x-w.x),y:w.y+D*(_.y-w.y)},F=ae(o,O);g.push({priority:2,dist:F,pos:O,snapType:"edge_fraction",targetEdge:v,fraction:D})})}),yt!=="none"&&l){const v=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;v&&ps(o,yt,v,Cn,!0).forEach(_=>{const C=ae(o,_);g.push({priority:3,dist:C,pos:_,snapType:"grid"})})}const S=a.currentSegmentReferenceA_for_display,I=a.currentSegmentReferenceD,b=new Set([0,...cr.flatMap(v=>[v,-v])]),T=Array.from(b).sort((v,w)=>v-w).map(v=>({factor:v,angle:$n(a.offsetAngleRad+v*S),turn:pt(v*S)})),M=ae(e,o),P=[];if([0,...as].forEach(v=>P.push({factor:v,dist:v*I})),I>ye){const v=M/I,w=Math.round(v),_=Math.round(v*2)/2;[w,_].forEach(C=>{C>=0&&!P.some(D=>Math.abs(D.factor-C)<ye)&&P.push({factor:C,dist:C*I})})}if(P.sort((v,w)=>v.dist-w.dist),T.length>0&&P.length>0)for(const v of T)for(const w of P){if(w.dist<ye&&(v.factor!==0||P.length>1))continue;const _={x:e.x+w.dist*Math.cos(v.angle),y:e.y+w.dist*Math.sin(v.angle)},C=ae(o,_);g.push({priority:4,dist:C,pos:_,snapType:"geometric",lengthSnapFactor:w.factor,angleSnapFactor:v.factor,angleTurn:v.turn})}}else if(!y&&yt!=="none"&&l){const S=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;if(S){const I=ps(o,yt,S,Cn,!0);if(I.length>0){const b=I.sort((E,T)=>ae(o,E)-ae(o,T))[0];g.push({priority:3,dist:ae(o,b),pos:b,snapType:"grid"})}}}let m=null;if(g.length>0)if(!p)m=g[0];else{let S=!1;for(let I=1;I<=3;I++){let b;I===1?b=d:I===2?b=f:b=h;const E=g.filter(T=>T.priority===I&&T.dist<b);if(E.length>0){m=E.sort((T,M)=>T.dist-M.dist)[0],S=!0;break}}if(!S){const I=g.filter(b=>b.priority===4);if(I.length>0){const b=I.sort((E,T)=>E.dist-T.dist)[0];b.dist<u&&(m=b)}}m||(m=g.sort((I,b)=>I.dist-b.dist)[0])}if(m){const S=Math.atan2(m.pos.y-e.y,m.pos.x-e.x)||0,I=parseFloat(ae(e,m.pos).toFixed(10));let b=null,E=null;if(m.snapType==="grid"&&l){const M=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z.interval1;if(M){const P=m.pos.x-e.x,A=m.pos.y-e.y,v=M*1e-5;if(yt==="triangular"){const w=M*nr,_=A/w,C=Math.round(_),D=C%2!==0?M/2:0,O=(P-D)/M;if(Math.abs(_-C)<v/w&&Math.abs(O-Math.round(O))<v/M){const F=C,V=Math.round(O);b=V*V+V*F+F*F,E=M}}else{const w=P/M,_=A/M;if(Math.abs(w-Math.round(w))<v/M&&Math.abs(_-Math.round(_))<v/M){const C=Math.round(w),D=Math.round(_);b=C*C+D*D,E=M}}}}let T=m.angleTurn!=null?m.angleTurn:pt(S-a.offsetAngleRad);return{x:parseFloat(m.pos.x.toFixed(Qr)),y:parseFloat(m.pos.y.toFixed(Qr)),angle:S*(180/Math.PI),distance:I,snapped:!0,snapType:m.snapType,targetEdge:m.targetEdge,fraction:m.fraction,targetVertex:m.targetVertex,gridSnapped:m.snapType==="grid",lengthSnapFactor:m.lengthSnapFactor||null,angleSnapFactor:m.angleSnapFactor||null,angleTurn:T,gridToGridSquaredSum:b,gridInterval:E}}const x=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:x*(180/Math.PI),distance:ae(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:pt(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const g=[];for(const x of pe)if(x.id!==e.id&&x.type==="regular"){const S=ae(o,x);S<r&&g.push({priority:1,dist:S,pos:x,snapType:"vertex",targetVertex:x})}for(const x of K){const S=q(x.id1),I=q(x.id2);if(S&&I&&S.type==="regular"&&I.type==="regular"){const b=Dt(o,S,I);b.distance<c&&b.onSegmentStrict&&g.push({priority:2,dist:b.distance,pos:{x:b.x,y:b.y},snapType:"edge",targetEdge:x})}}let y=null;if(g.length>0){y=g.sort((S,I)=>S.priority!==I.priority?S.priority-I.priority:S.dist-I.dist)[0];const x=y.priority===1?d:f;y.dist>x&&(y=null)}if(y){const x=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:x*(180/Math.PI),distance:ae(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:pt(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const m=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:m*(180/Math.PI),distance:ae(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:pt(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function mu(e,t,n){const s=[],i=tr/he.scale,o=sr/he.scale;if(pe.forEach(a=>{if(a.id!==e.id&&a.type==="regular"){const r=ae(t,a);r<i&&s.push({priority:1,dist:r,pos:a,snapType:"vertex",targetVertex:a})}}),K.forEach(a=>{if(a.id1===e.id||a.id2===e.id)return;const r=q(a.id1),c=q(a.id2);if(r&&c&&r.type==="regular"&&c.type==="regular"){const l=Dt(t,r,c);l.distance<o&&l.onSegmentStrict&&s.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:a})}}),s.length>0){const a=s.sort((r,c)=>r.priority!==c.priority?r.priority-c.priority:r.dist-c.dist)[0];return{pos:a.pos,snapped:!0,snapType:a.snapType,targetEdge:a.targetEdge,targetVertex:a.targetVertex}}return{pos:t,snapped:!1}}function xu(){Me=Me.map(e=>e.type==="color"?{...e,value:Ch(e.value)}:e)}function Su(){H.toolbarButton={id:"toolbar-button",x:lt,y:lt,width:Nd,height:Fd,type:"menuButton"}}function mc(){const e=ve.height/Ye;H.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:Xe,height:e,type:"toolbar"};const t=lt;let n=H.toolbarButton.y+H.toolbarButton.height+Bd;H.colorToolButton={id:"color-tool-button",type:"toolButton",x:lt,y:n,width:Xe-2*lt,height:wt},n+=wt+t,H.colorModeToolButton={id:"color-mode-tool-button",type:"toolButton",x:lt,y:n,width:Xe-2*lt,height:wt},n+=wt+t,H.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:lt,y:n,width:Xe-2*lt,height:wt},n+=wt+t,H.transformToolButton={id:"transform-tool-button",type:"toolButton",x:lt,y:n,width:Xe-2*lt,height:wt},n+=wt+t,H.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:lt,y:n,width:Xe-2*lt,height:wt},n+=wt+t,H.sessionsToolButton={id:"sessions-tool-button",type:"toolButton",x:lt,y:n,width:Xe-2*lt,height:wt}}function Ct(){H.colorSwatches=[],H.colorTargetIcons=[];const e=fs&&St,t=(()=>{if(!e)return Me.map((x,S)=>S);const u=Me.length,p=Math.max(0,Math.min(u-1,St.originalIndex)),g=Math.max(0,Math.min(u-1,St.previewIndex??p)),y=Me.map((x,S)=>S),[m]=y.splice(p,1);return y.splice(g,0,m),y})(),n=Ho,s=Gs+So,i=s-n,o=n*2+i,a=Xe+lt,l=H.colorToolButton.y+wt/2-n/2+-2;let d=a;H.removeColorButton={id:"remove-color-button",type:"button",x:d+(s-n)/2,y:l,width:n,height:n},d+=s;const f=u=>!u||u.type!=="colormap"?!1:Array.isArray(u.vertices)&&u.vertices.length>1;t.forEach((u,p)=>{const g=Me[u],y=f(g),m=y?o:n;H.colorSwatches.push({id:`swatch-${u}`,type:"colorSwatch",x:d+(s-n)/2,y:l,width:m,height:n,index:u,positionIndex:p,item:g}),d+=y?s*2:s}),H.addColorButton={id:"add-color-button",type:"button",x:d+(s-n)/2,y:l,width:n,height:n},Object.entries(_e).forEach(([u,p])=>{const g=n*.75,y=H.colorSwatches.find(m=>m.index===p);y&&H.colorTargetIcons.push({id:`target-icon-${u}`,type:"colorTargetIcon",target:u,x:y.x+(y.width-g)/2,y:y.y-g-5,width:g,height:g})});const h=[...H.colorSwatches,H.removeColorButton,H.addColorButton,...H.colorTargetIcons].filter(Boolean);if(h.length>0){const u=Math.min(...h.map(m=>m.y)),p=Math.max(...h.map(m=>m.x+m.width)),g=Math.max(...h.map(m=>m.y+m.height)),y=5;H.colorPaletteBounds={x:Xe,y:u-y,width:p-Xe+y,height:g-u+y*2}}else H.colorPaletteBounds=null}function Wi(){if(H.colorModeIcons=[],!H.colorModeToolButton)return;const e=Xe+lt,t=H.colorModeToolButton.y+wt/2,n=Ho,i=t-n/2+-2,o=Gs+So,a=o-n,r=n*3+a*2,c=r+n+a,l=(o-n)/2,d=["inherit_vertices","colormap"],f=["inherit_vertices","inherit_edges","colormap_xy"],h=so(),u=oo(),p=h.length>0,g=u.length>0,y=p?h.includes(Yn)?Yn:h[0]:Tt,m=g?u.includes(Gn)?Gn:u[0]:_t;H.colorModeExprFields=[];let x=e;const S=(E,T)=>{H.colorModeIcons.push({id:`${E}-color-mode-${T}`,type:"colorModeIcon",group:E,mode:T,x:x+l,y:i,width:n,height:n})},I=(E,T)=>{H.colorModeExprFields.push({id:`${E}-color-expr`,type:"colorModeExprField",group:E,x:x+o+l,y:i,width:T,height:n,baseWidth:r,expandedWidth:c}),x=x+o+l+T+l};d.forEach(E=>{S("edge",E),y===E&&E==="colormap"?I("edge",pi||r):x+=o}),f.forEach(E=>{S("face",E),m===E&&E==="colormap_xy"?I("face",yi||r):x+=o});const b=[...H.colorModeIcons,...H.colorModeExprFields].filter(Boolean);if(b.length>0){const E=Math.min(...b.map(A=>A.y)),T=Math.max(...b.map(A=>A.x+A.width)),M=Math.max(...b.map(A=>A.y+A.height)),P=5;H.colorModePanelBounds={x:Xe,y:E-P,width:T-Xe+P,height:M-E+P*2}}else H.colorModePanelBounds=null}function Ar(){if(H.interpolationIcons=[],!H.interpolationToolButton)return;const e=Xe+lt,t=H.interpolationToolButton.y+wt/2,n=Ho,i=t-n/2+-2,o=Gs+So;let a=e;H.interpolationIcons.push({id:"interpolation-remove",type:"interpolationRemove",x:a+(o-n)/2,y:i,width:n,height:n}),a+=o,yn.forEach(c=>{H.interpolationIcons.push({id:`interpolation-${c.id}`,type:"interpolationStyle",styleId:c.id,x:a+(o-n)/2,y:i,width:n,height:n}),a+=o}),H.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:a+(o-n)/2,y:i,width:n,height:n});const r=H.interpolationIcons.filter(Boolean);if(r.length>0){const c=Math.min(...r.map(h=>h.y)),l=Math.max(...r.map(h=>h.x+h.width)),d=Math.max(...r.map(h=>h.y+h.height)),f=5;H.interpolationPanelBounds={x:Xe,y:c-f,width:l-Xe+f,height:d-c+f*2}}else H.interpolationPanelBounds=null}function Iu(){if(H.displayIcons=[],!H.visibilityToolButton)return;const e=Gs+So,t=Xe+lt,n=H.visibilityToolButton.y+wt/2,s=Ho,o=n-s/2+-2;let a=t;if(["coords","grid","angles","distances","theme"].forEach(c=>{H.displayIcons.push({id:`display-icon-${c}`,group:c,x:a+(e-s)/2,y:o,width:s,height:s}),a+=e}),H.displayIcons.length>0){const c=H.displayIcons[0],l=H.displayIcons[H.displayIcons.length-1],d=5;H.displayPanelBounds={x:Xe,y:c.y-d,width:l.x+l.width-Xe+d,height:c.height+d*2}}else H.displayPanelBounds=null}function ra(){if(H.sessionIcons=[],!H.sessionsToolButton)return;const e=Xe+lt,t=H.sessionsToolButton.y+wt/2,n=Ho,i=t-n/2+-2,o=Gs+So;let a=e;H.removeSessionButton={id:"remove-session-button",type:"button",x:a+(o-n)/2,y:i,width:n,height:n},a+=o,Ne.forEach((c,l)=>{H.sessionIcons.push({id:`session-${c.id}`,type:"sessionIcon",x:a+(o-n)/2,y:i,width:n,height:n,index:l,session:c}),a+=o}),H.addSessionButton={id:"add-session-button",type:"button",x:a+(o-n)/2,y:i,width:n,height:n};const r=[...H.sessionIcons,H.removeSessionButton,H.addSessionButton].filter(Boolean);if(r.length>0){const c=Math.min(...r.map(h=>h.y)),l=Math.max(...r.map(h=>h.x+h.width)),d=Math.max(...r.map(h=>h.y+h.height)),f=5;H.sessionsPanelBounds={x:Xe,y:c-f,width:l-Xe+f,height:d-c+f*2}}else H.sessionsPanelBounds=null}function bu(){H.transformIcons=[];const e=Gs,t=e+So,n=Xe+lt,i=H.transformToolButton.y+wt/2-e/2,o=[xn,Zn,Mn,bs];let a=n;if(o.forEach(r=>{H.transformIcons.push({id:`transform-icon-${r}`,type:r,x:a+(t-e)/2,y:i,width:e,height:e}),a+=t}),H.transformIcons.length>0){const r=H.transformIcons[0],c=H.transformIcons[H.transformIcons.length-1],l=5;H.transformPanelBounds={x:Xe,y:r.y-l,width:c.x+c.width-Xe+l,height:r.height+l*2}}else H.transformPanelBounds=null}function Ja(e){e<0||e>=Me.length||Me.length<=1||(Me.splice(e,1),Ot!==null&&(Ot===e?Ot=Math.min(e,Me.length-1):Ot>e&&(Ot-=1)),Object.keys(_e).forEach(t=>{_e[t]>e?_e[t]--:_e[t]===e&&(_e[t]=Math.min(e,Me.length-1))}),Ct())}function vu(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}Me.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(Me.push(e),ft&&Ct())}function xc(e,t=[]){const n=q(e);if(!n)return null;for(let s=K.length-1;s>=0;s--){const i=K[s],o=re(i);if(t.includes(o))continue;let a=null;if(i.id1===e?a=i.id2:i.id2===e&&(a=i.id1),a){const r=q(a);if(r){const c=n.x-r.x,l=n.y-r.y;return{p1:r,p2:n,angleRad:Math.atan2(l,c),length:Math.sqrt(c*c+l*l),edgeId:o}}}}return null}function Ze(){const e=Qo();Me.length,Me[0]?.value,pe.length,Mt.push(e),Mt.length>lr&&Mt.shift(),hs=[],Zt()}function _r(e){const t=H.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!is)return!1;const n=[];H.mainToolbar&&n.push(H.mainToolbar),ft&&H.colorPaletteBounds&&n.push(H.colorPaletteBounds),dn&&H.interpolationPanelBounds&&n.push(H.interpolationPanelBounds),Dn&&H.transformPanelBounds&&n.push(H.transformPanelBounds),bn&&H.displayPanelBounds&&n.push(H.displayPanelBounds),vt&&H.sessionsPanelBounds&&n.push(H.sessionsPanelBounds),hn&&H.colorModePanelBounds&&n.push(H.colorModePanelBounds);for(const i of n)if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;const s=[];ft&&H.colorPaletteBounds&&s.push(H.colorPaletteBounds),dn&&H.interpolationPanelBounds&&s.push(H.interpolationPanelBounds),Dn&&H.transformPanelBounds&&s.push(H.transformPanelBounds),bn&&H.displayPanelBounds&&s.push(H.displayPanelBounds),vt&&H.sessionsPanelBounds&&s.push(H.sessionsPanelBounds),hn&&H.colorModePanelBounds&&s.push(H.colorModePanelBounds),s.sort((i,o)=>i.y-o.y);for(let i=0;i<s.length-1;i++){const o=s[i],a=s[i+1],r=o.y+o.height,c=a.y;if(e.y>r&&e.y<c){const l=Xe,d=o.x+o.width-l,f=a.x+a.width-l,h=Math.min(d,f),u=l+h;if(e.x<Xe||e.x>=l&&e.x<=u)return!0}}return!1}function Zo(e){pe=JSON.parse(JSON.stringify(e.vertices)),K=JSON.parse(JSON.stringify(e.edges)),se=JSON.parse(JSON.stringify(e.faces||[])),We=JSON.parse(JSON.stringify(e.textElements||[])),be=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),Se=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),ge=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),Pe=JSON.parse(JSON.stringify(e.selectedTextIds||[])),Fe=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),je=JSON.parse(JSON.stringify(e.activeColorTargets||[])),yn=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(En))],Os=e.activeInterpolationStyleId||yn[0]?.id||En.id,Me=e.allColors?JSON.parse(JSON.stringify(e.allColors)):Zi.map(n=>typeof n=="string"?{type:"color",value:n}:n),_e=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[Ue]:0,[Je]:1,[at]:2,[Gt]:0},Tt=e.edgeColorMode||"colormap",_t=e.faceColorMode||"colormap_xy",ls=e.edgeColorExpression||"x",cs=e.faceColorExpression||"x",ds=e.faceColorPolarExpression||"r",K.forEach(n=>{(!n.directionFrom||!n.directionTo)&&(n.directionFrom=n.id1,n.directionTo=n.id2)}),Tt==="fixed"&&(Tt="colormap"),_t==="fixed"&&(_t="colormap_xy"),_t==="colormap_polar"&&(_t="colormap_xy",(!e.faceColorExpression||e.faceColorExpression.trim()==="")&&ds&&(cs=ds)),se.forEach(n=>{n.colorMode==="fixed"&&(n.colorMode="colormap_xy"),n.colorMode==="colormap_polar"&&(n.colorMode="colormap_xy")}),K.forEach(n=>{n.colorMode==="fixed"&&(n.colorMode="colormap")}),_e[Gt]===void 0&&(_e[Gt]=0),Ka(),rt=e.activeCenterId!==void 0?e.activeCenterId:null,st=e.isDrawingMode!==void 0?e.isDrawingMode:!1,mt=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,Kt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,xs=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,It=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,qn=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,Ss=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,no=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,qt=!1,Ve=!1,Tn=!1,Wn=!1,we=[],Yi=null,en=-1,Ie={targetId:null,type:null,count:0,timestamp:0},ve.style.cursor="crosshair",ft&&Ct();const t=Qo();Mt.length===0&&Mt.push(t),Zt()}function Qo(){return{vertices:JSON.parse(JSON.stringify(pe)),edges:JSON.parse(JSON.stringify(K)),faces:JSON.parse(JSON.stringify(se)),textElements:JSON.parse(JSON.stringify(We)),selectedVertexIds:JSON.parse(JSON.stringify(be)),selectedEdgeIds:JSON.parse(JSON.stringify(Se)),selectedFaceIds:JSON.parse(JSON.stringify(ge)),selectedTextIds:JSON.parse(JSON.stringify(Pe)),selectedCenterIds:JSON.parse(JSON.stringify(Fe)),activeColorTargets:JSON.parse(JSON.stringify(je)),interpolationStyles:JSON.parse(JSON.stringify(yn)),activeInterpolationStyleId:Os,colorAssignments:JSON.parse(JSON.stringify(_e)),edgeColorMode:Tt,faceColorMode:_t,edgeColorExpression:ls,faceColorExpression:cs,faceColorPolarExpression:ds,allColors:JSON.parse(JSON.stringify(Me)),activeCenterId:rt,isDrawingMode:st,previewLineStartVertexId:mt,frozenReference_A_rad:Kt,frozenReference_A_baseRad:xs,frozenReference_D_du:It,frozenReference_Origin_Data:qn,frozenReference_D_g2g:Ss,deletedFaceIds:new Set(no)}}function Sc(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function Mu(){try{const e=new URLSearchParams(window.location.search);return Sc(e.get("user"))}catch{return""}}function Ic(){if(Sn)return Sn;const e=Mu();if(e){Sn=e;try{localStorage.setItem(wa,Sn)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return Sn}try{Sn=localStorage.getItem(wa)}catch{Sn=null}if(!Sn){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}Sn=Sc(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(wa,Sn)}catch(s){console.warn("Could not persist user id to localStorage.",s)}}return Sn}function bc(){const e=Ic();return`${vr}.state.v${Li}.${e}`}function vc(){const e=Ic();return`${vr}.sessions.v${Li}.${e}`}function Mc(){return{vertices:[],edges:[],faces:[],textElements:[],selectedVertexIds:[],selectedEdgeIds:[],selectedFaceIds:[],selectedTextIds:[],selectedCenterIds:[],activeColorTargets:[],interpolationStyles:[JSON.parse(JSON.stringify(En))],activeInterpolationStyleId:En.id,colorAssignments:{[Ue]:0,[Je]:1,[at]:2,[Gt]:0},edgeColorMode:"colormap",faceColorMode:"colormap_xy",edgeColorExpression:"x",faceColorExpression:"x",faceColorPolarExpression:"r",allColors:Zi.map(e=>typeof e=="string"?{type:"color",value:e}:e),activeCenterId:null,isDrawingMode:!1,previewLineStartVertexId:null,frozenReference_A_rad:null,frozenReference_A_baseRad:null,frozenReference_D_du:null,frozenReference_Origin_Data:null,frozenReference_D_g2g:null,deletedFaceIds:[]}}function ei(){if(!Ne.length)return;const e=Ne[nn];e&&(e.state=kr())}function Dr(e,t=""){return{id:Ut(),name:t,state:JSON.parse(JSON.stringify(e))}}function kr(){const e=Qo();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function Ec(){if(!window.localStorage)return;const e=bc(),t={version:Li,savedAt:Date.now(),state:kr()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}if(Ne.length>0){ei();const n=vc(),s={version:Li,savedAt:Date.now(),activeSessionIndex:nn,sessions:Ne.map(i=>({...i,state:JSON.parse(JSON.stringify(i.state))}))};try{localStorage.setItem(n,JSON.stringify(s))}catch(i){console.warn("Could not persist sessions to localStorage.",i)}}}function Zt(){window.localStorage&&(ci&&clearTimeout(ci),ci=setTimeout(()=>{ci=null,Ec()},300))}function Eu(){if(!window.localStorage)return!1;const e=bc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(Zo(n.state),Jt(),ac=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function Tu(){if(!window.localStorage)return!1;const e=vc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!Array.isArray(n.sessions)||n.sessions.length===0?!1:(Ne=n.sessions.map(s=>({id:s.id||Ut(),name:s.name||"",state:s.state||Mc()})),nn=Math.min(Math.max(n.activeSessionIndex||0,0),Ne.length-1),kt=nn,Mt=[],hs=[],Zo(Ne[nn].state),Jt(),ac=!0,!0)}catch(t){return console.warn("Could not load sessions from localStorage.",t),!1}}function Cu(){const e=kr();Ne=[Dr(e,"World 1")],nn=0,kt=0}function zs(e){e<0||e>=Ne.length||(ei(),nn=e,kt=e,Mt=[],hs=[],Zo(Ne[nn].state),Jt(),vt&&ra(),Zt())}function wu(){ei();const e=Dr(Mc(),`World ${Ne.length+1}`),t=kt!==null?kt+1:Ne.length;Ne.splice(t,0,e),zs(t)}function Pu(){if(!ko||!ko.state)return;ei();const e=Dr(ko.state,`World ${Ne.length+1}`),t=kt!==null?kt+1:Ne.length;Ne.splice(t,0,e),zs(t)}function Tc(e){if(e<0||e>=Ne.length||(ei(),Ne.length===1))return;const t=e<Ne.length-1?e:e-1,[n]=Ne.splice(e,1);Gi.push({session:n,index:e}),nn===e?zs(Math.max(0,Math.min(t,Ne.length-1))):(nn>e&&(nn-=1),kt>e&&(kt-=1),vt&&ra(),Zt())}function Au(){if(!Gi.length)return!1;const{session:e,index:t}=Gi.pop(),n=Math.max(0,Math.min(t,Ne.length));return Ne.splice(n,0,e),zs(n),!0}function _u(){if(!Ne.length)return;const e=(kt+1)%Ne.length;zs(e)}function Du(){if(!Ne.length)return;const e=(kt-1+Ne.length)%Ne.length;zs(e)}function Ki(){se.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=se.map(t=>{const n=t.vertexIds.map(s=>q(s));return n.some(s=>!s)?null:{face:t,vertices:n,area:Math.abs(ta(n))}}).filter(Boolean);e.forEach(t=>{let n=null,s=1/0;e.forEach(i=>{if(t.face.id===i.face.id||i.area<=t.area)return;const o=t.face.vertexIds,a=o.map(c=>q(c));if(a.some(c=>!c))return;if(Nh(a,i.vertices)){const c=new Set(o),l=K.filter(f=>c.has(f.id1)&&c.has(f.id2));!Fh(l,i.vertices,q)&&i.area<s&&(s=i.area,n=i.face)}}),n&&(t.face.parentFaceId=n.id)}),se.forEach(t=>{if(t.parentFaceId){const n=se.find(s=>s.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function Oe(e){const t=e.x*Ye,n=e.y*Ye,s=ve.height;return{x:(t-he.offsetX)/he.scale,y:(s-n-he.offsetY)/he.scale}}function Ce(e){const t=ve.height,n=e.x*he.scale+he.offsetX,s=t-(e.y*he.scale+he.offsetY);return{x:n/Ye,y:s/Ye}}function q(e){return pe.find(t=>t.id===e)}function Xs(e){if(!q(e))return[];const t=new Set,n=[e],s=[];for(t.add(e);n.length>0;){const i=n.shift();s.push(i),In(i,K).forEach(o=>{t.has(o)||(t.add(o),n.push(o))})}return s}function po(e){const t=Oe(e),n=Ke*2/he.scale,s=(Ui+Ke)/he.scale;for(let i=pe.length-1;i>=0;i--){const o=pe[i];if(o.type!=="regular"&&ae(t,o)<s)return o}for(let i=pe.length-1;i>=0;i--){const o=pe[i];if(o.type==="regular"&&ae(t,o)<n)return o}return null}function yo(e){const t=Oe(e),n=sr/he.scale;for(let s=K.length-1;s>=0;s--){const i=K[s],o=q(i.id1),a=q(i.id2);if(o&&a&&o.type==="regular"&&a.type==="regular"){const r=Dt(t,o,a);if(r.distance<n&&r.onSegmentStrict)return i}}return null}function mo(e){const t=Oe(e),n=[];for(const o of se){if(o.color==="transparent")continue;const a=o.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular");a.length<3||Rs(t,a)&&n.push(o)}if(n.length===0)return null;let s=null,i=1/0;for(const o of n){let a=!1;if(o.childFaceIds&&o.childFaceIds.length>0)for(const r of o.childFaceIds){const c=se.find(l=>l.id===r);if(c&&c.color==="transparent"){const l=c.vertexIds.map(d=>q(d)).filter(Boolean);if(l.length>=3&&Rs(t,l)){a=!0;break}}}if(!a){const r=o.vertexIds.map(c=>q(c));if(r.every(Boolean)){const c=Math.abs(ta(r));c<i&&(i=c,s=o)}}}return s}function Za(e){return K.filter(t=>t.id1===e||t.id2===e)}function ku(){be.length===0&&Se.length===0&&Fe.length===0||(Ze(),Cc(),ti())}function Cc(){const e=new Set(be);rt&&e.add(rt);const t=[];ge.length>0&&ge.forEach(o=>{const a=se.find(r=>fe(r)===o);a&&(t.push(a),a.vertexIds.forEach(r=>e.add(r)))}),Se.forEach(o=>{const[a,r]=o.split(ao);e.add(a),e.add(r)}),Yt.vertices=Array.from(e).map(o=>{const a=q(o);return a?{...a}:null}).filter(o=>o),Yt.edges=[],K.forEach(o=>{e.has(o.id1)&&e.has(o.id2)&&Yt.edges.push({...o})}),Yt.faces=t.map(o=>JSON.parse(JSON.stringify(o)));const n=new Set(Pe),s=new Set(ge),i=new Set(Se);Yt.texts=We.filter(o=>{if(n.has(o.id))return!0;if(o.anchorType==="vertex")return e.has(o.anchorId);if(o.anchorType==="edge"){if(i.has(o.anchorId))return!0;const a=K.find(r=>re(r)===o.anchorId);return a?e.has(a.id1)&&e.has(a.id2):!1}if(o.anchorType==="face"){if(s.has(o.anchorId))return!0;const a=se.find(r=>fe(r)===o.anchorId);return a?a.vertexIds.every(r=>e.has(r)):!1}return!1}).map(o=>JSON.parse(JSON.stringify(o))),Yt.referenceVertex=Oe(j)}function Ru(){if(Yt.vertices.length===0||!Yt.referenceVertex)return;Ze();const e=Oe(j),t=e.x-Yt.referenceVertex.x,n=e.y-Yt.referenceVertex.y,s=new Map,i=[];let o=null;Is(),Yt.vertices.forEach(c=>{const l=Ut(),d={...c,id:l,x:c.x+t,y:c.y+n};pe.push(d),s.set(c.id,l),d.type==="regular"?i.push(l):o=l}),Yt.edges.forEach(c=>{const l=s.get(c.id1),d=s.get(c.id2);l&&d&&K.push({...c,id1:l,id2:d})});const a=[];Yt.faces.forEach(c=>{const l=c.vertexIds.map(d=>s.get(d)).filter(Boolean);if(l.length===c.vertexIds.length){const d={...c,id:fe({vertexIds:l}),vertexIds:l};d.localCoordSystem&&(d.localCoordSystem.origin.x+=t,d.localCoordSystem.origin.y+=n,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=s.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=s.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=s.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=s.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=s.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=s.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=s.get(d.localCoordSystem.scaleAttachedToEdge.v2))),d.parentFaceId=null,d.childFaceIds=[],se.push(d),a.push(d.id)}}),vs();const r=[];Yt.texts.forEach(c=>{const l=JSON.parse(JSON.stringify(c));if(l.id=Ut(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const d=s.get(l.anchorId);if(!d)return;l.anchorId=d}else if(l.anchorType==="edge"){const d=K.find(u=>re(u)===l.anchorId);if(!d)return;const f=s.get(d.id1),h=s.get(d.id2);if(!f||!h)return;l.anchorId=re({id1:f,id2:h})}else if(l.anchorType==="face"){const d=se.find(h=>fe(h)===l.anchorId);if(!d)return;const f=d.vertexIds.map(h=>s.get(h));if(!f.every(Boolean))return;l.anchorId=fe({vertexIds:f})}We.push(l),r.push(l.id)}),be=i,Se=Yt.edges.map(c=>re({id1:s.get(c.id1),id2:s.get(c.id2)})),ge=a,Pe=r,rt=o,Jt()}function ti(){const e=new Set(be),t=new Set(Fe),n=new Set(Se),s=new Set(ge),i=new Set(Pe);if(e.size===0&&t.size===0&&n.size===0&&s.size===0&&i.size===0)return;if(Ze(),s.size>0){const l=new Set;se.forEach(d=>{const f=d.id||fe(d);s.has(f)&&(no.add(f),d.childFaceIds&&d.childFaceIds.length>0&&d.childFaceIds.forEach(h=>{const u=se.find(p=>p.id===h);u&&(u.parentFaceId=null)}),d.parentFaceId?d.color="transparent":l.add(f))}),l.size>0&&(se=se.filter(d=>!l.has(d.id||fe(d))))}const o=[...K];if(n.size>0&&(K=K.filter(l=>!n.has(re(l)))),e.size>0){const l=JSON.parse(JSON.stringify(K)),d=[],f=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1,h=new Set(e);for(;h.size>0;){const u=h.values().next().value,p=new Set,g=[u];for(;g.length>0;){const S=g.shift();h.has(S)&&(p.add(S),h.delete(S),In(S,K).forEach(b=>{h.has(b)&&g.push(b)}))}const y=K.filter(S=>p.has(S.id1)&&!p.has(S.id2)||p.has(S.id2)&&!p.has(S.id1)),m=new Set;y.forEach(S=>{p.has(S.id1)||m.add(S.id1),p.has(S.id2)||m.add(S.id2)});const x=Array.from(m);if(x.length===2){const[S,I]=x,b=q(S),E=q(I),T=K.some(M=>M.id1===S&&M.id2===I||M.id1===I&&M.id2===S);if(b&&E&&!T){const M=Ls(b,E,f,Ge);Jn(M,Tt),Vs(M),d.push(M)}}}pe=pe.filter(u=>!e.has(u.id)),K=K.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),d.length>0&&(K.push(...d),Ys(l,K),vs())}Ys(o,K),t.size>0&&(pe=pe.filter(l=>!t.has(l.id))),i.size>0&&(We=We.filter(l=>!i.has(l.id)));const a=new Set(pe.map(l=>l.id)),r=new Set(K.map(l=>re(l))),c=new Set(se.map(l=>fe(l)));We=We.filter(l=>l.anchorType==="vertex"?a.has(l.anchorId):l.anchorType==="edge"?r.has(l.anchorId):l.anchorType==="face"?c.has(l.anchorId):!0),Pe=Pe.filter(l=>We.some(d=>d.id===l)),Is(),Jt()}function qi(e,t){let n=he.scale*t;n<Kr&&(n=Kr),n>qr&&(n=qr);const s=n/he.scale,i=e.x*Ye,o=e.y*Ye;he.offsetX=i*(1-s)+he.offsetX*s,he.offsetY=(ve.height-o)*(1-s)+he.offsetY*s,he.scale=n}function Lu(e){he.offsetX+=e.x*Ye,he.offsetY-=e.y*Ye}function Rr(e){let t=0,n,s=Math.PI/2,i=!0;const o=q(e);if(!o)return i=!0,yt!=="none"&&Z.interval1?n=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1:n=Oa,It!==null&&(n=It),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=xc(o.id);return a?(i=!1,t=a.angleRad,n=It!==null?It:a.length,Kt!==null?Math.abs(Kt)<ye?s=ya:s=Math.abs(Kt):s=ya):(i=!0,yt!=="none"&&Z.interval1?n=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1:n=Oa,It!==null&&(n=It),t=0,s=ya),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:Kt,displayAngleA_originVertexData_for_A_equals_label:qn,frozen_A_baseRad_to_display:xs,frozen_D_du_to_display:It,frozen_D_g2g_to_display:Ss}}function Pl(e,t,n){if(!e||!t)return null;const s=Math.atan2(t.y-e.y,t.x-e.x),i=ae(e,t);let o=0,a=!0;for(let c=n.length-1;c>=0;c--){const l=n[c];let d=null;if(l.id1===e.id&&q(l.id2)?.type==="regular"?d=l.id2:l.id2===e.id&&q(l.id1)?.type==="regular"&&(d=l.id1),d&&d!==t.id){const f=q(d);if(f){o=Math.atan2(e.y-f.y,e.x-f.x),a=!1;break}}}const r=pt(s-o);return{startVertex:e,endVertex:t,absoluteAngleRad:s,length:i,precedingSegmentAbsoluteAngleRad:o,turnAngleRad:r,isFirstSegmentOfLine:a}}function wc(e,t){const n=new Set,s=[e],i=new Set([e]);for(;s.length>0;){const o=s.shift(),a=t.find(r=>r.id===o);a&&(a.vertexIds.forEach(r=>n.add(r)),a.childFaceIds&&a.childFaceIds.forEach(r=>{i.has(r)||(i.add(r),s.push(r))}))}return Array.from(n)}function Ou(){const e=be.filter(i=>{const o=q(i);return o&&o.type==="regular"});if(e.length<2)return;Ze();const t=JSON.parse(JSON.stringify(K));let n=!1;const s=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;for(let i=0;i<e.length;i++)for(let o=i+1;o<e.length;o++){const a=e[i],r=e[o];if(!K.some(l=>l.id1===a&&l.id2===r||l.id1===r&&l.id2===a)){const l=q(a),d=q(r);if(l&&d){const f=Ls(l,d,s,Ge);Jn(f,Tt),Vs(f),K.push(f),n=!0}}}n&&jn&&(Ys(t,K),se.forEach(i=>{i.colorMode=i.colorMode||_t,Uo(i,i.colorMode)}),vs()),Jt()}function $t(e=[],t=[],n=[],s,i,o=!1,a=[]){if(o)Pr(e[0],s,i);else{let r=new Set(Ee.selection.vertices),c=new Set(Ee.selection.edges),l=new Set(Ee.selection.faces),d=new Set(Ee.selection.text);s?(e.forEach(f=>r.add(f)),t.forEach(f=>c.add(f)),n.forEach(f=>l.add(f)),a.forEach(f=>d.add(f))):i?(e.forEach(f=>{r.has(f)?r.delete(f):r.add(f)}),t.forEach(f=>{c.has(f)?c.delete(f):c.add(f)}),n.forEach(f=>{l.has(f)?l.delete(f):l.add(f)}),a.forEach(f=>{d.has(f)?d.delete(f):d.add(f)})):(r=new Set(e),c=new Set(t),l=new Set(n),d=new Set(a)),Ee.selection.vertices=r,Ee.selection.edges=c,Ee.selection.faces=l,Ee.selection.text=d,be=Array.from(r),Se=Array.from(c),ge=Array.from(l),Pe=Array.from(d)}Lr(),lc()}function Nu(e,t,n,s,i=0){const o={x:n.x-e.x,y:n.y-e.y},a={x:t.x-e.x,y:t.y-e.y},r=Math.hypot(o.x,o.y),c=Math.hypot(a.x,a.y),l=Math.atan2(o.y,o.x),d=Math.atan2(a.y,a.x);let f=0,h=1,u=!1;if(s===xn)h=1,f=gl(l,d,i);else if(s===Zn)f=0,r>ye&&(h=c/r);else if(s===Mn)f=gl(l,d,i),r>ye&&(h=c/r);else if(s===bs&&(u=!0,f=0,r>ye)){const p={x:o.x/r,y:o.y/r};h=(a.x*p.x+a.y*p.y)/r}return{rotation:f,scale:h,directionalScale:u}}function Ys(e,t){if(!jn){se=[],no.clear();return}const n=new Set(e.map(g=>re(g))),s=new Set(t.map(g=>re(g))),i=t.filter(g=>!n.has(re(g))),o=e.filter(g=>!s.has(re(g)));if(i.length===0&&o.length===0)return;const a=new Set;i.forEach(g=>{a.add(g.id1),a.add(g.id2)}),o.forEach(g=>{a.add(g.id1),a.add(g.id2)});const r=new Set,c=new Set;for(const g of a)c.has(g)||Xs(g).forEach(m=>{r.add(m),c.add(m)});const l=K.filter(g=>r.has(g.id1)&&r.has(g.id2)),d=se.filter(g=>g.vertexIds.every(y=>r.has(y))),f=sa(l,q),h=new Set(d.map(g=>g.id));se=se.filter(g=>!h.has(g.id));let u=f;if(f.length>1){const g=f.map(y=>{const m=y.vertexIds.map(x=>q(x));return m.some(x=>!x)?null:{face:y,area:Math.abs(ta(m))}}).filter(Boolean);if(g.length>1){g.sort((x,S)=>S.area-x.area);const y=g[0],m=g.slice(1).reduce((x,S)=>x+S.area,0);Math.abs(y.area-m)<ye&&(u=g.slice(1).map(x=>x.face))}}const p=new Set(i.map(g=>re(g)));u.forEach(g=>{let y=!1;if(i.length>0)for(let m=0;m<g.vertexIds.length;m++){const x=g.vertexIds[m],S=g.vertexIds[(m+1)%g.vertexIds.length],I=re({id1:x,id2:S});if(p.has(I)){y=!0;break}}if(no.has(g.id))if(y)no.delete(g.id);else return;g.colorMode=g.colorMode||_t,Uo(g,g.colorMode),g.interpolationStyleId||gu(g),g.parentFaceId=null,g.childFaceIds=[],se.push(g)}),vs()}function Pc(e,t,n,s){const i=q(e.id1),o=q(e.id2);if(!i||!o)return null;const a=[...K],r={id:Ut(),x:t.x,y:t.y,type:"regular",color:s(Ue)};pe.push(r),K=K.filter(f=>re(f)!==re(e));const c=Ls(i,r,n,s),l=Ls(r,o,n,s),d=e?.colorMode||Tt;return Jn(c,d),Jn(l,d),Vs(c),Vs(l),K.push(c),K.push(l),jn&&Ys(a,K),r}function Fu(e,t,n,s,i){const o=nt(n,e,s,i,!1,null),a={x:n.x-e.x,y:n.y-e.y},r=2*Ke/he.scale,c=t.filter(d=>d.type==="regular"),l=[];if(c.length>0){const d=pe.filter(h=>h.type==="regular"&&!t.some(u=>u.id===h.id)),f=parseInt(jt||"1",10)||1;for(let h=1;h<=f;h++)c.forEach(u=>{d.forEach(p=>{const g={x:u.x-e.x,y:u.y-e.y},y={x:p.x-e.x,y:p.y-e.y},m=Math.hypot(g.x,g.y),x=Math.hypot(y.x,y.y);if(m>ye){const S=Math.pow(x/m,1/h);let I=Math.atan2(y.y,y.x)-Math.atan2(g.y,g.x);const E=(I+Math.round((s*h-I)/(2*Math.PI))*(2*Math.PI))/h,T=nt(n,e,E,S,!1,a),M=ae(o,T);l.push({dist:M,rotation:E,scale:S,pos:T})}})})}if(l.length>0){const d=l.sort((f,h)=>f.dist-h.dist)[0];if(d.dist<r)return{...d,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}if(Re){const d=[],f=[],h=cr.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).sort((x,S)=>Math.abs(pt(s-x))-Math.abs(pt(s-S))),u=as.filter(x=>x>0).sort((x,S)=>Math.abs(i-x)-Math.abs(i-S)),p=h.slice(0,2),g=u.slice(0,2);p.forEach(x=>{g.forEach(S=>{const I=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI),b=nt(n,e,I,S,!1,a);d.push({dist:ae(o,b),rotation:I,scale:S,pos:b})})});const y=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;if(y){const x=ps(o,yt,y,Cn,!0),S=Math.hypot(a.x,a.y);x.forEach(I=>{if(S>ye){const b={x:I.x-e.x,y:I.y-e.y},E=Math.hypot(b.x,b.y)/S,T=Math.atan2(b.y,b.x)-Math.atan2(a.y,a.x),M=T+Math.round((s-T)/(2*Math.PI))*(2*Math.PI);f.push({dist:ae(o,I),rotation:M,scale:E,pos:I})}})}const m=[...d,...f].sort((x,S)=>x.dist-S.dist)[0];return{...m,snapped:!0,snapType:"geometric",snappedScaleValue:m.scale}}return{rotation:s,scale:i,pos:o,snapped:!1}}function Bu(e,t,n,s,i){const o=parseInt(jt||"1",10);let a=[];const r=Math.hypot(n.x-e.x,n.y-e.y),c=2*Ke/he.scale,l=t.filter(g=>g.type==="regular"),d=pe.filter(g=>g.type==="regular"&&!t.some(y=>y.id===g.id));if(Array.from({length:o},(g,y)=>y+1).forEach(g=>{l.forEach(y=>{d.forEach(m=>{const x={x:y.x-e.x,y:y.y-e.y},S={x:m.x-e.x,y:m.y-e.y};if(Math.abs(Math.hypot(x.x,x.y)-Math.hypot(S.x,S.y))<ye){let I=Math.atan2(S.y,S.x)-Math.atan2(x.y,x.x);const b=I+Math.round((s*g-I)/(2*Math.PI))*(2*Math.PI);a.push({rotation:b/g,priority:Math.abs(pt(b/g-s)),snapType:"merge"})}})})}),Re){cr.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).forEach(x=>{const S=Math.abs(pt(s-x)),I=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI);a.push({rotation:I,priority:S,snapType:"geometric"})});const y=new Set(t.map(x=>x.id));let m=pe.filter(x=>x.type==="regular"&&!y.has(x.id));if(Z){const x=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;x&&m.push(...ps(i,yt,x,Cn,!0))}m.forEach(x=>{const S=ae(i,x);if(S<tr/he.scale){const I=Math.atan2(n.y-e.y,n.x-e.x),b=Math.atan2(x.y-e.y,x.x-e.x),E=pt(b-I),T=E+Math.round((s-E)/(2*Math.PI))*(2*Math.PI);a.push({rotation:T,priority:S/1e3,snapType:"projection",projectionSource:x})}})}if(a.length===0)return{rotation:s,snapped:!1,snapType:null};a.sort((g,y)=>g.priority-y.priority);const h=a[0];if(h.snapType==="merge"){const g=nt(n,e,h.rotation,1,!1,null);if(ae(i,g)>c)return{rotation:s,snapped:!1,snapType:null}}const u=nt(n,e,h.rotation,1,!1,null);let p=null;return h.snapType==="projection"&&(p={x:e.x+r*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+h.rotation),y:e.y+r*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+h.rotation)}),{rotation:h.rotation,pos:u,snapped:!0,snapType:h.snapType,projectionSource:h.projectionSource||null,projectionPoint:p}}function $u(e,t,n,s){const i=Oe(j),o=2*Ke/he.scale,a=t.filter(c=>c.type==="regular"),r=[];if(a.length>0){const c=pe.filter(f=>f.type==="regular"&&!t.some(h=>h.id===f.id)),l=o/100,d=parseInt(jt||"1",10);for(let f=1;f<=d;f++)a.forEach(h=>{c.forEach(u=>{const p={x:h.x-e.x,y:h.y-e.y},g={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(p.x,p.y),m=Math.hypot(g.x,g.y);if(y>ye){const x=Math.atan2(p.y,p.x),S=Math.atan2(g.y,g.y);if(Math.abs(pt(x-S))<l){const I=Math.pow(m/y,1/f),b=nt(n,e,0,I,!1,null);r.push({scale:I,dist:ae(i,b)})}}})})}if(r.length>0){const c=r.sort((l,d)=>l.dist-d.dist)[0];if(c.dist<o){const l=nt(n,e,0,c.scale,!1,null);return{...c,pos:l,snapped:!0,snapType:"merge"}}}if(Re){let c,l,d=1,f=1/0;as.forEach(g=>{const y=Math.abs(s-g);y<f&&(f=y,d=g)});const h=nt(n,e,0,d,!1,null);c={scale:d,pos:h,dist:ae(i,h),snapType:"geometric",snappedScaleValue:d};const u=new Set(t.map(g=>g.id)),p=pe.filter(g=>g.type==="regular"&&!u.has(g.id));if(Z){const g=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;g&&p.push(...ps(i,yt,g,Cn,!0))}if(p.length>0){const g=p.reduce((x,S)=>ae(i,x)<ae(i,S)?x:S),y=Math.hypot(n.x-e.x,n.y-e.y),m=ae(e,g);if(y>ye){const x=m/y,S=Math.atan2(n.y-e.y,n.x-e.x),I={x:e.x+m*Math.cos(S),y:e.y+m*Math.sin(S)};l={scale:x,pos:I,dist:ae(i,I),snapType:"projection",snappedScaleValue:x,projectionSource:g}}}return l&&ae(i,l.projectionSource)<o?{...l,snapped:!0}:{...c,snapped:!0}}return{scale:s,snapped:!1,snapType:null}}function Vu(e,t,n,s,i,o){let a=[];const r=2*Ke/he.scale;if(t.filter(l=>l.type==="regular"),Re){let l=null,d=null,f=1,h=1/0;[...as,...as.map(m=>-m)].forEach(m=>{const x=Math.abs(s-m);x<h&&(h=x,f=m)});const p=nt(n,e,0,f,!0,i);l={scale:f,pos:p,dist:ae(o,p),snapType:"geometric",snappedScaleValue:f};const g=new Set(t.map(m=>m.id)),y=pe.filter(m=>m.type==="regular"&&!g.has(m.id));if(Z){const m=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;m&&y.push(...ps(o,yt,m,Cn,!0))}if(y.length>0){const m=y.reduce((S,I)=>ae(o,I)<ae(o,S)?I:S),x=Math.hypot(i.x,i.y);if(x>ye){const S={x:i.x/x,y:i.y/x},I=E=>(E.x-e.x)*S.x+(E.y-e.y)*S.y,b=I(n);if(Math.abs(b)>ye){const T=I(m)/b,M=nt(n,e,0,T,!0,i);d={scale:T,pos:M,dist:ae(o,M),snapType:"projection",snappedScaleValue:T,projectionSource:m}}}}d&&ae(o,d.projectionSource)<r?a.push({...d,priority:0}):a.push({...l,priority:1})}return a.length===0?{scale:s,snapped:!1,snapType:null}:{...a.sort((l,d)=>l.priority-d.priority)[0],snapped:!0}}function Xu(e){const t=ve.width/Ye,n=ve.height/Ye,{grid1Interval:s,grid2Interval:i,alpha1:o,alpha2:a}=$h(he.scale);Z={interval1:s,interval2:i,alpha1:o,alpha2:a,scale:he.scale},Cn=Vh(he,t,n,Ce),Zh(ke,{gridDisplayMode:yt,canvas:ve,dpr:Ye,viewTransform:he,gridAlpha:Qf,colors:e},Ce,Oe,Z,Cn);let r={useScientific:!1};return Fs!==Qi&&(r=qh(ke,gt,{canvas:ve,dpr:Ye,coordsDisplayMode:Fs,viewTransform:he,angleDisplayMode:Qt,colors:e},Ce,Oe,Z,Cn,Lt)),r}function Yu(e){const t=Ve&&xe.length===1&&!tt&&xe[0].type==="regular";if(za.forEach(n=>{Ve&&xe.length>0&&[...n].some(i=>xe.some(o=>o.id===i))||yu(n,e,!1,[],0)}),pe.forEach(n=>{if(n.type!=="regular"){const s=Ve&&xe.some(c=>c.id===n.id);let i=n,o=!1,a=s?0:void 0;if(s&&!t&&we.length>0){const c=we.find(l=>l&&l.originalId===n.id&&l.transformIndex===0);c&&(i=c)}if(At){const c=n.originalId||n.id;At.has(c)&&At.get(c).find(f=>f.copyIndex===a)&&(o=!0)}const r={selectedVertexIds:[],selectedCenterIds:Fe,activeCenterId:rt,colors:e,verticesVisible:!0,isHovered:mn===n.id&&!Et,isSnapped:o,snappedVertexIds:At,isDragConfirmed:Ve,dragPreviewVertices:we,currentAltPressed:Et};Di(ke,i,r,Ce)}}),Ve){const s={copyCount:parseInt(jt||"1",10),isDragConfirmed:Ve,initialDragVertexStates:xe,dragPreviewVertices:we,transformIndicatorData:tt,allEdges:K,allFaces:se,findVertexById:q,findNeighbors:i=>findNeighbors(i),findAllVerticesInSubgraph:i=>Xs(i),colors:e,edgeColorMode:Tt,faceColorMode:_t,edgeColorExpression:ls,faceColorExpression:cs,faceColorPolarExpression:ds,angleDisplayMode:Qt,initialCoordSystemStates:ms,getInterpolationStyleById:Go,snappedEdgesInfo:Bs,snappedVertexIds:At};t?zh(ke,s,Ce):Gh(ke,s,Ce)}}function Gu(e,t){gf(gt,{coordsDisplayMode:Fs,isMouseOverCanvas:Xo,currentShiftPressed:Re,ghostVertexPosition:ze,gridDisplayMode:yt,lastGridState:Z,angleDisplayMode:Qt,canvas:ve,dpr:Ye,mousePos:j,colors:e,useScientific:t.useScientific},Oe,Lt),cu();const n={dpr:Ye,canvasUI:H,isToolbarExpanded:is,isColorPaletteExpanded:ft,isColorModePanelExpanded:hn,isInterpolationPanelExpanded:dn,isTransformPanelExpanded:Dn,isDisplayPanelExpanded:bn,isVisibilityPanelExpanded:ia,isSessionsPanelExpanded:vt,isPlacingTransform:sn,placingTransformType:ho,placingSnapPos:jo,mousePos:j,allColors:Me,activeThemeName:Yo,colors:e,verticesVisible:Ni,edgesVisible:Fi,facesVisible:jn,coordsDisplayMode:Fs,gridDisplayMode:yt,angleDisplayMode:Qt,distanceDisplayMode:ui,namedColors:ts.namedColors,colorAssignments:_e,activeColorTargets:je,lastSelectedSwatchIndex:Ot,interpolationStyles:yn,activeInterpolationStyleId:Os,sessions:Ne,activeSessionIndex:nn,selectedSessionIndex:kt,edgeColorMode:Tt,faceColorMode:_t,selectedEdgeModes:so(),selectedFaceModes:oo(),isDraggingColorTarget:to,draggedColorTargetInfo:Xt};n.selectedInterpolationStyleId=hc(),_f(ke,gt,n,Lt)}function Ac(){Mr.clear();const e=aa();Xh(ke,{canvas:ve,dpr:Ye,colors:e}),Yu(e),Gl(ke,{allFaces:se,hoveredFaceId:Ft,selectedFaceIds:ge,colors:e,isDragConfirmed:Ve,dragPreviewVertices:we,currentAltPressed:Et},Ce,q,fe),ge.length>0&&Ql(ke,{allFaces:se,selectedFaceIds:ge,colors:e,isDragConfirmed:Ve,dragPreviewVertices:we,initialDragVertexStates:xe,transformIndicatorData:tt,highlightedEdgeForSnap:Xn,draggedFaceId:qo,coordSystemSnapAngle:co,coordSystemSnapType:Ns,coordSystemSnapScale:Bn,initialCoordSystemStates:ms},Ce,q),Cg(e),pu(e),ef(ke,{altHoverInfo:ct,colors:e},Ce,q,Lt);const t=Xu(e);Gu(e,t),hu()}function _c(){if(!Le||Le.length<2)return;const e=_e[Ue];if(e===-1)return;const t=Me[e];if(!t||t.type!=="colormap")return;const n=Le.length;Le.forEach((s,i)=>{const o=q(s);if(o&&o.type==="regular"){const a=n>1?i/(n-1):.5;o.color=Be(t,a)}})}function Dc(){if(!Le||Le.length<2)return;const e=_e[Je];if(e===-1)return;const t=Me[e];if(!t||t.type!=="colormap")return;const s=Le.length-1;for(let i=0;i<s;i++){const o=Le[i],a=Le[i+1],r=K.find(c=>c.id1===o&&c.id2===a||c.id1===a&&c.id2===o);if(r){const c=i/s,l=(i+1)/s;r.gradientStart=c,r.gradientEnd=l,r.colormapItem=t,delete r.colormapOffset,delete r.color}}}function zu(e,t,n){if(!ft)return!1;const s=H.removeColorButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height){if(Me.length>1&&je.length>0){const o=je[je.length-1],a=_e[o];a>=0&&(Ze(),Ja(a))}else Me.length>1&&Ot!==null&&Ot>=0&&Ot<Me.length&&(Ze(),Ja(Ot));return!0}const i=H.addColorButton;return i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height?(Vi=!1,Do=null,ts.show(),!0):!1}function Lr(){const e=[];return ge.length>0&&e.push(at),Se.length>0&&e.push(Je),be.length>0&&e.push(Ue),Pe.length>0&&e.push(Gt),e.length>0?(je=e,Ot=null,ft&&Ct(),!0):!1}function Is(){if(tn&&clearTimeout(tn),jt="",tn=null,fs&&(Me=St.originalAllColors,_e=St.originalAssignments,Ct(),Mt.length>0&&Mt.pop(),fs=!1,St=null),st){st=!1,mt=null,Kt=null,xs=null,It=null,Ss=null,qn=null,ht=[],ln=0,Le=[],Oi=null;return}sn&&(sn=!1,ho=null,jo=null),be=[],Se=[],ge=[],Fe=[],Pe=[],rt=null,je=[],ft&&Ct(),_n=null,qt=!1,Ve=!1,Tn=!1,$i=!1,_s=!1,Wn=!1,we=[],xe=[],Yi=null,en=-1,Ie={targetId:null,type:null,count:0,timestamp:0},ve.style.cursor="crosshair",tt=null,$s=[],ze=null,Xn=null,co=null,qo=null,Ns=null,_n=null,ct=null}function Hu(){if(!st||!mt||ht.length===0)return;Ze();const e=q(mt);if(!e){Is();return}const t=xc(e.id);if(!t){Is();return}const n=t.angleRad;if(ht.length===1)return;const s=ht.length-1,i=(ln-1)%s+1,o=ht[i],a=o.length;let r;if(i===ht.length-1){const m=ht.length>2?1:0;r=ht[m].turn}else r=o.turn;let c,l;if(i===ht.length-1){const m=[ht[0].endVertexColor,ht[1].endVertexColor],x=(ln-1)%m.length;l=m[x];const S=ln%m.length;c=m[S],e.color=l}else c=o.endVertexColor;const d=$n(n+r),f=e.x+a*Math.cos(d),h=e.y+a*Math.sin(d);let u=null,p=!1;const g=Ke*2/he.scale;for(const m of pe)if(m.type==="regular"&&ae({x:f,y:h},m)<g){u=m,p=!0;break}p||(u={id:Ut(),x:f,y:h,type:"regular",color:c},pe.push(u)),K.some(m=>m.id1===e.id&&m.id2===u.id||m.id2===e.id&&m.id1===u.id)||K.push({id1:e.id,id2:u.id,color:Ge(Je)}),jn&&(se=sa(K,q),vs()),Le.push(u.id),window.currentDrawingPath=Le,_c(),Dc(),mt=u.id,ln++,ln>=ht.length&&(ln=1),It=null,Ss=null,Kt=null,xs=null,qn=null}function kc(){Ac(),requestAnimationFrame(kc)}function Wu(e){if(ge.length===0)return!1;const t=Io(e,ve);for(const n of ge){const s=se.find(o=>o.id===n);if(!s||!s.localCoordSystem)continue;const i=bh(t,s,Ce);if(i)return Un=!0,wn=i,qo=s.id,zi=Ku(s),i.type==="center"&&(s.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function Ku(e){const t=[],n=[],s=[],i=[],o=[];e.vertexIds.forEach(a=>{const r=q(a);r&&r.type==="regular"&&t.push({...r,id:a})});for(let a=0;a<t.length;a++){const r=t[a],c=t[(a+1)%t.length];n.push({x:(r.x+c.x)/2,y:(r.y+c.y)/2,v1:r.id,v2:c.id}),s.push(r.id,c.id),o.push(Math.atan2(c.y-r.y,c.x-r.x))}return se.forEach(a=>{a.id!==e.id&&a.localCoordSystem&&i.push(a.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:s,faceCenters:i,edgeAngles:o}}function Qa(e,t){const n=e.vertexIds[t],s=e.vertexIds[(t+1)%e.vertexIds.length],i=q(n),o=q(s);return i&&o?{v1Id:n,v2Id:s,edgeAngle:Math.atan2(o.y-i.y,o.x-i.x)}:null}function qu(e,t){if(e.length===0||t&&t.transformType===xn||!t)return;const i=new Set;e.forEach(a=>{Za(a).forEach(r=>i.add(r))});const o=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;i.forEach(a=>{const r=q(a.id1),c=q(a.id2);if(!r||!c)return;const l=r.x-c.x,d=r.y-c.y,f=l/o,h=d/o,u=1e-5;if(o&&Math.abs(f-Math.round(f))<u&&Math.abs(h-Math.round(h))<u){a.labelMode="exact";const g=Math.round(f),y=Math.round(h);a.exactValue={g2gSquaredSum:g*g+y*y,gridInterval:o}}else a.labelMode="decimal",delete a.exactValue})}function ju(){if(Wt){Ze();let e=se.find(t=>t.id===Wt);if(e)e.color=Ge(at),Ki();else{const n=sa(K,q).find(s=>s.id===Wt);n&&(n.color=Ge(at),se.push(n),Ki(),vs())}Wt=null}bt.style.display="none"}function Uu(e,t){const n=[],s=t.find(a=>a.id===e);if(!s)return[];const i=[...s.childFaceIds||[]],o=new Set(s.childFaceIds);for(;i.length>0;){const a=i.shift(),r=t.find(c=>c.id===a);r&&(n.push(r),r.childFaceIds&&r.childFaceIds.forEach(c=>{o.has(c)||(o.add(c),i.push(c))}))}return n}function Ju(e,t,n,s,i){if(!t.isCustom){const l=e.vertexIds.map(d=>s.find(f=>f.id===d)||i(d)).filter(d=>d&&d.type==="regular");if(l.length>=3){const d=na(l);d&&(e.localCoordSystem.origin=d.center,e.localCoordSystem.scale=d.radius)}return}let o={...t.origin},a=t.angle,r=t.scale;if(e.localCoordSystem.attachedToVertex){const l=s.find(d=>d.id===e.localCoordSystem.attachedToVertex);l&&(o={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=s.find(f=>f.id===e.localCoordSystem.attachedToEdge.v1)||i(e.localCoordSystem.attachedToEdge.v1),d=s.find(f=>f.id===e.localCoordSystem.attachedToEdge.v2)||i(e.localCoordSystem.attachedToEdge.v2);l&&d&&(o={x:l.x+e.localCoordSystem.attachedToEdge.t*(d.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(d.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=s.find(f=>f.id===e.localCoordSystem.rotationAlignedToEdge.v1)||i(e.localCoordSystem.rotationAlignedToEdge.v1),d=s.find(f=>f.id===e.localCoordSystem.rotationAlignedToEdge.v2)||i(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&d){const f=Math.atan2(d.y-l.y,d.x-l.x),h=e.localCoordSystem.rotationAlignedToEdge.originalAngle,p=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-h;a=$n(f+p),e.localCoordSystem.rotationAlignedToEdge.originalAngle=f,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(e.localCoordSystem.scaleAttachedToEdge){const l=s.find(f=>f.id===e.localCoordSystem.scaleAttachedToEdge.v1)||i(e.localCoordSystem.scaleAttachedToEdge.v1),d=s.find(f=>f.id===e.localCoordSystem.scaleAttachedToEdge.v2)||i(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&d){const f=ae(l,d);r=f*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=f}}const c=e.vertexIds.map(l=>s.find(d=>d.id===l)||i(l)).filter(l=>l&&l.type==="regular");c.length>=3&&(e.localCoordSystem.origin=lo(o,c),e.localCoordSystem.angle=a,e.localCoordSystem.scale=Math.max(.01,r),e.localCoordSystem.isCustom=!0)}function Zu(e,t){const n=new Map;return e.forEach(s=>{const i=[...new Set(s.vertexIds.map(o=>t(o)))];if(i.length>=3){const o=fe({vertexIds:i});if(s.localCoordSystem&&s.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(s.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=t(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=t(a.attachedToEdge.v1),a.attachedToEdge.v2=t(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=t(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=t(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=t(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=t(a.scaleAttachedToEdge.v2)),n.set(o,a)}}}),n}function Qu(e){bt.innerHTML="",bt.style.display="none",j=Io(e,ve);const t=po(j),n=t?null:yo(j),s=!t&&!n?mo(j):null;if(t||n||s){let d=!1;t?d=be.includes(t.id):n?d=Se.includes(re(n)):s&&(d=ge.includes(fe(s))),d||(be=[],Se=[],ge=[],Fe=[],Pe=[],t?be=[t.id]:n?Se=[re(n)]:s&&(ge=[fe(s)]))}else Is();const o=Oe(j);let a=[];Wt=null,Qs=null,Zs=null;const r=(be.length>0?1:0)+(Se.length>0?1:0)+(ge.length>0?1:0),c=po(j),l=c?null:yo(j);if(c&&c.type==="regular"){Zs=c.id;const d=r>1?"Remove Geometry":"Remove Vertex";a.push({text:d,handler:hg})}else if(l){Qs=re(l);const d=r>1?"Remove Geometry":"Remove Edge";a.push({text:d,handler:fg})}else{const d=mo(j);if(d){Wt=fe(d);const f=r>1?"Remove Geometry":"Remove Face";a.push({text:f,handler:ug}),d.childFaceIds&&d.childFaceIds.length>0&&a.push({text:"Remove Face and Children",handler:dg})}else{const f=sa(K,q);let h=null,u=1/0;f.forEach(p=>{const g=p.vertexIds.map(y=>q(y));if(g.every(Boolean)&&Rs(o,g)){const y=Math.abs(ta(g));y<u&&(u=y,h=p)}}),h&&(Wt=h.id||fe(h),a.push({text:"Add Face",handler:ju}))}}if(a.length>0){const d=document.createElement("ul");a.forEach(f=>{const h=document.createElement("li");h.textContent=f.text,h.addEventListener("click",f.handler),d.appendChild(h)}),bt.appendChild(d),bt.style.left=`${e.clientX-Wr}px`,bt.style.top=`${e.clientY-Wr}px`,bt.style.display="block"}}function eg(e){if(bn){for(const t of H.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[Qi,dr,Lo,ea];Fs=n[(n.indexOf(Fs)+1)%n.length];break;case"grid":const s=[hr,fr,ur,gr,Wo];yt=s[(s.indexOf(yt)+1)%s.length];break;case"angles":const i=[ks,Ko,Oo];Qt=i[(i.indexOf(Qt)+1)%i.length],es=Qt!==Oo;break;case"distances":const o=[No,rh];ui=o[(o.indexOf(ui)+1)%o.length],On=ui===No;break;case"theme":ag();break}return!0}}return!1}function tg(e){if(!dn)return!1;for(const t of H.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationRemove"){const n=Se.length>0||ge.length>0||be.length>0;n&&uu();const s=hc()||Os;return s&&s!==En.id?(yn=yn.filter(i=>i.id!==s),Os===s&&Ii(En.id),Ar(),Zt()):n||Ii(En.id),!0}if(t.type==="interpolationAdd")return Js?.initialize?.(),Js?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(di.id===t.styleId&&n-di.timestamp<Mi){const i=Go(t.styleId);return i&&(Js?.initialize?.(),Js?.show(i)),di={id:null,timestamp:0},!0}return di={id:t.styleId,timestamp:n},(Se.length>0||ge.length>0||be.length>0)&&fu(t.styleId),Ii(t.styleId),!0}}return!1}function ng(e){if(!hn)return!1;for(const t of H.colorModeIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.group==="edge"){const n=fo();n.length>0?(au(t.mode,n),Yn=t.mode):(Tt=t.mode,Ka())}else if(t.group==="face"){const n=uo();n.length>0?(ru(t.mode,n),Gn=t.mode):(_t=t.mode,Ka()),vs()}return Ct(),Wi(),Zt(),!0}return!1}function sg(e,t=!1,n=!1){const s=H.toolbarButton;if(e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return is=!is,is?mc():(ft=!1,hn=!1,dn=!1,Dn=!1,bn=!1,ia=!1,vt=!1,je=[]),!0;if(is){const i=H.colorToolButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return cg(),!0;const o=H.colorModeToolButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return hn=!hn,hn&&Wi(),!0;const a=H.interpolationToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return dn=!dn,dn&&Ar(),!0;const r=H.transformToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return Dn=!Dn,Dn&&bu(),!0;const c=H.visibilityToolButton;if(c&&e.x>=c.x&&e.x<=c.x+c.width&&e.y>=c.y&&e.y<=c.y+c.height)return bn=!bn,bn&&Iu(),!0;const l=H.sessionsToolButton;if(l&&e.x>=l.x&&e.x<=l.x+l.width&&e.y>=l.y&&e.y<=l.y+l.height)return vt=!vt,vt&&(kt=nn,ra()),!0}if(ft&&zu(e)||hn&&ng(e)||dn&&tg(e))return!0;if(Dn){for(const i of H.transformIcons)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return sn?ho=i.type:(sn=!0,ho=i.type,ve.style.cursor="none"),!0}if(bn&&eg(e))return!0;if(vt&&H.sessionsPanelBounds){const i=H.sessionsPanelBounds;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return _u(),!0}return!!_r(e)}function og(){if(Mt.length===0)return;const e=Qo();Me.length,Me[0]?.value,pe.length,hs.push(e),hs.length>lr&&hs.shift();const t=Mt.pop();Zo(t),Me.length,Me[0]?.value,pe.length,Jt()}function ig(){if(hs.length===0)return;const e=Qo();Mt.push(e),Mt.length>lr&&Mt.shift();const t=hs.pop();Zo(t),Jt()}function Or(e,t){const n=Oe(e),s=po(e),i=s?null:yo(e),o=!s&&!i?mo(e):null;if(s)ct={point:{x:s.x,y:s.y},element:{type:"vertex",id:s.id},shiftKey:t};else if(i){const a=q(i.id1),r=q(i.id2);if(a&&r){let c,l;const d=Dt(n,a,r);if(t){const f=Ah(d,a,r);c=f.point,l=f.fraction}else c={x:d.x,y:d.y},l=d.t;ct={point:c,element:{type:"edge",edge:i},shiftKey:t,fraction:l}}}else o?ct={point:n,element:{type:"face",id:fe(o)},shiftKey:t}:ct=null;mn=null,zt=null,Ft=null}function ag(){Ze(),Yo=Yo==="dark"?"light":"dark",xu(),ft&&Ct()}function rg(e){if(!Un||!wn)return!1;const t=Io(e,ve),n=Oe(t),s=wn,i=s.face,o=i.localCoordSystem,a=i.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular"&&r.x!==void 0&&r.y!==void 0);if(s.type==="center"){let r,c={snapped:!1};if(e.shiftKey){if(c=Th(n,zi,yt,Z,Cn),c.snapped){if(r=c.snapPoint,c.snapType==="edge"){const l=c.edgeInfo,d=q(l.v1),f=q(l.v2);d&&f&&(r=c.snapPoint,_n=null)}}else{const l=na(a);r=l?l.center:a[0]}s.type==="center"&&(ze=r)}else r=n,ze=null,_n=null;a.length>0&&a.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(r=lo(r,a),ze&&(ze=lo(ze,a))),o.origin.x=r.x,o.origin.y=r.y,o.isCustom=!0,c.snapped?(o.attachedToVertex=c.vertexId||null,o.attachedToEdge=c.edgeInfo||null):(o.attachedToVertex=null,o.attachedToEdge=null)}else if(s.type==="x_axis"||s.type==="y_axis"){const r={x:n.x-o.origin.x,y:n.y-o.origin.y};let c=Math.atan2(r.y,r.x),l=Math.hypot(r.x,r.y);if(Xn=null,co=null,Ns=null,$s=[],ze=null,_n=null,Bn=null,e.shiftKey){const d=Mh(n,o.origin,!0,zi);if(d.snapped){c=d.angle,co=c,Ns=d.snapType;const f={x:Math.cos(c),y:Math.sin(c)},h={x:n.x-o.origin.x,y:n.y-o.origin.y},u=h.x*f.x+h.y*f.y;if(d.snapType==="vertex_direction"){const p=q(d.targetVertexId);p&&(l=ae(o.origin,p),Bn=l)}else if(d.edgeIndex!==null){Xn=d.edgeIndex;const p=Qa(i,d.edgeIndex);if(p){const g=Math.abs(pt(c-p.edgeAngle))>Math.PI/4&&Math.abs(pt(c-p.edgeAngle))<3*Math.PI/4;if(s.type==="x_axis"&&g){const y=q(p.v1Id),m=q(p.v2Id);if(y&&m){const x=$l(o.origin,y,m),S=x.distance,I=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};I.forEach(T=>{const M=S*T,P=Math.abs(u-M);P<b.dist&&(b={scale:M,dist:P,fraction:T})});const E=15/he.scale;b.dist<E?(l=b.scale,Bn=l,_n={orthogonalDistanceFraction:b.fraction,v1:y,v2:m,snapPosition:{origin:o.origin,closest:x}}):(l=u>0?u:0,Bn=l)}}else{const y=Eh(o.origin,s.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:p},i,q,u,he,s.type);if(y.snapped){if(l=y.scale,Bn=l,y.edgeFraction!==null){const m={x:o.origin.x+l*Math.cos((s.type==="y_axis",c)),y:o.origin.y+l*Math.sin((s.type==="y_axis",c))};_n={edgeFraction:y.edgeFraction,v1:q(p.v1Id),v2:q(p.v2Id),snapPosition:m}}}else l=u>0?u:0}}}}else l=Math.hypot(r.x,r.y)}s.type==="y_axis"?o.angle=c-Math.PI/2:o.angle=c,l>.01&&(o.scale=l),o.isCustom=!0}return!0}function lg(){if(Un){const e=wn,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const s=yd;let i=null,o=null,a=1/0,r={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(c=>{const l=q(c);if(l&&l.type==="regular"){const d=ae(n.origin,l);d<a&&(a=d,d<s&&(i=c))}}),!i){for(let c=0;c<t.vertexIds.length;c++){const l=q(t.vertexIds[c]),d=q(t.vertexIds[(c+1)%t.vertexIds.length]);if(l&&d&&l.type==="regular"&&d.type==="regular"){const f=Dt(n.origin,l,d);f.distance<r.dist&&(r={dist:f.distance,t:f.t,v1:l.id,v2:d.id})}}if(r.dist<s){const c=ae(q(r.v1),q(r.v2));c>ye&&(o={v1:r.v1,v2:r.v2,t:r.t,originalLength:c,scaleRatio:n.scale/c})}}n.attachedToVertex=i,n.attachedToEdge=o}if(e.type==="x_axis"||e.type==="y_axis"){let s=!1,i=!1;if(Ns==="edge"&&Xn!==null){const o=Qa(t,Xn);o&&(n.rotationAlignedToEdge={v1:o.v1Id,v2:o.v2Id,originalAngle:o.edgeAngle,originalSystemAngle:n.angle},s=!0)}if(Bn!==null&&n.rotationAlignedToEdge){const o=Qa(t,Xn);if(o){const a=q(o.v1Id),r=q(o.v2Id);if(a&&r){const c=ae(a,r);c>ye&&(n.scaleAttachedToEdge={v1:o.v1Id,v2:o.v2Id,scaleRatio:n.scale/c,originalLength:c},i=!0)}}}s||(n.rotationAlignedToEdge=null),i||(n.scaleAttachedToEdge=null)}return Bn=null,_n=null,Un=!1,wn=null,zi=null,Xn=null,co=null,Ns=null,qo=null,ze=null,$s=[],!0}return!1}function cg(){ft=!ft,ft&&Ct()}function dg(){if(Wt){Ze();const e=se.find(t=>t.id===Wt);if(e){const t=Uu(e.id,se),n=new Set(t.map(o=>o.id)),s=new Set;t.forEach(o=>{o.vertexIds.forEach(a=>s.add(a))}),pe=pe.filter(o=>!s.has(o.id)),K=K.filter(o=>!s.has(o.id1)&&!s.has(o.id2));const i=new Set([e.id,...n]);se=se.filter(o=>!i.has(o.id)),Is()}Wt=null}bt.style.display="none"}function hg(){Zs&&(Ze(),be.includes(Zs)||(Se=[],ge=[],Fe=[],Pe=[],be=[Zs]),ti(),Zs=null),bt.style.display="none"}function fg(){Qs&&(Ze(),Se.includes(Qs)||(be=[],ge=[],Fe=[],Pe=[],Se=[Qs]),ti(),Qs=null),bt.style.display="none"}function ug(){Wt&&(Ze(),ge.includes(Wt)||(be=[],Se=[],Fe=[],Pe=[],ge=[Wt]),ti(),Wt=null),bt.style.display="none"}function gg(e){const t=Bl(j,H,{isToolbarExpanded:is,isColorPaletteExpanded:ft,isColorModePanelExpanded:hn,isInterpolationPanelExpanded:dn,isTransformPanelExpanded:Dn,isDisplayPanelExpanded:bn,isVisibilityPanelExpanded:ia,isSessionsPanelExpanded:vt});if(sn&&(!t||t.type!=="transformIcon")){Ze();const f=Oe(j),h=Re?bi(f):f,u={id:Ut(),x:h.x,y:h.y,type:ho};pe.push(u),Fe=[u.id],rt=u.id,be=[],Se=[],ge=[],Pe=[],sn=!1,ho=null,jo=null,ve.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!st){Or(j,e.shiftKey);const f=ct&&ct.element.type==="vertex"?q(ct.element.id):null,h=ct&&ct.element.type==="edge"?ct.element.edge:null,u=ct&&ct.element.type==="face"?se.find(p=>fe(p)===ct.element.id):null;if(f||h||u){Ze(),be=[],Se=[],ge=[],Fe=[],Pe=[],rt=null,je=[],ft&&Ct();const p=Z?.alpha2>=Z?.alpha1&&Z?.interval2?Z.interval2:Z?.interval1;if(f&&f.type==="regular")st=!0,mt=f.id,ht=[],ln=0,Le=[f.id],window.currentDrawingPath=Le;else if(h&&ct){const g=ct.point,y=Pc(h,g,p,Ge);y&&(st=!0,mt=y.id,ht=[],ln=0,Le=[y.id],window.currentDrawingPath=Le,Jt())}else if(u&&ct){const g=ct.point;let y=Ge(Ue);const m=_e[Ue];if(m!==-1){const S=Me[m];S&&S.type==="colormap"&&(y=Be(S,0))}const x={id:Ut(),...g,type:"regular",color:y};pe.push(x),st=!0,mt=x.id,ht=[],ln=0,Le=[x.id],window.currentDrawingPath=Le,Jt()}qt=!1,e.preventDefault();return}}if(qt=!0,Ve=!1,Wn=!1,ft){const f=(H.colorTargetIcons||[]).filter(h=>j.x>=h.x&&j.x<=h.x+h.width&&j.y>=h.y&&j.y<=h.y+h.height);if(f.length>0){const h=f[f.length-1],{element:u,shiftKey:p,ctrlKey:g}={element:h,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};p?je.includes(u.target)||je.push(u.target):g?je.includes(u.target)?je=je.filter(y=>y!==u.target):je.push(u.target):je=[u.target],Ct(),ce={target:"ui_icon_click",element:{...h,type:"colorTargetIcon"}},ve.style.cursor="default";return}for(const h of H.colorSwatches)if(j.x>=h.x&&j.x<=h.x+h.width&&j.y>=h.y&&j.y<=h.y+h.height){ce={target:"ui_swatch",element:{...h}},ve.style.cursor="default";return}}if(vt){const f=H.removeSessionButton;if(f&&j.x>=f.x&&j.x<=f.x+f.width&&j.y>=f.y&&j.y<=f.y+f.height){ce={target:"ui_session_remove"},ve.style.cursor="default";return}const h=H.addSessionButton;if(h&&j.x>=h.x&&j.x<=h.x+h.width&&j.y>=h.y&&j.y<=h.y+h.height){ce={target:"ui_session_add"},ve.style.cursor="default";return}for(const u of H.sessionIcons)if(j.x>=u.x&&j.x<=u.x+u.width&&j.y>=u.y&&j.y<=u.y+u.height){ce={target:"ui_session",element:{...u}},ve.style.cursor="default";return}}if(sg(j,e.shiftKey,e.ctrlKey||e.metaKey)){ce={target:"ui"},ve.style.cursor="default";return}if(Wu(e)){ce={target:"coord_system"};return}const n=pc(j);let s=n?null:po(j),i=!n&&!s?yo(j):null,o=!n&&!s&&!i?mo(j):null;if(n)gn("entityMouseDown",{type:ue.TEXT,id:n.id,button:e.button});else if(s){const f=s.type==="regular"?ue.VERTEX:ue.TRANSFORMATION_OBJECT;gn("entityMouseDown",{type:f,id:s.id,button:e.button})}else i?gn("entityMouseDown",{type:ue.EDGE,id:re(i),button:e.button}):o&&gn("entityMouseDown",{type:ue.FACE,id:fe(o),button:e.button});const a=e.shiftKey||e.ctrlKey||e.metaKey,r=n||s||i||o;let c=!1;n?c=Pe.includes(n.id):s?c=be.includes(s.id)||Fe.includes(s.id):i?c=Se.includes(re(i)):o&&(c=ge.includes(fe(o))),!st&&!a&&r&&!c&&(n?$t([],[],[],!1,!1,!1,[n.id]):s?$t([s.id],[],[],!1,!1,s.type!=="regular"):i?$t([],[re(i)],[],!1,!1):o&&$t([],[],[fe(o)],!1,!1));let l=null;if(n)l=Oe(j);else if(s)l=s;else if(i){const f=q(i.id1),h=q(i.id2);l=Dt(Oe(j),f,h)}else o&&(l=Oe(j));const d=rt&&(be.length>0||Se.length>0||ge.length>0||Pe.length>0);xe=[],we=[],ce={targetVertex:s,dragHandle:l,targetEdge:i,targetFace:o,targetText:n,target:r||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:d},s&&s.type!=="regular"&&(_s=!0,Pr(s.id,e.shiftKey,e.ctrlKey||e.metaKey))}function pg(){Ze();const e=[...be],t=[...Se],n=[...ge],s=[...Fe],i=rt;be=[],Se=[],ge=[],Fe=[],Pe=[],rt=null;const o=parseInt(jt,10)||1;let a=null;const r=Ve&&xe.length===1&&ce?.finalSnapResult?.snapType==="edge",c=new Set(eo.map(y=>y.id));if(c.size>0){const y=new Map(eo.map(P=>[P.id,P])),m=new Set(e);t.forEach(P=>{const[A,v]=P.split(ao);A&&m.add(A),v&&m.add(v)}),n.forEach(P=>{const A=se.find(v=>fe(v)===P);A&&wc(A.id,se).forEach(w=>m.add(w))});const x=tt?null:uc(),{center:S,rotation:I=0,scale:b=1,directionalScale:E=!1,startVector:T}=tt||{},M=-I*(180/Math.PI);We.forEach(P=>{if(!c.has(P.id))return;const A=y.get(P.id)||P,v=fc(A);if(A.anchorType!=="canvas"&&!v)return;const w=A.anchorType==="canvas"?A.position||P.position:v.anchor,_=A.anchorType==="canvas"?{x:0,y:0}:A.offset||{x:0,y:0},C=A.anchorType==="canvas"?A.position||P.position||{x:0,y:0}:{x:w.x+_.x,y:w.y+_.y},D=(()=>{if(A.anchorType==="vertex")return m.has(A.anchorId);if(A.anchorType==="edge"){if(t.includes(A.anchorId))return!0;const O=K.find(F=>re(F)===A.anchorId);return O?m.has(O.id1)&&m.has(O.id2):!1}if(A.anchorType==="face"){if(n.includes(A.anchorId))return!0;const O=se.find(F=>fe(F)===A.anchorId);return O?O.vertexIds.every(F=>m.has(F)):!1}return!1})();if(tt){const O=nt(C,S,I,b,E,T);if(P.rotationDeg=(A.rotationDeg||0)+M,P.scale=(A.scale||1)*b,A.anchorType==="canvas")P.position=O;else{const F=D?nt(w,S,I,b,E,T):w,V={x:O.x-F.x,y:O.y-F.y};if(P.offset=V,P.anchorType==="edge"){const N=qa(P.anchorId,V);typeof N=="number"&&(P.edgeOffsetFactor=N)}}}else if(x){if(A.anchorType==="canvas"){const O=A.position||P.position||{x:0,y:0};P.position={x:O.x+x.x,y:O.y+x.y}}else if(!D){const O=A.offset||{x:0,y:0},F={x:O.x+x.x,y:O.y+x.y};if(P.offset=F,P.anchorType==="edge"){const V=qa(P.anchorId,F);typeof V=="number"&&(P.edgeOffsetFactor=V)}}}})}if(r){const y=ce.finalSnapResult,m=xe[0].id,x=y.targetEdge,S=q(m);if(S&&x){const I=JSON.parse(JSON.stringify(K)),b=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;S.x=y.pos.x,S.y=y.pos.y,K=K.filter(v=>re(v)!==re(x));const E=q(x.id1),T=q(x.id2),M=Ls(E,S,b,Ge),P=Ls(T,S,b,Ge),A=x?.colorMode||Tt;Jn(M,A),Jn(P,A),Vs(M),Vs(P),K.push(M),K.push(P),Ys(I,K)}}else if(tt){const{center:y,rotation:m,scale:x,directionalScale:S,startPos:I}=tt,b={x:I.x-y.x,y:I.y-y.y};xe.forEach(E=>{const T=q(E.id);if(T){const M=nt(E,y,m,x,S,b);T.x=M.x,T.y=M.y}})}else if(we.length>0){const y=ce.finalSnapResult&&ce.finalSnapResult.snapped?ce.finalSnapResult.finalDelta:{x:we[0].x-xe[0].x,y:we[0].y-xe[0].y},m=xe.filter(x=>x.type==="regular");if(o>1&&m.length>0){const x=new Set(m.map(C=>C.id)),S=new Set(ge),I=new Set(Se);ge.forEach(C=>{const D=se.find(O=>fe(O)===C);D&&D.vertexIds.forEach(O=>x.add(O))});const b=new Set;ge.forEach(C=>{const D=se.find(O=>fe(O)===C);if(D)for(let O=0;O<D.vertexIds.length;O++){const F=D.vertexIds[O],V=D.vertexIds[(O+1)%D.vertexIds.length];b.add(re({id1:F,id2:V}))}});const E=K.filter(C=>{const D=re(C);return I.has(D)||b.has(D)?!0:x.has(C.id1)&&x.has(C.id2)}),T=ge.length>0?se.filter(C=>S.has(fe(C))):se.filter(C=>C.vertexIds.every(D=>x.has(D))),M=K.filter(C=>x.has(C.id1)&&!x.has(C.id2)||x.has(C.id2)&&!x.has(C.id1)),P=[],A=[],v=[];a={vertices:[],edges:[],faces:[],texts:[]};const w=new Set(Pe),_=We.filter(C=>{if(w.has(C.id))return!0;if(C.anchorType==="vertex")return x.has(C.anchorId);if(C.anchorType==="edge"){const D=K.find(O=>re(O)===C.anchorId);return D?x.has(D.id1)&&x.has(D.id2):!1}if(C.anchorType==="face"){if(S.has(C.anchorId))return!0;const D=se.find(O=>fe(O)===C.anchorId);return D?D.vertexIds.every(O=>x.has(O)):!1}return!1});for(let C=1;C<o;C++){const D=new Map,O=[],F=[],V=[],N=[];m.forEach($=>{const L={x:$.x+y.x*C,y:$.y+y.y*C},k={...$,...L,id:Ut()};P.push(k),D.set($.id,k.id),O.push(k.id)}),E.forEach($=>{const L=D.get($.id1),k=D.get($.id2);if(L&&k){const R=$.directionFrom===$.id2?k:L,X=$.directionFrom===$.id2?L:k,z={...$,id1:L,id2:k,directionFrom:R,directionTo:X};A.push(z),F.push(re(z))}}),M.forEach($=>{const L=x.has($.id1)?$.id2:$.id1,k=x.has($.id1)?$.id1:$.id2,R=D.get(k);if(R){const X=R,z=L,B=$.directionFrom===$.id2?z:X,Y=$.directionFrom===$.id2?X:z,G={...$,id1:X,id2:z,directionFrom:B,directionTo:Y};A.push(G)}}),T.forEach($=>{const L=ms.get($.id),k=$.vertexIds.map(R=>D.get(R));if(k.every(Boolean)){const R=JSON.parse(JSON.stringify($));if(R.id=fe({vertexIds:k}),R.vertexIds=k,R.localCoordSystem&&L){const X={x:y.x*C,y:y.y*C};R.localCoordSystem.origin.x=L.origin.x+X.x,R.localCoordSystem.origin.y=L.origin.y+X.y}v.push(R),V.push(R.id)}}),_.forEach($=>{const L=JSON.parse(JSON.stringify($));if(L.id=Ut(),$.anchorType==="canvas"){if(!L.position)return;L.position={x:L.position.x+y.x*C,y:L.position.y+y.y*C}}else if($.anchorType==="vertex"){const k=D.get($.anchorId);if(!k)return;L.anchorId=k}else if($.anchorType==="edge"){const k=K.find(z=>re(z)===$.anchorId);if(!k)return;const R=D.get(k.id1),X=D.get(k.id2);if(!R||!X)return;L.anchorId=re({id1:R,id2:X})}else if($.anchorType==="face"){const k=se.find(X=>fe(X)===$.anchorId);if(!k)return;const R=k.vertexIds.map(X=>D.get(X));if(!R.every(Boolean))return;L.anchorId=fe({vertexIds:R})}We.push(L),w.has($.id)&&N.push(L.id)}),C===1&&(a={vertices:O,edges:F,faces:V,texts:N})}pe.push(...P),K.push(...A),se.push(...v)}else o===1&&xe.forEach(x=>{const S=q(x.id);S&&(S.x=x.x+y.x,S.y=x.y+y.y)})}const l=new Set(xe.map(y=>y.id)),d=se.filter(y=>y.vertexIds.some(m=>l.has(m)));d.length>0&&d.forEach(y=>{const m=ms.get(y.id);if(y.localCoordSystem&&m){const x=new Set(y.vertexIds),S=new Set(xe.map(b=>b.id));if([...x].every(b=>S.has(b))){if(tt){const{center:b,rotation:E,scale:T,directionalScale:M,startPos:P}=tt,A={x:P.x-b.x,y:P.y-b.y},v=nt(m.origin,b,E,T,M,A);if(y.localCoordSystem.origin=v,M){const w=kn({x:1,y:0},m),_=nt(w,b,E,T,M,A);y.localCoordSystem.scale=ae(v,_)}else y.localCoordSystem.angle=$n(m.angle+E),y.localCoordSystem.scale=m.scale*T}else if(o===1){const b=ce.finalSnapResult&&ce.finalSnapResult.snapped?ce.finalSnapResult.finalDelta:{x:we[0].x-xe[0].x,y:we[0].y-xe[0].y};y.localCoordSystem.origin.x=m.origin.x+b.x,y.localCoordSystem.origin.y=m.origin.y+b.y}}else{const b=y.vertexIds.map(E=>q(E)).filter(Boolean);Ju(y,m,xe,b,q)}}}),qu(Array.from(l),tt);const{vertexMerges:f,edgeSplits:h}=Dg(pe,K,he),u=new Map;pe.forEach(y=>u.set(y.id,y.id));const p=y=>{if(!u.has(y)||u.get(y)===y)return y;const m=p(u.get(y));return u.set(y,m),m};f.forEach((y,m)=>{const x=p(m),S=p(y);x!==S&&u.set(S,x)});const g=new Set;if(pe.forEach(y=>{const m=p(y.id);y.id!==m&&g.add(y.id)}),g.size>0||h.size>0){const y=JSON.parse(JSON.stringify(K)),m=Zu(se,p);K.forEach(x=>{x.id1=p(x.id1),x.id2=p(x.id2)}),pe=pe.filter(x=>!g.has(x.id)),K=K.filter((x,S,I)=>x.id1!==x.id2&&S===I.findIndex(b=>re(b)===re(x))),Ys(y,K),se.forEach(x=>{const S=m.get(x.id);S&&(x.localCoordSystem=S)}),vs()}o>1&&a?(be=e.length>0?a.vertices.map(y=>p(y)):[],Se=t.length>0?a.edges:[],ge=n.length>0?a.faces:[],Pe=eo.length>0?a.texts:[]):o===1&&(be=e.map(y=>p(y)),Se=t,ge=n,Pe=eo.map(y=>y.id).filter(y=>We.some(m=>m.id===y))),Fe=s,rt=i,Ki(),Jt()}function yg(e){const{shiftKey:t,ctrlKey:n,targetVertex:s,targetEdge:i,targetFace:o,targetText:a}=e,r=q(mt);if(st&&r){Ze();const c=JSON.parse(JSON.stringify(K)),l=Jo(r,j,t);let d=null;const f=Z.alpha2>Z.alpha1&&Z.interval2?Z.interval2:Z.interval1;if(l.snapType==="vertex"&&l.targetVertex)d=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)d=Pc(l.targetEdge,{x:l.x,y:l.y},f,Ge);else{let h=Ge(Ue);const u=_e[Ue];if(u!==-1){const p=Me[u];p&&p.type==="colormap"&&(h=Be(p,.5))}d={id:Ut(),x:l.x,y:l.y,type:"regular",color:h},pe.push(d)}if(d){if(!K.some(p=>p.id1===r.id&&p.id2===d.id||p.id2===r.id&&p.id1===d.id)){const p=Ls(r,d,f,Ge);Jn(p,Tt),Vs(p),K.push(p),Ys(c,K),Ki(),se.forEach(g=>{g.colorMode=g.colorMode||_t,Uo(g,g.colorMode)})}const u=Pl(r,d,K);u&&(ht.length>0&&(ht[ht.length-1].turn=u.turnAngleRad),ht.push({length:u.length,turn:0,endVertexColor:d.color}),ln=ht.length-1,qn=u.startVertex,It=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,Ss=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Kt=u.turnAngleRad,xs=u.precedingSegmentAbsoluteAngleRad),Le.push(d.id),window.currentDrawingPath=Le,_c(),Dc(),Jt(),mt=d.id}if(t&&d&&l){const h=Pl(r,d,K);h&&(qn=h.startVertex,It=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):h.length,Ss=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Kt=h.turnAngleRad,xs=h.precedingSegmentAbsoluteAngleRad)}Ie.count=0}else if(e.target==="canvas"){Ze();const c=ze||Oe(j);let l=Ge(Ue);const d=_e[Ue];if(d!==-1){const h=Me[d];h&&h.type==="colormap"&&(l=Be(h,0))}const f={id:Ut(),...c,type:"regular",color:l};pe.push(f),st=!0,mt=f.id,ht=[],ln=0,Le=[f.id],window.currentDrawingPath=Le,Jt()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(a||s||i||o)){Ze();const l=a?a.id:o?fe(o):i?re(i):s.id;let d;switch(a?d="text":o?d="face":s&&s.type!=="regular"?d="center":s?d="vertex":i&&(d="edge"),l&&Ie.targetId===l&&Date.now()-Ie.timestamp<Mi?Ie.count++:Ie.count=1,Ie.targetId=l,Ie.type=d,Ie.timestamp=Date.now(),Ie.count){case 1:Ie.type==="text"?$t([],[],[],t,n,!1,[Ie.targetId]):Ie.type==="face"?$t([],[],[Ie.targetId],t,n):Ie.type==="edge"?$t([],[Ie.targetId],[],t,n):Ie.type==="vertex"?$t([Ie.targetId],[],[],t,n):Ie.type==="center"&&Pr(Ie.targetId,t,n);break;case 2:if(Ie.type==="text"){const f=go(Ie.targetId);f&&yc(f,f.content||"")}else if(Ie.type==="vertex"){const f=In(Ie.targetId,K);$t([Ie.targetId,...f],[],[],t,n)}else if(Ie.type==="edge"){const f=K.find(h=>re(h)===Ie.targetId);if(f){const h=[...Za(f.id1),...Za(f.id2)];$t([],Array.from(new Set(h.map(u=>re(u)))),[],t,n)}}else if(Ie.type==="face"){const f=se.find(h=>fe(h)===Ie.targetId);if(f){const h=[],u=new Set;for(let p=0;p<f.vertexIds.length;p++){const g=f.vertexIds[p],y=f.vertexIds[(p+1)%f.vertexIds.length];u.add(re({id1:g,id2:y}))}se.forEach(p=>{if(fe(p)!==fe(f))for(let g=0;g<p.vertexIds.length;g++){const y=p.vertexIds[g],m=p.vertexIds[(g+1)%p.vertexIds.length];if(u.has(re({id1:y,id2:m}))){h.push(fe(p));break}}}),$t([],[],[fe(f),...h],t,n)}}break;case 3:if(Ie.type==="vertex"||Ie.type==="edge"||Ie.type==="face"){let f;if(Ie.type==="vertex")f=Ie.targetId;else if(Ie.type==="edge")f=Ie.targetId.split(ao)[0];else if(Ie.type==="face"){const h=se.find(u=>fe(u)===Ie.targetId);h&&(f=h.vertexIds[0])}if(f){const h=new Set(Xs(f));if(Ie.type==="vertex")$t(Array.from(h),[],[],t,n);else if(Ie.type==="edge"){const u=K.filter(p=>h.has(p.id1)&&h.has(p.id2)).map(p=>re(p));$t([],u,[],t,n)}else if(Ie.type==="face"){const u=se.filter(p=>p.vertexIds.every(g=>h.has(g))).map(p=>fe(p));$t([],[],u,t,n)}}}Ie.count=0;break}Lr()}}}function mg(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),s=`icon-${t.target}`;if(Ie.targetId===s&&n-Ie.timestamp<Mi){switch(Ze(),t.target){case Ue:Ni=!Ni;break;case Je:Fi=!Fi;break;case at:jn=!jn;break}Ct(),Ie.count=0}Ie.targetId=s,Ie.timestamp=n,Ot=null;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),s=`swatch-${t.index}`;if(!(be.length>0||Se.length>0||ge.length>0||Pe.length>0)&&je.length===0?Ot=t.index:Ot=null,Ie.targetId===s&&n-Ie.timestamp<Mi){Vi=!0,Do=t.index;const o=Me[t.index];let a;if(o.type==="color"){const r=ys(o.value);a={type:"colormap",points:[{pos:.5,alpha:r.a,color:[r.r,r.g,r.b],order:1}]}}else o.type==="colormap"&&(a={type:"colormap",points:o.vertices.map(r=>({pos:r.pos,alpha:r.alpha!==void 0?r.alpha:1,color:Array.isArray(r.color)?[...r.color]:[r.color.r||0,r.color.g||0,r.color.b||0],order:r.order||1})),isCyclic:o.isCyclic===!0});ts.show(void 0,void 0,a),Ie.count=0}else je.length>0&&(Ze(),je.forEach(o=>_e[o]=t.index),Cr(),Ct(),Ot=null);Ie.targetId=s,Ie.timestamp=n;return}if(e.target==="ui_session"){const{element:t}=e;t&&t.index!==void 0&&zs(t.index);return}if(e.target==="ui_session_add"){wu();return}if(e.target==="ui_session_remove"){kt!==null&&Tc(kt);return}}function xg(e){if(to||fs||Ro){if(to){if(H.colorTargetIcons.find(n=>n.target===Xt.target)){const n=H.colorSwatches,s=Xl(j,n);s&&(_e[Xt.target]=s.index,Hi(Xt.target).forEach(i=>{_e[i]=s.index}),Cr())}}else if(fs){const t=H.removeColorButton;if(t&&j.x>=t.x&&j.x<=t.x+t.width&&j.y>=t.y&&j.y<=t.y+t.height&&Me.length>1){const s=Me.indexOf(St.item);s!==-1&&Ja(s)}else if(St&&St.previewIndex!==null&&St.previewIndex!==void 0){const s=St.originalIndex,i=St.previewIndex;if(s!==i&&s>=0&&i>=0){const o=[...St.originalAllColors],[a]=o.splice(s,1);o.splice(i,0,a),Me=o;const r={...St.originalAssignments};Object.keys(r).forEach(c=>{const l=r[c];l===s?r[c]=i:s<i&&l>s&&l<=i?r[c]=l-1:s>i&&l>=i&&l<s&&(r[c]=l+1)}),_e=r}}}else if(Ro){const t=H.removeSessionButton;t&&j.x>=t.x&&j.x<=t.x+t.width&&j.y>=t.y&&j.y<=t.y+t.height&&Si&&Tc(Si.index)}to=!1,Xt=null,fs=!1,St=null,Ro=!1,Si=null,ft&&Ct(),vt&&ra()}else Ve?pg():ce&&(typeof ce.target=="string"&&ce.target.startsWith("ui")?mg(ce):yg(ce));Nc()}function Sg(e){qt=!0,Tn=!1,Xi=cn,ce={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function Ig(e){if(Ve&&Tn){const t=Oe({x:Math.min(cn.x,j.x),y:Math.min(cn.y,j.y)}),n=Oe({x:Math.max(cn.x,j.x),y:Math.max(cn.y,j.y)}),s=Math.min(t.x,n.x),i=Math.max(t.x,n.x),o=Math.min(t.y,n.y),a=Math.max(t.y,n.y),r=pe.filter(h=>h.type==="regular"&&h.x>=s&&h.x<=i&&h.y>=o&&h.y<=a).map(h=>h.id),c=pe.filter(h=>h.type!=="regular"&&h.x>=s&&h.x<=i&&h.y>=o&&h.y<=a).map(h=>h.id),l=new Set(r),d=K.filter(h=>l.has(h.id1)&&l.has(h.id2)).map(h=>re(h)),f=se.filter(h=>h.vertexIds.every(u=>l.has(u))).map(h=>fe(h));ce.shiftKey?(be=[...new Set([...be,...r])],Se=[...new Set([...Se,...d])],ge=[...new Set([...ge,...f])],Fe=[...new Set([...Fe,...c])]):ce.ctrlKey?(r.forEach(h=>{const u=be.indexOf(h);u>-1?be.splice(u,1):be.push(h)}),d.forEach(h=>{const u=Se.indexOf(h);u>-1?Se.splice(u,1):Se.push(h)}),f.forEach(h=>{const u=ge.indexOf(h);u>-1?ge.splice(u,1):ge.push(h)}),c.forEach(h=>{const u=Fe.indexOf(h);u>-1?Fe.splice(u,1):Fe.push(h)})):(be=r,Se=d,ge=f,Fe=c),Lr(),lc()}else{if(vt&&H.sessionsPanelBounds){const n=H.sessionsPanelBounds;if(j.x>=n.x&&j.x<=n.x+n.width&&j.y>=n.y&&j.y<=n.y+n.height){Du();return}}Qu(e);const t=be.length>0||Se.length>0||ge.length>0||Pe.length>0;Ot=null,t||(je=[]),ft&&Ct()}}function bg(e){e.preventDefault();const t=Io(e,ve),n=e.deltaY>0?1/1.15:1.15;qi(t,n),gn("wheel",e),Bt()}function vg(){Xo=!0,Bt()}function Mg(){Xo=!1,Ac(),Bt()}function Eg(e){e.preventDefault(),Bt()}function Tg(e,t){const n=parseInt(jt||"1",10)||1,s=Bh(xe,pe,K,q,e,n,he),i=s.finalDelta;xe.forEach(o=>{const a=we.find(r=>r&&r.id===o.id);a&&(a.x=o.x+i.x,a.y=o.y+i.y)}),Lc(i,s),ce.finalSnapResult=s}function Cg(e){if(jn&&pe.length>0&&(Gl(ke,{allFaces:se,hoveredFaceId:Ft,selectedFaceIds:ge,colors:e,isDragConfirmed:Ve,dragPreviewVertices:we,currentAltPressed:Et},Ce,q,fe),ge.length>0&&Ql(ke,{allFaces:se,selectedFaceIds:ge,colors:e,isDragConfirmed:Ve,dragPreviewVertices:we,initialDragVertexStates:xe,transformIndicatorData:tt,highlightedEdgeForSnap:Xn,draggedFaceId:qo,coordSystemSnapAngle:co,coordSystemSnapType:Ns,coordSystemSnapScale:Bn,initialCoordSystemStates:ms},Ce,q)),st&&Re&&(It!==null||Kt!==null)&&Le.length>=1&&qn){const s=q(qn.id);if(s){const i={frozen_Origin_Data_to_display:s,displayAngleA_valueRad_for_A_equals_label:Kt,frozen_A_baseRad_to_display:xs,frozen_D_du_to_display:It,frozen_D_g2g_to_display:Ss};ff(ke,i,Ce,Oe,{showAngles:es,showDistances:On,viewTransform:he,mousePos:j,colors:e}),uf(gt,i,{showAngles:es,showDistances:On,viewTransform:he,mousePos:j,frozenReference_D_du:It,distanceSigFigs:Es,angleDisplayMode:Qt,colors:e},Oe,Ce,Lt)}}const t={lastGridState:Z,showDistances:On,showAngles:es,distanceSigFigs:Es,angleDisplayMode:Qt,angleSigFigs:gi,currentShiftPressed:Re,viewTransform:he,colors:e};if(Ve){const s=new Set(xe.map(a=>a.id));let i=!1;if(xe.length>0){const a=new Set(Xs(xe[0].id));i=!(s.size===a.size&&[...s].every(r=>a.has(r)))}const o=pe.map(a=>we.find(c=>c.id===a.id)||a);if(i&&Re)xe.forEach(a=>{In(a.id,K).some(c=>!s.has(c))&&_o(ke,gt,a.id,o,t,Ce,c=>In(c,K),re,Re,null,Lt,be,!0,xe,rt,At)});else if(ce&&(ce.targetVertex||ce.targetEdge)){const a=ce.targetVertex?ce.targetVertex.id:xe[0]?.id;a&&_o(ke,gt,a,o,t,Ce,r=>In(r,K),re,Re,null,Lt,be,!0,xe,rt,At),ce.targetEdge&&Sl(ke,gt,Se,K,{showDistances:On,distanceSigFigs:Es,colors:e,lastGridState:Z,currentShiftPressed:Re},q,re,Ce,Lt,we,xe,tt)}}else(On||es)&&!st&&!(parseInt(jt||"1",10)>1&&Ve)&&!sn&&(be.length>0&&be.length<=Jd&&be.forEach(s=>{_o(ke,gt,s,pe,{...t,currentShiftPressed:!1},Ce,i=>In(i,K),re,!1,null,Lt,be,!1,[],rt)}),Se.length>0&&Se.length<=Zd&&(Sl(ke,gt,Se,K,{showDistances:On,distanceSigFigs:Es,colors:e,lastGridState:Z},q,re,Ce,Lt,we,xe,tt),kf(ke,gt,Se,K,{showAngles:es,angleSigFigs:gi,angleDisplayMode:Qt,currentShiftPressed:Re,distanceSigFigs:Es,viewTransform:he,lastGridState:Z,colors:e},q,re,Ce,s=>In(s,K),Lt)));const n=!Et&&(mn||zt||Ft);if(st&&mt&&!n){const s=q(mt);if(s){const i=Rr(s.id),o=Jo(s,j,Re);let a=Ge(Je),r=null;const c=_e[Je];if(c!==-1){const f=Me[c];if(f&&f.type==="colormap"&&Le&&Le.length>=1){const h=Le.length,u=Le.length-1,p=h>1?u/(h-1):0,g=h>1?(u+1)/h:1;r={colormapItem:f,startT:p,endT:g}}}Hl(ke,{startVertex:s,snappedData:o,isShiftPressed:Re,currentColor:Ge(Ue),nextCreationColor:Ge(Ue),nextEdgeColor:a,colors:e,edgeColormapInfo:r,interpolationStyle:zo()},Ce);const l={x:o.x,y:o.y};ql(ke,gt,s,l,o,{showDistances:On,showAngles:es,currentShiftPressed:Re,distanceSigFigs:Es,angleSigFigs:gi,angleDisplayMode:Qt,viewTransform:he,frozenReference_D_du:It,gridDisplayMode:yt,frozenReference_A_rad:Kt,colors:e},Ce,i,Lt)}}if(ze&&!n){const s={...ze,id:"ghost",type:"regular"};Di(ke,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:An==="vertex"||An==="edge_fraction"||An==="edge"?An:null,currentAltPressed:Et},Ce)}if(Tn&&Ve&&Df(ke,Xi,j,e),nf(ke,{info:{...Oi,startVertex:q(mt)},colors:e},Ce,q,Lt),(tt||_n)&&lf(ke,gt,{transformIndicatorData:tt,colors:e,coordSystemTransformIndicatorData:_n,currentShiftPressed:Re},Ce,Lt),ze&&!n){const s={...ze,id:"ghost",type:"regular"},i=An==="vertex"||An==="edge_fraction"||An==="edge";i?Di(ke,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:i?An:null,currentAltPressed:Et},Ce):mr(ke,s,{colors:e,verticesVisible:!0,isSnapped:!0},Ce)}}function wg(e){if(mn=null,zt=null,Ft=null,Bi=null,ze=null,An=null,!qt){if(!Et){const o=pc(e);if(o){Bi=o.id;return}}const t=po(e),n=t?null:yo(e),s=!t&&!n?mo(e):null,i=t||n||s;if(Et)i?Or(e,Re):ct=null,mn=null,zt=null,Ft=null;else if(t?mn=t.id:n?zt=re(n):s&&(Ft=s.id),Re&&!i){Oe(e);const o=Jo({id:"dummy_start",x:0,y:0},e,!0);o.snapped&&(ze={x:o.x,y:o.y},An=o.snapType)}}}function Pg(e){if(mt){const t=q(mt);if(t)if(Re){const n=Jo(t,e,Re);Oi=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else Oi=null}ze=null}function Ag(e,t,n,s){const i=Nu(n,e,t,s,xi);let o={},a={};if(s===xn)o=Bu(n,xe,t,i.rotation,e),a={rotation:o.rotation,scale:1,directionalScale:!1},xi=i.rotation;else if(s===Zn)o=$u(n,xe,t,i.scale),a={rotation:0,scale:o.scale||i.scale,directionalScale:!1};else if(s===Mn)o=Fu(n,xe,t,i.rotation,i.scale),a={rotation:o.rotation,scale:o.scale,directionalScale:!1},xi=i.rotation;else if(s===bs){const f={x:t.x-n.x,y:t.y-n.y};o=Vu(n,xe,t,i.scale,f,e),a={rotation:0,scale:o.scale||i.scale,directionalScale:!0}}o.snapped&&o.snapType==="projection"&&o.projectionSource&&(ze=o.projectionSource);const r={x:t.x-n.x,y:t.y-n.y};tt={center:n,startPos:t,currentPos:o.pos||e,rotation:a.rotation,scale:a.scale,isSnapping:o.snapped||!1,transformType:s,directionalScale:a.directionalScale,snappedScaleValue:o.snappedScaleValue||null,gridToGridInfo:o.gridToGridInfo||null,gridPoint:o.gridPoint||null,nearbyVertex:o.nearbyVertex||null,projectionPoint:o.projectionPoint||null,projectionSource:o.projectionSource||null,snapType:o.snapType||null,projectionCenter:o.snapType==="projection"?n:null,projectionHandleInitial:o.projectionHandleInitial||null,startVector:r};const c={x:t.x-n.x,y:t.y-n.y};if(we=xe.map(f=>{const h=nt(f,n,a.rotation,a.scale,a.directionalScale,c);return{...f,x:h.x,y:h.y}}),o.snapped&&o.snapType==="merge"&&o.mergingVertex&&o.mergeTarget){const f=xe.find(h=>h.id===o.mergingVertex.id);if(f){const h=we.find(u=>u.id===f.id);if(h){const u={x:o.mergeTarget.x-h.x,y:o.mergeTarget.y-h.y};we.forEach(p=>{p.x+=u.x,p.y+=u.y}),tt.currentPos&&(tt.currentPos.x+=u.x,tt.currentPos.y+=u.y)}}}const l=Ke*2/he.scale,d=pe.filter(f=>f.type==="regular"&&!xe.some(h=>h.id===f.id));we.forEach(f=>{f.type==="regular"&&d.forEach(h=>{ae(f,h)<l&&$s.push({x:h.x,y:h.y})})});for(let f=0;f<we.length;f++)for(let h=f+1;h<we.length;h++){const u=we[f],p=we[h];u.type==="regular"&&p.type==="regular"&&ae(u,p)<l&&$s.push({x:(u.x+p.x)/2,y:(u.y+p.y)/2})}}function _g(e){if(to&&Xt){const t=H.colorTargetIcons.find(n=>n.target===Xt.target);if(t){const n=[...H.colorSwatches],s=Xl(e,n);s?(t.x=s.x+(s.width-t.width)/2,t.y=s.y-t.height-5,Xt.previewColorIndex=s.index,Hi(Xt.target).forEach(i=>{const o=H.colorTargetIcons.find(a=>a.target===i);o&&(o.x=t.x,o.y=t.y)})):(t.x=e.x-Xt.offsetX,t.y=e.y-Xt.offsetY,Xt.previewColorIndex=Xt.originalColorIndex,Hi(Xt.target).forEach(i=>{const o=H.colorTargetIcons.find(a=>a.target===i);o&&(o.x=t.x,o.y=t.y)}))}return!0}if(fs){const t=St.originalIndex,n=H.colorSwatches.filter(i=>i.index!==t);let s=n.length;for(let i=0;i<n.length;i++){const o=n[i],a=o.x+o.width/2;if(e.x<a){s=i;break}}return St.previewIndex!==s&&(St.previewIndex=s,Ct()),!0}return!!Ro}function Nr(){if(qt||st){ct=null,ze=null,mn=null,zt=null,Ft=null;return}Et?Or(j,Re):(ct=null,wg(j))}function Rc(e){if(j=Io(e,ve),Re=e.shiftKey,Et=e.altKey,bo=e.ctrlKey||e.metaKey,_r(j)?ve.style.cursor="default":sn?ve.style.cursor="none":Wn||Ve?ve.style.cursor="grabbing":ve.style.cursor="crosshair",qt){if(!Ve&&ae(j,cn)>bd&&!st){if(Ve=!0,ce&&ce.target==="coord_system")return;if(Yi=ce.dragHandle,$i=ce.target==="edge",ce.target==="ui_icon_click"){to=!0;const t=ce.element.target;Xt={target:t,offsetX:j.x-ce.element.x,offsetY:j.y-ce.element.y,originalColorIndex:_e[t],previewColorIndex:_e[t]},ce.target="ui_icon_drag",je=[t,...Hi()]}else if(ce.target==="ui_swatch")Ze(),fs=!0,St={index:ce.element.index,item:ce.element.item,offsetX:j.x-ce.element.x,originalIndex:ce.element.index,originalAllColors:JSON.parse(JSON.stringify(Me)),originalAssignments:JSON.parse(JSON.stringify(_e)),previewIndex:ce.element.index};else if(ce.target==="ui_session")Ro=!0,Si={index:ce.element.index,session:ce.element.session,offsetX:j.x-ce.element.x,offsetY:j.y-ce.element.y},ce.target="ui_session_drag";else if(en===2){Tn=!0;return}else if(ce.target==="canvas")Wn=!0,Pa={x:he.offsetX,y:he.offsetY},ve.style.cursor="move";else{ve.style.cursor="grabbing",_s=ce.targetVertex&&ce.targetVertex.type!=="regular"&&!ce.isTransformDrag;let n;if(_s)n=[ce.targetVertex];else{let i=new Set(be);Se.forEach(o=>{const[a,r]=o.split(ao);i.add(a),i.add(r)}),ge.forEach(o=>{const a=se.find(r=>fe(r)===o);a&&wc(a.id,se).forEach(c=>i.add(c))}),n=Array.from(i).map(o=>q(o)).filter(o=>o&&o.type==="regular")}if(_s&&ce.targetVertex.type===xn){const i=ce.targetVertex,o=Oe(cn),a={x:o.x-i.x,y:o.y-i.y};ce.initialRotationStartAngle=Math.atan2(a.y,a.x),xi=0}const s=Pe.map(i=>go(i)).filter(Boolean);if(n.length>0||s.length>0){xe=JSON.parse(JSON.stringify(n)),we=JSON.parse(JSON.stringify(n)),eo=JSON.parse(JSON.stringify(s)),Ha=JSON.parse(JSON.stringify(s)),ms.clear();const i=new Set(xe.map(o=>o.id));se.forEach(o=>{o.vertexIds.some(a=>i.has(a))&&o.localCoordSystem&&ms.set(o.id,JSON.parse(JSON.stringify(o.localCoordSystem)))})}}}if(Ve){if(Wn){const t=j.x-cn.x,n=j.y-cn.y;he.offsetX=Pa.x+t*Ye,he.offsetY=Pa.y-n*Ye}else if(!Tn){if(_g(j)||rg(e))return;if(rt&&(be.length>0||Se.length>0||ge.length>0||Pe.length>0)&&!$i){const n=q(rt);let s=Yi;!s&&xe.length>0&&(s=xe.find(i=>i.type==="regular"&&ae(i,n)>1e-6)||xe.find(i=>i.type==="regular")),n&&s&&Ag(Oe(j),s,n,n.type)}else if(we.length>0){const n=xe.length===1&&xe[0].type==="regular",s=Oe(j);if(n){const i=xe[0];In(i.id,K).filter(a=>!xe.some(r=>r.id===a)).map(a=>q(a));const o=mu(i,s);if(we[0].x=o.pos.x,we[0].y=o.pos.y,At.clear(),Bs.clear(),o.snapped){const a={copyIndex:0,type:o.snapType,projectionLine:o.projectionLine};At.set(i.id,[a]),o.targetEdge&&Bs.set(re(o.targetEdge),[{copyIndex:0,type:"external_to_static"}])}ce.finalSnapResult={...o,finalDelta:{x:o.pos.x-i.x,y:o.pos.y-i.y}}}else{const i=Oe(cn),o={x:s.x-i.x,y:s.y-i.y};Tg(o)}}else if(Ha.length>0){const n=Oe(cn),s=Oe(j),i={x:s.x-n.x,y:s.y-n.y};ce.textFinalDelta=i}}}}else st?Pg(j):Nr();gn("mouseMove",{clientX:e.clientX,clientY:e.clientY,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey}),Bt()}function Lc(e,t){if(At.clear(),Bs.clear(),!t||!t.snapped)return;const n=(s,i,o,a)=>{if(i===void 0)return;let r;if(o===void 0)r=void 0;else if(o===-1)r=0;else if(o>=0)r=o;else return;(r===void 0||r>=0)&&(s.has(i)||s.set(i,[]),s.get(i).some(c=>c.copyIndex===r&&c.type===a)||s.get(i).push({copyIndex:r,type:a}))};t.mergePairs.forEach(s=>{n(At,s.source.originalId,s.source.transformIndex,"vertex"),n(At,s.target.originalId,s.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:s,targetEdge:i})=>{n(At,s.originalId,s.transformIndex,"edge"),n(Bs,i.originalEdgeId,i.transformIndex,"vertex_on_edge")})}function Dg(e,t,n){const s=2*Ke/n.scale,i=new Map,o=new Map,a=new Map;e.forEach(d=>a.set(d.id,d.id));const r=d=>{if(!a.has(d)||a.get(d)===d)return d;const f=r(a.get(d));return a.set(d,f),f};for(let d=0;d<e.length;d++)for(let f=d+1;f<e.length;f++){const h=e[d],u=e[f];if(h.type==="regular"&&u.type==="regular"&&ae(h,u)<s){const p=r(h.id),g=r(u.id);p!==g&&a.set(g,p)}}e.forEach(d=>{const f=r(d.id);d.id!==f&&i.set(d.id,f)});const c=new Set(i.keys()),l=new Map(e.map(d=>[d.id,d]));return t.forEach(d=>{const f=r(d.id1),h=r(d.id2);if(f===h)return;const u=l.get(f),p=l.get(h);!u||!p||e.forEach(g=>{if(g.type!=="regular"||c.has(g.id)||g.id===f||g.id===h)return;const y=Dt(g,u,p);if(y.distance<s&&y.onSegmentStrict){const m=re({id1:f,id2:h});o.has(m)||o.set(m,{edge:{id1:f,id2:h},pointsToInsert:[]}),o.get(m).pointsToInsert.push(g)}})}),{vertexMerges:i,edgeSplits:o}}function Oc(e){Un?lg():en===0?xg():en===2&&Ig(e),Un||Nc(),_r(j)?ve.style.cursor="default":sn||(ve.style.cursor="crosshair"),Zt(),en===2?gn("rightMouseUp",e):en===0&&gn("mouseUp",e),Bt()}function Nc(){tn&&clearTimeout(tn),jt="",tn=null,qt=!1,Ve=!1,Tn=!1,$i=!1,_s=!1,Wn=!1,we=[],xe=[],Ha=[],eo=[],ce=null,tt=null,$s=[],ze=null,Bs.clear(),At.clear(),ms.clear(),en=-1}function Fc(e){tn&&clearTimeout(tn),jt="",tn=null,bt.style.display==="block"&&(bt.style.display="none");const t=e.target;if(t&&(t.tagName==="INPUT"||t.closest(".katex"))){e.stopPropagation(),Bt();return}if((st||sn)&&e.button===2){Is(),e.preventDefault(),Bt();return}j=Io(e,ve),cn={...j},en=e.button,en===0?(gg(e),gn("mouseDown",e)):en===2&&(Sg(e),gn("rightMouseDown",e)),Bt()}function Bc(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;const t=()=>{gn("keyDown",e),Bt()};if((e.key==="Control"||e.key==="Meta")&&(bo=!0),e.key==="Alt"&&!e.repeat&&(e.preventDefault(),Et=!0,Nr()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!st&&!sn&&!qt){e.preventDefault(),Ua(e.key),Bt();return}const s=e.ctrlKey||e.metaKey;if(s&&(e.key==="a"||e.key==="A")){e.preventDefault();const o=pe.filter(l=>l.type==="regular").map(l=>l.id),a=K.map(l=>re(l)),r=se.map(l=>fe(l)),c=We.map(l=>l.id);$t(o,a,r,!1,!1,!1,c),Fe=pe.filter(l=>l.type!=="regular").map(l=>l.id),rt=Fe.length>0?Fe[Fe.length-1]:null,t();return}if(e.key==="Shift"&&!Re){Re=!0;const o=Oe(j);if(sn){const a=bi(o);a&&(jo=Ce(a),ze=a)}else if(st&&mt){const a=q(mt);if(a){const r=aa(),c=Rr(a.id),l=Jo(a,j,Re);let d=Ge(Je),f=null;const h=_e[Je];if(h!==-1){const p=Me[h];if(p&&p.type==="colormap"&&Le&&Le.length>=1){const g=Le.length,y=Le.length-1,m=g>1?y/(g-1):0,x=g>1?(y+1)/g:1;f={colormapItem:p,startT:m,endT:x}}}Hl(ke,{startVertex:a,snappedData:l,isShiftPressed:Re,currentColor:Ge(Ue),nextCreationColor:Ge(Ue),nextEdgeColor:d,colors:r,edgeColormapInfo:f},Ce),ql(ke,gt,a,l,l,{showDistances:On,showAngles:es,currentShiftPressed:Re,distanceSigFigs:Es,angleSigFigs:gi,angleDisplayMode:Qt,viewTransform:he,frozenReference_D_du:It,gridDisplayMode:yt,frozenReference_A_rad:Kt,colors:r},Ce,c,Lt)}}else if(!qt)if(Un&&wn&&wn.type==="center"){const a=bi(o);if(a){ze=a;const r=wn.face,c=r.localCoordSystem,l=r.vertexIds.map(f=>q(f)).filter(f=>f&&f.type==="regular"),d=lo(a,l);c.origin.x=d.x,c.origin.y=d.y,c.isCustom=!0}}else{const a=po(j),r=a?null:yo(j),c=!a&&!r?mo(j):null;!a&&!r&&!c?ze=bi(o):ze=null}}if(qt&&en===0&&(ce?.targetVertex||ce?.targetEdge||ce?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(tn),tn===null||jt.length>=2?jt=e.key:jt+=e.key;const o=parseInt(jt,10)||1;if(ce?.finalSnapResult?.finalDelta){const a=ce.finalSnapResult.finalDelta,r={delta:a},l=Yl(xe,pe,K,q,o,he,r,(d,f,h=r)=>({x:d.x+h.delta.x*f,y:d.y+h.delta.y*f}));Lc(a,l),ce.finalSnapResult={...l,finalDelta:a}}tn=setTimeout(()=>{tn=null},500)}if(s&&e.key.toLowerCase()===fh){e.preventDefault(),st&&mt&&Hu(),t();return}if(!(qt&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(s&&[rl,cl,ll,ba,dl,hl,al,ol,il].includes(e.key.toLowerCase())))){if(Xo&&s&&(e.key===ol||e.key===il)){e.preventDefault();const o={x:ve.width/Ye/2,y:ve.height/Ye/2};qi(o,jr),t();return}if(Xo&&s&&e.key===al){e.preventDefault();const o={x:ve.width/Ye/2,y:ve.height/Ye/2};qi(o,1/jr),t();return}if(e.key===lh)e.preventDefault(),Ou();else if(e.key===ch)Is();else if(e.key===dh||e.key===hh)e.preventDefault(),ti();else if(s&&e.key.toLowerCase()===rl){if(vt&&Ne[kt]){e.preventDefault(),ko=JSON.parse(JSON.stringify(Ne[kt])),t();return}e.preventDefault(),Cc()}else if(s&&e.key.toLowerCase()===cl)e.preventDefault(),ku();else if(s&&e.key.toLowerCase()===ll){if(vt&&ko){e.preventDefault(),Pu(),t();return}e.preventDefault(),Ru()}else if(s&&e.key.toLowerCase()===ba&&!e.shiftKey){if(vt&&Gi.length>0){e.preventDefault(),Au(),t();return}e.preventDefault(),og()}else if(s&&(e.key.toLowerCase()===dl||e.shiftKey&&e.key.toLowerCase()===ba))e.preventDefault(),ig();else if(s&&e.key.toLowerCase()===hl&&!Wa){e.preventDefault(),Ze(),be=pe.filter(a=>a.type==="regular").map(a=>a.id),Se=K.map(a=>re(a)),ge=se.map(a=>a.id),Fe=pe.filter(a=>a.type!=="regular").map(a=>a.id),rt=null;const o=[];ge.length>0&&o.push(at),Se.length>0&&o.push(Je),be.length>0&&o.push(Ue),Pe.length>0&&o.push(Gt),o.length>0&&(je=o,ft&&Ct())}t()}}function $c(e){const t=()=>{gn("keyUp",e),Bt()};if(e.key==="Shift"&&(Re=!1,ze=null,jo=null,$s=[],Un&&wn&&wn.type==="center")){const n=Oe(j),s=wn.face,i=s.localCoordSystem,o=s.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular"),a=lo(n,o);i.origin.x=a.x,i.origin.y=a.y,i.isCustom=!0}e.key==="Alt"&&(Et=!1,Nr()),(e.key==="Control"||e.key==="Meta")&&(bo=!1),Zt(),t()}function Vc(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,s=t.offsetHeight;ve.width=n*Ye,ve.height=s*Ye,ve.style.width=`${n}px`,ve.style.height=`${s}px`,gt&&(gt.style.width=`${n}px`,gt.style.height=`${s}px`)}function kg(){eu(),Me=Zi.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),Su(),mc(),Vc(),su(),Ff({canvas:ve,onMouseDown:Fc,onMouseMove:Rc,onMouseUp:Oc,onPinchZoom:(n,s)=>{qi(s,n),Bt()},onPan:n=>{Lu(n),Bt()},getModifiers:()=>({shiftKey:Re,ctrlKey:bo,altKey:Et}),isHoverMode:()=>mi,getHoverTarget:()=>Ee.hoverTarget,getUiTargetAt:ou}),ts=new Hc,ts.initialize(),document.body.appendChild(ts.getElement());const e=ts.getElement();e.addEventListener("mouseenter",()=>{Wa=!0}),e.addEventListener("mouseleave",()=>{Wa=!1}),ts.getElement().addEventListener("select",n=>{const s=n.detail,i=Lh(s);if(i){if(Vi&&Do!==null)Me[Do]=i;else{vu(i);const o=Me.length-1;je.forEach(a=>{_e[a]=o})}Cr(),Vi=!1,Do=null,Ct()}}),Js=new td({container:document.body,onSelect:n=>{if(!n)return;const s={...n};s.id||(s.id=Ut());const i=yn.findIndex(o=>o.id===s.id);i>=0?yn[i]=s:yn.push(s),Ii(s.id),dn&&Ar(),Zt()}}),Js.initialize(),he.scale=70,he.offsetX=ve.width/2,he.offsetY=ve.height/2,Fs="regular",bt=document.getElementById("context-menu"),window.addEventListener("click",()=>{bt&&(bt.style.display="none")}),bt.addEventListener("mouseleave",()=>{bt.style.display="none"}),Tu()||(Eu()||Ze(),Cu()),kc(),Jt(),Bt()}ve.addEventListener("wheel",bg,{passive:!1});ve.addEventListener("mouseenter",vg);ve.addEventListener("mouseleave",Mg);window.addEventListener("contextmenu",Eg);ve.addEventListener("mousemove",Rc);ve.addEventListener("mouseup",Oc);ve.addEventListener("mousedown",Fc);window.addEventListener("keyup",$c);window.addEventListener("keydown",Bc);window.addEventListener("resize",Vc);window.addEventListener("beforeunload",()=>{Ec()});window.addEventListener("load",kg);

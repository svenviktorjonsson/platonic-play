(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const ga="#3b82f6",pa="#4a5568",ya="#718096",Hc=300,ma="#242c3a",js=2,Yr=3,Le=9,xa=12,Kc=5,Gr=8,it=8,Wr=.9,zr=5,hi=[4,4],qc={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},jc={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class Uc{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=qc,this.namedColormaps=jc,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,s=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,o=1;if(s&&s.type==="colormap"&&(s.points||s.controlPoints)){this.state.isCyclic=s.isCyclic===!0;let a=JSON.parse(JSON.stringify(s.controlPoints||s.points));if(a.length===1){a[0].pos=.5;const r=a[0].color,c=r[0]/255,l=r[1]/255,d=r[2]/255;i=(c+l+d)/3,o=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(r=>{const c=r.color,l=r.alpha!==void 0?r.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,l,r.pos,r.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=o,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async s=>{const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch preset file at ${s}: Status ${i.status}`);return await i.json()},n=s=>{try{const i=localStorage.getItem(s);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:s}=t.dataset;if(s==="named_colors"||s==="custom_colors"){let i;if(s==="named_colors"?i=this.namedColors[n]:i=this.customColors[n]?.rgb,!i){console.error(`RGB undefined for ${n} in ${s}`);return}this.applyColorToSelection(i)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const i=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(i==="Cancel"||i==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,s)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,s=t[1]/255,i=t[2]/255;if(this.state.selectedPointIds.size===0){const o=this.state.points.length;o>0&&this.state.points.forEach(c=>{c.pos=c.pos*(o/(o+1))});const a=o===0?.5:1,r=this.createPointFromRgb(n,s,i,1,a,1);this.state.points.push(r),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const r=this.convertRgbToCurrentColorspace(n,s,i);a.hsPos=r.hsPos,a.originalHsPos={...r.hsPos},a.lightness=r.lightness}});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}loadColormap(t,n,s=!1){s||this.saveState();const i=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!i||!i.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const o=i.points.map(a=>{let r=[0,0,0];typeof a.color=="string"?r=this.namedColors[a.color]||this.customColors[a.color]?.rgb||r:Array.isArray(a.color)&&(r=a.color);const c=r[0]/255,l=r[1]/255,d=r[2]/255,h=a.alpha??1;return this.createPointFromRgb(c,l,d,h,a.pos,a.order)});this.state.points=o,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=($,R={})=>{const N=document.createElement($);if(R.id){N.id=R.id;const k=R.id.replace(/-(\w)/g,(Y,B)=>B.toUpperCase());this.elements[k]=N}return R.className&&(N.className=R.className),R.text&&(N.textContent=R.text),R.type&&(N.type=R.type),R.placeholder&&(N.placeholder=R.placeholder),N};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),s=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const o=t("div",{id:"selected-color-section",className:"control-section"}),a=t("div",{id:"current-colormap-section",className:"control-section"}),r=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),r.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(r,c);const d=t("h2",{className:"panel-header",text:"Lightness"}),h=t("div",{id:"lightness-slider-container",className:"canvas-container"}),f=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});h.append(t("canvas",{id:"lightness-bg-canvas"}),f),s.append(d,h);const u=t("h2",{className:"panel-header",text:"Alpha"}),p=t("div",{id:"alpha-slider-container",className:"canvas-container"}),g=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});p.append(t("canvas",{id:"alpha-bg-canvas"}),g),i.append(u,p);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const m=t("div",{className:"preset-category-header"});m.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(m,t("div",{className:"preset-items-container"}));const x=t("h3",{className:"section-title",text:"Selected Color"}),S=t("div",{className:"preview-container"});S.append(t("canvas",{id:"selected-color-preview-canvas"}));const M=t("div",{className:"space-y-2"}),b=t("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const E=t("div");E.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const C=t("div");C.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const v=t("div");v.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),b.append(E,C,v),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const T=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),w=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),I=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(T,w,I),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const P=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),L=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(P,L);const A=t("h3",{className:"input-label",text:"Interpolation"});A.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const _=t("div",{className:"interpolation-grid"});_.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),_.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),M.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,A,_),o.append(x,S,M);const D=t("h3",{className:"section-title text-center",text:"Current Colormap"}),O=t("div",{className:"preview-container"});O.append(t("canvas",{id:"colormap-preview-canvas"}));const X=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const F=t("div",{className:"button-row"});F.append(this.elements.reverseButton,this.elements.cycleButton),X.append(F,this.elements.closeButton,this.elements.selectButton),a.append(D,O,X),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const V=t("div",{id:"modal-dialog",className:"modal-dialog"});V.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),V.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(V),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,s,this.elements.colorsPresetsWrapper,o,i,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(f,"lightness"),this.createInteractiveCanvas(g,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const s=i=>{const o=i.target.closest(".preset-item");o&&(i.type==="click"?this.handlePresetClick(o):i.type==="contextmenu"&&o.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,o.dataset.name,o.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",s),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",s),this.elements.colormapsPresetsWrapper.addEventListener("click",s),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",s),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const o=this.state.points,a=o.length,r=(u,p)=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(g);return{pos:parseFloat((p!==void 0?p:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let p=0;p<u;p++){const g=o[p],y=o[(p+1)%a];i.push(r(g));const m=Math.max(g.order,y.order);if(m===0){let x=g.pos,S=y.pos;this.state.isCyclic&&S<x&&(S+=1);const M=x+(S-x)*.5;i.push(r(g,this.wrapPositionCyclic(M-1e-6))),i.push(r(y,this.wrapPositionCyclic(M)))}else if(m===3){const S=g.pos;let M=y.pos;this.state.isCyclic&&M<S&&(M+=1);const b=M-S;for(let E=1;E<16;E++){const C=E/16,v=S+C*b,T=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(v));if(T){const w=this.abstractToRgb(T.u,T.v,T.lightness),I=this.clampColor(w);i.push({pos:parseFloat(this.wrapPositionCyclic(v).toFixed(6)),alpha:parseFloat(T.alpha.toFixed(4)),color:[I.r,I.g,I.b],order:T.order})}}}}this.state.isCyclic||i.push(r(o[a-1]))}const c=new Map;i.forEach(u=>c.set(u.pos,u));let l=Array.from(c.values()).sort((u,p)=>u.pos-p.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const d=this.state.points.map(u=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),g=this.clampColor(p);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[g.r,g.g,g.b],order:u.order}}),h={points:l,controlPoints:d,isCyclic:this.state.isCyclic},f=new CustomEvent("select",{detail:h,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(f)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,s){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const o={Rename:()=>this.handlePresetAction("rename",n,s),Delete:()=>this.handlePresetAction("delete",n,s)};for(const[a,r]of Object.entries(o)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=r,i.appendChild(c)}i.style.left=`${t.clientX}px`,i.style.top=`${t.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,s){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(s==="custom_colors"&&delete this.customColors[n],s==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(s),this.populatePresets());else if(t==="rename"){const i=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(i&&i!==n){const o=s==="custom_colors"?this.customColors:this.customColormaps;if(o[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}o[i]=o[n],delete o[n],this.saveCustomPresets(s),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const s=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!s)return!1;if(t==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const o=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),a=this.clampColor(o);this.customColors[s]={rgb:[a.r,a.g,a.b],alpha:i.alpha}}else{const i=this.state.points.map(o=>{const a=this.abstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness),r=this.clampColor(a);return{pos:o.pos,alpha:o.alpha,color:[r.r,r.g,r.b],order:o.order}});this.customColormaps[s]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=s,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(o,a)=>{const r=document.createElement("div");r.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=o;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=a,r.appendChild(c),r.appendChild(l),r},n=(o,a,r,c)=>{Object.keys(a).sort().forEach(l=>{const d=document.createElement("div");d.className="preset-item",d.dataset.name=l,d.dataset.type=r,d.dataset.custom=c;const h=document.createElement("canvas");h.className="preset-icon",r.includes("colormap")?(h.width=64,h.height=16):(h.width=16,h.height=16);const f=document.createElement("span");if(f.textContent=l,d.appendChild(h),d.appendChild(f),o.appendChild(d),r==="named_colors"||r==="custom_colors"){const u=a[l],p=c?u.rgb:u;this.drawColorIcon(h,p)}else this.drawColormapIcon(h,a[l].points,this.namedColors,this.customColors)})},s=document.createElement("div");s.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(s),n(s,this.namedColors,"named_colors",!1),n(s,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),n(i,this.namedColormaps,"named_colormaps",!1),n(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,s,i){const o=n.map(d=>{let h=[0,0,0];typeof d.color=="string"?h=s[d.color]||(i[d.color]?i[d.color].rgb:[0,0,0]):Array.isArray(d.color)&&(h=d.color);const{hsPos:f,lightness:u}=this.convertRgbToCurrentColorspace(h[0]/255,h[1]/255,h[2]/255);return{id:Math.random(),hsPos:f,originalHsPos:{...f},lightness:u,alpha:d.alpha??1,pos:d.pos,order:1}}).sort((d,h)=>d.pos-h.pos),a=this.state.points;this.state.points=o;const r=t.getContext("2d"),{width:c,height:l}=t;if(this.drawCheckerboard(r),this.state.points.length>0)for(let d=0;d<c;d++){const h=d/(c-1),f=this.getInterpolatedPropertiesAt(h);if(!f)continue;const u=this.clampAbstractPoint(f.u,f.v,f.lightness),p=this.abstractToRgb(u.u,u.v,f.lightness),{r:g,g:y,b:m}=this.clampColor(p);r.fillStyle=`rgba(${g}, ${y}, ${m}, ${f.alpha})`,r.fillRect(d,0,1,l)}this.state.points=a}showPrompt(t,n,s=null){return new Promise(i=>{const{modalOverlay:o,modalTitle:a,modalInputContainer:r,modalInput:c,modalButtons:l}=this.elements,d=document.querySelectorAll("[data-tick-canvas]");d.forEach(h=>h.style.display="none"),a.textContent=t,l.innerHTML="",s?(c.value=s.value||"",c.placeholder=s.placeholder||"",r.classList.remove("hidden")):r.classList.add("hidden"),n.forEach(h=>{const f=document.createElement("button");f.className=`modal-button ${h==="Save"||h==="Delete"||h==="Rename"?"modal-button-primary":"modal-button-secondary"}`,f.textContent=h,f.onclick=()=>{o.classList.add("hidden"),d.forEach(u=>u.style.display=""),i(s?c.value:h)},l.appendChild(f)}),o.classList.remove("hidden"),s&&c.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(s=>s.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(s=>Math.abs(s.pos)<1e-6),n=this.state.points.some(s=>Math.abs(s.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(o=>({id:o.id,pos:o.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(o=>{o.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const s=t.getContext("2d");s.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,s.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,s,i,o,a){const{hsPos:r,lightness:c}=this.convertRgbToCurrentColorspace(t,n,s);return{id:Date.now()+Math.random(),hsPos:r,originalHsPos:{...r},lightness:c,alpha:i,pos:o,order:a}}convertRgbToCurrentColorspace(t,n,s){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),lightness:(t+n+s)/3};{const i=this.rgbToHsl(t,n,s);return{hsPos:this.rgbToHslDiConeAbstract(t,n,s),lightness:i.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:d,clientHeight:h}=l.container;(l.c.width!==d||l.c.height!==h)&&(l.c.width=d,l.c.height=h)});const i=this.elements.hsBgCanvas,o=this.elements.interactiveCanvases.hs,a=i.parentElement,r=a.clientWidth,c=a.clientHeight;[i,o].forEach(l=>{l&&(l.width=r,l.height=c,l.style.width=`${r}px`,l.style.height=`${c}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(i=>{let o;n==="RGB_CUBE"?o=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):o=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let a,r;if(t==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(o),r=(o.r+o.g+o.b)/3;else{const c=this.rgbToHsl(o.r,o.g,o.b);a=this.rgbToHslDiConeAbstract(o.r,o.g,o.b),r=c.l}i.hsPos=a,i.originalHsPos={...a},i.lightness=r});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const s=Date.now(),i=this.elements.interactiveCanvases[n];if(!i)return;const o=i.getBoundingClientRect(),a=i.width/o.width,r=i.height/o.height,c=(t.clientX-o.left)*a,l=(t.clientY-o.top)*r,d={x:c,y:l};let h=!1,f=null,u=!1;if(n==="hs")f=this.findHitPointHS(c,l);else{const m=this.findHitPointSlider(c,l,n);f=m.hitPoint,u=m.hitLine}if(s-this.lastClickTime<Hc&&f&&f.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=s,this.lastClickTarget=f?f.id:null,f){this.state.viewLightness=f.lightness,this.state.viewAlpha=f.alpha;const m=t.ctrlKey||t.metaKey,x=t.shiftKey;!this.state.selectedPointIds.has(f.id)&&!m&&!x&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(f.id),this.state.lastSelectedPointId=f.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=i,this.state.activeDrag.pointId=f?f.id:null,f){const m=new Map;if(n==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:x,offsetX:S,offsetY:M}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const E=b.hsPos.u*x+S,C=b.hsPos.v*x+M;this.state.activeDrag.initialPointPositions.set(b.id,{x:E,y:C})}})}else this.state.points.forEach(x=>{this.state.selectedPointIds.has(x.id)&&m.set(x.id,{lightness:x.lightness-f.lightness,alpha:x.alpha-f.alpha,pos:x.pos-f.pos})}),this.state.activeDrag.offsets=m}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const g=m=>{const x=(m.clientX-o.left)*a,S=(m.clientY-o.top)*r,M=Math.sqrt((x-d.x)**2+(S-d.y)**2);!h&&M>Kc&&(h=!0,f&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(m)},y=m=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y),h||this.handleClick(c,l,n,f,m),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",g),document.addEventListener("mouseup",y)}handleClick(t,n,s,i,o){const{shiftKey:a,ctrlKey:r,metaKey:c}=o,l=r||c;if(i){const{selectedPointIds:d}=this.state,h=i.id;if(this.clickCount===3)this.state.points.forEach(f=>d.add(f.id)),this.state.lastSelectedPointId=h;else if(this.clickCount===2){const f=this.state.points.findIndex(p=>p.id===h);d.clear(),[f-1,f,f+1].forEach(p=>{p>=0&&p<this.state.points.length&&d.add(this.state.points[p].id)}),this.state.lastSelectedPointId=h}else l?d.has(h)?(d.delete(h),this.state.lastSelectedPointId===h&&(this.state.lastSelectedPointId=d.size>0?Array.from(d)[0]:null)):(d.add(h),this.state.lastSelectedPointId=h):a?(d.add(h),this.state.lastSelectedPointId=h):(d.clear(),d.add(h),this.state.lastSelectedPointId=h)}else if(s==="hs")this.createNewPointHS(t,n);else if(s==="lightness"||s==="alpha"){const d=this.elements.interactiveCanvases[s],h=Math.ceil(Le*2.2),f=d.height-2*h,p=(d.height-h-n)/f,g=Math.max(0,Math.min(1,p));s==="lightness"?this.state.viewLightness=g:this.state.viewAlpha=g}this.drawAll()}findHitPointHS(t,n){const s=Math.ceil(Le*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=o,c=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;for(const d of this.state.points){const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-Le&&h<=a+c+Le&&f>=r-Le&&f<=r+l+Le&&Math.sqrt((t-h)**2+(n-f)**2)<=xa)return d}return null}handleInputChange(t,n){const s=t.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(n==="lightness"||n==="alpha"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[n]=o,n==="lightness"&&this.constrainPointToValidArea(a))}),i=!0)}else if(n==="position"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=o)}),this.sortPoints(),i=!0)}if(i){const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,s,i,o,a,r=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),s=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(s))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,s=Math.max(0,Math.min(255,s))/255;const c=this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),l=(t+n+s)/3;this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...c},d.originalHsPos={...c},d.lightness=l)}),r=!0}else{if(i=parseFloat(this.elements.hslHInput.value),o=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(i)||isNaN(o))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),o=Math.max(0,Math.min(1,o));const c=this.hslToRgb(i,o,a),l=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...l},d.originalHsPos={...l})}),r=!0}if(r){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const s=document.createElement("canvas");s.className=`interactive-canvas ${n}-interactive`,s.dataset.type=n,t.appendChild(s),this.elements.interactiveCanvases[n]=s}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:s,pointId:i}=this.state.activeDrag,o=s,a=o.getBoundingClientRect(),r=o.width/a.width,c=o.height/a.height,l=(t.clientX-a.left)*r,d=(t.clientY-a.top)*c;n.endsWith("-line")?this.handleLineDrag(d,o.height,n):i&&this.handlePointDrag(l,d,o,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),s=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:s}}rgbToHslDiConeAbstract(t,n,s){const i=this.rgbToHsl(t,n,s),o=1-Math.abs(2*i.l-1),a=i.s*o,r=i.h*2*Math.PI,c=a*Math.cos(r),l=a*Math.sin(r);return{u:c,v:l}}hslDiConeAbstractToRgb(t,n,s){const i=(Math.atan2(n,t)/(2*Math.PI)+1)%1,o=Math.sqrt(t*t+n*n),a=s,r=1-Math.abs(2*a-1);if(r<1e-9)return{r:a,g:a,b:a};const c=o/r;return this.hslToRgb(i,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,s=n&&n.tagName==="INPUT",i=t.ctrlKey||t.metaKey;if(i&&t.key==="z"){t.preventDefault(),this.undo();return}if(i&&t.key==="y"){t.preventDefault(),this.redo();return}if(s){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(i&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(o=>this.state.selectedPointIds.add(o.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(o=>!this.state.selectedPointIds.has(o.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,s,i=null){let o=t,a=zr+1;const r=Math.ceil(Le*2.2),c=Math.ceil(it/2),l=r+c,d=n-l-r,h=n-r;return this.state.points.forEach(f=>{if(f.id===i)return;const u=h-f[s]*d,p=Math.abs(t-u);p<zr&&p<a&&(o=u,a=p)}),o}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:s}=this.state,i=this.elements.hsBgCanvas.width,o=this.elements.hsBgCanvas.height;if(i===0||o===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=ma,a.fillRect(0,0,i,o);const r=Math.ceil(Le*2.2),c=Math.ceil(it/2),l=r+c,d=i-l-r,h=o-l-r;if(d<=0||h<=0)return;const f=s==="RGB_CUBE"?Math.min(d,h)/(Math.sqrt(2/3)*2)*Wr:Math.min(d,h)/2*Wr;this.state.transform.scale=f,this.state.transform.offsetX=i/2,this.state.transform.offsetY=o/2;const u=l,p=l,g=d,y=h,m=it,x=Math.round(g/m),S=Math.round(y/m),M=g/x,b=y/S;for(let w=0;w<S;w++)for(let I=0;I<x;I++){const P=u+I*M,L=p+w*b;(w+I)%2===0?a.fillStyle=ya:a.fillStyle=pa,a.fillRect(P,L,M,b)}if(s==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const I=i/2,P=o/2,L=t<.5?0:255;a.fillStyle=`rgba(${L}, ${L}, ${L}, ${n})`,a.fillRect(Math.floor(I),Math.floor(P),1,1);return}const E=a.createImageData(g,y),C=E.data;for(let w=0;w<y;w++)for(let I=0;I<g;I++){const P=u+I,L=p+w,A=(P-this.state.transform.offsetX)/this.state.transform.scale,_=(L-this.state.transform.offsetY)/this.state.transform.scale,{r:D,g:O,b:X}=this.abstractToRgb(A,_,t),F=(w*g+I)*4;this.isValidColor(D,O,X)&&(C[F]=Math.round(D*255),C[F+1]=Math.round(O*255),C[F+2]=Math.round(X*255),C[F+3]=255)}const v=document.createElement("canvas");v.width=g,v.height=y,v.getContext("2d").putImageData(E,0,0),a.globalAlpha=n,a.drawImage(v,u,p),a.globalAlpha=1}evaluateCubicSpline(t,n){const s=this.state.points,i=s.length;if(t<0||t>=i)return null;let o,a,r,c;if(this.state.isCyclic){const u=p=>{const g=(p%i+i)%i;return s[g]};t===i-1?(o=u(t-1),a=u(t),r=u(0),c=u(1)):(o=u(t-1),a=u(t),r=u(t+1),c=u(t+2))}else a=s[t],r=s[t+1],o=t>0?s[t-1]:s[t],c=t+2<i?s[t+2]:s[t+1];const l=n,d=l*l,h=d*l,f=(u,p,g,y)=>.5*(2*p+(-u+g)*l+(2*u-5*p+4*g-y)*d+(-u+3*p-3*g+y)*h);return{u:f(o.hsPos.u,a.hsPos.u,r.hsPos.u,c.hsPos.u),v:f(o.hsPos.v,a.hsPos.v,r.hsPos.v,c.hsPos.v),lightness:f(o.lightness,a.lightness,r.lightness,c.lightness),alpha:f(o.alpha,a.alpha,r.alpha,c.alpha),order:2}}isValidColor(t,n,s){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&s>=-.001&&s<=1.001}drawSliderBackgrounds(){const t=Math.ceil(Le*2.2),n=Math.ceil(it/2),s=t+n,i=this.elements.lightnessBgCanvas.getContext("2d"),o=this.elements.lightnessBgCanvas;i.fillStyle=ma,i.fillRect(0,0,o.width,o.height);const a=s,r=o.width-t,c=s,l=o.height-t,d=r-a,h=l-c;if(h>0&&d>0){const M=i.createLinearGradient(0,c,0,l);M.addColorStop(0,"white"),M.addColorStop(1,"black"),i.fillStyle=M,i.fillRect(a,c,d,h)}const f=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;f.fillStyle=ma,f.fillRect(0,0,u.width,u.height);const p=s,g=u.width-t,y=s,m=u.height-t,x=g-p,S=m-y;if(S>0&&x>0){const M=it,b=Math.round(x/M),E=Math.ceil(S/M),C=x/b,v=M,T=m-E*v;for(let I=0;I<E;I++)for(let P=0;P<b;P++){const L=p+P*C,A=T+I*v;if(A<m&&A+v>y){(I+P)%2===0?f.fillStyle=ya:f.fillStyle=pa;const _=Math.max(A,y),D=Math.min(A+v,m)-_;D>0&&f.fillRect(L,_,C,D)}}const w=f.createLinearGradient(0,y,0,m);w.addColorStop(0,"white"),w.addColorStop(1,"rgba(255,255,255,0)"),f.fillStyle=w,f.fillRect(p,y,x,S)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=ga,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Le*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=o,c=t.width-o-s,l=t.height-o-s;if(this.state.points.length>1){const d=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let h=0;h<d;h++){const f=this.state.points[h],u=this.state.points[(h+1)%this.state.points.length];if(Math.max(f.order,u.order)===0)continue;let g=f.pos,y=u.pos;this.state.isCyclic&&y<g&&(y+=1);const m=y-g;if(m<1e-9)continue;const x=Math.max(10,Math.ceil(m*100)),S=[];for(let b=0;b<=x;b++){const E=g+b/x*m,C=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(E));if(!C)continue;const v=this.clampAbstractPoint(C.u,C.v,C.lightness),T=v.u*this.state.transform.scale+this.state.transform.offsetX,w=v.v*this.state.transform.scale+this.state.transform.offsetY;S.push({x:T,y:w,isOnPlane:Math.abs(C.lightness-this.state.viewLightness)<1e-10})}if(S.length<2)continue;const M=S.every(b=>b.isOnPlane);n.strokeStyle="black",n.lineWidth=js,n.globalAlpha=M?.7:.4,n.setLineDash(M?[]:hi),n.beginPath(),n.moveTo(S[0].x,S[0].y);for(let b=1;b<S.length;b++)n.lineTo(S[b].x,S[b].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(a,r,c,l),n.clip(),this.state.points.forEach(d=>{const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-Le&&h<=a+c+Le&&f>=r-Le&&f<=r+l+Le){const u=this.abstractToRgb(d.hsPos.u,d.hsPos.v,d.lightness),{r:p,g,b:y}=this.clampColor(u),m=this.state.selectedPointIds.has(d.id),x=d.id===this.state.lastSelectedPointId,S=Math.abs(d.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),d.order){case 0:this._drawCircle(n,h,f,Le);break;case 1:this._drawDroplet(n,h,f,Le);break;case 3:this._drawTriangle(n,h,f,Le);break;default:this._drawCircle(n,h,f,Le)}n.globalAlpha=d.alpha,n.fillStyle=`rgb(${p}, ${g}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=m?ga:"black",n.lineWidth=x?Yr:js,n.setLineDash(S?[]:hi),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Le*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=t.width-s,c=o,l=t.height-s,d=r-a,h=l-c;let f=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(f=p.lightness)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.lightness*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:M}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),E=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,M,b,E,p.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=js;const s=this.state.points,i=s.length;if(n==="hs"){t.restore();return}const o=Math.ceil(Le*2.2),a=Math.ceil(it/2),r=o+a,c=r,l=t.canvas.height-o,d=t.canvas.width-r-o,h=l-r,f=c+d;if(d<=0){t.restore();return}const u=this.state.isCyclic?i:i-1;for(let p=0;p<u;p++){const g=s[p],y=s[(p+1)%i],m=Math.max(g.order,y.order),x=this.state.isCyclic&&p===i-1;if(m===0){const S=l-g[n]*h,M=l-y[n]*h,b=c+g.pos*d,E=c+y.pos*d;if(x&&g.pos>y.pos){let C=g.pos,v=y.pos+1;const T=C+(v-C)*.5,w=c+(T-Math.floor(T))*d,I=this.getInterpolatedPropertiesAt(g.pos),P=this.getInterpolatedPropertiesAt(y.pos);if(I){const L=this.abstractToRgb(I.u,I.v,I.lightness),A=this.clampColor(L);t.strokeStyle=`rgba(${A.r},${A.g},${A.b},${I.alpha})`,t.setLineDash([]),T>1?(t.beginPath(),t.moveTo(b,S),t.lineTo(f,S),t.stroke(),t.beginPath(),t.moveTo(c,S),t.lineTo(w,S),t.stroke()):(t.beginPath(),t.moveTo(b,S),t.lineTo(w,S),t.stroke())}if(P){const L=this.abstractToRgb(P.u,P.v,P.lightness),A=this.clampColor(L);t.strokeStyle=`rgba(${A.r},${A.g},${A.b},${P.alpha})`,t.setLineDash([]),T>1?(t.beginPath(),t.moveTo(w,M),t.lineTo(E,M),t.stroke()):(t.beginPath(),t.moveTo(w,M),t.lineTo(f,M),t.stroke(),t.beginPath(),t.moveTo(c,M),t.lineTo(E,M),t.stroke())}t.beginPath(),t.setLineDash(hi),t.strokeStyle="black",t.moveTo(w,S),t.lineTo(w,M),t.stroke()}else if(!x){let C=g.pos,v=y.pos;const T=C+(v-C)*.5,w=c+T*d,I=this.getInterpolatedPropertiesAt(g.pos),P=this.getInterpolatedPropertiesAt(y.pos);if(I){const L=this.abstractToRgb(I.u,I.v,I.lightness),A=this.clampColor(L);t.strokeStyle=`rgba(${A.r},${A.g},${A.b},${I.alpha})`,t.setLineDash([]);const _=p===0&&!this.state.isCyclic?c:b;t.beginPath(),t.moveTo(_,S),t.lineTo(w,S),t.stroke()}if(P){const L=this.abstractToRgb(P.u,P.v,P.lightness),A=this.clampColor(L);t.strokeStyle=`rgba(${A.r},${A.g},${A.b},${P.alpha})`,t.setLineDash([]);const _=p===u-1&&!this.state.isCyclic?f:E;t.beginPath(),t.moveTo(w,M),t.lineTo(_,M),t.stroke()}t.beginPath(),t.setLineDash(hi),t.strokeStyle="black",t.moveTo(w,S),t.lineTo(w,M),t.stroke()}}else if(t.setLineDash([]),x&&g.pos>y.pos){const S=l-g[n]*h,M=l-y[n]*h,b=c+g.pos*d,E=c+y.pos*d,C=1-g.pos;if(C>1e-6){const v=t.createLinearGradient(b,0,f,0),T=Math.max(2,Math.ceil(C*20));for(let P=0;P<=T;P++){const L=g.pos+P/T*C,A=this.getInterpolatedPropertiesAt(L);if(A){const _=this.abstractToRgb(A.u,A.v,A.lightness),{r:D,g:O,b:X}=this.clampColor(_);v.addColorStop(P/T,`rgba(${D}, ${O}, ${X}, ${A.alpha})`)}}const w=this.getInterpolatedPropertiesAt(1),I=w?l-w[n]*h:S;t.beginPath(),t.moveTo(b,S),t.lineTo(f,I),t.strokeStyle=v,t.stroke()}if(y.pos>1e-6){const v=t.createLinearGradient(c,0,E,0),T=Math.max(2,Math.ceil(y.pos*20));for(let P=0;P<=T;P++){const L=P/T*y.pos,A=this.getInterpolatedPropertiesAt(L);if(A){const _=this.abstractToRgb(A.u,A.v,A.lightness),{r:D,g:O,b:X}=this.clampColor(_);v.addColorStop(P/T,`rgba(${D}, ${O}, ${X}, ${A.alpha})`)}}const w=this.getInterpolatedPropertiesAt(0),I=w?l-w[n]*h:M;t.beginPath(),t.moveTo(c,I),t.lineTo(E,M),t.strokeStyle=v,t.stroke()}}else if(!x){const S=c+g.pos*d,M=c+y.pos*d,b=(E,C,v,T)=>{const w=C-E;if(Math.abs(w)<1e-9)return;const I=t.createLinearGradient(v,0,T,0),P=Math.ceil(Math.abs(T-v)/2);for(let L=0;L<=P;L++){const A=E+L/P*w,_=this.getInterpolatedPropertiesAt(A);if(!_)continue;const D=this.abstractToRgb(_.u,_.v,_.lightness),{r:O,g:X,b:F}=this.clampColor(D);I.addColorStop(L/P,`rgba(${O}, ${X}, ${F}, ${_.alpha})`)}t.beginPath();for(let L=0;L<=P;L++){const A=E+L/P*w,_=this.getInterpolatedPropertiesAt(A);if(!_)continue;const D=Math.max(0,Math.min(1,A)),O=c+D*d,X=l-_[n]*h;L===0?t.moveTo(O,X):t.lineTo(O,X)}t.strokeStyle=I,t.stroke()};if(p===0&&!this.state.isCyclic&&Math.abs(g.pos)>=1e-6){const E=this.getInterpolatedPropertiesAt(g.pos);if(E){const C=this.abstractToRgb(E.u,E.v,E.lightness),{r:v,g:T,b:w}=this.clampColor(C);t.strokeStyle=`rgba(${v}, ${T}, ${w}, ${E.alpha})`;const I=l-E[n]*h;t.beginPath(),t.moveTo(c,I),t.lineTo(S,I),t.stroke()}}if(b(g.pos,y.pos,S,M),p===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const E=this.getInterpolatedPropertiesAt(y.pos);if(E){const C=this.abstractToRgb(E.u,E.v,E.lightness),{r:v,g:T,b:w}=this.clampColor(C);t.strokeStyle=`rgba(${v}, ${T}, ${w}, ${E.alpha})`;const I=l-E[n]*h;t.beginPath(),t.moveTo(M,I),t.lineTo(f,I),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const s=t.lightness<.05||t.lightness>.95,i=n.lightness<.05||n.lightness>.95;if(s&&i)return!0;const o=10;for(let a=0;a<=o;a++){const r=a/o,c=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*r,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*r,d=t.lightness+(n.lightness-t.lightness)*r,h=this.abstractToRgb(c,l,d);if(!this.isValidColor(h.r,h.g,h.b))return!1}return!0}drawInterpolatedPath(t,n,s,i){const o=s.pos-n.pos;if(o<1e-6)return;const a=Math.max(2,Math.ceil(o*t.canvas.width/4));let r=!1;for(let c=0;c<=a;c++){const l=n.pos+c/a*o,d=this.getInterpolatedPropertiesAt(l);if(!d)continue;const h=this.clampAbstractPoint(d.u,d.v,d.lightness),f=h.u*this.state.transform.scale+this.state.transform.offsetX,u=h.v*this.state.transform.scale+this.state.transform.offsetY;!r||c===0?(t.moveTo(f,u),r=!0):t.lineTo(f,u)}}drawHSSegment(t,n,s,i,o){let a=n.pos,r=s.pos;this.state.isCyclic&&r<a&&(r+=1);const c=r-a;if(c<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(c*t.canvas.width/8)),d=[];for(let f=0;f<=l;f++){const u=a+f/l*c,p=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!p)continue;const g=this.clampAbstractPoint(p.u,p.v,p.lightness),y=g.u*this.state.transform.scale+this.state.transform.offsetX,m=g.v*this.state.transform.scale+this.state.transform.offsetY,x=Math.abs(p.lightness-this.state.viewLightness)<1e-10;d.push({x:y,y:m,isOnPlane:x,u:g.u,v:g.v})}if(d.length<2)return;if(d.every(f=>f.isOnPlane)){t.strokeStyle="black",t.lineWidth=js,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let f=1;f<d.length;f++)t.lineTo(d[f].x,d[f].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=js,t.globalAlpha=.4;const f=Math.sqrt((s.hsPos.u-n.hsPos.u)**2+(s.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+f*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let p=1;p<d.length;p++)t.lineTo(d[p].x,d[p].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const s=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<s;i++){const o=this.state.points[i],a=this.state.points[(i+1)%this.state.points.length];if(Math.max(o.order,a.order)===0)continue;const c=Math.abs(o.lightness-this.state.viewLightness)<1e-10,l=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&l)continue;const d=o.lightness,h=a.lightness,f=this.state.viewLightness;if(d<f&&h>f||d>f&&h<f){const u=this.findLightnessIntersection(o,a,f);if(u!==null){let p=a.pos-o.pos;this.state.isCyclic&&a.pos<o.pos&&(p+=1);const g=o.pos+u*p,y=this.getInterpolatedPropertiesAt(g);if(!y)continue;const m=this.clampAbstractPoint(y.u,y.v,y.lightness),x=m.u*this.state.transform.scale+this.state.transform.offsetX,S=m.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(x,S,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,s){const i=t.lightness,o=n.lightness;if(Math.abs(o-i)<1e-10)return null;if(Math.max(t.order,n.order)===1){const h=(s-i)/(o-i);return h>0&&h<1?h:null}let r=0,c=1;const l=25;for(let h=0;h<l;h++){const f=(r+c)/2,u=t.pos+(n.pos-t.pos)*f,p=this.getInterpolatedPropertiesAt(u);if(!p)break;if(Math.abs(p.lightness-s)<1e-10)return f;p.lightness<s?o>i?r=f:c=f:o>i?c=f:r=f}const d=(r+c)/2;return d>.01&&d<.99?d:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const s=t.canvas,i=Math.ceil(Le*2.2),o=Math.ceil(it/2),a=i+o;t.save(),t.strokeStyle="white",t.lineWidth=1;const r=a,c=s.width-i,l=a,d=s.height-i,h=c-r,f=d-l;this.clearTickLabels(s);const u=[0,.2,.4,.6,.8,1],p=["0","0.2","0.4","0.6","0.8","1"],g=s.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,m=window.pageYOffset||document.documentElement.scrollTop;for(let x=0;x<u.length;x++){const S=u[x],M=Math.floor(r+S*h)+.5;S===0?(t.beginPath(),t.moveTo(M,l),t.lineTo(M,d+5),t.stroke()):(t.beginPath(),t.moveTo(M,d),t.lineTo(M,d+5),t.stroke());const b=g.left+y+M,E=g.top+m+d+8;this.createKaTeXLabel(p[x],b,E,"bottom",s)}for(let x=0;x<u.length;x++){const S=u[x],M=Math.floor(d-S*f)+.5;S===0?(t.beginPath(),t.moveTo(r-5,M),t.lineTo(c,M),t.stroke()):(t.beginPath(),t.moveTo(r-5,M),t.lineTo(r,M),t.stroke());const b=g.left+y+r-8,E=g.top+m+M;this.createKaTeXLabel(p[x],b,E,"left",s)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(s=>s.remove())}createKaTeXLabel(t,n,s,i,o){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,katex.render(t,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,s,i,o)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Le*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=t.width-s,c=o,l=t.height-s,d=r-a,h=l-c;let f=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(f=p.alpha)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.alpha*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:M}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),E=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,M,b,E,p.order)})}_drawCircle(t,n,s,i){t.arc(n,s,i,0,2*Math.PI)}_drawJoukowsky(t,n,s,i,o){const r=[];let c=1/0,l=-1/0,d=1/0,h=-1/0;for(let m=0;m<=50;m++){const x=m/50*2*Math.PI,S=Math.cos(x),M=Math.sin(x),b=1-o+o*S,E=o*M,C=b*b+E*E;if(Math.abs(C)<1e-9)continue;const v=o*M-o*M/C,T=o*S+b/C;r.push({x:v,y:T}),v<c&&(c=v),v>l&&(l=v),T<d&&(d=T),T>h&&(h=T)}const f=h-d,u=i*2.5/f,p=(l+c)/2,g=(h+d)/2;t.beginPath();const y=r[0];t.moveTo(n+(y.x-p)*u,s-(y.y-g)*u);for(let m=1;m<r.length;m++){const x=r[m];t.lineTo(n+(x.x-p)*u,s-(x.y-g)*u)}t.closePath()}_drawDroplet(t,n,s,i){this._drawJoukowsky(t,n,s,i,.6666666666666666)}_drawTriangle(t,n,s,i){const o=i*1.4;t.moveTo(n,s-o),t.lineTo(n+o*Math.sqrt(3)/2,s+o/2),t.lineTo(n-o*Math.sqrt(3)/2,s+o/2),t.closePath()}drawPoint(t,n,s,i,o,a,r,c,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,s,Le);break;case 1:this._drawDroplet(t,n,s,Le);break;case 3:this._drawTriangle(t,n,s,Le);break;default:this._drawCircle(t,n,s,Le)}t.fillStyle=`rgb(${i}, ${o}, ${a})`,t.fill(),t.strokeStyle=r?ga:"black",t.lineWidth=c?Yr:js,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,s=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){s||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!s){const{lightness:o,hsPos:a}=t,r=this.abstractToRgb(a.u,a.v,o);if(i){const{r:c,g:l,b:d}=this.clampColor(r);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=d}else{const c=this.rgbToHsl(r.r,r.g,r.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:s}=t.parentElement;(t.width!==n||t.height!==s)&&(t.width=n,t.height=s);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),this.drawCheckerboard(i);const o=this.getLastSelectedPoint();if(o){const{hsPos:a,lightness:r,alpha:c}=o,l=this.abstractToRgb(a.u,a.v,r),{r:d,g:h,b:f}=this.clampColor(l);i.fillStyle=`rgba(${d}, ${h}, ${f}, ${c})`,i.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,s=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let i=0;i<n;i++){const o=i/(n-1),a=this.getInterpolatedPropertiesAt(o);if(!a)continue;const r=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(r.u,r.v,a.lightness),{r:l,g:d,b:h}=this.clampColor(c);t.fillStyle=`rgba(${l}, ${d}, ${h}, ${a.alpha})`,t.fillRect(i,0,1,s)}}getInterpolatedPropertiesAt(t){const n=this.state.points,s=n.length;if(s===0)return null;if(s===1){const f=n[0];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}const i=this.state.isCyclic,o=i?(t%1+1)%1:t;let a,r,c=-1;for(let f=0;f<s-1;f++)if(o>=n[f].pos&&o<=n[f+1].pos){c=f,a=n[f],r=n[f+1];break}if(c===-1)if(i)c=s-1,a=n[s-1],r=n[0];else{const f=o<n[0].pos?n[0]:n[s-1];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(!a||!r)return null;let l=r.pos-a.pos;if(i&&c===s-1&&(l+=1),Math.abs(l)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let d;i&&c===s-1?d=o>=a.pos?(o-a.pos)/l:(o+1-a.pos)/l:d=(o-a.pos)/l;const h=Math.max(a.order,r.order);if(h===0){const f=d<.5?a:r;return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(h===3){const f=this.evaluateCubicSpline(c,d);if(f){const u=Math.max(0,Math.min(1,f.lightness)),p=Math.max(0,Math.min(1,f.alpha)),g=this.clampAbstractPoint(f.u,f.v,u);return{u:g.u,v:g.v,lightness:u,alpha:p,order:2}}}return{u:a.hsPos.u+(r.hsPos.u-a.hsPos.u)*d,v:a.hsPos.v+(r.hsPos.v-a.hsPos.v)*d,lightness:a.lightness+(r.lightness-a.lightness)*d,alpha:a.alpha+(r.alpha-a.alpha)*d,order:1}}abstractToRgb(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,s);const i=this.rgbCubeAbstractToRgb(t,n,s);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE"){const f=Math.sqrt(t*t+n*n),u=1-Math.abs(2*s-1);return f>u&&u>1e-6?{u:t/f*u,v:n/f*u}:{u:t,v:n}}if(s<=.01||s>=.99)return{u:0,v:0};let{r:i,g:o,b:a}=this.abstractToRgb(t,n,s);if(this.isValidColor(i,o,a))return{u:t,v:n};let r=0,c=0,l=1/0;const d=Math.max(Math.abs(t),Math.abs(n),.5),h=50;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const p=t+(f/h-.5)*2*d,g=n+(u/h-.5)*2*d,y=this.abstractToRgb(p,g,s);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((p-t)**2+(g-n)**2);m<l&&(l=m,r=p,c=g)}}return l<1/0?{u:r,v:c}:{u:0,v:0}}hslToRgb(t,n,s){if(n===0)return{r:s,g:s,b:s};const i=s<.5?s*(1+n):s+n-s*n,o=2*s-i,a=(d,h,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<1/6?d+(h-d)*6*f:f<1/2?h:f<2/3?d+(h-d)*(2/3-f)*6:d),r=a(o,i,t+1/3),c=a(o,i,t),l=a(o,i,t-1/3);return{r,g:c,b:l}}rgbToHsl(t,n,s){const i=Math.max(t,n,s),o=Math.min(t,n,s);let a=0,r=0,c=(i+o)/2;if(i!==o){const l=i-o;switch(r=c>.5?l/(2-i-o):l/(i+o),i){case t:a=(n-s)/l+(n<s?6:0);break;case n:a=(s-t)/l+2;break;case s:a=(t-n)/l+4;break}a/=6}return{h:a,s:r,l:c}}drawCheckerboard(t){const n=t.canvas.width,s=t.canvas.height,i=n/it,o=s/it;t.fillStyle=pa,t.fillRect(0,0,n,s),t.fillStyle=ya;for(let a=0;a<o;a++)for(let r=0;r<i;r++)(a+r)%2===0&&t.fillRect(r*it,a*it,it,it)}findClosestValidPoint(t,n,s){const i=Math.ceil(Le*2.2),o=Math.ceil(it/2),a=i+o,r=a,c=a,l=this.elements.hsBgCanvas.width-a-i,d=this.elements.hsBgCanvas.height-a-i,h=Math.max(r,Math.min(r+l,t)),f=Math.max(c,Math.min(c+d,n)),{scale:u,offsetX:p,offsetY:g}=this.state.transform,y=(h-p)/u,m=(f-g)/u,x=this.abstractToRgb(y,m,s);if(this.isValidColor(x.r,x.g,x.b))return{x:h,y:f};if(this.state.colorSpace==="HSL_DI_CONE"){const S=Math.sqrt(y*y+m*m),M=1-Math.abs(2*s-1);if(S>M&&M>1e-6){const b=y/S*M,E=m/S*M;return{x:b*u+p,y:E*u+g}}return{x:h,y:f}}return this.findClosestPointOnRgbGamut(y,m,s,u,p,g,r,c,l,d)}getGamutVerticesRgb(t){const n=[],s=r=>r>=-1e-6&&r<=1.000001,i=(r,c)=>Math.abs(r.r-c.r)<1e-6&&Math.abs(r.g-c.g)<1e-6&&Math.abs(r.b-c.b)<1e-6,o=(r,c,l)=>{if(s(r)&&s(c)&&s(l)){const d={r,g:c,b:l};n.some(h=>i(h,d))||n.push(d)}},a=3*t;return o(a,0,0),o(0,a,0),o(0,0,a),o(1,a-1,0),o(1,0,a-1),o(a-1,1,0),o(0,1,a-1),o(a-1,0,1),o(0,a-1,1),o(1,1,a-2),o(1,a-2,1),o(a-2,1,1),n}rgbCubeAbstractToRgb(t,n,s){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},o={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=s+t*i.x+n*o.x,r=s+t*i.y+n*o.y,c=s+t*i.z+n*o.z;return{r:a,g:r,b:c}}findClosestPointOnRgbGamut(t,n,s,i,o,a,r,c,l,d){let h=t,f=n,u=1/0;const p=.5,g=50;for(let x=0;x<=g;x++)for(let S=0;S<=g;S++){const M=t+(x/g-.5)*2*p,b=n+(S/g-.5)*2*p,E=this.abstractToRgb(M,b,s);if(this.isValidColor(E.r,E.g,E.b)){const C=Math.sqrt((M-t)**2+(b-n)**2);C<u&&(u=C,h=M,f=b)}}if(u<1/0){const x=this.refineClosestPoint(t,n,h,f,s);h=x.u,f=x.v}const y=h*i+o,m=f*i+a;return{x:Math.max(r,Math.min(r+l,y)),y:Math.max(c,Math.min(c+d,m))}}refineClosestPoint(t,n,s,i,o){let a=s,r=i,c=.02;for(let l=0;l<5;l++){let d=!1;const h=20;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const p=a+(f/h-.5)*2*c,g=r+(u/h-.5)*2*c,y=this.abstractToRgb(p,g,o);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((a-t)**2+(r-n)**2);Math.sqrt((p-t)**2+(g-n)**2)<m&&(a=p,r=g,d=!0)}}if(c*=.5,!d)break}return{u:a,v:r}}findClosestPointOnPolygon(t,n){let s=null,i=1/0;for(let o=0;o<n.length;o++){const a=n[o],r=n[(o+1)%n.length],c=r.x-a.x,l=r.y-a.y;let d;if(c===0&&l===0)d=a;else{const f=((t.x-a.x)*c+(t.y-a.y)*l)/(c*c+l*l);f<0?d=a:f>1?d=r:d={x:a.x+f*c,y:a.y+f*l}}const h=(t.x-d.x)**2+(t.y-d.y)**2;h<i&&(i=h,s=d)}return s}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const s=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=s.u,t.hsPos.v=s.v}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(Le*2.2),a=Math.ceil(it/2),r=o+a,c=i.height-r-o,l=i.height-o,d=s==="lightness"?l-this.state.viewLightness*c:l-this.state.viewAlpha*c;let h=Math.abs(n-d)<=Gr,f=null;for(let u=0;u<this.state.points.length;u++){const p=this.state.points[u],g=i.width-r-o,y=r+p.pos*g,m=s==="lightness"?l-p.lightness*c:l-p.alpha*c;if(Math.sqrt((t-y)**2+(n-m)**2)<=xa){f=p;break}}return{hitPoint:f,hitLine:h}}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(Le*2.2),a=i.height-2*o,r=i.height-o,c=s==="lightness"?r-this.state.viewLightness*a:r-this.state.viewAlpha*a;let l=Math.abs(n-c)<=Gr,d=null;for(let h=0;h<this.state.points.length;h++){const f=this.state.points[h],u=i.width-2*o,p=o+f.pos*u,g=s==="lightness"?r-f.lightness*a:r-f.alpha*a;if(Math.sqrt((t-p)**2+(n-g)**2)<=xa){d=f;break}}return{hitPoint:d,hitLine:l}}createNewPointHS(t,n){const s=Math.ceil(Le*2.2),i=Math.ceil(it/2),o=s+i,a=o,r=o,c=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;if(t<a||t>a+c||n<r||n>r+l)return;const d=(t-this.state.transform.offsetX)/this.state.transform.scale,h=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:f,viewAlpha:u}=this.state,{r:p,g,b:y}=this.abstractToRgb(d,h,f);if(this.isValidColor(p,g,y)){this.markAsDirty();const m=this.state.points.length;m>0&&this.state.points.forEach(S=>{S.pos=S.pos-S.pos/m});const x={id:Date.now(),hsPos:{u:d,v:h},originalHsPos:{u:d,v:h},lightness:f,alpha:u,pos:m===0?.5:1,order:1};this.state.points.push(x),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(x.id),this.state.lastSelectedPointId=x.id,this.drawAll()}}handleLineDrag(t,n,s){const i=s.startsWith("lightness")?"lightness":"alpha",o=s.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(Le*2.2),r=Math.ceil(it/2),c=a+r,l=n-c-a,h=(this.findSnapPosition(t,n,i)-c)/l,f=Math.max(0,Math.min(1,1-h));this.state[o]=f,this.drawAll()}handlePointDrag(t,n,s,i){const o=this.getPointById(this.state.activeDrag.pointId);o&&(i==="hs"?this.handleHSPointDrag(t,n):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(o,t,n,s,i),this.drawAll())}handleHSPointDrag(t,n){const{startX:s,startY:i,initialPointPositions:o}=this.state.activeDrag,{scale:a,offsetX:r,offsetY:c}=this.state.transform,l=Math.ceil(Le*2.2),d=Math.ceil(it/2),h=l+d,f=h,u=h,p=this.elements.hsBgCanvas.width-h-l,g=this.elements.hsBgCanvas.height-h-l,y=t-s,m=n-i;this.state.points.forEach(x=>{if(o.has(x.id)){const S=o.get(x.id),M=S.x+y,b=S.y+m,E=Math.max(f,Math.min(f+p,M)),C=Math.max(u,Math.min(u+g,b)),v=this.findClosestValidPoint(E,C,x.lightness),T=(v.x-r)/a,w=(v.y-c)/a;x.hsPos={u:T,v:w};const I=this.abstractToRgb(T,w,x.lightness);this.isValidColor(I.r,I.g,I.b)&&(x.originalHsPos={u:T,v:w})}})}adjustPointForNewLightness(t,n){const s=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(s.r,s.g,s.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}handleSliderPointDrag(t,n,s,i,o){const{offsets:a}=this.state.activeDrag,r=Math.ceil(Le*2.2),c=Math.ceil(it/2),l=r+c;i.width-r,i.height-r;const d=this.findSnapPosition(s,i.height,o,t.id),h=l,f=i.width-r,u=l,p=i.height-r,g=f-h,y=p-u,m=(d-u)/y,x=Math.max(0,Math.min(1,1-m));let S=(n-h)/g,M=S;this.state.isCyclic?(S<0?M=1+S:S>1&&(M=S-1),M=this.wrapPositionCyclic(M)):M=Math.max(0,Math.min(1,S));for(const b of this.state.points)if(a.has(b.id)){const E=a.get(b.id),C=x+E[o];let v=M+E.pos;if(this.state.isCyclic?v=this.wrapPositionCyclic(v):v=Math.max(0,Math.min(1,v)),b.pos=v,o==="lightness"){const T=Math.max(0,Math.min(1,C));b.lightness=T;const w=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,T);if(this.isValidColor(w.r,w.g,w.b))b.hsPos={...b.originalHsPos};else{const I=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,T);b.hsPos.u=I.u,b.hsPos.v=I.v}this.state.viewLightness=T}else b.alpha=Math.max(0,Math.min(1,C)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const Jc=[5,4],or=16,Zc=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],Hr=e=>{const t=[{power:3,value:e[0]},{power:2,value:e[1]},{power:1,value:e[2]},{power:0,value:e[3]}],n=s=>Number(s.toFixed(6));return t.filter(s=>Math.abs(s.value)>1e-10).map((s,i)=>{const o=s.value<0?"-":"+",a=Math.abs(s.value),r=n(a),c=s.power===0?"":`t^${s.power}`,l=s.power===0?`${r}`:`${r}${c}`;return i===0?s.value<0?`-${l}`:`${l}`:`${o} ${l}`}).join(" ").replace(/t\^1\b/g,"t")},Qc=(e,t,n,s,i)=>{const o=[t.x,n.x,s.x,i.x],a=[t.y,n.y,s.y,i.y],r=e.map(l=>l.reduce((d,h,f)=>d+h*o[f],0)),c=e.map(l=>l.reduce((d,h,f)=>d+h*a[f],0));return{x:r,y:c}},ed=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c};function td(e,t=!1,n=or){if(e.length<2)return e;const s=[],i=e.length,o=t?i:i-1;for(let a=0;a<o;a++){const r=e[a],c=e[(a+1)%i],l=a===0?0:1;for(let d=l;d<=n;d++){const h=d/n;s.push({x:r.x+(c.x-r.x)*h,y:r.y+(c.y-r.y)*h})}}return s}const on=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},Ai=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),nd=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},Cs=(e,t,n,s,i,o,a,r=null)=>{const c=i*.5;if(c<=1e-6)return;const l={x:c,y:c},d=Math.PI,h=-Math.PI/2,f=nd(d,h),u=Math.max(2,o);for(let p=a?0:1;p<=u;p++){const g=p/u,y=d+f*g,m={x:l.x+Math.cos(y)*c,y:l.y+Math.sin(y)*c},x={x:t.x+n.x*m.x+s.x*m.y,y:t.y+n.y*m.x+s.y*m.y};r?r(x):e.push(x)}};function Kr(e,t=!1,n="relative",s=0,i=or,o=!1,a=!1,r=!1,c=!1){if(e.length<2)return e;if(s<=1e-6)return t?[...e,e[0]]:[...e];const l=e.length,d=[],h=[],f=n==="fixed"?"absolute":n,u=f==="absolute"?"relative":f,p=M=>{const b=e[(M-1+l)%l],E=e[M],C=e[(M+1)%l],v=Ai(b,E),T=Ai(C,E),w=Math.hypot(v.x,v.y),I=Math.hypot(T.x,T.y);if(w<=1e-6||I<=1e-6)return null;let P,L,A;const _=Math.min(w,I)*.5;if(u==="absolute"?(P=Math.max(0,Math.min(1,s)),L=on(T),A=on(v)):(f==="absolute"?P=Math.max(0,Math.min(s,_))*2:P=Math.max(0,Math.min(1,s)),L=f==="absolute"?on(T):T,A=f==="absolute"?on(v):v),P<=1e-6)return null;const D=P*.5,O=r?-D:f==="absolute"?w*.5:.5,X=r?-D:f==="absolute"?I*.5:.5,F={x:E.x+A.x*O,y:E.y+A.y*O},V={x:E.x+L.x*X,y:E.y+L.y*X},$=on(A),R=on(L),N={x:$.x+R.x,y:$.y+R.y},k=Math.hypot(N.x,N.y),Y=k>1e-6?{x:N.x/k,y:N.y/k}:{x:0,y:0},B=f==="absolute"?D:D*Math.min(w,I),G={x:E.x-Y.x*(B/Math.sqrt(2)),y:E.y-Y.y*(B/Math.sqrt(2))},W={x:-$.y,y:$.x},z={x:-R.y,y:R.x},K=W.x*Y.x+W.y*Y.y<0?{x:-W.x,y:-W.y}:W,H=z.x*Y.x+z.y*Y.y<0?{x:-z.x,y:-z.y}:z,q=(f==="absolute"?D:D*w)/Math.sqrt(2),se=(f==="absolute"?D:D*I)/Math.sqrt(2),fe={x:E.x+$.x*(w*.5)+K.x*q,y:E.y+$.y*(w*.5)+K.y*q},ae={x:E.x+R.x*(I*.5)+H.x*se,y:E.y+R.y*(I*.5)+H.y*se},ne={x:E.x+A.x*D,y:E.y+A.y*D},Z={x:E.x+L.x*D,y:E.y+L.y*D};return{index:M,origin:E,axisX:L,axisY:A,baseScale:P,radius:D,edgeInIndex:(M-1+l)%l,edgeOutIndex:M,midIn:F,midOut:V,arcStart:ne,arcEnd:Z,bisectorOuter:G,midInOrtho:fe,midOutOrtho:ae}},g=(M,b=null,E=null)=>{if(!c){d.push({x:M.x,y:M.y});return}d.push({x:M.x,y:M.y,tag:b||void 0,edgeIndex:E??void 0})},y=M=>g(M,"arc"),m=(M,b)=>{!r||M.radius<=1e-6||(b?(g(M.midInOrtho,"line",M.edgeInIndex),g(M.bisectorOuter,"corner")):(g(M.bisectorOuter,"corner"),g(M.midOutOrtho,"line",M.edgeOutIndex)))};if(t){for(let b=0;b<l;b++){const E=p(b);E&&h.push(E)}if(!h.length)return[...e,e[0]];if(r){const b=h[0];g(b.arcStart,"line",b.edgeInIndex),Cs(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!1,y);for(let E=1;E<h.length;E++){const C=h[E];g(C.arcStart,"line",C.edgeInIndex),Cs(d,C.origin,C.axisX,C.axisY,C.baseScale,i,!1,y)}return g({...b.arcStart},"line",b.edgeInIndex),d}const M=h[0];return g(M.midIn,"line",M.edgeInIndex),m(M,!0),h.forEach((b,E)=>{E>0&&(g(b.midIn,"line",b.edgeInIndex),m(b,!0)),Cs(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!0,y),m(b,!1),g(b.midOut,"line",b.edgeOutIndex),g(b.origin,"corner")}),g({...M.midIn},"line",M.edgeInIndex),d}if(u==="absolute"){for(let E=1;E<l-1;E++){const C=p(E);C&&h.push(C)}if(!h.length)return[...e];const M=h[0];g(e[0],"line",0),M&&g(M.midIn,"line",M.edgeInIndex),m(M,!0),h.forEach((E,C)=>{C>0&&(g(E.midIn,"line",E.edgeInIndex),m(E,!0)),Cs(d,E.origin,E.axisX,E.axisY,E.baseScale,i,!0,y),m(E,!1),g(E.midOut,"line",E.edgeOutIndex)});const b=h[h.length-1];return b&&g(b.midOut,"line",b.edgeOutIndex),g(e[l-1],"line",l-2),d}if(r){for(let b=1;b<l-1;b++){const E=p(b);E&&h.push(E)}if(!h.length)return[...e];g(e[0],"line",0);const M=h[0];g(M.arcStart,"line",M.edgeInIndex),Cs(d,M.origin,M.axisX,M.axisY,M.baseScale,i,!1,y);for(let b=1;b<h.length;b++){const E=h[b];g(E.arcStart,"line",E.edgeInIndex),Cs(d,E.origin,E.axisX,E.axisY,E.baseScale,i,!1,y)}return g(e[l-1],"line",l-2),d}for(let M=1;M<l-1;M++){const b=p(M);b&&h.push(b)}if(!h.length)return[...e];const x=h[0],S=h[h.length-1];return g(e[0],"line",0),g(x.midIn,"line",x.edgeInIndex),h.forEach((M,b)=>{b>0&&g(M.midIn,"line",M.edgeInIndex),m(M,!0),Cs(d,M.origin,M.axisX,M.axisY,M.baseScale,i,!0,y),m(M,!1),g(M.midOut,"line",M.edgeOutIndex)}),g(S.midOut,"line",S.edgeOutIndex),g(e[l-1],"line",l-2),d}function sd(e,t=!1,n="relative",s=0){if(e.length<3)return[];if(s<=1e-6)return[];const i=e.length,o=[],a=n==="fixed"?"absolute":n,r=a==="absolute"?"relative":a,c=t?i:i-1;for(let l=1;l<c;l++){const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=Ai(d,h),p=Ai(f,h),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)continue;const m=Math.min(g,y)*.5;let x,S,M;if(r==="absolute"){const Y=Math.min(g,y);x=Math.max(0,Math.min(s,Y*.5))*2,S=on(p),M=on(u)}else x=a==="absolute"?Math.max(0,Math.min(s,m))*2:Math.max(0,Math.min(1,s)),S=a==="absolute"?on(p):p,M=a==="absolute"?on(u):u;if(x<=1e-6)continue;const b=x*.5,E=on(M),C=on(S),v={x:E.x+C.x,y:E.y+C.y},T=Math.hypot(v.x,v.y),w=T>1e-6?{x:v.x/T,y:v.y/T}:{x:0,y:0},I=a==="absolute"?b:b*Math.min(g,y),P=t?(()=>{let Y=0;for(let B=0;B<i;B++){const G=e[B],W=e[(B+1)%i];Y+=G.x*W.y-W.x*G.y}return Y})():1,L=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),_=(P>=0?L>=0:L<=0)?-1:1,D={x:h.x+w.x*I*_,y:h.y+w.y*I*_},O={x:-E.y,y:E.x},X={x:-C.y,y:C.x},F=O.x*w.x+O.y*w.y<0?{x:-O.x,y:-O.y}:O,V=X.x*w.x+X.y*w.y<0?{x:-X.x,y:-X.y}:X,$=(a==="absolute"?b:b*g)/Math.sqrt(2),R=(a==="absolute"?b:b*y)/Math.sqrt(2),N={x:h.x+E.x*(g*.5)+F.x*$,y:h.y+E.y*(g*.5)+F.y*$},k={x:h.x+C.x*(y*.5)+V.x*R,y:h.y+C.y*(y*.5)+V.y*R};o.push(D,N,k)}return o}function qr(e,t=.5,n=!1,s=or,i={}){if(e.length<2)return e;const o=[],a=Math.max(0,Math.min(1,t)),r=(1-a)*.5,c=Zc(r),l=i?.logSegments??!1,d=i?.label??"Catmull-Rom",h=(u,p,g,y,m)=>{const x=m*m,S=x*m,M=2*S-3*x+1,b=S-2*x+m,E=-2*S+3*x,C=S-x;return{x:M*u.x+b*g.x+E*p.x+C*y.x,y:M*u.y+b*g.y+E*p.y+C*y.y}};return ed(e,n).forEach(({index:u,p0:p,p1:g,p2:y,p3:m})=>{if(l){const b=Qc(c,p,g,y,m);console.groupCollapsed(`${d} segment ${u}`),console.log("Matrix M (rows t^3,t^2,t,1; cols P0..P3):",c),console.log("P0..P3:",p,g,y,m),console.log(`tension: ${a}, tau: ${r}`),console.log("P(t) = [t^3 t^2 t 1] * M * [P0 P1 P2 P3]"),console.log(`x(t) = ${Hr(b.x)}`),console.log(`y(t) = ${Hr(b.y)}`),console.groupEnd()}const x=u===0?0:1,S={x:(y.x-p.x)*r,y:(y.y-p.y)*r},M={x:(m.x-g.x)*r,y:(m.y-g.y)*r};for(let b=x;b<=s;b++){const E=b/s;o.push(h(g,y,S,M,E))}}),o}const od={id:null,preset:"closed",type:"spline",mode:"piecewise",order:3,tension:.5,radiusMode:"absolute",radiusValue:.5,relRadiusValue:.5,absRadiusValue:.5,linearStyle:"lines",nurbsDegree:3,pointHandling:"anchor"},na=500,Zs=e=>Math.max(0,Math.min(1,e)),Rl=e=>Math.max(0,Math.min(na,e)),fi=e=>{const t=Zs(Number(e)||0);return t*t*na},jr=e=>{const t=Rl(Number(e)||0);return Math.sqrt(t/na)},Ur=[{id:"closed",label:"Closed"},{id:"open",label:"Open"},{id:"figure8",label:"Figure 8"},{id:"branching",label:"Branching"},{id:"branching4",label:"Branching (4)"},{id:"branching5",label:"Branching (5)"}],id=[{id:"linear",label:"Linear"},{id:"spline",label:"Spline"},{id:"radius",label:"Radius"}];class ad{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:this._createStyle(),previewPoints:this._createDefaultPresetPoints()},this.wrapper=null,this.elements={},this.previewCards=new Map,this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this._renderAllPreviews())}show(t=null){this.state.style=this._normalizeStyle(t),this._updateUIFromState(),this.wrapper.style.display="block",requestAnimationFrame(()=>{this._renderAllPreviews()})}hide(){this.wrapper&&(this.wrapper.style.display="none")}_createStyle(){return{...od,id:`style_${Date.now()}`}}_normalizeStyle(t){const n=this._createStyle();if(!t)return n;const i=Number(t.order)===3?3:1;let o=t.type==="px_radius"?"abs_radius":t.type,a=t.radiusMode==="fixed"?"absolute":t.radiusMode,r=t.pointHandling;o==="cubic_spline"?(o="spline",r="anchor"):o==="circular_arc"?o="radius":o==="linear"&&(o="linear"),o==="catmull"?(o="spline",r="anchor"):o==="nurbs"?(o="spline",r="control"):o==="linear"?(o="spline",r="anchor"):o==="rel_radius"?(o="radius",a="relative"):o==="abs_radius"&&(o="radius",a="absolute");const c=t.relRadiusValue??(a==="relative"?Zs(t.radiusValue):n.relRadiusValue),l=t.absRadiusValue??(a==="absolute"?jr(t.radiusValue):n.absRadiusValue),d=a==="relative"?c:fi(l);return o||(t.mode==="radius"?o="radius":i===3&&t.tension!==void 0?(o="spline",r="anchor"):i===3?o="spline":(o="spline",r="anchor")),{...n,...t,id:t.id||n.id,preset:t.preset||n.preset,order:i,type:o||n.type,radiusMode:a||n.radiusMode,radiusValue:d,relRadiusValue:c,absRadiusValue:l,linearStyle:t.linearStyle||n.linearStyle,nurbsDegree:t.nurbsDegree||n.nurbsDegree,pointHandling:o==="spline"?"anchor":r??t.pointHandling??n.pointHandling}}_createDefaultPresetPoints(){const t={x:.6,y:.25},n={x:.55,y:.45},s={x:.55,y:.5},i=[{x:.2,y:.2},{x:.8,y:.25},{x:.7,y:.6},{x:.5,y:.45},{x:.3,y:.75}],o=[{x:.05,y:.8},{x:.25,y:.4},{x:.45,y:.7},{x:.65,y:.2},{x:.85,y:.55}],a=[{x:.72,y:.5},{x:.61,y:.31},{x:.39,y:.31},{x:.28,y:.5},{x:.39,y:.69},{x:.61,y:.69},{x:.5,y:.5}];return{closed:{vertices:i,edges:i.map((r,c)=>[c,(c+1)%i.length])},open:{vertices:o,edges:o.slice(0,-1).map((r,c)=>[c,c+1])},figure8:{vertices:a,edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0],[0,6],[6,3]],faces:[[0,1,2,3,4,5]]},branching:[[{x:.1,y:.85},{x:.3,y:.6},{x:.5,y:.4},t],[t,{x:.75,y:.15},{x:.9,y:.1}],[t,{x:.75,y:.35},{x:.9,y:.45}]],branching4:{in:[[{x:.12,y:.15},{x:.32,y:.3},n],[{x:.18,y:.75},{x:.35,y:.58},n]],out:[[n,{x:.75,y:.25},{x:.92,y:.2}],[n,{x:.75,y:.6},{x:.9,y:.72}]]},branching5:{in:[[{x:.1,y:.25},{x:.32,y:.38},s],[{x:.18,y:.8},{x:.35,y:.64},s]],out:[[s,{x:.78,y:.25},{x:.92,y:.2}],[s,{x:.78,y:.5},{x:.92,y:.52}],[s,{x:.78,y:.78},{x:.9,y:.85}]]}}}_initializeDOM(){const t=(C,v={})=>{const T=document.createElement(C);if(v.id){T.id=v.id;const w=v.id.replace(/-(\w)/g,(I,P)=>P.toUpperCase());this.elements[w]=T}return v.className&&(T.className=v.className),v.text&&(T.textContent=v.text),v.type&&(T.type=v.type),v.value!==void 0&&(T.value=v.value),v.attrs&&Object.entries(v.attrs).forEach(([w,I])=>T.setAttribute(w,I)),T};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"interpolation-editor-layout"}),s=t("div",{className:"editor-panel preview-panel"});s.append(t("div",{className:"panel-header",text:"Preview Presets"}));const i=t("div",{className:"preview-list"});Ur.forEach(C=>{const v=t("button",{className:"preview-card",attrs:{"data-preset":C.id,type:"button"}}),T=t("div",{className:"preview-card-label",text:C.label}),w=t("canvas",{className:"preview-card-canvas"});v.append(w,T),i.append(v),this.previewCards.set(C.id,{card:v,canvas:w})}),s.append(i);const o=t("div",{className:"editor-panel type-panel"});o.append(t("div",{className:"panel-header",text:"Interpolation Type"}));const a=t("div",{className:"toggle-stack",id:"type-list"});id.forEach(C=>{const v=t("button",{className:"toggle-row",text:C.label,attrs:{"data-type":C.id,type:"button"}});a.append(v)}),o.append(a);const r=t("div",{className:"editor-panel params-panel"});r.append(t("div",{className:"panel-header",text:"Parameters"}));const c=t("div",{className:"param-section",id:"tension-section"});c.append(t("div",{className:"section-caption",text:"Catmull-Rom tension."}));const l=t("div",{className:"param-row"});this.elements.tensionSlider=t("input",{id:"tension-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.tensionInput=t("input",{id:"tension-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),l.append(this.elements.tensionSlider,this.elements.tensionInput),c.append(l);const d=t("div",{className:"param-section",id:"linear-section"});d.append(t("div",{className:"section-caption",text:"Linear marker style."}));const h=t("div",{className:"param-row"}),f=t("div",{className:"toggle-group",id:"linear-style-toggle"});f.append(t("button",{className:"toggle-button",text:"Lines",attrs:{"data-linear-style":"lines",type:"button"}}),t("button",{className:"toggle-button",text:"Arrows",attrs:{"data-linear-style":"arrows",type:"button"}})),h.append(f),d.append(h);const u=t("div",{className:"param-section",id:"handling-section"});u.append(t("div",{className:"section-caption",text:"Point handling."}));const p=t("div",{className:"param-row"}),g=t("div",{className:"toggle-group",id:"point-handling-toggle"});g.append(t("button",{className:"toggle-button",text:"Control",attrs:{"data-point-handling":"control",type:"button"}}),t("button",{className:"toggle-button",text:"Anchor",attrs:{"data-point-handling":"anchor",type:"button"}}),t("button",{className:"toggle-button",text:"Mixed",attrs:{"data-point-handling":"mixed",type:"button"}})),p.append(g),u.append(p);const y=t("div",{className:"param-section",id:"radius-section"});y.append(t("div",{className:"section-caption",text:"Clamped to half each adjacent edge."}));const m=t("div",{className:"param-row"});this.elements.radiusSlider=t("input",{id:"radius-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.radiusInput=t("input",{id:"radius-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),m.append(this.elements.radiusSlider,this.elements.radiusInput),y.append(m);const x=t("div",{className:"toggle-group",id:"radius-mode-toggle"});x.append(t("button",{className:"toggle-button",text:"Relative",attrs:{"data-radius-mode":"relative",type:"button"}}),t("button",{className:"toggle-button",text:"Absolute",attrs:{"data-radius-mode":"absolute",type:"button"}})),y.append(x);const S=t("div",{className:"param-section",id:"nurbs-section"});S.append(t("div",{className:"section-caption",text:"NURBS degree."}));const M=t("div",{className:"param-row"});this.elements.nurbsDegreeSlider=t("input",{id:"nurbs-degree-slider",type:"range",attrs:{min:"2",max:"5",step:"1"}}),this.elements.nurbsDegreeInput=t("input",{id:"nurbs-degree-input",type:"number",attrs:{min:"2",max:"5",step:"1"}}),M.append(this.elements.nurbsDegreeSlider,this.elements.nurbsDegreeInput),S.append(M),r.append(d,u,c,y,S);const b=t("div",{className:"editor-panel actions-panel"});b.append(t("div",{className:"panel-header",text:"Actions"}));const E=t("div",{className:"button-row"});this.elements.closeButton=t("button",{id:"close-button",className:"editor-button secondary",text:"Close",attrs:{type:"button"}}),this.elements.selectButton=t("button",{id:"select-button",className:"editor-button primary",text:"Select",attrs:{type:"button"}}),E.append(this.elements.closeButton,this.elements.selectButton),b.append(E),n.append(s,o,r,b),this.wrapper.append(n),this.container.appendChild(this.wrapper)}_setupEventListeners(){window.addEventListener("resize",()=>{this.wrapper&&this.wrapper.style.display!=="none"&&this._renderAllPreviews()}),this.previewCards.forEach((o,a)=>{o.card.addEventListener("click",()=>{this._setStyle({preset:a})}),o.canvas.addEventListener("mousedown",r=>{this._handlePreviewMouseDown(r,a)})}),this.wrapper.querySelector("#type-list").querySelectorAll(".toggle-row").forEach(o=>{o.addEventListener("click",()=>{this._applyTypeSelection(o.dataset.type)})}),this.wrapper.querySelector("#linear-style-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({linearStyle:o.dataset.linearStyle})})}),this.wrapper.querySelector("#point-handling-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({pointHandling:o.dataset.pointHandling})})}),this.elements.radiusSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyRadiusValue(a,!0)}),this.elements.radiusInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyRadiusValue(a,!1)}),this.wrapper.querySelector("#radius-mode-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._applyRadiusMode(o.dataset.radiusMode)})}),this.elements.tensionSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyTensionValue(a,!0)}),this.elements.tensionInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyTensionValue(a,!1)}),this.elements.nurbsDegreeSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyNurbsDegreeValue(a,!0)}),this.elements.nurbsDegreeInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyNurbsDegreeValue(a,!1)}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{this.onSelect(this._exportStyleForHost()),this.hide()}),window.addEventListener("mousemove",o=>{this._handlePreviewMouseMove(o)}),window.addEventListener("mouseup",()=>{this._handlePreviewMouseUp()})}_setStyle(t){this.state.style={...this.state.style,...t},this._updateUIFromState(),this._renderAllPreviews()}_exportStyleForHost(){const{id:t,name:n,type:s,tension:i,radiusMode:o,radiusValue:a,pointHandling:r,order:c,preset:l,mode:d,linearStyle:h}=this.state.style,f={id:t,name:n,order:c,preset:l,mode:d,linearStyle:h};return s==="spline"?{...f,type:"cubic_spline",cornerHandling:"pass_through",tension:Number(i??.5)}:s==="radius"?{...f,type:"circular_arc",cornerHandling:r==="mixed"?"mixed":"cut_all",radiusMode:o,radiusValue:a}:{...f,type:"linear",cornerHandling:"pass_through"}}_applyRadiusValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};if(s.radiusMode==="relative"){const i=Zs(t);s.radiusValue=i,s.relRadiusValue=i}else{const i=n?Zs(t):jr(t);s.absRadiusValue=i,s.radiusValue=fi(i)}this.state.style=s,n?this.elements.radiusInput.value=s.radiusValue.toFixed(s.radiusMode==="absolute"?0:2):this.elements.radiusSlider.value=s.radiusMode==="absolute"?s.absRadiusValue:s.radiusValue,this._updateUIFromState(),this._renderAllPreviews()}_applyTensionValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.tension=Math.max(0,Math.min(1,t)),this.state.style=s,n?this.elements.tensionInput.value=s.tension.toFixed(2):this.elements.tensionSlider.value=s.tension,this._updateUIFromState(),this._renderAllPreviews()}_applyRadiusMode(t){if(t!=="relative"&&t!=="absolute")return;const n={...this.state.style};n.radiusMode=t,t==="relative"?n.radiusValue=n.relRadiusValue??n.radiusValue:n.radiusValue=fi(n.absRadiusValue??n.radiusValue),this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_applyNurbsDegreeValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.nurbsDegree=Math.max(2,Math.min(5,Math.round(t))),this.state.style=s,n?this.elements.nurbsDegreeInput.value=s.nurbsDegree:this.elements.nurbsDegreeSlider.value=s.nurbsDegree,this._updateUIFromState()}_applyTypeSelection(t){const n={...this.state.style,type:t};switch(t){case"linear":n.mode="piecewise",n.order=1,n.pointHandling="anchor";break;case"spline":n.mode="piecewise",n.order=3,n.pointHandling="anchor";break;case"radius":n.mode="radius",n.radiusMode=n.radiusMode||"relative",n.radiusValue=n.radiusMode==="relative"?n.relRadiusValue??n.radiusValue:fi(n.absRadiusValue??n.radiusValue),n.pointHandling=n.pointHandling==="mixed"?"mixed":"control";break}this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_updateUIFromState(){const{preset:t,mode:n,order:s,radiusMode:i,radiusValue:o,tension:a,type:r,linearStyle:c,nurbsDegree:l,pointHandling:d}=this.state.style;this.previewCards.forEach((y,m)=>{y.card.classList.toggle("is-active",m===t)}),this.wrapper.querySelectorAll("#type-list .toggle-row").forEach(y=>{y.classList.toggle("is-active",y.dataset.type===r)}),this.wrapper.querySelectorAll("#linear-style-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.linearStyle===c)}),this.wrapper.querySelectorAll("#point-handling-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.pointHandling===d)});const h=this.wrapper.querySelector("#linear-section"),f=this.wrapper.querySelector("#handling-section"),u=this.wrapper.querySelector("#tension-section"),p=this.wrapper.querySelector("#radius-section"),g=this.wrapper.querySelector("#nurbs-section");h.classList.toggle("is-hidden",r!=="linear"),f.classList.toggle("is-hidden",!0),u.classList.toggle("is-hidden",r!=="spline"),p.classList.toggle("is-hidden",r!=="radius"),g.classList.toggle("is-hidden",!0),this.wrapper.querySelectorAll("#radius-mode-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.radiusMode===i)}),i==="absolute"?(this.elements.radiusSlider.value=Zs(this.state.style.absRadiusValue),this.elements.radiusInput.value=Rl(o).toFixed(0),this.elements.radiusInput.min="0",this.elements.radiusInput.max=String(na),this.elements.radiusInput.step="1"):(this.elements.radiusSlider.value=Zs(o),this.elements.radiusInput.value=Number(this.elements.radiusSlider.value).toFixed(2),this.elements.radiusInput.min="0",this.elements.radiusInput.max="1",this.elements.radiusInput.step="0.01"),this.elements.tensionSlider.value=Math.max(0,Math.min(1,a)),this.elements.tensionInput.value=Number(a).toFixed(2),this.elements.nurbsDegreeSlider.value=l,this.elements.nurbsDegreeInput.value=l}_renderAllPreviews(){Ur.forEach(t=>{const n=this.previewCards.get(t.id);n&&this._renderPreviewCard(n.canvas,t.id,t.id===this.state.style.preset)})}_renderPreviewCard(t,n,s){const i=t.getBoundingClientRect(),o=window.devicePixelRatio||1,a=Math.max(1,Math.floor(i.width*o)),r=Math.max(1,Math.floor(i.height*o));(t.width!==a||t.height!==r)&&(t.width=a,t.height=r);const c=t.getContext("2d");c.save(),c.scale(o,o),c.clearRect(0,0,i.width,i.height),c.fillStyle="#1f2937",c.fillRect(0,0,i.width,i.height),this._drawPreset(c,i.width,i.height,n,s),c.restore()}_drawPreset(t,n,s,i,o){const r=n-32,c=s-32,l=I=>({x:16+I.x*r,y:16+I.y*c}),d=this._getPresetPoints(i),h=o?"#3b82f6":"#6b7280",f=o?"#60a5fa":"#94a3b8";t.lineWidth=this._getStrokeWidth(),t.lineJoin=this.state.style.mode==="radius"?"round":"miter",t.lineCap="round",t.strokeStyle=h;const u=[],p=new Set,g=new Set,y=I=>{p.has(I)||(p.add(I),u.push(I))},m=this.state.style.mode==="radius"&&i==="branching",x=(I,P,L)=>{const A=L.x-P.x,_=L.y-P.y,D=I.x-P.x,O=I.y-P.y,X=A*A+_*_;return X<1e-6?0:(D*A+O*_)/X},S=I=>{if(!I)return 0;const P=Math.hypot(I.b.x-I.a.x,I.b.y-I.a.y);return P<=1e-6?0:this.state.style.radiusMode==="relative"?Math.max(0,Math.min(.5,this.state.style.radiusValue*.5)):Math.max(0,Math.min(.5,this.state.style.radiusValue/P))},M=(I,P,L,A,_)=>{if(I.length<3||!A)return I;const D=S(A),O=L?_?0:.5:D,X=L?1-D:_?1:.5,F=I.filter(V=>{if(V.tag==="line"&&V.edgeIndex!==void 0){if(V.edgeIndex!==P)return!0;const $=x(V,A.a,A.b);return $>=O&&$<=X}return V.tag!=="line"});return F.length>=2,F},b=d.faces&&d.vertices?d.vertices:null,E=d.faces||null,C=!!(b&&E&&E.length);let v=null,T=null;const w=Math.hypot(r,c);if(d.paths.forEach((I,P)=>{const L=I.points,A=L.map(l);if(L.forEach(y),P===0&&i==="closed"&&(console.groupCollapsed("anchor-control-debug"),console.log("mode",this.state.style.mode),console.log("type",this.state.style.type),console.log("pointHandling",this.state.style.pointHandling),console.log("radiusMode",this.state.style.radiusMode),console.log("radiusValue",this.state.style.radiusValue)),A.length>=2){t.save(),t.lineWidth=Math.max(1,this._getStrokeWidth()*.6),t.strokeStyle="#94a3b8",t.lineCap="round",t.lineJoin="round",t.setLineDash(Jc);const D=[];for(let O=0;O<A.length-1;O++)m&&i==="branching"&&P===0&&O===A.length-2||D.push([A[O],A[O+1]]);I.closed&&D.push([A[A.length-1],A[0]]),D.forEach(([O,X])=>{const F=Math.round(O.x),V=Math.round(O.y),$=Math.round(X.x),R=Math.round(X.y),N=`${F}:${V}`,k=`${$}:${R}`,Y=N<k?`${N}|${k}`:`${k}|${N}`;g.has(Y)||(g.add(Y),t.beginPath(),t.moveTo(O.x,O.y),t.lineTo(X.x,X.y),t.stroke())}),t.restore()}let _=this._getInterpolatedPoints(A,I.closed,w);if(_.length<2){P===0&&i==="closed"&&(console.log("drawPoints empty"),console.groupEnd());return}if(P===0&&i==="closed"){const D=_.reduce((X,F)=>({x:Math.min(X.x,F.x),y:Math.min(X.y,F.y)}),{x:1/0,y:1/0}),O=_.reduce((X,F)=>({x:Math.max(X.x,F.x),y:Math.max(X.y,F.y)}),{x:-1/0,y:-1/0});console.log("drawPoints bounds",{min:D,max:O}),console.groupEnd()}if(m){const D=6+this.state.style.order*4,O=this.state.style.pointHandling==="control";_=Kr(A,I.closed,this.state.style.radiusMode,this.state.style.radiusValue,D,!1,!1,O,!0);const X=I.trueEndpointStart===!0,F=I.trueEndpointEnd===!0;if(P===0){const V=A.length>=2?{a:A[0],b:A[1]}:null;_=M(_,0,!0,V,X);const $=A.length>=2?{a:A[A.length-2],b:A[A.length-1]}:null;_=M(_,A.length-2,!1,$,F)}else{const V=A.length>=2?{a:A[0],b:A[1]}:null,$=A.length>=2?{a:A[A.length-2],b:A[A.length-1]}:null;_=M(_,0,!0,V,X),_=M(_,A.length-2,!1,$,F)}if(_.length<2)return;_=_.map(V=>({x:V.x,y:V.y}))}if(this.state.style.mode!=="radius"&&(this.state.style.type!=="spline"||I.forceTrim)){if(I.trimFromPoint){const D=l(I.trimFromPoint);let O=0,X=1/0;_.forEach((F,V)=>{const $=Math.hypot(F.x-D.x,F.y-D.y);$<X&&(X=$,O=V)}),_=_.slice(O),!_.length||Math.hypot(_[0].x-D.x,_[0].y-D.y)>1e-6?_.unshift(D):_[0]=D}if(I.trimToPoint){const D=l(I.trimToPoint);let O=0,X=1/0;_.forEach((F,V)=>{const $=Math.hypot(F.x-D.x,F.y-D.y);$<X&&(X=$,O=V)}),_=_.slice(0,O+1),!_.length||Math.hypot(_[_.length-1].x-D.x,_[_.length-1].y-D.y)>1e-6?_.push(D):_[_.length-1]=D}}if(!(_.length<2)){if(t.beginPath(),t.moveTo(_[0].x,_[0].y),_.slice(1).forEach(D=>t.lineTo(D.x,D.y)),I.closed&&(this.state.style.mode!=="radius"||this.state.style.radiusValue<=1e-6)&&t.closePath(),t.stroke(),I.isBoundary&&I.closed?(v=_,T=new Set(L)):!C&&i==="closed"&&I.closed&&!Object.prototype.hasOwnProperty.call(I,"isBoundary")&&(v=_),this.state.style.mode==="radius"&&this.state.style.pointHandling==="anchor"){const D=sd(A,I.closed,this.state.style.radiusMode,this.state.style.radiusValue);D.length&&(t.save(),t.fillStyle="#f87171",D.forEach(O=>{t.beginPath(),t.arc(O.x,O.y,3,0,Math.PI*2),t.fill()}),t.restore())}this.state.style.type==="linear"&&this.state.style.linearStyle==="arrows"&&this._drawEdgeArrows(t,A,I.closed)}}),v&&v.length>=2&&(t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)",t.beginPath(),t.moveTo(v[0].x,v[0].y),v.slice(1).forEach(I=>t.lineTo(I.x,I.y)),t.closePath(),t.fill(),t.restore()),C){t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)";let I=!1;E.forEach(P=>{if(!Array.isArray(P)||P.length<3)return;const L=P.map(O=>b[O]).filter(Boolean);if(L.length<3)return;const A=T?L.every(O=>T.has(O)):!1;if(A&&v&&!I){t.beginPath(),t.moveTo(v[0].x,v[0].y),v.slice(1).forEach(O=>t.lineTo(O.x,O.y)),t.closePath(),t.fill(),I=!0;return}if(A&&v)return;const _=L.map(l),D=this._getInterpolatedPoints(_,!0,w);!D||D.length<2||(t.beginPath(),t.moveTo(D[0].x,D[0].y),D.slice(1).forEach(O=>t.lineTo(O.x,O.y)),t.closePath(),t.fill())}),t.restore()}t.fillStyle=f,u.map(l).forEach(I=>{t.beginPath(),t.arc(I.x,I.y,3.5,0,Math.PI*2),t.fill()})}_getStrokeWidth(){return 2}_drawEdgeArrows(t,n,s){if(n.length<2)return;const i=10,o=6,a=n.length,r=s?a:a-1;t.save(),t.fillStyle=t.strokeStyle;for(let c=0;c<r;c++){const l=n[c],d=n[(c+1)%a],h=d.x-l.x,f=d.y-l.y,u=Math.hypot(h,f);if(u<.001)continue;const p=h/u,g=f/u,y=d,m={x:y.x-p*i,y:y.y-g*i},x={x:m.x+-g*(o/2),y:m.y+p*(o/2)},S={x:m.x+g*(o/2),y:m.y-p*(o/2)};t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(x.x,x.y),t.lineTo(S.x,S.y),t.closePath(),t.fill()}t.restore()}_getInterpolatedPoints(t,n,s=1){const{mode:i,order:o,type:a,pointHandling:r,nurbsDegree:c,radiusMode:l,radiusValue:d}=this.state.style;if(i==="radius"||t.length<2){if(i==="radius"){const u=6+o*4,p=d;return p<=1e-6?t:Kr(t,n,l,p,u,!1,!1,r==="control")}return t}const h=4+o*4;if(a==="linear"||o===1)return td(t,n,h);if(t.length<3)return t;const f=this.state.style.tension??.5;return qr(t,f,n,h)}_buildControlCatmullTargets(t,n){if(t.length<2)return t;const s=[],i=t.length,o=n?i:i-1;n||s.push(t[0]);for(let a=0;a<o;a++){const r=t[a],c=t[(a+1)%i];s.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5})}return n||s.push(t[i-1]),s}_buildMixedCatmullTargets(t,n){if(t.length<2)return t;const s=this._getPathOrientation(t,n),i=[],o=t.length;for(let a=0;a<o;a++){if(!n&&(a===0||a===o-1)){i.push(t[a]);continue}const r=t[(a-1+o)%o],c=t[a],l=t[(a+1)%o],d=(c.x-r.x)*(l.y-c.y)-(c.y-r.y)*(l.x-c.x);(s>=0?d>=0:d<=0)?i.push(c):(i.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5}),i.push({x:(c.x+l.x)*.5,y:(c.y+l.y)*.5}))}return i}_buildMixedControlPoints(t,n,s){if(t.length<3)return t;const i=this._getPathOrientation(t,n),o=Math.max(0,s-1),a=[];n?t.length:t.length-1;for(let r=0;r<t.length;r++){const c=(r-1+t.length)%t.length,l=(r+1)%t.length,d=t[c],h=t[r],f=t[l],u=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),g=!n&&(r===0||r===t.length-1)||(i>=0?u>=0:u<=0);if(a.push(h),g)for(let y=0;y<o;y++)a.push({x:h.x,y:h.y})}return a}_getPathOrientation(t,n){if(!n)return 1;let s=0;for(let i=0;i<t.length;i++){const o=t[(i+1)%t.length];s+=t[i].x*o.y-o.x*t[i].y}return s}_getPresetPoints(t){const n=this.state.previewPoints[t];if(n&&n.vertices&&n.edges)return this._buildPathsFromGraph(n);if(t==="open")return{paths:this.state.previewPoints.open.map(s=>({closed:!1,points:s}))};if(t==="branching"){const s=this.state.previewPoints.branching[0]||[],i=s.length>=1?s[s.length-1]:null,o=s.length>=2?s[s.length-2]:null,a=this.state.style.type==="spline",r=a?s.slice(Math.max(0,s.length-3)):s.slice(Math.max(0,s.length-2));return{paths:this.state.previewPoints.branching.map((c,l)=>{if(l===0)return{closed:!1,points:c,trimToPoint:a?o:null,forceTrim:a,trueEndpointStart:!0,trueEndpointEnd:!1};const d=[...r],h=c[0],u=i&&h&&Math.abs(h.x-i.x)<1e-6&&Math.abs(h.y-i.y)<1e-6?c.slice(1):c;return d.push(...u),{closed:!1,points:d,trimFromPoint:a?o:i,forceTrim:a,trueEndpointStart:!1,trueEndpointEnd:!0}})}}if(t==="branching4"){const s=this.state.previewPoints.branching4;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[],a=d=>{const h=Math.hypot(d.x,d.y);return h>1e-6?{x:d.x/h,y:d.y/h}:{x:0,y:0}},r=i.map(d=>{if(d.length<2)return null;const h=d[d.length-1],f=d[d.length-2];return a({x:h.x-f.x,y:h.y-f.y})}),c=o.map(d=>{if(d.length<2)return null;const h=d[0],f=d[1];return a({x:f.x-h.x,y:f.y-h.y})});if(i.length!==1&&o.length!==1){const d=[];if(i.length===2&&o.length===2){const f=this.dragState?.presetId==="branching4"&&this.dragState.pointIndex!==null,u=w=>f?(this.branching4Pairing||(this.branching4Pairing=w),this.branching4Pairing):(this.branching4Pairing=null,w),p=r.map(w=>w?{x:-w.x,y:-w.y}:null),g=w=>Math.atan2(w.y,w.x),y=(w,I)=>{const P=p[w],L=c[I];return!P||!L?-1/0:P.x*L.x+P.y*L.y},m=(w,I)=>w.x*I.y-w.y*I.x,S=[{type:"in",idx:0,dir:p[0]},{type:"in",idx:1,dir:p[1]},{type:"out",idx:0,dir:c[0]},{type:"out",idx:1,dir:c[1]}].filter(w=>w.dir).slice().sort((w,I)=>g(w.dir)-g(I.dir)),M=S.map((w,I)=>w.type==="in"?I:null).filter(w=>w!==null),b=M.length===2&&(Math.abs(M[0]-M[1])===1||Math.abs(M[0]-M[1])===3),E=w=>y(0,w[0])+y(1,w[1]),C=[0,1],v=[1,0];let T=C;if(b){const w=(A,_)=>{const D=Math.abs(A-_);return Math.min(D,4-D)},I=A=>S.findIndex(_=>_.type==="out"&&_.idx===A),P=A=>S.findIndex(_=>_.type==="in"&&_.idx===A),L=A=>{const _=w(P(0),I(A[0])),D=w(P(1),I(A[1]));return _+D};T=L(v)>L(C)?v:C}else{const w=E(C),I=E(v);if(I===w&&this.state.style.type==="spline"){const P=L=>{const A=p[0]&&c[L[0]]?Math.sign(m(p[0],c[L[0]])):0,_=p[1]&&c[L[1]]?Math.sign(m(p[1],c[L[1]])):0;return(A<0?1:0)+(_<0?1:0)};T=P(v)>P(C)?v:C}else T=I>w?v:C}return T=u(T),i.forEach((w,I)=>{const P=T[I],L=o[P],A=L[0]===w[w.length-1]?L.slice(1):L;d.push({closed:!1,points:[...w,...A]})}),{paths:d}}const h=new Set;return i.forEach((f,u)=>{let p=-1,g=-1/0;const y=r[u];if(o.forEach((m,x)=>{if(h.has(x))return;const S=c[x];if(!y||!S)return;const M=y.x*S.x+y.y*S.y;M>g&&(g=M,p=x)}),p>=0){h.add(p);const m=o[p],x=m[0]===f[f.length-1]?m.slice(1):m;d.push({closed:!1,points:[...f,...x]})}else d.push({closed:!1,points:f})}),o.forEach((f,u)=>{h.has(u)||d.push({closed:!1,points:f})}),{paths:d}}const l=[];return i.length===1?o.forEach(d=>{const h=i[0],f=d[0]===h[h.length-1]?d.slice(1):d;l.push({closed:!1,points:[...h,...f]})}):i.forEach(d=>{const h=o[0],f=h[0]===d[d.length-1]?h.slice(1):h;l.push({closed:!1,points:[...d,...f]})}),{paths:l}}if(t==="branching5"){const s=this.state.previewPoints.branching5;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[];return{paths:[...i.map(r=>({closed:!1,points:r})),...o.map(r=>({closed:!1,points:r}))]}}return{paths:[{closed:!0,points:this.state.previewPoints.closed[0]}]}}_buildPathsFromGraph(t){const n=t.vertices||[],s=t.edges||[];if(!n.length||!s.length)return{paths:[]};const i=new Map,o=new Map,a=new Map;s.forEach(([R,N])=>{i.has(R)||i.set(R,[]),i.get(R).push(N),o.has(N)||o.set(N,[]),o.get(N).push(R),a.set(R,(a.get(R)||0)+1),a.set(N,(a.get(N)||0)+1)});const r=new Map,c=new Map,l=(R,N)=>R<N?`${R}-${N}`:`${N}-${R}`;s.forEach(([R,N])=>{const k=l(R,N);c.has(k)||c.set(k,[R,N]),r.has(R)||r.set(R,new Set),r.has(N)||r.set(N,new Set),r.get(R).add(N),r.get(N).add(R)});const d=(R,N)=>Math.atan2(n[N].y-n[R].y,n[N].x-n[R].x),h=new Map;n.forEach((R,N)=>{const k=[...r.get(N)||[]];k.sort((Y,B)=>d(N,Y)-d(N,B)),h.set(N,k)});const f=(R,N)=>{const k=h.get(N)||[];if(!k.length)return null;const Y=k.indexOf(R);return Y<0?k[0]:k[(Y-1+k.length)%k.length]},p=(()=>{const R=[],N=new Set,k=(Y,B)=>`${Y}->${B}`;return c.forEach(([Y,B])=>{[[Y,B],[B,Y]].forEach(([G,W])=>{const z=k(G,W);if(N.has(z))return;const K=[];let H=G,q=W,se=0;for(;se++<s.length*4;){N.add(k(H,q)),K.push(H);const fe=f(H,q);if(fe==null)break;const ae=q,ne=fe;if(H=ae,q=ne,H===G&&q===W)break}K.length>=3&&R.push(K)})}),R})(),g=R=>[...R].sort((N,k)=>N-k).join("_"),y=[],m=new Set;p.forEach(R=>{const N=g(R);m.has(N)||(m.add(N),y.push(R))});const x=R=>{let N=0;for(let k=0;k<R.length;k++){const Y=n[R[k]],B=n[R[(k+1)%R.length]];N+=Y.x*B.y-B.x*Y.y}return N*.5};let S=null;if(y.length){let R=null,N=-1/0;y.forEach(k=>{const Y=Math.abs(x(k));Y>N&&(N=Y,R=k)}),S=R}const M=new Set(S||[]),b=new Set;if(S&&S.length>=2)for(let R=0;R<S.length;R++){const N=S[R],k=S[(R+1)%S.length];b.add(l(N,k))}const E=new Map,C=R=>Math.atan2(R.y,R.x),v=(R,N)=>R.x*N.y-R.y*N.x,T=(R,N)=>R.x*N.x+R.y*N.y,w=(R,N)=>({x:N.x-R.x,y:N.y-R.y}),I=R=>{const N=Math.hypot(R.x,R.y);return N>1e-6?{x:R.x/N,y:R.y/N}:{x:0,y:0}};n.forEach((R,N)=>{if(M.has(N))return;const k=o.get(N)||[],Y=i.get(N)||[];if(k.length===2&&Y.length===2){const B=k.map(ee=>I(w(n[ee],n[N]))),G=Y.map(ee=>I(w(n[N],n[ee]))),W=B.map(ee=>({x:-ee.x,y:-ee.y})),z=(ee,ce)=>T(W[ee],G[ce]),K=[0,1],H=[1,0],q=z(0,0)+z(1,1),se=z(0,1)+z(1,0),ae=[{type:"in",idx:0,dir:W[0]},{type:"in",idx:1,dir:W[1]},{type:"out",idx:0,dir:G[0]},{type:"out",idx:1,dir:G[1]}].filter(ee=>ee.dir).slice().sort((ee,ce)=>C(ee.dir)-C(ce.dir)),ne=ae.map((ee,ce)=>ee.type==="in"?ce:null).filter(ee=>ee!==null),Z=ne.length===2&&(Math.abs(ne[0]-ne[1])===1||Math.abs(ne[0]-ne[1])===3);let Q=K;if(Z){const ee=(Se,Me)=>{const Ze=Math.abs(Se-Me);return Math.min(Ze,4-Ze)},ce=Se=>ae.findIndex(Me=>Me.type==="out"&&Me.idx===Se),de=Se=>ae.findIndex(Me=>Me.type==="in"&&Me.idx===Se),ve=Se=>{const Me=ee(de(0),ce(Se[0])),Ze=ee(de(1),ce(Se[1]));return Me+Ze};Q=ve(H)>ve(K)?H:K}else if(se===q&&this.state.style.type==="spline"){const ee=ce=>{const de=Math.sign(v(W[0],G[ce[0]])),ve=Math.sign(v(W[1],G[ce[1]]));return(de<0?1:0)+(ve<0?1:0)};Q=ee(H)>ee(K)?H:K}else Q=se>q?H:K;k.forEach((ee,ce)=>{const de=Y[Q[ce]];E.set(`${ee}->${N}`,de)})}});const P=n.map((R,N)=>N).filter(R=>(o.get(R)||[]).length===0),L=[],A=new Set,_=(R,N)=>`${R}->${N}`,D=(R,N)=>b.has(l(R,N)),O=(R,N,k,Y=!1)=>{const B=_(R,N);if(A.has(B)){L.push([...k,N]);return}A.add(B);const G=[...k,N];if(!Y&&M.has(N)&&G.length>1){L.push(G);return}const W=i.get(N)||[],z=o.get(N)||[],K=E.get(`${R}->${N}`);if(K!==void 0){if(G.includes(K)){L.push(G);return}O(N,K,G);return}if(W.length===0){L.push(G);return}if(z.length===2&&W.length>2){L.push(G);return}if(z.length===1&&W.length>1){W.forEach(H=>{!Y&&D(N,H)||O(N,H,G,Y)});return}if(z.length<=1&&W.length===1){if(!Y&&D(N,W[0])){L.push(G);return}O(N,W[0],G,Y);return}W.forEach(H=>{!Y&&D(N,H)||O(N,H,G,Y)})};let X=null;if(S&&S.length>=3)X=[...S,S[0]],L.push(X),s.forEach(([R,N])=>{D(R,N)&&A.add(_(R,N))}),s.forEach(([R,N])=>{const k=_(R,N);A.has(k)||O(R,N,[R],!1)});else if(P.length)P.forEach(R=>{(i.get(R)||[]).forEach(k=>O(R,k,[R]))});else{const R=s[0]?.[0];R!==void 0&&(i.get(R)||[]).forEach(k=>O(R,k,[R]))}const F=L.map(R=>{const N=R.length>2&&R[0]===R[R.length-1],k=N?R.slice(0,-1):R,Y=k.map(H=>n[H]),B=k[0],G=k[k.length-1],W=a.get(B)||0,z=a.get(G)||0,K=R===X;return{closed:N,points:Y,isBoundary:K,trueEndpointStart:W===1,trueEndpointEnd:z===1,trimFromPoint:!K&&this.state.style.type==="spline"&&W>2?n[B]:null,trimToPoint:!K&&this.state.style.type==="spline"&&z>2?n[G]:null,forceTrim:!K&&this.state.style.type==="spline"}}),V=S?g(S):null,$=y.filter(R=>g(R)!==V);return{paths:F,vertices:n,faces:$}}_handlePreviewMouseDown(t,n){const s=this._findHitPoint(t,n);s&&(this.dragState=s,t.preventDefault())}_handlePreviewMouseMove(t){const{presetId:n,pathIndex:s,pointIndex:i,vertexIndex:o,ioType:a,ioIndex:r}=this.dragState;if(n===null)return;const c=this.previewCards.get(n);if(!c)return;const{x:l,y:d}=this._getNormalizedPoint(t,c.canvas),h={x:Math.max(0,Math.min(1,l)),y:Math.max(0,Math.min(1,d))},f=this.state.previewPoints[n];if(f&&f.in&&f.out&&a&&Number.isInteger(r)){const x=f[a]?.[r]?.[i];x&&(x.x=h.x,x.y=h.y,this._renderAllPreviews());return}if(f&&f.vertices&&f.edges){Number.isInteger(o)&&f.vertices[o]&&(f.vertices[o].x=h.x,f.vertices[o].y=h.y,f.pathOverrides&&delete f.pathOverrides,this._renderAllPreviews());return}const p=(f&&f.vertices&&f.edges?f.pathOverrides?.map(y=>y.points):this.state.previewPoints[n])?.[s];if(!p)return;const g=p[i];g?(g.x=h.x,g.y=h.y):p[i]=h,this._renderAllPreviews()}_handlePreviewMouseUp(){this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}_findHitPoint(t,n){const s=this.previewCards.get(n);if(!s)return null;const o=s.canvas.getBoundingClientRect(),a=t.clientX-o.left,r=t.clientY-o.top,c=16,l=o.width-c*2,d=o.height-c*2,h=8,f=this.state.previewPoints[n];if(f&&f.in&&f.out){const p=[...f.in.map((g,y)=>({points:g,ioType:"in",ioIndex:y})),...f.out.map((g,y)=>({points:g,ioType:"out",ioIndex:y}))];for(let g=0;g<p.length;g++){const{points:y,ioType:m,ioIndex:x}=p[g];for(let S=0;S<y.length;S++){const M=c+y[S].x*l,b=c+y[S].y*d;if(Math.hypot(a-M,r-b)<=h)return{presetId:n,pathIndex:g,pointIndex:S,vertexIndex:null,ioType:m,ioIndex:x}}}return null}const u=f&&f.vertices&&f.edges?this._getPresetPoints(n).paths.map(p=>p.points):this.state.previewPoints[n];for(let p=0;p<u.length;p++){const g=u[p];for(let y=0;y<g.length;y++){const m=c+g[y].x*l,x=c+g[y].y*d;if(Math.hypot(a-m,r-x)<=h){let S=null;return f&&f.vertices&&f.edges&&(S=f.vertices.indexOf(g[y]),S<0&&(S=null)),{presetId:n,pathIndex:p,pointIndex:y,vertexIndex:S,ioType:null,ioIndex:null}}}}return null}_getNormalizedPoint(t,n){const s=n.getBoundingClientRect(),i=16,o=s.width-i*2,a=s.height-i*2,r=(t.clientX-s.left-i)/o,c=(t.clientY-s.top-i)/a;return{x:r,y:c}}}function Oo(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function rd(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,s=[];let i=0,o;for(;(o=n.exec(t))!==null;){const c=o[0],l=o.index;l>i&&s.push({type:"text",content:t.substring(i,l)}),c==="\\$"?s.push({type:"text",content:"$"}):s.push({type:"math",content:c}),i=l+c.length}i<t.length&&s.push({type:"text",content:t.substring(i)});const a=[];let r=null;for(const c of s)c.type==="text"?r===null?r={type:"text",content:c.content}:r.content+=c.content:(r!==null&&(a.push(r),r=null),a.push(c));return r!==null&&a.push(r),a.length===0&&s.length===1&&s[0].type==="text"?s:a}function ld(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let s=null,i=!1;if(t&&t[1]?.trim()?(s=t[1].trim(),i=!0):n&&n[1]?.trim()&&(s=n[1].trim(),i=!1),s===null)return`<span class="text-segment">${Oo(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(s,{throwOnError:!1,displayMode:i,output:"html",strict:"warn"})}catch(o){return console.error("KaTeX renderToString unexpected error:",o),`<span class="katex-error" title="${Oo(o.message||"Unknown KaTeX error")}">${Oo(e)}</span>`}}function cd(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const s=t==null?"":String(t);let i="";try{i=rd(s).map(a=>a.type==="text"?`<span class="text-segment">${Oo(a.content)}</span>`:a.type==="math"?ld(a.content):"").join("")}catch(o){console.error("Error processing string segments for rendering:",o,s),i=`<span class="katex-error" title="${Oo(String(o.message||"Unknown error"))}">Error</span>`}e.innerHTML=i}function dd(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const s=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let i;const o=[];for(s.lastIndex=0;(i=s.exec(e))!==null;){const[,f,u,p,g,y,m,x,S,M,b,E]=i;let C={};if(f){const v=f.split("_"),T=v[0].slice(1),w=v[1].slice(1);C={type:"backslashSubscript",value:`\\mathrm{${T}}_\\mathrm{${w}}`}}else if(u)C={type:"doubleBackslash",value:"\\\\"};else if(p)C={type:"command",value:p};else if(g)C={type:"backslashLetter",value:g.slice(1)};else if(y){C={type:"word",value:y};const v=o[o.length-1],T=o[o.length-2],w=v?.type==="other"&&v.value==="{"&&T?.type==="command";C.isArgument=w}else m?C={type:"number",value:m}:x?C={type:"dollar",value:"\\$"}:S?C={type:"ampersand",value:"&"}:M?C={type:"space",value:" "}:b?C={type:"newline",value:"\\\\"}:E&&(C={type:"other",value:E});C.type&&o.push(C)}const a=["a","I"],r=["+","-","=","*","/","<",">"],c=(f,u)=>{let p=f+u;for(;p>=0&&p<o.length;){if(o[p].type!=="space")return o[p];p+=u}return null},l=f=>f?f.type==="other"&&r.includes(f.value):!1,d=f=>f?f.type==="backslashLetter"||f.type==="word"&&f.value.length===1&&!a.includes(f.value):!1;let h="";for(let f=0;f<o.length;f++){const u=o[f];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":h+=u.value;break;case"other":["#","%"].includes(u.value)?h+="\\"+u.value:h+=u.value;break;case"backslashLetter":h+=u.value;break;case"word":if(u.isArgument)h+=u.value;else if(u.value.length>1)h+=`\\mathrm{${u.value}}`;else{const x=o[f-1],S=o[f-2],M=x?.type==="other"&&x.value==="(",b=M&&S?.type==="space",E=M&&S?.type!=="space",C=c(f,-1),v=c(f,1),T=l(C)||l(v);b?h+=`\\mathrm{${u.value}}`:a.includes(u.value)?T||E?h+=u.value:h+=`\\mathrm{${u.value}}`:h+=u.value}break;case"space":let g=!0;const y=c(f,-1),m=c(f,1);if(!y||!m)g=!0;else{const x=d(y),S=d(m),M=l(y),b=l(m);(M||b)&&(g=!1),x&&S&&(g=!1)}h+=g?"\\ ":" ";break;default:h+=u.value;break}}if(h.endsWith("\\ ")){const f=h.match(/(\\ )+$/);if(f){const u=f[0].length/2,p="\\,".repeat(u);h=h.replace(/(\\ )+$/,p)}}return h===""?"":`$$${h}$$`}const hd={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},fd={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},Jr=5,ko=25,Na=20,ud=20,gd=.1,Ll=[1/4,1/3,1/2,2/3,3/4],_i=4,Hs=30,Je=5,sa=Hs/2,ir=10,ws=2,qn=1,Wn=[6,6],Nl=[3,3],Sa=360,Fo=180,Ol=90,Ne=2*Math.PI,oa=.01,ar=Math.sqrt(3)/2,pd=400,yd=Math.PI/3,md=1.5,hn=Math.PI/6,xd=1.5,Sd=[2,3],Id=[1,3],bd=.01,vd=8,Md=5,Ed=Math.PI/24,Cd=15,fo="_EDGE_",Di=300,Td=3,rr=7,Zr=1e-15,Qr=1e13,el=1.15,wd=1e-5,Pd=1-1e-5,lr=.001,Fl=.01,Ad=.95,_d=100,Dd=1.5,kd=.5,Rd=1.5,pt=4,ki=.9,is=24,Ps=10,as=8,Ot=20,Xe=12,Oa=5,Fa=20,Ba=10,$a=5,Ia=20,ba=12,Ld="\\phantom{-}0",Ii="i",ui="r",Nd="\\mathrm{Re}",Od="\\mathrm{Im}",Fd=80,Va=1,va=Math.PI/2,Bd="#808080",Qs="rgba(128, 128, 128, 1)",$d=4,Vd=.25,ct=10,He=56,Qo=35,tl=10,Xd=36,Yd=30,_t=40,Gd=20,Eo=32,cr=2,Ln=1.5,Ma=[2,4],zn=1.5,dr=10,Bl=3,Co=15,Wd=4,$l=1,nl=12,Vl=6,zd=2,Hd=24,Kd="T",qd=12,jd=10,Ud=10,Jd=3,Bn=2,Bo=2,an=7,Ea=30,ia=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],Ca=4,bn=12,uo=30,rs=18,gn=1,Xl=1.5,Xa=11,Ri=18,Li=60,Yl=20,Gl=8,Zd=20,sl=18,Ya=1e6,Ga=1e-6,Ni=1e-5,As=.015,eo=32,Qd=10,ol=16,eh=12,th=14,Us="\\hphantom{-}",Gt="\\pi",il="\\delta = ",Po="\\theta = ",hr=15,Ls=.8,Oi=3,us=2,nh=1,sh=3,oh=1,ih=140,al=.4,ah=.9,gi=.05,rh=10,rl=1.5,Ta=[15,5,1],ll=80,lh=.01,xe=1e-9,fr=50,ch=6,dh=10,ur=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let s=1;s<=n*4;s++)e.add(s/n);return Array.from(e).sort((n,s)=>n-s)})();function hh(e,t){const n=new Set;n.add(0);for(let s=1;s<=e;s++)for(let i=1;i<=s*t;i++)n.add(i/s);return Array.from(n).sort((s,i)=>s-i)}const cs=hh(ch,dh),Nn="regular",mn=" transformation_rotation",ts=" transformation_scale",vn="transformation_rotate_scale",Ms="transformation_directional_scale",aa="none",gr="regular",Wo="complex",ra="polar",ei="none",pr="lines",yr="points",mr="triangular",xr="polar",Ns="degrees",ti="radians",zo="none",Ho="on",fh="none",uh=" ",gh="Escape",ph="Delete",yh="Backspace",mh="r",cl="=",dl="+",hl="-",fl="c",ul="v",gl="x",wa="z",pl="y",yl="a",et="vertex",tt="edge",at="face",Ht="text",xh=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],Sh=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c},ml=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},xl=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Ih=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},$o=(e,t=!1)=>{const n=[],s=e.length,i=t?s:s-1;for(let o=0;o<i;o++)n.push({type:"line",a:e[o],b:e[(o+1)%s]});return n},bh=(e,t=!1,n=.5)=>{const i=(1-Math.max(0,Math.min(1,n)))*.5,o=xh(i),a=[];return Sh(e,t).forEach(({p0:c,p1:l,p2:d,p3:h})=>{const f=[c.x,l.x,d.x,h.x],u=[c.y,l.y,d.y,h.y],p=o.map(y=>y.reduce((m,x,S)=>m+x*f[S],0)),g=o.map(y=>y.reduce((m,x,S)=>m+x*u[S],0));a.push({type:"cubic",coeffX:p,coeffY:g})}),a},vh=(e,t,n,s)=>{if(e.length<2||s<=1e-6)return $o(e,t);const i=e.length,o=n==="fixed"?"absolute":n,a=[],r=l=>{const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=xl(d,h),p=xl(f,h),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)return null;const m=Math.min(g,y)*.5;let x,S,M;if(o==="absolute"?(x=Math.max(0,Math.min(s,m))*2,S=ml(p),M=ml(u)):(x=Math.max(0,Math.min(1,s)),S=p,M=u),x<=1e-6)return null;const b=x*.5,E=o==="absolute"?g*.5:.5,C=o==="absolute"?y*.5:.5,v={x:h.x+M.x*E,y:h.y+M.y*E},T={x:h.x+S.x*C,y:h.y+S.y*C},w={x:h.x+M.x*b,y:h.y+M.y*b},I={x:h.x+S.x*b,y:h.y+S.y*b},P=Math.PI,L=-Math.PI/2,A=Ih(P,L);return{origin:h,axisX:S,axisY:M,baseScale:x,midIn:v,midOut:T,arcStart:w,arcEnd:I,startAngle:P,sweep:A}};if(t){const l=[];for(let d=0;d<i;d++){const h=r(d);h&&l.push(h)}return l.length?(a.push({type:"line",a:l[0].midIn,b:l[0].arcStart}),l.forEach(d=>{a.push({type:"affineArc",origin:d.origin,axisX:d.axisX,axisY:d.axisY,baseScale:d.baseScale,startAngle:d.startAngle,sweep:d.sweep}),a.push({type:"line",a:d.arcEnd,b:d.midOut})}),a.push({type:"line",a:l[l.length-1].midOut,b:l[0].midIn}),a):$o(e,!0)}const c=[];for(let l=1;l<i-1;l++){const d=r(l);d&&c.push(d)}return c.length?(a.push({type:"line",a:e[0],b:c[0].midIn}),c.forEach(l=>{a.push({type:"line",a:l.midIn,b:l.arcStart}),a.push({type:"affineArc",origin:l.origin,axisX:l.axisX,axisY:l.axisY,baseScale:l.baseScale,startAngle:l.startAngle,sweep:l.sweep}),a.push({type:"line",a:l.arcEnd,b:l.midOut})}),a.push({type:"line",a:c[c.length-1].midOut,b:e[i-1]}),a):$o(e,!1)};function Mh(e,t,n=!1){return!t||e.length<2?[]:t.type==="linear"?$o(e,n):t.type==="cubic_spline"?bh(e,n,t.tension??.5):t.type==="circular_arc"?vh(e,n,t.radiusMode??"relative",t.radiusValue??0):$o(e,n)}function Eh(e,t){const n=[];return e.forEach((s,i)=>{const o=(a,r=!1)=>{i>0,n.push(a)};if(s.type==="line"){const a=s.a,r=s.b,c=t?t(a):a,l=t?t(r):r,d=Math.hypot(l.x-c.x,l.y-c.y),h=Math.max(2,Math.ceil(d/8));for(let f=0;f<=h;f++){const u=f/h;o({x:a.x+(r.x-a.x)*u,y:a.y+(r.y-a.y)*u},f===0)}return}if(s.type==="cubic"){const a=s.coeffX,r=s.coeffY,c=g=>({x:((a[0]*g+a[1])*g+a[2])*g+a[3],y:((r[0]*g+r[1])*g+r[2])*g+r[3]}),l=c(0),d=c(1),h=t?t(l):l,f=t?t(d):d,u=Math.hypot(f.x-h.x,f.y-h.y),p=Math.max(4,Math.ceil(u/6));for(let g=0;g<=p;g++){const y=g/p;o(c(y),g===0)}return}if(s.type==="affineArc"){const{origin:a,axisX:r,axisY:c,baseScale:l,startAngle:d,sweep:h}=s,f=l*.5,u={x:f,y:f},p=24;for(let g=0;g<=p;g++){const y=g/p,m=d+h*y,x={x:u.x+Math.cos(m)*f,y:u.y+Math.sin(m)*f};o({x:a.x+r.x*x.x+c.x*x.y,y:a.y+r.y*x.x+c.y*x.y},g===0)}}}),n}function gs(e,t,n=!1,s=null){const i=Mh(e,t,n);return i.length?Eh(i,s):e}function It(e,t,n=!1){if(e===0)return"0";const s=Math.abs(e),i=e<0?"-":"";let o;if(n||s>=Ya||s!==0&&s<Ga){if(e===0)return"0";const r=s.toExponential(Math.max(0,t-1)).split("e");let c=parseFloat(r[0]).toString(),l=parseInt(r[1],10);o=`${c} \\cdot 10^{${l}}`}else{const a=s<1?0:Math.floor(Math.log10(s))+1;let r;if(s===0)r=t-1;else if(s<1){let d=0,h=s;for(;h<1&&d<t+5;)h*=10,d++;r=Math.max(0,d-1+t)}else r=Math.max(0,t-a);let c=s.toFixed(r),l=parseFloat(c);if(Math.abs(l)===0&&e!==0)return"0";o=Math.abs(l).toString()}return i+o}function Sr(e,t){return t===0?e:Sr(t,e%t)}function le(e){return e.id1<e.id2?`${e.id1}${fo}${e.id2}`:`${e.id2}${fo}${e.id1}`}function pi(e,t,n,s,i,o){const a=i-n,r=o-s,c=a*a+r*r;if(c===0){const p=e-n,g=t-s;return Math.sqrt(p*p+g*g)}let l=-((n-e)*a+(s-t)*r)/c;l<0&&(l=0),l>1&&(l=1);const d=n+l*a,h=s+l*r,f=e-d,u=t-h;return Math.sqrt(f*f+u*u)}function ue(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function ps(e,t,n,s,i=!1){const o=[];if(t==="none"||!n||n<=0)return o;if(t==="polar"){const a=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,r=Math.hypot(e.x,e.y),c=Math.round(r/n)*n;s.forEach(l=>{if(l.alpha>.01&&l.angle>0){const d=l.angle,f=Math.round(a/d)*d*Math.PI/180;o.push({x:c*Math.cos(f),y:c*Math.sin(f),isGridPoint:!0})}})}else if(t==="triangular"){const a=n*ar,r=e.x/n-e.y/(n*Math.sqrt(3)),c=e.y/a;let l=Math.round(r),d=Math.round(c),h=Math.round(-r-c);const f=Math.abs(l-r),u=Math.abs(d-c),p=Math.abs(h-(-r-c));f>u&&f>p?l=-d-h:u>p&&(d=-l-h);const g=l*n+d*n/2,y=d*a;o.push({x:g,y,isGridPoint:!0})}else if(i){const a=Math.floor(e.x/n)*n,r=Math.floor(e.y/n)*n;o.push({x:a,y:r,isGridPoint:!0},{x:a+n,y:r,isGridPoint:!0},{x:a,y:r+n,isGridPoint:!0},{x:a+n,y:r+n,isGridPoint:!0})}else o.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return o}function $t(){return crypto.randomUUID()}function Rn(e){for(;e<0;)e+=Ne;for(;e>=Ne;)e-=Ne;return e}function Sl(e,t,n=0){let s=t-e,i=Math.round((n-s)/(2*Math.PI));return s+i*(2*Math.PI)}function mt(e){return e=Rn(e),e>Math.PI&&(e-=Ne),e}function Ch(e){for(;e<0;)e+=Sa;for(;e>=Sa;)e-=Sa;return e}function Ir(e,t){const{p1:n,p2:s}=e,{center:i,radius:o}=t,a={x:s.x-n.x,y:s.y-n.y},r={x:n.x-i.x,y:n.y-i.y},c=a.x*a.x+a.y*a.y,l=2*(r.x*a.x+r.y*a.y),d=r.x*r.x+r.y*r.y-o*o;let h=l*l-4*c*d;if(h<0)return[];h=Math.sqrt(h);const f=(-l-h)/(2*c),u=(-l+h)/(2*c);return[{x:n.x+f*a.x,y:n.y+f*a.y},{x:n.x+u*a.x,y:n.y+u*a.y}]}function _s(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let s=2;s*s<=n;s++)for(;n%(s*s)===0;)n/=s*s,t*=s;return[t,n]}function Ds(e,t,n=""){const s=n?`\\${n}`:"";return t===1?e===1&&n?s:`${e}${s}`:e===1?`\\sqrt{${t}}${s}`:`${e}\\sqrt{${t}}${s}`}function re(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function fn(e,t=As,n=eo){if(Math.abs(e)<Ni)return"0";const s=e<0?"-":"",i=Math.abs(e);if(Math.abs(i-Math.round(i))<t){const r=Math.round(i);return s+r.toString()}const o=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[r,c]of o)if(c<=n&&Math.abs(i-r/c)<t)return s+`${r}/${c}`;for(let r=1;r<=n;r++){const c=Math.round(i*r);if(!(c===0&&i>Ni)&&Math.abs(i-c/r)<t/r){const l=Sr(c,r),d=c/l,h=r/l;return h===1?s+`${d}`:s+`${d}/${h}`}}let a=2;return i<.01?a=3:i<.1?a=2:i<10?a=1:a=0,s+i.toFixed(a)}function Os(e,t){if(t.length<3)return!1;const n=e.x,s=e.y;let i=!1;for(let o=0,a=t.length-1;o<t.length;a=o++){const r=t[o].x,c=t[o].y,l=t[a].x,d=t[a].y;if(r===n&&c===s||c===d&&c===s&&n>=Math.min(r,l)&&n<=Math.max(r,l)||r===l&&r===n&&s>=Math.min(c,d)&&s<=Math.max(c,d))return!0;c>s!=d>s&&n<(l-r)*(s-c)/(d-c)+r&&(i=!i)}return i}function jn(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function Th(e,t,n){const s=t.localCoordSystem;if(!s)return null;const i=n(s.origin),o=vd;if(re(e,i)<o)return{face:t,type:"center"};const a=Md,r=Mn({x:1,y:0},s),c=n(r);if(Lt(e,i,c).distance<a)return{face:t,type:"x_axis"};const d=Mn({x:0,y:1},s),h=n(d);return Lt(e,i,h).distance<a?{face:t,type:"y_axis"}:null}function go(e,t){if(Os(e,t))return e;let n=e,s=1/0;for(let i=0;i<t.length;i++){const o=t[i],a=t[(i+1)%t.length],r=Lt(e,o,a);r.distance<s&&(s=r.distance,n={x:r.x,y:r.y})}return n}function Wl(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:s,isColorModePanelExpanded:i,isInterpolationPanelExpanded:o,isTransformPanelExpanded:a,isDisplayPanelExpanded:r,isVisibilityPanelExpanded:c,isSessionsPanelExpanded:l}){const d=(h,f)=>f?h.x>=f.x&&h.x<=f.x+f.width&&h.y>=f.y&&h.y<=f.y+f.height:!1;if(s){for(const h of t.colorTargetIcons||[])if(d(e,h))return{...h,type:"colorTargetIcon"};for(const h of t.colorSwatches||[])if(d(e,h))return{...h,type:"colorSwatch"};if(d(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(d(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(d(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(d(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(i){for(const h of t.colorModeIcons||[])if(d(e,h))return{...h,type:"colorModeIcon"}}if(a){for(const h of t.transformIcons||[])if(d(e,h))return{...h,type:"transformIcon"}}if(o){for(const h of t.interpolationIcons||[])if(d(e,h))return{...h,type:"interpolationIcon"}}if(r){for(const h of t.displayIcons||[])if(d(e,h))return{...h,type:"displayIcon"}}if(c){for(const h of t.visibilityIcons||[])if(d(e,h))return{...h,type:"visibilityIcon"}}if(l){for(const h of t.sessionIcons||[])if(d(e,h))return{...h,type:"sessionIcon"};if(d(e,t.removeSessionButton))return{...t.removeSessionButton,type:"button"};if(d(e,t.addSessionButton))return{...t.addSessionButton,type:"button"}}if(n){if(d(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(d(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(d(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(d(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(d(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(d(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"};if(d(e,t.sessionsToolButton))return{...t.sessionsToolButton,type:"toolButton"};if(d(e,t.colorModeToolButton))return{...t.colorModeToolButton,type:"toolButton"}}return d(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function wh(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function Lt(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y,distance:re(e,t),onSegmentStrict:!0,t:0};let c=(o*s+a*i)/r;const l=c>wd&&c<Pd,d=Math.max(0,Math.min(1,c)),h=t.x+d*s,f=t.y+d*i,u=re(e,{x:h,y:f});return{x:h,y:f,distance:u,onSegmentStrict:l,t:d}}function zl(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y,distance:re(e,t)};let c=(o*s+a*i)/r;const l=t.x+c*s,d=t.y+c*i,h=re(e,{x:l,y:d});return{x:l,y:d,distance:h}}function ut(e,t={},n=0){if(!e||typeof e!="string")return n;const s=e.trim();if(!s)return n;try{const i={...t},o=Object.keys(i),a=o.map(d=>i[d]),r=s.replace(/\^/g,"**"),l=new Function(...o,`'use strict'; return (${r});`)(...a);return Number.isFinite(l)?l:n}catch{return n}}function To(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function Pa(e,t,n){e/=255,t/=255,n/=255;const s=Math.max(e,t,n),i=Math.min(e,t,n);let o,a,r=(s+i)/2;if(s===i)o=a=0;else{const c=s-i;switch(a=r>.5?c/(2-s-i):c/(s+i),s){case e:o=(t-n)/c+(t<n?6:0);break;case t:o=(n-e)/c+2;break;case n:o=(e-t)/c+4;break}o/=6}return[o,a,r]}function Ph(e,t,n,s,i=null){const o=Math.atan2(e.y-t.y,e.x-t.x);if(!s)return{angle:o,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=Ed;let r={angle:o,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},l=(h,f,u=null,p=null)=>{const g=mt(h),y=Math.abs(mt(o-g));if(y<a){const m=c[f],x=r.snapType?c[r.snapType]:1/0;m<x?r={angle:g,difference:y,edgeIndex:u,snapType:f,targetVertexId:p}:m===x&&y<r.difference&&(r={angle:g,difference:y,edgeIndex:u,snapType:f,targetVertexId:p})}};return s.edgeAngles&&s.edgeAngles.forEach((h,f)=>{[h,h+Math.PI/2,h-Math.PI/2,h+Math.PI].forEach(u=>{l(u,"edge",f)})}),s.vertices&&s.vertices.forEach(h=>{if(re(t,h)>xe){const f=Math.atan2(h.y-t.y,h.x-t.x);l(f,"vertex_direction",null,h.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(h=>l(h,"cardinal")),{angle:r.angle,edgeIndex:r.edgeIndex,snapType:r.snapType,snapped:r.difference<1/0,targetVertexId:r.targetVertexId}}function Ah(e,t,n,s,i,o=null,a=null,r="x_axis"){if(!o||!a||!n.alignedEdgeInfo)return{snapped:!1};const c=Cd/a.scale;let l=[];const{v1Id:d,v2Id:h}=n.alignedEdgeInfo,f=i(d),u=i(h);if(f&&u&&f.type==="regular"&&u.type==="regular"){const g=re(f,u);[.25,1/3,.5,2/3,.75,1].forEach(m=>{const x=g*m,S=Math.abs(o-x);l.push({scale:x,distance:S,type:"edge_fraction",priority:m===.5?1:m===1?2:3,fraction:m})})}if(l.length===0)return{snapped:!1};l.sort((g,y)=>g.priority!==y.priority?g.priority-y.priority:g.distance-y.distance);const p=l.find(g=>g.distance<c);return p?{snapped:!0,scale:p.scale,snapType:"edge_fraction",edgeFraction:p.fraction}:{snapped:!1}}function _h(e,t,n,s,i){let o=null,a=1/0;if(t&&(t.vertices&&t.vertices.forEach(r=>{const c=re(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:r,snapType:"vertex",vertexId:r.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(r=>{const c=re(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:{x:r.x,y:r.y},snapType:"edge",edgeInfo:{v1:r.v1,v2:r.v2}})}),t.faceCenters&&t.faceCenters.forEach(r=>{const c=re(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:r,snapType:"faceCenter"})})),n&&n!=="none"&&s&&s.interval1){const r=s.alpha2>s.alpha1&&s.interval2?s.interval2:s.interval1;ps(e,n,r,i,!0).forEach(l=>{const d=re(e,l);d<a&&(a=d,o={snapped:!0,snapPoint:l,snapType:"grid"})})}return o||{snapped:!1}}function Dh(e){if(Array.isArray(e)){const[t,n,s]=Pa(e[0],e[1],e[2]),i=1-s,[o,a,r]=Aa(t,n,i);return[o,a,r]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,s,i,o]=t,a=parseInt(n),r=parseInt(s),c=parseInt(i),[l,d,h]=Pa(a,r,c),f=1-h,[u,p,g]=Aa(l,d,f);return`rgba(${u}, ${p}, ${g}, ${o})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16),[i,o,a]=Pa(t,n,s),r=1-a,[c,l,d]=Aa(i,o,r);return`#${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function la(e){let t=0;const n=e.length;for(let s=0;s<n;s++){const i=(s+1)%n;t+=e[s].x*e[i].y,t-=e[i].x*e[s].y}return t/2}function kh(e,t,n){return Math.max(t,Math.min(n,e))}function Rh(e,t){return e==="light"?fd:t}function Aa(e,t,n){let s,i,o;if(t===0)s=i=o=n;else{const a=(l,d,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?l+(d-l)*6*h:h<.5?d:h<.6666666666666666?l+(d-l)*(6*(.6666666666666666-h)):l),r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;s=a(c,r,e+1/3),i=a(c,r,e),o=a(c,r,e-1/3)}return[Math.round(s*255),Math.round(i*255),Math.round(o*255)]}function Js(e,t){const n=fn(e,.001),s=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${s}`;if(n==="1")return s;if(n==="-1")return`-${s}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${s}`;if(n.includes("/")){let i="",o=n;o.startsWith("-")&&(i="-",o=o.substring(1));const a=o.split("/"),r=a[0],c=a[1];return r==="1"?`${i}\\frac{1}{${c}}${s}`:`${i}\\frac{${r}}{${c}}${s}`}return`${n}${s}`}function je(e,t,n,s,i,o){const a={x:e.x-t.x,y:e.y-t.y};if(i){const r=Math.hypot(o.x,o.y);if(r>xe){const c={x:o.x/r,y:o.y/r},l=a.x*c.x+a.y*c.y,d={x:a.x-l*c.x,y:a.y-l*c.y},h=l*s,f={x:h*c.x+d.x,y:h*c.y+d.y};return{x:t.x+f.x,y:t.y+f.y}}return{x:e.x,y:e.y}}else{let r={...a};r.x*=s,r.y*=s;const c=r.x,l=r.y;return r.x=c*Math.cos(n)-l*Math.sin(n),r.y=c*Math.sin(n)+l*Math.cos(n),{x:t.x+r.x,y:t.y+r.y}}}function ca(e){if(e.length<3)return null;if(e.length===3){const[t,n,s]=e,i=re(n,s),o=re(t,s),a=re(t,n),r=i+o+a;if(r<xe)return null;const c=(i*t.x+o*n.x+a*s.x)/r,l=(i*t.y+o*n.y+a*s.y)/r,h=2*(Math.abs((n.x-t.x)*(s.y-t.y)-(s.x-t.x)*(n.y-t.y))/2)/r;return{center:{x:c,y:l},radius:h}}return Nh(e)}function Lh(e,t,n){const s=Ll.reduce((o,a)=>Math.abs(a-e.t)<Math.abs(o-e.t)?a:o),i={x:t.x+s*(n.x-t.x),y:t.y+s*(n.y-t.y)};return{fraction:s,point:i}}function Nh(e){if(e.length<3)return null;let t={x:e.reduce((i,o)=>i+o.x,0)/e.length,y:e.reduce((i,o)=>i+o.y,0)/e.length};Os(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,s=Il(t,e);for(let i=0;i<ud;i++){let o=!1;const a=s*gd,r=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of r){const l={x:n.x+c.x,y:n.y+c.y};if(Os(l,e)){const d=Il(l,e);d>s&&(n=l,s=d,o=!0)}}if(!o)break}return{center:n,radius:Math.max(s,xe)}}function Il(e,t){let n=1/0;for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length],a=Hl(e,i,o);n=Math.min(n,a)}return n}function Hl(e,t,n){return Lt(e,t,n).distance}function Oh(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=bl(n,t);else if(!n.localCoordSystem.isCustom){const s=bl(n,t);s&&(n.localCoordSystem.origin=s.origin,n.localCoordSystem.scale=s.scale)}})}function Fh(e,t,n){const s=[e];let i=e,o=t;const a=n.size+2;for(let r=0;r<a;r++){if(s.push(o),o===e)return s.pop(),s;const c=n.get(o);if(!c||c.length<1)return null;const l=c.indexOf(i);if(l===-1)return null;const d=(l+1)%c.length,h=c[d];i=o,o=h}return null}function Bh(e,t,n){if(e.length<=1)return e;const s=new Set(t.map(i=>[i.id1,i.id2].sort().join("_")));return e.filter(i=>{const o=i.vertexIds;if(o.length<3)return!1;for(let a=0;a<o.length;a++)for(let r=a+2;r<o.length;r++){if(a===0&&r===o.length-1)continue;const c=o[a],l=o[r],d=[c,l].sort().join("_");if(s.has(d))return!1}return!0})}function da(e,t){const n=new Map,s=new Map;e.forEach(l=>{const d=t(l.id1),h=t(l.id2);!d||!h||d.type!=="regular"||h.type!=="regular"||(s.has(d.id)||s.set(d.id,d),s.has(h.id)||s.set(h.id,h),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,d]of n.entries()){const h=s.get(l);h&&d.sort((f,u)=>{const p=s.get(f),g=s.get(u);if(!p||!g)return 0;const y=Math.atan2(p.y-h.y,p.x-h.x),m=Math.atan2(g.y-h.y,g.x-h.x);return y-m})}const i=[],o=new Set;for(const[l,d]of n.entries())for(const h of d){const f=`${l}->${h}`;if(o.has(f))continue;const u=Fh(l,h,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const m=u[y],x=u[(y+1)%u.length];o.add(`${m}->${x}`)}const g={vertexIds:u};g.id=ue(g),i.push(g)}}const a=Bh(i,e),r=[],c=new Set;return a.forEach(l=>{const d=[...l.vertexIds].sort().join("_");c.has(d)||(r.push(l),c.add(d))}),r}function Fs(e,t,n,s){const i={id1:e.id,id2:t.id,directionFrom:e.id,directionTo:t.id},o=e.x-t.x,a=e.y-t.y,r=o/n,c=a/n,l=1e-5;if(n&&Math.abs(r-Math.round(r))<l&&Math.abs(c-Math.round(c))<l){i.labelMode="exact";const h=Math.round(r),f=Math.round(c);i.exactValue={g2gSquaredSum:h*h+f*f,gridInterval:n}}else i.labelMode="decimal";return i.color=s(tt),i}function Kl(e,t){let n=null,s=1/0;return t.forEach(i=>{if(!i)return;const o=Math.abs(e.x-(i.x+i.width/2));o<s&&o<i.width/2+ct&&(s=o,n=i)}),n}function $h(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function Ge(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],p=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${p})`}Number.isFinite(t)||(t=0),e.isCyclic?t=(t%1+1)%1:t=Math.max(0,Math.min(1,t));let s=n[0],i=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){s=n[u],i=n[u+1];break}const o=i.pos-s.pos,a=o>0?(t-s.pos)/o:0,r=Math.round(s.color[0]+(i.color[0]-s.color[0])*a),c=Math.round(s.color[1]+(i.color[1]-s.color[1])*a),l=Math.round(s.color[2]+(i.color[2]-s.color[2])*a),d=s.alpha!==void 0?s.alpha:1,h=i.alpha!==void 0?i.alpha:1,f=d+(h-d)*a;return`rgba(${r},${c},${l},${f})`}function bl(e,t){const n=e.vertexIds.map(i=>t(i)).filter(i=>i&&i.type==="regular");if(n.length<3)return null;const s=ca(n);return s?{origin:{...s.center},angle:0,scale:s.radius,isCustom:!1,showCoordSystem:!1}:null}function Ao(e,t){if(!t)return e;const n={x:e.x-t.origin.x,y:e.y-t.origin.y},s=Math.cos(-t.angle),i=Math.sin(-t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return t.scale===0?{x:0,y:0}:{x:o.x/t.scale,y:o.y/t.scale}}function Sn(e,t){const n=new Set;return t.forEach(s=>{s.id1===e?n.add(s.id2):s.id2===e&&n.add(s.id1)}),Array.from(n)}function Mn(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},s=Math.cos(t.angle),i=Math.sin(t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return{x:o.x+t.origin.x,y:o.y+t.origin.y}}function Vh(e,t,n,s){const i=(e.x-t.x)*(n.y-s.y)-(e.y-t.y)*(n.x-s.x);if(Math.abs(i)<xe)return null;const o=((e.x-n.x)*(n.y-s.y)-(e.y-n.y)*(n.x-s.x))/i,a=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/i;return o>xe&&o<1-xe&&a>xe&&a<1-xe?{x:e.x+o*(t.x-e.x),y:e.y+o*(t.y-e.y)}:null}function Xh(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length];if(Hl(n,i,o)<xe)return!1}if(!Os(n,t))return!1}return!0}function Yh(e,t,n){const s=[];for(let i=0;i<t.length;i++)s.push({p1:t[i],p2:t[(i+1)%t.length]});for(const i of e){const o=n(i.id1),a=n(i.id2);if(!(!o||!a)){for(const r of s)if(Vh(o,a,r.p1,r.p2))return!0}}return!1}function vl(e,t,n){const s=[];for(const i of e)for(const o of t){if(i.originalId===o.originalId&&i.transformIndex===o.transformIndex)continue;const a=re(i,o);a<n&&s.push({dist:a,sourceVertex:i,targetVertex:o,correctionVector:{x:o.x-i.x,y:o.y-i.y},type:"vertex-vertex"})}return s}function yi(e,t,n){const s=[];for(const i of e)for(const o of t){if(!o||!o.originalEdge||!o.p1||!o.p2)continue;const a=i.transformIndex===o.transformIndex,r=i.originalId===o.originalEdge.id1||i.originalId===o.originalEdge.id2;if(a&&r)continue;const c=Lt(i,o.p1,o.p2);c.distance<n&&c.onSegmentStrict&&s.push({dist:c.distance,sourceVertex:i,targetEdge:o,snapPoint:{x:c.x,y:c.y},correctionVector:{x:c.x-i.x,y:c.y-i.y},type:"vertex-to-edge"})}return s}function ql(e,t,n,s,i,o,a,r){const c=Je*2/o.scale,l=Je/o.scale,d=String(Nn).trim(),h=e.filter(B=>(B&&B.type?String(B.type).trim():"undefined")===d);if(h.length===0||i<=0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const f=new Set(e.map(B=>B.id)),u=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const G=B,W=B;h.forEach(z=>{u.push({...r(z,G,a),originalId:z.id,transformIndex:W,type:"regular"})})}const p=t.filter(B=>B.type==="regular"&&!f.has(B.id)).map(B=>({...B,originalId:B.id,transformIndex:void 0})),g=n.filter(B=>f.has(B.id1)&&f.has(B.id2)),y=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const G=B,W=u.filter(z=>z.transformIndex===G);W.length>0&&g.forEach(z=>{const K=W.find(q=>q.originalId===z.id1),H=W.find(q=>q.originalId===z.id2);K&&H&&y.push({p1:K,p2:H,originalEdge:z,transformIndex:G,originalEdgeId:le(z)})})}const m=n.filter(B=>!f.has(B.id1)||!f.has(B.id2)).map(B=>({p1:s(B.id1),p2:s(B.id2),originalEdge:B,transformIndex:void 0,originalEdgeId:le(B)})).filter(B=>B.p1&&B.p2),x=[...p,...u],S=[...m,...y],M=vl(u,x,c),b=yi(u,S,l),C=yi(p,y,l).map(B=>({dist:B.dist,sourceEdge:B.targetEdge,targetVertex:B.sourceVertex,correctionVector:{x:B.sourceVertex.x-B.snapPoint.x,y:B.sourceVertex.y-B.snapPoint.y},type:"edge-to-vertex"})),v=[...M,...b,...C];if(v.length===0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const T={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};v.sort((B,G)=>{const W=T[B.type]??99,z=T[G.type]??99;return W!==z?W-z:B.dist-G.dist});const w=v[0];let I={...w.correctionVector};const P=w.sourceVertex?w.sourceVertex.transformIndex:w.sourceEdge.transformIndex,L=w.targetVertex?w.targetVertex.transformIndex:w.targetEdge?w.targetEdge.transformIndex:void 0;let A;L===void 0?A=P:A=P-L;let _={x:0,y:0};Math.abs(A)>1e-9?(_.x=I.x/A,_.y=I.y/A):_={x:0,y:0};const D={...a,delta:{x:a.delta.x+_.x,y:a.delta.y+_.y}},O=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const G=B,W=B;h.forEach(z=>{O.push({...r(z,G,D),id:`final_${z.id}_${B}`,originalId:z.id,transformIndex:W,type:"regular"})})}const X=p.map(B=>({...B})),F=[...X,...O],V=vl(O,F,xe),$=m.map(B=>({...B})),R=[];for(let B=0;B<i&&(B+=i==1,!(B>=i));B++){const G=B,W=O.filter(z=>z.transformIndex===G);W.length>0&&g.forEach(z=>{const K=W.find(q=>q.originalId===z.id1),H=W.find(q=>q.originalId===z.id2);K&&H&&R.push({p1:K,p2:H,originalEdge:z,transformIndex:G,originalEdgeId:le(z)})})}const N=[...$,...R],k=yi(O,N,xe),Y=yi(X,R,xe);return{snapped:!0,finalTransform:D,bestSnap:w,mergePairs:V.map(B=>({source:{originalId:B.sourceVertex.originalId,transformIndex:B.sourceVertex.transformIndex},target:{originalId:B.targetVertex.originalId,transformIndex:B.targetVertex.transformIndex}})),edgeSnaps:[...k,...Y].map(B=>({sourceVertex:{originalId:B.sourceVertex.originalId,transformIndex:B.sourceVertex.transformIndex},targetEdge:{originalEdgeId:B.targetEdge.originalEdgeId,transformIndex:B.targetEdge.transformIndex}}))}}function Gh(e,t,n,s,i,o,a){const r={delta:i},l=ql(e,t,n,s,o,a,r,(d,h,f=r)=>({x:d.x+f.delta.x*h,y:d.y+f.delta.y*h}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const _a=e=>Math.max(0,Math.min(1,e)),ht=(e,t)=>{const n=jn(e);return n||t},Wa=e=>`rgba(${Math.round(e.r)},${Math.round(e.g)},${Math.round(e.b)},${e.a??1})`,io=(e,t)=>{let n=0,s=0,i=0,o=0,a=0;return e.forEach((r,c)=>{const l=t[c]||0;a+=l,n+=r.r*l,s+=r.g*l,i+=r.b*l,o+=r.a*l}),a<=0?{r:0,g:0,b:0,a:1}:{r:n/a,g:s/a,b:i/a,a:o/a}};function Fi(e,t,n,s,i,o,a){if(!t)return[n,s];const r=e.directionFrom||e.id1,c=e.directionTo||e.id2,l=o(r)||n,d=o(c)||s,h={x:d.x-l.x,y:d.y-l.y},f=Math.hypot(h.x,h.y)||1;h.x/=f,h.y/=f;const u=e.interpolationStyleId||null,p=(w,I)=>{const P=[];return i.forEach(L=>{L.id1===e.id1&&L.id2===e.id2||L.id1===e.id2&&L.id2===e.id1||(L.id1===w&&L.id2!==I&&P.push(L),L.id2===w&&L.id1!==I&&P.push(L))}),P},g=(w,I,P)=>{const L=p(w,I).filter(F=>(F.interpolationStyleId||null)===u);if(L.length!==1)return null;const A=L[0],D=[A.id1===w?A.id2:A.id1];let O=null,X=P?-1/0:1/0;return D.forEach(F=>{const V=o(F);if(!V||V.type!==Nn)return;const $=o(w);if(!$)return;const R={x:V.x-$.x,y:V.y-$.y},N=Math.hypot(R.x,R.y);if(N<=xe)return;const k=R.x/N*h.x+R.y/N*h.y;P?k>X&&(X=k,O=V):k<X&&(X=k,O=V)}),O},y=g(r,c,!1),m=g(c,r,!0),x=[l,d];y&&x.unshift(y),m&&x.push(m);const S=gs(x,t,!1,a);if(!S||S.length<2)return[n,s];let M=0,b=S.length-1,E=1/0,C=1/0;if(S.forEach((w,I)=>{const P=re(w,n);P<E&&(E=P,M=I);const L=re(w,s);L<C&&(C=L,b=I)}),M===b)return[n,s];const v=Math.min(M,b),T=Math.max(M,b);return S.slice(v,T+1)}function Wh(e){const t=ih/e;let n=Math.pow(10,Math.floor(Math.log10(t))),s=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-s)<xe||n===0)&&(s=n===0?.001:n*10,n===0&&(n=1e-4));const i=n,o=s;let a=0;o>i&&i>0&&(a=(Math.log10(t)-Math.log10(i))/(Math.log10(o)-Math.log10(i)));let r=(a-al)/(ah-al);r=Math.max(0,Math.min(1,r)),r=r*r*(3-2*r);let c=1-r,l=r;c<gi?c=0:c>1-gi&&(c=1),l<gi?l=0:l>1-gi&&(l=1);const d=c+l;return d>0&&d!==2&&(c/=d,l/=d),{grid1Interval:i,grid2Interval:o,alpha1:c,alpha2:l}}function zh(e,t,n,s){const i=s({x:0,y:0}),o={x:t/2,y:n/2},a=re(i,o);let r;a<1e-6?r=ll:r=ll/a*(180/Math.PI),(isNaN(r)||r<=xe)&&(r=xe);const c=[];let l=[...Ta],d=l[l.length-1];const h=1e-15;for(;d>h;)d/=10,l.includes(d)||l.push(d);l.sort((y,m)=>m-y);let f=null,u=null;for(let y=l.length-1;y>=0;y--){const m=l[y];if(r<m){f={angle:m,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!f&&l.length>0?(f={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!f&&l.length===0&&(f={angle:Ta[0],alpha:1}),c.push(f),u){const y=Math.log10(f.angle),m=Math.log10(u.angle),x=Math.log10(r);let S;m===y?S=0:S=(x-y)/(m-y),S=Math.max(0,Math.min(1,S));const M=S*S*(3-2*S);M>lh&&(u.alpha=M,c.push(u))}const p=[],g=new Set;c.sort((y,m)=>m.angle-y.angle);for(const y of c)g.has(y.angle)||(p.push(y),g.add(y.angle));return p.length===0&&p.push({angle:Ta[0],alpha:1}),p}function jl(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:s,colors:i,isDragConfirmed:o,dragPreviewVertices:a,currentAltPressed:r},c,l,d){if(!n&&s.length===0)return;const h=new Map;o&&a&&a.forEach(u=>{if(u&&u.id){const p=u.originalId||u.id;h.set(p,u)}});const f=u=>o&&h.has(u)?h.get(u):l(u);t.forEach(u=>{const p=d(u),g=s.includes(p),y=!r&&p===n;if(o&&u.vertexIds.some(m=>h.has(m)),(g||y)&&u.color!=="transparent"){e.save(),e.fillStyle=i.selectionGlow,e.globalAlpha=Vd,e.beginPath();const m=u.vertexIds.map(S=>f(S)).filter(S=>S&&S.type==="regular");if(m.length<3){e.restore();return}m.map(S=>c(S)).forEach((S,M)=>{M===0?e.moveTo(S.x,S.y):e.lineTo(S.x,S.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(S=>{const M=t.find(b=>b.id===S);if(M){const b=M.vertexIds.map(E=>f(E)).filter(E=>E&&E.type==="regular");if(b.length>=3){const E=b.map(C=>c(C));e.moveTo(E[0].x,E[0].y),E.slice(1).forEach(C=>e.lineTo(C.x,C.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function br(e,t,{colors:n,verticesVisible:s=!0,isSnapped:i=!1},o){if(t.type===Nn&&!s&&!i)return;const a=o(t);switch(t.type){case Nn:e.beginPath(),e.arc(a.x,a.y,Je,0,Ne),e.fillStyle=i?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case mn:case ts:case vn:case Ms:const r=sa*2,c={type:t.type,x:a.x-r/2,y:a.y-r/2,width:r,height:r};ha(e,c,n);break}}function Ul(e,t,n,s){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=s)return{ranges:[[0,360]],isFullCircle:!0};const i={left:0,right:n,top:0,bottom:s};if(e.x+t<i.left||e.x-t>i.right||e.y+t<i.top||e.y-t>i.bottom)return null;const o=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(o.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const r=[];if(o.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const g=u.x-e.x,y=u.y-e.y,m=Math.atan2(-y,g),x=m<0?m+2*Math.PI:m;r.push(x*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{Ir({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(g=>{const y=g.x-e.x,m=g.y-e.y,x=Math.atan2(-m,y),S=x<0?x+2*Math.PI:x;r.push(S*180/Math.PI)})}),r.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(r.map(u=>Math.round(u*1e6)/1e6))].sort((u,p)=>u-p);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let d=0,h=0,f=0;for(let u=0;u<l.length;u++){const p=l[u],g=l[(u+1)%l.length];let y;u===l.length-1?y=360-p+g:y=g-p,y>d&&(d=y,h=p,f=g)}return f>h?{ranges:[[f,h+360]],isFullCircle:!1}:{ranges:[[f,h]],isFullCircle:!1}}function Hh(e,{canvas:t,dpr:n,colors:s}){const i=t.width/n,o=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=s.background,e.fillRect(0,0,i,o)}function ds(e,t){return e?.colorMode||t}function Ko(e,t){return e?.colorMode||t}function Kh(e,{allFaces:t,allEdges:n,facesVisible:s,isDragConfirmed:i,dragPreviewVertices:o,transformIndicatorData:a,initialDragVertexStates:r,colors:c,initialCoordSystemStates:l,interpolationStyle:d,getInterpolationStyleById:h,faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x",edgeWeightExpression:m="r",faceVertexWeightExpression:x="1/(r+0.001)",faceEdgeWeightExpression:S="1/(r+0.001)",angleDisplayMode:M="degrees"},b,E){if(!s||!t||!c||!e)return;const C=w=>E(w);t.filter(w=>!w.parentFaceId).forEach(w=>{if(!w||!w.vertexIds||w.vertexIds.length<3)return;const I=w.vertexIds.map(D=>C(D)).filter(D=>D&&D.type==="regular");if(I.length<3)return;const P=w.interpolationStyleId&&h?h(w.interpolationStyleId):null,A=(P?gs(I,P,!0,b):I).map(D=>b(D));let _=w;w.localCoordSystem,A.every(D=>D&&typeof D.x=="number"&&typeof D.y=="number")&&Vi(e,A,_,c,b,E,n,t,C,!0,d,{faceColorMode:Ko(w,f),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:x,faceEdgeWeightExpression:S,angleDisplayMode:M})}),t.filter(w=>w.parentFaceId&&w.color!=="transparent").forEach(w=>{if(!w||!w.vertexIds||w.vertexIds.length<3)return;const I=w.vertexIds.map(D=>C(D)).filter(D=>D&&D.type==="regular");if(I.length<3)return;const P=w.interpolationStyleId&&h?h(w.interpolationStyleId):null,A=(P?gs(I,P,!0,b):I).map(D=>b(D));let _=w;w.localCoordSystem,A.every(D=>D&&typeof D.x=="number"&&typeof D.y=="number")&&Vi(e,A,_,c,b,E,n,t,C,!1,d,{faceColorMode:Ko(w,f),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:x,faceEdgeWeightExpression:S,angleDisplayMode:M})})}function vr(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:s,findVertexById:i,transformIndicatorData:o}){if(!t)return e.localCoordSystem;const a=new Set(e.vertexIds),r=new Set(s.map(p=>p.id));if([...a].every(p=>r.has(p))){const p=JSON.parse(JSON.stringify(t));if(o){const{center:g,rotation:y,scale:m,directionalScale:x,startPos:S}=o,M={x:S.x-g.x,y:S.y-g.y};if(p.origin=je(t.origin,g,y,m,x,M),x){const b=Mn({x:1,y:0},t),E=je(b,g,y,m,x,M);p.scale=re(p.origin,E)}else p.angle=Rn(t.angle+y),p.scale=t.scale*m}else if(s.length>0&&n.length>0){const g=s.find(m=>a.has(m.id)),y=g?n.find(m=>m.id===g.id):null;if(y){const m=y.x-g.x,x=y.y-g.y;p.origin.x+=m,p.origin.y+=x}}return p}const l=e.vertexIds.map(p=>n.find(g=>g&&g.id===p)||i(p)).filter(p=>p&&p.type==="regular");if(!t.isCustom){const p=ca(l);if(p){const g=o?o.rotation:0;return{...t,origin:p.center,scale:p.radius,angle:Rn(t.angle+g)}}return t}const d=JSON.parse(JSON.stringify(t));if(o){const{center:p,rotation:g,scale:y,directionalScale:m,startPos:x}=o,S={x:x.x-p.x,y:x.y-p.y};if(d.origin=je(t.origin,p,g,y,m,S),m){const M=Mn({x:1,y:0},t),b=je(M,p,g,y,m,S);d.scale=re(d.origin,b)}else d.angle=Rn(t.angle+g),d.scale=t.scale*y}let h={...d.origin},f=d.angle,u=d.scale;if(d.attachedToVertex){if(r.has(d.attachedToVertex)){const p=n.find(g=>g.id===d.attachedToVertex);p&&(h={...p})}}else if(d.attachedToEdge&&(r.has(d.attachedToEdge.v1)||r.has(d.attachedToEdge.v2))){const p=n.find(y=>y.id===d.attachedToEdge.v1)||i(d.attachedToEdge.v1),g=n.find(y=>y.id===d.attachedToEdge.v2)||i(d.attachedToEdge.v2);p&&g&&(h={x:p.x+d.attachedToEdge.t*(g.x-p.x),y:p.y+d.attachedToEdge.t*(g.y-p.y)})}if(d.rotationAlignedToEdge&&(r.has(d.rotationAlignedToEdge.v1)||r.has(d.rotationAlignedToEdge.v2))){const p=n.find(y=>y.id===d.rotationAlignedToEdge.v1)||i(d.rotationAlignedToEdge.v1),g=n.find(y=>y.id===d.rotationAlignedToEdge.v2)||i(d.rotationAlignedToEdge.v2);if(p&&g){const y=Math.atan2(g.y-p.y,g.x-p.x),{originalAngle:m,originalSystemAngle:x}=d.rotationAlignedToEdge,S=x-m;f=Rn(y+S)}}if(d.scaleAttachedToEdge&&(r.has(d.scaleAttachedToEdge.v1)||r.has(d.scaleAttachedToEdge.v2))){const p=n.find(y=>y.id===d.scaleAttachedToEdge.v1)||i(d.scaleAttachedToEdge.v1),g=n.find(y=>y.id===d.scaleAttachedToEdge.v2)||i(d.scaleAttachedToEdge.v2);p&&g&&(u=re(p,g)*d.scaleAttachedToEdge.scaleRatio)}return l.length>=3?d.origin=go(h,l):d.origin=h,d.angle=f,d.scale=Math.max(.01,u),d}function qh(e,t,n){const{copyCount:s,isDragConfirmed:i,initialDragVertexStates:o,dragPreviewVertices:a,transformIndicatorData:r,allEdges:c,allFaces:l,findVertexById:d,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",edgeWeightExpression:m="r",faceColorExpression:x="x",faceColorPolarExpression:S="r",faceVertexWeightExpression:M="1/(r+0.001)",faceEdgeWeightExpression:b="1/(r+0.001)",angleDisplayMode:E="degrees",initialCoordSystemStates:C=new Map,getInterpolationStyleById:v}=t,T=o.length===1&&!r&&o[0].type==="regular";if(!i||!o.length||s<=0||T)return;const w=o.filter(_=>_.type==="regular");if(w.length===0)return;const I=new Set(w.map(_=>_.id)),P=c.filter(_=>I.has(_.id1)&&I.has(_.id2)),L=c.filter(_=>I.has(_.id1)&&!I.has(_.id2)||I.has(_.id2)&&!I.has(_.id1)),A=l.filter(_=>_.vertexIds.every(D=>I.has(D)));e.save(),e.globalAlpha=1;for(let _=0;_<s;_++){_+=s==1;const D=_,O=_;let X;const F=new Map;if(r){const{center:k,rotation:Y,scale:B,directionalScale:G,startPos:W}=r,z={x:W.x-k.x,y:W.y-k.y};X=w.map(K=>{const H=je(K,k,Y*O,Math.pow(B,O),G,z);return{...K,...H,id:`preview_${K.id}_${D}`,originalId:K.id,transformIndex:D}})}else{const k=a.length>0?a[0].x-o[0].x:0,Y=a.length>0?a[0].y-o[0].y:0;X=w.map(B=>({...B,x:B.x+k*O,y:B.y+Y*O,id:`preview_${B.id}_${D}`,originalId:B.id,transformIndex:D}))}if(!X||X.length===0)continue;X.forEach(k=>F.set(k.originalId,k)),A.forEach(k=>{const Y=k.vertexIds.map(B=>F.get(B)).filter(Boolean);if(Y.length===k.vertexIds.length){const B=k.interpolationStyleId&&v?v(k.interpolationStyleId):null,W=(B?gs(Y,B,!0,n):Y).map(K=>n(K));let z=k;if(k.localCoordSystem){const K=C.get(k.id)||k.localCoordSystem,H=vr(k,{initialSystem:K,dragPreviewVertices:a,initialDragVertexStates:o,findVertexById:d,transformIndicatorData:r});z={...k,localCoordSystem:H}}Vi(e,W,z,h,n,d,c,[],K=>F.get(K),!1,null,{faceColorMode:Ko(k,g),edgeColorMode:p,faceColorExpression:x,faceColorPolarExpression:S,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:M,faceEdgeWeightExpression:b,angleDisplayMode:E})}}),e.setLineDash([]),e.lineWidth=ws;const V=ht(h.edge,{r:255,g:255,b:255,a:1}),$=k=>ht(k?.color||h.vertex||h.edge,V),R=(k,Y,B,G)=>{const W=ds(k,p);if(W==="inherit_vertices"&&B&&G){const z=$(B),K=$(G),H=k.weightExpression||m,q=re(B,G)||1,se=Y*q,fe=(1-Y)*q,ae=se/q,ne=fe/q,Z=ut(H,{x:0,y:0,r:ae,a:0},1),Q=ut(H,{x:0,y:0,r:ne,a:0},1);return io([z,K],[Z,Q])}if(W==="colormap"&&k.colormapItem){const z=k.colorExpression||y,K=ut(z,{x:Y},Y),H=Ge(k.colormapItem,K);return ht(H,V)}return ht(k.color||h.edge,V)},N=k=>F.get(k)||d(k);P.forEach(k=>{const Y=F.get(k.id1),B=F.get(k.id2);if(Y&&B){const G=k.interpolationStyleId&&v?v(k.interpolationStyleId):null,z=Fi(k,G,Y,B,c,N,n).map(ae=>n(ae));if(z.length<2)return;const K=z[0],H=z[z.length-1],q=ds(k,p);if(q==="inherit_vertices"||q==="colormap"){$(Y),$(B);let ae=0;for(let Z=1;Z<z.length;Z++)ae+=Math.hypot(z[Z].x-z[Z-1].x,z[Z].y-z[Z-1].y);let ne=0;for(let Z=1;Z<z.length;Z++){const Q=z[Z-1],ee=z[Z],ce=Math.hypot(ee.x-Q.x,ee.y-Q.y),de=ae>0?ne/ae:0,ve=ae>0?(ne+ce)/ae:1,Se=(de+ve)/2,Me=R(k,Se,Y,B);e.strokeStyle=Wa(Me),e.beginPath(),e.moveTo(Q.x,Q.y),e.lineTo(ee.x,ee.y),e.stroke(),ne+=ce}}else if(k.colormapItem){let ae=0;for(let Z=1;Z<z.length;Z++)ae+=Math.hypot(z[Z].x-z[Z-1].x,z[Z].y-z[Z-1].y);let ne=0;for(let Z=1;Z<z.length;Z++){const Q=z[Z-1],ee=z[Z],ce=Math.hypot(ee.x-Q.x,ee.y-Q.y),de=ae>0?ne/ae:0,ve=ae>0?(ne+ce)/ae:1,Se=(de+ve)/2,Me=k.gradientStart+(k.gradientEnd-k.gradientStart)*Se,Ze=Ge(k.colormapItem,Me);e.strokeStyle=Ze,e.beginPath(),e.moveTo(Q.x,Q.y),e.lineTo(ee.x,ee.y),e.stroke(),ne+=ce}}else{e.strokeStyle=k.color||h.edge,e.beginPath(),e.moveTo(z[0].x,z[0].y);for(let ae=1;ae<z.length;ae++)e.lineTo(z[ae].x,z[ae].y);e.stroke()}const se=le(k);if((f?.get(se)||[]).some(ae=>ae.copyIndex===D)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Ls,e.lineWidth=us,e.lineCap="round",e.lineJoin="round";const ae=H.x-K.x,ne=H.y-K.y,Z=Math.hypot(ae,ne),Q=_i;if(Z>xe){const ee=-ne/Z,ce=ae/Z,de=ee*Q,ve=ce*Q;e.beginPath(),e.arc(K.x,K.y,Q,Math.atan2(ve,de),Math.atan2(-ve,-de)),e.lineTo(H.x-de,H.y-ve),e.arc(H.x,H.y,Q,Math.atan2(-ve,-de),Math.atan2(ve,de)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(K.x,K.y,Q,0,Ne),e.stroke();e.restore()}}}),L.forEach(k=>{const Y=I.has(k.id1)?k.id2:k.id1,B=I.has(k.id1)?k.id1:k.id2,G=F.get(B),W=d(Y);if(G&&W){const z=k.interpolationStyleId&&v?v(k.interpolationStyleId):null,H=Fi(k,z,G,W,c,N,n).map(Z=>n(Z));if(H.length<2)return;const q=H[0],se=H[H.length-1],fe=ds(k,p);if(fe==="inherit_vertices"||fe==="colormap"){$(G),$(W);let Z=0;for(let ee=1;ee<H.length;ee++)Z+=Math.hypot(H[ee].x-H[ee-1].x,H[ee].y-H[ee-1].y);let Q=0;for(let ee=1;ee<H.length;ee++){const ce=H[ee-1],de=H[ee],ve=Math.hypot(de.x-ce.x,de.y-ce.y),Se=Z>0?Q/Z:0,Me=Z>0?(Q+ve)/Z:1,Ze=(Se+Me)/2,lt=R(k,Ze,G,W);e.strokeStyle=Wa(lt),e.beginPath(),e.moveTo(ce.x,ce.y),e.lineTo(de.x,de.y),e.stroke(),Q+=ve}}else if(k.colormapItem){let Z=0;for(let ee=1;ee<H.length;ee++)Z+=Math.hypot(H[ee].x-H[ee-1].x,H[ee].y-H[ee-1].y);let Q=0;for(let ee=1;ee<H.length;ee++){const ce=H[ee-1],de=H[ee],ve=Math.hypot(de.x-ce.x,de.y-ce.y),Se=Z>0?Q/Z:0,Me=Z>0?(Q+ve)/Z:1,Ze=(Se+Me)/2,lt=k.gradientStart+(k.gradientEnd-k.gradientStart)*Ze,Pn=Ge(k.colormapItem,lt);e.strokeStyle=Pn,e.beginPath(),e.moveTo(ce.x,ce.y),e.lineTo(de.x,de.y),e.stroke(),Q+=ve}}else{e.strokeStyle=k.color||h.edge,e.beginPath(),e.moveTo(H[0].x,H[0].y);for(let Z=1;Z<H.length;Z++)e.lineTo(H[Z].x,H[Z].y);e.stroke()}const ae=le(k);if((f?.get(ae)||[]).some(Z=>Z.copyIndex===D)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Ls,e.lineWidth=us,e.lineCap="round",e.lineJoin="round";const Z=se.x-q.x,Q=se.y-q.y,ee=Math.hypot(Z,Q),ce=_i;if(ee>xe){const de=-Q/ee,ve=Z/ee,Se=de*ce,Me=ve*ce;e.beginPath(),e.arc(q.x,q.y,ce,Math.atan2(Me,Se),Math.atan2(-Me,-Se)),e.lineTo(se.x-Se,se.y-Me),e.arc(se.x,se.y,ce,Math.atan2(-Me,-Se),Math.atan2(Me,Se)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(q.x,q.y,ce,0,Ne),e.stroke();e.restore()}}}),X.forEach(k=>{const Y=k.originalId,B=u.get(Y)||[],G=B.some(K=>K.copyIndex===D),W=B.find(K=>K.copyIndex===D),z=W?W.type:null;br(e,k,{colors:h,verticesVisible:!0,isSnapped:!1},n),G&&Mr(e,k,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:z,currentAltPressed:!1},n)})}e.restore()}function Mr(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,isSnapped:h=!1,snapType:f=null,currentAltPressed:u}=n;if(u&&d)return;let p;if(t.type===Nn){if(p=o.includes(t.id),!l&&!p&&!d&&!h)return}else p=a.includes(t.id);if(p||d||h){const y=s(t);e.save();let m=c.selectionGlow;t.id===r&&t.type!=="regular"?m=c.activeCenterGlow:h?m=c.feedbackSnapped:d&&(m=c.selectionGlow),e.shadowColor=m,e.shadowBlur=hr,e.globalAlpha=Ls,e.strokeStyle=m,e.lineWidth=us,e.beginPath();let x;t.type===Nn?x=Je+Oi:x=sa+Oi,e.arc(y.x,y.y,x,0,Ne),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function jh(e,t,n){const{copyCount:s=1,initialDragVertexStates:i,dragPreviewVertices:o,allEdges:a,allFaces:r,findVertexById:c,findNeighbors:l,findAllVerticesInSubgraph:d,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",edgeWeightExpression:m="r",faceColorExpression:x="x",faceColorPolarExpression:S="r",faceVertexWeightExpression:M="1/(r+0.001)",faceEdgeWeightExpression:b="1/(r+0.001)",angleDisplayMode:E="degrees",initialCoordSystemStates:C=new Map,getInterpolationStyleById:v}=t;if(!i||i.length!==1||!o||o.length===0)return;const T=i[0];for(let w=0;w<s;w++){w+=s==1;const I=w,P=w;let L;const A=o.length>0?o[0].x-i[0].x:0,_=o.length>0?o[0].y-i[0].y:0;L={x:T.x+A*P,y:T.y+_*P};const D={...T,...L,originalId:T.id,transformIndex:I},O=new Set(d(T.id)),X=a.filter(k=>O.has(k.id1)&&O.has(k.id2)),F=r.filter(k=>k.vertexIds.every(Y=>O.has(Y))),V=k=>k===T.id?D:O.has(k)?c(k):null;F.forEach(k=>{const Y=k.vertexIds.map(V).filter(Boolean);if(Y.length>=3){const B=k.interpolationStyleId&&v?v(k.interpolationStyleId):null,W=(B?gs(Y,B,!0,n):Y).map(K=>n(K));let z=k;if(k.localCoordSystem){const K=C.get(k.id)||k.localCoordSystem,H=vr(k,{initialSystem:K,dragPreviewVertices:o,initialDragVertexStates:i,findVertexById:c,transformIndicatorData:null});z={...k,localCoordSystem:H}}Vi(e,W,z,h,n,c,a,r,V,!0,null,{faceColorMode:Ko(k,g),edgeColorMode:p,faceColorExpression:x,faceColorPolarExpression:S,edgeColorExpression:y,edgeWeightExpression:m,faceVertexWeightExpression:M,faceEdgeWeightExpression:b,angleDisplayMode:E})}}),e.save(),e.lineWidth=ws,e.setLineDash([]);const $=ht(h.edge,{r:255,g:255,b:255,a:1}),R=k=>ht(k?.color||h.vertex||h.edge,$),N=(k,Y,B,G)=>{const W=ds(k,p);if(W==="inherit_vertices"&&B&&G){const z=R(B),K=R(G),H=k.weightExpression||m,q=re(B,G)||1,se=Y*q,fe=(1-Y)*q,ae=se/q,ne=fe/q,Z=ut(H,{x:0,y:0,r:ae,a:0},1),Q=ut(H,{x:0,y:0,r:ne,a:0},1);return io([z,K],[Z,Q])}if(W==="colormap"&&k.colormapItem){const z=k.colorExpression||y,K=ut(z,{x:Y},Y),H=Ge(k.colormapItem,K);return ht(H,$)}return ht(k.color||h.edge,$)};X.forEach(k=>{const Y=V(k.id1),B=V(k.id2);if(Y&&B){const G=k.interpolationStyleId&&v?v(k.interpolationStyleId):null,K=Fi(k,G,Y,B,a,ne=>V(ne),n).map(ne=>n(ne));if(K.length<2)return;const H=K[0],q=K[K.length-1],se=ds(k,p);if(se==="inherit_vertices"||se==="colormap"){let ne=0;for(let Q=1;Q<K.length;Q++)ne+=Math.hypot(K[Q].x-K[Q-1].x,K[Q].y-K[Q-1].y);let Z=0;for(let Q=1;Q<K.length;Q++){const ee=K[Q-1],ce=K[Q],de=Math.hypot(ce.x-ee.x,ce.y-ee.y),ve=ne>0?Z/ne:0,Se=ne>0?(Z+de)/ne:1,Me=(ve+Se)/2,Ze=N(k,Me,Y,B);e.strokeStyle=Wa(Ze),e.beginPath(),e.moveTo(ee.x,ee.y),e.lineTo(ce.x,ce.y),e.stroke(),Z+=de}}else if(k.colormapItem){let ne=0;for(let Q=1;Q<K.length;Q++)ne+=Math.hypot(K[Q].x-K[Q-1].x,K[Q].y-K[Q-1].y);let Z=0;for(let Q=1;Q<K.length;Q++){const ee=K[Q-1],ce=K[Q],de=Math.hypot(ce.x-ee.x,ce.y-ee.y),ve=ne>0?Z/ne:0,Se=ne>0?(Z+de)/ne:1,Me=(ve+Se)/2,Ze=k.gradientStart+(k.gradientEnd-k.gradientStart)*Me,lt=Ge(k.colormapItem,Ze);e.strokeStyle=lt,e.beginPath(),e.moveTo(ee.x,ee.y),e.lineTo(ce.x,ce.y),e.stroke(),Z+=de}}else{e.strokeStyle=k.color||h.edge,e.beginPath(),e.moveTo(K[0].x,K[0].y);for(let ne=1;ne<K.length;ne++)e.lineTo(K[ne].x,K[ne].y);e.stroke()}const fe=le(k);if((f?.get(fe)||[]).some(ne=>ne.copyIndex===I)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Ls,e.lineWidth=us,e.lineCap="round",e.lineJoin="round";const ne=q.x-H.x,Z=q.y-H.y,Q=Math.hypot(ne,Z),ee=_i;if(Q>xe){const ce=-Z/Q,de=ne/Q,ve=ce*ee,Se=de*ee;e.beginPath(),e.arc(H.x,H.y,ee,Math.atan2(Se,ve),Math.atan2(-Se,-ve)),e.lineTo(q.x-ve,q.y-Se),e.arc(q.x,q.y,ee,Math.atan2(-Se,-ve),Math.atan2(Se,ve)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(H.x,H.y,ee,0,Ne),e.stroke();e.restore()}}}),e.restore(),O.forEach(k=>{const Y=V(k);if(!Y)return;const B=k===T.id,G=u.get(T.id)||[],W=B&&G.some(q=>q.copyIndex===I),z=B?G.find(q=>q.copyIndex===I):null,K=z?z.type:null,H={...Y,id:`preview_${Y.originalId||Y.id}_${I}`,originalId:Y.originalId||Y.id,transformIndex:I};br(e,H,{colors:h,verticesVisible:!0,isSnapped:!1},n),W&&Mr(e,H,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:K,currentAltPressed:!1},n)})}}function Jl(e,{startVertex:t,snappedData:n,isShiftPressed:s,currentColor:i,nextCreationColor:o,nextEdgeColor:a,colors:r,edgeColormapInfo:c,interpolationStyle:l},d){const h=d(t),f=d(n);e.save();let u=[{x:t.x,y:t.y},{x:n.x,y:n.y}];if(l&&l.type&&l.type!=="linear"?(u=gs(u,l,!1,null),e.setLineDash([])):e.setLineDash(Wn),c&&c.colormapItem){const m=e.createLinearGradient(h.x,h.y,f.x,f.y),x=Ge(c.colormapItem,c.startT),S=Ge(c.colormapItem,c.endT);m.addColorStop(0,x),m.addColorStop(1,S),e.strokeStyle=m}else n.snapped||s?e.strokeStyle=r.feedbackSnapped:e.strokeStyle=a;e.lineWidth=ws;const g=u.map(m=>d(m));e.beginPath(),e.moveTo(g[0].x,g[0].y);for(let m=1;m<g.length;m++)e.lineTo(g[m].x,g[m].y);if(e.stroke(),e.restore(),l?.linearStyle==="arrows"&&g.length>=2){const m=(M,b)=>{const E=Math.atan2(b.y-M.y,b.x-M.x),C=Xe*.6,v={x:b.x-Math.cos(E)*C+Math.cos(E+Math.PI/2)*C*.6,y:b.y-Math.sin(E)*C+Math.sin(E+Math.PI/2)*C*.6},T={x:b.x-Math.cos(E)*C+Math.cos(E-Math.PI/2)*C*.6,y:b.y-Math.sin(E)*C+Math.sin(E-Math.PI/2)*C*.6};e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(v.x,v.y),e.lineTo(T.x,T.y),e.closePath(),e.fill()};e.save();const x=g[g.length-2],S=g[g.length-1];e.fillStyle=e.strokeStyle||a,m(x,S),e.restore()}if(e.save(),e.beginPath(),e.arc(f.x,f.y,Je,0,Ne),n.snapped?e.fillStyle=r.feedbackSnapped:e.fillStyle=o,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=r.feedbackSnapped,e.shadowBlur=hr,e.globalAlpha=Ls,e.strokeStyle=r.feedbackSnapped,e.lineWidth=us;const m=Je+Oi;e.beginPath(),e.arc(f.x,f.y,m,0,Ne),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function Bi(e,t,n){const s=[];if(n>360){const o=n-360,a=Math.floor(t/e)*e;for(let r=a;r<360;r+=e)r>=t&&s.push(r);for(let r=0;r<=o+e;r+=e)r<=o&&s.push(r)}else{const o=Math.floor(t/e)*e;for(let a=o;a<=n+e;a+=e)a>=t&&a<=n&&a>=0&&a<360&&s.push(a)}return[...new Set(s)].sort((o,a)=>o-a)}function Uh(e,t,n){return e.x>=-20&&e.x<=t+Ot&&e.y>=-20&&e.y<=n+Ot}function Jh(e,t,n,s,i,{canvas:o,dpr:a,viewTransform:r,angleDisplayMode:c,colors:l},d,h){if(typeof d!="function"||typeof n!="function")return;const f=d({x:0,y:0}),u=o.width/a,p=o.height/a,g={x:u/2,y:p/2},y=Math.min(u,p)/4,m=re(f,g),x=y+m;if(x<Yl||!Zl(f.x,f.y,x,u,p))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=gn;const S=Math.min(u,p)*400,M=x>S;let b=null;if(M){const P={x:0,y:0,w:u,h:p},L={x:f.x,y:f.y,r:x},A=za(L,P);if(A.length>=2){let _=A[0],D=A[1],O=0;for(let V=0;V<A.length;V++)for(let $=V+1;$<A.length;$++){const R=(A[V].x-A[$].x)**2+(A[V].y-A[$].y)**2;R>O&&(O=R,_=A[V],D=A[$])}e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(D.x,D.y),e.stroke();const X=(Math.atan2(f.y-_.y,_.x-f.x)*180/Math.PI+360)%360,F=(Math.atan2(f.y-D.y,D.x-f.x)*180/Math.PI+360)%360;b={minAngle:Math.min(X,F),maxAngle:Math.max(X,F),isFullCircle:!1},Math.abs(X-F)>180&&(b={minAngle:Math.max(X,F),maxAngle:Math.min(X,F)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(f.x,f.y,x,0,2*Math.PI),e.stroke(),b=Ul(f,x,u,p);if(e.restore(),!b)return;const E=x/(r.scale/a),C=new Set,v=new Map;h.forEach(P=>{const L=P.alpha;if(L<Fl||x*(P.angle*Math.PI/180)<Gl*.5)return;const _=`rgba(${l.feedbackDefault.join(",")}, ${L*Ad})`;let D;if(b.isFullCircle){D=[];for(let O=0;O<360;O+=P.angle)D.push(O)}else D=[],b.ranges&&Array.isArray(b.ranges)?b.ranges.forEach(O=>{const[X,F]=O,V=Bi(P.angle,X,F);D.push(...V)}):b.minAngle!==void 0&&b.maxAngle!==void 0&&(D=Bi(P.angle,b.minAngle,b.maxAngle)),D=[...new Set(D)];D.forEach(O=>{if(O=Math.round(O*1e10)/1e10,c==="degrees"){if(C.has(O))return}else if(c==="radians"){const k=`${O}-${P.angle}`;if(v.has(k))return}const X=O*Math.PI/180,F={x:f.x+(x+Ri)*Math.cos(X),y:f.y-(x+Ri)*Math.sin(X)},V=_d;if(!(F.x>-V&&F.x<u+V&&F.y>-V&&F.y<p+V))return;let R={textAlign:"center",textBaseline:"middle"};if(c==="radians"&&(R={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=_,e.lineWidth=qn,O%90===0&&O<360){const k={x:f.x+x*Math.cos(X),y:f.y-x*Math.sin(X)};let Y;const B=pt*1.5;switch(O){case 0:Y={x:Math.SQRT1_2,y:-Math.SQRT1_2},R={textAlign:"left",textBaseline:"bottom"};break;case 90:Y={x:Math.SQRT1_2,y:-Math.SQRT1_2},R={textAlign:"left",textBaseline:"bottom"};break;case 180:Y={x:-Math.SQRT1_2,y:-Math.SQRT1_2},R={textAlign:"right",textBaseline:"bottom"};break;case 270:Y={x:Math.SQRT1_2,y:Math.SQRT1_2},R={textAlign:"left",textBaseline:"top"};break}const G={x:k.x+Y.x*B,y:k.y+Y.y*B};e.lineWidth=Dd,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(G.x,G.y),e.stroke(),F.x=G.x,F.y=G.y}else{const k={x:f.x+(x-Je)*Math.cos(X),y:f.y-(x-Je)*Math.sin(X)},Y={x:f.x+(x+Je)*Math.cos(X),y:f.y-(x+Je)*Math.sin(X)};Uh(Y,u,p)&&(e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(Y.x,Y.y),e.stroke())}e.restore();let N="";if(c==="degrees"){let k=Math.max(0,(P.angle.toString().split(".")[1]||"").length);P.angle<1&&(k=Math.max(k,Math.ceil(-Math.log10(P.angle))+1));const Y=Math.round(O*Math.pow(10,k))/Math.pow(10,k),B=parseFloat(Y.toFixed(k));N=`${Math.round(B*1e10)/1e10}^{\\circ}`}else if(O===0&&c==="radians")N="0";else if(O!==0)if(P.angle<=5){const Y=O*Math.PI/180,B=Math.max(0,(P.angle.toString().split(".")[1]||"").length),G=Math.max(3,B+2);let W=Y.toFixed(G);W=parseFloat(W).toString(),parseFloat(W)!==0&&(N=W)}else{const Y=O,B=180,G=Sr(Y,B),W=Y/G,z=B/G;z===1?W===1?N="\\pi":W===-1?N="-\\pi":N=`${W}\\pi`:W===1?N=`\\frac{\\pi}{${z}}`:W===-1?N=`-\\frac{\\pi}{${z}}`:W<0?N=`-\\frac{${Math.abs(W)}\\pi}{${z}}`:N=`\\frac{${W}\\pi}{${z}}`}if(N){const k=c==="radians"?`circ-label-${O}-${P.angle}-${E.toExponential(15)}`:`circ-label-${O}-${E.toExponential(15)}`;if(n({id:k,content:N,x:F.x,y:F.y,color:_,fontSize:Xa,options:R}),c==="degrees")C.add(O);else{const Y=`${O}-${P.angle}`;v.set(Y,{levelAngle:P.angle,alpha:L,labelId:k})}}})});const T=l.feedbackDefault;let w=-1/0;const I={x:f.x+x,y:f.y};if(I.x>-20&&I.x<u+Ot&&I.y>-20&&I.y<p+Ot)w=0;else{const P={x:0,y:0,w:u,h:p},L={x:f.x,y:f.y,r:x},A=za(L,P);if(A.length>0){let _=-1/0;A.forEach(O=>{const X=Math.atan2(f.y-O.y,O.x-f.x),F=X>=0?X:X+2*Math.PI,V={x:f.x+x*Math.cos(F),y:f.y-x*Math.sin(F)},$=Ot;V.x>-$&&V.x<u+$&&V.y>-$&&V.y<p+$&&F>_&&(_=F)}),[{x:0,y:0},{x:P.w,y:0},{x:P.w,y:P.h},{x:0,y:P.h}].forEach(O=>{if(re(O,f)<L.r){const X=Math.atan2(f.y-O.y,O.x-f.x),F=X>=0?X:X+2*Math.PI,V={x:f.x+x*Math.cos(F),y:f.y-x*Math.sin(F)},$=Ot;V.x>-$&&V.x<u+$&&V.y>-$&&V.y<p+$&&F>_&&(_=F)}}),_>-1/0&&(w=_)}}if(w>-1/0){const P=w,L={x:f.x+x*Math.cos(P),y:f.y-x*Math.sin(P)},A={x:-Math.sin(P),y:-Math.cos(P)},_={x:Math.cos(P),y:-Math.sin(P)},D={x:L.x-Xe*A.x+Xe/2*_.x,y:L.y-Xe*A.y+Xe/2*_.y},O={x:L.x-Xe*A.x-Xe/2*_.x,y:L.y-Xe*A.y-Xe/2*_.y};e.save(),e.fillStyle=`rgba(${T.join(",")}, 1.0)`,e.beginPath(),e.moveTo(L.x,L.y),e.lineTo(D.x,D.y),e.lineTo(O.x,O.y),e.closePath(),e.fill(),e.restore();let X;if(P===0)X={x:L.x-Ia,y:L.y+ba+Xe};else{const F={x:-Math.cos(P),y:Math.sin(P)};X={x:L.x+F.x*(ba+Xe)+A.x*Ia,y:L.y+F.y*(ba+Xe)+A.y*Ia}}n({id:"theta-label-sticky",content:"\\theta",x:X.x,y:X.y,color:`rgba(${T.join(",")}, 1.0)`,fontSize:is,options:{textAlign:"center",textBaseline:"middle"}})}}function za(e,t){const{x:n,y:s,r:i}=e,{x:o,y:a,w:r,h:c}=t,l=[],d={center:{x:n,y:s},radius:i},h=(f,u,p,g)=>{Ir({p1:{x:f,y:u},p2:{x:p,y:g}},d).forEach(x=>{const S=p-f,M=g-u;let b;Math.abs(S)>Math.abs(M)?b=(x.x-f)/S:b=(x.y-u)/M,b>=0&&b<=1&&l.push({x:x.x,y:x.y})})};return h(o,a,o+r,a),h(o+r,a,o+r,a+c),h(o+r,a+c,o,a+c),h(o,a+c,o,a),l}function Zl(e,t,n,s,i){return!(e+n<0||e-n>s||t+n<0||t-n>i)}function Zh(e,t,n,s,i,o,a){const r=`rgba(${a.axisTickLabel.join(",")}, ${ki})`,c=pt*md;e.save(),e.strokeStyle=r,e.lineWidth=xd,e.setLineDash([]);const l=c,d=l/Math.tan(yd),h=t.x-d,f=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(h,f),e.stroke(),e.restore(),o({id:"tick-label-origin",content:Ld,x:t.x-pt-as,y:t.y+pt+as,color:r,fontSize:Ps,options:{textAlign:"right",textBaseline:"top"}})}function Qh(e,t,{canvas:n,dpr:s,coordsDisplayMode:i,viewTransform:o,angleDisplayMode:a,colors:r},c,l,d,h,f){e.save();const u=n.width/s,p=n.height/s,g=c({x:0,y:0}),y=(S,M,b,E)=>{e.beginPath(),e.moveTo(S,M),e.lineTo(b,E),e.stroke();const C=Math.atan2(E-M,b-S);e.beginPath(),e.moveTo(b,E),e.lineTo(b-Xe*Math.cos(C-hn),E-Xe*Math.sin(C-hn)),e.lineTo(b-Xe*Math.cos(C+hn),E-Xe*Math.sin(C+hn)),e.closePath(),e.fill()},m=(S,M,b,E,C)=>{const v=new Map,T=new Map,w=(X,F,V)=>{if(!X||F<oa)return;const $=l({x:0,y:0}),R=l({x:u,y:p}),N=X*xe;{const k=Math.floor($.x/X),Y=Math.ceil(R.x/X),B=Math.floor(R.y/X),G=Math.ceil($.y/X);for(let W=k;W<=Y;W++){const z=W*X;if(Math.abs(z)<N)continue;const K=v.get(z);K?V?v.set(z,{alpha:Math.max(K.alpha,F),isCoarser:!0}):K.isCoarser||v.set(z,{alpha:Math.max(K.alpha,F),isCoarser:!1}):v.set(z,{alpha:F,isCoarser:V})}for(let W=B;W<=G;W++){const z=W*X;if(Math.abs(z)<N)continue;const K=T.get(z);K?V?T.set(z,{alpha:Math.max(K.alpha,F),isCoarser:!0}):K.isCoarser||T.set(z,{alpha:Math.max(K.alpha,F),isCoarser:!1}):T.set(z,{alpha:F,isCoarser:V})}}},I=!b||S>=b;w(S,M,I),w(b,E,!I);let P=!1;const L=X=>{const F=Math.abs(X);(F>=Ya||F>0&&F<Ga)&&(P=!0)};v.forEach((X,F)=>L(F)),T.forEach((X,F)=>L(F));const A=l({x:0,y:0}),_=l({x:u,y:p});L(A.x),L(A.y),L(_.x),L(_.y);const D=S||b||1,O=D>0?Math.max(0,-Math.floor(Math.log10(D))):0;return v.forEach((X,F)=>{const V=X.isCoarser?1:X.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${ki*V})`;e.strokeStyle=$,e.lineWidth=qn;{const R=c({x:F,y:0}).x;e.beginPath(),e.moveTo(R,g.y),e.lineTo(R,g.y+pt),e.stroke();let N;if(P){const Y=Math.log10(Math.abs(F)),B=Math.floor(Y),G=D/Math.pow(10,B),W=Math.max(0,-Math.floor(Math.log10(G))+1),K=Math.abs(F).toExponential(W).split("e");let H=K[0];H=H.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let q=parseInt(K[1],10);N=`${F<0?"-":""}${H} \\cdot 10^{${q}}`}else N=F.toFixed(O).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");f({id:((Y,B)=>`${Y}-${B.toExponential(15)}`)("tick-label-x",F),content:N,x:R,y:g.y+pt+as,color:$,fontSize:Ps,options:{textAlign:"center",textBaseline:"top"}})}}),T.forEach((X,F)=>{const V=X.isCoarser?1:X.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${ki*V})`;e.strokeStyle=$,e.lineWidth=qn;const R=c({x:0,y:F}).y;let N;if(P){const Y=Math.log10(Math.abs(F)),B=Math.floor(Y),G=D/Math.pow(10,B),W=Math.max(0,-Math.floor(Math.log10(G))+1),K=Math.abs(F).toExponential(W).split("e");let H=K[0];H=H.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let q=parseInt(K[1],10);N=`${F<0?"-":""}${H} \\cdot 10^{${q}}`}else N=F.toFixed(O).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");i===Wo&&Math.abs(F)>xe&&(N==="1"?N=Ii:N==="-1"?N=`-${Ii}`:N+=Ii),e.beginPath(),e.moveTo(g.x,R),e.lineTo(g.x-pt,R),e.stroke(),f({id:((Y,B)=>`${Y}-${B.toExponential(15)}`)("tick-label-y",F),content:N,x:g.x-pt-as,y:R,color:$,fontSize:Ps,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:P}};e.lineWidth=Rd,e.strokeStyle=r.axis,e.fillStyle=r.axis;let x={useScientific:!1};if(i===ra){const{interval1:S,interval2:M,alpha1:b,alpha2:E}=d;tf(e,t,{canvas:n,dpr:s,colors:r},c,f);let C=!1;const v=I=>{const P=Math.abs(I);(P>=Ya||P>0&&P<Ga)&&(C=!0)},T=l({x:0,y:0}),w=l({x:u,y:p});v(T.x),v(T.y),v(w.x),v(w.y),ef(e,t,{canvas:n,dpr:s,colors:r},c,l,d,f,C),Jh(e,t,f,0,0,{canvas:n,dpr:s,viewTransform:o,angleDisplayMode:a,colors:r},c,h),x={useScientific:C}}else{g.y>0&&g.y<p&&y(0,g.y,u,g.y),g.x>0&&g.x<u&&y(g.x,p,g.x,0);let S="x",M="y";i===Wo&&(S=Nd,M=Od),f({id:"axis-label-x",content:S,x:u-Xe-Fa,y:g.y-Oa,color:r.axis,fontSize:is,options:{textAlign:"center",textBaseline:"bottom"}}),f({id:"axis-label-y",content:M,x:g.x+Ba,y:Xe+$a,color:r.axis,fontSize:is,options:{textAlign:"left",textBaseline:"middle"}}),x=m(d.interval1,d.alpha1,d.interval2,d.alpha2)}return Zh(e,g,u,p,i,f,r),e.restore(),x}function ef(e,t,{canvas:n,dpr:s,colors:i},o,a,r,c,l){const d=n.width/s,h=n.height/s,f=o({x:0,y:0}),u=f.y>-20&&f.y<h+Ot,p=f.x>-20&&f.x<d+Ot;if(!u&&!p)return;const{interval1:g,interval2:y,alpha1:m,alpha2:x}=r,S=new Map,M=g||y||1,b=M>0?Math.max(0,-Math.floor(Math.log10(M))):0,E=(v,T,w)=>{if(!v||T<oa)return;let I=0;if(u){const D=a({x:0,y:f.y}),O=a({x:d,y:f.y});I=Math.max(I,Math.abs(D.x),Math.abs(O.x))}if(p){const D=a({x:f.x,y:0}),O=a({x:f.x,y:h});I=Math.max(I,Math.abs(D.y),Math.abs(O.y))}I*=1.1;const P=1,L=Math.ceil(I/v),_=Math.min(L,P+1e3);for(let D=P;D<=_;D++){const O=D*v;let X=!1;if(u){const F=o({x:O,y:0}).x,V=o({x:-O,y:0}).x;(F>=-20&&F<=d+Ot||V>=-20&&V<=d+Ot)&&(X=!0)}if(!X&&p){const F=o({x:0,y:O}).y,V=o({x:0,y:-O}).y;(F>=-20&&F<=h+Ot||V>=-20&&V<=h+Ot)&&(X=!0)}if(X){const F=S.get(O);F?w?S.set(O,{alpha:Math.max(F.alpha,T),isCoarser:!0}):F.isCoarser||S.set(O,{alpha:Math.max(F.alpha,T),isCoarser:!1}):S.set(O,{alpha:T,isCoarser:w})}}},C=!y||g>=y;E(g,m,C),E(y,x,!C),S.forEach((v,T)=>{const w=v.isCoarser?1:v.alpha,I=`rgba(${i.axisTickLabel.join(",")}, ${ki*w})`;e.strokeStyle=I,e.lineWidth=qn;let P;if(l){const A=Math.log10(Math.abs(T)),_=Math.floor(A),D=M/Math.pow(10,_),O=Math.max(0,-Math.floor(Math.log10(D))+1),F=Math.abs(T).toExponential(O).split("e");let V=F[0];V=V.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let $=parseInt(F[1],10);P=`${T<0?"-":""}${V} \\cdot 10^{${$}}`}else P=T.toFixed(b).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const L=T.toExponential(15);if(u){const A=o({x:T,y:0});A.x>-20&&A.x<d+Ot&&(e.beginPath(),e.moveTo(A.x,f.y-pt/2),e.lineTo(A.x,f.y+pt/2),e.stroke(),c({id:`polartick-r-x-${L}`,content:P,x:A.x,y:f.y+pt+as,color:I,fontSize:Ps,options:{textAlign:"center",textBaseline:"top"}}));const _=o({x:-T,y:0});_.x>-20&&_.x<d+Ot&&(e.beginPath(),e.moveTo(_.x,f.y-pt/2),e.lineTo(_.x,f.y+pt/2),e.stroke(),c({id:`polartick-r-negx-${L}`,content:P,x:_.x,y:f.y+pt+as,color:I,fontSize:Ps,options:{textAlign:"center",textBaseline:"top"}}))}if(p){const A=o({x:0,y:T});A.y>-20&&A.y<h+Ot&&(e.beginPath(),e.moveTo(f.x-pt/2,A.y),e.lineTo(f.x+pt/2,A.y),e.stroke(),c({id:`polartick-r-posy-${L}`,content:P,x:f.x-pt-as,y:A.y,color:I,fontSize:Ps,options:{textAlign:"right",textBaseline:"middle"}}));const _=o({x:0,y:-T});_.y>-20&&_.y<h+Ot&&(e.beginPath(),e.moveTo(f.x-pt/2,_.y),e.lineTo(f.x+pt/2,_.y),e.stroke(),c({id:`polartick-r-negy-${L}`,content:P,x:f.x-pt-as,y:_.y,color:I,fontSize:Ps,options:{textAlign:"right",textBaseline:"middle"}}))}})}function tf(e,t,{canvas:n,dpr:s,colors:i},o,a){const r=n.width/s,c=n.height/s,l=o({x:0,y:0}),d=(g,y,m,x)=>{e.beginPath(),e.moveTo(g,y),e.lineTo(m,x),e.stroke();const S=Math.atan2(x-y,m-g);e.beginPath(),e.moveTo(m,x),e.lineTo(m-Xe*Math.cos(S-hn),x-Xe*Math.sin(S-hn)),e.lineTo(m-Xe*Math.cos(S+hn),x-Xe*Math.sin(S+hn)),e.closePath(),e.fill()};e.lineWidth=qn;const h=r>l.x,f=0<l.x,u=0<l.y,p=c>l.y;h&&(d(l.x,l.y,r,l.y),a({id:"axis-label-r-posx",content:ui,x:r-Xe-Fa,y:l.y-Oa,color:i.axis,fontSize:is,options:{textAlign:"center",textBaseline:"bottom"}})),f&&(d(l.x,l.y,0,l.y),a({id:"axis-label-r-negx",content:ui,x:Xe+Fa,y:l.y-Oa,color:i.axis,fontSize:is,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(d(l.x,l.y,l.x,0),a({id:"axis-label-r-posy",content:ui,x:l.x+Ba,y:Xe+$a,color:i.axis,fontSize:is,options:{textAlign:"left",textBaseline:"middle"}})),p&&(d(l.x,l.y,l.x,c),a({id:"axis-label-r-negy",content:ui,x:l.x+Ba,y:c-Xe-$a,color:i.axis,fontSize:is,options:{textAlign:"left",textBaseline:"middle"}}))}function nf(e,{canvas:t,dpr:n,colors:s,gridAlpha:i},o,a,r,c,l){const d=t.width/n,h=t.height/n,f=Math.min(d,h)*pd;let u,p;if(o.x>=0&&o.x<=d&&o.y>=0&&o.y<=h)u=0;else{const I=[pi(o.x,o.y,0,0,d,0),pi(o.x,o.y,d,0,d,h),pi(o.x,o.y,d,h,0,h),pi(o.x,o.y,0,h,0,0)];u=Math.min(...I)}const y=[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(I=>Math.sqrt((I.x-o.x)**2+(I.y-o.y)**2));p=Math.max(...y);const m=u*n/r.scale,x=p*n/r.scale,S=(I,P)=>{if(!I||P<oa||I*r.scale/n<rh)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${P*i})`,e.lineWidth=qn;const A=m===0?1:Math.ceil(m/I),_=Math.floor(x/I);for(let D=A;D<=_;D++){const X=D*I*r.scale/n;if(X>f){const F=[],V={center:{x:o.x,y:o.y},radius:X};if([{p1:{x:0,y:0},p2:{x:d,y:0}},{p1:{x:d,y:0},p2:{x:d,y:h}},{p1:{x:d,y:h},p2:{x:0,y:h}},{p1:{x:0,y:h},p2:{x:0,y:0}}].forEach(R=>{Ir(R,V).forEach(k=>{k.x>=0&&k.x<=d&&k.y>=0&&k.y<=h&&F.push(k)})}),F.length>=2){let R=F[0],N=F[1],k=0;for(let Y=0;Y<F.length;Y++)for(let B=Y+1;B<F.length;B++){const G=(F[Y].x-F[B].x)**2+(F[Y].y-F[B].y)**2;G>k&&(k=G,R=F[Y],N=F[B])}e.beginPath(),e.moveTo(R.x,R.y),e.lineTo(N.x,N.y),e.stroke()}}else e.beginPath(),e.arc(o.x,o.y,X,0,Ne),e.stroke()}};if(S(c.interval1,c.alpha1),S(c.interval2,c.alpha2),!l||!Array.isArray(l))return;const M={x:d/2,y:h/2},b=Math.min(d,h)/4,E=Math.sqrt((o.x-M.x)**2+(o.y-M.y)**2),C=b+E;if(C<Yl||!Zl(o.x,o.y,C,d,h))return;const v=C>f;let T=null;if(v){const I={x:0,y:0,w:d,h},P={x:o.x,y:o.y,r:C},L=za(P,I);if(L.length>=2){let A=L[0],_=L[1],D=0;for(let F=0;F<L.length;F++)for(let V=F+1;V<L.length;V++){const $=(L[F].x-L[V].x)**2+(L[F].y-L[V].y)**2;$>D&&(D=$,A=L[F],_=L[V])}const O=(Math.atan2(o.y-A.y,A.x-o.x)*180/Math.PI+360)%360,X=(Math.atan2(o.y-_.y,_.x-o.x)*180/Math.PI+360)%360;T={minAngle:Math.min(O,X),maxAngle:Math.max(O,X),isFullCircle:!1},Math.abs(O-X)>180&&(T={minAngle:Math.max(O,X),maxAngle:Math.min(O,X)+360,isFullCircle:!1})}}else T=Ul(o,C,d,h);if(!T)return;const w=new Set;l.forEach(I=>{const P=I.alpha;if(P<Fl||C*(I.angle*Math.PI/180)<Gl*.5)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${P*i})`,e.lineWidth=qn*kd;let A;if(T.isFullCircle){A=[];for(let _=0;_<360;_+=I.angle)A.push(_)}else{if(A=[],T.ranges&&Array.isArray(T.ranges))T.ranges.forEach(_=>{let[D,O]=_;if(v){const $=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(k=>(Math.atan2(o.y-k.y,k.x-o.x)*180/Math.PI+360)%360),D,O].sort((k,Y)=>k-Y),R=Math.min(...$)-I.angle*2,N=Math.max(...$)+I.angle*2;D=R,O=N}const X=Bi(I.angle,D,O);A.push(...X)});else if(T.minAngle!==void 0&&T.maxAngle!==void 0){let _=T.minAngle,D=T.maxAngle;if(v){const F=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(R=>(Math.atan2(o.y-R.y,R.x-o.x)*180/Math.PI+360)%360),_,D].sort((R,N)=>R-N),V=Math.min(...F)-I.angle*2,$=Math.max(...F)+I.angle*2;_=V,D=$}A=Bi(I.angle,_,D)}A=[...new Set(A)]}A.forEach(_=>{if(_=Math.round(_*1e10)/1e10,w.has(_))return;const D=_*Math.PI/180,O={x:o.x+m*r.scale/n*Math.cos(D),y:o.y-m*r.scale/n*Math.sin(D)},X={x:o.x+x*r.scale/n*Math.cos(D),y:o.y-x*r.scale/n*Math.sin(D)};e.beginPath(),e.moveTo(O.x,O.y),e.lineTo(X.x,X.y),e.stroke(),w.add(_)})})}function sf(e,{gridDisplayMode:t,canvas:n,dpr:s,viewTransform:i,gridAlpha:o,colors:a},r,c,l,d){if(t===ei)return;e.save();const h=r({x:0,y:0}),f=n.width/s,u=n.height/s;if(t===xr){const p=c({x:0,y:0}),g=c({x:f,y:u}),y=Math.hypot(Math.max(Math.abs(p.x),Math.abs(g.x)),Math.max(Math.abs(p.y),Math.abs(g.y)));nf(e,{canvas:n,dpr:s,colors:a,gridAlpha:o},h,y,i,l,d)}else{const p=(g,y)=>{if(!g||y<oa)return;const m=`rgba(${a.grid.join(",")}, ${y*o})`,x=c({x:0,y:u}),S=c({x:f,y:0}),M=Math.floor(x.x/g),b=Math.ceil(S.x/g),E=Math.floor(x.y/g),C=Math.ceil(S.y/g);if(t===pr){e.strokeStyle=m,e.lineWidth=qn;for(let v=M;v<=b;v++){const T=v*g,w=r({x:T,y:0}).x;e.beginPath(),e.moveTo(w,0),e.lineTo(w,u),e.stroke()}for(let v=E;v<=C;v++){const T=v*g,w=r({x:0,y:T}).y;e.beginPath(),e.moveTo(0,w),e.lineTo(f,w),e.stroke()}}else if(t===yr){e.fillStyle=m;const v=rl*s;for(let T=M;T<=b;T++){const w=T*g;for(let I=E;I<=C;I++){const P=I*g,L=r({x:w,y:P});e.beginPath(),e.arc(L.x,L.y,v,0,Ne),e.fill()}}}else if(t===mr){e.fillStyle=m;const v=rl*s,T=g*ar,w=Math.floor(x.y/T),I=Math.ceil(S.y/T);for(let P=w;P<=I;P++){const L=P*T,_=P%2!==0?g/2:0;for(let D=M;D<=b;D++){const X=D*g+_,F=r({x:X,y:L});e.beginPath(),e.arc(F.x,F.y,v,0,Ne),e.fill()}}}};p(l.interval1,l.alpha1),p(l.interval2,l.alpha2)}e.restore()}function Er(e,t,n,s,i,o,a=!1){e.save(),e.strokeStyle=o,e.lineWidth=qn,e.setLineDash(a?Nl:[]);const r=-n,c=-s;let l=mt(s-n);e.beginPath(),e.arc(t.x,t.y,i,r,c,l>0),e.stroke(),e.restore()}function Ql(e,{info:t,colors:n,idPrefix:s,startVertexScreen:i},o,a,r){if(!t||!t.edge)return;const{edge:c,fraction:l,snapPoint:d}=t,h=a(c.id1),f=a(c.id2);if(!h||!f)return;const u=o(h),p=o(f),g=o(d),y=n.feedbackSnapped,m=wh({x:-(p.y-u.y),y:p.x-u.x});let x=1;i&&(x=(p.x-u.x)*(i.y-u.y)-(p.y-u.y)*(i.x-u.x)>0?-1:1);const S=ko,M={x:(u.x+g.x)/2,y:(u.y+g.y)/2},b={x:M.x+x*m.x*S,y:M.y+x*m.y*S},E=fn(l,.001,8);r({id:`${s}-1`,content:E,x:b.x,y:b.y,color:y,fontSize:Na,options:{textAlign:"center",textBaseline:"middle"}});const C={x:(g.x+p.x)/2,y:(g.y+p.y)/2},v={x:C.x+x*m.x*S,y:C.y+x*m.y*S},T=fn(1-l,.001,8);r({id:`${s}-2`,content:T,x:v.x,y:v.y,color:y,fontSize:Na,options:{textAlign:"center",textBaseline:"middle"}})}function of(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:s,isDragConfirmed:i,dragPreviewVertices:o,colors:a,edgesVisible:r,snappedEdgeIds:c,currentAltPressed:l,interpolationStyle:d,getInterpolationStyleById:h,edgeColorMode:f="fixed",edgeColorExpression:u="x",edgeWeightExpression:p="r"},g,y,m){e.lineWidth=ws;const x=ht(a.defaultStroke,{r:255,g:255,b:255,a:1}),S=b=>{const E=b?.color||a.vertex||a.defaultStroke;return ht(E,x)},M=(b,E,C,v)=>{const T=ds(b,f);if(T==="inherit_vertices"&&C&&v){const w=S(C),I=S(v),P=b.weightExpression||p,L=re(C,v)||1,A=E*L,_=(1-E)*L,D=A/L,O=_/L,X=ut(P,{x:0,y:0,r:D,a:0},1),F=ut(P,{x:0,y:0,r:O,a:0},1);return io([w,I],[X,F])}if(T==="colormap"&&b.colormapItem){const w=b.colorExpression||u,I=ut(w,{x:E},E),P=Ge(b.colormapItem,I);return ht(P,x)}return ht(b.color||a.defaultStroke,x)};t.forEach(b=>{const E=y(b.id1),C=y(b.id2);if(!E||!C||E.type!==Nn||C.type!==Nn)return;const v=m(b),T=n.includes(v),w=c&&c.has(v)&&c.get(v).some(k=>k.copyIndex===void 0||k.copyIndex===0),I=!l&&v===s;if(!r&&!T&&!w&&!I)return;let P=E,L=C;const A=b.interpolationStyleId&&h?h(b.interpolationStyleId):null;A&&A.type;const _=new Map,X=Fi(b,A,P,L,t,k=>_.get(k)||y(k),g).map(k=>g(k));if(X.length<2)return;const F=X[0],V=X[X.length-1],$=g(P),R=g(L);e.beginPath(),e.moveTo(X[0].x,X[0].y);for(let k=1;k<X.length;k++)e.lineTo(X[k].x,X[k].y);const N=ds(b,f);if(N==="colormap"||N==="inherit_vertices"){let k=0;for(let B=1;B<X.length;B++)k+=Math.hypot(X[B].x-X[B-1].x,X[B].y-X[B-1].y);let Y=0;for(let B=1;B<X.length;B++){const G=X[B-1],W=X[B],z=Math.hypot(W.x-G.x,W.y-G.y),K=k>0?Y/k:0,H=k>0?(Y+z)/k:1,q=(K+H)/2,se=M(b,q,P,L);e.strokeStyle=`rgba(${Math.round(se.r)},${Math.round(se.g)},${Math.round(se.b)},${se.a})`,e.beginPath(),e.moveTo(G.x,G.y),e.lineTo(W.x,W.y),e.setLineDash([]),e.lineWidth=ws,e.stroke(),Y+=z}}else if(b.colormapItem){const k=e.createLinearGradient(F.x,F.y,V.x,V.y),Y=Ge(b.colormapItem,b.gradientStart),B=Ge(b.colormapItem,b.gradientEnd);k.addColorStop(0,Y),k.addColorStop(1,B),e.strokeStyle=k,e.setLineDash([]),e.lineWidth=ws,e.stroke()}else e.strokeStyle=b.color||a.defaultStroke,e.setLineDash([]),e.lineWidth=ws,e.stroke();if(T||w||I){if(e.save(),e.globalAlpha=Ls,e.lineCap="round",e.lineJoin="round",T||w||I){const k=w?a.feedbackSnapped:a.selectionGlow,Y=_i,B=R.x-$.x,G=R.y-$.y,W=Math.hypot(B,G);if(e.strokeStyle=k,e.lineWidth=us,W>xe){const z=-G/W,K=B/W,H=z*Y,q=K*Y;e.beginPath(),e.arc($.x,$.y,Y,Math.atan2(q,H),Math.atan2(-q,-H)),e.lineTo(R.x-H,R.y-q),e.arc(R.x,R.y,Y,Math.atan2(-q,-H),Math.atan2(q,H)),e.closePath(),e.stroke()}else e.beginPath(),e.arc($.x,$.y,Y,0,Ne),e.stroke()}e.restore()}}),e.setLineDash([]),e.strokeStyle=a.defaultStroke,e.globalAlpha=1}function $i(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,snappedVertexIds:h,isDragConfirmed:f,dragPreviewVertices:u,currentAltPressed:p}=n;let g=t,y=!1,m=null,x;if(f&&u){const E=u.find(C=>C&&(C.id===t.id||C.originalId===t.id));E&&(g=E,x=E.transformIndex)}if(h&&g.originalId&&h.has(g.originalId)){const C=h.get(g.originalId).find(v=>v.copyIndex===x);C&&(y=!0,m=C.type)}else if(h&&!g.originalId&&h.has(g.id)){const C=h.get(g.id).find(v=>v.copyIndex===x);C&&(y=!0,m=C.type)}let S;if(g.type===Nn){if(S=o.includes(g.id),!l&&!S&&!d&&!y&&!(p&&d))return}else S=a.includes(g.id);const M=s(g);switch(g.type){case Nn:e.beginPath(),e.arc(M.x,M.y,Je,0,Ne),e.fillStyle=g.color||c.vertex,e.fill();break;case mn:case ts:case vn:case Ms:const E=sa*2,C={type:g.type,x:M.x-E/2,y:M.y-E/2,width:E,height:E};ha(e,C,c);break}const b={...n,isSnapped:y,snapType:m};Mr(e,g,b,s)}function af(e,{altHoverInfo:t,colors:n},s,i,o){if(!t)return;const{point:a,element:r,shiftKey:c,fraction:l}=t,d=s(a),h=n.feedbackSnapped,f=n.feedbackSnapped;e.save(),e.shadowColor=f,e.shadowBlur=hr,e.globalAlpha=Ls,e.beginPath();const u=Je+Oi;e.arc(d.x,d.y,u,0,Ne),e.strokeStyle=f,e.lineWidth=us,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(d.x,d.y,Je,0,Ne),e.fillStyle=h,e.fill(),e.restore(),r.type==="edge"&&c&&rf(e,{info:{edge:r.edge,fraction:l,snapPoint:a},colors:n},s,i,o)}function rf(e,{info:t,colors:n},s,i,o){Ql(e,{info:t,colors:n,idPrefix:"alt-snap-label"},s,i,o)}function lf(e,{info:t,colors:n},s,i,o){if(!t||!t.startVertex)return;const a=s(t.startVertex);Ql(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:a},s,i,o)}function cf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,currentPos:r,rotation:c,isSnapping:l,snapType:d}=t,h=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(o),u=i(a),p=i(r);if(e.save(),e.lineWidth=gn,e.strokeStyle=h,e.setLineDash(Wn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!s||s&&d==="projection"){const y=je(a,o,c,1),m=i(y);e.beginPath(),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.stroke()}if(Math.abs(c)>lr){e.setLineDash([]);const y=re(f,u),m=Math.atan2(u.y-f.y,u.x-f.x),x=-c,S=c>0;e.beginPath(),e.arc(f.x,f.y,y,m,m+x,S),e.stroke()}e.restore()}function df(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,scale:r,isSnapping:c,snapType:l,currentPos:d}=t,h=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(o),u=i(a),p=i(d);if(e.save(),e.lineWidth=gn,e.strokeStyle=h,e.setLineDash(Wn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!s){const x=re(f,p),S=Math.atan2(u.y-f.y,u.x-f.x),M=Math.atan2(p.y-f.y,p.x-f.x);let b=M-S;b>Math.PI?b-=2*Math.PI:b<-Math.PI&&(b+=2*Math.PI);const E=b<0;e.beginPath(),e.arc(f.x,f.y,x,S,M,E),e.stroke()}const y={x:o.x+(a.x-o.x)*r,y:o.y+(a.y-o.y)*r},m=i(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(m.x,m.y),e.stroke(),e.restore()}function hf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,currentPos:r,scale:c,startVector:l,isSnapping:d,snapType:h,projectionSource:f}=t,u=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,p=i(o),g=i(a),y=i(r);e.save(),e.lineWidth=gn,e.strokeStyle=u,e.setLineDash(Wn),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(g.x,g.y),e.stroke();const m=je(a,o,0,c,!0,l),x=i(m);if((!s||s&&h==="projection")&&(e.setLineDash(Wn),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(x.x,x.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(x.x,x.y),e.stroke(),d&&h==="projection"&&f){const M=i(f),b=o,E={x:o.x+l.x,y:o.y+l.y},C=zl(f,b,E),v=i(C);e.setLineDash(Wn),e.beginPath(),e.moveTo(M.x,M.y),e.lineTo(v.x,v.y),e.stroke()}e.restore()}function ff(e,{transformIndicatorData:t,colors:n},s){const{center:i,startPos:o,rotation:a,scale:r,isSnapping:c}=t,l=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,d=s(i),h=s(o);e.save(),e.lineWidth=gn,e.strokeStyle=l,e.setLineDash(Wn),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(h.x,h.y),e.stroke();const f={x:i.x+(o.x-i.x)*r,y:i.y+(o.y-i.y)*r},u=s(f);if(e.setLineDash([]),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(a)>lr){const p=re(d,u),g=Math.atan2(h.y-d.y,h.x-d.x),y=-a,m=a>0;e.beginPath(),e.arc(d.x,d.y,p,g,g+y,m),e.stroke()}e.restore()}function uf(e,t,{transformIndicatorData:n,colors:s,coordSystemTransformIndicatorData:i,currentShiftPressed:o},a,r){if(n){const{isSnapping:c,snapType:l,transformType:d}=n;switch(e.save(),e.lineWidth=gn,d){case vn:ff(e,{transformIndicatorData:n,colors:s},a);break;case mn:cf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break;case ts:df(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break;case Ms:hf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break}c&&l==="projection"&&o&&gf(e,{transformIndicatorData:n,colors:s},a),e.restore(),pf(t,{transformIndicatorData:n,colors:s},a,r)}i&&yf(t,{coordSystemTransformIndicatorData:i,colors:s},a,r)}function gf(e,{transformIndicatorData:t,colors:n},s){const{transformType:i,projectionSource:o,projectionCenter:a,projectionPoint:r,currentPos:c}=t;if(i!==vn){if(e.setLineDash(Wn),e.strokeStyle=n.feedbackSnapped,i===mn&&r){const l=s(c),d=s(r),h=s(o);e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(d.x,d.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(d.x,d.y),e.stroke()}else if(i===ts&&a){const l=s(a),d=s(o),h=s(c),f=re(l,d);let u=Math.atan2(d.y-l.y,d.x-l.x),p=Math.atan2(h.y-l.y,h.x-l.x);const g=2*Math.PI;u=(u+g)%g,p=(p+g)%g;const y=(p-u+g)%g,x=(u-p+g)%g<y;e.beginPath(),e.arc(l.x,l.y,f,u,p,x),e.stroke()}}}function pf(e,{transformIndicatorData:t,colors:n},s,i){const{center:o,startPos:a,rotation:r,scale:c,isSnapping:l,snapType:d,snappedScaleValue:h,transformType:f}=t,u=s(o),p=s(a),g=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(f===ts||f===vn||f===Ms){let y;const m=h!==null?h:c;d==="projection"||d==="merge"&&f===vn?y=`\\times ${parseFloat(m.toFixed(Ca)).toString()}`:l&&h!==null?y=`\\times ${fn(h,As,Qd)}`:y=`\\times ${parseFloat(m.toFixed(Ca)).toString()}`;const S=(u.x+p.x)/2,M=(u.y+p.y)/2,b=Math.atan2(p.y-u.y,p.x-u.x),E=b-Math.PI/2,C=S+Math.cos(E)*sl,v=M+Math.sin(E)*sl;let T=b*(180/Math.PI);(T>90||T<-90)&&(T+=180),i({id:"transform-scale-indicator",content:y,x:C,y:v,color:g,fontSize:bn,options:{textAlign:"center",textBaseline:"bottom",rotation:T}})}else i({id:"transform-scale-indicator",content:"",x:0,y:0,color:g,fontSize:bn,options:{}});if((f===mn||f===vn)&&Math.abs(r)>lr){const y=r*(180/Math.PI),m=`${parseFloat(y.toFixed(Ca)).toString()}^{\\circ}`,x={x:p.x-u.x,y:p.y-u.y},S=Math.atan2(x.y,x.x)+-r/2,b=Math.hypot(x.x,x.y)+Zd,E=u.x+b*Math.cos(S),C=u.y+b*Math.sin(S);let v=S*(180/Math.PI);(v>90||v<-90)&&(v+=180),i({id:"transform-angle-indicator",content:m,x:E,y:C,color:g,fontSize:bn,options:{rotation:v}})}else i({id:"transform-angle-indicator",content:"",x:0,y:0,color:g,fontSize:bn,options:{}})}function yf(e,{coordSystemTransformIndicatorData:t,colors:n},s,i){const{edgeFraction:o,orthogonalDistanceFraction:a,v1:r,v2:c,snapPosition:l}=t;let d="",h={x:0,y:0};if(a!==void 0){d=fn(a,.001,8);const f=s(l.origin),u=s(l.closest),p=(f.x+u.x)/2,g=(f.y+u.y)/2,y=Math.atan2(u.y-f.y,u.x-f.x);h.x=p+Math.cos(y+Math.PI/2)*ko,h.y=g+Math.sin(y+Math.PI/2)*ko}else if(o!==void 0){const f=s(r),u=s(c),p=s(l),g=Math.atan2(u.y-f.y,u.x-f.x),y=Math.cos(g+Math.PI/2)*ko,m=Math.sin(g+Math.PI/2)*ko;h.x=p.x+y,h.y=p.y+m,d=fn(o,.001,8)}d&&i({id:"coord-system-edge-fraction",content:d,x:h.x,y:h.y,color:n.feedbackSnapped,fontSize:Na,options:{textAlign:"center",textBaseline:"middle"}})}function mf(e,t,n,s,{showAngles:i,showDistances:o,viewTransform:a,mousePos:r,colors:c}){if(!i&&!o||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,d=s(r);if(re(l,d)<xe)return;const f=c.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,p=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const g=n(l),y=p+u;if(e.save(),e.lineWidth=gn,e.strokeStyle=f,i&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>xe){const m=uo+e.lineWidth/2,x={x:l.x+Math.cos(p)*(m/a.scale),y:l.y+Math.sin(p)*(m/a.scale)},S=n(x);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(S.x,S.y),e.setLineDash(Id),e.stroke(),Er(e,g,p,y,uo,f,!1)}e.restore()}function ec(e,t,n,s,i,{showDistances:o,showAngles:a,currentShiftPressed:r,distanceSigFigs:c,angleSigFigs:l,angleDisplayMode:d,viewTransform:h,frozenReference_D_du:f,gridDisplayMode:u,frozenReference_A_rad:p,colors:g,lastGridState:y},m,x,S){if(!a&&!o||i.distance<xe){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const M=m(n),{angle:b,distance:E,lengthSnapFactor:C,angleSnapFactor:v,angleTurn:T,gridToGridSquaredSum:w,gridInterval:I,snapType:P}=i,{offsetAngleRad:L,isFirstSegmentBeingDrawn:A,currentSegmentReferenceD:_}=x,D=i.snapped||r?g.feedbackSnapped:g.geometryInfoText,O=Math.atan2(s.y-n.y,s.x-n.x);if(E*h.scale/window.devicePixelRatio<Xl){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const X=a&&E>xe&&(A||Math.abs(T)>xe);if(o){let F="",V=i.gridInterval||null;if(!V&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&(V=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),r&&i.snapped)if(A)if(P==="grid"&&w!==null&&V)if(w===0)F="0";else{const[$,R]=_s(w),N=V*$,k=parseFloat(N.toFixed(10));F=Ds(k,R)}else if(P==="geometric"&&C!==null){const $=C*_;F=fn($,As,eo),(F===$.toFixed(2)||F===String(Math.round($)))&&(F=It($,c))}else if(P==="vertex"||P==="edge_fraction"||P==="edge"){let $=!1;if(V){const R=i.x-n.x,N=i.y-n.y,k=R/V,Y=N/V;if(Math.abs(k-Math.round(k))<1e-5&&Math.abs(Y-Math.round(Y))<1e-5){const B=Math.round(k),G=Math.round(Y),W=B*B+G*G;if(W===0)F="0";else{const[z,K]=_s(W),H=V*z,q=parseFloat(H.toFixed(10));F=Ds(q,K)}$=!0}}$||(F=It(E,c))}else F=It(E,c);else if(P==="geometric"&&C!==null)F=Js(C,"D");else if(P==="grid"&&w!==null&&V&&f!==null&&f>xe){const R=V*Math.sqrt(w)/f;let N=!1;for(const k of cs)if(Math.abs(R-k)<xe){F=Js(k,"D"),N=!0;break}if(!N)if(w===0)F="0";else{const[k,Y]=_s(w),B=V*k,G=parseFloat(B.toFixed(10));F=Ds(G,Y)}}else if(P==="vertex"||P==="edge_fraction"||P==="edge")if(f!==null&&f>xe){const $=E/f;let R=!1;for(const N of cs)if(Math.abs($-N)<xe){F=Js(N,"D"),R=!0;break}R||(F=It(E,c))}else F=It(E,c);else F=It(E,c);else if(!A&&f!==null&&f>xe){const $=E/f;let R=!1;for(const N of cs)if(Math.abs($-N)<xe){F=Js(N,"D"),R=!0;break}R||(F=It(E,c))}else F=It(E,c);if(F){const $=m(n),R=m(s),N=Math.atan2(R.y-$.y,R.x-$.x),k=($.x+R.x)/2,Y=($.y+R.y)/2;let B;if(X){const K=A?-O:-T;K<0&&K>-Math.PI||K>Math.PI?B=N-Math.PI/2:B=N+Math.PI/2}else B=N-Math.PI/2,Math.sin(B)>0&&(B+=Math.PI);const G=k+Math.cos(B)*rs,W=Y+Math.sin(B)*rs;let z=N*(Fo/Math.PI);(z>Ol||z<-90)&&(z+=Fo),S({id:"snap-dist",content:F,x:G,y:W,color:D,fontSize:bn,options:{rotation:z}},t)}else S({id:"snap-dist",content:"",x:0,y:0})}else S({id:"snap-dist",content:"",x:0,y:0});if(X){const F=A?0:L;Er(e,M,F,O,uo,D),e.save(),e.beginPath();const V=uo+e.lineWidth/2,$={x:n.x+V/h.scale*Math.cos(F),y:n.y+V/h.scale*Math.sin(F)},R=m($);e.moveTo(M.x,M.y),e.lineTo(R.x,R.y),e.strokeStyle=D,e.setLineDash(Sd),e.lineWidth=gn,e.stroke(),e.restore();let N="";const k=!A&&p!==null&&Math.abs(p)>xe,Y=x.currentSegmentReferenceA_for_display,B=A?O:T;if(d===Ns){let G=mt(B)*(180/Math.PI);r&&!A&&i.snapped&&P==="geometric"&&v!==null||r&&k&&v!==null&&i.snapped&&P!=="geometric"?N=Js(v,"A"):Math.abs(G)>Ni&&(N=`${It(G,l)}^{\\circ}`)}else if(d===ti){let G=mt(B);if(r&&!A&&i.snapped&&P==="geometric"&&v!==null&&Y){const W=fn(v*(Y/Math.PI),As,eo);W==="0"?N="0":W==="1"?N=Gt:W==="-1"?N=`-${Gt}`:N=`${W}${Gt}`}else if(r&&k&&v!==null&&i.snapped&&P!=="geometric"&&Y){const W=fn(v*(Y/Math.PI),As,eo);W==="0"?N="0":W==="1"?N=Gt:W==="-1"?N=`-${Gt}`:N=`${W}${Gt}`}else if(Math.abs(G)>Ni){const W=fn(G/Math.PI,As,eo);W!==G.toFixed(2)?W==="0"?N="0":W==="1"?N=Gt:W==="-1"?N=`-${Gt}`:N=`${W}${Gt}`:N=It(G,l)}}if(N){const G=-F,W=-O,z=Math.cos(G)+Math.cos(W),K=Math.sin(G)+Math.sin(W),H=Math.atan2(K,z),q=Li;let se=H*(180/Math.PI);const fe={x:q*Math.cos(H),y:q*Math.sin(H)},ae={x:M.x+fe.x,y:M.y+fe.y};(se>90||se<-90)&&(se+=180),S({id:"snap-angle",content:N,x:ae.x,y:ae.y,color:D,fontSize:bn,options:{rotation:se}},t)}else S({id:"snap-angle",content:"",x:0,y:0})}else S({id:"snap-angle",content:"",x:0,y:0})}function xf(e,t,{showAngles:n,showDistances:s,viewTransform:i,mousePos:o,frozenReference_D_du:a,distanceSigFigs:r,angleSigFigs:c,angleDisplayMode:l,colors:d},h,f,u){const p=Xl/i.scale;let g=-1;if(t.frozen_Origin_Data_to_display){const I=t.frozen_Origin_Data_to_display,P=h(o);g=re(I,P)}if(!n&&!s||!t.frozen_Origin_Data_to_display||g<p)return;const y=d.frozenReference,m=t.frozen_Origin_Data_to_display,x=t.displayAngleA_valueRad_for_A_equals_label,S=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,M=t.frozen_D_du_to_display,b=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,E=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!m)return;const C=S+x,v={x:m.x+M*Math.cos(C),y:m.y+M*Math.sin(C)},T=f(m),w=f(v);if(s&&M!==null&&M>p){let I="";if(b!==null&&b>0&&E){const[F,V]=_s(b),$=E*F,R=parseFloat($.toFixed(10));I=`${il}${Ds(R,V)}`}else{const F=M/Va;I=`${il}${It(F,r)}`}const P=Math.atan2(w.y-T.y,w.x-T.x),L=(T.x+w.x)/2,A=(T.y+w.y)/2;let _=P*(Fo/Math.PI);(_>Ol||_<-90)&&(_+=Fo);let D;x!==null&&Math.abs(x)>xe?-x<0?D=P-Math.PI/2:D=P+Math.PI/2:(D=P-Math.PI/2,Math.sin(D)>0&&(D+=Math.PI));const O=L+Math.cos(D)*Ri,X=A+Math.sin(D)*Ri;u({id:"ref-dist",content:I,x:O,y:X,color:y,fontSize:Xa,options:{rotation:_}},e)}if(n&&x!==null&&Math.abs(x)>xe){const I=-S,P=-(S+x),L=Math.cos(I)+Math.cos(P),A=Math.sin(I)+Math.sin(P),_=Math.atan2(A,L),D=Li,O=T.x+Math.cos(_)*D,X=T.y+Math.sin(_)*D;let F=_*(180/Math.PI);(F>90||F<-90)&&(F+=180);let V="";if(l===Ns){let $=x*(Fo/Math.PI);V=`${Po}${It($,c)}^{\\circ}`}else l===ti&&(V=`${Po}${fn(x/Math.PI,As,eo)}${Gt}`,V===`${Po}1${Gt}`&&(V=Gt),V===`${Po}-1${Gt}`&&(V=`-${Gt}`),V===`${Po}0${Gt}`&&(V="0"));u({id:"ref-angle",content:V,x:O,y:X,color:y,fontSize:Xa,options:{rotation:F}},e)}}function Sf(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:s,ghostVertexPosition:i,gridDisplayMode:o,lastGridState:a,angleDisplayMode:r,canvas:c,dpr:l,mousePos:d,colors:h,useScientific:f},u,p){if(t===aa||!d||!n)return;let g;s&&i?g=i:g=u(d);let y=1;o!==ei&&a&&a.interval1&&(y=a.interval1);let m=y;a&&a.interval2&&a.interval2<m&&(m=a.interval2);let x,S=1;m>=1e4?(S=100,x=0):m>=1e3?(S=10,x=0):m>=100?(S=1,x=0):m>=10?x=1:x=Math.max(0,-Math.floor(Math.log10(m)))+2;const E=(I=>1)(m)+2,C=I=>{if(f){const P=E-1,A=Math.abs(I).toExponential(P).split("e");let _=A[0],D=parseInt(A[1],10);return`${I<0?"-":""}${_} \\cdot 10^{${D}}`}else return S>1?(Math.round(I/S)*S).toFixed(x):I.toFixed(x)},v=Math.min(x,eh);let T="";switch(t){case gr:{let I=C(g.x);g.x>=0&&!I.includes("cdot")&&(I=`${Us}${I}`);let P=C(g.y);g.y>=0&&!P.includes("cdot")&&(P=`${Us}${P}`),T=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${I} \\\\ ${P} \\end{pmatrix*}`;break}case Wo:{let I=C(g.x);g.x>=0&&!I.includes("cdot")&&(I=`${Us}${I}`);const P=Math.abs(g.y);let L=C(P);const A=g.y<0?"-":"+";T=`z = ${I} ${A} ${L}${Ii}`;break}case ra:{const I=Math.hypot(g.x,g.y),P=Math.atan2(g.y,g.x);let L=C(I);I>=0&&!L.includes("cdot")&&(L=`${Us}${L}`);let A;if(r===Ns){let _=Ch(P*180/Math.PI);A=_.toFixed(v),_>=0&&(A=`${Us}${A}`),A+="^{\\circ}"}else{let _=mt(P);A=_.toFixed(v),_>=0&&(A=`${Us}${A}`)}T=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${L} \\\\ ${A} \\end{pmatrix*}`;break}}const w=c.width/l;p({id:"mouse-coord-text",content:T,x:w-tl,y:tl,color:h.mouseCoords,fontSize:th,options:{textAlign:"right",textBaseline:"top"}})}function tc(e,t,n,s){e.save();const i=t.x+t.width/2,o=t.y+t.height/2,a=t.width/2*.6;if(e.strokeStyle=s.uiIcon,e.fillStyle=s.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(i,o,a*.7,0,2*Math.PI),e.fill();for(let r=0;r<8;r++){const c=r/8*2*Math.PI,l=i+Math.cos(c)*(a*.85),d=o+Math.sin(c)*(a*.85),h=i+Math.cos(c)*(a*1.1),f=o+Math.sin(c)*(a*1.1);e.beginPath(),e.moveTo(l,d),e.lineTo(h,f),e.stroke()}}else e.beginPath(),e.arc(i,o,a,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i-5,o-3,a,0,2*Math.PI),e.fillStyle=s.background,e.fill();e.restore()}function If(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/Eo;e.scale(l,l),e.translate(-16,-16);const d=0;e.strokeStyle=r,e.lineWidth=Ln,e.lineCap="round",e.beginPath(),e.moveTo(0+d,32),e.lineTo(32+d,32),e.moveTo(0+d,32),e.lineTo(0+d,0),e.stroke(),e.fillStyle=r;const h={x:16+d,y:16};let f={x:16+d,y:8},u="";switch(n){case gr:e.setLineDash(Ma),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(h.x,32),e.moveTo(h.x,h.y),e.lineTo(0+d,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,zn,0,Ne),e.fill(),u="(x,y)";break;case Wo:e.setLineDash(Ma),e.beginPath(),e.moveTo(0+d,32),e.lineTo(h.x,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,zn,0,Ne),e.fill(),u="x+iy";break;case ra:e.setLineDash(Ma),e.beginPath(),e.moveTo(0+d,32),e.lineTo(h.x,h.y),e.stroke(),e.beginPath(),e.arc(0+d,32,8,-Math.atan2(32-h.y,h.x-(0+d)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,zn,0,Ne),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const p="icon-label-coords",g=s?a.uiTextSelected:a.uiTextDefault;o({id:p,content:u,x:c.x+(f.x-16)*l,y:c.y+(f.y-16)*l,color:g,fontSize:dr,options:{textAlign:"center",textBaseline:"middle"}},i)}}function nc(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(c.x,c.y);const d=t.width/Eo;e.scale(d,d),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=Ln;const h={x:32,y:32},f={x:0,y:32},u={x:16,y:0};e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke();let p="",g={x:20,y:22};if(n!==zo){e.beginPath();const y=Math.atan2(u.y-f.y,u.x-f.x);e.arc(f.x,f.y,8,y,0),e.stroke(),n===Ns?p="60^\\circ":n===ti&&(p="\\frac{\\pi}{3}",l=2)}if(e.restore(),p){const y="icon-label-angles",m=s?a.uiTextSelected:a.uiTextDefault;o({id:y,content:p,x:c.x+(g.x-16)*d,y:c.y+(g.y-20)*d,color:m,fontSize:dr+l,options:{textAlign:"center",textBaseline:"middle"}},i)}}function sc(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/Eo;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=Ln,e.beginPath(),e.moveTo(0,32),e.lineTo(32,32),e.stroke();let d="",h={x:16,y:22};if(n===Ho&&(d="3.14"),e.restore(),d){const f="icon-label-distances",u=s?a.uiTextSelected:a.uiTextDefault;o({id:f,content:d,x:c.x+(h.x-16)*l,y:c.y+(h.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function bf(e,t,n,s,i){const o=s?i.uiIconSelected:i.uiIconDefault,a={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(a.x,a.y);const r=t.width/Eo;switch(e.scale(r,r),e.translate(-16,-16),e.strokeStyle=o,e.fillStyle=o,e.lineWidth=Ln,n){case pr:e.strokeRect(0,0,32,32),e.beginPath(),e.moveTo(0,16),e.lineTo(32,16),e.moveTo(16,0),e.lineTo(16,32),e.stroke();break;case yr:e.strokeRect(0,0,32,32),e.beginPath(),[8,16,24].forEach(h=>{[8,16,24].forEach(f=>{e.moveTo(h,f),e.arc(h,f,zn,0,Ne)})}),e.fill();break;case mr:e.strokeRect(0,0,32,32);const c=8,l=16,d=16;e.beginPath(),e.arc(l,d,zn,0,Ne);for(let h=0;h<6;h++){const f=Math.PI/3*h,u=l+c*Math.cos(f),p=d+c*Math.sin(f);e.moveTo(u,p),e.arc(u,p,zn,0,Ne)}e.fill();break;case xr:e.beginPath(),e.arc(16,16,14,0,Ne),e.stroke(),e.beginPath(),e.arc(16,16,7,0,Ne),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case ei:e.strokeRect(2,2,28,28);break}e.restore()}function ha(e,t,n){const s={x:t.x+t.width/2,y:t.y+t.height/2},i=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=Ln,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(s.x,s.y),t.type){case mn:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();const a=i*.25,r=i*Math.cos(o),c=i*Math.sin(o);e.save(),e.translate(r,c),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),d=i*Math.sin(Math.PI+o);e.save(),e.translate(l,d),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();break}case ts:{const o=i*.8,a=i*.25;e.beginPath(),e.moveTo(-o,0),e.lineTo(o,0),e.moveTo(0,-o),e.lineTo(0,o),e.stroke(),[{x:o,y:0,dirX:1,dirY:0},{x:-o,y:0,dirX:-1,dirY:0},{x:0,y:-o,dirX:0,dirY:-1},{x:0,y:o,dirX:0,dirY:1}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}case vn:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();let a=i*.25;const r=i*Math.cos(o),c=i*Math.sin(o);e.save(),e.translate(r,c),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),d=i*Math.sin(Math.PI+o);e.save(),e.translate(l,d),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const h=i*.8;a=i*.25,e.beginPath(),e.moveTo(-h,0),e.lineTo(h,0),e.moveTo(0,-h),e.lineTo(0,h),e.stroke(),[{x:h,y:0,dirX:1,dirY:0},{x:-h,y:0,dirX:-1,dirY:0},{x:0,y:-h,dirX:0,dirY:-1},{x:0,y:h,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a+u.dirY*a*.5,u.y-u.dirY*a-u.dirX*a*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a-u.dirY*a*.5,u.y-u.dirY*a+u.dirX*a*.5),e.stroke()});break}case Ms:{const o=i*.8,a=i*.25;e.beginPath(),e.moveTo(-o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(o/Math.sqrt(2),o/Math.sqrt(2)),e.moveTo(o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(-o/Math.sqrt(2),o/Math.sqrt(2)),e.stroke(),[{x:o/Math.sqrt(2),y:-o/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-o/Math.sqrt(2),y:o/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}}e.restore()}function vf(e,t,n){const s=t.x+t.width/2,i=t.y+t.height/2,o=t.width*.6,a=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=Ln,e.lineCap="round",e.beginPath(),e.ellipse(s,i,o/2,a/2,0,0,2*Math.PI),e.stroke();const r=a*.3;e.beginPath(),e.arc(s,i,r,0,2*Math.PI),e.fill(),e.restore()}function Mf(e,t,n,s){const{canvasUI:i,colors:o,allColors:a,namedColors:r,colorAssignments:c,activeColorTargets:l,lastSelectedSwatchIndex:d,verticesVisible:h,edgesVisible:f,facesVisible:u,isDraggingColorTarget:p,draggedColorTargetInfo:g,mousePos:y}=n,m=o.checkerboardColor1,x=o.checkerboardColor2;function S(v){const T=v.height/3,w=Math.ceil(v.width/T);for(let I=0;I<3;I++)for(let P=0;P<w;P++){e.fillStyle=(I+P)%2===0?m:x;const L=v.x+P*T,A=v.y+I*T,_=Math.min(T,v.x+v.width-L),D=Math.min(T,v.y+v.height-A);_>0&&D>0&&e.fillRect(L,A,_,D)}}const M=i.randomColorButton;if(M){e.fillStyle="#000000",e.fillRect(M.x,M.y,M.width,M.height),e.strokeStyle=o.uiDefault,e.lineWidth=Bn,e.strokeRect(M.x,M.y,M.width,M.height);const v=M.x+M.width/2,T=M.y+M.height/2,w=M.width*.35,I=8;for(let P=0;P<I;P++){const L=P/I*2*Math.PI,A=(P+1)/I*2*Math.PI,_=P/I*360;e.fillStyle=`hsl(${_}, 70%, 60%)`,e.beginPath(),e.moveTo(v,T),e.arc(v,T,w,L,A),e.closePath(),e.fill()}e.fillStyle=o.background,e.beginPath(),e.arc(v,T,w*.4,0,2*Math.PI),e.fill()}const b=i.removeColorButton;b&&(e.strokeStyle=o.uiDefault,e.lineWidth=Bn,e.strokeRect(b.x,b.y,b.width,b.height),e.beginPath(),e.moveTo(b.x+an,b.y+b.height/2),e.lineTo(b.x+b.width-an,b.y+b.height/2),e.stroke()),i.colorSwatches.forEach(v=>{const T=v.item;let w=!1;if(T&&T.type==="color"){const I=jn(T.value);I&&I.a<1&&(w=!0)}else T&&T.type==="colormap"&&T.vertices.some(I=>I.alpha!==void 0&&I.alpha<1)&&(w=!0);if(w&&S(v),T&&T.type==="colormap"){const I=e.createLinearGradient(v.x,v.y,v.x+v.width,v.y);T.vertices.forEach(P=>{let L=P.color;typeof L=="string"&&(L=r[L]||[0,0,0]),I.addColorStop(P.pos,`rgba(${L.join(",")},${P.alpha||1})`)}),e.fillStyle=I}else T&&(e.fillStyle=T.value);e.fillRect(v.x,v.y,v.width,v.height)});const E=i.addColorButton;if(E&&(e.strokeStyle=o.uiDefault,e.lineWidth=Bn,e.strokeRect(E.x,E.y,E.width,E.height),e.beginPath(),e.moveTo(E.x+E.width/2,E.y+an),e.lineTo(E.x+E.width/2,E.y+E.height-an),e.moveTo(E.x+an,E.y+E.height/2),e.lineTo(E.x+E.width-an,E.y+E.height/2),e.stroke()),i.colorTargetIcons){const v=I=>{let P=c[I];return p&&g&&g.target===I&&g.previewColorIndex!==void 0&&(P=g.previewColorIndex),P},T=I=>{let P=v(I);const L=P===-1?null:a[P],A={};if(I===et)A.vertexState=h?"filled":"disabled",P===-1?A.vertexColor=Qs:L&&L.type==="color"?A.vertexColor=L.value:L&&L.type==="colormap"&&(A.vertexColormapItem=L);else if(I===tt)A.edgeState=f?"solid":"disabled",P===-1?A.edgeColor=Qs:L&&L.type==="color"?A.edgeColor=L.value:L&&L.type==="colormap"&&(A.edgeColormapItem=L);else if(I===at)A.faceState=u?"filled":"disabled",P===-1?A.faceColor=Qs:L&&L.type==="color"?A.faceColor=L.value:L&&L.type==="colormap"&&(A.faceColormapItem=L);else if(I===Ht){P===-1?A.textColor=Qs:L&&L.type==="color"?A.textColor=L.value:L&&L.type==="colormap"&&(A.textColor=Ge(L,.5));const _=v(at);if(_===P){const D=_===-1?null:a[_];D?D.type==="color"?A.faceColorForContrast=D.value:D.type==="colormap"&&(A.faceColorForContrast=Ge(D,.5)):A.faceColorForContrast=Qs}}return A};[at,tt,et,Ht].forEach(I=>{const P=i.colorTargetIcons.find(L=>L.target===I);if(P){l.includes(I);const L=T(I);if(p&&g&&g.target===at&&I===at){const A=i.colorSwatches.find(_=>y.x>=_.x&&y.x<=_.x+_.width&&y.y>=_.y&&y.y<=_.y+_.height);if(A&&A.item.type==="colormap"){const _=kh((y.x-A.x)/A.width,0,1);L.faceColor=Ge(A.item,_),L.faceState="filled"}}I===Ht?Pf(e,P,L,o,!1):qo(e,P,L,o,!1)}})}const C=new Set;if(d!=null){const v=i.colorSwatches.find(T=>T.index===d);if(v){const w=i.colorTargetIcons.find(P=>P.x+P.width/2>=v.x&&P.x+P.width/2<=v.x+v.width),I=w?Math.min(w.y,v.y):v.y;e.strokeStyle=o.selectionGlow,e.lineWidth=Bn,e.strokeRect(v.x-2,I-2,v.width+4,v.y+v.height-I+4),C.add(d)}}l.forEach(v=>{let T=c[v];if(p&&g&&g.target===v&&g.previewColorIndex!==void 0&&(T=g.previewColorIndex),T===-1||C.has(T))return;const w=i.colorSwatches.find(I=>I.index===T);if(w){const I=Object.keys(c).filter(L=>{let A=c[L];return p&&g&&g.target===L&&g.previewColorIndex!==void 0&&(A=g.previewColorIndex),A===w.index&&l.includes(L)}),P=i.colorTargetIcons.filter(L=>I.includes(L.target));if(P.length>0){const L=Math.min(...P.map(F=>F.y));e.strokeStyle=o.selectionGlow,e.lineWidth=Bn;const A=2,_=w.x-A,D=L-A,O=w.width+A*2,X=w.y+w.height-D+A;e.strokeRect(_,D,O,X),C.add(T)}}})}function Ef(e,t,n,s){const{canvasUI:i,colors:o,allColors:a,activeThemeName:r,edgeColorMode:c,faceColorMode:l,selectedEdgeModes:d,selectedFaceModes:h,edgeWeightExpression:f,faceVertexWeightExpression:u,faceEdgeWeightExpression:p,faceColorExpression:g,edgeColorExpression:y,angleDisplayMode:m}=n,x=i.colorModeIcons||[];if(!x.length)return;const S=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"],M=d&&d.length>0?d:[c],b=h&&h.length>0?h:[l];a&&a.find(v=>v&&v.type==="colormap");const C={type:"colormap",vertices:[{pos:0,color:[255,0,0],alpha:1},{pos:.5,color:[0,255,0],alpha:1},{pos:1,color:[0,0,255],alpha:1}],isCyclic:!1};x.forEach(v=>{e.save(),e.strokeStyle=o.uiIcon,e.fillStyle=o.uiIcon,e.lineWidth=Ln;const T={vertexState:"none",edgeState:"none",faceState:"none",faceColor:o.uiIcon,edgeColor:o.uiIcon,vertexColor:o.uiIcon};if(v.group==="edge"){const w={...T,edgeState:"solid",edgeWeightExpression:f,angleDisplayMode:m};v.mode==="inherit_vertices"&&(w.vertexState="filled",w.vertexColors=S,w.edgeVertexColors=S),v.mode==="colormap"&&(w.edgeColormapItem=C,w.edgeExpression=y,w.edgeColormapEdges=null);const I=M.includes(v.mode);qo(e,v,w,o,I)}else if(v.group==="face"){const w={...T,faceState:"filled",vertexWeightExpression:u,edgeWeightExpression:p,angleDisplayMode:m};v.mode==="inherit_vertices"&&(w.vertexState="filled",w.faceVertexColors=S,w.vertexColors=S,w.edgeVertexColors=S),v.mode==="inherit_edges"&&(w.edgeState="solid",w.edgeColors=S,w.faceEdgeColors=S),v.mode==="colormap_xy"&&(w.faceColormapItem=C,w.faceExpression=g);const I=b.includes(v.mode);qo(e,v,w,o,I)}e.restore()})}function Cf(e,t,n,s){const i=(n?.vertices||[]).filter(C=>C&&C.type==="regular");if(!i.length){e.save(),e.fillStyle=s.uiIconDefault,e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width*.08,0,2*Math.PI),e.fill(),e.restore();return}let o=1/0,a=1/0,r=-1/0,c=-1/0;i.forEach(C=>{C.x<o&&(o=C.x),C.y<a&&(a=C.y),C.x>r&&(r=C.x),C.y>c&&(c=C.y)});const l=3,d=Math.max(t.width-l*2,1),h=Math.max(t.height-l*2,1),f=Math.max(r-o,1e-6),u=Math.max(c-a,1e-6),p=Math.min(d/f,h/u),g=(o+r)/2,y=(a+c)/2,m=t.x+t.width/2,x=t.y+t.height/2,S=C=>({x:m+(C.x-g)*p,y:x+(C.y-y)*p}),M=n?.edges||[],b=n?.faces||[],E=new Map(i.map(C=>[C.id,C]));e.save(),e.lineWidth=1,b.length>0&&(e.fillStyle=s.uiIconDefault,e.globalAlpha=.2,b.forEach(C=>{const v=(C.vertexIds||[]).map(w=>E.get(w)).filter(Boolean);if(v.length<3)return;e.beginPath();const T=S(v[0]);e.moveTo(T.x,T.y);for(let w=1;w<v.length;w++){const I=S(v[w]);e.lineTo(I.x,I.y)}e.closePath(),e.fill()}),e.globalAlpha=1),e.strokeStyle=s.uiIconDefault,M.forEach(C=>{const v=E.get(C.id1),T=E.get(C.id2);if(!v||!T)return;const w=S(v),I=S(T);e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(I.x,I.y),e.stroke()}),e.fillStyle=s.uiIconDefault,i.forEach(C=>{const v=S(C);e.beginPath(),e.arc(v.x,v.y,1.2,0,2*Math.PI),e.fill()}),e.restore()}function Tf(e,t){const{canvasUI:n,colors:s,sessions:i,activeSessionIndex:o,selectedSessionIndex:a}=t,r=n.removeSessionButton;r&&(e.strokeStyle=s.uiDefault,e.lineWidth=Bn,e.strokeRect(r.x,r.y,r.width,r.height),e.beginPath(),e.moveTo(r.x+an,r.y+r.height/2),e.lineTo(r.x+r.width-an,r.y+r.height/2),e.stroke()),(n.sessionIcons||[]).forEach(l=>{const d=l.index===a,h=l.index===o;e.save(),e.strokeStyle=d?s.selectionGlow:s.uiDefault,e.lineWidth=Bo,e.strokeRect(l.x,l.y,l.width,l.height),h&&!d&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Bo,e.strokeRect(l.x+2,l.y+2,l.width-4,l.height-4)),Cf(e,l,l.session?.state,s),e.restore()});const c=n.addSessionButton;c&&(e.strokeStyle=s.uiDefault,e.lineWidth=Bn,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width/2,c.y+an),e.lineTo(c.x+c.width/2,c.y+c.height-an),e.moveTo(c.x+an,c.y+c.height/2),e.lineTo(c.x+c.width-an,c.y+c.height/2),e.stroke())}function wf(e,t,{verticesVisible:n,edgesVisible:s,facesVisible:i,colorAssignments:o,allColors:a},r){const c=!n&&!s&&!i,l={vertexState:n||c?"filled":"hidden",edgeState:s||c?"solid":"hidden",faceState:i||c?"filled":"hidden",showAllDisabled:c},d=o[et];if(d!==-1){const u=a[d];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=r.vertex;const h=o[tt];if(h!==-1){const u=a[h];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=r.edge;const f=o[at];if(f!==-1){const u=a[f];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=r.face;qo(e,t,l,r)}function Ro(e){const t={x:e.x+e.width/2,y:e.y+e.height/2},s=26*(e.width/Eo),i=s*Math.sqrt(3)/2,o=[{x:t.x,y:t.y-i/1.5},{x:t.x-s/2,y:t.y+i/3},{x:t.x+s/2,y:t.y+i/3}],a=new Path2D;a.moveTo(o[0].x,o[0].y),a.lineTo(o[1].x,o[1].y),a.lineTo(o[2].x,o[2].y),a.closePath();const r=Math.min(o[0].x,o[1].x,o[2].x),c=Math.max(o[0].x,o[1].x,o[2].x),l=Math.min(o[0].y,o[1].y,o[2].y),d=Math.max(o[0].y,o[1].y,o[2].y);return{vertices:o,facePath:a,bounds:{x:r,y:l,w:c-r,h:d-l}}}function qo(e,t,n,s,i=!1){const{vertexState:o="none",edgeState:a="none",faceState:r="none",faceColor:c,edgeColor:l,vertexColor:d,vertexColors:h,edgeVertexColors:f,edgeColors:u,faceColormapItem:p,faceExpression:g,faceVertexColors:y,faceEdgeColors:m,vertexWeightExpression:x,edgeWeightExpression:S,edgeColormapItem:M,edgeExpression:b,edgeColormapEdges:E,angleDisplayMode:C="degrees",showAllDisabled:v=!1}=n;e.save();const{vertices:T,facePath:w}=Ro(t),I=D=>D?Array.isArray(D)?{r:D[0],g:D[1],b:D[2],a:1}:jn(D):{r:0,g:0,b:0,a:1},P=(D,O)=>{const X=O.reduce((N,k)=>N+k,0)||1;let F=0,V=0,$=0,R=0;return D.forEach((N,k)=>{const Y=O[k]/X;F+=Y*N.r,V+=Y*N.g,$+=Y*N.b,R+=Y*N.a}),{r:F,g:V,b:$,a:R}},L=(D,O,X,F,V)=>{const $=Math.max(1,Math.ceil(O.w)),R=Math.max(1,Math.ceil(O.h)),N=document.createElement("canvas");N.width=$,N.height=R;const k=N.getContext("2d"),Y=k.createImageData($,R),B=Y.data,G=D[0],W=D[1],z=D[2],K=(W.y-z.y)*(G.x-z.x)+(z.x-W.x)*(G.y-z.y),H=F.map(I),q=[[G,W],[W,z],[z,G]];for(let se=0;se<R;se++)for(let fe=0;fe<$;fe++){const ae=O.x+fe+.5,ne=O.y+se+.5,Z=((W.y-z.y)*(ae-z.x)+(z.x-W.x)*(ne-z.y))/K,Q=((z.y-G.y)*(ae-z.x)+(G.x-z.x)*(ne-z.y))/K,ee=1-Z-Q,ce=(se*$+fe)*4;if(Z>=-.001&&Q>=-.001&&ee>=-.001){let de;if(X==="vertices")if(V){const ve=D.map(Se=>{const Me=ae-Se.x,Ze=ne-Se.y,lt=Math.hypot(Me,Ze),Pn=Math.atan2(Ze,Me),qs=C==="degrees"?(Pn*180/Math.PI+360)%360:(Pn+Ne)%Ne;return ut(V,{x:Me,y:Ze,r:lt,a:qs},1)});de=P(H,ve)}else de={r:Z*H[0].r+Q*H[1].r+ee*H[2].r,g:Z*H[0].g+Q*H[1].g+ee*H[2].g,b:Z*H[0].b+Q*H[1].b+ee*H[2].b,a:Z*H[0].a+Q*H[1].a+ee*H[2].a};else{const ve=q.map(Se=>{const Me=Lt({x:ae,y:ne},Se[0],Se[1]);return V?ut(V,{x:0,y:0,r:Me.distance,a:0},1):1/Math.max(Me.distance,1e-4)});de=P(H,ve)}B[ce]=Math.round(de.r),B[ce+1]=Math.round(de.g),B[ce+2]=Math.round(de.b),B[ce+3]=Math.round((de.a??1)*255)}else B[ce+3]=0}k.putImageData(Y,0,0),e.drawImage(N,O.x,O.y)},A=(D,O,X,F)=>{const V=Math.max(1,Math.ceil(O.w)),$=Math.max(1,Math.ceil(O.h)),R=document.createElement("canvas");R.width=V,R.height=$;const N=R.getContext("2d"),k=N.createImageData(V,$),Y=k.data,B=D[0],G=D[1],W=D[2],z=(G.y-W.y)*(B.x-W.x)+(W.x-G.x)*(B.y-W.y),K={x:(B.x+G.x+W.x)/3,y:(B.y+G.y+W.y)/3},q=(Math.hypot(G.x-B.x,G.y-B.y)||1)/2;for(let se=0;se<$;se++)for(let fe=0;fe<V;fe++){const ae=O.x+fe+.5,ne=O.y+se+.5,Z=((G.y-W.y)*(ae-W.x)+(W.x-G.x)*(ne-W.y))/z,Q=((W.y-B.y)*(ae-W.x)+(B.x-W.x)*(ne-W.y))/z,ee=1-Z-Q,ce=(se*V+fe)*4;if(Z>=-.001&&Q>=-.001&&ee>=-.001){const de=(ae-K.x)/q,ve=(ne-K.y)/q,Se=Math.hypot(de,ve),Me=Math.atan2(ve,de),Ze=C==="degrees"?(Me*180/Math.PI+360)%360:(Me+Ne)%Ne,lt=ut(F,{x:de,y:ve,r:Se,a:Ze},0),Pn=Ge(X,lt),qs=jn(Pn)||{r:0,g:0,b:0,a:1};Y[ce]=Math.round(qs.r),Y[ce+1]=Math.round(qs.g),Y[ce+2]=Math.round(qs.b),Y[ce+3]=Math.round((qs.a??1)*255)}else Y[ce+3]=0}N.putImageData(k,0,0),e.drawImage(R,O.x,O.y)};if(r==="filled"){let D=!1;if(p&&p.type==="colormap"&&g){const{bounds:O}=Ro(t);A(T,O,p,g),D=!0}else if(p&&p.type==="colormap"){const O=e.createLinearGradient(T[1].x,0,T[2].x,0);p.vertices.forEach(X=>{const F=X.color,V=X.alpha!==void 0?X.alpha:1,$=`rgba(${F.join(",")},${V})`;O.addColorStop(X.pos,$)}),e.fillStyle=O}else if(y&&y.length>=3){const{bounds:O}=Ro(t);L(T,O,"vertices",y,x),D=!0}else if(m&&m.length>=3){const{bounds:O}=Ro(t);L(T,O,"edges",m,S),D=!0}else e.fillStyle=c||s.face;D||e.fill(w)}else r==="disabled"&&(e.fillStyle=Bd,e.fill(w));(a==="solid"||a==="disabled")&&(e.lineWidth=Ln,e.setLineDash([]),[[0,1],[1,2],[2,0]].forEach((O,X)=>{const[F,V]=O,$=T[F],R=T[V];if(u&&u.length>=3)e.strokeStyle=u[X];else if(f&&f.length>=3&&S){const N=e.createLinearGradient($.x,$.y,R.x,R.y),k=5,Y=re($,R)||1;for(let B=0;B<k;B++){const G=B/(k-1),W=G*Y,z=(1-G)*Y,K=W/Y,H=z/Y,q=ut(S,{x:0,y:0,r:K,a:0},1),se=ut(S,{x:0,y:0,r:H,a:0},1),fe=P([I(f[F]),I(f[V])],[q,se]);N.addColorStop(G,`rgba(${Math.round(fe.r)},${Math.round(fe.g)},${Math.round(fe.b)},${fe.a??1})`)}e.strokeStyle=N}else if(M&&M.type==="colormap"&&a==="solid"){const N=b&&b.trim()?b:"x",k=!E||E.includes(X),Y=e.createLinearGradient($.x,$.y,R.x,R.y),B=k?5:2;for(let G=0;G<B;G++){const W=B===1?.5:G/(B-1),z=k?ut(N,{x:W},W):W,K=Ge(M,z);Y.addColorStop(W,K)}e.strokeStyle=Y}else if(f&&f.length>=3){const N=e.createLinearGradient($.x,$.y,R.x,R.y);N.addColorStop(0,f[F]),N.addColorStop(1,f[V]),e.strokeStyle=N}else a==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||s.edge;e.beginPath(),e.moveTo($.x,$.y),e.lineTo(R.x,R.y),e.stroke()})),(o==="filled"||o==="disabled")&&(e.lineWidth=Ln,T.forEach((D,O)=>{let X=h&&h[O]||d||s.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&o==="filled"){const V=T.length>1?O/(T.length-1):.5;X=Ge(n.vertexColormapItem,V)}o==="disabled"&&(X="#808080");const F=new Path2D;F.moveTo(D.x+zn*2,D.y),F.arc(D.x,D.y,zn*2,0,2*Math.PI),e.fillStyle=X,e.setLineDash([]),e.fill(F)})),v?(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(o==="disabled"||a==="disabled"||r==="disabled")&&(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),i&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Bn,e.setLineDash([]),e.strokeRect(t.x-2,t.y-2,t.width+4,t.height+4)),e.restore()}function Pf(e,t,n,s,i=!1){e.save();const o={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(o.x,o.y);const a=t.width/Eo;e.scale(a,a),e.translate(-16,-16);let r=n.textColor||s.uiTextDefault;if(n.faceColorForContrast){const c=jn(n.faceColorForContrast);r=(.2126*c.r+.7152*c.g+.0722*c.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=r,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function Vi(e,t,n,s,i,o,a,r,c,l,d,h={}){if(!t||t.length<3)return;e.save(),e.beginPath(),t.forEach((I,P)=>{P===0?e.moveTo(I.x,I.y):e.lineTo(I.x,I.y)}),e.closePath(),l&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(I=>{const P=r.find(L=>L.id===I);if(P){const L=P.vertexIds.map(A=>c(A)).filter(A=>A&&A.type==="regular");if(L.length>=3){const _=(d?gs(L,d,!0,i):L).map(D=>i(D));e.moveTo(_[0].x,_[0].y),_.slice(1).forEach(D=>{e.lineTo(D.x,D.y)}),e.closePath()}}});const{faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x",edgeWeightExpression:m="r",faceVertexWeightExpression:x="1/(r+0.001)",faceEdgeWeightExpression:S="1/(r+0.001)",angleDisplayMode:M="degrees"}=h,b=Ko(n,f),E=n?.vertexIds?n.vertexIds.map(I=>c(I)).filter(Boolean):[],C=I=>I?.color||s.face,v=ht(s.face,{r:255,g:255,b:255,a:1}),T=(I,P,L)=>{const A=e.createPattern(I,"no-repeat"),_=i(P.origin),D=Mn({x:1,y:0},P),O=Mn({x:0,y:1},P),X=i(D),F=i(O),V=X.x-_.x,$=X.y-_.y,R=F.x-_.x,N=F.y-_.y,k=I.width,Y=Math.max(L?.width||0,1e-6),B=Math.max(L?.height||0,1e-6),G=Y/(k-1),W=B/(k-1),z=V*G,K=$*G,H=R*W,q=N*W,se={x:L?.minX||0,y:L?.minY||0},fe=Mn(se,P),ae=i(fe),ne=ae.x,Z=ae.y,Q=new DOMMatrix([z,K,H,q,ne,Z]);return A.setTransform(Q),A},w=(I,P)=>{const A=document.createElement("canvas");A.width=64,A.height=64;const _=A.getContext("2d"),D=_.createImageData(64,64),O=D.data,X=1/63,F=E.filter(q=>q.type==="regular"),V=F.map(q=>Ao(q,P));let $=1/0,R=1/0,N=-1/0,k=-1/0,Y=1;V.forEach(q=>{!Number.isFinite(q.x)||!Number.isFinite(q.y)||($=Math.min($,q.x),R=Math.min(R,q.y),N=Math.max(N,q.x),k=Math.max(k,q.y),Y=Math.max(Y,Math.hypot(q.x,q.y)))}),(!Number.isFinite($)||!Number.isFinite(R)||!Number.isFinite(N)||!Number.isFinite(k))&&($=-1,R=-1,N=1,k=1);const B={minX:$,minY:R,width:Math.max(N-$,1e-6),height:Math.max(k-R,1e-6),maxRadius:Math.max(Y,1e-6)},G=F.map(q=>ht(C(q),v)),W=q=>({x:(q.x-$)/B.width,y:(q.y-R)/B.height}),z=V.map(W),K=[];if(n?.vertexIds&&n.vertexIds.length>1)for(let q=0;q<n.vertexIds.length;q++){const se=n.vertexIds[q],fe=n.vertexIds[(q+1)%n.vertexIds.length],ae=a?.find(Q=>Q.id1===se&&Q.id2===fe||Q.id1===fe&&Q.id2===se)||{id1:se,id2:fe},ne=c(ae.id1),Z=c(ae.id2);ne&&Z&&K.push({edge:ae,mode:ds(ae,u),v1:ne,v2:Z,v1Local:Ao(ne,P),v2Local:Ao(Z,P),v1Norm:W(Ao(ne,P)),v2Norm:W(Ao(Z,P))})}const H=(q,se)=>{const{edge:fe,v1:ae,v2:ne,mode:Z}=q;if(Z==="inherit_vertices"&&ae&&ne){const Q=ht(C(ae),v),ee=ht(C(ne),v),ce=fe.weightExpression||m,de=re(ae,ne)||1,ve=se*de,Se=(1-se)*de,Me=ve/de,Ze=Se/de,lt=ut(ce,{x:0,y:0,r:Me,a:0},1),Pn=ut(ce,{x:0,y:0,r:Ze,a:0},1);return io([Q,ee],[lt,Pn])}if(Z==="colormap"&&fe.colormapItem){const Q=fe.colorExpression||y,ee=ut(Q,{x:se},se),ce=Ge(fe.colormapItem,ee);return ht(ce,v)}return ht(fe.color||s.edge,v)};for(let q=0;q<64;q++)for(let se=0;se<64;se++){const fe=B.minX+se*X*B.width,ae=B.minY+q*X*B.height,ne=_a((fe-B.minX)/B.width),Z=_a((ae-B.minY)/B.height);let Q=v;if(I==="colormap_xy"||I==="colormap_polar")if(n?.colormapItem){const ce=Math.hypot(fe,ae);let de=Math.atan2(ae,fe);de<0&&(de+=Ne);const ve=M==="degrees"?de*(180/Math.PI):de,Se=n?.colorExpression||p||g||"x",Me=ut(Se,{x:ne,y:Z,r:ce,a:ve},ne);if(Array.isArray(n.colormapItem.vertices)&&n.colormapItem.vertices.length===1){const lt=Ge(n.colormapItem,0);Q=ht(lt,v)}else if(n.colormapItem.isCyclic){const lt=Ge(n.colormapItem,Me);Q=ht(lt,v)}else if(Me<0)Q={...v,a:0};else if(Me>1){const lt=Ge(n.colormapItem,1);Q=ht(lt,v)}else{const lt=Ge(n.colormapItem,Me);Q=ht(lt,v)}}else Q=v;else if(I==="inherit_vertices"&&V.length>0){const ce=n.vertexWeightExpression||x,de=z.map(ve=>{const Se=ne-ve.x,Me=Z-ve.y,Ze=Math.hypot(Se,Me),lt=Math.atan2(Me,Se),Pn=M==="degrees"?(lt*180/Math.PI+360)%360:(lt+Ne)%Ne;return ut(ce,{x:Se,y:Me,r:Ze,a:Pn},1)});Q=io(G,de)}else if(I==="inherit_edges"&&K.length>0){const ce=n.edgeWeightExpression||S,de=K.map(Se=>{const Me=Lt({x:ne,y:Z},Se.v1Norm,Se.v2Norm);return ut(ce,{x:0,y:0,r:Me.distance,a:0},1)}),ve=K.map(Se=>{const Me=Lt({x:ne,y:Z},Se.v1Norm,Se.v2Norm);return H(Se,Me.t)});Q=io(ve,de)}const ee=(q*64+se)*4;O[ee]=Math.round(Q.r),O[ee+1]=Math.round(Q.g),O[ee+2]=Math.round(Q.b),O[ee+3]=Math.round(_a(Q.a)*255)}return _.putImageData(D,0,0),{canvas:A,bounds:B}};if(b==="fixed")e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");else if(n.localCoordSystem){const I=w(b,n.localCoordSystem),P=T(I.canvas,n.localCoordSystem,I.bounds);e.fillStyle=P||n?.color||s.face,e.fill(l?"evenodd":"nonzero")}else n?.colormapItem&&n.localCoordSystem,e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");e.restore()}function Af(e,t,n,s,i,o){const{angleDisplayMode:a,distanceDisplayMode:r,colors:c}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":nc(e,l,a,a!==zo,s,i,c);break;case"distances":sc(e,l,r,r===Ho,s,i,c);break}}function _f(e,t,n,s){const{canvasUI:i,colorAssignments:o,allColors:a,colors:r}=n,c=l=>{if(!o||!a)return r.uiIcon;const d=o[l];if(d===-1)return Qs;const h=a[d];return h&&h.type==="color"?h.value:r.uiIcon};c(et),c(tt),c(at),i.visibilityIcons.forEach(l=>{Af(e,l,n,t,s)})}function oc(e,t,n,s){const i={x:t.x+t.width*.22,y:t.y+t.height*.78},o={x:t.x+t.width*.22,y:t.y+t.height*.22},a={x:t.x+t.width*.78,y:t.y+t.height*.22},r=[i,o,a],l=!s||s.type==="linear"?r:gs(r,s,!1,null),d=(h,f)=>{const u=Math.atan2(f.y-h.y,f.x-h.x),p=t.width*.08,g={x:f.x-Math.cos(u)*p+Math.cos(u+Math.PI/2)*p*.6,y:f.y-Math.sin(u)*p+Math.sin(u+Math.PI/2)*p*.6},y={x:f.x-Math.cos(u)*p+Math.cos(u-Math.PI/2)*p*.6,y:f.y-Math.sin(u)*p+Math.sin(u-Math.PI/2)*p*.6};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(g.x,g.y),e.lineTo(y.x,y.y),e.closePath(),e.fill()};e.save(),e.strokeStyle=n.uiIcon,e.lineWidth=cr,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let h=1;h<l.length;h++)e.lineTo(l[h].x,l[h].y);e.stroke(),e.fillStyle=n.uiIcon,r.forEach(h=>{e.beginPath(),e.arc(h.x,h.y,zn+.5,0,Math.PI*2),e.fill()}),s?.linearStyle==="arrows"&&(d(i,o),d(o,a)),e.restore()}function Df(e,t,n,s){const{canvasUI:i,colors:o,activeInterpolationStyleId:a,selectedInterpolationStyleId:r,interpolationStyles:c}=n;i.interpolationIcons.forEach(l=>{const d={x:l.x,y:l.y,width:l.width,height:l.height};if(l.type==="interpolationStyle"){const h=l.styleId===(r||a);e.strokeStyle=o.uiDefault,e.lineWidth=Bo,e.strokeRect(d.x,d.y,d.width,d.height),h&&(e.strokeStyle=o.selectionGlow,e.lineWidth=Bn,e.strokeRect(d.x-2,d.y-2,d.width+4,d.height+4));const f=c.find(p=>p.id===l.styleId);oc(e,d,o,f);const u=f?.name||"";u&&u.toLowerCase()!=="linear"&&s({id:`interpolation-label-${l.styleId}`,content:u.length>6?`${u.slice(0,6)}...`:u,x:d.x+d.width/2,y:d.y+d.height+10,color:o.uiTextDefault,fontSize:dr,options:{textAlign:"center",textBaseline:"top"}},t)}else l.type==="interpolationRemove"?(e.strokeStyle=o.uiDefault,e.lineWidth=Bo,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.strokeStyle=o.uiIcon,e.lineWidth=cr,e.stroke()):l.type==="interpolationAdd"&&(e.strokeStyle=o.uiDefault,e.lineWidth=Bo,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width/2,d.y+d.height*.25),e.lineTo(d.x+d.width/2,d.y+d.height*.75),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.stroke())})}function kf(e,t,n,s){const{canvasUI:i,colors:o,activeThemeName:a,colorAssignments:r,allColors:c,verticesVisible:l,edgesVisible:d,facesVisible:h}=n,f=i.toolbarButton;e.strokeStyle=o.uiDefault,e.lineWidth=Bl,e.beginPath();for(let b=0;b<3;b++){const E=f.y+5+b*10;e.moveTo(f.x+4,E),e.lineTo(f.x+f.width-4,E)}e.stroke();const u=i.colorToolButton;u&&wf(e,u,{verticesVisible:l,edgesVisible:d,facesVisible:h,colorAssignments:r,allColors:c},o);const p=i.colorModeToolButton;if(p){const b=p,E={x:b.x,y:b.y,width:b.width,height:b.height};(v=>{const{vertices:T}=Ro(v),w=[[T[0],T[1]],[T[1],T[2]],[T[2],T[0]]],I=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"];w.forEach((P,L)=>{e.strokeStyle=I[L],e.lineWidth=2,e.beginPath(),e.moveTo(P[0].x,P[0].y),e.lineTo(P[1].x,P[1].y),e.stroke()})})(E),e.fillStyle="#ffffff",qo(e,E,{edgeState:"none",faceState:"filled",vertexState:"none",faceColor:"#ffffff"},o)}const g=i.transformToolButton;g&&s({id:"transform-tool-label",content:Kd,x:g.x+g.width/2,y:g.y+g.height/2,color:o.uiIcon,fontSize:Hd,options:{textAlign:"center",textBaseline:"middle"}},t);const y=i.interpolationToolButton;y&&oc(e,y,o);const m=i.displayToolButton;if(m){e.strokeStyle=o.uiDefault,e.fillStyle=o.uiDefault,e.lineWidth=cr;const b=m.width-qd;for(let E=0;E<3;E++){const C=m.y+jd+E*Ud;e.beginPath(),e.moveTo(m.x+6,C),e.lineTo(m.x+6+b,C),e.stroke(),e.beginPath(),e.arc(m.x+6+b*(E/2),C,Jd,0,2*Math.PI),e.fill()}}const x=i.visibilityToolButton;x&&vf(e,x,o);const S=i.sessionsToolButton;if(S){e.save(),e.strokeStyle=o.uiDefault,e.lineWidth=Ln;const b=6,E=Math.min(S.width,S.height)-b*2,C=S.x+b,v=S.y+b;e.strokeRect(C+4,v+2,E,E),e.strokeRect(C,v+6,E,E),e.restore()}const M=i.themeToggleButton;M&&tc(e,M,a,o)}function Rf(e,t){const{canvasUI:n,colors:s}=t;n.transformIcons.forEach(i=>{ha(e,i,s)})}function Lf(e,t,n,s){const{canvasUI:i,colors:o,coordsDisplayMode:a,gridDisplayMode:r,angleDisplayMode:c,distanceDisplayMode:l,activeThemeName:d}=n;i.displayIcons.forEach(h=>{const f={x:h.x,y:h.y,width:h.width,height:h.height};switch(h.group){case"coords":If(e,f,a,a!==aa,t,s,o);break;case"grid":bf(e,f,r,r!==ei,o);break;case"angles":nc(e,f,c,c!==zo,t,s,o);break;case"distances":sc(e,f,l,l===Ho,t,s,o);break;case"theme":tc(e,f,d,o);break}})}function Nf(e,t,n,s){const{dpr:i,isToolbarExpanded:o,isColorPaletteExpanded:a,isColorModePanelExpanded:r,isInterpolationPanelExpanded:c,isTransformPanelExpanded:l,isDisplayPanelExpanded:d,isVisibilityPanelExpanded:h,isSessionsPanelExpanded:f,isPlacingTransform:u,placingTransformType:p,placingSnapPos:g,mousePos:y,colors:m}=n;if(e.save(),e.resetTransform(),e.scale(i,i),o)kf(e,t,n,s);else{const x=n.canvasUI.toolbarButton;e.strokeStyle=m.uiDefault,e.lineWidth=Bl,e.beginPath();for(let S=0;S<3;S++){const M=x.y+5+S*10;e.moveTo(x.x+4,M),e.lineTo(x.x+x.width-4,M)}e.stroke()}if(a&&Mf(e,t,n),r&&Ef(e,t,n),c&&Df(e,t,n,s),l&&Rf(e,n),d&&Lf(e,t,n,s),h&&_f(e,t,n,s),f&&Tf(e,n),u){const x=g||y;if(x){const S=Ea/2,M={type:p,x:x.x-S,y:x.y-S,width:Ea,height:Ea};ha(e,M,m)}}e.restore()}function Ml(e,t,n,s,{showDistances:i,distanceSigFigs:o,colors:a,lastGridState:r,currentShiftPressed:c},l,d,h,f,u=null,p=null,g=null){!i||n.length===0||n.forEach(y=>{const m=s.find(x=>d(x)===y);if(m){let x=l(m.id1),S=l(m.id2);if(u){const M=u.find(E=>E.id===m.id1),b=u.find(E=>E.id===m.id2);M&&(x=M),b&&(S=b)}if(x&&S&&x.type==="regular"&&S.type==="regular"){let M;const b=u&&g;if(m.labelMode==="exact"&&m.exactValue){const[_,D]=_s(m.exactValue.g2gSquaredSum);let O=m.exactValue.gridInterval*_;if(b&&g.transformType!==mn){const X=g.snappedScaleValue!==null?g.snappedScaleValue:g.scale;O*=X}M=Ds(parseFloat(O.toFixed(10)),D)}else M=It(re(x,S),o);const E=h(x),C=h(S),v=(E.x+C.x)/2,T=(E.y+C.y)/2,w=Math.atan2(C.y-E.y,C.x-E.x);let I=w-Math.PI/2;Math.sin(I)>0&&(I+=Math.PI);const P=v+Math.cos(I)*rs,L=T+Math.sin(I)*rs;let A=w*(180/Math.PI);(A>90||A<-90)&&(A+=180),f({id:`selected-edge-dist-${y}`,content:M,x:P,y:L,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:bn,options:{rotation:A}})}}})}function Of(e,t,n,s){e.save(),e.strokeStyle=s.mouseCoords,e.lineWidth=gn,e.setLineDash(Wn);const i=Math.min(t.x,n.x),o=Math.min(t.y,n.y),a=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);e.strokeRect(i,o,a,r),e.restore()}function Vo(e,t,n,s,{lastGridState:i,showDistances:o,showAngles:a,distanceSigFigs:r,angleDisplayMode:c,angleSigFigs:l,currentShiftPressed:d,viewTransform:h,colors:f},u,p,g,y=!1,m=null,x=null,S=[],M=!1,b=[],E=null,C=new Map){const v=y?f.feedbackSnapped:`rgba(${f.feedbackDefault.join(",")}, 1.0)`,T=new Map(s.map(V=>[V.id,{...V}])),w=V=>T.get(V),I=w(n);if(!I)return;const P=p(I.id).map(w).filter(Boolean),L=u(I),A=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,D=(C.get(n)||[]).find(V=>V.type==="projection"&&V.projectionLine);if(D){const[V,$]=D.projectionLine,R=u(V),N=u($),k={x:N.x-R.x,y:N.y-R.y},Y=Math.hypot(k.x,k.y);if(Y>0){const B={x:k.x/Y,y:k.y/Y},G=1e4,W={x:R.x-B.x*G,y:R.y-B.y*G},z={x:R.x+B.x*G,y:R.y+B.y*G};e.save(),e.strokeStyle=v,e.lineWidth=gn,e.setLineDash(Nl),e.beginPath(),e.moveTo(W.x,W.y),e.lineTo(z.x,z.y),e.stroke(),e.restore()}}const O=(V,$)=>{if(!V||!$||$<=0)return!1;const R=$*1e-6,N=Math.abs(V.x/$-Math.round(V.x/$))<R,k=Math.abs(V.y/$-Math.round(V.y/$))<R;return N&&k},X=P.every(V=>S.includes(V.id)),F=b.find(V=>V.id===n);if(!E&&M&&d&&X&&F&&re(F,I)>xe){const V=u(F),$=L,R=Math.atan2($.y-V.y,$.x-V.x),N=Math.atan2(I.y-F.y,I.x-F.x);if(o){let k;const Y=A&&O(F,A),B=A&&O(I,A);if(Y&&B){const se=I.x-F.x,fe=I.y-F.y,ae=Math.round(se/A),ne=Math.round(fe/A),Z=ae*ae+ne*ne;if(Z===0)k="0";else{const[Q,ee]=_s(Z),ce=A*Q,de=parseFloat(ce.toFixed(10));k=Ds(de,ee)}}else{const se=r+2;k=It(re(F,I),se)}const G=(V.x+$.x)/2,W=(V.y+$.y)/2;let z;a&&Math.abs(N)>xe?-N<0?z=R-Math.PI/2:z=R+Math.PI/2:(z=R-Math.PI/2,Math.sin(z)>0&&(z+=Math.PI));const K=G+Math.cos(z)*rs,H=W+Math.sin(z)*rs;let q=R*(180/Math.PI);(q>90||q<-90)&&(q+=180),x({id:`drag-dist-vector-${I.id}`,content:k,x:K,y:H,color:v,fontSize:bn,options:{rotation:q}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=v,e.lineWidth=gn,e.beginPath(),e.moveTo(V.x,V.y),e.lineTo($.x,$.y),e.stroke(),e.restore(),a&&Math.abs(R)>xe){Er(e,V,0,N,uo,v);let k;if(c===Ns?k=`${It(N*(180/Math.PI),l)}^{\\circ}`:k=It(N,l),k){const Y=-N/2,B=Li,G={x:B*Math.cos(Y),y:B*Math.sin(Y)},W={x:V.x+G.x,y:V.y+G.y};let z=Y*(180/Math.PI);(z>90||z<-90)&&(z+=180),x({id:`drag-angle-vector-${I.id}`,content:k,x:W.x,y:W.y,color:v,fontSize:bn,options:{rotation:z}},t)}}}if(o&&P.forEach(V=>{const $=S.includes(V.id);if(!M||!$){const R=I,N=V,k=g({id1:R.id,id2:N.id});let Y;if(A&&O(R,A)&&O(N,A)){const ne=R.x-N.x,Z=R.y-N.y,Q=Math.round(ne/A),ee=Math.round(Z/A),ce=Q*Q+ee*ee;if(ce===0)Y="0";else{const[de,ve]=_s(ce),Se=A*de,Me=parseFloat(Se.toFixed(10));Y=Ds(Me,ve)}}else{const ne=re(R,N);Y=It(ne,r)}const G=u(R),W=u(N),z=(G.x+W.x)/2,K=(G.y+W.y)/2,H=Math.atan2(W.y-G.y,W.x-G.x);let q=H-Math.PI/2;Math.sin(q)>0&&(q+=Math.PI);const se=z+Math.cos(q)*rs,fe=K+Math.sin(q)*rs;let ae=H*(180/Math.PI);(ae>90||ae<-90)&&(ae+=180),x({id:`drag-dist-${k}`,content:Y,x:se,y:fe,color:v,fontSize:bn,options:{rotation:ae}})}}),a&&P.length>=2&&(!M||P.some(V=>!S.includes(V.id)))){const V=[...P].sort(($,R)=>{const N=Math.atan2($.y-I.y,$.x-I.x),k=Math.atan2(R.y-I.y,R.x-I.x);return N-k});for(let $=0;$<V.length;$++){const R=V[$],N=V[($+1)%V.length],k=S.includes(R.id),Y=S.includes(N.id);if(!(!M||!k||!Y))continue;const G={x:R.x-I.x,y:R.y-I.y},W={x:N.x-I.x,y:N.y-I.y},z=Math.atan2(G.y,G.x),K=Math.atan2(W.y,W.x);let H=K-z;if(H<0&&(H+=2*Math.PI),H<xe)continue;const q=z+H/2;e.save(),e.strokeStyle=v,e.lineWidth=gn,e.beginPath(),e.arc(L.x,L.y,uo,-z,-K,!1),e.stroke(),e.restore();let se;if(c===Ns?se=`${It(H*(180/Math.PI),l)}^{\\circ}`:c===ti&&(d?(se=fn(H/Math.PI,.015,32)+"\\pi",se.startsWith("1\\pi")&&(se="\\pi"),se.startsWith("-1\\pi")&&(se="-\\pi"),se==="0\\pi"&&(se="0")):se=It(H,l)),se){const fe=`drag-angle-${I.id}-${R.id}-${N.id}`,ae={x:I.x+Math.cos(q),y:I.y+Math.sin(q)},ne=u(ae),Z=Math.atan2(ne.y-L.y,ne.x-L.x),Q=Li,ee={x:Q*Math.cos(Z),y:Q*Math.sin(Z)},ce={x:L.x+ee.x,y:L.y+ee.y};let de=Z*(180/Math.PI);(de>90||de<-90)&&(de+=180),x({id:fe,content:se,x:ce.x,y:ce.y,color:v,fontSize:bn,options:{rotation:de}},t)}}}}function Ff(e,t,n,s,{showAngles:i,angleSigFigs:o,angleDisplayMode:a,currentShiftPressed:r,distanceSigFigs:c,viewTransform:l,lastGridState:d,colors:h},f,u,p,g,y){!i||n.length===0||n.forEach(m=>{const x=s.find(S=>u(S)===m);if(x){const S=f(x.id1),M=f(x.id2);if(S&&M&&S.type==="regular"&&M.type==="regular"){const b={lastGridState:d,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:o,currentShiftPressed:r,viewTransform:l,colors:h};Vo(e,t,S.id,[S,M],b,p,g,u,!1,null,y),Vo(e,t,M.id,[S,M],b,p,g,u,!1,null,y)}}})}function ic(e,{allFaces:t,selectedFaceIds:n,colors:s,isDragConfirmed:i,dragPreviewVertices:o,initialDragVertexStates:a,transformIndicatorData:r,highlightedEdgeForSnap:c,draggedFaceId:l,coordSystemSnapAngle:d,coordSystemSnapType:h,coordSystemSnapScale:f,initialCoordSystemStates:u},p,g){if(n.length>oh)return;const y=new Set(n);y.size!==0&&y.forEach(m=>{const x=t.find(M=>M.id===m);if(!x||!x.localCoordSystem)return;let S=x.localCoordSystem;if(i&&x.vertexIds.some(M=>o.some(b=>b.id===M))){const M=u.get(x.id);S=vr(x,{initialSystem:M,dragPreviewVertices:o,initialDragVertexStates:a,findVertexById:g,transformIndicatorData:r})}if(l===m&&d!==null){const M=E=>{if(i&&o){const C=o.find(v=>v&&v.id===E);if(C)return C}return g(E)},b=p(S.origin);if(h==="edge"&&c!==null){const E=x.vertexIds.map(C=>M(C)).filter(C=>C&&C.type==="regular");if(c<E.length){const C=E[c],v=E[(c+1)%E.length],T=p(C),w=p(v);e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(w.x,w.y),e.stroke(),e.restore()}}else if(h==="cardinal"){const C=b.x+Math.cos(-d)*100,v=b.y+Math.sin(-d)*100,T=b.x-Math.cos(-d)*100,w=b.y-Math.sin(-d)*100;e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(T,w),e.lineTo(C,v),e.stroke(),e.restore()}}Bf(e,S,s,p,f)})}function Bf(e,t,n,s,i=null){const o=s(t.origin),a=Mn({x:1,y:0},t),r=Mn({x:0,y:1},t),c=s(a),l=s(r);e.save(),e.lineWidth=us,e.lineCap="round";const d=(u,p,g,y)=>{e.strokeStyle=g,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(p.x,p.y),e.stroke(),e.fillStyle=y;const m=Math.atan2(p.y-u.y,p.x-u.x);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(p.x-Xe*Math.cos(m-hn),p.y-Xe*Math.sin(m-hn)),e.lineTo(p.x-Xe*Math.cos(m+hn),p.y-Xe*Math.sin(m+hn)),e.closePath(),e.fill()},h=i!==null?n.feedbackSnapped:n.coordSysX,f=i!==null?n.feedbackSnapped:n.coordSysY;d(o,c,h,h),d(o,l,f,f),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(o.x,o.y,$d,0,2*Math.PI),e.fill(),e.restore()}const $f=6,Vf=500,Xf=300,El=8;function Da(e,t){return{x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}}function Cl(e,t){const n=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.hypot(n,s)}function An(e,t,n,s,i){const{shiftKey:o,ctrlKey:a,altKey:r,metaKey:c}=i||{};return{button:n,clientX:t.clientX,clientY:t.clientY,shiftKey:!!o,ctrlKey:!!a,metaKey:!!c,altKey:!!r,target:e,preventDefault:()=>s.preventDefault(),stopPropagation:()=>s.stopPropagation()}}function Yf({canvas:e,onMouseDown:t,onMouseMove:n,onMouseUp:s,onPinchZoom:i,onPan:o,getModifiers:a,isHoverMode:r,getHoverTarget:c,getUiTargetAt:l}){let d=null,h=null,f=null,u=!1,p=!1,g=0,y=null,m=null,x=!1,S=!1,M=null,b=0;const E=()=>typeof a=="function"?a():{},C=()=>typeof r=="function"?r():!1,v=()=>typeof c=="function"?c():null,T=_=>typeof l=="function"?l(_):null,w=()=>{f&&(clearTimeout(f),f=null),u=!1},I=(_,D)=>{w(),f=setTimeout(()=>{u=!0;const O=An(e,_,2,D,E());t(O)},Vf)},P=_=>{if(!(!_.touches||_.touches.length===0)){if(_.preventDefault(),_.touches.length===1){const D=_.touches[0];if(d=D.identifier,h={x:D.clientX,y:D.clientY},m={x:D.clientX,y:D.clientY},p=!1,g=0,y=null,x=!1,S=!1,M=null,C()){const O=An(e,D,0,_,E());n(O);const X=T({x:D.clientX,y:D.clientY}),F=v();if(X||F&&F.type&&F.type!=="canvas"){const V=An(e,D,0,_,E());t(V)}else x=!0}else{I(D,_);const O=An(e,D,0,_,E());t(O)}return}if(_.touches.length===2){if(w(),S=C()&&x&&!!m,b=Date.now(),M=Da(_.touches[0],_.touches[1]),d!==null&&h){const X=_.touches[0],F=An(e,X,0,_,E());s(F)}p=!0,d=null;const[D,O]=_.touches;g=Cl(D,O),y=Da(D,O)}}},L=_=>{if(!(!_.touches||_.touches.length===0)){if(_.preventDefault(),p&&_.touches.length>=2){const[D,O]=_.touches,X=Cl(D,O),F=Da(D,O);if(S&&M){const V=Math.hypot(F.x-M.x,F.y-M.y),$=Math.abs(X-g);(V>El||$>El)&&(S=!1)}if(!S){if(g>0){const V=X/g;Number.isFinite(V)&&V!==1&&i(V,F)}if(y){const V=F.x-y.x,$=F.y-y.y;(V!==0||$!==0)&&o({x:V,y:$})}}g=X,y=F;return}if(_.touches.length===1&&d!==null){const D=_.touches[0],O=D.clientX-(h?.x??D.clientX),X=D.clientY-(h?.y??D.clientY);Math.hypot(O,X)>$f&&w(),h={x:D.clientX,y:D.clientY},m={x:D.clientX,y:D.clientY};const F=An(e,D,0,_,E());n(F)}}},A=_=>{if(_.preventDefault(),p&&_.touches.length<2&&(p=!1,g=0,y=null),S&&m){if(Date.now()-b<=Xf){const O={clientX:m.x,clientY:m.y},X=An(e,O,0,_,E()),F=An(e,O,0,_,E());t(X),s(F)}}else if(d!==null&&!C()){const D=Array.from(_.changedTouches).find(O=>O.identifier===d)||_.changedTouches[0];if(D)if(u){const O=An(e,D,2,_,E());s(O)}else{const O=An(e,D,0,_,E());s(O)}}w(),S=!1,M=null,d=_.touches.length===1?_.touches[0].identifier:null,_.touches.length===0&&(h=null,m=null)};return e.style.touchAction="none",e.addEventListener("touchstart",P,{passive:!1}),e.addEventListener("touchmove",L,{passive:!1}),e.addEventListener("touchend",A,{passive:!1}),e.addEventListener("touchcancel",A,{passive:!1}),()=>{w(),e.removeEventListener("touchstart",P),e.removeEventListener("touchmove",L),e.removeEventListener("touchend",A),e.removeEventListener("touchcancel",A)}}class Gf{constructor(){this.appMode="static",this.mode="idle",this.dragAction=null,this.selection={transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set},this.hoverTarget={type:"canvas",id:null},this.modifiers={shift:!1,ctrl:!1,alt:!1},this.marqueeRect={active:!1,startX:0,startY:0,endX:0,endY:0},this.lastClickTime=0,this.lastClickTarget={type:null,id:null},this.clickCount=0,this.selectionBeforeClick=null,this.zoomLevel=1,this.activeTransformationObjectId=null,this.lastMouseX=0,this.lastMouseY=0,this.textInput={active:!1,x:0,y:0,value:""},this.touchTimerId=null,this.initialTouchData=null}clearGeometricSelection(){this.selection.vertices.clear(),this.selection.edges.clear(),this.selection.faces.clear(),this.selection.text.clear()}clearTransformationObjectSelection(){this.selection.transformationObjects.clear(),this.activeTransformationObjectId=null}clearSelection(){this.clearGeometricSelection(),this.clearTransformationObjectSelection(),this.selection.ui.clear()}}const Wf=300,zf=500,Tl=1.1,wl=.2,Pl=5,ke={IDLE:"idle",DRAWING:"drawing",DRAGGING:"dragging",SELECTING:"selecting",TYPING:"typing"},me={VERTEX:"vertex",EDGE:"edge",FACE:"face",TEXT:"text",TRANSFORMATION_OBJECT:"transformationObject",MANIFOLD:"manifold",UI:"ui",CANVAS:"canvas"},Fn={[me.VERTEX]:"vertices",[me.EDGE]:"edges",[me.FACE]:"faces",[me.TEXT]:"text",[me.TRANSFORMATION_OBJECT]:"transformationObjects",[me.MANIFOLD]:"manifolds",[me.UI]:"ui"},Vn={PANNING:"panning",MARQUEE_SELECT:"marqueeSelect",RIGID_DRAG:"rigidDrag"};function ns(e,t,n){if(t===me.UI)return;const s=Fn[t];if(!s){console.warn(`No selection key for type: ${t}`);return}const i=e.selection[s];if(!i){console.warn(`No selection set for type: ${t} (key: ${s})`);return}const o=e.modifiers.ctrl&&!e.modifiers.shift;n.forEach(a=>{o&&i.has(a)?i.delete(a):i.add(a)})}function Hf(e,t,n){const{originalSelection:s}=e.dragAction;if(!s)return;const i=n&&n.ctrlKey,o=n&&n.shiftKey,{startX:a,startY:r,endX:c,endY:l}=e.marqueeRect,d={minX:Math.min(a,c),maxX:Math.max(a,c),minY:Math.min(r,l),maxY:Math.max(r,l)},h=t.getEntitiesInRect(d),f=new Set(s.vertices),u=new Set(s.edges),p=new Set(s.faces),g=new Set(s.text),y=new Set(s.transformationObjects),m={[Fn[me.VERTEX]]:f,[Fn[me.EDGE]]:u,[Fn[me.FACE]]:p,[Fn[me.TEXT]]:g,[Fn[me.TRANSFORMATION_OBJECT]]:y},x=i&&!o;!i&&!o?e.clearGeometricSelection():(e.selection.vertices=new Set(s.vertices),e.selection.edges=new Set(s.edges),e.selection.faces=new Set(s.faces),e.selection.text=new Set(s.text),e.selection.transformationObjects=new Set(s.transformationObjects)),h.length>0&&h.forEach(M=>{const b=Fn[M.type];if(!b||!e.selection[b])return;const E=e.selection[b],v=m[b]?.has(M.id);x&&v?E.delete(M.id):E.add(M.id)})}function Kf(e,t,n,s){if(e.mode===ke.TYPING){s.preventDefault(),s.key==="Enter"||s.key==="Escape"?(n.stopTyping(e),e.mode=ke.IDLE):s.key==="Backspace"?n.backspace(e):s.key.length===1&&n.updateText(e,s.key);return}if(s.key==="Shift"&&(e.modifiers.shift=!0),s.key==="Control"&&(e.modifiers.ctrl=!0),s.key==="Alt"&&(e.modifiers.alt=!0),e.modifiers.ctrl&&(s.key==="a"||s.key==="A")){s.preventDefault(),e.clearGeometricSelection(),document.querySelectorAll(".proxy-entity").forEach(i=>{const o=i.dataset.type,a=i.dataset.id,r=Fn[o];if(r&&o!==me.TRANSFORMATION_OBJECT&&o!==me.UI){const c=e.selection[r];c&&c.add(a)}}),e.clickCount=0,e.selectionBeforeClick=null;return}(s.key==="Escape"||s.key==="Esc")&&(e.mode=ke.IDLE,e.dragAction=null,e.clearSelection(),e.activeTransformationObjectId=null,e.marqueeRect.active=!1,e.clickCount=0,e.selectionBeforeClick=null),s.key.length===1&&!s.ctrlKey&&!s.metaKey&&(e.mode===ke.IDLE||e.mode===ke.DRAWING)&&(s.preventDefault(),e.mode=ke.TYPING,n.startTyping(e),n.updateText(e,s.key))}function qf(e,t,n,s){s.key==="Shift"&&(e.modifiers.shift=!1),s.key==="Control"&&(e.modifiers.ctrl=!1),s.key==="Alt"&&(e.modifiers.alt=!1)}function ac(e,t,n,s){let i=e.zoomLevel;s.deltaY<0?i*=Tl:s.deltaY>0&&(i/=Tl),i<wl&&(i=wl),i>Pl&&(i=Pl),e.zoomLevel=i}function rc(e,t,n,s){e.hoverTarget={type:s.type,id:s.id}}function lc(e,t,n,s){e.hoverTarget.id===s.id&&(e.hoverTarget={type:me.CANVAS,id:null})}function jf(e,t,n,s){e.appMode=s.mode}function Uf(e,t,n,s){e.mode===ke.TYPING&&(n.stopTyping(e),e.mode=ke.IDLE),s.button===0&&e.hoverTarget.type===me.CANVAS&&(e.clickCount=0,e.selectionBeforeClick=null,e.dragAction={hasMoved:!1,button:0})}function Xi(e){return e?{transformationObjects:new Set(e.transformationObjects),vertices:new Set(e.vertices),edges:new Set(e.edges),faces:new Set(e.faces),text:new Set(e.text),ui:new Set(e.ui)}:{transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set}}function cc(e,t,n,s){if(e.mode===ke.TYPING&&(n.stopTyping(e),e.mode=ke.IDLE),s.button===0){if(e.modifiers.alt){e.mode=ke.DRAWING,e.clickCount=0,e.selectionBeforeClick=null;return}const i=Date.now(),{type:o,id:a}=s,r=Fn[o];if(!r){console.warn(`Unknown entity type for selection: ${o}`);return}const c=e.selection[r],l=c&&c.has(a),d=o===me.VERTEX||o===me.EDGE||o===me.FACE||o===me.TEXT,h=o===me.TRANSFORMATION_OBJECT;if(e.lastClickTarget.id===a&&i-e.lastClickTime<Wf?e.clickCount++:(e.clickCount=1,e.selectionBeforeClick=Xi(e.selection)),e.lastClickTime=i,e.lastClickTarget={type:o,id:a},o===me.UI){e.clickCount=0,e.selectionBeforeClick=null;return}if(e.clickCount===1)e.modifiers.ctrl||e.modifiers.shift?ns(e,o,[a]):l||(d?e.clearGeometricSelection():h&&e.clearTransformationObjectSelection(),ns(e,o,[a]));else if(e.selection=Xi(e.selectionBeforeClick),d)if(e.clickCount===2){const f=t.getNeighbors(a),u={};f.forEach(p=>{const g=t.getEntityType(p);!g||g===me.UI||(u[g]||(u[g]=[]),u[g].push(p))});for(const p in u)ns(e,p,u[p]);ns(e,o,[a])}else{const f=t.getAllConnected(a),u=[];f.forEach(p=>{t.getEntityType(p)===o&&u.push(p)}),ns(e,o,u)}else h&&ns(e,o,[a]);if(h){const f=e.selection.transformationObjects;f.has(a)?e.activeTransformationObjectId=a:e.activeTransformationObjectId===a&&(e.activeTransformationObjectId=f.size>0?Array.from(f)[f.size-1]:null)}e.clickCount>=3&&(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction={hasMoved:!1,button:0,draggedEntityType:o,draggedEntityId:a,wasAlreadySelected:l}}}function dc(e,t,n,s){if(e.lastMouseX=s.clientX,e.lastMouseY=s.clientY,e.mode===ke.TYPING&&(e.textInput.x=s.clientX,e.textInput.y=s.clientY),!!e.dragAction){if(!e.dragAction.hasMoved)if(e.dragAction.hasMoved=!0,e.clickCount>0&&e.selectionBeforeClick&&(e.selection=Xi(e.selectionBeforeClick)),e.clickCount=0,e.selectionBeforeClick=null,e.dragAction.button===0)if(e.dragAction.draggedEntityType){const i=t.getDragType(e);i?(e.dragAction.type=i,e.mode=ke.DRAGGING):e.dragAction.type=Vn.PANNING}else e.dragAction.type=Vn.PANNING,!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection();else e.dragAction.button===2&&(e.dragAction.type=Vn.MARQUEE_SELECT,e.mode=ke.SELECTING,e.marqueeRect.active=!0,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY);e.dragAction&&e.dragAction.type===Vn.MARQUEE_SELECT&&(e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY,Hf(e,t,s))}}function hc(e,t,n,s){if(s.button===0){if(e.dragAction&&e.dragAction.button===0)if(e.dragAction.hasMoved)e.mode=ke.IDLE;else{const i=e.dragAction.draggedEntityType;if(i){const o=i===me.VERTEX||i===me.EDGE||i===me.FACE||i===me.TEXT,a=i===me.TRANSFORMATION_OBJECT;e.clickCount===1&&e.dragAction.wasAlreadySelected&&!s.shiftKey&&!s.ctrlKey&&(o?(e.clearGeometricSelection(),ns(e,i,[e.dragAction.draggedEntityId])):a&&(e.clearTransformationObjectSelection(),ns(e,i,[e.dragAction.draggedEntityId]),e.activeTransformationObjectId=e.dragAction.draggedEntityId))}else!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==ke.DRAWING&&(e.mode=ke.DRAWING)}else e.dragAction||e.hoverTarget.type===me.CANVAS&&(!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==ke.DRAWING&&(e.mode=ke.DRAWING));e.clickCount>0&&(!e.dragAction||!e.dragAction.hasMoved)||(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction=null}}function Jf(e,t,n,s){e.mode===ke.TYPING&&(n.stopTyping(e),e.mode=ke.IDLE),e.clickCount=0,e.selectionBeforeClick=null,(e.mode===ke.IDLE||e.mode===ke.DRAWING)&&(e.dragAction={hasMoved:!1,button:2,originalMode:e.mode,originalSelection:Xi(e.selection)},e.marqueeRect.startX=s.clientX,e.marqueeRect.startY=s.clientY,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY)}function Ha(e,t,n,s){e.dragAction&&e.dragAction.button===2?e.dragAction.hasMoved?e.mode=e.dragAction.originalMode:(!s.shiftKey&&!s.ctrlKey&&(e.clearSelection(),e.activeTransformationObjectId=null),e.mode=ke.IDLE):e.dragAction||(e.mode=ke.IDLE),e.dragAction=null,e.marqueeRect.active=!1}function Zf(e,t,n,s){if(e.mode===ke.TYPING){n.stopTyping(e),e.mode=ke.IDLE;return}const i=s.event;i.touches.length===1?(e.lastMouseX=i.touches[0].clientX,e.lastMouseY=i.touches[0].clientY,clearTimeout(e.touchTimerId),e.initialTouchData={clientX:i.touches[0].clientX,clientY:i.touches[0].clientY,targetType:s.type,targetId:s.id},e.touchTimerId=setTimeout(()=>{e.touchTimerId=null;const o=e.initialTouchData.targetType,a=e.initialTouchData.targetId;o===me.CANVAS?e.dragAction={hasMoved:!1,button:0}:cc(e,t,n,{type:o,id:a,button:0}),e.hoverTarget={type:me.CANVAS,id:null}},zf),s.type!==me.CANVAS&&rc(e,t,n,{type:s.type,id:s.id})):i.touches.length===2&&(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,e.dragAction={hasMoved:!1,button:0,type:Vn.PANNING,startDistance:Math.hypot(i.touches[0].clientX-i.touches[1].clientX,i.touches[0].clientY-i.touches[1].clientY),startCenter:{x:(i.touches[0].clientX+i.touches[1].clientX)/2,y:(i.touches[0].clientY+i.touches[1].clientY)/2},originalMode:e.mode},e.mode=ke.DRAGGING,e.clearGeometricSelection())}function Qf(e,t,n,s){const i=s.touches;if(i.length===1){const o=i[0].clientX,a=i[0].clientY;if(e.lastMouseX=o,e.lastMouseY=a,e.touchTimerId&&(clearTimeout(e.touchTimerId),e.touchTimerId=null),e.dragAction&&e.dragAction.button===0){dc(e,t,n,{clientX:o,clientY:a,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl});return}}else if(i.length===2&&e.dragAction&&e.dragAction.type===Vn.PANNING){e.dragAction.hasMoved=!0;const o=Math.hypot(i[0].clientX-i[1].clientX,i[0].clientY-i[1].clientY),a={x:(i[0].clientX+i[1].clientX)/2,y:(i[0].clientY+i[1].clientY)/2},r=o/e.dragAction.startDistance,c=Math.log(r)*100;a.x-e.dragAction.startCenter.x,a.y-e.dragAction.startCenter.y,c!==0&&ac(e,t,n,{deltaY:-c}),e.lastMouseX=a.x,e.lastMouseY=a.y}}function eu(e,t,n,s){e.touchTimerId?(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,Ha(e,t,n,{shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}),e.mode===ke.IDLE&&!e.modifiers.shift&&!e.modifiers.ctrl&&e.clearSelection()):e.dragAction&&e.dragAction.button===0?hc(e,t,n,{button:0,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}):e.hoverTarget={type:me.CANVAS,id:null},e.dragAction&&e.dragAction.button===2&&Ha(e,t,n,{}),e.dragAction=null,e.marqueeRect.active=!1,lc(e,t,n,{id:e.hoverTarget.id})}const tu={keyDown:Kf,keyUp:qf,wheel:ac,hoverStart:rc,hoverEnd:lc,appModeChange:jf,mouseDown:Uf,entityMouseDown:cc,mouseMove:dc,mouseUp:hc,rightMouseDown:Jf,rightMouseUp:Ha,touchStart:Zf,touchMove:Qf,touchEnd:eu};function nu(e,t,n,s,i){const o=tu[s];o&&o(e,t,n,i)}const Te=document.getElementById("drawingCanvas"),Oe=Te.getContext("2d",{willReadFrequently:!0}),yt=document.getElementById("html-overlay"),Ke=window.devicePixelRatio||1,jo=new Map,Cr=is,mi=8,ka={x:12,y:-12},su={x:8,y:-8};let Dt={activeId:null,inputEl:null};const En={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0,radiusMode:"relative",radiusValue:.25},Tr="platonic-play",Yi=1,Ra=`${Tr}.user-id`;let xn=null,xi=null,fc=!1,os,to,pn=[JSON.parse(JSON.stringify(En))],Bs=En.id;const j={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,colorModeToolButton:null,colorModeIcons:[],colorModeExprFields:[],colorModePanelBounds:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[],sessionsToolButton:null,sessionIcons:[],addSessionButton:null,removeSessionButton:null,sessionsPanelBounds:null};let Ct,no=null,so=null,qt=null,Ka=[],Gi=null,Hn=new Map,Dn=null,Xn=null,po=null,ni=null,$s=null,$n=null,ao=!1,Wt=null,Be=[],jt=null,ys=null,Et=null,Un=null,Uo=!1,si=null,In=!1,fa=!1,cn=!1,vt=!1,dn=!1,Vs="regular",xt="lines",en="degrees",bi="on",Wi=!0,zi=!0,Jn=!0,yn=null,Kt=null,Vt=null,Hi=null,Ki=!1,ks=!1,ye=[],U=[],ie=[],We=[],Xs=new Map,kt=new Map,Ce=[],be=[],ge=[],_e=[],rt=null,te={x:0,y:0},ms=null,ls=!1,gt=!1,qi=!1,Xo=null,kn=!1,sn=!1,yo=null,ft=[],rn=0,ss=!0,On=!0,dt=null,vi=4,Ts=3,ou=.5,st=null,Ut=!1,ze=!1,Kn=!1,Cn=!1,tn=-1,ln={x:0,y:0},La={x:0,y:0},Ie=[],ji={x:0,y:0},he=null,we=ia,ot=!1,St=null,Ui=null,De=[],oo=[],qa=[],Fe=!1,zt={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},Ee={targetId:null,type:null,count:0,timestamp:0},Si={id:null,timestamp:0},wt=[],Ve=[],Rt=0,Nt=0,Yo=null,Ji=[],Mt="colormap",Tt="colormap_xy",xs="x",Ss="x",Rs="r",Zn="1-r",Is="1/(r+0.001)",bs="1/(r+0.001)",_o={},Do={},ja={},Ua={},Yn=null,Gn=null,Pt=!1,wo=!1,_n=null,Mi=!1,Bt=null;function iu(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,s=Array.prototype.splice;wt.pop=function(){return e.call(this)},wt.push=function(...i){return t.call(this,...i)},wt.shift=function(){return n.call(this)},wt.splice=function(...i){return s.call(this,...i)}}let Ja=!1,hs=[],Ue=null,Ye=[],Jt="",nn=null,Ys=[],Ei=0,oe={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},pe={scale:Fd,offsetX:0,offsetY:0},Tn={angle1:30,angle2:15,alpha1:1,alpha2:0},wr=new Set,Jo="dark",Qe=[],fs=!1,bt=null,Go=!1,Ci=null,Re={[et]:0,[tt]:1,[at]:2,[Ht]:0},Qn=!1,wn=null,Zi=null,ro=new Set;const Pe=new Gf,uc={getEntitiesInRect:e=>{const t=[],n=s=>s.x>=e.minX&&s.x<=e.maxX&&s.y>=e.minY&&s.y<=e.maxY;return ye.forEach(s=>{const i=Ae(s);n(i)&&t.push({type:s.type==="regular"?me.VERTEX:me.TRANSFORMATION_OBJECT,id:s.id})}),U.forEach(s=>{const i=J(s.id1),o=J(s.id2);if(!i||!o)return;const a=Ae({x:(i.x+o.x)/2,y:(i.y+o.y)/2});n(a)&&t.push({type:me.EDGE,id:le(s)})}),ie.forEach(s=>{const i=s.vertexIds.map(r=>J(r)).filter(Boolean);if(i.length<3)return;const o=i.reduce((r,c)=>({x:r.x+c.x,y:r.y+c.y}),{x:0,y:0}),a=Ae({x:o.x/i.length,y:o.y/i.length});n(a)&&t.push({type:me.FACE,id:ue(s)})}),We.forEach(s=>{const i=s.screenBounds;if(!i)return;const o={x:(i.left+i.right)/2,y:(i.top+i.bottom)/2};n(o)&&t.push({type:me.TEXT,id:s.id})}),t},getNeighbors:e=>{if(J(e))return Sn(e,U);const n=U.find(o=>le(o)===e);if(n)return[n.id1,n.id2];const s=ie.find(o=>ue(o)===e);if(s)return[...s.vertexIds];const i=We.find(o=>o.id===e);return i&&i.anchorId?[i.anchorId]:[]},getAllConnected:e=>{const t=uc.getEntityType(e);if(t===me.VERTEX||t===me.TRANSFORMATION_OBJECT)return Ws(e);if(t===me.EDGE){const n=U.find(i=>le(i)===e);if(!n)return[];const s=new Set(Ws(n.id1));return U.filter(i=>s.has(i.id1)&&s.has(i.id2)).map(i=>le(i))}if(t===me.FACE){const n=ie.find(o=>ue(o)===e);if(!n)return[];const s=new Set([ue(n)]),i=[n];for(;i.length>0;){const o=i.shift();ie.forEach(a=>{const r=ue(a);s.has(r)||a.vertexIds.some(c=>o.vertexIds.includes(c))&&(s.add(r),i.push(a))})}return Array.from(s)}return[e]},getEntityType:e=>{const t=J(e);return t?t.type==="regular"?me.VERTEX:me.TRANSFORMATION_OBJECT:U.some(n=>le(n)===e)?me.EDGE:ie.some(n=>ue(n)===e)?me.FACE:We.some(n=>n.id===e)?me.TEXT:null},getDragType:e=>e.selection.vertices.size>0||e.selection.edges.size>0||e.selection.faces.size>0||e.selection.text.size>0||e.selection.transformationObjects.size>0?Vn.RIGID_DRAG:null},au={startTyping:()=>{Dt.activeId||er("")},updateText:(e,t)=>{if(!Dt.activeId){er(t);return}const n=Dt.inputEl;if(n)n.value+=t;else{const s=So(Dt.activeId);s&&(s.content=`${s.content||""}${t}`)}e.textInput.value=Dt.inputEl?Dt.inputEl.value:""},backspace:e=>{const t=Dt.inputEl;t&&(t.value=t.value.slice(0,-1),e.textInput.value=t.value)},stopTyping:()=>{No(!0)}};function un(e,t){nu(Pe,uc,au,e,t)}function Xt(){Dt.activeId?Pe.mode=ke.TYPING:Cn?Pe.mode=ke.SELECTING:ze||Kn||ks||Qn?Pe.mode=ke.DRAGGING:ot?Pe.mode=ke.DRAWING:Pe.mode=ke.IDLE,Pe.modifiers.shift=Fe,Pe.modifiers.ctrl=wo,Pe.modifiers.alt=Pt,Pe.selection.vertices=new Set(Ce),Pe.selection.edges=new Set(be),Pe.selection.faces=new Set(ge),Pe.selection.text=new Set(_e),Pe.selection.transformationObjects=new Set(Ye),Pe.activeTransformationObjectId=rt,Hi?Pe.hoverTarget={type:me.TEXT,id:Hi}:yn?Pe.hoverTarget={type:me.VERTEX,id:yn}:Kt?Pe.hoverTarget={type:me.EDGE,id:Kt}:Vt?Pe.hoverTarget={type:me.FACE,id:Vt}:Pe.hoverTarget={type:me.CANVAS,id:null},Pe.marqueeRect={active:Cn,startX:ji.x,startY:ji.y,endX:te.x,endY:te.y},Pe.zoomLevel=pe.scale,Pe.lastMouseX=te.x,Pe.lastMouseY=te.y;const e=Dt.inputEl;Pe.textInput.active=!!Dt.activeId,Pe.textInput.x=te.x,Pe.textInput.y=te.y,Pe.textInput.value=e?e.value:"",Ut?Pe.dragAction={hasMoved:ze,button:tn,type:Cn?Vn.MARQUEE_SELECT:Kn?Vn.PANNING:null}:Pe.dragAction=null}function Al(e,t){e&&(e.classList.toggle("active",t),e.setAttribute("aria-pressed",t?"true":"false"))}function ru(e,t){const n={key:e,shiftKey:e==="Shift",ctrlKey:e==="Control",metaKey:!1,altKey:e==="Alt",repeat:!1,target:document.body,preventDefault:()=>{},stopPropagation:()=>{}};t?Gc(n):Wc(n)}function lu(){const e=document.getElementById("mobile-controls");if(!e)return;const t=e.querySelector('[data-mod="hover"]'),n=e.querySelector('[data-mod="shift"]'),s=e.querySelector('[data-mod="ctrl"]'),i=e.querySelector('[data-mod="alt"]'),o=()=>{Mi=!Mi,Al(t,Mi),Xt()},a=(r,c,l)=>{const d=!l;Al(r,d),ru(c,d)};t&&t.addEventListener("click",o),n&&n.addEventListener("click",()=>a(n,"Shift",Fe)),s&&s.addEventListener("click",()=>a(s,"Control",wo)),i&&i.addEventListener("click",()=>a(i,"Alt",Pt))}function cu(e){return Wl(e,j,{isToolbarExpanded:ls,isColorPaletteExpanded:gt,isColorModePanelExpanded:dn,isInterpolationPanelExpanded:cn,isTransformPanelExpanded:kn,isDisplayPanelExpanded:In,isVisibilityPanelExpanded:fa,isSessionsPanelExpanded:vt})}function Es(){Oh(ie,J)}function ua(){return Rh(Jo,hd)}function qe(e,t=0,n=1){let s=Re[e];(s<0||s>=we.length)&&(s=0);const i=we[s];if(i?.type==="color")return i.value;if(i?.type==="colormap"){const a=n>1?t/(n-1):.5;return Ge(i,a)}const o=ua();return e===et?o.vertex:e===tt?o.edge:e===at?o.face:e===Ht?o.uiTextDefault||o.geometryInfoText:o.vertex}function Qi(e){return[]}function mo(){const e=new Set(be);return Array.from(Pe.selection.edges||[]).forEach(n=>e.add(n)),Array.from(e)}function xo(){const e=new Set(ge);return Array.from(Pe.selection.faces||[]).forEach(n=>e.add(n)),Array.from(e)}function lo(){const e=mo();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=U.find(i=>le(i)===n);s&&t.add(Pr(s))}),Array.from(t)}function co(){const e=xo();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=ie.find(i=>ue(i)===n);s&&t.add(Ar(s))}),Array.from(t)}function gc(){const e=mo();if(e.length>0){const n=Kt?U.find(s=>le(s)===Kt):null;if(n&&e.includes(le(n))){const s=Pr(n);lo().includes(s)&&(Yn=s)}lo().includes(Yn)||(Yn=lo()[0]||Yn)}const t=xo();if(t.length>0){const n=Vt?ie.find(s=>ue(s)===Vt):null;if(n&&t.includes(ue(n))){const s=Ar(n);co().includes(s)&&(Gn=s)}co().includes(Gn)||(Gn=co()[0]||Gn)}}function Pr(e){return e?.colorMode||Mt}function Ar(e){return e?.colorMode||Tt}function du(e){return e?e.type==="color"?!0:e.type==="colormap"?Array.isArray(e.vertices)&&e.vertices.length===1:!1:!1}function pc(e){if(!e)return null;if(e.type==="colormap")return e;if(e.type==="color"){const t=jn(e.value);return{type:"colormap",vertices:[{pos:0,color:t?[Math.round(t.r),Math.round(t.g),Math.round(t.b)]:[255,255,255],alpha:1}],isCyclic:!1}}return null}function es(e,t){if(e.colorMode=t,t==="colormap"){const n=we[Re[tt]],s=pc(n);if(s){e.colormapItem=e.colormapItem||s,e.gradientStart=e.gradientStart??0,e.gradientEnd=e.gradientEnd??1,delete e.color;return}e.color=qe(tt),delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd;return}delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd}function oi(e,t){if(e.colorMode=t,t==="colormap_xy"){const n=we[Re[at]],s=pc(n);if(s){e.colormapItem=e.colormapItem||s,e.colormapDistribution=e.colormapDistribution||"x",delete e.color;return}e.color=qe(at),delete e.colormapItem,delete e.colormapDistribution;return}delete e.colormapItem,delete e.colormapDistribution}function hu(e,t=null){(t||mo()).forEach(s=>{const i=U.find(o=>le(o)===s);i&&es(i,e)})}function fu(e,t=null){(t||xo()).forEach(s=>{const i=ie.find(o=>ue(o)===s);i&&oi(i,e)})}function Za(){U.forEach(e=>{const t=e.colorMode||Mt;es(e,t)}),ie.forEach(e=>{const t=e.colorMode||Tt;oi(e,t)})}function _r(){Qe.forEach(e=>{const t=Re[e];if(e===et){const n=we[t];if(n&&n.type==="colormap"){const s=Ce.map(i=>J(i)).filter(i=>i&&i.type==="regular");s.forEach((i,o)=>{const a=s.length>1?o/(s.length-1):.5;i.color=Ge(n,a)})}else Ce.forEach(s=>{const i=J(s);i&&i.type==="regular"&&(i.color=qe(et))})}else if(e===tt){const n=we[t];be.forEach((s,i)=>{const o=U.find(c=>le(c)===s);if(!o)return;const a=Pr(o);if(a==="inherit_vertices")return;if(a==="colormap"&&n&&n.type==="colormap"){const c=be.length,l=c>1?i/c:0,d=c>1?(i+1)/c:1;o.gradientStart=l,o.gradientEnd=d,o.colormapItem=n,delete o.color;return}const r=n&&n.type==="colormap"?Ge(n,.5):qe(tt);o.color=r,delete o.gradientStart,delete o.gradientEnd,delete o.colormapItem})}else if(e===at){const n=Re[e],s=we[n];ge.forEach(i=>{const o=ie.find(c=>ue(c)===i);if(!o)return;const a=Ar(o);if(a==="inherit_vertices"||a==="inherit_edges")return;if(a==="colormap_xy"&&s&&s.type==="colormap"){o.colormapItem=s,o.colormapDistribution="x",delete o.color;return}const r=s&&s.type==="colormap"?Ge(s,.5):qe(at);o.color=r,delete o.colormapItem,delete o.colormapDistribution})}else if(e===Ht){const n=we[t];if(n&&n.type==="colormap")_e.forEach((s,i)=>{const o=So(s);if(!o)return;const a=_e.length>1?i/(_e.length-1):.5;o.color=Ge(n,a)});else{const s=qe(Ht);_e.forEach(i=>{const o=So(i);o&&(o.color=s)})}}})}function Ft({id:e,content:t,x:n,y:s,color:i,fontSize:o,options:a={}}){wr.add(e);let r=jo.get(e);if(r){if(!r.contentEl||!r.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.textContent="",r.appendChild(u),r.contentEl=u,r.katexEl=p,r.katexContent=null,r.style.pointerEvents="none"}}else{r=document.createElement("div"),r.style.position="absolute",r.style.fontFamily="KaTeX_Main, Times New Roman, serif",r.style.whiteSpace="nowrap",r.style.lineHeight="1",r.style.display="inline-block",r.style.padding="0",r.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.appendChild(u),r.contentEl=u,r.katexEl=p,yt.appendChild(r),jo.set(e,r)}let c="-50%",l="-50%",d="center";switch(a.textAlign){case"left":c="0%";break;case"right":c="-100%";break}switch(a.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}a.textAlign==="left"&&a.textBaseline==="top"?d="top left":a.textAlign==="right"&&a.textBaseline==="top"?d="top right":a.textAlign==="left"&&a.textBaseline==="bottom"?d="bottom left":a.textAlign==="right"&&a.textBaseline==="bottom"&&(d="bottom right"),r.style.left=`${n}px`,r.style.top=`${s}px`,r.style.transformOrigin=d,r.style.transform=`translate(${c}, ${l}) rotate(${a.rotation||0}deg)`,r.style.display="inline-block",r.style.background="transparent",r.style.border="none",r.style.borderRadius="0",r.style.padding="0",r.style.minHeight="0",r.style.alignItems="",r.style.justifyContent="",r.style.color=i,r.style.fontSize=`${o}px`;const h=t==null?"":String(t),f=dd(h);if(r.katexContent!==f){const u=r.katexEl||r.contentEl||r;cd(u,f),r.katexContent=f}}function _l(e,{placeholder:t,onChange:n}){if(e)return e;const s=document.createElement("div");s.style.position="absolute",s.style.display="none",s.style.boxSizing="border-box",s.style.pointerEvents="auto",s.style.fontFamily='Consolas, Monaco, "Courier New", monospace',s.style.fontSize=`${nl}px`,s.style.padding=`${zd}px ${Vl}px`,s.style.borderRadius=`${Wd}px`,s.style.border=`${$l}px solid rgba(0,0,0,0.3)`,s.style.background="transparent",s.style.alignItems="center",s.style.gap="4px";const i=document.createElement("div");i.style.display="inline-flex",i.style.alignItems="center",i.style.whiteSpace="nowrap",i.style.lineHeight="1",i.style.pointerEvents="none";const o=document.createElement("input");o.type="text",o.placeholder=t,o.style.flex="1",o.style.minWidth="0",o.style.border="none",o.style.outline="none",o.style.background="transparent",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize=`${nl}px`,o.style.color="#111111",o.style.height="100%",o.style.lineHeight="1",o.style.pointerEvents="auto";const a=()=>{n&&n(o.value)};return o.addEventListener("input",a),o.addEventListener("blur",a),o.addEventListener("keydown",r=>{r.key==="Enter"&&(a(),o.blur())}),s.appendChild(i),s.appendChild(o),yt.appendChild(s),{container:s,label:i,input:o,labelText:""}}function uu(e){const t=e.match(/[A-Za-z_][A-Za-z0-9_]*/g);return t||[]}function Dl(e,t){const n=(e||"").trim();return n?uu(n).every(i=>t.includes(i)):!0}function gu(){const e=lo(),t=co();e.length>0&&(e.includes(Yn)||e[0]),t.length>0&&(t.includes(Gn)||t[0]);const n=()=>{const C=mo();if(C.length===0)return null;if(Kt){const T=U.find(w=>le(w)===Kt);if(T&&C.includes(le(T)))return T}return U.find(T=>le(T)===C[0])||null},s=()=>{const C=xo();if(C.length===0)return null;if(Vt){const T=ie.find(w=>ue(w)===Vt);if(T&&C.includes(ue(T)))return T}return ie.find(T=>ue(T)===C[0])||null},i=C=>{const v=Re[C],T=v>=0?we[v]:null;return du(T)?"1":"x"},o=C=>C==="edge"?"1-r":"1/(r+0.001)",a=(C,v)=>{C.labelText!==v&&(C.label.textContent=v,C.labelText=v)},r=(C,v)=>(_o[C]=_l(_o[C],{placeholder:"x",onChange:v}),_o[C]),c=(C,v)=>(Do[C]=_l(Do[C],{placeholder:"x",onChange:v}),Do[C]),l=(C,v)=>C==="inherit_vertices"?v?.weightExpression||Zn||o("edge"):v?.colorExpression||xs||i(tt),d=(C,v)=>C==="inherit_edges"?v?.edgeWeightExpression||bs||o("face_edge"):C==="inherit_vertices"?v?.vertexWeightExpression||Is||o("face_vertex"):v?.colorExpression||Ss||Rs||i(at),h=(C,v)=>{const T=v.trim();if(!Dl(T,["x","r"])){const P=_o[C];P&&(P.input.value=l(C,n()));return}const I=mo();I.length>0?I.forEach(P=>{const L=U.find(A=>le(A)===P);L&&(C==="inherit_vertices"?L.weightExpression=T||o("edge"):L.colorExpression=T||i(tt))}):C==="inherit_vertices"?Zn=T||o("edge"):xs=T||i(tt),Qt()},f=(C,v)=>{const T=v.trim();if(!Dl(T,C==="inherit_edges"?["r"]:["x","y","r","a"])){const P=Do[C];P&&(P.input.value=d(C,s()));return}const I=xo();I.length>0?I.forEach(P=>{const L=ie.find(A=>ue(A)===P);L&&(C==="inherit_edges"?L.edgeWeightExpression=T||o("face_edge"):C==="inherit_vertices"?L.vertexWeightExpression=T||o("face_vertex"):L.colorExpression=T||i(at))}):C==="inherit_edges"?bs=T||o("face_edge"):C==="inherit_vertices"?Is=T||o("face_vertex"):Ss=T||i(at),Qt()},u=Jo==="light",p=u?"#000000":"#ffffff",g=u?"#000000":"#ffffff",y=ua().background;if(Object.values(_o).forEach(C=>{C.container.style.display="none"}),Object.values(Do).forEach(C=>{C.container.style.display="none"}),!dn||!j.colorModeIcons.length)return;const m=[{mode:"inherit_vertices",label:"w(x)=",minWidth:"3ch"},{mode:"colormap",label:"c(x)=",minWidth:"3ch"}],x=[{mode:"inherit_vertices",label:"w(x,y,r,a) =",minWidth:"9ch"},{mode:"inherit_edges",label:"w(r) =",minWidth:"9ch"},{mode:"colormap_xy",label:"c(x,y,r,a) =",minWidth:"9ch"}];let S=!1;const M=(C,v,T)=>{const w=j.colorModeExprFields.find($=>$.group===C&&$.mode===v.mode);if(!w)return;const I=C==="edge"?r(v.mode,$=>h(v.mode,$)):c(v.mode,$=>f(v.mode,$));if(a(I,v.label),!T){I.container.style.display="none";return}document.activeElement!==I.input&&(C==="edge"?I.input.value=l(v.mode,n()):I.input.value=d(v.mode,s()));const P=2;I.container.style.left=`${w.x-P}px`,I.container.style.top=`${w.y-P}px`,I.container.style.width=`${w.width+P*2}px`,I.container.style.height=`${w.height+P*2}px`,I.container.style.padding=`0 ${Vl}px`,I.container.style.border=`${$l}px solid ${g}`,I.container.style.background=y,I.container.style.color=p;const L=Math.max(10,Math.floor(w.height*.64));I.container.style.fontSize=`${L}px`,I.input.style.fontSize=`${L}px`,I.input.style.color=p,I.input.style.minWidth=v.minWidth,I.input.style.height=`${w.height+P*2}px`,I.input.style.lineHeight=`${w.height+P*2}px`,I.container.style.display="flex";const A=w.baseWidth||w.width,_=w.stepWidth||A,D=I.label.getBoundingClientRect().width,O=I.input.scrollWidth,X=D+O+8,F=Math.max(0,Math.ceil((X-A)/_)),V=A+F*_;C==="edge"?ja[v.mode]!==V&&(ja[v.mode]=V,S=!0):Ua[v.mode]!==V&&(Ua[v.mode]=V,S=!0)},b=e.length>0?e:[Mt],E=t.length>0?t:[Tt];if(m.forEach(C=>M("edge",C,b.includes(C.mode))),x.forEach(C=>M("face",C,E.includes(C.mode))),S){Rr();return}}function pu(e,t,n){const s=jn(e),i=jn(t),o=Math.max(0,Math.min(1,n)),a=Math.round(s.r*(1-o)+i.r*o),r=Math.round(s.g*(1-o)+i.g*o),c=Math.round(s.b*(1-o)+i.b*o),l=s.a;return`rgba(${a}, ${r}, ${c}, ${l})`}function yu(){for(const[e,t]of jo.entries())wr.has(e)||(t.remove(),jo.delete(e))}function ho(e){return{x:e.x*Ke/pe.scale,y:-e.y*Ke/pe.scale}}function So(e){return We.find(t=>t.id===e)}function Dr(e,t,n,s=null){if(!e||!t||!n)return null;const i={x:n.x-t.x,y:n.y-t.y},o=Math.hypot(i.x,i.y);if(o<1e-6)return null;let a={x:-i.y/o,y:i.x/o};if(s&&s.length>=3){const r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},c=s.reduce((h,f)=>({x:h.x+f.x,y:h.y+f.y}),{x:0,y:0});c.x/=s.length,c.y/=s.length;const l={x:c.x-r.x,y:c.y-r.y};a.x*l.x+a.y*l.y>0&&(a={x:-a.x,y:-a.y})}return{normalData:a,edgeLen:o}}function yc(e){const t=U.find(l=>le(l)===e);if(!t)return ho(mi);const n=J(t.id1),s=J(t.id2);if(!n||!s)return ho(mi);const i=ie.filter(l=>{const d=l.vertexIds||[];for(let h=0;h<d.length;h++){const f=d[h],u=d[(h+1)%d.length];if(f===t.id1&&u===t.id2||f===t.id2&&u===t.id1)return!0}return!1});let o=null;i.length===1&&(o=(i[0].vertexIds||[]).map(d=>J(d)).filter(Boolean));const a=Dr(t,n,s,o);if(!a)return ho(mi);const r=a.normalData,c=mi*Ke/pe.scale;return{x:r.x*c,y:r.y*c}}function Ti(e,t){const n=U.find(l=>le(l)===e);if(!n||!t)return null;const s=J(n.id1),i=J(n.id2);if(!s||!i)return null;const o=Dr(n,s,i);if(!o)return null;const{normalData:a,edgeLen:r}=o;return r<1e-6?null:(t.x*a.x+t.y*a.y)/r}function Qa(e){const t=J(e);if(!t)return{offset:ho(ka),align:"left",baseline:"middle"};const s=Sn(e,U).map(f=>J(f)).filter(Boolean);let i={x:1,y:0};if(s.length===2){const f={x:s[0].x-t.x,y:s[0].y-t.y},u={x:s[1].x-t.x,y:s[1].y-t.y},p=Math.hypot(f.x,f.y),g=Math.hypot(u.x,u.y);if(p>1e-6&&g>1e-6){const y={x:f.x/p,y:f.y/p},m={x:u.x/g,y:u.y/g},x={x:y.x+m.x,y:y.y+m.y},S=Math.hypot(x.x,x.y);S>1e-6?i={x:-x.x/S,y:-x.y/S}:i={x:-y.y,y:y.x}}}const o=Ae(t),a=Ae({x:t.x+i.x,y:t.y+i.y});let r={x:a.x-o.x,y:a.y-o.y};const c=Math.hypot(r.x,r.y);c>1e-6?(r.x/=c,r.y/=c):r={x:1,y:0};const l=Math.hypot(ka.x,ka.y),d={x:r.x*l,y:r.y*l},h=r.x>=0?"left":"right";return{offset:ho(d),align:h,baseline:"middle"}}function Zo(e){return pn.find(t=>t.id===e)||null}function Io(){return Zo(Bs)||pn[0]||En}function wi(e){e&&(Bs=e,Qt())}function mc(){const e=new Set(be),t=new Set(ge),n=new Set(Ce),s=new Set,i=o=>{const a=o||En.id;s.add(a)};return e.size>0&&U.forEach(o=>{const a=le(o);e.has(a)&&i(o.interpolationStyleId)}),t.size>0&&ie.forEach(o=>{const a=ue(o);a&&t.has(a)&&i(o.interpolationStyleId)}),e.size===0&&t.size===0&&n.size>0&&(U.forEach(o=>{(n.has(o.id1)||n.has(o.id2))&&i(o.interpolationStyleId)}),ie.forEach(o=>{o.vertexIds&&o.vertexIds.some(a=>n.has(a))&&i(o.interpolationStyleId)})),s.size===1?[...s][0]:null}function mu(e){if(!e)return;const t=new Set(be),n=new Set(ge),s=new Set(Ce);let i=!1;t.size>0&&U.forEach(o=>{const a=le(o);t.has(a)&&(o.interpolationStyleId=e,i=!0)}),n.size>0&&ie.forEach(o=>{const a=ue(o);a&&n.has(a)&&(o.interpolationStyleId=e,i=!0)}),t.size===0&&n.size===0&&s.size>0&&(U.forEach(o=>{(s.has(o.id1)||s.has(o.id2))&&(o.interpolationStyleId=e,i=!0)}),ie.forEach(o=>{o.vertexIds&&o.vertexIds.some(a=>s.has(a))&&(o.interpolationStyleId=e,i=!0)})),i&&Qt()}function xu(){const e=new Set(be),t=new Set(ge),n=new Set(Ce);let s=!1;e.size>0&&U.forEach(i=>{const o=le(i);e.has(o)&&(delete i.interpolationStyleId,s=!0)}),t.size>0&&ie.forEach(i=>{const o=ue(i);o&&t.has(o)&&(delete i.interpolationStyleId,s=!0)}),e.size===0&&t.size===0&&n.size>0&&(U.forEach(i=>{(n.has(i.id1)||n.has(i.id2))&&(delete i.interpolationStyleId,s=!0)}),ie.forEach(i=>{i.vertexIds&&i.vertexIds.some(o=>n.has(o))&&(delete i.interpolationStyleId,s=!0)})),s&&Qt()}function Gs(e){const t=Io();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function Su(e){const t=Io();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function Lo(e){if(!e)return null;const t=new Map;ze&&Array.isArray(De)&&De.length>0&&De.forEach(s=>{if(!s||!s.id)return;const i=s.originalId||s.id;t.set(i,s)});const n=s=>t.has(s)?t.get(s):J(s);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const s=n(e.anchorId);return s?{anchor:{x:s.x,y:s.y}}:null}if(e.anchorType==="edge"){const s=U.find(g=>le(g)===e.anchorId);if(!s)return null;const i=n(s.id1),o=n(s.id2);if(!i||!o)return null;const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2},r=Math.atan2(o.y-i.y,o.x-i.x),c=Ae(i),l=Ae(o),d=Math.atan2(l.y-c.y,l.x-c.x),h=ie.filter(g=>{const y=g.vertexIds||[];for(let m=0;m<y.length;m++){const x=y[m],S=y[(m+1)%y.length];if(x===s.id1&&S===s.id2||x===s.id2&&S===s.id1)return!0}return!1});let f=null;h.length===1&&(f=(h[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=Dr(s,i,o,f),p=u?u.normalData:null;return{anchor:a,edgeAngleRad:r,edgeAngleRadScreen:d,edgeNormalData:p,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const s=ie.find(a=>ue(a)===e.anchorId);if(!s)return null;const i=s.vertexIds.map(a=>n(a)).filter(a=>a&&a.type==="regular");return i.length<3?null:{anchor:{x:i.reduce((a,r)=>a+r.x,0)/i.length,y:i.reduce((a,r)=>a+r.y,0)/i.length}}}return null}function xc(){return he?.finalSnapResult?.finalDelta?he.finalSnapResult.finalDelta:he?.textFinalDelta?he.textFinalDelta:De.length>0&&Ie.length>0?{x:De[0].x-Ie[0].x,y:De[0].y-Ie[0].y}:null}function Sc(e){const t=Lo(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=yc(e.anchorId);const l=Ti(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let s={x:t.anchor.x+n.x,y:t.anchor.y+n.y},i=e.rotationDeg||0,o=e.scale||1,a="center",r="middle";if(e.anchorType==="vertex"){const l=Qa(e.anchorId);a=e.vertexAlign||l.align||"left",r=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(a="center",r="middle",typeof t.edgeAngleRadScreen=="number"?i+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(i+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(a="left",r="top");e.anchorType==="edge"&&(i>90||i<-90)&&(i+=180,i>180&&(i-=360),r="top");const c=_e.includes(e.id);if(ze&&c)if(st){const{center:l,rotation:d,scale:h,directionalScale:f,startVector:u}=st;s=je(s,l,d,h,f,u),i-=d*(180/Math.PI),o*=h}else{const l=xc();l&&(s={x:s.x+l.x,y:s.y+l.y})}return{id:e.id,content:e.content||"",position:s,rotationDeg:i,scale:o,textAlign:a,textBaseline:r}}function Iu(e){const t=yt.getBoundingClientRect(),n=[];We.forEach(s=>{const i=Sc(s);if(!i){n.push(s.id);return}const o=Ae(i.position),a=`text-${i.id}`,r=_e.includes(s.id),c=s.color||qe(Ht)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",d=pu(c,l,.35);Ft({id:a,content:i.content,x:o.x,y:o.y,color:r?d:c,fontSize:(s.fontSize||Cr)*i.scale,options:{textAlign:i.textAlign,textBaseline:i.textBaseline,rotation:i.rotationDeg}});const h=jo.get(a);if(h){const f=h.contentEl||h;f.style.outline="none",f.style.textShadow="none",f.style.color=r?d:c;const p=(h.katexEl||f).getBoundingClientRect();s.screenBounds={left:p.left-t.left,top:p.top-t.top,right:p.right-t.left,bottom:p.bottom-t.top}}}),n.length>0&&(We=We.filter(s=>!n.includes(s.id)),_e=_e.filter(s=>!n.includes(s)))}function Ic(e){for(let t=We.length-1;t>=0;t--){const n=We[t],s=n.screenBounds;if(s&&e.x>=s.left&&e.x<=s.right&&e.y>=s.top&&e.y<=s.bottom)return n}return null}function bc(e,t=""){if(!Dt.inputEl){const o=document.createElement("input");o.type="text",o.style.position="absolute",o.style.zIndex="5",o.style.pointerEvents="auto",o.style.fontFamily="KaTeX_Main, Times New Roman, serif",o.style.fontSize=`${e.fontSize||Cr}px`,o.style.border="1px solid rgba(255, 255, 255, 0.4)",o.style.borderRadius="4px",o.style.padding="2px 4px",o.style.background="rgba(0, 0, 0, 0.6)",o.style.color="#ffffff",o.style.outline="none",o.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),No(!0)):a.key==="Escape"&&(a.preventDefault(),No(!1))}),o.addEventListener("mouseleave",()=>No(!0)),o.addEventListener("blur",()=>No(!0)),yt.appendChild(o),Dt.inputEl=o}const n=Sc(e);if(!n)return;const s=Ae(n.position),i=Dt.inputEl;i.value=t||e.content||"",i.style.left=`${s.x}px`,i.style.top=`${s.y}px`,i.style.transform="translate(-10%, -10%)",i.style.display="block",Dt.activeId=e.id,i.focus(),i.setSelectionRange(i.value.length,i.value.length)}function No(e){const t=Dt.inputEl;if(!t)return;const n=Dt.activeId;if(n&&e){const s=So(n);if(s){nt();const i=t.value.trim();!i&&s.isDraft?(We=We.filter(o=>o.id!==s.id),_e=_e.filter(o=>o!==s.id)):(s.content=i||s.content||"",delete s.isDraft)}}t.style.display="none",Dt.activeId=null}function er(e=""){let t="canvas",n=null,s={x:0,y:0},i=$e(te);if(yn)t="vertex",n=yn,s=Qa(n).offset;else if(Kt)t="edge",n=Kt,s=yc(n);else if(Vt)t="face",n=Vt;else{const a=ho(su);i={x:i.x+a.x,y:i.y+a.y}}const o={id:$t(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?i:null,offset:t==="canvas"?{x:0,y:0}:s,rotationDeg:0,scale:1,fontSize:Cr,color:qe(Ht),isDraft:!0};if(t==="vertex"){const a=Qa(n);o.vertexAlign=a.align,o.vertexBaseline=a.baseline}We.push(o),_e=[o.id],bc(o,e)}function kr(e,t,n){const s=new Set(Pe.selection.transformationObjects);let i=Pe.activeTransformationObjectId;if(n)if(s.has(e)){if(s.delete(e),i===e){const o=Array.from(s);i=o.length>0?o[o.length-1]:null}}else s.add(e),i=e;else s.has(e)||s.add(e),i=e;Pe.selection.transformationObjects=s,Pe.activeTransformationObjectId=i,Ye=Array.from(s),rt=i}function Pi(e){const t=ps(e,xt,oe.interval1,Tn,!0);if(ye.forEach(s=>{s.type==="regular"&&t.push({x:s.x,y:s.y,isGridVertex:!1})}),U.forEach(s=>{const i=J(s.id1),o=J(s.id2);if(i&&o&&i.type==="regular"&&o.type==="regular"){const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2,isGridVertex:!1};t.push(a)}}),t.length===0)return null;const n=(s,i)=>(s.x-i.x)**2+(s.y-i.y)**2;return t.reduce((s,i)=>{const o=n(e,s);return n(e,i)<o?i:s})}function Zt(){const e=new Set(ye.map(a=>a.id)),t=new Set,n=[];for(const a of e)if(!t.has(a)){const r=Ws(a),c=new Set(r);n.push(c),r.forEach(l=>t.add(l))}const s=a=>[...a].sort().join(","),i=[],o=new Set;Ka.forEach(a=>{const r=s(a);for(let c=0;c<n.length;c++){if(o.has(c))continue;const l=n[c];if(r===s(l)){i.push(l),o.add(c);break}}});for(let a=0;a<n.length;a++)o.has(a)||i.push(n[a]);Ka=i}function bu(e,t,n=!1,s=[],i=1){if(n&&s.length>0&&[...e].some(l=>s.some(d=>d.id===l)))return;const o=ie.filter(c=>c.vertexIds.every(l=>e.has(l)));Kh(Oe,{allFaces:o,allEdges:U,facesVisible:Jn,isDragConfirmed:!1,dragPreviewVertices:[],transformIndicatorData:null,initialDragVertexStates:[],colors:t,initialCoordSystemStates:new Map,interpolationStyle:Io(),getInterpolationStyleById:Zo,faceColorMode:Tt,edgeColorMode:Mt,faceColorExpression:Ss,faceColorPolarExpression:Rs,edgeColorExpression:xs,edgeWeightExpression:Zn,faceVertexWeightExpression:Is,faceEdgeWeightExpression:bs,angleDisplayMode:en},Ae,J);const a=U.filter(c=>e.has(c.id1)&&e.has(c.id2));of(Oe,{allEdges:a,selectedEdgeIds:be,hoveredEdgeId:Kt,isDragConfirmed:!1,dragPreviewVertices:[],colors:t,edgesVisible:zi,snappedEdgeIds:Xs,currentAltPressed:Pt,interpolationStyle:Io(),getInterpolationStyleById:Zo,edgeColorMode:Mt,edgeColorExpression:xs,edgeWeightExpression:Zn},Ae,J,le),ye.filter(c=>e.has(c.id)).forEach(c=>{let l=!1;kt.has(c.id)&&kt.get(c.id).some(h=>h.copyIndex===void 0)&&(l=!0),$i(Oe,c,{selectedVertexIds:Ce,selectedCenterIds:Ye,activeCenterId:rt,colors:t,verticesVisible:Wi,isHovered:yn===c.id,isSnapped:l,snappedVertexIds:kt,isDragConfirmed:!1,dragPreviewVertices:[],currentAltPressed:Pt},Ae)})}function ii(e,t,n,s=!1,i=null){const o=$e(t),a=i||Br(e.id),r=ir/pe.scale,c=rr/pe.scale,l=oe?.alpha2>=oe?.alpha1&&oe?.interval2?oe.interval2:oe?.interval1,d=Je*2/pe.scale,h=Je/pe.scale,f=Je*2/pe.scale,u=Je*2/pe.scale,p=ot&&Be.length>=1;if(n){const g=[];let y=!1;for(const S of ye)if(S.id!==e.id&&S.type==="regular"&&re(o,S)<r){y=!0;break}if(!y)for(const S of U){const M=J(S.id1),b=J(S.id2);if(M&&b&&M.type==="regular"&&b.type==="regular"&&Lt(o,M,b).distance<c){y=!0;break}}if(p){if(ye.forEach(I=>{if(I.id!==e.id&&I.type==="regular"){const P=re(o,I);g.push({priority:1,dist:P,pos:I,snapType:"vertex",targetVertex:I})}}),U.forEach(I=>{const P=J(I.id1),L=J(I.id2);P&&L&&P.type==="regular"&&L.type==="regular"&&P.id!==e.id&&L.id!==e.id&&Lt(o,P,L).distance<h*1.5&&Ll.forEach(_=>{const D={x:P.x+_*(L.x-P.x),y:P.y+_*(L.y-P.y)},O=re(o,D);g.push({priority:2,dist:O,pos:D,snapType:"edge_fraction",targetEdge:I,fraction:_})})}),xt!=="none"&&l){const I=oe?.alpha2>=oe?.alpha1&&oe?.interval2?oe.interval2:oe.interval1;I&&ps(o,xt,I,Tn,!0).forEach(L=>{const A=re(o,L);g.push({priority:3,dist:A,pos:L,snapType:"grid"})})}const S=a.currentSegmentReferenceA_for_display,M=a.currentSegmentReferenceD,b=new Set([0,...ur.flatMap(I=>[I,-I])]),C=Array.from(b).sort((I,P)=>I-P).map(I=>({factor:I,angle:Rn(a.offsetAngleRad+I*S),turn:mt(I*S)})),v=re(e,o),T=[];if([0,...cs].forEach(I=>T.push({factor:I,dist:I*M})),M>xe){const I=v/M,P=Math.round(I),L=Math.round(I*2)/2;[P,L].forEach(A=>{A>=0&&!T.some(_=>Math.abs(_.factor-A)<xe)&&T.push({factor:A,dist:A*M})})}if(T.sort((I,P)=>I.dist-P.dist),C.length>0&&T.length>0)for(const I of C)for(const P of T){if(P.dist<xe&&(I.factor!==0||T.length>1))continue;const L={x:e.x+P.dist*Math.cos(I.angle),y:e.y+P.dist*Math.sin(I.angle)},A=re(o,L);g.push({priority:4,dist:A,pos:L,snapType:"geometric",lengthSnapFactor:P.factor,angleSnapFactor:I.factor,angleTurn:I.turn})}}else if(!y&&xt!=="none"&&l){const S=oe?.alpha2>=oe?.alpha1&&oe?.interval2?oe.interval2:oe.interval1;if(S){const M=ps(o,xt,S,Tn,!0);if(M.length>0){const b=M.sort((E,C)=>re(o,E)-re(o,C))[0];g.push({priority:3,dist:re(o,b),pos:b,snapType:"grid"})}}}let m=null;if(g.length>0)if(!p)m=g[0];else{let S=!1;for(let M=1;M<=3;M++){let b;M===1?b=d:M===2?b=h:b=f;const E=g.filter(C=>C.priority===M&&C.dist<b);if(E.length>0){m=E.sort((C,v)=>C.dist-v.dist)[0],S=!0;break}}if(!S){const M=g.filter(b=>b.priority===4);if(M.length>0){const b=M.sort((E,C)=>E.dist-C.dist)[0];b.dist<u&&(m=b)}}m||(m=g.sort((M,b)=>M.dist-b.dist)[0])}if(m){const S=Math.atan2(m.pos.y-e.y,m.pos.x-e.x)||0,M=parseFloat(re(e,m.pos).toFixed(10));let b=null,E=null;if(m.snapType==="grid"&&l){const v=oe?.alpha2>=oe?.alpha1&&oe?.interval2?oe.interval2:oe.interval1;if(v){const T=m.pos.x-e.x,w=m.pos.y-e.y,I=v*1e-5;if(xt==="triangular"){const P=v*ar,L=w/P,A=Math.round(L),_=A%2!==0?v/2:0,D=(T-_)/v;if(Math.abs(L-A)<I/P&&Math.abs(D-Math.round(D))<I/v){const O=A,X=Math.round(D);b=X*X+X*O+O*O,E=v}}else{const P=T/v,L=w/v;if(Math.abs(P-Math.round(P))<I/v&&Math.abs(L-Math.round(L))<I/v){const A=Math.round(P),_=Math.round(L);b=A*A+_*_,E=v}}}}let C=m.angleTurn!=null?m.angleTurn:mt(S-a.offsetAngleRad);return{x:parseFloat(m.pos.x.toFixed(ol)),y:parseFloat(m.pos.y.toFixed(ol)),angle:S*(180/Math.PI),distance:M,snapped:!0,snapType:m.snapType,targetEdge:m.targetEdge,fraction:m.fraction,targetVertex:m.targetVertex,gridSnapped:m.snapType==="grid",lengthSnapFactor:m.lengthSnapFactor||null,angleSnapFactor:m.angleSnapFactor||null,angleTurn:C,gridToGridSquaredSum:b,gridInterval:E}}const x=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:x*(180/Math.PI),distance:re(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:mt(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const g=[];for(const x of ye)if(x.id!==e.id&&x.type==="regular"){const S=re(o,x);S<r&&g.push({priority:1,dist:S,pos:x,snapType:"vertex",targetVertex:x})}for(const x of U){const S=J(x.id1),M=J(x.id2);if(S&&M&&S.type==="regular"&&M.type==="regular"){const b=Lt(o,S,M);b.distance<c&&b.onSegmentStrict&&g.push({priority:2,dist:b.distance,pos:{x:b.x,y:b.y},snapType:"edge",targetEdge:x})}}let y=null;if(g.length>0){y=g.sort((S,M)=>S.priority!==M.priority?S.priority-M.priority:S.dist-M.dist)[0];const x=y.priority===1?d:h;y.dist>x&&(y=null)}if(y){const x=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:x*(180/Math.PI),distance:re(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:mt(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const m=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:m*(180/Math.PI),distance:re(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:mt(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function vu(e,t,n){const s=[],i=ir/pe.scale,o=rr/pe.scale;if(ye.forEach(a=>{if(a.id!==e.id&&a.type==="regular"){const r=re(t,a);r<i&&s.push({priority:1,dist:r,pos:a,snapType:"vertex",targetVertex:a})}}),U.forEach(a=>{if(a.id1===e.id||a.id2===e.id)return;const r=J(a.id1),c=J(a.id2);if(r&&c&&r.type==="regular"&&c.type==="regular"){const l=Lt(t,r,c);l.distance<o&&l.onSegmentStrict&&s.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:a})}}),s.length>0){const a=s.sort((r,c)=>r.priority!==c.priority?r.priority-c.priority:r.dist-c.dist)[0];return{pos:a.pos,snapped:!0,snapType:a.snapType,targetEdge:a.targetEdge,targetVertex:a.targetVertex}}return{pos:t,snapped:!1}}function Mu(){we=we.map(e=>e.type==="color"?{...e,value:Dh(e.value)}:e)}function Eu(){j.toolbarButton={id:"toolbar-button",x:ct,y:ct,width:Xd,height:Yd,type:"menuButton"}}function vc(){const e=Te.height/Ke;j.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:He,height:e,type:"toolbar"};const t=ct;let n=j.toolbarButton.y+j.toolbarButton.height+Gd;j.colorToolButton={id:"color-tool-button",type:"toolButton",x:ct,y:n,width:He-2*ct,height:_t},n+=_t+t,j.colorModeToolButton={id:"color-mode-tool-button",type:"toolButton",x:ct,y:n,width:He-2*ct,height:_t},n+=_t+t,j.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:ct,y:n,width:He-2*ct,height:_t},n+=_t+t,j.transformToolButton={id:"transform-tool-button",type:"toolButton",x:ct,y:n,width:He-2*ct,height:_t},n+=_t+t,j.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:ct,y:n,width:He-2*ct,height:_t},n+=_t+t,j.sessionsToolButton={id:"sessions-tool-button",type:"toolButton",x:ct,y:n,width:He-2*ct,height:_t}}function At(){j.colorSwatches=[],j.colorTargetIcons=[];const e=fs&&bt,t=(()=>{if(!e)return we.map((x,S)=>S);const u=we.length,p=Math.max(0,Math.min(u-1,bt.originalIndex)),g=Math.max(0,Math.min(u-1,bt.previewIndex??p)),y=we.map((x,S)=>S),[m]=y.splice(p,1);return y.splice(g,0,m),y})(),n=Qo,s=Hs+Co,i=s-n,o=n*2+i,a=He+ct,l=j.colorToolButton.y+_t/2-n/2+-2;let d=a;j.removeColorButton={id:"remove-color-button",type:"button",x:d+(s-n)/2,y:l,width:n,height:n},d+=s;const h=u=>!u||u.type!=="colormap"?!1:Array.isArray(u.vertices)&&u.vertices.length>1;t.forEach((u,p)=>{const g=we[u],y=h(g),m=y?o:n;j.colorSwatches.push({id:`swatch-${u}`,type:"colorSwatch",x:d+(s-n)/2,y:l,width:m,height:n,index:u,positionIndex:p,item:g}),d+=y?s*2:s}),j.addColorButton={id:"add-color-button",type:"button",x:d+(s-n)/2,y:l,width:n,height:n},Object.entries(Re).forEach(([u,p])=>{const g=n*.75,y=j.colorSwatches.find(m=>m.index===p);y&&j.colorTargetIcons.push({id:`target-icon-${u}`,type:"colorTargetIcon",target:u,x:y.x+(y.width-g)/2,y:y.y-g-5,width:g,height:g})});const f=[...j.colorSwatches,j.removeColorButton,j.addColorButton,...j.colorTargetIcons].filter(Boolean);if(f.length>0){const u=Math.min(...f.map(m=>m.y)),p=Math.max(...f.map(m=>m.x+m.width)),g=Math.max(...f.map(m=>m.y+m.height)),y=5;j.colorPaletteBounds={x:He,y:u-y,width:p-He+y,height:g-u+y*2}}else j.colorPaletteBounds=null}function Rr(){if(j.colorModeIcons=[],!j.colorModeToolButton)return;const e=He+ct,t=j.colorModeToolButton.y+_t/2,n=Qo,i=t-n/2+-2,o=Hs+Co,a=o-n,r=n*2+a,c=n*5+a*4,l=(o-n)/2,d=["inherit_vertices","colormap"],h=["inherit_vertices","inherit_edges","colormap_xy"],f=lo(),u=co(),p=f.length>0,g=u.length>0,y=p?f.includes(Yn)?Yn:f[0]:Mt,m=g?u.includes(Gn)?Gn:u[0]:Tt,x=f.length>0?f:[y],S=u.length>0?u:[m];j.colorModeExprFields=[];let M=e;const b=(v,T)=>{j.colorModeIcons.push({id:`${v}-color-mode-${T}`,type:"colorModeIcon",group:v,mode:T,x:M+l,y:i,width:n,height:n})},E=(v,T,w,I)=>{j.colorModeExprFields.push({id:`${v}-color-expr-${T}`,type:"colorModeExprField",group:v,mode:T,x:M+o+l,y:i,width:w,height:n,baseWidth:I,stepWidth:o}),M=M+o+l+w+l};d.forEach(v=>{if(b("edge",v),x.includes(v)){const T=ja[v]||r;E("edge",v,T,r)}else M+=o}),h.forEach(v=>{if(b("face",v),S.includes(v)){const T=Ua[v]||c;E("face",v,T,c)}else M+=o});const C=[...j.colorModeIcons,...j.colorModeExprFields].filter(Boolean);if(C.length>0){const v=Math.min(...C.map(P=>P.y)),T=Math.max(...C.map(P=>P.x+P.width)),w=Math.max(...C.map(P=>P.y+P.height)),I=5;j.colorModePanelBounds={x:He,y:v-I,width:T-He+I,height:w-v+I*2}}else j.colorModePanelBounds=null}function Lr(){if(j.interpolationIcons=[],!j.interpolationToolButton)return;const e=He+ct,t=j.interpolationToolButton.y+_t/2,n=Qo,i=t-n/2+-2,o=Hs+Co;let a=e;j.interpolationIcons.push({id:"interpolation-remove",type:"interpolationRemove",x:a+(o-n)/2,y:i,width:n,height:n}),a+=o,pn.forEach(c=>{j.interpolationIcons.push({id:`interpolation-${c.id}`,type:"interpolationStyle",styleId:c.id,x:a+(o-n)/2,y:i,width:n,height:n}),a+=o}),j.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:a+(o-n)/2,y:i,width:n,height:n});const r=j.interpolationIcons.filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;j.interpolationPanelBounds={x:He,y:c-h,width:l-He+h,height:d-c+h*2}}else j.interpolationPanelBounds=null}function Cu(){if(j.displayIcons=[],!j.visibilityToolButton)return;const e=Hs+Co,t=He+ct,n=j.visibilityToolButton.y+_t/2,s=Qo,o=n-s/2+-2;let a=t;if(["coords","grid","angles","distances","theme"].forEach(c=>{j.displayIcons.push({id:`display-icon-${c}`,group:c,x:a+(e-s)/2,y:o,width:s,height:s}),a+=e}),j.displayIcons.length>0){const c=j.displayIcons[0],l=j.displayIcons[j.displayIcons.length-1],d=5;j.displayPanelBounds={x:He,y:c.y-d,width:l.x+l.width-He+d,height:c.height+d*2}}else j.displayPanelBounds=null}function ai(){if(j.sessionIcons=[],!j.sessionsToolButton)return;const e=He+ct,t=j.sessionsToolButton.y+_t/2,n=Qo,i=t-n/2+-2,o=Hs+Co;let a=e;j.removeSessionButton={id:"remove-session-button",type:"button",x:a+(o-n)/2,y:i,width:n,height:n},a+=o,Ve.forEach((c,l)=>{j.sessionIcons.push({id:`session-${c.id}`,type:"sessionIcon",x:a+(o-n)/2,y:i,width:n,height:n,index:l,session:c}),a+=o}),j.addSessionButton={id:"add-session-button",type:"button",x:a+(o-n)/2,y:i,width:n,height:n};const r=[...j.sessionIcons,j.removeSessionButton,j.addSessionButton].filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;j.sessionsPanelBounds={x:He,y:c-h,width:l-He+h,height:d-c+h*2}}else j.sessionsPanelBounds=null}function Tu(){j.transformIcons=[];const e=Hs,t=e+Co,n=He+ct,i=j.transformToolButton.y+_t/2-e/2,o=[mn,ts,vn,Ms];let a=n;if(o.forEach(r=>{j.transformIcons.push({id:`transform-icon-${r}`,type:r,x:a+(t-e)/2,y:i,width:e,height:e}),a+=t}),j.transformIcons.length>0){const r=j.transformIcons[0],c=j.transformIcons[j.transformIcons.length-1],l=5;j.transformPanelBounds={x:He,y:r.y-l,width:c.x+c.width-He+l,height:r.height+l*2}}else j.transformPanelBounds=null}function tr(e){e<0||e>=we.length||we.length<=1||(we.splice(e,1),Bt!==null&&(Bt===e?Bt=Math.min(e,we.length-1):Bt>e&&(Bt-=1)),Object.keys(Re).forEach(t=>{Re[t]>e?Re[t]--:Re[t]===e&&(Re[t]=Math.min(e,we.length-1))}),At())}function wu(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}we.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(we.push(e),gt&&At())}function Mc(e,t=[]){const n=J(e);if(!n)return null;for(let s=U.length-1;s>=0;s--){const i=U[s],o=le(i);if(t.includes(o))continue;let a=null;if(i.id1===e?a=i.id2:i.id2===e&&(a=i.id1),a){const r=J(a);if(r){const c=n.x-r.x,l=n.y-r.y;return{p1:r,p2:n,angleRad:Math.atan2(l,c),length:Math.sqrt(c*c+l*l),edgeId:o}}}}return null}function nt(){const e=li();we.length,we[0]?.value,ye.length,wt.push(e),wt.length>fr&&wt.shift(),hs=[],Qt()}function Nr(e){const t=j.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!ls)return!1;const n=[];j.mainToolbar&&n.push(j.mainToolbar),gt&&j.colorPaletteBounds&&n.push(j.colorPaletteBounds),cn&&j.interpolationPanelBounds&&n.push(j.interpolationPanelBounds),kn&&j.transformPanelBounds&&n.push(j.transformPanelBounds),In&&j.displayPanelBounds&&n.push(j.displayPanelBounds),vt&&j.sessionsPanelBounds&&n.push(j.sessionsPanelBounds),dn&&j.colorModePanelBounds&&n.push(j.colorModePanelBounds);for(const i of n)if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;const s=[];gt&&j.colorPaletteBounds&&s.push(j.colorPaletteBounds),cn&&j.interpolationPanelBounds&&s.push(j.interpolationPanelBounds),kn&&j.transformPanelBounds&&s.push(j.transformPanelBounds),In&&j.displayPanelBounds&&s.push(j.displayPanelBounds),vt&&j.sessionsPanelBounds&&s.push(j.sessionsPanelBounds),dn&&j.colorModePanelBounds&&s.push(j.colorModePanelBounds),s.sort((i,o)=>i.y-o.y);for(let i=0;i<s.length-1;i++){const o=s[i],a=s[i+1],r=o.y+o.height,c=a.y;if(e.y>r&&e.y<c){const l=He,d=o.x+o.width-l,h=a.x+a.width-l,f=Math.min(d,h),u=l+f;if(e.x<He||e.x>=l&&e.x<=u)return!0}}return!1}function ri(e){ye=JSON.parse(JSON.stringify(e.vertices)),U=JSON.parse(JSON.stringify(e.edges)),ie=JSON.parse(JSON.stringify(e.faces||[])),We=JSON.parse(JSON.stringify(e.textElements||[])),Ce=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),be=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),ge=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),_e=JSON.parse(JSON.stringify(e.selectedTextIds||[])),Ye=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),Qe=JSON.parse(JSON.stringify(e.activeColorTargets||[])),pn=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(En))],Bs=e.activeInterpolationStyleId||pn[0]?.id||En.id,we=e.allColors?JSON.parse(JSON.stringify(e.allColors)):ia.map(n=>typeof n=="string"?{type:"color",value:n}:n),Re=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[et]:0,[tt]:1,[at]:2,[Ht]:0},Mt=e.edgeColorMode||"colormap",Tt=e.faceColorMode||"colormap_xy",xs=e.edgeColorExpression||"x",Ss=e.faceColorExpression||"x",Rs=e.faceColorPolarExpression||"r",!e.edgeWeightExpression||e.edgeWeightExpression==="1/(r+0.001)"?Zn="1-r":Zn=e.edgeWeightExpression,Is=e.faceVertexWeightExpression||Is,bs=e.faceEdgeWeightExpression||bs,U.forEach(n=>{(!n.directionFrom||!n.directionTo)&&(n.directionFrom=n.id1,n.directionTo=n.id2)}),Mt==="fixed"&&(Mt="colormap"),Tt==="fixed"&&(Tt="colormap_xy"),Tt==="colormap_polar"&&(Tt="colormap_xy",(!e.faceColorExpression||e.faceColorExpression.trim()==="")&&Rs&&(Ss=Rs)),ie.forEach(n=>{n.colorMode==="fixed"&&(n.colorMode="colormap_xy"),n.colorMode==="colormap_polar"&&(n.colorMode="colormap_xy")}),U.forEach(n=>{n.colorMode==="fixed"&&(n.colorMode="colormap")}),Re[Ht]===void 0&&(Re[Ht]=0),Za(),rt=e.activeCenterId!==void 0?e.activeCenterId:null,ot=e.isDrawingMode!==void 0?e.isDrawingMode:!1,St=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,jt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,ys=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,Et=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,Un=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,ms=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,ro=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,Ut=!1,ze=!1,Cn=!1,Kn=!1,De=[],Ui=null,tn=-1,Ee={targetId:null,type:null,count:0,timestamp:0},Te.style.cursor="crosshair",gt&&At();const t=li();wt.length===0&&wt.push(t),Qt()}function li(){return{vertices:JSON.parse(JSON.stringify(ye)),edges:JSON.parse(JSON.stringify(U)),faces:JSON.parse(JSON.stringify(ie)),textElements:JSON.parse(JSON.stringify(We)),selectedVertexIds:JSON.parse(JSON.stringify(Ce)),selectedEdgeIds:JSON.parse(JSON.stringify(be)),selectedFaceIds:JSON.parse(JSON.stringify(ge)),selectedTextIds:JSON.parse(JSON.stringify(_e)),selectedCenterIds:JSON.parse(JSON.stringify(Ye)),activeColorTargets:JSON.parse(JSON.stringify(Qe)),interpolationStyles:JSON.parse(JSON.stringify(pn)),activeInterpolationStyleId:Bs,colorAssignments:JSON.parse(JSON.stringify(Re)),edgeColorMode:Mt,faceColorMode:Tt,edgeColorExpression:xs,faceColorExpression:Ss,faceColorPolarExpression:Rs,edgeWeightExpression:Zn,faceVertexWeightExpression:Is,faceEdgeWeightExpression:bs,allColors:JSON.parse(JSON.stringify(we)),activeCenterId:rt,isDrawingMode:ot,previewLineStartVertexId:St,frozenReference_A_rad:jt,frozenReference_A_baseRad:ys,frozenReference_D_du:Et,frozenReference_Origin_Data:Un,frozenReference_D_g2g:ms,deletedFaceIds:new Set(ro)}}function Ec(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function Pu(){try{const e=new URLSearchParams(window.location.search);return Ec(e.get("user"))}catch{return""}}function Cc(){if(xn)return xn;const e=Pu();if(e){xn=e;try{localStorage.setItem(Ra,xn)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return xn}try{xn=localStorage.getItem(Ra)}catch{xn=null}if(!xn){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}xn=Ec(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(Ra,xn)}catch(s){console.warn("Could not persist user id to localStorage.",s)}}return xn}function Tc(){const e=Cc();return`${Tr}.state.v${Yi}.${e}`}function wc(){const e=Cc();return`${Tr}.sessions.v${Yi}.${e}`}function Pc(){return{vertices:[],edges:[],faces:[],textElements:[],selectedVertexIds:[],selectedEdgeIds:[],selectedFaceIds:[],selectedTextIds:[],selectedCenterIds:[],activeColorTargets:[],interpolationStyles:[JSON.parse(JSON.stringify(En))],activeInterpolationStyleId:En.id,colorAssignments:{[et]:0,[tt]:1,[at]:2,[Ht]:0},edgeColorMode:"colormap",faceColorMode:"colormap_xy",edgeColorExpression:"x",faceColorExpression:"x",faceColorPolarExpression:"r",allColors:ia.map(e=>typeof e=="string"?{type:"color",value:e}:e),activeCenterId:null,isDrawingMode:!1,previewLineStartVertexId:null,frozenReference_A_rad:null,frozenReference_A_baseRad:null,frozenReference_D_du:null,frozenReference_Origin_Data:null,frozenReference_D_g2g:null,deletedFaceIds:[]}}function ci(){if(!Ve.length)return;const e=Ve[Rt];e&&(e.state=Fr())}function Or(e,t=""){return{id:$t(),name:t,state:JSON.parse(JSON.stringify(e))}}function Fr(){const e=li();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function Ac(){if(!window.localStorage)return;const e=Tc(),t={version:Yi,savedAt:Date.now(),state:Fr()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}if(Ve.length>0){ci();const n=wc(),s={version:Yi,savedAt:Date.now(),activeSessionIndex:Rt,sessions:Ve.map(i=>({...i,state:JSON.parse(JSON.stringify(i.state))}))};try{localStorage.setItem(n,JSON.stringify(s))}catch(i){console.warn("Could not persist sessions to localStorage.",i)}}}function Qt(){window.localStorage&&(xi&&clearTimeout(xi),xi=setTimeout(()=>{xi=null,Ac()},300))}function Au(){if(!window.localStorage)return!1;const e=Tc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(ri(n.state),Zt(),fc=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function _u(){if(!window.localStorage)return!1;const e=wc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!Array.isArray(n.sessions)||n.sessions.length===0?!1:(Ve=n.sessions.map(s=>({id:s.id||$t(),name:s.name||"",state:s.state||Pc()})),Rt=Math.min(Math.max(n.activeSessionIndex||0,0),Ve.length-1),Nt=Rt,wt=[],hs=[],ri(Ve[Rt].state),Zt(),fc=!0,!0)}catch(t){return console.warn("Could not load sessions from localStorage.",t),!1}}function Du(){const e=Fr();Ve=[Or(e,"World 1")],Rt=0,Nt=0}function Ks(e){e<0||e>=Ve.length||(ci(),Rt=e,Nt=e,wt=[],hs=[],ri(Ve[Rt].state),Zt(),vt&&ai(),Qt())}function ku(){ci();const e=Or(Pc(),`World ${Ve.length+1}`),t=Nt!==null?Nt+1:Ve.length;Ve.splice(t,0,e),Ks(t)}function Ru(){if(!Yo||!Yo.state)return;ci();const e=Or(Yo.state,`World ${Ve.length+1}`),t=Nt!==null?Nt+1:Ve.length;Ve.splice(t,0,e),Ks(t)}function _c(e){if(e<0||e>=Ve.length||(ci(),Ve.length===1))return;const t=e<Ve.length-1?e:e-1,[n]=Ve.splice(e,1);Ji.push({session:n,index:e}),Rt===e?(Rt=-1,Nt=-1,Ks(Math.max(0,Math.min(t,Ve.length-1)))):(Rt>e&&(Rt-=1),Nt>e&&(Nt-=1),vt&&ai(),Qt())}function Lu(){if(!Ji.length)return!1;const{session:e,index:t}=Ji.pop(),n=Math.max(0,Math.min(t,Ve.length));return Ve.splice(n,0,e),Ks(n),!0}function Nu(){if(!Ve.length)return;const e=(Nt+1)%Ve.length;Ks(e)}function Ou(){if(!Ve.length)return;const e=(Nt-1+Ve.length)%Ve.length;Ks(e)}function ea(){ie.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=ie.map(t=>{const n=t.vertexIds.map(s=>J(s));return n.some(s=>!s)?null:{face:t,vertices:n,area:Math.abs(la(n))}}).filter(Boolean);e.forEach(t=>{let n=null,s=1/0;e.forEach(i=>{if(t.face.id===i.face.id||i.area<=t.area)return;const o=t.face.vertexIds,a=o.map(c=>J(c));if(a.some(c=>!c))return;if(Xh(a,i.vertices)){const c=new Set(o),l=U.filter(h=>c.has(h.id1)&&c.has(h.id2));!Yh(l,i.vertices,J)&&i.area<s&&(s=i.area,n=i.face)}}),n&&(t.face.parentFaceId=n.id)}),ie.forEach(t=>{if(t.parentFaceId){const n=ie.find(s=>s.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function $e(e){const t=e.x*Ke,n=e.y*Ke,s=Te.height;return{x:(t-pe.offsetX)/pe.scale,y:(s-n-pe.offsetY)/pe.scale}}function Ae(e){const t=Te.height,n=e.x*pe.scale+pe.offsetX,s=t-(e.y*pe.scale+pe.offsetY);return{x:n/Ke,y:s/Ke}}function J(e){return ye.find(t=>t.id===e)}function Ws(e){if(!J(e))return[];const t=new Set,n=[e],s=[];for(t.add(e);n.length>0;){const i=n.shift();s.push(i),Sn(i,U).forEach(o=>{t.has(o)||(t.add(o),n.push(o))})}return s}function bo(e){const t=$e(e),n=Je*2/pe.scale,s=(sa+Je)/pe.scale;for(let i=ye.length-1;i>=0;i--){const o=ye[i];if(o.type!=="regular"&&re(t,o)<s)return o}for(let i=ye.length-1;i>=0;i--){const o=ye[i];if(o.type==="regular"&&re(t,o)<n)return o}return null}function vo(e){const t=$e(e),n=rr/pe.scale;for(let s=U.length-1;s>=0;s--){const i=U[s],o=J(i.id1),a=J(i.id2);if(o&&a&&o.type==="regular"&&a.type==="regular"){const r=Lt(t,o,a);if(r.distance<n&&r.onSegmentStrict)return i}}return null}function Mo(e){const t=$e(e),n=[];for(const o of ie){if(o.color==="transparent")continue;const a=o.vertexIds.map(r=>J(r)).filter(r=>r&&r.type==="regular");a.length<3||Os(t,a)&&n.push(o)}if(n.length===0)return null;let s=null,i=1/0;for(const o of n){let a=!1;if(o.childFaceIds&&o.childFaceIds.length>0)for(const r of o.childFaceIds){const c=ie.find(l=>l.id===r);if(c&&c.color==="transparent"){const l=c.vertexIds.map(d=>J(d)).filter(Boolean);if(l.length>=3&&Os(t,l)){a=!0;break}}}if(!a){const r=o.vertexIds.map(c=>J(c));if(r.every(Boolean)){const c=Math.abs(la(r));c<i&&(i=c,s=o)}}}return s}function nr(e){return U.filter(t=>t.id1===e||t.id2===e)}function Fu(){Ce.length===0&&be.length===0&&Ye.length===0||(nt(),Dc(),di())}function Dc(){const e=new Set(Ce);rt&&e.add(rt);const t=[];ge.length>0&&ge.forEach(o=>{const a=ie.find(r=>ue(r)===o);a&&(t.push(a),a.vertexIds.forEach(r=>e.add(r)))}),be.forEach(o=>{const[a,r]=o.split(fo);e.add(a),e.add(r)}),zt.vertices=Array.from(e).map(o=>{const a=J(o);return a?{...a}:null}).filter(o=>o),zt.edges=[],U.forEach(o=>{e.has(o.id1)&&e.has(o.id2)&&zt.edges.push({...o})}),zt.faces=t.map(o=>JSON.parse(JSON.stringify(o)));const n=new Set(_e),s=new Set(ge),i=new Set(be);zt.texts=We.filter(o=>{if(n.has(o.id))return!0;if(o.anchorType==="vertex")return e.has(o.anchorId);if(o.anchorType==="edge"){if(i.has(o.anchorId))return!0;const a=U.find(r=>le(r)===o.anchorId);return a?e.has(a.id1)&&e.has(a.id2):!1}if(o.anchorType==="face"){if(s.has(o.anchorId))return!0;const a=ie.find(r=>ue(r)===o.anchorId);return a?a.vertexIds.every(r=>e.has(r)):!1}return!1}).map(o=>JSON.parse(JSON.stringify(o))),zt.referenceVertex=$e(te)}function Bu(){if(zt.vertices.length===0||!zt.referenceVertex)return;nt();const e=$e(te),t=e.x-zt.referenceVertex.x,n=e.y-zt.referenceVertex.y,s=new Map,i=[];let o=null;vs(),zt.vertices.forEach(c=>{const l=$t(),d={...c,id:l,x:c.x+t,y:c.y+n};ye.push(d),s.set(c.id,l),d.type==="regular"?i.push(l):o=l}),zt.edges.forEach(c=>{const l=s.get(c.id1),d=s.get(c.id2);l&&d&&U.push({...c,id1:l,id2:d})});const a=[];zt.faces.forEach(c=>{const l=c.vertexIds.map(d=>s.get(d)).filter(Boolean);if(l.length===c.vertexIds.length){const d={...c,id:ue({vertexIds:l}),vertexIds:l};d.localCoordSystem&&(d.localCoordSystem.origin.x+=t,d.localCoordSystem.origin.y+=n,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=s.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=s.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=s.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=s.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=s.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=s.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=s.get(d.localCoordSystem.scaleAttachedToEdge.v2))),d.parentFaceId=null,d.childFaceIds=[],ie.push(d),a.push(d.id)}}),Es();const r=[];zt.texts.forEach(c=>{const l=JSON.parse(JSON.stringify(c));if(l.id=$t(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const d=s.get(l.anchorId);if(!d)return;l.anchorId=d}else if(l.anchorType==="edge"){const d=U.find(u=>le(u)===l.anchorId);if(!d)return;const h=s.get(d.id1),f=s.get(d.id2);if(!h||!f)return;l.anchorId=le({id1:h,id2:f})}else if(l.anchorType==="face"){const d=ie.find(f=>ue(f)===l.anchorId);if(!d)return;const h=d.vertexIds.map(f=>s.get(f));if(!h.every(Boolean))return;l.anchorId=ue({vertexIds:h})}We.push(l),r.push(l.id)}),Ce=i,be=zt.edges.map(c=>le({id1:s.get(c.id1),id2:s.get(c.id2)})),ge=a,_e=r,rt=o,Zt()}function di(){const e=new Set(Ce),t=new Set(Ye),n=new Set(be),s=new Set(ge),i=new Set(_e);if(e.size===0&&t.size===0&&n.size===0&&s.size===0&&i.size===0)return;if(nt(),s.size>0){const l=new Set;ie.forEach(d=>{const h=d.id||ue(d);s.has(h)&&(ro.add(h),d.childFaceIds&&d.childFaceIds.length>0&&d.childFaceIds.forEach(f=>{const u=ie.find(p=>p.id===f);u&&(u.parentFaceId=null)}),d.parentFaceId?d.color="transparent":l.add(h))}),l.size>0&&(ie=ie.filter(d=>!l.has(d.id||ue(d))))}const o=[...U];if(n.size>0&&(U=U.filter(l=>!n.has(le(l)))),e.size>0){const l=JSON.parse(JSON.stringify(U)),d=[],h=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1,f=new Set(e);for(;f.size>0;){const u=f.values().next().value,p=new Set,g=[u];for(;g.length>0;){const S=g.shift();f.has(S)&&(p.add(S),f.delete(S),Sn(S,U).forEach(b=>{f.has(b)&&g.push(b)}))}const y=U.filter(S=>p.has(S.id1)&&!p.has(S.id2)||p.has(S.id2)&&!p.has(S.id1)),m=new Set;y.forEach(S=>{p.has(S.id1)||m.add(S.id1),p.has(S.id2)||m.add(S.id2)});const x=Array.from(m);if(x.length===2){const[S,M]=x,b=J(S),E=J(M),C=U.some(v=>v.id1===S&&v.id2===M||v.id1===M&&v.id2===S);if(b&&E&&!C){const v=Fs(b,E,h,qe);es(v,Mt),Gs(v),d.push(v)}}}ye=ye.filter(u=>!e.has(u.id)),U=U.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),d.length>0&&(U.push(...d),zs(l,U),Es())}zs(o,U),t.size>0&&(ye=ye.filter(l=>!t.has(l.id))),i.size>0&&(We=We.filter(l=>!i.has(l.id)));const a=new Set(ye.map(l=>l.id)),r=new Set(U.map(l=>le(l))),c=new Set(ie.map(l=>ue(l)));We=We.filter(l=>l.anchorType==="vertex"?a.has(l.anchorId):l.anchorType==="edge"?r.has(l.anchorId):l.anchorType==="face"?c.has(l.anchorId):!0),_e=_e.filter(l=>We.some(d=>d.id===l)),vs(),Zt()}function ta(e,t){let n=pe.scale*t;n<Zr&&(n=Zr),n>Qr&&(n=Qr);const s=n/pe.scale,i=e.x*Ke,o=e.y*Ke;pe.offsetX=i*(1-s)+pe.offsetX*s,pe.offsetY=(Te.height-o)*(1-s)+pe.offsetY*s,pe.scale=n}function $u(e){pe.offsetX+=e.x*Ke,pe.offsetY-=e.y*Ke}function Br(e){let t=0,n,s=Math.PI/2,i=!0;const o=J(e);if(!o)return i=!0,xt!=="none"&&oe.interval1?n=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1:n=Va,Et!==null&&(n=Et),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=Mc(o.id);return a?(i=!1,t=a.angleRad,n=Et!==null?Et:a.length,jt!==null?Math.abs(jt)<xe?s=va:s=Math.abs(jt):s=va):(i=!0,xt!=="none"&&oe.interval1?n=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1:n=Va,Et!==null&&(n=Et),t=0,s=va),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:jt,displayAngleA_originVertexData_for_A_equals_label:Un,frozen_A_baseRad_to_display:ys,frozen_D_du_to_display:Et,frozen_D_g2g_to_display:ms}}function kl(e,t,n){if(!e||!t)return null;const s=Math.atan2(t.y-e.y,t.x-e.x),i=re(e,t);let o=0,a=!0;for(let c=n.length-1;c>=0;c--){const l=n[c];let d=null;if(l.id1===e.id&&J(l.id2)?.type==="regular"?d=l.id2:l.id2===e.id&&J(l.id1)?.type==="regular"&&(d=l.id1),d&&d!==t.id){const h=J(d);if(h){o=Math.atan2(e.y-h.y,e.x-h.x),a=!1;break}}}const r=mt(s-o);return{startVertex:e,endVertex:t,absoluteAngleRad:s,length:i,precedingSegmentAbsoluteAngleRad:o,turnAngleRad:r,isFirstSegmentOfLine:a}}function kc(e,t){const n=new Set,s=[e],i=new Set([e]);for(;s.length>0;){const o=s.shift(),a=t.find(r=>r.id===o);a&&(a.vertexIds.forEach(r=>n.add(r)),a.childFaceIds&&a.childFaceIds.forEach(r=>{i.has(r)||(i.add(r),s.push(r))}))}return Array.from(n)}function Vu(){const e=Ce.filter(i=>{const o=J(i);return o&&o.type==="regular"});if(e.length<2)return;nt();const t=JSON.parse(JSON.stringify(U));let n=!1;const s=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;for(let i=0;i<e.length;i++)for(let o=i+1;o<e.length;o++){const a=e[i],r=e[o];if(!U.some(l=>l.id1===a&&l.id2===r||l.id1===r&&l.id2===a)){const l=J(a),d=J(r);if(l&&d){const h=Fs(l,d,s,qe);es(h,Mt),Gs(h),U.push(h),n=!0}}}n&&Jn&&(zs(t,U),ie.forEach(i=>{i.colorMode=i.colorMode||Tt,oi(i,i.colorMode)}),Es()),Zt()}function Yt(e=[],t=[],n=[],s,i,o=!1,a=[]){if(o)kr(e[0],s,i);else{let r=new Set(Pe.selection.vertices),c=new Set(Pe.selection.edges),l=new Set(Pe.selection.faces),d=new Set(Pe.selection.text);s?(e.forEach(h=>r.add(h)),t.forEach(h=>c.add(h)),n.forEach(h=>l.add(h)),a.forEach(h=>d.add(h))):i?(e.forEach(h=>{r.has(h)?r.delete(h):r.add(h)}),t.forEach(h=>{c.has(h)?c.delete(h):c.add(h)}),n.forEach(h=>{l.has(h)?l.delete(h):l.add(h)}),a.forEach(h=>{d.has(h)?d.delete(h):d.add(h)})):(r=new Set(e),c=new Set(t),l=new Set(n),d=new Set(a)),Pe.selection.vertices=r,Pe.selection.edges=c,Pe.selection.faces=l,Pe.selection.text=d,Ce=Array.from(r),be=Array.from(c),ge=Array.from(l),_e=Array.from(d)}$r(),gc()}function Xu(e,t,n,s,i=0){const o={x:n.x-e.x,y:n.y-e.y},a={x:t.x-e.x,y:t.y-e.y},r=Math.hypot(o.x,o.y),c=Math.hypot(a.x,a.y),l=Math.atan2(o.y,o.x),d=Math.atan2(a.y,a.x);let h=0,f=1,u=!1;if(s===mn)f=1,h=Sl(l,d,i);else if(s===ts)h=0,r>xe&&(f=c/r);else if(s===vn)h=Sl(l,d,i),r>xe&&(f=c/r);else if(s===Ms&&(u=!0,h=0,r>xe)){const p={x:o.x/r,y:o.y/r};f=(a.x*p.x+a.y*p.y)/r}return{rotation:h,scale:f,directionalScale:u}}function zs(e,t){if(!Jn){ie=[],ro.clear();return}const n=new Set(e.map(g=>le(g))),s=new Set(t.map(g=>le(g))),i=t.filter(g=>!n.has(le(g))),o=e.filter(g=>!s.has(le(g)));if(i.length===0&&o.length===0)return;const a=new Set;i.forEach(g=>{a.add(g.id1),a.add(g.id2)}),o.forEach(g=>{a.add(g.id1),a.add(g.id2)});const r=new Set,c=new Set;for(const g of a)c.has(g)||Ws(g).forEach(m=>{r.add(m),c.add(m)});const l=U.filter(g=>r.has(g.id1)&&r.has(g.id2)),d=ie.filter(g=>g.vertexIds.every(y=>r.has(y))),h=da(l,J),f=new Set(d.map(g=>g.id));ie=ie.filter(g=>!f.has(g.id));let u=h;if(h.length>1){const g=h.map(y=>{const m=y.vertexIds.map(x=>J(x));return m.some(x=>!x)?null:{face:y,area:Math.abs(la(m))}}).filter(Boolean);if(g.length>1){g.sort((x,S)=>S.area-x.area);const y=g[0],m=g.slice(1).reduce((x,S)=>x+S.area,0);Math.abs(y.area-m)<xe&&(u=g.slice(1).map(x=>x.face))}}const p=new Set(i.map(g=>le(g)));u.forEach(g=>{let y=!1;if(i.length>0)for(let m=0;m<g.vertexIds.length;m++){const x=g.vertexIds[m],S=g.vertexIds[(m+1)%g.vertexIds.length],M=le({id1:x,id2:S});if(p.has(M)){y=!0;break}}if(ro.has(g.id))if(y)ro.delete(g.id);else return;g.colorMode=g.colorMode||Tt,oi(g,g.colorMode),g.interpolationStyleId||Su(g),g.parentFaceId=null,g.childFaceIds=[],ie.push(g)}),Es()}function Rc(e,t,n,s){const i=J(e.id1),o=J(e.id2);if(!i||!o)return null;const a=[...U],r={id:$t(),x:t.x,y:t.y,type:"regular",color:s(et)};ye.push(r),U=U.filter(h=>le(h)!==le(e));const c=Fs(i,r,n,s),l=Fs(r,o,n,s),d=e?.colorMode||Mt;return es(c,d),es(l,d),Gs(c),Gs(l),U.push(c),U.push(l),Jn&&zs(a,U),r}function Yu(e,t,n,s,i){const o=je(n,e,s,i,!1,null),a={x:n.x-e.x,y:n.y-e.y},r=2*Je/pe.scale,c=t.filter(d=>d.type==="regular"),l=[];if(c.length>0){const d=ye.filter(f=>f.type==="regular"&&!t.some(u=>u.id===f.id)),h=parseInt(Jt||"1",10)||1;for(let f=1;f<=h;f++)c.forEach(u=>{d.forEach(p=>{const g={x:u.x-e.x,y:u.y-e.y},y={x:p.x-e.x,y:p.y-e.y},m=Math.hypot(g.x,g.y),x=Math.hypot(y.x,y.y);if(m>xe){const S=Math.pow(x/m,1/f);let M=Math.atan2(y.y,y.x)-Math.atan2(g.y,g.x);const E=(M+Math.round((s*f-M)/(2*Math.PI))*(2*Math.PI))/f,C=je(n,e,E,S,!1,a),v=re(o,C);l.push({dist:v,rotation:E,scale:S,pos:C})}})})}if(l.length>0){const d=l.sort((h,f)=>h.dist-f.dist)[0];if(d.dist<r)return{...d,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}if(Fe){const d=[],h=[],f=ur.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).sort((x,S)=>Math.abs(mt(s-x))-Math.abs(mt(s-S))),u=cs.filter(x=>x>0).sort((x,S)=>Math.abs(i-x)-Math.abs(i-S)),p=f.slice(0,2),g=u.slice(0,2);p.forEach(x=>{g.forEach(S=>{const M=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI),b=je(n,e,M,S,!1,a);d.push({dist:re(o,b),rotation:M,scale:S,pos:b})})});const y=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;if(y){const x=ps(o,xt,y,Tn,!0),S=Math.hypot(a.x,a.y);x.forEach(M=>{if(S>xe){const b={x:M.x-e.x,y:M.y-e.y},E=Math.hypot(b.x,b.y)/S,C=Math.atan2(b.y,b.x)-Math.atan2(a.y,a.x),v=C+Math.round((s-C)/(2*Math.PI))*(2*Math.PI);h.push({dist:re(o,M),rotation:v,scale:E,pos:M})}})}const m=[...d,...h].sort((x,S)=>x.dist-S.dist)[0];return{...m,snapped:!0,snapType:"geometric",snappedScaleValue:m.scale}}return{rotation:s,scale:i,pos:o,snapped:!1}}function Gu(e,t,n,s,i){const o=parseInt(Jt||"1",10);let a=[];const r=Math.hypot(n.x-e.x,n.y-e.y),c=2*Je/pe.scale,l=t.filter(g=>g.type==="regular"),d=ye.filter(g=>g.type==="regular"&&!t.some(y=>y.id===g.id));if(Array.from({length:o},(g,y)=>y+1).forEach(g=>{l.forEach(y=>{d.forEach(m=>{const x={x:y.x-e.x,y:y.y-e.y},S={x:m.x-e.x,y:m.y-e.y};if(Math.abs(Math.hypot(x.x,x.y)-Math.hypot(S.x,S.y))<xe){let M=Math.atan2(S.y,S.x)-Math.atan2(x.y,x.x);const b=M+Math.round((s*g-M)/(2*Math.PI))*(2*Math.PI);a.push({rotation:b/g,priority:Math.abs(mt(b/g-s)),snapType:"merge"})}})})}),Fe){ur.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).forEach(x=>{const S=Math.abs(mt(s-x)),M=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI);a.push({rotation:M,priority:S,snapType:"geometric"})});const y=new Set(t.map(x=>x.id));let m=ye.filter(x=>x.type==="regular"&&!y.has(x.id));if(oe){const x=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;x&&m.push(...ps(i,xt,x,Tn,!0))}m.forEach(x=>{const S=re(i,x);if(S<ir/pe.scale){const M=Math.atan2(n.y-e.y,n.x-e.x),b=Math.atan2(x.y-e.y,x.x-e.x),E=mt(b-M),C=E+Math.round((s-E)/(2*Math.PI))*(2*Math.PI);a.push({rotation:C,priority:S/1e3,snapType:"projection",projectionSource:x})}})}if(a.length===0)return{rotation:s,snapped:!1,snapType:null};a.sort((g,y)=>g.priority-y.priority);const f=a[0];if(f.snapType==="merge"){const g=je(n,e,f.rotation,1,!1,null);if(re(i,g)>c)return{rotation:s,snapped:!1,snapType:null}}const u=je(n,e,f.rotation,1,!1,null);let p=null;return f.snapType==="projection"&&(p={x:e.x+r*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation),y:e.y+r*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation)}),{rotation:f.rotation,pos:u,snapped:!0,snapType:f.snapType,projectionSource:f.projectionSource||null,projectionPoint:p}}function Wu(e,t,n,s){const i=$e(te),o=2*Je/pe.scale,a=t.filter(c=>c.type==="regular"),r=[];if(a.length>0){const c=ye.filter(h=>h.type==="regular"&&!t.some(f=>f.id===h.id)),l=o/100,d=parseInt(Jt||"1",10);for(let h=1;h<=d;h++)a.forEach(f=>{c.forEach(u=>{const p={x:f.x-e.x,y:f.y-e.y},g={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(p.x,p.y),m=Math.hypot(g.x,g.y);if(y>xe){const x=Math.atan2(p.y,p.x),S=Math.atan2(g.y,g.y);if(Math.abs(mt(x-S))<l){const M=Math.pow(m/y,1/h),b=je(n,e,0,M,!1,null);r.push({scale:M,dist:re(i,b)})}}})})}if(r.length>0){const c=r.sort((l,d)=>l.dist-d.dist)[0];if(c.dist<o){const l=je(n,e,0,c.scale,!1,null);return{...c,pos:l,snapped:!0,snapType:"merge"}}}if(Fe){let c,l,d=1,h=1/0;cs.forEach(g=>{const y=Math.abs(s-g);y<h&&(h=y,d=g)});const f=je(n,e,0,d,!1,null);c={scale:d,pos:f,dist:re(i,f),snapType:"geometric",snappedScaleValue:d};const u=new Set(t.map(g=>g.id)),p=ye.filter(g=>g.type==="regular"&&!u.has(g.id));if(oe){const g=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;g&&p.push(...ps(i,xt,g,Tn,!0))}if(p.length>0){const g=p.reduce((x,S)=>re(i,x)<re(i,S)?x:S),y=Math.hypot(n.x-e.x,n.y-e.y),m=re(e,g);if(y>xe){const x=m/y,S=Math.atan2(n.y-e.y,n.x-e.x),M={x:e.x+m*Math.cos(S),y:e.y+m*Math.sin(S)};l={scale:x,pos:M,dist:re(i,M),snapType:"projection",snappedScaleValue:x,projectionSource:g}}}return l&&re(i,l.projectionSource)<o?{...l,snapped:!0}:{...c,snapped:!0}}return{scale:s,snapped:!1,snapType:null}}function zu(e,t,n,s,i,o){let a=[];const r=2*Je/pe.scale;if(t.filter(l=>l.type==="regular"),Fe){let l=null,d=null,h=1,f=1/0;[...cs,...cs.map(m=>-m)].forEach(m=>{const x=Math.abs(s-m);x<f&&(f=x,h=m)});const p=je(n,e,0,h,!0,i);l={scale:h,pos:p,dist:re(o,p),snapType:"geometric",snappedScaleValue:h};const g=new Set(t.map(m=>m.id)),y=ye.filter(m=>m.type==="regular"&&!g.has(m.id));if(oe){const m=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;m&&y.push(...ps(o,xt,m,Tn,!0))}if(y.length>0){const m=y.reduce((S,M)=>re(o,M)<re(o,S)?M:S),x=Math.hypot(i.x,i.y);if(x>xe){const S={x:i.x/x,y:i.y/x},M=E=>(E.x-e.x)*S.x+(E.y-e.y)*S.y,b=M(n);if(Math.abs(b)>xe){const C=M(m)/b,v=je(n,e,0,C,!0,i);d={scale:C,pos:v,dist:re(o,v),snapType:"projection",snappedScaleValue:C,projectionSource:m}}}}d&&re(o,d.projectionSource)<r?a.push({...d,priority:0}):a.push({...l,priority:1})}return a.length===0?{scale:s,snapped:!1,snapType:null}:{...a.sort((l,d)=>l.priority-d.priority)[0],snapped:!0}}function Hu(e){const t=Te.width/Ke,n=Te.height/Ke,{grid1Interval:s,grid2Interval:i,alpha1:o,alpha2:a}=Wh(pe.scale);oe={interval1:s,interval2:i,alpha1:o,alpha2:a,scale:pe.scale},Tn=zh(pe,t,n,Ae),sf(Oe,{gridDisplayMode:xt,canvas:Te,dpr:Ke,viewTransform:pe,gridAlpha:ou,colors:e},Ae,$e,oe,Tn);let r={useScientific:!1};return Vs!==aa&&(r=Qh(Oe,yt,{canvas:Te,dpr:Ke,coordsDisplayMode:Vs,viewTransform:pe,angleDisplayMode:en,colors:e},Ae,$e,oe,Tn,Ft)),r}function Ku(e){const t=ze&&Ie.length===1&&!st&&Ie[0].type==="regular";if(Ka.forEach(n=>{ze&&Ie.length>0&&[...n].some(i=>Ie.some(o=>o.id===i))||bu(n,e,!1,[],0)}),ye.forEach(n=>{if(n.type!=="regular"){const s=ze&&Ie.some(c=>c.id===n.id);let i=n,o=!1,a=s?0:void 0;if(s&&!t&&De.length>0){const c=De.find(l=>l&&l.originalId===n.id&&l.transformIndex===0);c&&(i=c)}if(kt){const c=n.originalId||n.id;kt.has(c)&&kt.get(c).find(h=>h.copyIndex===a)&&(o=!0)}const r={selectedVertexIds:[],selectedCenterIds:Ye,activeCenterId:rt,colors:e,verticesVisible:!0,isHovered:yn===n.id&&!Pt,isSnapped:o,snappedVertexIds:kt,isDragConfirmed:ze,dragPreviewVertices:De,currentAltPressed:Pt};$i(Oe,i,r,Ae)}}),ze){const s={copyCount:parseInt(Jt||"1",10),isDragConfirmed:ze,initialDragVertexStates:Ie,dragPreviewVertices:De,transformIndicatorData:st,allEdges:U,allFaces:ie,findVertexById:J,findNeighbors:i=>findNeighbors(i),findAllVerticesInSubgraph:i=>Ws(i),colors:e,edgeColorMode:Mt,faceColorMode:Tt,edgeColorExpression:xs,faceColorExpression:Ss,faceColorPolarExpression:Rs,edgeWeightExpression:Zn,faceVertexWeightExpression:Is,faceEdgeWeightExpression:bs,angleDisplayMode:en,initialCoordSystemStates:Hn,getInterpolationStyleById:Zo,snappedEdgesInfo:Xs,snappedVertexIds:kt};t?jh(Oe,s,Ae):qh(Oe,s,Ae)}}function qu(e,t){Sf(yt,{coordsDisplayMode:Vs,isMouseOverCanvas:Uo,currentShiftPressed:Fe,ghostVertexPosition:Ue,gridDisplayMode:xt,lastGridState:oe,angleDisplayMode:en,canvas:Te,dpr:Ke,mousePos:te,colors:e,useScientific:t.useScientific},$e,Ft),gu();const n={dpr:Ke,canvasUI:j,isToolbarExpanded:ls,isColorPaletteExpanded:gt,isColorModePanelExpanded:dn,isInterpolationPanelExpanded:cn,isTransformPanelExpanded:kn,isDisplayPanelExpanded:In,isVisibilityPanelExpanded:fa,isSessionsPanelExpanded:vt,isPlacingTransform:sn,placingTransformType:yo,placingSnapPos:si,mousePos:te,allColors:we,activeThemeName:Jo,colors:e,verticesVisible:Wi,edgesVisible:zi,facesVisible:Jn,coordsDisplayMode:Vs,gridDisplayMode:xt,angleDisplayMode:en,distanceDisplayMode:bi,namedColors:os.namedColors,colorAssignments:Re,activeColorTargets:Qe,lastSelectedSwatchIndex:Bt,interpolationStyles:pn,activeInterpolationStyleId:Bs,sessions:Ve,activeSessionIndex:Rt,selectedSessionIndex:Nt,edgeColorMode:Mt,faceColorMode:Tt,edgeColorExpression:xs,faceColorExpression:Ss,edgeWeightExpression:Zn,faceVertexWeightExpression:Is,faceEdgeWeightExpression:bs,selectedEdgeModes:lo(),selectedFaceModes:co(),isDraggingColorTarget:ao,draggedColorTargetInfo:Wt};n.selectedInterpolationStyleId=mc(),Nf(Oe,yt,n,Ft)}function Lc(){wr.clear();const e=ua();Hh(Oe,{canvas:Te,dpr:Ke,colors:e}),Ku(e),jl(Oe,{allFaces:ie,hoveredFaceId:Vt,selectedFaceIds:ge,colors:e,isDragConfirmed:ze,dragPreviewVertices:De,currentAltPressed:Pt},Ae,J,ue),ge.length>0&&ic(Oe,{allFaces:ie,selectedFaceIds:ge,colors:e,isDragConfirmed:ze,dragPreviewVertices:De,initialDragVertexStates:Ie,transformIndicatorData:st,highlightedEdgeForSnap:Xn,draggedFaceId:ni,coordSystemSnapAngle:po,coordSystemSnapType:$s,coordSystemSnapScale:$n,initialCoordSystemStates:Hn},Ae,J),Dg(e),Iu(e),af(Oe,{altHoverInfo:dt,colors:e},Ae,J,Ft);const t=Hu(e);qu(e,t),yu()}function Nc(){if(!Be||Be.length<2)return;const e=Re[et];if(e===-1)return;const t=we[e];if(!t||t.type!=="colormap")return;const n=Be.length;Be.forEach((s,i)=>{const o=J(s);if(o&&o.type==="regular"){const a=n>1?i/(n-1):.5;o.color=Ge(t,a)}})}function Oc(){if(!Be||Be.length<2)return;const e=Re[tt];if(e===-1)return;const t=we[e];if(!t||t.type!=="colormap")return;const s=Be.length-1;for(let i=0;i<s;i++){const o=Be[i],a=Be[i+1],r=U.find(c=>c.id1===o&&c.id2===a||c.id1===a&&c.id2===o);if(r){const c=i/s,l=(i+1)/s;r.gradientStart=c,r.gradientEnd=l,r.colormapItem=t,delete r.colormapOffset,delete r.color}}}function ju(e,t,n){if(!gt)return!1;const s=j.removeColorButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height){if(we.length>1&&Qe.length>0){const o=Qe[Qe.length-1],a=Re[o];a>=0&&(nt(),tr(a))}else we.length>1&&Bt!==null&&Bt>=0&&Bt<we.length&&(nt(),tr(Bt));return!0}const i=j.addColorButton;return i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height?(qi=!1,Xo=null,os.show(),!0):!1}function $r(){const e=[];return ge.length>0&&e.push(at),be.length>0&&e.push(tt),Ce.length>0&&e.push(et),_e.length>0&&e.push(Ht),e.length>0?(Qe=e,Bt=null,gt&&At(),!0):!1}function vs(){if(nn&&clearTimeout(nn),Jt="",nn=null,fs&&(we=bt.originalAllColors,Re=bt.originalAssignments,At(),wt.length>0&&wt.pop(),fs=!1,bt=null),ot){ot=!1,St=null,jt=null,ys=null,Et=null,ms=null,Un=null,ft=[],rn=0,Be=[],Gi=null;return}sn&&(sn=!1,yo=null,si=null),Ce=[],be=[],ge=[],Ye=[],_e=[],rt=null,Qe=[],gt&&At(),Dn=null,Ut=!1,ze=!1,Cn=!1,Ki=!1,ks=!1,Kn=!1,De=[],Ie=[],Ui=null,tn=-1,Ee={targetId:null,type:null,count:0,timestamp:0},Te.style.cursor="crosshair",st=null,Ys=[],Ue=null,Xn=null,po=null,ni=null,$s=null,Dn=null,dt=null}function Uu(){if(!ot||!St||ft.length===0)return;nt();const e=J(St);if(!e){vs();return}const t=Mc(e.id);if(!t){vs();return}const n=t.angleRad;if(ft.length===1)return;const s=ft.length-1,i=(rn-1)%s+1,o=ft[i],a=o.length;let r;if(i===ft.length-1){const m=ft.length>2?1:0;r=ft[m].turn}else r=o.turn;let c,l;if(i===ft.length-1){const m=[ft[0].endVertexColor,ft[1].endVertexColor],x=(rn-1)%m.length;l=m[x];const S=rn%m.length;c=m[S],e.color=l}else c=o.endVertexColor;const d=Rn(n+r),h=e.x+a*Math.cos(d),f=e.y+a*Math.sin(d);let u=null,p=!1;const g=Je*2/pe.scale;for(const m of ye)if(m.type==="regular"&&re({x:h,y:f},m)<g){u=m,p=!0;break}p||(u={id:$t(),x:h,y:f,type:"regular",color:c},ye.push(u)),U.some(m=>m.id1===e.id&&m.id2===u.id||m.id2===e.id&&m.id1===u.id)||U.push({id1:e.id,id2:u.id,color:qe(tt)}),Jn&&(ie=da(U,J),Es()),Be.push(u.id),window.currentDrawingPath=Be,Nc(),Oc(),St=u.id,rn++,rn>=ft.length&&(rn=1),Et=null,ms=null,jt=null,ys=null,Un=null}function Fc(){Lc(),requestAnimationFrame(Fc)}function Ju(e){if(ge.length===0)return!1;const t=To(e,Te);for(const n of ge){const s=ie.find(o=>o.id===n);if(!s||!s.localCoordSystem)continue;const i=Th(t,s,Ae);if(i)return Qn=!0,wn=i,ni=s.id,Zi=Zu(s),i.type==="center"&&(s.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function Zu(e){const t=[],n=[],s=[],i=[],o=[];e.vertexIds.forEach(a=>{const r=J(a);r&&r.type==="regular"&&t.push({...r,id:a})});for(let a=0;a<t.length;a++){const r=t[a],c=t[(a+1)%t.length];n.push({x:(r.x+c.x)/2,y:(r.y+c.y)/2,v1:r.id,v2:c.id}),s.push(r.id,c.id),o.push(Math.atan2(c.y-r.y,c.x-r.x))}return ie.forEach(a=>{a.id!==e.id&&a.localCoordSystem&&i.push(a.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:s,faceCenters:i,edgeAngles:o}}function sr(e,t){const n=e.vertexIds[t],s=e.vertexIds[(t+1)%e.vertexIds.length],i=J(n),o=J(s);return i&&o?{v1Id:n,v2Id:s,edgeAngle:Math.atan2(o.y-i.y,o.x-i.x)}:null}function Qu(e,t){if(e.length===0||t&&t.transformType===mn||!t)return;const i=new Set;e.forEach(a=>{nr(a).forEach(r=>i.add(r))});const o=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;i.forEach(a=>{const r=J(a.id1),c=J(a.id2);if(!r||!c)return;const l=r.x-c.x,d=r.y-c.y,h=l/o,f=d/o,u=1e-5;if(o&&Math.abs(h-Math.round(h))<u&&Math.abs(f-Math.round(f))<u){a.labelMode="exact";const g=Math.round(h),y=Math.round(f);a.exactValue={g2gSquaredSum:g*g+y*y,gridInterval:o}}else a.labelMode="decimal",delete a.exactValue})}function eg(){if(qt){nt();let e=ie.find(t=>t.id===qt);if(e)e.color=qe(at),ea();else{const n=da(U,J).find(s=>s.id===qt);n&&(n.color=qe(at),ie.push(n),ea(),Es())}qt=null}Ct.style.display="none"}function tg(e,t){const n=[],s=t.find(a=>a.id===e);if(!s)return[];const i=[...s.childFaceIds||[]],o=new Set(s.childFaceIds);for(;i.length>0;){const a=i.shift(),r=t.find(c=>c.id===a);r&&(n.push(r),r.childFaceIds&&r.childFaceIds.forEach(c=>{o.has(c)||(o.add(c),i.push(c))}))}return n}function ng(e,t,n,s,i){if(!t.isCustom){const l=e.vertexIds.map(d=>s.find(h=>h.id===d)||i(d)).filter(d=>d&&d.type==="regular");if(l.length>=3){const d=ca(l);d&&(e.localCoordSystem.origin=d.center,e.localCoordSystem.scale=d.radius)}return}let o={...t.origin},a=t.angle,r=t.scale;if(e.localCoordSystem.attachedToVertex){const l=s.find(d=>d.id===e.localCoordSystem.attachedToVertex);l&&(o={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.attachedToEdge.v1)||i(e.localCoordSystem.attachedToEdge.v1),d=s.find(h=>h.id===e.localCoordSystem.attachedToEdge.v2)||i(e.localCoordSystem.attachedToEdge.v2);l&&d&&(o={x:l.x+e.localCoordSystem.attachedToEdge.t*(d.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(d.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v1)||i(e.localCoordSystem.rotationAlignedToEdge.v1),d=s.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v2)||i(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&d){const h=Math.atan2(d.y-l.y,d.x-l.x),f=e.localCoordSystem.rotationAlignedToEdge.originalAngle,p=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-f;a=Rn(h+p),e.localCoordSystem.rotationAlignedToEdge.originalAngle=h,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(e.localCoordSystem.scaleAttachedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v1)||i(e.localCoordSystem.scaleAttachedToEdge.v1),d=s.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v2)||i(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&d){const h=re(l,d);r=h*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=h}}const c=e.vertexIds.map(l=>s.find(d=>d.id===l)||i(l)).filter(l=>l&&l.type==="regular");c.length>=3&&(e.localCoordSystem.origin=go(o,c),e.localCoordSystem.angle=a,e.localCoordSystem.scale=Math.max(.01,r),e.localCoordSystem.isCustom=!0)}function sg(e,t){const n=new Map;return e.forEach(s=>{const i=[...new Set(s.vertexIds.map(o=>t(o)))];if(i.length>=3){const o=ue({vertexIds:i});if(s.localCoordSystem&&s.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(s.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=t(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=t(a.attachedToEdge.v1),a.attachedToEdge.v2=t(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=t(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=t(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=t(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=t(a.scaleAttachedToEdge.v2)),n.set(o,a)}}}),n}function og(e){Ct.innerHTML="",Ct.style.display="none",te=To(e,Te);const t=bo(te),n=t?null:vo(te),s=!t&&!n?Mo(te):null;if(t||n||s){let d=!1;t?d=Ce.includes(t.id):n?d=be.includes(le(n)):s&&(d=ge.includes(ue(s))),d||(Ce=[],be=[],ge=[],Ye=[],_e=[],t?Ce=[t.id]:n?be=[le(n)]:s&&(ge=[ue(s)]))}else vs();const o=$e(te);let a=[];qt=null,so=null,no=null;const r=(Ce.length>0?1:0)+(be.length>0?1:0)+(ge.length>0?1:0),c=bo(te),l=c?null:vo(te);if(c&&c.type==="regular"){no=c.id;const d=r>1?"Remove Geometry":"Remove Vertex";a.push({text:d,handler:yg})}else if(l){so=le(l);const d=r>1?"Remove Geometry":"Remove Edge";a.push({text:d,handler:mg})}else{const d=Mo(te);if(d){qt=ue(d);const h=r>1?"Remove Geometry":"Remove Face";a.push({text:h,handler:xg}),d.childFaceIds&&d.childFaceIds.length>0&&a.push({text:"Remove Face and Children",handler:pg})}else{const h=da(U,J);let f=null,u=1/0;h.forEach(p=>{const g=p.vertexIds.map(y=>J(y));if(g.every(Boolean)&&Os(o,g)){const y=Math.abs(la(g));y<u&&(u=y,f=p)}}),f&&(qt=f.id||ue(f),a.push({text:"Add Face",handler:eg}))}}if(a.length>0){const d=document.createElement("ul");a.forEach(h=>{const f=document.createElement("li");f.textContent=h.text,f.addEventListener("click",h.handler),d.appendChild(f)}),Ct.appendChild(d),Ct.style.left=`${e.clientX-Jr}px`,Ct.style.top=`${e.clientY-Jr}px`,Ct.style.display="block"}}function ig(e){if(In){for(const t of j.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[aa,gr,Wo,ra];Vs=n[(n.indexOf(Vs)+1)%n.length];break;case"grid":const s=[pr,yr,mr,xr,ei];xt=s[(s.indexOf(xt)+1)%s.length];break;case"angles":const i=[Ns,ti,zo];en=i[(i.indexOf(en)+1)%i.length],ss=en!==zo;break;case"distances":const o=[Ho,fh];bi=o[(o.indexOf(bi)+1)%o.length],On=bi===Ho;break;case"theme":hg();break}return!0}}return!1}function ag(e){if(!cn)return!1;for(const t of j.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationRemove"){const n=be.length>0||ge.length>0||Ce.length>0;n&&xu();const s=mc()||Bs;return s&&s!==En.id?(pn=pn.filter(i=>i.id!==s),Bs===s&&wi(En.id),Lr(),Qt()):n||wi(En.id),!0}if(t.type==="interpolationAdd")return to?.initialize?.(),to?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(Si.id===t.styleId&&n-Si.timestamp<Di){const i=Zo(t.styleId);return i&&(to?.initialize?.(),to?.show(i)),Si={id:null,timestamp:0},!0}return Si={id:t.styleId,timestamp:n},(be.length>0||ge.length>0||Ce.length>0)&&mu(t.styleId),wi(t.styleId),!0}}return!1}function rg(e){if(!dn)return!1;for(const t of j.colorModeIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.group==="edge"){const n=mo();n.length>0?(hu(t.mode,n),Yn=t.mode):(Mt=t.mode,Za())}else if(t.group==="face"){const n=xo();n.length>0?(fu(t.mode,n),Gn=t.mode):(Tt=t.mode,Za()),Es()}return At(),Rr(),Qt(),!0}return!1}function lg(e,t=!1,n=!1){const s=j.toolbarButton;if(e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return ls=!ls,ls?vc():(gt=!1,dn=!1,cn=!1,kn=!1,In=!1,fa=!1,vt=!1,Qe=[]),!0;if(ls){const i=j.colorToolButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return gg(),!0;const o=j.colorModeToolButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return dn=!dn,dn&&Rr(),!0;const a=j.interpolationToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return cn=!cn,cn&&Lr(),!0;const r=j.transformToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return kn=!kn,kn&&Tu(),!0;const c=j.visibilityToolButton;if(c&&e.x>=c.x&&e.x<=c.x+c.width&&e.y>=c.y&&e.y<=c.y+c.height)return In=!In,In&&Cu(),!0;const l=j.sessionsToolButton;if(l&&e.x>=l.x&&e.x<=l.x+l.width&&e.y>=l.y&&e.y<=l.y+l.height)return vt=!vt,vt&&(Nt=Rt,ai()),!0}if(gt&&ju(e)||dn&&rg(e)||cn&&ag(e))return!0;if(kn){for(const i of j.transformIcons)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return sn?yo=i.type:(sn=!0,yo=i.type,Te.style.cursor="none"),!0}if(In&&ig(e))return!0;if(vt&&j.sessionsPanelBounds){const i=j.sessionsPanelBounds;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return Nu(),!0}return!!Nr(e)}function cg(){if(wt.length===0)return;const e=li();we.length,we[0]?.value,ye.length,hs.push(e),hs.length>fr&&hs.shift();const t=wt.pop();ri(t),we.length,we[0]?.value,ye.length,Zt()}function dg(){if(hs.length===0)return;const e=li();wt.push(e),wt.length>fr&&wt.shift();const t=hs.pop();ri(t),Zt()}function Vr(e,t){const n=$e(e),s=bo(e),i=s?null:vo(e),o=!s&&!i?Mo(e):null;if(s)dt={point:{x:s.x,y:s.y},element:{type:"vertex",id:s.id},shiftKey:t};else if(i){const a=J(i.id1),r=J(i.id2);if(a&&r){let c,l;const d=Lt(n,a,r);if(t){const h=Lh(d,a,r);c=h.point,l=h.fraction}else c={x:d.x,y:d.y},l=d.t;dt={point:c,element:{type:"edge",edge:i},shiftKey:t,fraction:l}}}else o?dt={point:n,element:{type:"face",id:ue(o)},shiftKey:t}:dt=null;yn=null,Kt=null,Vt=null}function hg(){nt(),Jo=Jo==="dark"?"light":"dark",Mu(),gt&&At()}function fg(e){if(!Qn||!wn)return!1;const t=To(e,Te),n=$e(t),s=wn,i=s.face,o=i.localCoordSystem,a=i.vertexIds.map(r=>J(r)).filter(r=>r&&r.type==="regular"&&r.x!==void 0&&r.y!==void 0);if(s.type==="center"){let r,c={snapped:!1};if(e.shiftKey){if(c=_h(n,Zi,xt,oe,Tn),c.snapped){if(r=c.snapPoint,c.snapType==="edge"){const l=c.edgeInfo,d=J(l.v1),h=J(l.v2);d&&h&&(r=c.snapPoint,Dn=null)}}else{const l=ca(a);r=l?l.center:a[0]}s.type==="center"&&(Ue=r)}else r=n,Ue=null,Dn=null;a.length>0&&a.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(r=go(r,a),Ue&&(Ue=go(Ue,a))),o.origin.x=r.x,o.origin.y=r.y,o.isCustom=!0,c.snapped?(o.attachedToVertex=c.vertexId||null,o.attachedToEdge=c.edgeInfo||null):(o.attachedToVertex=null,o.attachedToEdge=null)}else if(s.type==="x_axis"||s.type==="y_axis"){const r={x:n.x-o.origin.x,y:n.y-o.origin.y};let c=Math.atan2(r.y,r.x),l=Math.hypot(r.x,r.y);if(Xn=null,po=null,$s=null,Ys=[],Ue=null,Dn=null,$n=null,e.shiftKey){const d=Ph(n,o.origin,!0,Zi);if(d.snapped){c=d.angle,po=c,$s=d.snapType;const h={x:Math.cos(c),y:Math.sin(c)},f={x:n.x-o.origin.x,y:n.y-o.origin.y},u=f.x*h.x+f.y*h.y;if(d.snapType==="vertex_direction"){const p=J(d.targetVertexId);p&&(l=re(o.origin,p),$n=l)}else if(d.edgeIndex!==null){Xn=d.edgeIndex;const p=sr(i,d.edgeIndex);if(p){const g=Math.abs(mt(c-p.edgeAngle))>Math.PI/4&&Math.abs(mt(c-p.edgeAngle))<3*Math.PI/4;if(s.type==="x_axis"&&g){const y=J(p.v1Id),m=J(p.v2Id);if(y&&m){const x=zl(o.origin,y,m),S=x.distance,M=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};M.forEach(C=>{const v=S*C,T=Math.abs(u-v);T<b.dist&&(b={scale:v,dist:T,fraction:C})});const E=15/pe.scale;b.dist<E?(l=b.scale,$n=l,Dn={orthogonalDistanceFraction:b.fraction,v1:y,v2:m,snapPosition:{origin:o.origin,closest:x}}):(l=u>0?u:0,$n=l)}}else{const y=Ah(o.origin,s.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:p},i,J,u,pe,s.type);if(y.snapped){if(l=y.scale,$n=l,y.edgeFraction!==null){const m={x:o.origin.x+l*Math.cos((s.type==="y_axis",c)),y:o.origin.y+l*Math.sin((s.type==="y_axis",c))};Dn={edgeFraction:y.edgeFraction,v1:J(p.v1Id),v2:J(p.v2Id),snapPosition:m}}}else l=u>0?u:0}}}}else l=Math.hypot(r.x,r.y)}s.type==="y_axis"?o.angle=c-Math.PI/2:o.angle=c,l>.01&&(o.scale=l),o.isCustom=!0}return!0}function ug(){if(Qn){const e=wn,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const s=bd;let i=null,o=null,a=1/0,r={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(c=>{const l=J(c);if(l&&l.type==="regular"){const d=re(n.origin,l);d<a&&(a=d,d<s&&(i=c))}}),!i){for(let c=0;c<t.vertexIds.length;c++){const l=J(t.vertexIds[c]),d=J(t.vertexIds[(c+1)%t.vertexIds.length]);if(l&&d&&l.type==="regular"&&d.type==="regular"){const h=Lt(n.origin,l,d);h.distance<r.dist&&(r={dist:h.distance,t:h.t,v1:l.id,v2:d.id})}}if(r.dist<s){const c=re(J(r.v1),J(r.v2));c>xe&&(o={v1:r.v1,v2:r.v2,t:r.t,originalLength:c,scaleRatio:n.scale/c})}}n.attachedToVertex=i,n.attachedToEdge=o}if(e.type==="x_axis"||e.type==="y_axis"){let s=!1,i=!1;if($s==="edge"&&Xn!==null){const o=sr(t,Xn);o&&(n.rotationAlignedToEdge={v1:o.v1Id,v2:o.v2Id,originalAngle:o.edgeAngle,originalSystemAngle:n.angle},s=!0)}if($n!==null&&n.rotationAlignedToEdge){const o=sr(t,Xn);if(o){const a=J(o.v1Id),r=J(o.v2Id);if(a&&r){const c=re(a,r);c>xe&&(n.scaleAttachedToEdge={v1:o.v1Id,v2:o.v2Id,scaleRatio:n.scale/c,originalLength:c},i=!0)}}}s||(n.rotationAlignedToEdge=null),i||(n.scaleAttachedToEdge=null)}return $n=null,Dn=null,Qn=!1,wn=null,Zi=null,Xn=null,po=null,$s=null,ni=null,Ue=null,Ys=[],!0}return!1}function gg(){gt=!gt,gt&&At()}function pg(){if(qt){nt();const e=ie.find(t=>t.id===qt);if(e){const t=tg(e.id,ie),n=new Set(t.map(o=>o.id)),s=new Set;t.forEach(o=>{o.vertexIds.forEach(a=>s.add(a))}),ye=ye.filter(o=>!s.has(o.id)),U=U.filter(o=>!s.has(o.id1)&&!s.has(o.id2));const i=new Set([e.id,...n]);ie=ie.filter(o=>!i.has(o.id)),vs()}qt=null}Ct.style.display="none"}function yg(){no&&(nt(),Ce.includes(no)||(be=[],ge=[],Ye=[],_e=[],Ce=[no]),di(),no=null),Ct.style.display="none"}function mg(){so&&(nt(),be.includes(so)||(Ce=[],ge=[],Ye=[],_e=[],be=[so]),di(),so=null),Ct.style.display="none"}function xg(){qt&&(nt(),ge.includes(qt)||(Ce=[],be=[],Ye=[],_e=[],ge=[qt]),di(),qt=null),Ct.style.display="none"}function Sg(e){const t=Wl(te,j,{isToolbarExpanded:ls,isColorPaletteExpanded:gt,isColorModePanelExpanded:dn,isInterpolationPanelExpanded:cn,isTransformPanelExpanded:kn,isDisplayPanelExpanded:In,isVisibilityPanelExpanded:fa,isSessionsPanelExpanded:vt});if(sn&&(!t||t.type!=="transformIcon")){nt();const h=$e(te),f=Fe?Pi(h):h,u={id:$t(),x:f.x,y:f.y,type:yo};ye.push(u),Ye=[u.id],rt=u.id,Ce=[],be=[],ge=[],_e=[],sn=!1,yo=null,si=null,Te.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!ot){Vr(te,e.shiftKey);const h=dt&&dt.element.type==="vertex"?J(dt.element.id):null,f=dt&&dt.element.type==="edge"?dt.element.edge:null,u=dt&&dt.element.type==="face"?ie.find(p=>ue(p)===dt.element.id):null;if(h||f||u){nt(),Ce=[],be=[],ge=[],Ye=[],_e=[],rt=null,Qe=[],gt&&At();const p=oe?.alpha2>=oe?.alpha1&&oe?.interval2?oe.interval2:oe?.interval1;if(h&&h.type==="regular")ot=!0,St=h.id,ft=[],rn=0,Be=[h.id],window.currentDrawingPath=Be;else if(f&&dt){const g=dt.point,y=Rc(f,g,p,qe);y&&(ot=!0,St=y.id,ft=[],rn=0,Be=[y.id],window.currentDrawingPath=Be,Zt())}else if(u&&dt){const g=dt.point;let y=qe(et);const m=Re[et];if(m!==-1){const S=we[m];S&&S.type==="colormap"&&(y=Ge(S,0))}const x={id:$t(),...g,type:"regular",color:y};ye.push(x),ot=!0,St=x.id,ft=[],rn=0,Be=[x.id],window.currentDrawingPath=Be,Zt()}Ut=!1,e.preventDefault();return}}if(Ut=!0,ze=!1,Kn=!1,gt){const h=(j.colorTargetIcons||[]).filter(f=>te.x>=f.x&&te.x<=f.x+f.width&&te.y>=f.y&&te.y<=f.y+f.height);if(h.length>0){const f=h[h.length-1],{element:u,shiftKey:p,ctrlKey:g}={element:f,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};p?Qe.includes(u.target)||Qe.push(u.target):g?Qe.includes(u.target)?Qe=Qe.filter(y=>y!==u.target):Qe.push(u.target):Qe=[u.target],At(),he={target:"ui_icon_click",element:{...f,type:"colorTargetIcon"}},Te.style.cursor="default";return}for(const f of j.colorSwatches)if(te.x>=f.x&&te.x<=f.x+f.width&&te.y>=f.y&&te.y<=f.y+f.height){he={target:"ui_swatch",element:{...f}},Te.style.cursor="default";return}}if(vt){const h=j.removeSessionButton;if(h&&te.x>=h.x&&te.x<=h.x+h.width&&te.y>=h.y&&te.y<=h.y+h.height){he={target:"ui_session_remove"},Te.style.cursor="default";return}const f=j.addSessionButton;if(f&&te.x>=f.x&&te.x<=f.x+f.width&&te.y>=f.y&&te.y<=f.y+f.height){he={target:"ui_session_add"},Te.style.cursor="default";return}for(const u of j.sessionIcons)if(te.x>=u.x&&te.x<=u.x+u.width&&te.y>=u.y&&te.y<=u.y+u.height){Nt=u.index,vt&&ai(),he={target:"ui_session",element:{...u}},Te.style.cursor="default";return}}if(lg(te,e.shiftKey,e.ctrlKey||e.metaKey)){he={target:"ui"},Te.style.cursor="default";return}if(Ju(e)){he={target:"coord_system"};return}const n=Ic(te);let s=n?null:bo(te),i=!n&&!s?vo(te):null,o=!n&&!s&&!i?Mo(te):null;if(n)un("entityMouseDown",{type:me.TEXT,id:n.id,button:e.button});else if(s){const h=s.type==="regular"?me.VERTEX:me.TRANSFORMATION_OBJECT;un("entityMouseDown",{type:h,id:s.id,button:e.button})}else i?un("entityMouseDown",{type:me.EDGE,id:le(i),button:e.button}):o&&un("entityMouseDown",{type:me.FACE,id:ue(o),button:e.button});const a=e.shiftKey||e.ctrlKey||e.metaKey,r=n||s||i||o;let c=!1;n?c=_e.includes(n.id):s?c=Ce.includes(s.id)||Ye.includes(s.id):i?c=be.includes(le(i)):o&&(c=ge.includes(ue(o))),!ot&&!a&&r&&!c&&(n?Yt([],[],[],!1,!1,!1,[n.id]):s?Yt([s.id],[],[],!1,!1,s.type!=="regular"):i?Yt([],[le(i)],[],!1,!1):o&&Yt([],[],[ue(o)],!1,!1));let l=null;if(n)l=$e(te);else if(s)l=s;else if(i){const h=J(i.id1),f=J(i.id2);l=Lt($e(te),h,f)}else o&&(l=$e(te));const d=rt&&(Ce.length>0||be.length>0||ge.length>0||_e.length>0);Ie=[],De=[],he={targetVertex:s,dragHandle:l,targetEdge:i,targetFace:o,targetText:n,target:r||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:d},s&&s.type!=="regular"&&(ks=!0,kr(s.id,e.shiftKey,e.ctrlKey||e.metaKey))}function Ig(){nt();const e=[...Ce],t=[...be],n=[...ge],s=[...Ye],i=rt;Ce=[],be=[],ge=[],Ye=[],_e=[],rt=null;const o=parseInt(Jt,10)||1;let a=null;const r=ze&&Ie.length===1&&he?.finalSnapResult?.snapType==="edge",c=new Set(oo.map(y=>y.id));if(c.size>0){const y=new Map(oo.map(T=>[T.id,T])),m=new Set(e);t.forEach(T=>{const[w,I]=T.split(fo);w&&m.add(w),I&&m.add(I)}),n.forEach(T=>{const w=ie.find(I=>ue(I)===T);w&&kc(w.id,ie).forEach(P=>m.add(P))});const x=st?null:xc(),{center:S,rotation:M=0,scale:b=1,directionalScale:E=!1,startVector:C}=st||{},v=-M*(180/Math.PI);We.forEach(T=>{if(!c.has(T.id))return;const w=y.get(T.id)||T,I=Lo(w);if(w.anchorType!=="canvas"&&!I)return;const P=w.anchorType==="canvas"?w.position||T.position:I.anchor,L=w.anchorType==="canvas"?{x:0,y:0}:w.offset||{x:0,y:0},A=w.anchorType==="canvas"?w.position||T.position||{x:0,y:0}:{x:P.x+L.x,y:P.y+L.y},_=(()=>{if(w.anchorType==="vertex")return m.has(w.anchorId);if(w.anchorType==="edge"){if(t.includes(w.anchorId))return!0;const D=U.find(O=>le(O)===w.anchorId);return D?m.has(D.id1)&&m.has(D.id2):!1}if(w.anchorType==="face"){if(n.includes(w.anchorId))return!0;const D=ie.find(O=>ue(O)===w.anchorId);return D?D.vertexIds.every(O=>m.has(O)):!1}return!1})();if(st){const D=je(A,S,M,b,E,C);if(T.rotationDeg=(w.rotationDeg||0)+v,T.scale=(w.scale||1)*b,w.anchorType==="canvas")T.position=D;else{const O=_?je(P,S,M,b,E,C):P,X={x:D.x-O.x,y:D.y-O.y};if(T.offset=X,T.anchorType==="edge"){const F=Ti(T.anchorId,X);typeof F=="number"&&(T.edgeOffsetFactor=F)}}}else if(x){if(w.anchorType==="canvas"){const D=w.position||T.position||{x:0,y:0};T.position={x:D.x+x.x,y:D.y+x.y}}else if(!_){const D=w.offset||{x:0,y:0},O={x:D.x+x.x,y:D.y+x.y};if(T.offset=O,T.anchorType==="edge"){const X=Ti(T.anchorId,O);typeof X=="number"&&(T.edgeOffsetFactor=X)}}}})}if(r){const y=he.finalSnapResult,m=Ie[0].id,x=y.targetEdge,S=J(m);if(S&&x){const M=JSON.parse(JSON.stringify(U)),b=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;S.x=y.pos.x,S.y=y.pos.y,U=U.filter(I=>le(I)!==le(x));const E=J(x.id1),C=J(x.id2),v=Fs(E,S,b,qe),T=Fs(C,S,b,qe),w=x?.colorMode||Mt;es(v,w),es(T,w),Gs(v),Gs(T),U.push(v),U.push(T),zs(M,U)}}else if(st){const{center:y,rotation:m,scale:x,directionalScale:S,startPos:M}=st,b={x:M.x-y.x,y:M.y-y.y},E=(v,T)=>je(v,y,m*T,Math.pow(x,T),S,b),C=(v,T)=>{if(!v)return null;const w=m*T,I=Math.pow(x,T),P=je(v.origin,y,w,I,S,b),L=JSON.parse(JSON.stringify(v));if(L.origin=P,S){const A=Mn({x:1,y:0},v),_=je(A,y,w,I,S,b);L.scale=Math.max(.01,re(P,_))}else L.angle=Rn(v.angle+w),L.scale=v.scale*I;return L};if(o>1){const v=Ie.filter($=>$.type==="regular"),T=new Set(v.map($=>$.id)),w=new Set(ge),I=new Set(be);ge.forEach($=>{const R=ie.find(N=>ue(N)===$);R&&R.vertexIds.forEach(N=>T.add(N))});const P=new Set;ge.forEach($=>{const R=ie.find(N=>ue(N)===$);if(R)for(let N=0;N<R.vertexIds.length;N++){const k=R.vertexIds[N],Y=R.vertexIds[(N+1)%R.vertexIds.length];P.add(le({id1:k,id2:Y}))}});const L=U.filter($=>{const R=le($);return I.has(R)||P.has(R)?!0:T.has($.id1)&&T.has($.id2)}),A=ge.length>0?ie.filter($=>w.has(ue($))):ie.filter($=>$.vertexIds.every(R=>T.has(R))),_=U.filter($=>T.has($.id1)&&!T.has($.id2)||T.has($.id2)&&!T.has($.id1)),D=[],O=[],X=[];a={vertices:[],edges:[],faces:[],texts:[]};const F=new Set(_e),V=We.filter($=>{if(F.has($.id))return!0;if($.anchorType==="vertex")return T.has($.anchorId);if($.anchorType==="edge"){const R=U.find(N=>le(N)===$.anchorId);return R?T.has(R.id1)&&T.has(R.id2):!1}if($.anchorType==="face"){if(w.has($.anchorId))return!0;const R=ie.find(N=>ue(N)===$.anchorId);return R?R.vertexIds.every(N=>T.has(N)):!1}return!1});for(let $=1;$<o;$++){const R=new Map,N=[],k=[],Y=[],B=[];v.forEach(G=>{const W=E(G,$),z={...G,...W,id:$t()};D.push(z),R.set(G.id,z.id),N.push(z.id)}),L.forEach(G=>{const W=R.get(G.id1),z=R.get(G.id2);if(W&&z){const K=G.directionFrom===G.id2?z:W,H=G.directionFrom===G.id2?W:z,q={...G,id1:W,id2:z,directionFrom:K,directionTo:H};O.push(q),k.push(le(q))}}),_.forEach(G=>{const W=T.has(G.id1)?G.id2:G.id1,z=T.has(G.id1)?G.id1:G.id2,K=R.get(z);if(K){const H=K,q=W,se=G.directionFrom===G.id2?q:H,fe=G.directionFrom===G.id2?H:q,ae={...G,id1:H,id2:q,directionFrom:se,directionTo:fe};O.push(ae)}}),A.forEach(G=>{const W=Hn.get(G.id)||G.localCoordSystem,z=G.vertexIds.map(K=>R.get(K));if(z.every(Boolean)){const K=JSON.parse(JSON.stringify(G));if(K.id=ue({vertexIds:z}),K.vertexIds=z,K.localCoordSystem&&W){const H=C(W,$);H&&(K.localCoordSystem=H)}X.push(K),Y.push(K.id)}}),V.forEach(G=>{const W=JSON.parse(JSON.stringify(G));W.id=$t();const z=-m*(180/Math.PI)*$,K=Math.pow(x,$);if(W.rotationDeg=(G.rotationDeg||0)+z,W.scale=(G.scale||1)*K,G.anchorType==="canvas"){if(!W.position)return;W.position=E(W.position,$)}else if(G.anchorType==="vertex"){const H=R.get(G.anchorId);if(!H)return;const q=Lo(G),se=q?q.anchor:null;if(se){const fe=G.offset||{x:0,y:0},ae={x:se.x+fe.x,y:se.y+fe.y},ne=E(se,$),Z=E(ae,$);W.offset={x:Z.x-ne.x,y:Z.y-ne.y}}W.anchorId=H}else if(G.anchorType==="edge"){const H=U.find(ne=>le(ne)===G.anchorId);if(!H)return;const q=R.get(H.id1),se=R.get(H.id2);if(!q||!se)return;const fe=Lo(G),ae=fe?fe.anchor:null;if(ae){const ne=G.offset||{x:0,y:0},Z={x:ae.x+ne.x,y:ae.y+ne.y},Q=E(ae,$),ee=E(Z,$),ce={x:ee.x-Q.x,y:ee.y-Q.y};W.offset=ce;const de=le({id1:q,id2:se}),ve=Ti(de,ce);typeof ve=="number"&&(W.edgeOffsetFactor=ve)}W.anchorId=le({id1:q,id2:se})}else if(G.anchorType==="face"){const H=ie.find(ae=>ue(ae)===G.anchorId);if(!H)return;const q=H.vertexIds.map(ae=>R.get(ae));if(!q.every(Boolean))return;const se=Lo(G),fe=se?se.anchor:null;if(fe){const ae=G.offset||{x:0,y:0},ne={x:fe.x+ae.x,y:fe.y+ae.y},Z=E(fe,$),Q=E(ne,$);W.offset={x:Q.x-Z.x,y:Q.y-Z.y}}W.anchorId=ue({vertexIds:q})}We.push(W),F.has(G.id)&&B.push(W.id)}),$===1&&(a={vertices:N,edges:k,faces:Y,texts:B})}ye.push(...D),U.push(...O),ie.push(...X)}else Ie.forEach(v=>{const T=J(v.id);if(T){const w=E(v,1);T.x=w.x,T.y=w.y}})}else if(De.length>0){const y=he.finalSnapResult&&he.finalSnapResult.snapped?he.finalSnapResult.finalDelta:{x:De[0].x-Ie[0].x,y:De[0].y-Ie[0].y},m=Ie.filter(x=>x.type==="regular");if(o>1&&m.length>0){const x=new Set(m.map(A=>A.id)),S=new Set(ge),M=new Set(be);ge.forEach(A=>{const _=ie.find(D=>ue(D)===A);_&&_.vertexIds.forEach(D=>x.add(D))});const b=new Set;ge.forEach(A=>{const _=ie.find(D=>ue(D)===A);if(_)for(let D=0;D<_.vertexIds.length;D++){const O=_.vertexIds[D],X=_.vertexIds[(D+1)%_.vertexIds.length];b.add(le({id1:O,id2:X}))}});const E=U.filter(A=>{const _=le(A);return M.has(_)||b.has(_)?!0:x.has(A.id1)&&x.has(A.id2)}),C=ge.length>0?ie.filter(A=>S.has(ue(A))):ie.filter(A=>A.vertexIds.every(_=>x.has(_))),v=U.filter(A=>x.has(A.id1)&&!x.has(A.id2)||x.has(A.id2)&&!x.has(A.id1)),T=[],w=[],I=[];a={vertices:[],edges:[],faces:[],texts:[]};const P=new Set(_e),L=We.filter(A=>{if(P.has(A.id))return!0;if(A.anchorType==="vertex")return x.has(A.anchorId);if(A.anchorType==="edge"){const _=U.find(D=>le(D)===A.anchorId);return _?x.has(_.id1)&&x.has(_.id2):!1}if(A.anchorType==="face"){if(S.has(A.anchorId))return!0;const _=ie.find(D=>ue(D)===A.anchorId);return _?_.vertexIds.every(D=>x.has(D)):!1}return!1});for(let A=1;A<o;A++){const _=new Map,D=[],O=[],X=[],F=[];m.forEach(V=>{const $={x:V.x+y.x*A,y:V.y+y.y*A},R={...V,...$,id:$t()};T.push(R),_.set(V.id,R.id),D.push(R.id)}),E.forEach(V=>{const $=_.get(V.id1),R=_.get(V.id2);if($&&R){const N=V.directionFrom===V.id2?R:$,k=V.directionFrom===V.id2?$:R,Y={...V,id1:$,id2:R,directionFrom:N,directionTo:k};w.push(Y),O.push(le(Y))}}),v.forEach(V=>{const $=x.has(V.id1)?V.id2:V.id1,R=x.has(V.id1)?V.id1:V.id2,N=_.get(R);if(N){const k=N,Y=$,B=V.directionFrom===V.id2?Y:k,G=V.directionFrom===V.id2?k:Y,W={...V,id1:k,id2:Y,directionFrom:B,directionTo:G};w.push(W)}}),C.forEach(V=>{const $=Hn.get(V.id),R=V.vertexIds.map(N=>_.get(N));if(R.every(Boolean)){const N=JSON.parse(JSON.stringify(V));if(N.id=ue({vertexIds:R}),N.vertexIds=R,N.localCoordSystem&&$){const k={x:y.x*A,y:y.y*A};N.localCoordSystem.origin.x=$.origin.x+k.x,N.localCoordSystem.origin.y=$.origin.y+k.y}I.push(N),X.push(N.id)}}),L.forEach(V=>{const $=JSON.parse(JSON.stringify(V));if($.id=$t(),V.anchorType==="canvas"){if(!$.position)return;$.position={x:$.position.x+y.x*A,y:$.position.y+y.y*A}}else if(V.anchorType==="vertex"){const R=_.get(V.anchorId);if(!R)return;$.anchorId=R}else if(V.anchorType==="edge"){const R=U.find(Y=>le(Y)===V.anchorId);if(!R)return;const N=_.get(R.id1),k=_.get(R.id2);if(!N||!k)return;$.anchorId=le({id1:N,id2:k})}else if(V.anchorType==="face"){const R=ie.find(k=>ue(k)===V.anchorId);if(!R)return;const N=R.vertexIds.map(k=>_.get(k));if(!N.every(Boolean))return;$.anchorId=ue({vertexIds:N})}We.push($),P.has(V.id)&&F.push($.id)}),A===1&&(a={vertices:D,edges:O,faces:X,texts:F})}ye.push(...T),U.push(...w),ie.push(...I)}else o===1&&Ie.forEach(x=>{const S=J(x.id);S&&(S.x=x.x+y.x,S.y=x.y+y.y)})}const l=new Set(Ie.map(y=>y.id)),d=ie.filter(y=>y.vertexIds.some(m=>l.has(m)));d.length>0&&d.forEach(y=>{const m=Hn.get(y.id);if(y.localCoordSystem&&m){const x=new Set(y.vertexIds),S=new Set(Ie.map(b=>b.id));if([...x].every(b=>S.has(b))){if(st){const{center:b,rotation:E,scale:C,directionalScale:v,startPos:T}=st,w={x:T.x-b.x,y:T.y-b.y},I=je(m.origin,b,E,C,v,w);if(y.localCoordSystem.origin=I,v){const P=Mn({x:1,y:0},m),L=je(P,b,E,C,v,w);y.localCoordSystem.scale=re(I,L)}else y.localCoordSystem.angle=Rn(m.angle+E),y.localCoordSystem.scale=m.scale*C}else if(o===1){const b=he.finalSnapResult&&he.finalSnapResult.snapped?he.finalSnapResult.finalDelta:{x:De[0].x-Ie[0].x,y:De[0].y-Ie[0].y};y.localCoordSystem.origin.x=m.origin.x+b.x,y.localCoordSystem.origin.y=m.origin.y+b.y}}else{const b=y.vertexIds.map(E=>J(E)).filter(Boolean);ng(y,m,Ie,b,J)}}}),Qu(Array.from(l),st);const{vertexMerges:h,edgeSplits:f}=Og(ye,U,pe),u=new Map;ye.forEach(y=>u.set(y.id,y.id));const p=y=>{if(!u.has(y)||u.get(y)===y)return y;const m=p(u.get(y));return u.set(y,m),m};h.forEach((y,m)=>{const x=p(m),S=p(y);x!==S&&u.set(S,x)});const g=new Set;if(ye.forEach(y=>{const m=p(y.id);y.id!==m&&g.add(y.id)}),g.size>0||f.size>0){const y=JSON.parse(JSON.stringify(U)),m=sg(ie,p);U.forEach(x=>{x.id1=p(x.id1),x.id2=p(x.id2)}),ye=ye.filter(x=>!g.has(x.id)),U=U.filter((x,S,M)=>x.id1!==x.id2&&S===M.findIndex(b=>le(b)===le(x))),zs(y,U),ie.forEach(x=>{const S=m.get(x.id);S&&(x.localCoordSystem=S)}),Es()}o>1&&a?(Ce=e.length>0?a.vertices.map(y=>p(y)):[],be=t.length>0?a.edges:[],ge=n.length>0?a.faces:[],_e=oo.length>0?a.texts:[]):o===1&&(Ce=e.map(y=>p(y)),be=t,ge=n,_e=oo.map(y=>y.id).filter(y=>We.some(m=>m.id===y))),Ye=s,rt=i,ea(),Zt()}function bg(e){const{shiftKey:t,ctrlKey:n,targetVertex:s,targetEdge:i,targetFace:o,targetText:a}=e,r=J(St);if(ot&&r){nt();const c=JSON.parse(JSON.stringify(U)),l=ii(r,te,t);let d=null;const h=oe.alpha2>oe.alpha1&&oe.interval2?oe.interval2:oe.interval1;if(l.snapType==="vertex"&&l.targetVertex)d=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)d=Rc(l.targetEdge,{x:l.x,y:l.y},h,qe);else{let f=qe(et);const u=Re[et];if(u!==-1){const p=we[u];p&&p.type==="colormap"&&(f=Ge(p,.5))}d={id:$t(),x:l.x,y:l.y,type:"regular",color:f},ye.push(d)}if(d){if(!U.some(p=>p.id1===r.id&&p.id2===d.id||p.id2===r.id&&p.id1===d.id)){const p=Fs(r,d,h,qe);es(p,Mt),Gs(p),U.push(p),zs(c,U),ea(),ie.forEach(g=>{g.colorMode=g.colorMode||Tt,oi(g,g.colorMode)})}const u=kl(r,d,U);u&&(ft.length>0&&(ft[ft.length-1].turn=u.turnAngleRad),ft.push({length:u.length,turn:0,endVertexColor:d.color}),rn=ft.length-1,Un=u.startVertex,Et=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,ms=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,jt=u.turnAngleRad,ys=u.precedingSegmentAbsoluteAngleRad),Be.push(d.id),window.currentDrawingPath=Be,Nc(),Oc(),Zt(),St=d.id}if(t&&d&&l){const f=kl(r,d,U);f&&(Un=f.startVertex,Et=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):f.length,ms=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,jt=f.turnAngleRad,ys=f.precedingSegmentAbsoluteAngleRad)}Ee.count=0}else if(e.target==="canvas"){nt();const c=Ue||$e(te);let l=qe(et);const d=Re[et];if(d!==-1){const f=we[d];f&&f.type==="colormap"&&(l=Ge(f,0))}const h={id:$t(),...c,type:"regular",color:l};ye.push(h),ot=!0,St=h.id,ft=[],rn=0,Be=[h.id],window.currentDrawingPath=Be,Zt()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(a||s||i||o)){nt();const l=a?a.id:o?ue(o):i?le(i):s.id;let d;switch(a?d="text":o?d="face":s&&s.type!=="regular"?d="center":s?d="vertex":i&&(d="edge"),l&&Ee.targetId===l&&Date.now()-Ee.timestamp<Di?Ee.count++:Ee.count=1,Ee.targetId=l,Ee.type=d,Ee.timestamp=Date.now(),Ee.count){case 1:Ee.type==="text"?Yt([],[],[],t,n,!1,[Ee.targetId]):Ee.type==="face"?Yt([],[],[Ee.targetId],t,n):Ee.type==="edge"?Yt([],[Ee.targetId],[],t,n):Ee.type==="vertex"?Yt([Ee.targetId],[],[],t,n):Ee.type==="center"&&kr(Ee.targetId,t,n);break;case 2:if(Ee.type==="text"){const h=So(Ee.targetId);h&&bc(h,h.content||"")}else if(Ee.type==="vertex"){const h=Sn(Ee.targetId,U);Yt([Ee.targetId,...h],[],[],t,n)}else if(Ee.type==="edge"){const h=U.find(f=>le(f)===Ee.targetId);if(h){const f=[...nr(h.id1),...nr(h.id2)];Yt([],Array.from(new Set(f.map(u=>le(u)))),[],t,n)}}else if(Ee.type==="face"){const h=ie.find(f=>ue(f)===Ee.targetId);if(h){const f=[],u=new Set;for(let p=0;p<h.vertexIds.length;p++){const g=h.vertexIds[p],y=h.vertexIds[(p+1)%h.vertexIds.length];u.add(le({id1:g,id2:y}))}ie.forEach(p=>{if(ue(p)!==ue(h))for(let g=0;g<p.vertexIds.length;g++){const y=p.vertexIds[g],m=p.vertexIds[(g+1)%p.vertexIds.length];if(u.has(le({id1:y,id2:m}))){f.push(ue(p));break}}}),Yt([],[],[ue(h),...f],t,n)}}break;case 3:if(Ee.type==="vertex"||Ee.type==="edge"||Ee.type==="face"){let h;if(Ee.type==="vertex")h=Ee.targetId;else if(Ee.type==="edge")h=Ee.targetId.split(fo)[0];else if(Ee.type==="face"){const f=ie.find(u=>ue(u)===Ee.targetId);f&&(h=f.vertexIds[0])}if(h){const f=new Set(Ws(h));if(Ee.type==="vertex")Yt(Array.from(f),[],[],t,n);else if(Ee.type==="edge"){const u=U.filter(p=>f.has(p.id1)&&f.has(p.id2)).map(p=>le(p));Yt([],u,[],t,n)}else if(Ee.type==="face"){const u=ie.filter(p=>p.vertexIds.every(g=>f.has(g))).map(p=>ue(p));Yt([],[],u,t,n)}}}Ee.count=0;break}$r()}}}function vg(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),s=`icon-${t.target}`;if(Ee.targetId===s&&n-Ee.timestamp<Di){switch(nt(),t.target){case et:Wi=!Wi;break;case tt:zi=!zi;break;case at:Jn=!Jn;break}At(),Ee.count=0}Ee.targetId=s,Ee.timestamp=n,Bt=null;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),s=`swatch-${t.index}`;if(!(Ce.length>0||be.length>0||ge.length>0||_e.length>0)&&Qe.length===0?Bt=t.index:Bt=null,Ee.targetId===s&&n-Ee.timestamp<Di){qi=!0,Xo=t.index;const o=we[t.index];let a;if(o.type==="color"){const r=jn(o.value);a={type:"colormap",points:[{pos:.5,alpha:r.a,color:[r.r,r.g,r.b],order:1}]}}else o.type==="colormap"&&(a={type:"colormap",points:o.vertices.map(r=>({pos:r.pos,alpha:r.alpha!==void 0?r.alpha:1,color:Array.isArray(r.color)?[...r.color]:[r.color.r||0,r.color.g||0,r.color.b||0],order:r.order||1})),isCyclic:o.isCyclic===!0});os.show(void 0,void 0,a),Ee.count=0}else Qe.length>0&&(nt(),Qe.forEach(o=>Re[o]=t.index),_r(),At(),Bt=null);Ee.targetId=s,Ee.timestamp=n;return}if(e.target==="ui_session"){const{element:t}=e;t&&t.index!==void 0&&Ks(t.index);return}if(e.target==="ui_session_add"){ku();return}if(e.target==="ui_session_remove"){Rt!==null&&Rt>=0&&_c(Rt);return}}function Mg(e){if(ao||fs||Go){if(ao){if(j.colorTargetIcons.find(n=>n.target===Wt.target)){const n=j.colorSwatches,s=Kl(te,n);s&&(Re[Wt.target]=s.index,Qi(Wt.target).forEach(i=>{Re[i]=s.index}),_r())}}else if(fs){const t=j.removeColorButton;if(t&&te.x>=t.x&&te.x<=t.x+t.width&&te.y>=t.y&&te.y<=t.y+t.height&&we.length>1){const s=we.indexOf(bt.item);s!==-1&&tr(s)}else if(bt&&bt.previewIndex!==null&&bt.previewIndex!==void 0){const s=bt.originalIndex,i=bt.previewIndex;if(s!==i&&s>=0&&i>=0){const o=[...bt.originalAllColors],[a]=o.splice(s,1);o.splice(i,0,a),we=o;const r={...bt.originalAssignments};Object.keys(r).forEach(c=>{const l=r[c];l===s?r[c]=i:s<i&&l>s&&l<=i?r[c]=l-1:s>i&&l>=i&&l<s&&(r[c]=l+1)}),Re=r}}}else if(Go){const t=j.removeSessionButton;t&&te.x>=t.x&&te.x<=t.x+t.width&&te.y>=t.y&&te.y<=t.y+t.height&&Ci&&_c(Ci.index)}ao=!1,Wt=null,fs=!1,bt=null,Go=!1,Ci=null,gt&&At(),vt&&ai()}else ze?Ig():he&&(typeof he.target=="string"&&he.target.startsWith("ui")?vg(he):bg(he));Xc()}function Eg(e){Ut=!0,Cn=!1,ji=ln,he={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function Cg(e){if(ze&&Cn){const t=$e({x:Math.min(ln.x,te.x),y:Math.min(ln.y,te.y)}),n=$e({x:Math.max(ln.x,te.x),y:Math.max(ln.y,te.y)}),s=Math.min(t.x,n.x),i=Math.max(t.x,n.x),o=Math.min(t.y,n.y),a=Math.max(t.y,n.y),r=ye.filter(f=>f.type==="regular"&&f.x>=s&&f.x<=i&&f.y>=o&&f.y<=a).map(f=>f.id),c=ye.filter(f=>f.type!=="regular"&&f.x>=s&&f.x<=i&&f.y>=o&&f.y<=a).map(f=>f.id),l=new Set(r),d=U.filter(f=>l.has(f.id1)&&l.has(f.id2)).map(f=>le(f)),h=ie.filter(f=>f.vertexIds.every(u=>l.has(u))).map(f=>ue(f));he.shiftKey?(Ce=[...new Set([...Ce,...r])],be=[...new Set([...be,...d])],ge=[...new Set([...ge,...h])],Ye=[...new Set([...Ye,...c])]):he.ctrlKey?(r.forEach(f=>{const u=Ce.indexOf(f);u>-1?Ce.splice(u,1):Ce.push(f)}),d.forEach(f=>{const u=be.indexOf(f);u>-1?be.splice(u,1):be.push(f)}),h.forEach(f=>{const u=ge.indexOf(f);u>-1?ge.splice(u,1):ge.push(f)}),c.forEach(f=>{const u=Ye.indexOf(f);u>-1?Ye.splice(u,1):Ye.push(f)})):(Ce=r,be=d,ge=h,Ye=c),$r(),gc()}else{if(vt&&j.sessionsPanelBounds){const n=j.sessionsPanelBounds;if(te.x>=n.x&&te.x<=n.x+n.width&&te.y>=n.y&&te.y<=n.y+n.height){Ou();return}}og(e);const t=Ce.length>0||be.length>0||ge.length>0||_e.length>0;Bt=null,t||(Qe=[]),gt&&At()}}function Tg(e){e.preventDefault();const t=To(e,Te),n=e.deltaY>0?1/1.15:1.15;ta(t,n),un("wheel",e),Xt()}function wg(){Uo=!0,Xt()}function Pg(){Uo=!1,Lc(),Xt()}function Ag(e){e.preventDefault(),Xt()}function _g(e,t){const n=parseInt(Jt||"1",10)||1,s=Gh(Ie,ye,U,J,e,n,pe),i=s.finalDelta;Ie.forEach(o=>{const a=De.find(r=>r&&r.id===o.id);a&&(a.x=o.x+i.x,a.y=o.y+i.y)}),$c(i,s),he.finalSnapResult=s}function Dg(e){if(Jn&&ye.length>0&&(jl(Oe,{allFaces:ie,hoveredFaceId:Vt,selectedFaceIds:ge,colors:e,isDragConfirmed:ze,dragPreviewVertices:De,currentAltPressed:Pt},Ae,J,ue),ge.length>0&&ic(Oe,{allFaces:ie,selectedFaceIds:ge,colors:e,isDragConfirmed:ze,dragPreviewVertices:De,initialDragVertexStates:Ie,transformIndicatorData:st,highlightedEdgeForSnap:Xn,draggedFaceId:ni,coordSystemSnapAngle:po,coordSystemSnapType:$s,coordSystemSnapScale:$n,initialCoordSystemStates:Hn},Ae,J)),ot&&Fe&&(Et!==null||jt!==null)&&Be.length>=1&&Un){const s=J(Un.id);if(s){const i={frozen_Origin_Data_to_display:s,displayAngleA_valueRad_for_A_equals_label:jt,frozen_A_baseRad_to_display:ys,frozen_D_du_to_display:Et,frozen_D_g2g_to_display:ms};mf(Oe,i,Ae,$e,{showAngles:ss,showDistances:On,viewTransform:pe,mousePos:te,colors:e}),xf(yt,i,{showAngles:ss,showDistances:On,viewTransform:pe,mousePos:te,frozenReference_D_du:Et,distanceSigFigs:Ts,angleDisplayMode:en,colors:e},$e,Ae,Ft)}}const t={lastGridState:oe,showDistances:On,showAngles:ss,distanceSigFigs:Ts,angleDisplayMode:en,angleSigFigs:vi,currentShiftPressed:Fe,viewTransform:pe,colors:e};if(ze){const s=new Set(Ie.map(a=>a.id));let i=!1;if(Ie.length>0){const a=new Set(Ws(Ie[0].id));i=!(s.size===a.size&&[...s].every(r=>a.has(r)))}const o=ye.map(a=>De.find(c=>c.id===a.id)||a);if(i&&Fe)Ie.forEach(a=>{Sn(a.id,U).some(c=>!s.has(c))&&Vo(Oe,yt,a.id,o,t,Ae,c=>Sn(c,U),le,Fe,null,Ft,Ce,!0,Ie,rt,kt)});else if(he&&(he.targetVertex||he.targetEdge)){const a=he.targetVertex?he.targetVertex.id:Ie[0]?.id;a&&Vo(Oe,yt,a,o,t,Ae,r=>Sn(r,U),le,Fe,null,Ft,Ce,!0,Ie,rt,kt),he.targetEdge&&Ml(Oe,yt,be,U,{showDistances:On,distanceSigFigs:Ts,colors:e,lastGridState:oe,currentShiftPressed:Fe},J,le,Ae,Ft,De,Ie,st)}}else(On||ss)&&!ot&&!(parseInt(Jt||"1",10)>1&&ze)&&!sn&&(Ce.length>0&&Ce.length<=nh&&Ce.forEach(s=>{Vo(Oe,yt,s,ye,{...t,currentShiftPressed:!1},Ae,i=>Sn(i,U),le,!1,null,Ft,Ce,!1,[],rt)}),be.length>0&&be.length<=sh&&(Ml(Oe,yt,be,U,{showDistances:On,distanceSigFigs:Ts,colors:e,lastGridState:oe},J,le,Ae,Ft,De,Ie,st),Ff(Oe,yt,be,U,{showAngles:ss,angleSigFigs:vi,angleDisplayMode:en,currentShiftPressed:Fe,distanceSigFigs:Ts,viewTransform:pe,lastGridState:oe,colors:e},J,le,Ae,s=>Sn(s,U),Ft)));const n=!Pt&&(yn||Kt||Vt);if(ot&&St&&!n){const s=J(St);if(s){const i=Br(s.id),o=ii(s,te,Fe);let a=qe(tt),r=null;const c=Re[tt];if(c!==-1){const h=we[c];if(h&&h.type==="colormap"&&Be&&Be.length>=1){const f=Be.length,u=Be.length-1,p=f>1?u/(f-1):0,g=f>1?(u+1)/f:1;r={colormapItem:h,startT:p,endT:g}}}Jl(Oe,{startVertex:s,snappedData:o,isShiftPressed:Fe,currentColor:qe(et),nextCreationColor:qe(et),nextEdgeColor:a,colors:e,edgeColormapInfo:r,interpolationStyle:Io()},Ae);const l={x:o.x,y:o.y};ec(Oe,yt,s,l,o,{showDistances:On,showAngles:ss,currentShiftPressed:Fe,distanceSigFigs:Ts,angleSigFigs:vi,angleDisplayMode:en,viewTransform:pe,frozenReference_D_du:Et,gridDisplayMode:xt,frozenReference_A_rad:jt,colors:e},Ae,i,Ft)}}if(Ue&&!n){const s={...Ue,id:"ghost",type:"regular"};$i(Oe,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:_n==="vertex"||_n==="edge_fraction"||_n==="edge"?_n:null,currentAltPressed:Pt},Ae)}if(Cn&&ze&&Of(Oe,ji,te,e),lf(Oe,{info:{...Gi,startVertex:J(St)},colors:e},Ae,J,Ft),(st||Dn)&&uf(Oe,yt,{transformIndicatorData:st,colors:e,coordSystemTransformIndicatorData:Dn,currentShiftPressed:Fe},Ae,Ft),Ue&&!n){const s={...Ue,id:"ghost",type:"regular"},i=_n==="vertex"||_n==="edge_fraction"||_n==="edge";i?$i(Oe,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:i?_n:null,currentAltPressed:Pt},Ae):br(Oe,s,{colors:e,verticesVisible:!0,isSnapped:!0},Ae)}}function kg(e){if(yn=null,Kt=null,Vt=null,Hi=null,Ue=null,_n=null,!Ut){if(!Pt){const o=Ic(e);if(o){Hi=o.id;return}}const t=bo(e),n=t?null:vo(e),s=!t&&!n?Mo(e):null,i=t||n||s;if(Pt)i?Vr(e,Fe):dt=null,yn=null,Kt=null,Vt=null;else if(t?yn=t.id:n?Kt=le(n):s&&(Vt=s.id),Fe&&!i){$e(e);const o=ii({id:"dummy_start",x:0,y:0},e,!0);o.snapped&&(Ue={x:o.x,y:o.y},_n=o.snapType)}}}function Rg(e){if(St){const t=J(St);if(t)if(Fe){const n=ii(t,e,Fe);Gi=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else Gi=null}Ue=null}function Lg(e,t,n,s){const i=Xu(n,e,t,s,Ei);let o={},a={};if(s===mn)o=Gu(n,Ie,t,i.rotation,e),a={rotation:o.rotation,scale:1,directionalScale:!1},Ei=i.rotation;else if(s===ts)o=Wu(n,Ie,t,i.scale),a={rotation:0,scale:o.scale||i.scale,directionalScale:!1};else if(s===vn)o=Yu(n,Ie,t,i.rotation,i.scale),a={rotation:o.rotation,scale:o.scale,directionalScale:!1},Ei=i.rotation;else if(s===Ms){const h={x:t.x-n.x,y:t.y-n.y};o=zu(n,Ie,t,i.scale,h,e),a={rotation:0,scale:o.scale||i.scale,directionalScale:!0}}o.snapped&&o.snapType==="projection"&&o.projectionSource&&(Ue=o.projectionSource);const r={x:t.x-n.x,y:t.y-n.y};st={center:n,startPos:t,currentPos:o.pos||e,rotation:a.rotation,scale:a.scale,isSnapping:o.snapped||!1,transformType:s,directionalScale:a.directionalScale,snappedScaleValue:o.snappedScaleValue||null,gridToGridInfo:o.gridToGridInfo||null,gridPoint:o.gridPoint||null,nearbyVertex:o.nearbyVertex||null,projectionPoint:o.projectionPoint||null,projectionSource:o.projectionSource||null,snapType:o.snapType||null,projectionCenter:o.snapType==="projection"?n:null,projectionHandleInitial:o.projectionHandleInitial||null,startVector:r};const c={x:t.x-n.x,y:t.y-n.y};if(De=Ie.map(h=>{const f=je(h,n,a.rotation,a.scale,a.directionalScale,c);return{...h,x:f.x,y:f.y}}),o.snapped&&o.snapType==="merge"&&o.mergingVertex&&o.mergeTarget){const h=Ie.find(f=>f.id===o.mergingVertex.id);if(h){const f=De.find(u=>u.id===h.id);if(f){const u={x:o.mergeTarget.x-f.x,y:o.mergeTarget.y-f.y};De.forEach(p=>{p.x+=u.x,p.y+=u.y}),st.currentPos&&(st.currentPos.x+=u.x,st.currentPos.y+=u.y)}}}const l=Je*2/pe.scale,d=ye.filter(h=>h.type==="regular"&&!Ie.some(f=>f.id===h.id));De.forEach(h=>{h.type==="regular"&&d.forEach(f=>{re(h,f)<l&&Ys.push({x:f.x,y:f.y})})});for(let h=0;h<De.length;h++)for(let f=h+1;f<De.length;f++){const u=De[h],p=De[f];u.type==="regular"&&p.type==="regular"&&re(u,p)<l&&Ys.push({x:(u.x+p.x)/2,y:(u.y+p.y)/2})}}function Ng(e){if(ao&&Wt){const t=j.colorTargetIcons.find(n=>n.target===Wt.target);if(t){const n=[...j.colorSwatches],s=Kl(e,n);s?(t.x=s.x+(s.width-t.width)/2,t.y=s.y-t.height-5,Wt.previewColorIndex=s.index,Qi(Wt.target).forEach(i=>{const o=j.colorTargetIcons.find(a=>a.target===i);o&&(o.x=t.x,o.y=t.y)})):(t.x=e.x-Wt.offsetX,t.y=e.y-Wt.offsetY,Wt.previewColorIndex=Wt.originalColorIndex,Qi(Wt.target).forEach(i=>{const o=j.colorTargetIcons.find(a=>a.target===i);o&&(o.x=t.x,o.y=t.y)}))}return!0}if(fs){const t=bt.originalIndex,n=j.colorSwatches.filter(i=>i.index!==t);let s=n.length;for(let i=0;i<n.length;i++){const o=n[i],a=o.x+o.width/2;if(e.x<a){s=i;break}}return bt.previewIndex!==s&&(bt.previewIndex=s,At()),!0}return!!Go}function Xr(){if(Ut||ot){dt=null,Ue=null,yn=null,Kt=null,Vt=null;return}Pt?Vr(te,Fe):(dt=null,kg(te))}function Bc(e){if(te=To(e,Te),Fe=e.shiftKey,Pt=e.altKey,wo=e.ctrlKey||e.metaKey,Nr(te)?Te.style.cursor="default":sn?Te.style.cursor="none":Kn||ze?Te.style.cursor="grabbing":Te.style.cursor="crosshair",Ut){if(!ze&&re(te,ln)>Td&&!ot){if(ze=!0,he&&he.target==="coord_system")return;if(Ui=he.dragHandle,Ki=he.target==="edge",he.target==="ui_icon_click"){ao=!0;const t=he.element.target;Wt={target:t,offsetX:te.x-he.element.x,offsetY:te.y-he.element.y,originalColorIndex:Re[t],previewColorIndex:Re[t]},he.target="ui_icon_drag",Qe=[t,...Qi()]}else if(he.target==="ui_swatch")nt(),fs=!0,bt={index:he.element.index,item:he.element.item,offsetX:te.x-he.element.x,originalIndex:he.element.index,originalAllColors:JSON.parse(JSON.stringify(we)),originalAssignments:JSON.parse(JSON.stringify(Re)),previewIndex:he.element.index};else if(he.target==="ui_session")Go=!0,Ci={index:he.element.index,session:he.element.session,offsetX:te.x-he.element.x,offsetY:te.y-he.element.y},he.target="ui_session_drag";else if(tn===2){Cn=!0;return}else if(he.target==="canvas")Kn=!0,La={x:pe.offsetX,y:pe.offsetY},Te.style.cursor="move";else{Te.style.cursor="grabbing",ks=he.targetVertex&&he.targetVertex.type!=="regular"&&!he.isTransformDrag;let n;if(ks)n=[he.targetVertex];else{let i=new Set(Ce);be.forEach(o=>{const[a,r]=o.split(fo);i.add(a),i.add(r)}),ge.forEach(o=>{const a=ie.find(r=>ue(r)===o);a&&kc(a.id,ie).forEach(c=>i.add(c))}),n=Array.from(i).map(o=>J(o)).filter(o=>o&&o.type==="regular")}if(ks&&he.targetVertex.type===mn){const i=he.targetVertex,o=$e(ln),a={x:o.x-i.x,y:o.y-i.y};he.initialRotationStartAngle=Math.atan2(a.y,a.x),Ei=0}const s=_e.map(i=>So(i)).filter(Boolean);if(n.length>0||s.length>0){Ie=JSON.parse(JSON.stringify(n)),De=JSON.parse(JSON.stringify(n)),oo=JSON.parse(JSON.stringify(s)),qa=JSON.parse(JSON.stringify(s)),Hn.clear();const i=new Set(Ie.map(o=>o.id));ie.forEach(o=>{o.vertexIds.some(a=>i.has(a))&&o.localCoordSystem&&Hn.set(o.id,JSON.parse(JSON.stringify(o.localCoordSystem)))})}}}if(ze){if(Kn){const t=te.x-ln.x,n=te.y-ln.y;pe.offsetX=La.x+t*Ke,pe.offsetY=La.y-n*Ke}else if(!Cn){if(Ng(te)||fg(e))return;if(rt&&(Ce.length>0||be.length>0||ge.length>0||_e.length>0)&&!Ki){const n=J(rt);let s=Ui;!s&&Ie.length>0&&(s=Ie.find(i=>i.type==="regular"&&re(i,n)>1e-6)||Ie.find(i=>i.type==="regular")),n&&s&&Lg($e(te),s,n,n.type)}else if(De.length>0){const n=Ie.length===1&&Ie[0].type==="regular",s=$e(te);if(n){const i=Ie[0];Sn(i.id,U).filter(a=>!Ie.some(r=>r.id===a)).map(a=>J(a));const o=vu(i,s);if(De[0].x=o.pos.x,De[0].y=o.pos.y,kt.clear(),Xs.clear(),o.snapped){const a={copyIndex:0,type:o.snapType,projectionLine:o.projectionLine};kt.set(i.id,[a]),o.targetEdge&&Xs.set(le(o.targetEdge),[{copyIndex:0,type:"external_to_static"}])}he.finalSnapResult={...o,finalDelta:{x:o.pos.x-i.x,y:o.pos.y-i.y}}}else{const i=$e(ln),o={x:s.x-i.x,y:s.y-i.y};_g(o)}}else if(qa.length>0){const n=$e(ln),s=$e(te),i={x:s.x-n.x,y:s.y-n.y};he.textFinalDelta=i}}}}else ot?Rg(te):Xr();un("mouseMove",{clientX:e.clientX,clientY:e.clientY,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey}),Xt()}function $c(e,t){if(kt.clear(),Xs.clear(),!t||!t.snapped)return;const n=(s,i,o,a)=>{if(i===void 0)return;let r;if(o===void 0)r=void 0;else if(o===-1)r=0;else if(o>=0)r=o;else return;(r===void 0||r>=0)&&(s.has(i)||s.set(i,[]),s.get(i).some(c=>c.copyIndex===r&&c.type===a)||s.get(i).push({copyIndex:r,type:a}))};t.mergePairs.forEach(s=>{n(kt,s.source.originalId,s.source.transformIndex,"vertex"),n(kt,s.target.originalId,s.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:s,targetEdge:i})=>{n(kt,s.originalId,s.transformIndex,"edge"),n(Xs,i.originalEdgeId,i.transformIndex,"vertex_on_edge")})}function Og(e,t,n){const s=2*Je/n.scale,i=new Map,o=new Map,a=new Map;e.forEach(d=>a.set(d.id,d.id));const r=d=>{if(!a.has(d)||a.get(d)===d)return d;const h=r(a.get(d));return a.set(d,h),h};for(let d=0;d<e.length;d++)for(let h=d+1;h<e.length;h++){const f=e[d],u=e[h];if(f.type==="regular"&&u.type==="regular"&&re(f,u)<s){const p=r(f.id),g=r(u.id);p!==g&&a.set(g,p)}}e.forEach(d=>{const h=r(d.id);d.id!==h&&i.set(d.id,h)});const c=new Set(i.keys()),l=new Map(e.map(d=>[d.id,d]));return t.forEach(d=>{const h=r(d.id1),f=r(d.id2);if(h===f)return;const u=l.get(h),p=l.get(f);!u||!p||e.forEach(g=>{if(g.type!=="regular"||c.has(g.id)||g.id===h||g.id===f)return;const y=Lt(g,u,p);if(y.distance<s&&y.onSegmentStrict){const m=le({id1:h,id2:f});o.has(m)||o.set(m,{edge:{id1:h,id2:f},pointsToInsert:[]}),o.get(m).pointsToInsert.push(g)}})}),{vertexMerges:i,edgeSplits:o}}function Vc(e){Qn?ug():tn===0?Mg():tn===2&&Cg(e),Qn||Xc(),Nr(te)?Te.style.cursor="default":sn||(Te.style.cursor="crosshair"),Qt(),tn===2?un("rightMouseUp",e):tn===0&&un("mouseUp",e),Xt()}function Xc(){nn&&clearTimeout(nn),Jt="",nn=null,Ut=!1,ze=!1,Cn=!1,Ki=!1,ks=!1,Kn=!1,De=[],Ie=[],qa=[],oo=[],he=null,st=null,Ys=[],Ue=null,Xs.clear(),kt.clear(),Hn.clear(),tn=-1}function Yc(e){nn&&clearTimeout(nn),Jt="",nn=null,Ct.style.display==="block"&&(Ct.style.display="none");const t=e.target;if(t&&(t.tagName==="INPUT"||t.closest(".katex"))){e.stopPropagation(),Xt();return}if((ot||sn)&&e.button===2){vs(),e.preventDefault(),Xt();return}te=To(e,Te),ln={...te},tn=e.button,tn===0?(Sg(e),un("mouseDown",e)):tn===2&&(Eg(e),un("rightMouseDown",e)),Xt()}function Gc(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;const t=()=>{un("keyDown",e),Xt()};if((e.key==="Control"||e.key==="Meta")&&(wo=!0),e.key==="Alt"&&!e.repeat&&(e.preventDefault(),Pt=!0,Xr()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!ot&&!sn&&!Ut){e.preventDefault(),er(e.key),Xt();return}const s=e.ctrlKey||e.metaKey;if(s&&(e.key==="a"||e.key==="A")){e.preventDefault();const o=ye.filter(l=>l.type==="regular").map(l=>l.id),a=U.map(l=>le(l)),r=ie.map(l=>ue(l)),c=We.map(l=>l.id);Yt(o,a,r,!1,!1,!1,c),Ye=ye.filter(l=>l.type!=="regular").map(l=>l.id),rt=Ye.length>0?Ye[Ye.length-1]:null,t();return}if(e.key==="Shift"&&!Fe){Fe=!0;const o=$e(te);if(sn){const a=Pi(o);a&&(si=Ae(a),Ue=a)}else if(ot&&St){const a=J(St);if(a){const r=ua(),c=Br(a.id),l=ii(a,te,Fe);let d=qe(tt),h=null;const f=Re[tt];if(f!==-1){const p=we[f];if(p&&p.type==="colormap"&&Be&&Be.length>=1){const g=Be.length,y=Be.length-1,m=g>1?y/(g-1):0,x=g>1?(y+1)/g:1;h={colormapItem:p,startT:m,endT:x}}}Jl(Oe,{startVertex:a,snappedData:l,isShiftPressed:Fe,currentColor:qe(et),nextCreationColor:qe(et),nextEdgeColor:d,colors:r,edgeColormapInfo:h,interpolationStyle:Io()},Ae),ec(Oe,yt,a,l,l,{showDistances:On,showAngles:ss,currentShiftPressed:Fe,distanceSigFigs:Ts,angleSigFigs:vi,angleDisplayMode:en,viewTransform:pe,frozenReference_D_du:Et,gridDisplayMode:xt,frozenReference_A_rad:jt,colors:r},Ae,c,Ft)}}else if(!Ut)if(Qn&&wn&&wn.type==="center"){const a=Pi(o);if(a){Ue=a;const r=wn.face,c=r.localCoordSystem,l=r.vertexIds.map(h=>J(h)).filter(h=>h&&h.type==="regular"),d=go(a,l);c.origin.x=d.x,c.origin.y=d.y,c.isCustom=!0}}else{const a=bo(te),r=a?null:vo(te),c=!a&&!r?Mo(te):null;!a&&!r&&!c?Ue=Pi(o):Ue=null}}if(Ut&&tn===0&&(he?.targetVertex||he?.targetEdge||he?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(nn),nn===null||Jt.length>=2?Jt=e.key:Jt+=e.key;const o=parseInt(Jt,10)||1;if(he?.finalSnapResult?.finalDelta){const a=he.finalSnapResult.finalDelta,r={delta:a},l=ql(Ie,ye,U,J,o,pe,r,(d,h,f=r)=>({x:d.x+f.delta.x*h,y:d.y+f.delta.y*h}));$c(a,l),he.finalSnapResult={...l,finalDelta:a}}nn=setTimeout(()=>{nn=null},500)}if(s&&e.key.toLowerCase()===mh){e.preventDefault(),ot&&St&&Uu(),t();return}if(!(Ut&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(s&&[fl,gl,ul,wa,pl,yl,hl,cl,dl].includes(e.key.toLowerCase())))){if(Uo&&s&&(e.key===cl||e.key===dl)){e.preventDefault();const o={x:Te.width/Ke/2,y:Te.height/Ke/2};ta(o,el),t();return}if(Uo&&s&&e.key===hl){e.preventDefault();const o={x:Te.width/Ke/2,y:Te.height/Ke/2};ta(o,1/el),t();return}if(e.key===uh)e.preventDefault(),Vu();else if(e.key===gh)vs();else if(e.key===ph||e.key===yh)e.preventDefault(),di();else if(s&&e.key.toLowerCase()===fl){if(vt&&Ve[Nt]){e.preventDefault(),Yo=JSON.parse(JSON.stringify(Ve[Nt])),t();return}e.preventDefault(),Dc()}else if(s&&e.key.toLowerCase()===gl)e.preventDefault(),Fu();else if(s&&e.key.toLowerCase()===ul){if(vt&&Yo){e.preventDefault(),Ru(),t();return}e.preventDefault(),Bu()}else if(s&&e.key.toLowerCase()===wa&&!e.shiftKey){if(vt&&Ji.length>0){e.preventDefault(),Lu(),t();return}e.preventDefault(),cg()}else if(s&&(e.key.toLowerCase()===pl||e.shiftKey&&e.key.toLowerCase()===wa))e.preventDefault(),dg();else if(s&&e.key.toLowerCase()===yl&&!Ja){e.preventDefault(),nt(),Ce=ye.filter(a=>a.type==="regular").map(a=>a.id),be=U.map(a=>le(a)),ge=ie.map(a=>a.id),Ye=ye.filter(a=>a.type!=="regular").map(a=>a.id),rt=null;const o=[];ge.length>0&&o.push(at),be.length>0&&o.push(tt),Ce.length>0&&o.push(et),_e.length>0&&o.push(Ht),o.length>0&&(Qe=o,gt&&At())}t()}}function Wc(e){const t=()=>{un("keyUp",e),Xt()};if(e.key==="Shift"&&(Fe=!1,Ue=null,si=null,Ys=[],Qn&&wn&&wn.type==="center")){const n=$e(te),s=wn.face,i=s.localCoordSystem,o=s.vertexIds.map(r=>J(r)).filter(r=>r&&r.type==="regular"),a=go(n,o);i.origin.x=a.x,i.origin.y=a.y,i.isCustom=!0}e.key==="Alt"&&(Pt=!1,Xr()),(e.key==="Control"||e.key==="Meta")&&(wo=!1),Qt(),t()}function zc(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,s=t.offsetHeight;Te.width=n*Ke,Te.height=s*Ke,Te.style.width=`${n}px`,Te.style.height=`${s}px`,yt&&(yt.style.width=`${n}px`,yt.style.height=`${s}px`)}function Fg(){iu(),we=ia.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),Eu(),vc(),zc(),lu(),Yf({canvas:Te,onMouseDown:Yc,onMouseMove:Bc,onMouseUp:Vc,onPinchZoom:(n,s)=>{ta(s,n),Xt()},onPan:n=>{$u(n),Xt()},getModifiers:()=>({shiftKey:Fe,ctrlKey:wo,altKey:Pt}),isHoverMode:()=>Mi,getHoverTarget:()=>Pe.hoverTarget,getUiTargetAt:cu}),os=new Uc,os.initialize(),document.body.appendChild(os.getElement());const e=os.getElement();e.addEventListener("mouseenter",()=>{Ja=!0}),e.addEventListener("mouseleave",()=>{Ja=!1}),os.getElement().addEventListener("select",n=>{const s=n.detail,i=$h(s);if(i){if(qi&&Xo!==null)we[Xo]=i;else{wu(i);const o=we.length-1;Qe.forEach(a=>{Re[a]=o})}_r(),qi=!1,Xo=null,At()}}),to=new ad({container:document.body,onSelect:n=>{if(!n)return;const s={...n};s.id||(s.id=$t());const i=pn.findIndex(o=>o.id===s.id);i>=0?pn[i]=s:pn.push(s),wi(s.id),cn&&Lr(),Qt()}}),to.initialize(),pe.scale=70,pe.offsetX=Te.width/2,pe.offsetY=Te.height/2,Vs="regular",Ct=document.getElementById("context-menu"),window.addEventListener("click",()=>{Ct&&(Ct.style.display="none")}),Ct.addEventListener("mouseleave",()=>{Ct.style.display="none"}),_u()||(Au()||nt(),Du()),Fc(),Zt(),Xt()}Te.addEventListener("wheel",Tg,{passive:!1});Te.addEventListener("mouseenter",wg);Te.addEventListener("mouseleave",Pg);window.addEventListener("contextmenu",Ag);Te.addEventListener("mousemove",Bc);Te.addEventListener("mouseup",Vc);Te.addEventListener("mousedown",Yc);window.addEventListener("keyup",Wc);window.addEventListener("keydown",Gc);window.addEventListener("resize",zc);window.addEventListener("beforeunload",()=>{Ac()});window.addEventListener("load",Fg);

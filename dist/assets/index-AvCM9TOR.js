(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const Li="#3b82f6",Oi="#4a5568",Ni="#718096",Kl=300,Bi="#242c3a",Ps=2,rr=3,be=9,Fi=12,Jl=5,lr=8,We=8,cr=.9,dr=5,Oo=[4,4],Zl={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},Ql={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class ec{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=Zl,this.namedColormaps=Ql,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,o=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,s=1;if(o&&o.type==="colormap"&&(o.points||o.controlPoints)){this.state.isCyclic=o.isCyclic===!0;let a=JSON.parse(JSON.stringify(o.controlPoints||o.points));if(a.length===1){a[0].pos=.5;const r=a[0].color,c=r[0]/255,l=r[1]/255,d=r[2]/255;i=(c+l+d)/3,s=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(r=>{const c=r.color,l=r.alpha!==void 0?r.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,l,r.pos,r.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=s,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async o=>{const i=await fetch(o);if(!i.ok)throw new Error(`Failed to fetch preset file at ${o}: Status ${i.status}`);return await i.json()},n=o=>{try{const i=localStorage.getItem(o);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:o}=t.dataset;if(o==="named_colors"||o==="custom_colors"){let i;if(o==="named_colors"?i=this.namedColors[n]:i=this.customColors[n]?.rgb,!i){console.error(`RGB undefined for ${n} in ${o}`);return}this.applyColorToSelection(i)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const i=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(i==="Cancel"||i==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,o)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,o=t[1]/255,i=t[2]/255;if(this.state.selectedPointIds.size===0){const s=this.state.points.length;s>0&&this.state.points.forEach(c=>{c.pos=c.pos*(s/(s+1))});const a=s===0?.5:1,r=this.createPointFromRgb(n,o,i,1,a,1);this.state.points.push(r),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const r=this.convertRgbToCurrentColorspace(n,o,i);a.hsPos=r.hsPos,a.originalHsPos={...r.hsPos},a.lightness=r.lightness}});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha)}this.drawAll()}loadColormap(t,n,o=!1){o||this.saveState();const i=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!i||!i.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const s=i.points.map(a=>{let r=[0,0,0];typeof a.color=="string"?r=this.namedColors[a.color]||this.customColors[a.color]?.rgb||r:Array.isArray(a.color)&&(r=a.color);const c=r[0]/255,l=r[1]/255,d=r[2]/255,h=a.alpha??1;return this.createPointFromRgb(c,l,d,h,a.pos,a.order)});this.state.points=s,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=($,A={})=>{const k=document.createElement($);if(A.id){k.id=A.id;const V=A.id.replace(/-(\w)/g,(Y,X)=>X.toUpperCase());this.elements[V]=k}return A.className&&(k.className=A.className),A.text&&(k.textContent=A.text),A.type&&(k.type=A.type),A.placeholder&&(k.placeholder=A.placeholder),k};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),o=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const s=t("div",{id:"selected-color-section",className:"control-section"}),a=t("div",{id:"current-colormap-section",className:"control-section"}),r=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),r.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(r,c);const d=t("h2",{className:"panel-header",text:"Lightness"}),h=t("div",{id:"lightness-slider-container",className:"canvas-container"}),f=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});h.append(t("canvas",{id:"lightness-bg-canvas"}),f),o.append(d,h);const u=t("h2",{className:"panel-header",text:"Alpha"}),g=t("div",{id:"alpha-slider-container",className:"canvas-container"}),p=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});g.append(t("canvas",{id:"alpha-bg-canvas"}),p),i.append(u,g);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const S=t("div",{className:"preset-category-header"});S.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(S,t("div",{className:"preset-items-container"}));const m=t("h3",{className:"section-title",text:"Selected Color"}),x=t("div",{className:"preview-container"});x.append(t("canvas",{id:"selected-color-preview-canvas"}));const I=t("div",{className:"space-y-2"}),b=t("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const v=t("div");v.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const C=t("div");C.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const w=t("div");w.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),b.append(v,C,w),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const P=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),T=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),M=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(P,T,M),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const E=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),N=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(E,N);const _=t("h3",{className:"input-label",text:"Interpolation"});_.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const D=t("div",{className:"interpolation-grid"});D.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),D.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),I.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,_,D),s.append(m,x,I);const F=t("h3",{className:"section-title text-center",text:"Current Colormap"}),R=t("div",{className:"preview-container"});R.append(t("canvas",{id:"colormap-preview-canvas"}));const B=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const L=t("div",{className:"button-row"});L.append(this.elements.reverseButton,this.elements.cycleButton),B.append(L,this.elements.closeButton,this.elements.selectButton),a.append(F,R,B),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const O=t("div",{id:"modal-dialog",className:"modal-dialog"});O.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),O.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(O),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,o,this.elements.colorsPresetsWrapper,s,i,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(f,"lightness"),this.createInteractiveCanvas(p,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const o=i=>{const s=i.target.closest(".preset-item");s&&(i.type==="click"?this.handlePresetClick(s):i.type==="contextmenu"&&s.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,s.dataset.name,s.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",o),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",o),this.elements.colormapsPresetsWrapper.addEventListener("click",o),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",o),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const s=this.state.points,a=s.length,r=(u,g)=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(p);return{pos:parseFloat((g!==void 0?g:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let g=0;g<u;g++){const p=s[g],y=s[(g+1)%a];i.push(r(p));const S=Math.max(p.order,y.order);if(S===0){let m=p.pos,x=y.pos;this.state.isCyclic&&x<m&&(x+=1);const I=m+(x-m)*.5;i.push(r(p,this.wrapPositionCyclic(I-1e-6))),i.push(r(y,this.wrapPositionCyclic(I)))}else if(S===3){const x=p.pos;let I=y.pos;this.state.isCyclic&&I<x&&(I+=1);const b=I-x;for(let v=1;v<16;v++){const C=v/16,w=x+C*b,P=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(w));if(P){const T=this.abstractToRgb(P.u,P.v,P.lightness),M=this.clampColor(T);i.push({pos:parseFloat(this.wrapPositionCyclic(w).toFixed(6)),alpha:parseFloat(P.alpha.toFixed(4)),color:[M.r,M.g,M.b],order:P.order})}}}}this.state.isCyclic||i.push(r(s[a-1]))}const c=new Map;i.forEach(u=>c.set(u.pos,u));let l=Array.from(c.values()).sort((u,g)=>u.pos-g.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const d=this.state.points.map(u=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),p=this.clampColor(g);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[p.r,p.g,p.b],order:u.order}}),h={points:l,controlPoints:d,isCyclic:this.state.isCyclic},f=new CustomEvent("select",{detail:h,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(f)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,o){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const s={Rename:()=>this.handlePresetAction("rename",n,o),Delete:()=>this.handlePresetAction("delete",n,o)};for(const[a,r]of Object.entries(s)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=r,i.appendChild(c)}i.style.left=`${t.clientX}px`,i.style.top=`${t.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,o){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(o==="custom_colors"&&delete this.customColors[n],o==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(o),this.populatePresets());else if(t==="rename"){const i=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(i&&i!==n){const s=o==="custom_colors"?this.customColors:this.customColormaps;if(s[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}s[i]=s[n],delete s[n],this.saveCustomPresets(o),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const o=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!o)return!1;if(t==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const s=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),a=this.clampColor(s);this.customColors[o]={rgb:[a.r,a.g,a.b],alpha:i.alpha}}else{const i=this.state.points.map(s=>{const a=this.abstractToRgb(s.hsPos.u,s.hsPos.v,s.lightness),r=this.clampColor(a);return{pos:s.pos,alpha:s.alpha,color:[r.r,r.g,r.b],order:s.order}});this.customColormaps[o]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=o,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(s,a)=>{const r=document.createElement("div");r.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=s;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=a,r.appendChild(c),r.appendChild(l),r},n=(s,a,r,c)=>{Object.keys(a).sort().forEach(l=>{const d=document.createElement("div");d.className="preset-item",d.dataset.name=l,d.dataset.type=r,d.dataset.custom=c;const h=document.createElement("canvas");h.className="preset-icon",r.includes("colormap")?(h.width=64,h.height=16):(h.width=16,h.height=16);const f=document.createElement("span");if(f.textContent=l,d.appendChild(h),d.appendChild(f),s.appendChild(d),r==="named_colors"||r==="custom_colors"){const u=a[l],g=c?u.rgb:u;this.drawColorIcon(h,g)}else this.drawColormapIcon(h,a[l].points,this.namedColors,this.customColors)})},o=document.createElement("div");o.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(o),n(o,this.namedColors,"named_colors",!1),n(o,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),n(i,this.namedColormaps,"named_colormaps",!1),n(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,o,i){const s=n.map(d=>{let h=[0,0,0];typeof d.color=="string"?h=o[d.color]||(i[d.color]?i[d.color].rgb:[0,0,0]):Array.isArray(d.color)&&(h=d.color);const{hsPos:f,lightness:u}=this.convertRgbToCurrentColorspace(h[0]/255,h[1]/255,h[2]/255);return{id:Math.random(),hsPos:f,originalHsPos:{...f},lightness:u,alpha:d.alpha??1,pos:d.pos,order:1}}).sort((d,h)=>d.pos-h.pos),a=this.state.points;this.state.points=s;const r=t.getContext("2d"),{width:c,height:l}=t;if(this.drawCheckerboard(r),this.state.points.length>0)for(let d=0;d<c;d++){const h=d/(c-1),f=this.getInterpolatedPropertiesAt(h);if(!f)continue;const u=this.clampAbstractPoint(f.u,f.v,f.lightness),g=this.abstractToRgb(u.u,u.v,f.lightness),{r:p,g:y,b:S}=this.clampColor(g);r.fillStyle=`rgba(${p}, ${y}, ${S}, ${f.alpha})`,r.fillRect(d,0,1,l)}this.state.points=a}showPrompt(t,n,o=null){return new Promise(i=>{const{modalOverlay:s,modalTitle:a,modalInputContainer:r,modalInput:c,modalButtons:l}=this.elements,d=document.querySelectorAll("[data-tick-canvas]");d.forEach(h=>h.style.display="none"),a.textContent=t,l.innerHTML="",o?(c.value=o.value||"",c.placeholder=o.placeholder||"",r.classList.remove("hidden")):r.classList.add("hidden"),n.forEach(h=>{const f=document.createElement("button");f.className=`modal-button ${h==="Save"||h==="Delete"||h==="Rename"?"modal-button-primary":"modal-button-secondary"}`,f.textContent=h,f.onclick=()=>{s.classList.add("hidden"),d.forEach(u=>u.style.display=""),i(o?c.value:h)},l.appendChild(f)}),s.classList.remove("hidden"),o&&c.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(o=>o.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(o=>Math.abs(o.pos)<1e-6),n=this.state.points.some(o=>Math.abs(o.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(s=>({id:s.id,pos:s.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(s=>{s.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const o=t.getContext("2d");o.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,o.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,o,i,s,a){const{hsPos:r,lightness:c}=this.convertRgbToCurrentColorspace(t,n,o);return{id:Date.now()+Math.random(),hsPos:r,originalHsPos:{...r},lightness:c,alpha:i,pos:s,order:a}}convertRgbToCurrentColorspace(t,n,o){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:o}),lightness:(t+n+o)/3};{const i=this.rgbToHsl(t,n,o);return{hsPos:this.rgbToHslDiConeAbstract(t,n,o),lightness:i.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:d,clientHeight:h}=l.container;(l.c.width!==d||l.c.height!==h)&&(l.c.width=d,l.c.height=h)});const i=this.elements.hsBgCanvas,s=this.elements.interactiveCanvases.hs,a=i.parentElement,r=a.clientWidth,c=a.clientHeight;[i,s].forEach(l=>{l&&(l.width=r,l.height=c,l.style.width=`${r}px`,l.style.height=`${c}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(i=>{let s;n==="RGB_CUBE"?s=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):s=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let a,r;if(t==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(s),r=(s.r+s.g+s.b)/3;else{const c=this.rgbToHsl(s.r,s.g,s.b);a=this.rgbToHslDiConeAbstract(s.r,s.g,s.b),r=c.l}i.hsPos=a,i.originalHsPos={...a},i.lightness=r});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const o=Date.now(),i=this.elements.interactiveCanvases[n];if(!i)return;const s=i.getBoundingClientRect(),a=i.width/s.width,r=i.height/s.height,c=(t.clientX-s.left)*a,l=(t.clientY-s.top)*r,d={x:c,y:l};let h=!1,f=null,u=!1;if(n==="hs")f=this.findHitPointHS(c,l);else{const S=this.findHitPointSlider(c,l,n);f=S.hitPoint,u=S.hitLine}if(o-this.lastClickTime<Kl&&f&&f.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=o,this.lastClickTarget=f?f.id:null,f){this.state.viewLightness=f.lightness,this.state.viewAlpha=f.alpha;const S=t.ctrlKey||t.metaKey,m=t.shiftKey;!this.state.selectedPointIds.has(f.id)&&!S&&!m&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(f.id),this.state.lastSelectedPointId=f.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=i,this.state.activeDrag.pointId=f?f.id:null,f){const S=new Map;if(n==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:m,offsetX:x,offsetY:I}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const v=b.hsPos.u*m+x,C=b.hsPos.v*m+I;this.state.activeDrag.initialPointPositions.set(b.id,{x:v,y:C})}})}else this.state.points.forEach(m=>{this.state.selectedPointIds.has(m.id)&&S.set(m.id,{lightness:m.lightness-f.lightness,alpha:m.alpha-f.alpha,pos:m.pos-f.pos})}),this.state.activeDrag.offsets=S}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const p=S=>{const m=(S.clientX-s.left)*a,x=(S.clientY-s.top)*r,I=Math.sqrt((m-d.x)**2+(x-d.y)**2);!h&&I>Jl&&(h=!0,f&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(S)},y=S=>{document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",y),h||this.handleClick(c,l,n,f,S),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",p),document.addEventListener("mouseup",y)}handleClick(t,n,o,i,s){const{shiftKey:a,ctrlKey:r,metaKey:c}=s,l=r||c;if(i){const{selectedPointIds:d}=this.state,h=i.id;if(this.clickCount===3)this.state.points.forEach(f=>d.add(f.id)),this.state.lastSelectedPointId=h;else if(this.clickCount===2){const f=this.state.points.findIndex(g=>g.id===h);d.clear(),[f-1,f,f+1].forEach(g=>{g>=0&&g<this.state.points.length&&d.add(this.state.points[g].id)}),this.state.lastSelectedPointId=h}else l?d.has(h)?(d.delete(h),this.state.lastSelectedPointId===h&&(this.state.lastSelectedPointId=d.size>0?Array.from(d)[0]:null)):(d.add(h),this.state.lastSelectedPointId=h):a?(d.add(h),this.state.lastSelectedPointId=h):(d.clear(),d.add(h),this.state.lastSelectedPointId=h)}else if(o==="hs")this.createNewPointHS(t,n);else if(o==="lightness"||o==="alpha"){const d=this.elements.interactiveCanvases[o],h=Math.ceil(be*2.2),f=d.height-2*h,g=(d.height-h-n)/f,p=Math.max(0,Math.min(1,g));o==="lightness"?this.state.viewLightness=p:this.state.viewAlpha=p}this.drawAll()}findHitPointHS(t,n){const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=s,c=this.elements.hsBgCanvas.width-s-o,l=this.elements.hsBgCanvas.height-s-o;for(const d of this.state.points){const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-be&&h<=a+c+be&&f>=r-be&&f<=r+l+be&&Math.sqrt((t-h)**2+(n-f)**2)<=Fi)return d}return null}handleInputChange(t,n){const o=t.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(n==="lightness"||n==="alpha"){const s=parseFloat(o);!isNaN(s)&&s>=0&&s<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[n]=s,n==="lightness"&&this.constrainPointToValidArea(a))}),i=!0)}else if(n==="position"){const s=parseFloat(o);!isNaN(s)&&s>=0&&s<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=s)}),this.sortPoints(),i=!0)}if(i){const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,o,i,s,a,r=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),o=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(o))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,o=Math.max(0,Math.min(255,o))/255;const c=this.rgbCubeRgbToAbstract({r:t,g:n,b:o}),l=(t+n+o)/3;this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...c},d.originalHsPos={...c},d.lightness=l)}),r=!0}else{if(i=parseFloat(this.elements.hslHInput.value),s=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(i)||isNaN(s))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),s=Math.max(0,Math.min(1,s));const c=this.hslToRgb(i,s,a),l=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...l},d.originalHsPos={...l})}),r=!0}if(r){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const o=document.createElement("canvas");o.className=`interactive-canvas ${n}-interactive`,o.dataset.type=n,t.appendChild(o),this.elements.interactiveCanvases[n]=o}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:o,pointId:i}=this.state.activeDrag,s=o,a=s.getBoundingClientRect(),r=s.width/a.width,c=s.height/a.height,l=(t.clientX-a.left)*r,d=(t.clientY-a.top)*c;n.endsWith("-line")?this.handleLineDrag(d,s.height,n):i&&this.handlePointDrag(l,d,s,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),o=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:o}}rgbToHslDiConeAbstract(t,n,o){const i=this.rgbToHsl(t,n,o),s=1-Math.abs(2*i.l-1),a=i.s*s,r=i.h*2*Math.PI,c=a*Math.cos(r),l=a*Math.sin(r);return{u:c,v:l}}hslDiConeAbstractToRgb(t,n,o){const i=(Math.atan2(n,t)/(2*Math.PI)+1)%1,s=Math.sqrt(t*t+n*n),a=o,r=1-Math.abs(2*a-1);if(r<1e-9)return{r:a,g:a,b:a};const c=s/r;return this.hslToRgb(i,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,o=n&&n.tagName==="INPUT",i=t.ctrlKey||t.metaKey;if(i&&t.key==="z"){t.preventDefault(),this.undo();return}if(i&&t.key==="y"){t.preventDefault(),this.redo();return}if(o){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(i&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(s=>this.state.selectedPointIds.add(s.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(s=>!this.state.selectedPointIds.has(s.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,o,i=null){let s=t,a=dr+1;const r=Math.ceil(be*2.2),c=Math.ceil(We/2),l=r+c,d=n-l-r,h=n-r;return this.state.points.forEach(f=>{if(f.id===i)return;const u=h-f[o]*d,g=Math.abs(t-u);g<dr&&g<a&&(s=u,a=g)}),s}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:o}=this.state,i=this.elements.hsBgCanvas.width,s=this.elements.hsBgCanvas.height;if(i===0||s===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=Bi,a.fillRect(0,0,i,s);const r=Math.ceil(be*2.2),c=Math.ceil(We/2),l=r+c,d=i-l-r,h=s-l-r;if(d<=0||h<=0)return;const f=o==="RGB_CUBE"?Math.min(d,h)/(Math.sqrt(2/3)*2)*cr:Math.min(d,h)/2*cr;this.state.transform.scale=f,this.state.transform.offsetX=i/2,this.state.transform.offsetY=s/2;const u=l,g=l,p=d,y=h,S=We,m=Math.round(p/S),x=Math.round(y/S),I=p/m,b=y/x;for(let T=0;T<x;T++)for(let M=0;M<m;M++){const E=u+M*I,N=g+T*b;(T+M)%2===0?a.fillStyle=Ni:a.fillStyle=Oi,a.fillRect(E,N,I,b)}if(o==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const M=i/2,E=s/2,N=t<.5?0:255;a.fillStyle=`rgba(${N}, ${N}, ${N}, ${n})`,a.fillRect(Math.floor(M),Math.floor(E),1,1);return}const v=a.createImageData(p,y),C=v.data;for(let T=0;T<y;T++)for(let M=0;M<p;M++){const E=u+M,N=g+T,_=(E-this.state.transform.offsetX)/this.state.transform.scale,D=(N-this.state.transform.offsetY)/this.state.transform.scale,{r:F,g:R,b:B}=this.abstractToRgb(_,D,t),L=(T*p+M)*4;this.isValidColor(F,R,B)&&(C[L]=Math.round(F*255),C[L+1]=Math.round(R*255),C[L+2]=Math.round(B*255),C[L+3]=255)}const w=document.createElement("canvas");w.width=p,w.height=y,w.getContext("2d").putImageData(v,0,0),a.globalAlpha=n,a.drawImage(w,u,g),a.globalAlpha=1}evaluateCubicSpline(t,n){const o=this.state.points,i=o.length;if(t<0||t>=i)return null;let s,a,r,c;if(this.state.isCyclic){const u=g=>{const p=(g%i+i)%i;return o[p]};t===i-1?(s=u(t-1),a=u(t),r=u(0),c=u(1)):(s=u(t-1),a=u(t),r=u(t+1),c=u(t+2))}else a=o[t],r=o[t+1],s=t>0?o[t-1]:o[t],c=t+2<i?o[t+2]:o[t+1];const l=n,d=l*l,h=d*l,f=(u,g,p,y)=>.5*(2*g+(-u+p)*l+(2*u-5*g+4*p-y)*d+(-u+3*g-3*p+y)*h);return{u:f(s.hsPos.u,a.hsPos.u,r.hsPos.u,c.hsPos.u),v:f(s.hsPos.v,a.hsPos.v,r.hsPos.v,c.hsPos.v),lightness:f(s.lightness,a.lightness,r.lightness,c.lightness),alpha:f(s.alpha,a.alpha,r.alpha,c.alpha),order:2}}isValidColor(t,n,o){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&o>=-.001&&o<=1.001}drawSliderBackgrounds(){const t=Math.ceil(be*2.2),n=Math.ceil(We/2),o=t+n,i=this.elements.lightnessBgCanvas.getContext("2d"),s=this.elements.lightnessBgCanvas;i.fillStyle=Bi,i.fillRect(0,0,s.width,s.height);const a=o,r=s.width-t,c=o,l=s.height-t,d=r-a,h=l-c;if(h>0&&d>0){const I=i.createLinearGradient(0,c,0,l);I.addColorStop(0,"white"),I.addColorStop(1,"black"),i.fillStyle=I,i.fillRect(a,c,d,h)}const f=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;f.fillStyle=Bi,f.fillRect(0,0,u.width,u.height);const g=o,p=u.width-t,y=o,S=u.height-t,m=p-g,x=S-y;if(x>0&&m>0){const I=We,b=Math.round(m/I),v=Math.ceil(x/I),C=m/b,w=I,P=S-v*w;for(let M=0;M<v;M++)for(let E=0;E<b;E++){const N=g+E*C,_=P+M*w;if(_<S&&_+w>y){(M+E)%2===0?f.fillStyle=Ni:f.fillStyle=Oi;const D=Math.max(_,y),F=Math.min(_+w,S)-D;F>0&&f.fillRect(N,D,C,F)}}const T=f.createLinearGradient(0,y,0,S);T.addColorStop(0,"white"),T.addColorStop(1,"rgba(255,255,255,0)"),f.fillStyle=T,f.fillRect(g,y,m,x)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=Li,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=s,c=t.width-s-o,l=t.height-s-o;if(this.state.points.length>1){const d=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let h=0;h<d;h++){const f=this.state.points[h],u=this.state.points[(h+1)%this.state.points.length];if(Math.max(f.order,u.order)===0)continue;let p=f.pos,y=u.pos;this.state.isCyclic&&y<p&&(y+=1);const S=y-p;if(S<1e-9)continue;const m=Math.max(10,Math.ceil(S*100)),x=[];for(let b=0;b<=m;b++){const v=p+b/m*S,C=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(v));if(!C)continue;const w=this.clampAbstractPoint(C.u,C.v,C.lightness),P=w.u*this.state.transform.scale+this.state.transform.offsetX,T=w.v*this.state.transform.scale+this.state.transform.offsetY;x.push({x:P,y:T,isOnPlane:Math.abs(C.lightness-this.state.viewLightness)<1e-10})}if(x.length<2)continue;const I=x.every(b=>b.isOnPlane);n.strokeStyle="black",n.lineWidth=Ps,n.globalAlpha=I?.7:.4,n.setLineDash(I?[]:Oo),n.beginPath(),n.moveTo(x[0].x,x[0].y);for(let b=1;b<x.length;b++)n.lineTo(x[b].x,x[b].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(a,r,c,l),n.clip(),this.state.points.forEach(d=>{const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-be&&h<=a+c+be&&f>=r-be&&f<=r+l+be){const u=this.abstractToRgb(d.hsPos.u,d.hsPos.v,d.lightness),{r:g,g:p,b:y}=this.clampColor(u),S=this.state.selectedPointIds.has(d.id),m=d.id===this.state.lastSelectedPointId,x=Math.abs(d.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),d.order){case 0:this._drawCircle(n,h,f,be);break;case 1:this._drawDroplet(n,h,f,be);break;case 3:this._drawTriangle(n,h,f,be);break;default:this._drawCircle(n,h,f,be)}n.globalAlpha=d.alpha,n.fillStyle=`rgb(${g}, ${p}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=S?Li:"black",n.lineWidth=m?rr:Ps,n.setLineDash(x?[]:Oo),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=t.width-o,c=s,l=t.height-o,d=r-a,h=l-c;let f=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const g=this.getPointById(this.state.activeDrag.pointId);g&&(f=g.lightness)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(g=>{const p=a+g.pos*d,y=l-g.lightness*h,S=this.abstractToRgb(g.hsPos.u,g.hsPos.v,g.lightness),{r:m,g:x,b:I}=this.clampColor(S),b=this.state.selectedPointIds.has(g.id),v=g.id===this.state.lastSelectedPointId;this.drawPoint(n,p,y,m,x,I,b,v,g.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=Ps;const o=this.state.points,i=o.length;if(n==="hs"){t.restore();return}const s=Math.ceil(be*2.2),a=Math.ceil(We/2),r=s+a,c=r,l=t.canvas.height-s,d=t.canvas.width-r-s,h=l-r,f=c+d;if(d<=0){t.restore();return}const u=this.state.isCyclic?i:i-1;for(let g=0;g<u;g++){const p=o[g],y=o[(g+1)%i],S=Math.max(p.order,y.order),m=this.state.isCyclic&&g===i-1;if(S===0){const x=l-p[n]*h,I=l-y[n]*h,b=c+p.pos*d,v=c+y.pos*d;if(m&&p.pos>y.pos){let C=p.pos,w=y.pos+1;const P=C+(w-C)*.5,T=c+(P-Math.floor(P))*d,M=this.getInterpolatedPropertiesAt(p.pos),E=this.getInterpolatedPropertiesAt(y.pos);if(M){const N=this.abstractToRgb(M.u,M.v,M.lightness),_=this.clampColor(N);t.strokeStyle=`rgba(${_.r},${_.g},${_.b},${M.alpha})`,t.setLineDash([]),P>1?(t.beginPath(),t.moveTo(b,x),t.lineTo(f,x),t.stroke(),t.beginPath(),t.moveTo(c,x),t.lineTo(T,x),t.stroke()):(t.beginPath(),t.moveTo(b,x),t.lineTo(T,x),t.stroke())}if(E){const N=this.abstractToRgb(E.u,E.v,E.lightness),_=this.clampColor(N);t.strokeStyle=`rgba(${_.r},${_.g},${_.b},${E.alpha})`,t.setLineDash([]),P>1?(t.beginPath(),t.moveTo(T,I),t.lineTo(v,I),t.stroke()):(t.beginPath(),t.moveTo(T,I),t.lineTo(f,I),t.stroke(),t.beginPath(),t.moveTo(c,I),t.lineTo(v,I),t.stroke())}t.beginPath(),t.setLineDash(Oo),t.strokeStyle="black",t.moveTo(T,x),t.lineTo(T,I),t.stroke()}else if(!m){let C=p.pos,w=y.pos;const P=C+(w-C)*.5,T=c+P*d,M=this.getInterpolatedPropertiesAt(p.pos),E=this.getInterpolatedPropertiesAt(y.pos);if(M){const N=this.abstractToRgb(M.u,M.v,M.lightness),_=this.clampColor(N);t.strokeStyle=`rgba(${_.r},${_.g},${_.b},${M.alpha})`,t.setLineDash([]);const D=g===0&&!this.state.isCyclic?c:b;t.beginPath(),t.moveTo(D,x),t.lineTo(T,x),t.stroke()}if(E){const N=this.abstractToRgb(E.u,E.v,E.lightness),_=this.clampColor(N);t.strokeStyle=`rgba(${_.r},${_.g},${_.b},${E.alpha})`,t.setLineDash([]);const D=g===u-1&&!this.state.isCyclic?f:v;t.beginPath(),t.moveTo(T,I),t.lineTo(D,I),t.stroke()}t.beginPath(),t.setLineDash(Oo),t.strokeStyle="black",t.moveTo(T,x),t.lineTo(T,I),t.stroke()}}else if(t.setLineDash([]),m&&p.pos>y.pos){const x=l-p[n]*h,I=l-y[n]*h,b=c+p.pos*d,v=c+y.pos*d,C=1-p.pos;if(C>1e-6){const w=t.createLinearGradient(b,0,f,0),P=Math.max(2,Math.ceil(C*20));for(let E=0;E<=P;E++){const N=p.pos+E/P*C,_=this.getInterpolatedPropertiesAt(N);if(_){const D=this.abstractToRgb(_.u,_.v,_.lightness),{r:F,g:R,b:B}=this.clampColor(D);w.addColorStop(E/P,`rgba(${F}, ${R}, ${B}, ${_.alpha})`)}}const T=this.getInterpolatedPropertiesAt(1),M=T?l-T[n]*h:x;t.beginPath(),t.moveTo(b,x),t.lineTo(f,M),t.strokeStyle=w,t.stroke()}if(y.pos>1e-6){const w=t.createLinearGradient(c,0,v,0),P=Math.max(2,Math.ceil(y.pos*20));for(let E=0;E<=P;E++){const N=E/P*y.pos,_=this.getInterpolatedPropertiesAt(N);if(_){const D=this.abstractToRgb(_.u,_.v,_.lightness),{r:F,g:R,b:B}=this.clampColor(D);w.addColorStop(E/P,`rgba(${F}, ${R}, ${B}, ${_.alpha})`)}}const T=this.getInterpolatedPropertiesAt(0),M=T?l-T[n]*h:I;t.beginPath(),t.moveTo(c,M),t.lineTo(v,I),t.strokeStyle=w,t.stroke()}}else if(!m){const x=c+p.pos*d,I=c+y.pos*d,b=(v,C,w,P)=>{const T=C-v;if(Math.abs(T)<1e-9)return;const M=t.createLinearGradient(w,0,P,0),E=Math.ceil(Math.abs(P-w)/2);for(let N=0;N<=E;N++){const _=v+N/E*T,D=this.getInterpolatedPropertiesAt(_);if(!D)continue;const F=this.abstractToRgb(D.u,D.v,D.lightness),{r:R,g:B,b:L}=this.clampColor(F);M.addColorStop(N/E,`rgba(${R}, ${B}, ${L}, ${D.alpha})`)}t.beginPath();for(let N=0;N<=E;N++){const _=v+N/E*T,D=this.getInterpolatedPropertiesAt(_);if(!D)continue;const F=Math.max(0,Math.min(1,_)),R=c+F*d,B=l-D[n]*h;N===0?t.moveTo(R,B):t.lineTo(R,B)}t.strokeStyle=M,t.stroke()};if(g===0&&!this.state.isCyclic&&Math.abs(p.pos)>=1e-6){const v=this.getInterpolatedPropertiesAt(p.pos);if(v){const C=this.abstractToRgb(v.u,v.v,v.lightness),{r:w,g:P,b:T}=this.clampColor(C);t.strokeStyle=`rgba(${w}, ${P}, ${T}, ${v.alpha})`;const M=l-v[n]*h;t.beginPath(),t.moveTo(c,M),t.lineTo(x,M),t.stroke()}}if(b(p.pos,y.pos,x,I),g===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const v=this.getInterpolatedPropertiesAt(y.pos);if(v){const C=this.abstractToRgb(v.u,v.v,v.lightness),{r:w,g:P,b:T}=this.clampColor(C);t.strokeStyle=`rgba(${w}, ${P}, ${T}, ${v.alpha})`;const M=l-v[n]*h;t.beginPath(),t.moveTo(I,M),t.lineTo(f,M),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const o=t.lightness<.05||t.lightness>.95,i=n.lightness<.05||n.lightness>.95;if(o&&i)return!0;const s=10;for(let a=0;a<=s;a++){const r=a/s,c=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*r,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*r,d=t.lightness+(n.lightness-t.lightness)*r,h=this.abstractToRgb(c,l,d);if(!this.isValidColor(h.r,h.g,h.b))return!1}return!0}drawInterpolatedPath(t,n,o,i){const s=o.pos-n.pos;if(s<1e-6)return;const a=Math.max(2,Math.ceil(s*t.canvas.width/4));let r=!1;for(let c=0;c<=a;c++){const l=n.pos+c/a*s,d=this.getInterpolatedPropertiesAt(l);if(!d)continue;const h=this.clampAbstractPoint(d.u,d.v,d.lightness),f=h.u*this.state.transform.scale+this.state.transform.offsetX,u=h.v*this.state.transform.scale+this.state.transform.offsetY;!r||c===0?(t.moveTo(f,u),r=!0):t.lineTo(f,u)}}drawHSSegment(t,n,o,i,s){let a=n.pos,r=o.pos;this.state.isCyclic&&r<a&&(r+=1);const c=r-a;if(c<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(c*t.canvas.width/8)),d=[];for(let f=0;f<=l;f++){const u=a+f/l*c,g=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!g)continue;const p=this.clampAbstractPoint(g.u,g.v,g.lightness),y=p.u*this.state.transform.scale+this.state.transform.offsetX,S=p.v*this.state.transform.scale+this.state.transform.offsetY,m=Math.abs(g.lightness-this.state.viewLightness)<1e-10;d.push({x:y,y:S,isOnPlane:m,u:p.u,v:p.v})}if(d.length<2)return;if(d.every(f=>f.isOnPlane)){t.strokeStyle="black",t.lineWidth=Ps,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let f=1;f<d.length;f++)t.lineTo(d[f].x,d[f].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=Ps,t.globalAlpha=.4;const f=Math.sqrt((o.hsPos.u-n.hsPos.u)**2+(o.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+f*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let g=1;g<d.length;g++)t.lineTo(d[g].x,d[g].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const o=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<o;i++){const s=this.state.points[i],a=this.state.points[(i+1)%this.state.points.length];if(Math.max(s.order,a.order)===0)continue;const c=Math.abs(s.lightness-this.state.viewLightness)<1e-10,l=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&l)continue;const d=s.lightness,h=a.lightness,f=this.state.viewLightness;if(d<f&&h>f||d>f&&h<f){const u=this.findLightnessIntersection(s,a,f);if(u!==null){let g=a.pos-s.pos;this.state.isCyclic&&a.pos<s.pos&&(g+=1);const p=s.pos+u*g,y=this.getInterpolatedPropertiesAt(p);if(!y)continue;const S=this.clampAbstractPoint(y.u,y.v,y.lightness),m=S.u*this.state.transform.scale+this.state.transform.offsetX,x=S.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(m,x,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,o){const i=t.lightness,s=n.lightness;if(Math.abs(s-i)<1e-10)return null;if(Math.max(t.order,n.order)===1){const h=(o-i)/(s-i);return h>0&&h<1?h:null}let r=0,c=1;const l=25;for(let h=0;h<l;h++){const f=(r+c)/2,u=t.pos+(n.pos-t.pos)*f,g=this.getInterpolatedPropertiesAt(u);if(!g)break;if(Math.abs(g.lightness-o)<1e-10)return f;g.lightness<o?s>i?r=f:c=f:s>i?c=f:r=f}const d=(r+c)/2;return d>.01&&d<.99?d:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const o=t.canvas,i=Math.ceil(be*2.2),s=Math.ceil(We/2),a=i+s;t.save(),t.strokeStyle="white",t.lineWidth=1;const r=a,c=o.width-i,l=a,d=o.height-i,h=c-r,f=d-l;this.clearTickLabels(o);const u=[0,.2,.4,.6,.8,1],g=["0","0.2","0.4","0.6","0.8","1"],p=o.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,S=window.pageYOffset||document.documentElement.scrollTop;for(let m=0;m<u.length;m++){const x=u[m],I=Math.floor(r+x*h)+.5;x===0?(t.beginPath(),t.moveTo(I,l),t.lineTo(I,d+5),t.stroke()):(t.beginPath(),t.moveTo(I,d),t.lineTo(I,d+5),t.stroke());const b=p.left+y+I,v=p.top+S+d+8;this.createKaTeXLabel(g[m],b,v,"bottom",o)}for(let m=0;m<u.length;m++){const x=u[m],I=Math.floor(d-x*f)+.5;x===0?(t.beginPath(),t.moveTo(r-5,I),t.lineTo(c,I),t.stroke()):(t.beginPath(),t.moveTo(r-5,I),t.lineTo(r,I),t.stroke());const b=p.left+y+r-8,v=p.top+S+I;this.createKaTeXLabel(g[m],b,v,"left",o)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(o=>o.remove())}createKaTeXLabel(t,n,o,i,s){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${o}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=s.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${o}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=s.dataset.type,katex.render(t,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,o,i,s)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=t.width-o,c=s,l=t.height-o,d=r-a,h=l-c;let f=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const g=this.getPointById(this.state.activeDrag.pointId);g&&(f=g.alpha)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(g=>{const p=a+g.pos*d,y=l-g.alpha*h,S=this.abstractToRgb(g.hsPos.u,g.hsPos.v,g.lightness),{r:m,g:x,b:I}=this.clampColor(S),b=this.state.selectedPointIds.has(g.id),v=g.id===this.state.lastSelectedPointId;this.drawPoint(n,p,y,m,x,I,b,v,g.order)})}_drawCircle(t,n,o,i){t.arc(n,o,i,0,2*Math.PI)}_drawJoukowsky(t,n,o,i,s){const r=[];let c=1/0,l=-1/0,d=1/0,h=-1/0;for(let S=0;S<=50;S++){const m=S/50*2*Math.PI,x=Math.cos(m),I=Math.sin(m),b=1-s+s*x,v=s*I,C=b*b+v*v;if(Math.abs(C)<1e-9)continue;const w=s*I-s*I/C,P=s*x+b/C;r.push({x:w,y:P}),w<c&&(c=w),w>l&&(l=w),P<d&&(d=P),P>h&&(h=P)}const f=h-d,u=i*2.5/f,g=(l+c)/2,p=(h+d)/2;t.beginPath();const y=r[0];t.moveTo(n+(y.x-g)*u,o-(y.y-p)*u);for(let S=1;S<r.length;S++){const m=r[S];t.lineTo(n+(m.x-g)*u,o-(m.y-p)*u)}t.closePath()}_drawDroplet(t,n,o,i){this._drawJoukowsky(t,n,o,i,.6666666666666666)}_drawTriangle(t,n,o,i){const s=i*1.4;t.moveTo(n,o-s),t.lineTo(n+s*Math.sqrt(3)/2,o+s/2),t.lineTo(n-s*Math.sqrt(3)/2,o+s/2),t.closePath()}drawPoint(t,n,o,i,s,a,r,c,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,o,be);break;case 1:this._drawDroplet(t,n,o,be);break;case 3:this._drawTriangle(t,n,o,be);break;default:this._drawCircle(t,n,o,be)}t.fillStyle=`rgb(${i}, ${s}, ${a})`,t.fill(),t.strokeStyle=r?Li:"black",t.lineWidth=c?rr:Ps,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,o=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){o||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!o){const{lightness:s,hsPos:a}=t,r=this.abstractToRgb(a.u,a.v,s);if(i){const{r:c,g:l,b:d}=this.clampColor(r);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=d}else{const c=this.rgbToHsl(r.r,r.g,r.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:o}=t.parentElement;(t.width!==n||t.height!==o)&&(t.width=n,t.height=o);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),this.drawCheckerboard(i);const s=this.getLastSelectedPoint();if(s){const{hsPos:a,lightness:r,alpha:c}=s,l=this.abstractToRgb(a.u,a.v,r),{r:d,g:h,b:f}=this.clampColor(l);i.fillStyle=`rgba(${d}, ${h}, ${f}, ${c})`,i.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,o=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let i=0;i<n;i++){const s=i/(n-1),a=this.getInterpolatedPropertiesAt(s);if(!a)continue;const r=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(r.u,r.v,a.lightness),{r:l,g:d,b:h}=this.clampColor(c);t.fillStyle=`rgba(${l}, ${d}, ${h}, ${a.alpha})`,t.fillRect(i,0,1,o)}}getInterpolatedPropertiesAt(t){const n=this.state.points,o=n.length;if(o===0)return null;if(o===1){const f=n[0];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}const i=this.state.isCyclic,s=i?(t%1+1)%1:t;let a,r,c=-1;for(let f=0;f<o-1;f++)if(s>=n[f].pos&&s<=n[f+1].pos){c=f,a=n[f],r=n[f+1];break}if(c===-1)if(i)c=o-1,a=n[o-1],r=n[0];else{const f=s<n[0].pos?n[0]:n[o-1];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(!a||!r)return null;let l=r.pos-a.pos;if(i&&c===o-1&&(l+=1),Math.abs(l)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let d;i&&c===o-1?d=s>=a.pos?(s-a.pos)/l:(s+1-a.pos)/l:d=(s-a.pos)/l;const h=Math.max(a.order,r.order);if(h===0){const f=d<.5?a:r;return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(h===3){const f=this.evaluateCubicSpline(c,d);if(f){const u=Math.max(0,Math.min(1,f.lightness)),g=Math.max(0,Math.min(1,f.alpha)),p=this.clampAbstractPoint(f.u,f.v,u);return{u:p.u,v:p.v,lightness:u,alpha:g,order:2}}}return{u:a.hsPos.u+(r.hsPos.u-a.hsPos.u)*d,v:a.hsPos.v+(r.hsPos.v-a.hsPos.v)*d,lightness:a.lightness+(r.lightness-a.lightness)*d,alpha:a.alpha+(r.alpha-a.alpha)*d,order:1}}abstractToRgb(t,n,o){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,o);const i=this.rgbCubeAbstractToRgb(t,n,o);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,o){if(this.state.colorSpace==="HSL_DI_CONE"){const f=Math.sqrt(t*t+n*n),u=1-Math.abs(2*o-1);return f>u&&u>1e-6?{u:t/f*u,v:n/f*u}:{u:t,v:n}}if(o<=.01||o>=.99)return{u:0,v:0};let{r:i,g:s,b:a}=this.abstractToRgb(t,n,o);if(this.isValidColor(i,s,a))return{u:t,v:n};let r=0,c=0,l=1/0;const d=Math.max(Math.abs(t),Math.abs(n),.5),h=50;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const g=t+(f/h-.5)*2*d,p=n+(u/h-.5)*2*d,y=this.abstractToRgb(g,p,o);if(this.isValidColor(y.r,y.g,y.b)){const S=Math.sqrt((g-t)**2+(p-n)**2);S<l&&(l=S,r=g,c=p)}}return l<1/0?{u:r,v:c}:{u:0,v:0}}hslToRgb(t,n,o){if(n===0)return{r:o,g:o,b:o};const i=o<.5?o*(1+n):o+n-o*n,s=2*o-i,a=(d,h,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<1/6?d+(h-d)*6*f:f<1/2?h:f<2/3?d+(h-d)*(2/3-f)*6:d),r=a(s,i,t+1/3),c=a(s,i,t),l=a(s,i,t-1/3);return{r,g:c,b:l}}rgbToHsl(t,n,o){const i=Math.max(t,n,o),s=Math.min(t,n,o);let a=0,r=0,c=(i+s)/2;if(i!==s){const l=i-s;switch(r=c>.5?l/(2-i-s):l/(i+s),i){case t:a=(n-o)/l+(n<o?6:0);break;case n:a=(o-t)/l+2;break;case o:a=(t-n)/l+4;break}a/=6}return{h:a,s:r,l:c}}drawCheckerboard(t){const n=t.canvas.width,o=t.canvas.height,i=n/We,s=o/We;t.fillStyle=Oi,t.fillRect(0,0,n,o),t.fillStyle=Ni;for(let a=0;a<s;a++)for(let r=0;r<i;r++)(a+r)%2===0&&t.fillRect(r*We,a*We,We,We)}findClosestValidPoint(t,n,o){const i=Math.ceil(be*2.2),s=Math.ceil(We/2),a=i+s,r=a,c=a,l=this.elements.hsBgCanvas.width-a-i,d=this.elements.hsBgCanvas.height-a-i,h=Math.max(r,Math.min(r+l,t)),f=Math.max(c,Math.min(c+d,n)),{scale:u,offsetX:g,offsetY:p}=this.state.transform,y=(h-g)/u,S=(f-p)/u,m=this.abstractToRgb(y,S,o);if(this.isValidColor(m.r,m.g,m.b))return{x:h,y:f};if(this.state.colorSpace==="HSL_DI_CONE"){const x=Math.sqrt(y*y+S*S),I=1-Math.abs(2*o-1);if(x>I&&I>1e-6){const b=y/x*I,v=S/x*I;return{x:b*u+g,y:v*u+p}}return{x:h,y:f}}return this.findClosestPointOnRgbGamut(y,S,o,u,g,p,r,c,l,d)}getGamutVerticesRgb(t){const n=[],o=r=>r>=-1e-6&&r<=1.000001,i=(r,c)=>Math.abs(r.r-c.r)<1e-6&&Math.abs(r.g-c.g)<1e-6&&Math.abs(r.b-c.b)<1e-6,s=(r,c,l)=>{if(o(r)&&o(c)&&o(l)){const d={r,g:c,b:l};n.some(h=>i(h,d))||n.push(d)}},a=3*t;return s(a,0,0),s(0,a,0),s(0,0,a),s(1,a-1,0),s(1,0,a-1),s(a-1,1,0),s(0,1,a-1),s(a-1,0,1),s(0,a-1,1),s(1,1,a-2),s(1,a-2,1),s(a-2,1,1),n}rgbCubeAbstractToRgb(t,n,o){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},s={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=o+t*i.x+n*s.x,r=o+t*i.y+n*s.y,c=o+t*i.z+n*s.z;return{r:a,g:r,b:c}}findClosestPointOnRgbGamut(t,n,o,i,s,a,r,c,l,d){let h=t,f=n,u=1/0;const g=.5,p=50;for(let m=0;m<=p;m++)for(let x=0;x<=p;x++){const I=t+(m/p-.5)*2*g,b=n+(x/p-.5)*2*g,v=this.abstractToRgb(I,b,o);if(this.isValidColor(v.r,v.g,v.b)){const C=Math.sqrt((I-t)**2+(b-n)**2);C<u&&(u=C,h=I,f=b)}}if(u<1/0){const m=this.refineClosestPoint(t,n,h,f,o);h=m.u,f=m.v}const y=h*i+s,S=f*i+a;return{x:Math.max(r,Math.min(r+l,y)),y:Math.max(c,Math.min(c+d,S))}}refineClosestPoint(t,n,o,i,s){let a=o,r=i,c=.02;for(let l=0;l<5;l++){let d=!1;const h=20;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const g=a+(f/h-.5)*2*c,p=r+(u/h-.5)*2*c,y=this.abstractToRgb(g,p,s);if(this.isValidColor(y.r,y.g,y.b)){const S=Math.sqrt((a-t)**2+(r-n)**2);Math.sqrt((g-t)**2+(p-n)**2)<S&&(a=g,r=p,d=!0)}}if(c*=.5,!d)break}return{u:a,v:r}}findClosestPointOnPolygon(t,n){let o=null,i=1/0;for(let s=0;s<n.length;s++){const a=n[s],r=n[(s+1)%n.length],c=r.x-a.x,l=r.y-a.y;let d;if(c===0&&l===0)d=a;else{const f=((t.x-a.x)*c+(t.y-a.y)*l)/(c*c+l*l);f<0?d=a:f>1?d=r:d={x:a.x+f*c,y:a.y+f*l}}const h=(t.x-d.x)**2+(t.y-d.y)**2;h<i&&(i=h,o=d)}return o}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const o=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=o.u,t.hsPos.v=o.v}findHitPointSlider(t,n,o){const i=this.elements.interactiveCanvases[o],s=Math.ceil(be*2.2),a=Math.ceil(We/2),r=s+a,c=i.height-r-s,l=i.height-s,d=o==="lightness"?l-this.state.viewLightness*c:l-this.state.viewAlpha*c;let h=Math.abs(n-d)<=lr,f=null;for(let u=0;u<this.state.points.length;u++){const g=this.state.points[u],p=i.width-r-s,y=r+g.pos*p,S=o==="lightness"?l-g.lightness*c:l-g.alpha*c;if(Math.sqrt((t-y)**2+(n-S)**2)<=Fi){f=g;break}}return{hitPoint:f,hitLine:h}}findHitPointSlider(t,n,o){const i=this.elements.interactiveCanvases[o],s=Math.ceil(be*2.2),a=i.height-2*s,r=i.height-s,c=o==="lightness"?r-this.state.viewLightness*a:r-this.state.viewAlpha*a;let l=Math.abs(n-c)<=lr,d=null;for(let h=0;h<this.state.points.length;h++){const f=this.state.points[h],u=i.width-2*s,g=s+f.pos*u,p=o==="lightness"?r-f.lightness*a:r-f.alpha*a;if(Math.sqrt((t-g)**2+(n-p)**2)<=Fi){d=f;break}}return{hitPoint:d,hitLine:l}}createNewPointHS(t,n){const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=s,c=this.elements.hsBgCanvas.width-s-o,l=this.elements.hsBgCanvas.height-s-o;if(t<a||t>a+c||n<r||n>r+l)return;const d=(t-this.state.transform.offsetX)/this.state.transform.scale,h=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:f,viewAlpha:u}=this.state,{r:g,g:p,b:y}=this.abstractToRgb(d,h,f);if(this.isValidColor(g,p,y)){this.markAsDirty();const S=this.state.points.length;S>0&&this.state.points.forEach(x=>{x.pos=x.pos-x.pos/S});const m={id:Date.now(),hsPos:{u:d,v:h},originalHsPos:{u:d,v:h},lightness:f,alpha:u,pos:S===0?.5:1,order:1};this.state.points.push(m),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(m.id),this.state.lastSelectedPointId=m.id,this.drawAll()}}handleLineDrag(t,n,o){const i=o.startsWith("lightness")?"lightness":"alpha",s=o.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(be*2.2),r=Math.ceil(We/2),c=a+r,l=n-c-a,h=(this.findSnapPosition(t,n,i)-c)/l,f=Math.max(0,Math.min(1,1-h));this.state[s]=f,this.drawAll()}handlePointDrag(t,n,o,i){const s=this.getPointById(this.state.activeDrag.pointId);s&&(i==="hs"?this.handleHSPointDrag(t,n):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(s,t,n,o,i),this.drawAll())}handleHSPointDrag(t,n){const{startX:o,startY:i,initialPointPositions:s}=this.state.activeDrag,{scale:a,offsetX:r,offsetY:c}=this.state.transform,l=Math.ceil(be*2.2),d=Math.ceil(We/2),h=l+d,f=h,u=h,g=this.elements.hsBgCanvas.width-h-l,p=this.elements.hsBgCanvas.height-h-l,y=t-o,S=n-i;this.state.points.forEach(m=>{if(s.has(m.id)){const x=s.get(m.id),I=x.x+y,b=x.y+S,v=Math.max(f,Math.min(f+g,I)),C=Math.max(u,Math.min(u+p,b)),w=this.findClosestValidPoint(v,C,m.lightness),P=(w.x-r)/a,T=(w.y-c)/a;m.hsPos={u:P,v:T};const M=this.abstractToRgb(P,T,m.lightness);this.isValidColor(M.r,M.g,M.b)&&(m.originalHsPos={u:P,v:T})}})}adjustPointForNewLightness(t,n){const o=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(o.r,o.g,o.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}handleSliderPointDrag(t,n,o,i,s){const{offsets:a}=this.state.activeDrag,r=Math.ceil(be*2.2),c=Math.ceil(We/2),l=r+c;i.width-r,i.height-r;const d=this.findSnapPosition(o,i.height,s,t.id),h=l,f=i.width-r,u=l,g=i.height-r,p=f-h,y=g-u,S=(d-u)/y,m=Math.max(0,Math.min(1,1-S));let x=(n-h)/p,I=x;this.state.isCyclic?(x<0?I=1+x:x>1&&(I=x-1),I=this.wrapPositionCyclic(I)):I=Math.max(0,Math.min(1,x));for(const b of this.state.points)if(a.has(b.id)){const v=a.get(b.id),C=m+v[s];let w=I+v.pos;if(this.state.isCyclic?w=this.wrapPositionCyclic(w):w=Math.max(0,Math.min(1,w)),b.pos=w,s==="lightness"){const P=Math.max(0,Math.min(1,C));b.lightness=P;const T=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,P);if(this.isValidColor(T.r,T.g,T.b))b.hsPos={...b.originalHsPos};else{const M=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,P);b.hsPos.u=M.u,b.hsPos.v=M.v}this.state.viewLightness=P}else b.alpha=Math.max(0,Math.min(1,C)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const tc=[5,4],Ca=16,nc=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],hr=e=>{const t=[{power:3,value:e[0]},{power:2,value:e[1]},{power:1,value:e[2]},{power:0,value:e[3]}],n=o=>Number(o.toFixed(6));return t.filter(o=>Math.abs(o.value)>1e-10).map((o,i)=>{const s=o.value<0?"-":"+",a=Math.abs(o.value),r=n(a),c=o.power===0?"":`t^${o.power}`,l=o.power===0?`${r}`:`${r}${c}`;return i===0?o.value<0?`-${l}`:`${l}`:`${s} ${l}`}).join(" ").replace(/t\^1\b/g,"t")},sc=(e,t,n,o,i)=>{const s=[t.x,n.x,o.x,i.x],a=[t.y,n.y,o.y,i.y],r=e.map(l=>l.reduce((d,h,f)=>d+h*s[f],0)),c=e.map(l=>l.reduce((d,h,f)=>d+h*a[f],0));return{x:r,y:c}},oc=(e,t)=>{if(e.length<2)return[];const n=e.length,o=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),s=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[o(l)]:l<0?i():l>=n?s():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c};function ic(e,t=!1,n=Ca){if(e.length<2)return e;const o=[],i=e.length,s=t?i:i-1;for(let a=0;a<s;a++){const r=e[a],c=e[(a+1)%i],l=a===0?0:1;for(let d=l;d<=n;d++){const h=d/n;o.push({x:r.x+(c.x-r.x)*h,y:r.y+(c.y-r.y)*h})}}return o}const Gt=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},Jo=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),ac=(e,t)=>{const n=Math.PI*2;let o=(t-e)%n;return o<0&&(o+=n),o>Math.PI&&(o-=n),o},Qn=(e,t,n,o,i,s,a,r=null)=>{const c=i*.5;if(c<=1e-6)return;const l={x:c,y:c},d=Math.PI,h=-Math.PI/2,f=ac(d,h),u=Math.max(2,s);for(let g=a?0:1;g<=u;g++){const p=g/u,y=d+f*p,S={x:l.x+Math.cos(y)*c,y:l.y+Math.sin(y)*c},m={x:t.x+n.x*S.x+o.x*S.y,y:t.y+n.y*S.x+o.y*S.y};r?r(m):e.push(m)}};function fr(e,t=!1,n="relative",o=0,i=Ca,s=!1,a=!1,r=!1,c=!1){if(e.length<2)return e;if(o<=1e-6)return t?[...e,e[0]]:[...e];const l=e.length,d=[],h=[],f=n==="fixed"?"absolute":n,u=f==="absolute"?"relative":f,g=I=>{const b=e[(I-1+l)%l],v=e[I],C=e[(I+1)%l],w=Jo(b,v),P=Jo(C,v),T=Math.hypot(w.x,w.y),M=Math.hypot(P.x,P.y);if(T<=1e-6||M<=1e-6)return null;let E,N,_;const D=Math.min(T,M)*.5;if(u==="absolute"?(E=Math.max(0,Math.min(1,o)),N=Gt(P),_=Gt(w)):(f==="absolute"?E=Math.max(0,Math.min(o,D))*2:E=Math.max(0,Math.min(1,o)),N=f==="absolute"?Gt(P):P,_=f==="absolute"?Gt(w):w),E<=1e-6)return null;const F=E*.5,R=r?-F:f==="absolute"?T*.5:.5,B=r?-F:f==="absolute"?M*.5:.5,L={x:v.x+_.x*R,y:v.y+_.y*R},O={x:v.x+N.x*B,y:v.y+N.y*B},$=Gt(_),A=Gt(N),k={x:$.x+A.x,y:$.y+A.y},V=Math.hypot(k.x,k.y),Y=V>1e-6?{x:k.x/V,y:k.y/V}:{x:0,y:0},X=f==="absolute"?F:F*Math.min(T,M),z={x:v.x-Y.x*(X/Math.sqrt(2)),y:v.y-Y.y*(X/Math.sqrt(2))},G={x:-$.y,y:$.x},W={x:-A.y,y:A.x},Q=G.x*Y.x+G.y*Y.y<0?{x:-G.x,y:-G.y}:G,te=W.x*Y.x+W.y*Y.y<0?{x:-W.x,y:-W.y}:W,pe=(f==="absolute"?F:F*T)/Math.sqrt(2),me=(f==="absolute"?F:F*M)/Math.sqrt(2),vt={x:v.x+$.x*(T*.5)+Q.x*pe,y:v.y+$.y*(T*.5)+Q.y*pe},Qe={x:v.x+A.x*(M*.5)+te.x*me,y:v.y+A.y*(M*.5)+te.y*me},rt={x:v.x+_.x*F,y:v.y+_.y*F},zt={x:v.x+N.x*F,y:v.y+N.y*F};return{index:I,origin:v,axisX:N,axisY:_,baseScale:E,radius:F,edgeInIndex:(I-1+l)%l,edgeOutIndex:I,midIn:L,midOut:O,arcStart:rt,arcEnd:zt,bisectorOuter:z,midInOrtho:vt,midOutOrtho:Qe}},p=(I,b=null,v=null)=>{if(!c){d.push({x:I.x,y:I.y});return}d.push({x:I.x,y:I.y,tag:b||void 0,edgeIndex:v??void 0})},y=I=>p(I,"arc"),S=(I,b)=>{!r||I.radius<=1e-6||(b?(p(I.midInOrtho,"line",I.edgeInIndex),p(I.bisectorOuter,"corner")):(p(I.bisectorOuter,"corner"),p(I.midOutOrtho,"line",I.edgeOutIndex)))};if(t){for(let b=0;b<l;b++){const v=g(b);v&&h.push(v)}if(!h.length)return[...e,e[0]];if(r){const b=h[0];p(b.arcStart,"line",b.edgeInIndex),Qn(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!1,y);for(let v=1;v<h.length;v++){const C=h[v];p(C.arcStart,"line",C.edgeInIndex),Qn(d,C.origin,C.axisX,C.axisY,C.baseScale,i,!1,y)}return p({...b.arcStart},"line",b.edgeInIndex),d}const I=h[0];return p(I.midIn,"line",I.edgeInIndex),S(I,!0),h.forEach((b,v)=>{v>0&&(p(b.midIn,"line",b.edgeInIndex),S(b,!0)),Qn(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!0,y),S(b,!1),p(b.midOut,"line",b.edgeOutIndex),p(b.origin,"corner")}),p({...I.midIn},"line",I.edgeInIndex),d}if(u==="absolute"){for(let v=1;v<l-1;v++){const C=g(v);C&&h.push(C)}if(!h.length)return[...e];const I=h[0];p(e[0],"line",0),I&&p(I.midIn,"line",I.edgeInIndex),S(I,!0),h.forEach((v,C)=>{C>0&&(p(v.midIn,"line",v.edgeInIndex),S(v,!0)),Qn(d,v.origin,v.axisX,v.axisY,v.baseScale,i,!0,y),S(v,!1),p(v.midOut,"line",v.edgeOutIndex)});const b=h[h.length-1];return b&&p(b.midOut,"line",b.edgeOutIndex),p(e[l-1],"line",l-2),d}if(r){for(let b=1;b<l-1;b++){const v=g(b);v&&h.push(v)}if(!h.length)return[...e];p(e[0],"line",0);const I=h[0];p(I.arcStart,"line",I.edgeInIndex),Qn(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!1,y);for(let b=1;b<h.length;b++){const v=h[b];p(v.arcStart,"line",v.edgeInIndex),Qn(d,v.origin,v.axisX,v.axisY,v.baseScale,i,!1,y)}return p(e[l-1],"line",l-2),d}for(let I=1;I<l-1;I++){const b=g(I);b&&h.push(b)}if(!h.length)return[...e];const m=h[0],x=h[h.length-1];return p(e[0],"line",0),p(m.midIn,"line",m.edgeInIndex),h.forEach((I,b)=>{b>0&&p(I.midIn,"line",I.edgeInIndex),S(I,!0),Qn(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!0,y),S(I,!1),p(I.midOut,"line",I.edgeOutIndex)}),p(x.midOut,"line",x.edgeOutIndex),p(e[l-1],"line",l-2),d}function rc(e,t=!1,n="relative",o=0){if(e.length<3)return[];if(o<=1e-6)return[];const i=e.length,s=[],a=n==="fixed"?"absolute":n,r=a==="absolute"?"relative":a,c=t?i:i-1;for(let l=1;l<c;l++){const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=Jo(d,h),g=Jo(f,h),p=Math.hypot(u.x,u.y),y=Math.hypot(g.x,g.y);if(p<=1e-6||y<=1e-6)continue;const S=Math.min(p,y)*.5;let m,x,I;if(r==="absolute"){const Y=Math.min(p,y);m=Math.max(0,Math.min(o,Y*.5))*2,x=Gt(g),I=Gt(u)}else m=a==="absolute"?Math.max(0,Math.min(o,S))*2:Math.max(0,Math.min(1,o)),x=a==="absolute"?Gt(g):g,I=a==="absolute"?Gt(u):u;if(m<=1e-6)continue;const b=m*.5,v=Gt(I),C=Gt(x),w={x:v.x+C.x,y:v.y+C.y},P=Math.hypot(w.x,w.y),T=P>1e-6?{x:w.x/P,y:w.y/P}:{x:0,y:0},M=a==="absolute"?b:b*Math.min(p,y),E=t?(()=>{let Y=0;for(let X=0;X<i;X++){const z=e[X],G=e[(X+1)%i];Y+=z.x*G.y-G.x*z.y}return Y})():1,N=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),D=(E>=0?N>=0:N<=0)?-1:1,F={x:h.x+T.x*M*D,y:h.y+T.y*M*D},R={x:-v.y,y:v.x},B={x:-C.y,y:C.x},L=R.x*T.x+R.y*T.y<0?{x:-R.x,y:-R.y}:R,O=B.x*T.x+B.y*T.y<0?{x:-B.x,y:-B.y}:B,$=(a==="absolute"?b:b*p)/Math.sqrt(2),A=(a==="absolute"?b:b*y)/Math.sqrt(2),k={x:h.x+v.x*(p*.5)+L.x*$,y:h.y+v.y*(p*.5)+L.y*$},V={x:h.x+C.x*(y*.5)+O.x*A,y:h.y+C.y*(y*.5)+O.y*A};s.push(F,k,V)}return s}function ur(e,t=.5,n=!1,o=Ca,i={}){if(e.length<2)return e;const s=[],a=Math.max(0,Math.min(1,t)),r=(1-a)*.5,c=nc(r),l=i?.logSegments??!1,d=i?.label??"Catmull-Rom",h=(u,g,p,y,S)=>{const m=S*S,x=m*S,I=2*x-3*m+1,b=x-2*m+S,v=-2*x+3*m,C=x-m;return{x:I*u.x+b*p.x+v*g.x+C*y.x,y:I*u.y+b*p.y+v*g.y+C*y.y}};return oc(e,n).forEach(({index:u,p0:g,p1:p,p2:y,p3:S})=>{if(l){const b=sc(c,g,p,y,S);console.groupCollapsed(`${d} segment ${u}`),console.log("Matrix M (rows t^3,t^2,t,1; cols P0..P3):",c),console.log("P0..P3:",g,p,y,S),console.log(`tension: ${a}, tau: ${r}`),console.log("P(t) = [t^3 t^2 t 1] * M * [P0 P1 P2 P3]"),console.log(`x(t) = ${hr(b.x)}`),console.log(`y(t) = ${hr(b.y)}`),console.groupEnd()}const m=u===0?0:1,x={x:(y.x-g.x)*r,y:(y.y-g.y)*r},I={x:(S.x-p.x)*r,y:(S.y-p.y)*r};for(let b=m;b<=o;b++){const v=b/o;s.push(h(p,y,x,I,v))}}),s}const lc={id:null,preset:"closed",type:"spline",mode:"piecewise",order:3,tension:.5,radiusMode:"absolute",radiusValue:.5,relRadiusValue:.5,absRadiusValue:.5,linearStyle:"lines",nurbsDegree:3,pointHandling:"anchor"},vi=500,Ds=e=>Math.max(0,Math.min(1,e)),Wr=e=>Math.max(0,Math.min(vi,e)),No=e=>{const t=Ds(Number(e)||0);return t*t*vi},pr=e=>{const t=Wr(Number(e)||0);return Math.sqrt(t/vi)},gr=[{id:"closed",label:"Closed"},{id:"open",label:"Open"},{id:"figure8",label:"Figure 8"},{id:"branching",label:"Branching"},{id:"branching4",label:"Branching (4)"},{id:"branching5",label:"Branching (5)"}],cc=[{id:"linear",label:"Linear"},{id:"spline",label:"Spline"},{id:"radius",label:"Radius"}];class dc{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:this._createStyle(),previewPoints:this._createDefaultPresetPoints()},this.wrapper=null,this.elements={},this.previewCards=new Map,this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this._renderAllPreviews())}show(t=null){this.state.style=this._normalizeStyle(t),this._updateUIFromState(),this.wrapper.style.display="block",requestAnimationFrame(()=>{this._renderAllPreviews()})}hide(){this.wrapper&&(this.wrapper.style.display="none")}_createStyle(){return{...lc,id:`style_${Date.now()}`}}_normalizeStyle(t){const n=this._createStyle();if(!t)return n;const i=Number(t.order)===3?3:1;let s=t.type==="px_radius"?"abs_radius":t.type,a=t.radiusMode==="fixed"?"absolute":t.radiusMode,r=t.pointHandling;s==="cubic_spline"?(s="spline",r="anchor"):s==="circular_arc"?s="radius":s==="linear"&&(s="linear"),s==="catmull"?(s="spline",r="anchor"):s==="nurbs"?(s="spline",r="control"):s==="linear"?(s="spline",r="anchor"):s==="rel_radius"?(s="radius",a="relative"):s==="abs_radius"&&(s="radius",a="absolute");const c=t.relRadiusValue??(a==="relative"?Ds(t.radiusValue):n.relRadiusValue),l=t.absRadiusValue??(a==="absolute"?pr(t.radiusValue):n.absRadiusValue),d=a==="relative"?c:No(l);return s||(t.mode==="radius"?s="radius":i===3&&t.tension!==void 0?(s="spline",r="anchor"):i===3?s="spline":(s="spline",r="anchor")),{...n,...t,id:t.id||n.id,preset:t.preset||n.preset,order:i,type:s||n.type,radiusMode:a||n.radiusMode,radiusValue:d,relRadiusValue:c,absRadiusValue:l,linearStyle:t.linearStyle||n.linearStyle,nurbsDegree:t.nurbsDegree||n.nurbsDegree,pointHandling:s==="spline"?"anchor":r??t.pointHandling??n.pointHandling}}_createDefaultPresetPoints(){const t={x:.6,y:.25},n={x:.55,y:.45},o={x:.55,y:.5},i=[{x:.2,y:.2},{x:.8,y:.25},{x:.7,y:.6},{x:.5,y:.45},{x:.3,y:.75}],s=[{x:.05,y:.8},{x:.25,y:.4},{x:.45,y:.7},{x:.65,y:.2},{x:.85,y:.55}],a=[{x:.72,y:.5},{x:.61,y:.31},{x:.39,y:.31},{x:.28,y:.5},{x:.39,y:.69},{x:.61,y:.69},{x:.5,y:.5}];return{closed:{vertices:i,edges:i.map((r,c)=>[c,(c+1)%i.length])},open:{vertices:s,edges:s.slice(0,-1).map((r,c)=>[c,c+1])},figure8:{vertices:a,edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0],[0,6],[6,3]],faces:[[0,1,2,3,4,5]]},branching:[[{x:.1,y:.85},{x:.3,y:.6},{x:.5,y:.4},t],[t,{x:.75,y:.15},{x:.9,y:.1}],[t,{x:.75,y:.35},{x:.9,y:.45}]],branching4:{in:[[{x:.12,y:.15},{x:.32,y:.3},n],[{x:.18,y:.75},{x:.35,y:.58},n]],out:[[n,{x:.75,y:.25},{x:.92,y:.2}],[n,{x:.75,y:.6},{x:.9,y:.72}]]},branching5:{in:[[{x:.1,y:.25},{x:.32,y:.38},o],[{x:.18,y:.8},{x:.35,y:.64},o]],out:[[o,{x:.78,y:.25},{x:.92,y:.2}],[o,{x:.78,y:.5},{x:.92,y:.52}],[o,{x:.78,y:.78},{x:.9,y:.85}]]}}}_initializeDOM(){const t=(C,w={})=>{const P=document.createElement(C);if(w.id){P.id=w.id;const T=w.id.replace(/-(\w)/g,(M,E)=>E.toUpperCase());this.elements[T]=P}return w.className&&(P.className=w.className),w.text&&(P.textContent=w.text),w.type&&(P.type=w.type),w.value!==void 0&&(P.value=w.value),w.attrs&&Object.entries(w.attrs).forEach(([T,M])=>P.setAttribute(T,M)),P};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"interpolation-editor-layout"}),o=t("div",{className:"editor-panel preview-panel"});o.append(t("div",{className:"panel-header",text:"Preview Presets"}));const i=t("div",{className:"preview-list"});gr.forEach(C=>{const w=t("button",{className:"preview-card",attrs:{"data-preset":C.id,type:"button"}}),P=t("div",{className:"preview-card-label",text:C.label}),T=t("canvas",{className:"preview-card-canvas"});w.append(T,P),i.append(w),this.previewCards.set(C.id,{card:w,canvas:T})}),o.append(i);const s=t("div",{className:"editor-panel type-panel"});s.append(t("div",{className:"panel-header",text:"Interpolation Type"}));const a=t("div",{className:"toggle-stack",id:"type-list"});cc.forEach(C=>{const w=t("button",{className:"toggle-row",text:C.label,attrs:{"data-type":C.id,type:"button"}});a.append(w)}),s.append(a);const r=t("div",{className:"editor-panel params-panel"});r.append(t("div",{className:"panel-header",text:"Parameters"}));const c=t("div",{className:"param-section",id:"tension-section"});c.append(t("div",{className:"section-caption",text:"Catmull-Rom tension."}));const l=t("div",{className:"param-row"});this.elements.tensionSlider=t("input",{id:"tension-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.tensionInput=t("input",{id:"tension-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),l.append(this.elements.tensionSlider,this.elements.tensionInput),c.append(l);const d=t("div",{className:"param-section",id:"linear-section"});d.append(t("div",{className:"section-caption",text:"Linear marker style."}));const h=t("div",{className:"param-row"}),f=t("div",{className:"toggle-group",id:"linear-style-toggle"});f.append(t("button",{className:"toggle-button",text:"Lines",attrs:{"data-linear-style":"lines",type:"button"}}),t("button",{className:"toggle-button",text:"Arrows",attrs:{"data-linear-style":"arrows",type:"button"}})),h.append(f),d.append(h);const u=t("div",{className:"param-section",id:"handling-section"});u.append(t("div",{className:"section-caption",text:"Point handling."}));const g=t("div",{className:"param-row"}),p=t("div",{className:"toggle-group",id:"point-handling-toggle"});p.append(t("button",{className:"toggle-button",text:"Control",attrs:{"data-point-handling":"control",type:"button"}}),t("button",{className:"toggle-button",text:"Anchor",attrs:{"data-point-handling":"anchor",type:"button"}}),t("button",{className:"toggle-button",text:"Mixed",attrs:{"data-point-handling":"mixed",type:"button"}})),g.append(p),u.append(g);const y=t("div",{className:"param-section",id:"radius-section"});y.append(t("div",{className:"section-caption",text:"Clamped to half each adjacent edge."}));const S=t("div",{className:"param-row"});this.elements.radiusSlider=t("input",{id:"radius-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.radiusInput=t("input",{id:"radius-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),S.append(this.elements.radiusSlider,this.elements.radiusInput),y.append(S);const m=t("div",{className:"toggle-group",id:"radius-mode-toggle"});m.append(t("button",{className:"toggle-button",text:"Relative",attrs:{"data-radius-mode":"relative",type:"button"}}),t("button",{className:"toggle-button",text:"Absolute",attrs:{"data-radius-mode":"absolute",type:"button"}})),y.append(m);const x=t("div",{className:"param-section",id:"nurbs-section"});x.append(t("div",{className:"section-caption",text:"NURBS degree."}));const I=t("div",{className:"param-row"});this.elements.nurbsDegreeSlider=t("input",{id:"nurbs-degree-slider",type:"range",attrs:{min:"2",max:"5",step:"1"}}),this.elements.nurbsDegreeInput=t("input",{id:"nurbs-degree-input",type:"number",attrs:{min:"2",max:"5",step:"1"}}),I.append(this.elements.nurbsDegreeSlider,this.elements.nurbsDegreeInput),x.append(I),r.append(d,u,c,y,x);const b=t("div",{className:"editor-panel actions-panel"});b.append(t("div",{className:"panel-header",text:"Actions"}));const v=t("div",{className:"button-row"});this.elements.closeButton=t("button",{id:"close-button",className:"editor-button secondary",text:"Close",attrs:{type:"button"}}),this.elements.selectButton=t("button",{id:"select-button",className:"editor-button primary",text:"Select",attrs:{type:"button"}}),v.append(this.elements.closeButton,this.elements.selectButton),b.append(v),n.append(o,s,r,b),this.wrapper.append(n),this.container.appendChild(this.wrapper)}_setupEventListeners(){window.addEventListener("resize",()=>{this.wrapper&&this.wrapper.style.display!=="none"&&this._renderAllPreviews()}),this.previewCards.forEach((s,a)=>{s.card.addEventListener("click",()=>{this._setStyle({preset:a})}),s.canvas.addEventListener("mousedown",r=>{this._handlePreviewMouseDown(r,a)})}),this.wrapper.querySelector("#type-list").querySelectorAll(".toggle-row").forEach(s=>{s.addEventListener("click",()=>{this._applyTypeSelection(s.dataset.type)})}),this.wrapper.querySelector("#linear-style-toggle").querySelectorAll(".toggle-button").forEach(s=>{s.addEventListener("click",()=>{this._setStyle({linearStyle:s.dataset.linearStyle})})}),this.wrapper.querySelector("#point-handling-toggle").querySelectorAll(".toggle-button").forEach(s=>{s.addEventListener("click",()=>{this._setStyle({pointHandling:s.dataset.pointHandling})})}),this.elements.radiusSlider.addEventListener("input",s=>{const a=Number(s.target.value);this._applyRadiusValue(a,!0)}),this.elements.radiusInput.addEventListener("change",s=>{const a=Number(s.target.value);this._applyRadiusValue(a,!1)}),this.wrapper.querySelector("#radius-mode-toggle").querySelectorAll(".toggle-button").forEach(s=>{s.addEventListener("click",()=>{this._applyRadiusMode(s.dataset.radiusMode)})}),this.elements.tensionSlider.addEventListener("input",s=>{const a=Number(s.target.value);this._applyTensionValue(a,!0)}),this.elements.tensionInput.addEventListener("change",s=>{const a=Number(s.target.value);this._applyTensionValue(a,!1)}),this.elements.nurbsDegreeSlider.addEventListener("input",s=>{const a=Number(s.target.value);this._applyNurbsDegreeValue(a,!0)}),this.elements.nurbsDegreeInput.addEventListener("change",s=>{const a=Number(s.target.value);this._applyNurbsDegreeValue(a,!1)}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{this.onSelect(this._exportStyleForHost()),this.hide()}),window.addEventListener("mousemove",s=>{this._handlePreviewMouseMove(s)}),window.addEventListener("mouseup",()=>{this._handlePreviewMouseUp()})}_setStyle(t){this.state.style={...this.state.style,...t},this._updateUIFromState(),this._renderAllPreviews()}_exportStyleForHost(){const{id:t,name:n,type:o,tension:i,radiusMode:s,radiusValue:a,pointHandling:r,order:c,preset:l,mode:d,linearStyle:h}=this.state.style,f={id:t,name:n,order:c,preset:l,mode:d,linearStyle:h};return o==="spline"?{...f,type:"cubic_spline",cornerHandling:"pass_through",tension:Number(i??.5)}:o==="radius"?{...f,type:"circular_arc",cornerHandling:r==="mixed"?"mixed":"cut_all",radiusMode:s,radiusValue:a}:{...f,type:"linear",cornerHandling:"pass_through"}}_applyRadiusValue(t,n){if(Number.isNaN(t))return;const o={...this.state.style};if(o.radiusMode==="relative"){const i=Ds(t);o.radiusValue=i,o.relRadiusValue=i}else{const i=n?Ds(t):pr(t);o.absRadiusValue=i,o.radiusValue=No(i)}this.state.style=o,n?this.elements.radiusInput.value=o.radiusValue.toFixed(o.radiusMode==="absolute"?0:2):this.elements.radiusSlider.value=o.radiusMode==="absolute"?o.absRadiusValue:o.radiusValue,this._updateUIFromState(),this._renderAllPreviews()}_applyTensionValue(t,n){if(Number.isNaN(t))return;const o={...this.state.style};o.tension=Math.max(0,Math.min(1,t)),this.state.style=o,n?this.elements.tensionInput.value=o.tension.toFixed(2):this.elements.tensionSlider.value=o.tension,this._updateUIFromState(),this._renderAllPreviews()}_applyRadiusMode(t){if(t!=="relative"&&t!=="absolute")return;const n={...this.state.style};n.radiusMode=t,t==="relative"?n.radiusValue=n.relRadiusValue??n.radiusValue:n.radiusValue=No(n.absRadiusValue??n.radiusValue),this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_applyNurbsDegreeValue(t,n){if(Number.isNaN(t))return;const o={...this.state.style};o.nurbsDegree=Math.max(2,Math.min(5,Math.round(t))),this.state.style=o,n?this.elements.nurbsDegreeInput.value=o.nurbsDegree:this.elements.nurbsDegreeSlider.value=o.nurbsDegree,this._updateUIFromState()}_applyTypeSelection(t){const n={...this.state.style,type:t};switch(t){case"linear":n.mode="piecewise",n.order=1,n.pointHandling="anchor";break;case"spline":n.mode="piecewise",n.order=3,n.pointHandling="anchor";break;case"radius":n.mode="radius",n.radiusMode=n.radiusMode||"relative",n.radiusValue=n.radiusMode==="relative"?n.relRadiusValue??n.radiusValue:No(n.absRadiusValue??n.radiusValue),n.pointHandling=n.pointHandling==="mixed"?"mixed":"control";break}this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_updateUIFromState(){const{preset:t,mode:n,order:o,radiusMode:i,radiusValue:s,tension:a,type:r,linearStyle:c,nurbsDegree:l,pointHandling:d}=this.state.style;this.previewCards.forEach((y,S)=>{y.card.classList.toggle("is-active",S===t)}),this.wrapper.querySelectorAll("#type-list .toggle-row").forEach(y=>{y.classList.toggle("is-active",y.dataset.type===r)}),this.wrapper.querySelectorAll("#linear-style-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.linearStyle===c)}),this.wrapper.querySelectorAll("#point-handling-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.pointHandling===d)});const h=this.wrapper.querySelector("#linear-section"),f=this.wrapper.querySelector("#handling-section"),u=this.wrapper.querySelector("#tension-section"),g=this.wrapper.querySelector("#radius-section"),p=this.wrapper.querySelector("#nurbs-section");h.classList.toggle("is-hidden",r!=="linear"),f.classList.toggle("is-hidden",!0),u.classList.toggle("is-hidden",r!=="spline"),g.classList.toggle("is-hidden",r!=="radius"),p.classList.toggle("is-hidden",!0),this.wrapper.querySelectorAll("#radius-mode-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.radiusMode===i)}),i==="absolute"?(this.elements.radiusSlider.value=Ds(this.state.style.absRadiusValue),this.elements.radiusInput.value=Wr(s).toFixed(0),this.elements.radiusInput.min="0",this.elements.radiusInput.max=String(vi),this.elements.radiusInput.step="1"):(this.elements.radiusSlider.value=Ds(s),this.elements.radiusInput.value=Number(this.elements.radiusSlider.value).toFixed(2),this.elements.radiusInput.min="0",this.elements.radiusInput.max="1",this.elements.radiusInput.step="0.01"),this.elements.tensionSlider.value=Math.max(0,Math.min(1,a)),this.elements.tensionInput.value=Number(a).toFixed(2),this.elements.nurbsDegreeSlider.value=l,this.elements.nurbsDegreeInput.value=l}_renderAllPreviews(){gr.forEach(t=>{const n=this.previewCards.get(t.id);n&&this._renderPreviewCard(n.canvas,t.id,t.id===this.state.style.preset)})}_renderPreviewCard(t,n,o){const i=t.getBoundingClientRect(),s=window.devicePixelRatio||1,a=Math.max(1,Math.floor(i.width*s)),r=Math.max(1,Math.floor(i.height*s));(t.width!==a||t.height!==r)&&(t.width=a,t.height=r);const c=t.getContext("2d");c.save(),c.scale(s,s),c.clearRect(0,0,i.width,i.height),c.fillStyle="#1f2937",c.fillRect(0,0,i.width,i.height),this._drawPreset(c,i.width,i.height,n,o),c.restore()}_drawPreset(t,n,o,i,s){const r=n-32,c=o-32,l=M=>({x:16+M.x*r,y:16+M.y*c}),d=this._getPresetPoints(i),h=s?"#3b82f6":"#6b7280",f=s?"#60a5fa":"#94a3b8";t.lineWidth=this._getStrokeWidth(),t.lineJoin=this.state.style.mode==="radius"?"round":"miter",t.lineCap="round",t.strokeStyle=h;const u=[],g=new Set,p=new Set,y=M=>{g.has(M)||(g.add(M),u.push(M))},S=this.state.style.mode==="radius"&&i==="branching",m=(M,E,N)=>{const _=N.x-E.x,D=N.y-E.y,F=M.x-E.x,R=M.y-E.y,B=_*_+D*D;return B<1e-6?0:(F*_+R*D)/B},x=M=>{if(!M)return 0;const E=Math.hypot(M.b.x-M.a.x,M.b.y-M.a.y);return E<=1e-6?0:this.state.style.radiusMode==="relative"?Math.max(0,Math.min(.5,this.state.style.radiusValue*.5)):Math.max(0,Math.min(.5,this.state.style.radiusValue/E))},I=(M,E,N,_,D)=>{if(M.length<3||!_)return M;const F=x(_),R=N?D?0:.5:F,B=N?1-F:D?1:.5,L=M.filter(O=>{if(O.tag==="line"&&O.edgeIndex!==void 0){if(O.edgeIndex!==E)return!0;const $=m(O,_.a,_.b);return $>=R&&$<=B}return O.tag!=="line"});return L.length>=2,L},b=d.faces&&d.vertices?d.vertices:null,v=d.faces||null,C=!!(b&&v&&v.length);let w=null,P=null;const T=Math.hypot(r,c);if(d.paths.forEach((M,E)=>{const N=M.points,_=N.map(l);if(N.forEach(y),E===0&&i==="closed"&&(console.groupCollapsed("anchor-control-debug"),console.log("mode",this.state.style.mode),console.log("type",this.state.style.type),console.log("pointHandling",this.state.style.pointHandling),console.log("radiusMode",this.state.style.radiusMode),console.log("radiusValue",this.state.style.radiusValue)),_.length>=2){t.save(),t.lineWidth=Math.max(1,this._getStrokeWidth()*.6),t.strokeStyle="#94a3b8",t.lineCap="round",t.lineJoin="round",t.setLineDash(tc);const F=[];for(let R=0;R<_.length-1;R++)S&&i==="branching"&&E===0&&R===_.length-2||F.push([_[R],_[R+1]]);M.closed&&F.push([_[_.length-1],_[0]]),F.forEach(([R,B])=>{const L=Math.round(R.x),O=Math.round(R.y),$=Math.round(B.x),A=Math.round(B.y),k=`${L}:${O}`,V=`${$}:${A}`,Y=k<V?`${k}|${V}`:`${V}|${k}`;p.has(Y)||(p.add(Y),t.beginPath(),t.moveTo(R.x,R.y),t.lineTo(B.x,B.y),t.stroke())}),t.restore()}let D=this._getInterpolatedPoints(_,M.closed,T);if(D.length<2){E===0&&i==="closed"&&(console.log("drawPoints empty"),console.groupEnd());return}if(E===0&&i==="closed"){const F=D.reduce((B,L)=>({x:Math.min(B.x,L.x),y:Math.min(B.y,L.y)}),{x:1/0,y:1/0}),R=D.reduce((B,L)=>({x:Math.max(B.x,L.x),y:Math.max(B.y,L.y)}),{x:-1/0,y:-1/0});console.log("drawPoints bounds",{min:F,max:R}),console.groupEnd()}if(S){const F=6+this.state.style.order*4,R=this.state.style.pointHandling==="control";D=fr(_,M.closed,this.state.style.radiusMode,this.state.style.radiusValue,F,!1,!1,R,!0);const B=M.trueEndpointStart===!0,L=M.trueEndpointEnd===!0;if(E===0){const O=_.length>=2?{a:_[0],b:_[1]}:null;D=I(D,0,!0,O,B);const $=_.length>=2?{a:_[_.length-2],b:_[_.length-1]}:null;D=I(D,_.length-2,!1,$,L)}else{const O=_.length>=2?{a:_[0],b:_[1]}:null,$=_.length>=2?{a:_[_.length-2],b:_[_.length-1]}:null;D=I(D,0,!0,O,B),D=I(D,_.length-2,!1,$,L)}if(D.length<2)return;D=D.map(O=>({x:O.x,y:O.y}))}if(this.state.style.mode!=="radius"&&(this.state.style.type!=="spline"||M.forceTrim)){if(M.trimFromPoint){const F=l(M.trimFromPoint);let R=0,B=1/0;D.forEach((L,O)=>{const $=Math.hypot(L.x-F.x,L.y-F.y);$<B&&(B=$,R=O)}),D=D.slice(R),!D.length||Math.hypot(D[0].x-F.x,D[0].y-F.y)>1e-6?D.unshift(F):D[0]=F}if(M.trimToPoint){const F=l(M.trimToPoint);let R=0,B=1/0;D.forEach((L,O)=>{const $=Math.hypot(L.x-F.x,L.y-F.y);$<B&&(B=$,R=O)}),D=D.slice(0,R+1),!D.length||Math.hypot(D[D.length-1].x-F.x,D[D.length-1].y-F.y)>1e-6?D.push(F):D[D.length-1]=F}}if(!(D.length<2)){if(t.beginPath(),t.moveTo(D[0].x,D[0].y),D.slice(1).forEach(F=>t.lineTo(F.x,F.y)),M.closed&&(this.state.style.mode!=="radius"||this.state.style.radiusValue<=1e-6)&&t.closePath(),t.stroke(),M.isBoundary&&M.closed?(w=D,P=new Set(N)):!C&&i==="closed"&&M.closed&&!Object.prototype.hasOwnProperty.call(M,"isBoundary")&&(w=D),this.state.style.mode==="radius"&&this.state.style.pointHandling==="anchor"){const F=rc(_,M.closed,this.state.style.radiusMode,this.state.style.radiusValue);F.length&&(t.save(),t.fillStyle="#f87171",F.forEach(R=>{t.beginPath(),t.arc(R.x,R.y,3,0,Math.PI*2),t.fill()}),t.restore())}this.state.style.type==="linear"&&this.state.style.linearStyle==="arrows"&&this._drawEdgeArrows(t,_,M.closed)}}),w&&w.length>=2&&(t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)",t.beginPath(),t.moveTo(w[0].x,w[0].y),w.slice(1).forEach(M=>t.lineTo(M.x,M.y)),t.closePath(),t.fill(),t.restore()),C){t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)";let M=!1;v.forEach(E=>{if(!Array.isArray(E)||E.length<3)return;const N=E.map(R=>b[R]).filter(Boolean);if(N.length<3)return;const _=P?N.every(R=>P.has(R)):!1;if(_&&w&&!M){t.beginPath(),t.moveTo(w[0].x,w[0].y),w.slice(1).forEach(R=>t.lineTo(R.x,R.y)),t.closePath(),t.fill(),M=!0;return}if(_&&w)return;const D=N.map(l),F=this._getInterpolatedPoints(D,!0,T);!F||F.length<2||(t.beginPath(),t.moveTo(F[0].x,F[0].y),F.slice(1).forEach(R=>t.lineTo(R.x,R.y)),t.closePath(),t.fill())}),t.restore()}t.fillStyle=f,u.map(l).forEach(M=>{t.beginPath(),t.arc(M.x,M.y,3.5,0,Math.PI*2),t.fill()})}_getStrokeWidth(){return 2}_drawEdgeArrows(t,n,o){if(n.length<2)return;const i=10,s=6,a=n.length,r=o?a:a-1;t.save(),t.fillStyle=t.strokeStyle;for(let c=0;c<r;c++){const l=n[c],d=n[(c+1)%a],h=d.x-l.x,f=d.y-l.y,u=Math.hypot(h,f);if(u<.001)continue;const g=h/u,p=f/u,y=d,S={x:y.x-g*i,y:y.y-p*i},m={x:S.x+-p*(s/2),y:S.y+g*(s/2)},x={x:S.x+p*(s/2),y:S.y-g*(s/2)};t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(m.x,m.y),t.lineTo(x.x,x.y),t.closePath(),t.fill()}t.restore()}_getInterpolatedPoints(t,n,o=1){const{mode:i,order:s,type:a,pointHandling:r,nurbsDegree:c,radiusMode:l,radiusValue:d}=this.state.style;if(i==="radius"||t.length<2){if(i==="radius"){const u=6+s*4,g=d;return g<=1e-6?t:fr(t,n,l,g,u,!1,!1,r==="control")}return t}const h=4+s*4;if(a==="linear"||s===1)return ic(t,n,h);if(t.length<3)return t;const f=this.state.style.tension??.5;return ur(t,f,n,h)}_buildControlCatmullTargets(t,n){if(t.length<2)return t;const o=[],i=t.length,s=n?i:i-1;n||o.push(t[0]);for(let a=0;a<s;a++){const r=t[a],c=t[(a+1)%i];o.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5})}return n||o.push(t[i-1]),o}_buildMixedCatmullTargets(t,n){if(t.length<2)return t;const o=this._getPathOrientation(t,n),i=[],s=t.length;for(let a=0;a<s;a++){if(!n&&(a===0||a===s-1)){i.push(t[a]);continue}const r=t[(a-1+s)%s],c=t[a],l=t[(a+1)%s],d=(c.x-r.x)*(l.y-c.y)-(c.y-r.y)*(l.x-c.x);(o>=0?d>=0:d<=0)?i.push(c):(i.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5}),i.push({x:(c.x+l.x)*.5,y:(c.y+l.y)*.5}))}return i}_buildMixedControlPoints(t,n,o){if(t.length<3)return t;const i=this._getPathOrientation(t,n),s=Math.max(0,o-1),a=[];n?t.length:t.length-1;for(let r=0;r<t.length;r++){const c=(r-1+t.length)%t.length,l=(r+1)%t.length,d=t[c],h=t[r],f=t[l],u=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),p=!n&&(r===0||r===t.length-1)||(i>=0?u>=0:u<=0);if(a.push(h),p)for(let y=0;y<s;y++)a.push({x:h.x,y:h.y})}return a}_getPathOrientation(t,n){if(!n)return 1;let o=0;for(let i=0;i<t.length;i++){const s=t[(i+1)%t.length];o+=t[i].x*s.y-s.x*t[i].y}return o}_getPresetPoints(t){const n=this.state.previewPoints[t];if(n&&n.vertices&&n.edges)return this._buildPathsFromGraph(n);if(t==="open")return{paths:this.state.previewPoints.open.map(o=>({closed:!1,points:o}))};if(t==="branching"){const o=this.state.previewPoints.branching[0]||[],i=o.length>=1?o[o.length-1]:null,s=o.length>=2?o[o.length-2]:null,a=this.state.style.type==="spline",r=a?o.slice(Math.max(0,o.length-3)):o.slice(Math.max(0,o.length-2));return{paths:this.state.previewPoints.branching.map((c,l)=>{if(l===0)return{closed:!1,points:c,trimToPoint:a?s:null,forceTrim:a,trueEndpointStart:!0,trueEndpointEnd:!1};const d=[...r],h=c[0],u=i&&h&&Math.abs(h.x-i.x)<1e-6&&Math.abs(h.y-i.y)<1e-6?c.slice(1):c;return d.push(...u),{closed:!1,points:d,trimFromPoint:a?s:i,forceTrim:a,trueEndpointStart:!1,trueEndpointEnd:!0}})}}if(t==="branching4"){const o=this.state.previewPoints.branching4;if(!o)return{paths:[]};const i=o.in||[],s=o.out||[],a=d=>{const h=Math.hypot(d.x,d.y);return h>1e-6?{x:d.x/h,y:d.y/h}:{x:0,y:0}},r=i.map(d=>{if(d.length<2)return null;const h=d[d.length-1],f=d[d.length-2];return a({x:h.x-f.x,y:h.y-f.y})}),c=s.map(d=>{if(d.length<2)return null;const h=d[0],f=d[1];return a({x:f.x-h.x,y:f.y-h.y})});if(i.length!==1&&s.length!==1){const d=[];if(i.length===2&&s.length===2){const f=this.dragState?.presetId==="branching4"&&this.dragState.pointIndex!==null,u=T=>f?(this.branching4Pairing||(this.branching4Pairing=T),this.branching4Pairing):(this.branching4Pairing=null,T),g=r.map(T=>T?{x:-T.x,y:-T.y}:null),p=T=>Math.atan2(T.y,T.x),y=(T,M)=>{const E=g[T],N=c[M];return!E||!N?-1/0:E.x*N.x+E.y*N.y},S=(T,M)=>T.x*M.y-T.y*M.x,x=[{type:"in",idx:0,dir:g[0]},{type:"in",idx:1,dir:g[1]},{type:"out",idx:0,dir:c[0]},{type:"out",idx:1,dir:c[1]}].filter(T=>T.dir).slice().sort((T,M)=>p(T.dir)-p(M.dir)),I=x.map((T,M)=>T.type==="in"?M:null).filter(T=>T!==null),b=I.length===2&&(Math.abs(I[0]-I[1])===1||Math.abs(I[0]-I[1])===3),v=T=>y(0,T[0])+y(1,T[1]),C=[0,1],w=[1,0];let P=C;if(b){const T=(_,D)=>{const F=Math.abs(_-D);return Math.min(F,4-F)},M=_=>x.findIndex(D=>D.type==="out"&&D.idx===_),E=_=>x.findIndex(D=>D.type==="in"&&D.idx===_),N=_=>{const D=T(E(0),M(_[0])),F=T(E(1),M(_[1]));return D+F};P=N(w)>N(C)?w:C}else{const T=v(C),M=v(w);if(M===T&&this.state.style.type==="spline"){const E=N=>{const _=g[0]&&c[N[0]]?Math.sign(S(g[0],c[N[0]])):0,D=g[1]&&c[N[1]]?Math.sign(S(g[1],c[N[1]])):0;return(_<0?1:0)+(D<0?1:0)};P=E(w)>E(C)?w:C}else P=M>T?w:C}return P=u(P),i.forEach((T,M)=>{const E=P[M],N=s[E],_=N[0]===T[T.length-1]?N.slice(1):N;d.push({closed:!1,points:[...T,..._]})}),{paths:d}}const h=new Set;return i.forEach((f,u)=>{let g=-1,p=-1/0;const y=r[u];if(s.forEach((S,m)=>{if(h.has(m))return;const x=c[m];if(!y||!x)return;const I=y.x*x.x+y.y*x.y;I>p&&(p=I,g=m)}),g>=0){h.add(g);const S=s[g],m=S[0]===f[f.length-1]?S.slice(1):S;d.push({closed:!1,points:[...f,...m]})}else d.push({closed:!1,points:f})}),s.forEach((f,u)=>{h.has(u)||d.push({closed:!1,points:f})}),{paths:d}}const l=[];return i.length===1?s.forEach(d=>{const h=i[0],f=d[0]===h[h.length-1]?d.slice(1):d;l.push({closed:!1,points:[...h,...f]})}):i.forEach(d=>{const h=s[0],f=h[0]===d[d.length-1]?h.slice(1):h;l.push({closed:!1,points:[...d,...f]})}),{paths:l}}if(t==="branching5"){const o=this.state.previewPoints.branching5;if(!o)return{paths:[]};const i=o.in||[],s=o.out||[];return{paths:[...i.map(r=>({closed:!1,points:r})),...s.map(r=>({closed:!1,points:r}))]}}return{paths:[{closed:!0,points:this.state.previewPoints.closed[0]}]}}_buildPathsFromGraph(t){const n=t.vertices||[],o=t.edges||[];if(!n.length||!o.length)return{paths:[]};const i=new Map,s=new Map,a=new Map;o.forEach(([A,k])=>{i.has(A)||i.set(A,[]),i.get(A).push(k),s.has(k)||s.set(k,[]),s.get(k).push(A),a.set(A,(a.get(A)||0)+1),a.set(k,(a.get(k)||0)+1)});const r=new Map,c=new Map,l=(A,k)=>A<k?`${A}-${k}`:`${k}-${A}`;o.forEach(([A,k])=>{const V=l(A,k);c.has(V)||c.set(V,[A,k]),r.has(A)||r.set(A,new Set),r.has(k)||r.set(k,new Set),r.get(A).add(k),r.get(k).add(A)});const d=(A,k)=>Math.atan2(n[k].y-n[A].y,n[k].x-n[A].x),h=new Map;n.forEach((A,k)=>{const V=[...r.get(k)||[]];V.sort((Y,X)=>d(k,Y)-d(k,X)),h.set(k,V)});const f=(A,k)=>{const V=h.get(k)||[];if(!V.length)return null;const Y=V.indexOf(A);return Y<0?V[0]:V[(Y-1+V.length)%V.length]},g=(()=>{const A=[],k=new Set,V=(Y,X)=>`${Y}->${X}`;return c.forEach(([Y,X])=>{[[Y,X],[X,Y]].forEach(([z,G])=>{const W=V(z,G);if(k.has(W))return;const Q=[];let te=z,pe=G,me=0;for(;me++<o.length*4;){k.add(V(te,pe)),Q.push(te);const vt=f(te,pe);if(vt==null)break;const Qe=pe,rt=vt;if(te=Qe,pe=rt,te===z&&pe===G)break}Q.length>=3&&A.push(Q)})}),A})(),p=A=>[...A].sort((k,V)=>k-V).join("_"),y=[],S=new Set;g.forEach(A=>{const k=p(A);S.has(k)||(S.add(k),y.push(A))});const m=A=>{let k=0;for(let V=0;V<A.length;V++){const Y=n[A[V]],X=n[A[(V+1)%A.length]];k+=Y.x*X.y-X.x*Y.y}return k*.5};let x=null;if(y.length){let A=null,k=-1/0;y.forEach(V=>{const Y=Math.abs(m(V));Y>k&&(k=Y,A=V)}),x=A}const I=new Set(x||[]),b=new Set;if(x&&x.length>=2)for(let A=0;A<x.length;A++){const k=x[A],V=x[(A+1)%x.length];b.add(l(k,V))}const v=new Map,C=A=>Math.atan2(A.y,A.x),w=(A,k)=>A.x*k.y-A.y*k.x,P=(A,k)=>A.x*k.x+A.y*k.y,T=(A,k)=>({x:k.x-A.x,y:k.y-A.y}),M=A=>{const k=Math.hypot(A.x,A.y);return k>1e-6?{x:A.x/k,y:A.y/k}:{x:0,y:0}};n.forEach((A,k)=>{if(I.has(k))return;const V=s.get(k)||[],Y=i.get(k)||[];if(V.length===2&&Y.length===2){const X=V.map(ve=>M(T(n[ve],n[k]))),z=Y.map(ve=>M(T(n[k],n[ve]))),G=X.map(ve=>({x:-ve.x,y:-ve.y})),W=(ve,Je)=>P(G[ve],z[Je]),Q=[0,1],te=[1,0],pe=W(0,0)+W(1,1),me=W(0,1)+W(1,0),Qe=[{type:"in",idx:0,dir:G[0]},{type:"in",idx:1,dir:G[1]},{type:"out",idx:0,dir:z[0]},{type:"out",idx:1,dir:z[1]}].filter(ve=>ve.dir).slice().sort((ve,Je)=>C(ve.dir)-C(Je.dir)),rt=Qe.map((ve,Je)=>ve.type==="in"?Je:null).filter(ve=>ve!==null),zt=rt.length===2&&(Math.abs(rt[0]-rt[1])===1||Math.abs(rt[0]-rt[1])===3);let Ft=Q;if(zt){const ve=(cn,en)=>{const Lo=Math.abs(cn-en);return Math.min(Lo,4-Lo)},Je=cn=>Qe.findIndex(en=>en.type==="out"&&en.idx===cn),Mt=cn=>Qe.findIndex(en=>en.type==="in"&&en.idx===cn),Ts=cn=>{const en=ve(Mt(0),Je(cn[0])),Lo=ve(Mt(1),Je(cn[1]));return en+Lo};Ft=Ts(te)>Ts(Q)?te:Q}else if(me===pe&&this.state.style.type==="spline"){const ve=Je=>{const Mt=Math.sign(w(G[0],z[Je[0]])),Ts=Math.sign(w(G[1],z[Je[1]]));return(Mt<0?1:0)+(Ts<0?1:0)};Ft=ve(te)>ve(Q)?te:Q}else Ft=me>pe?te:Q;V.forEach((ve,Je)=>{const Mt=Y[Ft[Je]];v.set(`${ve}->${k}`,Mt)})}});const E=n.map((A,k)=>k).filter(A=>(s.get(A)||[]).length===0),N=[],_=new Set,D=(A,k)=>`${A}->${k}`,F=(A,k)=>b.has(l(A,k)),R=(A,k,V,Y=!1)=>{const X=D(A,k);if(_.has(X)){N.push([...V,k]);return}_.add(X);const z=[...V,k];if(!Y&&I.has(k)&&z.length>1){N.push(z);return}const G=i.get(k)||[],W=s.get(k)||[],Q=v.get(`${A}->${k}`);if(Q!==void 0){if(z.includes(Q)){N.push(z);return}R(k,Q,z);return}if(G.length===0){N.push(z);return}if(W.length===2&&G.length>2){N.push(z);return}if(W.length===1&&G.length>1){G.forEach(te=>{!Y&&F(k,te)||R(k,te,z,Y)});return}if(W.length<=1&&G.length===1){if(!Y&&F(k,G[0])){N.push(z);return}R(k,G[0],z,Y);return}G.forEach(te=>{!Y&&F(k,te)||R(k,te,z,Y)})};let B=null;if(x&&x.length>=3)B=[...x,x[0]],N.push(B),o.forEach(([A,k])=>{F(A,k)&&_.add(D(A,k))}),o.forEach(([A,k])=>{const V=D(A,k);_.has(V)||R(A,k,[A],!1)});else if(E.length)E.forEach(A=>{(i.get(A)||[]).forEach(V=>R(A,V,[A]))});else{const A=o[0]?.[0];A!==void 0&&(i.get(A)||[]).forEach(V=>R(A,V,[A]))}const L=N.map(A=>{const k=A.length>2&&A[0]===A[A.length-1],V=k?A.slice(0,-1):A,Y=V.map(te=>n[te]),X=V[0],z=V[V.length-1],G=a.get(X)||0,W=a.get(z)||0,Q=A===B;return{closed:k,points:Y,isBoundary:Q,trueEndpointStart:G===1,trueEndpointEnd:W===1,trimFromPoint:!Q&&this.state.style.type==="spline"&&G>2?n[X]:null,trimToPoint:!Q&&this.state.style.type==="spline"&&W>2?n[z]:null,forceTrim:!Q&&this.state.style.type==="spline"}}),O=x?p(x):null,$=y.filter(A=>p(A)!==O);return{paths:L,vertices:n,faces:$}}_handlePreviewMouseDown(t,n){const o=this._findHitPoint(t,n);o&&(this.dragState=o,t.preventDefault())}_handlePreviewMouseMove(t){const{presetId:n,pathIndex:o,pointIndex:i,vertexIndex:s,ioType:a,ioIndex:r}=this.dragState;if(n===null)return;const c=this.previewCards.get(n);if(!c)return;const{x:l,y:d}=this._getNormalizedPoint(t,c.canvas),h={x:Math.max(0,Math.min(1,l)),y:Math.max(0,Math.min(1,d))},f=this.state.previewPoints[n];if(f&&f.in&&f.out&&a&&Number.isInteger(r)){const m=f[a]?.[r]?.[i];m&&(m.x=h.x,m.y=h.y,this._renderAllPreviews());return}if(f&&f.vertices&&f.edges){Number.isInteger(s)&&f.vertices[s]&&(f.vertices[s].x=h.x,f.vertices[s].y=h.y,f.pathOverrides&&delete f.pathOverrides,this._renderAllPreviews());return}const g=(f&&f.vertices&&f.edges?f.pathOverrides?.map(y=>y.points):this.state.previewPoints[n])?.[o];if(!g)return;const p=g[i];p?(p.x=h.x,p.y=h.y):g[i]=h,this._renderAllPreviews()}_handlePreviewMouseUp(){this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}_findHitPoint(t,n){const o=this.previewCards.get(n);if(!o)return null;const s=o.canvas.getBoundingClientRect(),a=t.clientX-s.left,r=t.clientY-s.top,c=16,l=s.width-c*2,d=s.height-c*2,h=8,f=this.state.previewPoints[n];if(f&&f.in&&f.out){const g=[...f.in.map((p,y)=>({points:p,ioType:"in",ioIndex:y})),...f.out.map((p,y)=>({points:p,ioType:"out",ioIndex:y}))];for(let p=0;p<g.length;p++){const{points:y,ioType:S,ioIndex:m}=g[p];for(let x=0;x<y.length;x++){const I=c+y[x].x*l,b=c+y[x].y*d;if(Math.hypot(a-I,r-b)<=h)return{presetId:n,pathIndex:p,pointIndex:x,vertexIndex:null,ioType:S,ioIndex:m}}}return null}const u=f&&f.vertices&&f.edges?this._getPresetPoints(n).paths.map(g=>g.points):this.state.previewPoints[n];for(let g=0;g<u.length;g++){const p=u[g];for(let y=0;y<p.length;y++){const S=c+p[y].x*l,m=c+p[y].y*d;if(Math.hypot(a-S,r-m)<=h){let x=null;return f&&f.vertices&&f.edges&&(x=f.vertices.indexOf(p[y]),x<0&&(x=null)),{presetId:n,pathIndex:g,pointIndex:y,vertexIndex:x,ioType:null,ioIndex:null}}}}return null}_getNormalizedPoint(t,n){const o=n.getBoundingClientRect(),i=16,s=o.width-i*2,a=o.height-i*2,r=(t.clientX-o.left-i)/s,c=(t.clientY-o.top-i)/a;return{x:r,y:c}}}function ao(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function hc(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,o=[];let i=0,s;for(;(s=n.exec(t))!==null;){const c=s[0],l=s.index;l>i&&o.push({type:"text",content:t.substring(i,l)}),c==="\\$"?o.push({type:"text",content:"$"}):o.push({type:"math",content:c}),i=l+c.length}i<t.length&&o.push({type:"text",content:t.substring(i)});const a=[];let r=null;for(const c of o)c.type==="text"?r===null?r={type:"text",content:c.content}:r.content+=c.content:(r!==null&&(a.push(r),r=null),a.push(c));return r!==null&&a.push(r),a.length===0&&o.length===1&&o[0].type==="text"?o:a}function fc(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let o=null,i=!1;if(t&&t[1]?.trim()?(o=t[1].trim(),i=!0):n&&n[1]?.trim()&&(o=n[1].trim(),i=!1),o===null)return`<span class="text-segment">${ao(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(o,{throwOnError:!1,displayMode:i,output:"html",strict:"warn"})}catch(s){return console.error("KaTeX renderToString unexpected error:",s),`<span class="katex-error" title="${ao(s.message||"Unknown KaTeX error")}">${ao(e)}</span>`}}function uc(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const o=t==null?"":String(t);let i="";try{i=hc(o).map(a=>a.type==="text"?`<span class="text-segment">${ao(a.content)}</span>`:a.type==="math"?fc(a.content):"").join("")}catch(s){console.error("Error processing string segments for rendering:",s,o),i=`<span class="katex-error" title="${ao(String(s.message||"Unknown error"))}">Error</span>`}e.innerHTML=i}function pc(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const o=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let i;const s=[];for(o.lastIndex=0;(i=o.exec(e))!==null;){const[,f,u,g,p,y,S,m,x,I,b,v]=i;let C={};if(f){const w=f.split("_"),P=w[0].slice(1),T=w[1].slice(1);C={type:"backslashSubscript",value:`\\mathrm{${P}}_\\mathrm{${T}}`}}else if(u)C={type:"doubleBackslash",value:"\\\\"};else if(g)C={type:"command",value:g};else if(p)C={type:"backslashLetter",value:p.slice(1)};else if(y){C={type:"word",value:y};const w=s[s.length-1],P=s[s.length-2],T=w?.type==="other"&&w.value==="{"&&P?.type==="command";C.isArgument=T}else S?C={type:"number",value:S}:m?C={type:"dollar",value:"\\$"}:x?C={type:"ampersand",value:"&"}:I?C={type:"space",value:" "}:b?C={type:"newline",value:"\\\\"}:v&&(C={type:"other",value:v});C.type&&s.push(C)}const a=["a","I"],r=["+","-","=","*","/","<",">"],c=(f,u)=>{let g=f+u;for(;g>=0&&g<s.length;){if(s[g].type!=="space")return s[g];g+=u}return null},l=f=>f?f.type==="other"&&r.includes(f.value):!1,d=f=>f?f.type==="backslashLetter"||f.type==="word"&&f.value.length===1&&!a.includes(f.value):!1;let h="";for(let f=0;f<s.length;f++){const u=s[f];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":h+=u.value;break;case"other":["#","%"].includes(u.value)?h+="\\"+u.value:h+=u.value;break;case"backslashLetter":h+=u.value;break;case"word":if(u.isArgument)h+=u.value;else if(u.value.length>1)h+=`\\mathrm{${u.value}}`;else{const m=s[f-1],x=s[f-2],I=m?.type==="other"&&m.value==="(",b=I&&x?.type==="space",v=I&&x?.type!=="space",C=c(f,-1),w=c(f,1),P=l(C)||l(w);b?h+=`\\mathrm{${u.value}}`:a.includes(u.value)?P||v?h+=u.value:h+=`\\mathrm{${u.value}}`:h+=u.value}break;case"space":let p=!0;const y=c(f,-1),S=c(f,1);if(!y||!S)p=!0;else{const m=d(y),x=d(S),I=l(y),b=l(S);(I||b)&&(p=!1),m&&x&&(p=!1)}h+=p?"\\ ":" ";break;default:h+=u.value;break}}if(h.endsWith("\\ ")){const f=h.match(/(\\ )+$/);if(f){const u=f[0].length/2,g="\\,".repeat(u);h=h.replace(/(\\ )+$/,g)}}return h===""?"":`$$${h}$$`}const gc={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},yc={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},yr=5,io=25,ea=20,mc=20,xc=.1,qr=[1/4,1/3,1/2,2/3,3/4],ta=4,zn=30,Be=5,Mi=zn/2,Ea=10,ns=2,_n=1,En=[6,6],Ur=[3,3],$i=360,ro=180,jr=90,$e=2*Math.PI,Ci=.01,wa=Math.sqrt(3)/2,Sc=400,Ic=Math.PI/3,bc=1.5,Kt=Math.PI/6,vc=1.5,Mc=[2,3],Cc=[1,3],Ec=.01,wc=8,Tc=5,Pc=Math.PI/24,_c=15,Gs="_EDGE_",Zo=300,Ac=3,Ta=7,mr=1e-15,xr=1e13,Sr=1.15,Dc=1e-5,kc=1-1e-5,Pa=.001,Kr=.01,Rc=.95,Lc=100,Oc=1.5,Nc=.5,Bc=1.5,et=4,Qo=.9,ss=24,os=10,Fn=8,mt=20,De=12,na=5,sa=20,oa=10,ia=5,Vi=20,Xi=12,Fc="\\phantom{-}0",Go="i",Bo="r",$c="\\mathrm{Re}",Vc="\\mathrm{Im}",Xc=80,aa=1,Yi=Math.PI/2,Yc="#808080",ks="rgba(128, 128, 128, 1)",Hc=4,zc=.25,je=10,Le=56,_a=35,Ir=10,Gc=36,Wc=30,ut=40,qc=20,to=32,Aa=2,xn=1.5,Hi=[2,4],wn=1.5,Da=10,Jr=3,no=15,po=12,ra=8,la=48,ei=70,In=20,Uc=20,Zr=6,Qr=2,el=4,ti=1,ca=12,jc=24,Kc="T",Jc=35,Zc=12,Qc=10,ed=10,td=3,is=2,Fs=2,Wt=7,zi=30,Ei=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],Gi=4,sn=12,Ws=30,$n=18,Zt=1,tl=1.5,da=11,ni=18,si=60,nl=20,sl=8,nd=20,br=18,ha=1e6,fa=1e-6,oi=1e-5,as=.015,Rs=32,sd=10,vr=16,od=12,id=14,_s="\\hphantom{-}",Et="\\pi",Mr="\\delta = ",oo="\\theta = ",ka=15,ps=.8,ii=3,Gn=2,ad=1,rd=3,ld=1,cd=140,Cr=.4,dd=.9,Fo=.05,hd=10,Er=1.5,Wi=[15,5,1],wr=80,fd=.01,re=1e-9,Ra=50,ud=6,pd=10,La=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let o=1;o<=n*4;o++)e.add(o/n);return Array.from(e).sort((n,o)=>n-o)})();function gd(e,t){const n=new Set;n.add(0);for(let o=1;o<=e;o++)for(let i=1;i<=o*t;i++)n.add(i/o);return Array.from(n).sort((o,i)=>o-i)}const Vn=gd(ud,pd),An="regular",Qt=" transformation_rotation",On=" transformation_scale",an="transformation_rotate_scale",Zn="transformation_directional_scale",wi="none",Oa="regular",go="complex",Ti="polar",Mo="none",Na="lines",Ba="points",Fa="triangular",$a="polar",gs="degrees",Co="radians",yo="none",mo="on",yd="none",md=" ",xd="Escape",Sd="Delete",Id="Backspace",bd="r",Tr="=",Pr="+",_r="-",Ar="c",Dr="v",kr="x",qi="z",Rr="y",Lr="a",_e="vertex",Re="edge",we="face",It="text",vd=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],Md=(e,t)=>{if(e.length<2)return[];const n=e.length,o=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),s=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[o(l)]:l<0?i():l>=n?s():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c},Or=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},Nr=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Cd=(e,t)=>{const n=Math.PI*2;let o=(t-e)%n;return o<0&&(o+=n),o>Math.PI&&(o-=n),o},lo=(e,t=!1)=>{const n=[],o=e.length,i=t?o:o-1;for(let s=0;s<i;s++)n.push({type:"line",a:e[s],b:e[(s+1)%o]});return n},Ed=(e,t=!1,n=.5)=>{const i=(1-Math.max(0,Math.min(1,n)))*.5,s=vd(i),a=[];return Md(e,t).forEach(({p0:c,p1:l,p2:d,p3:h})=>{const f=[c.x,l.x,d.x,h.x],u=[c.y,l.y,d.y,h.y],g=s.map(y=>y.reduce((S,m,x)=>S+m*f[x],0)),p=s.map(y=>y.reduce((S,m,x)=>S+m*u[x],0));a.push({type:"cubic",coeffX:g,coeffY:p})}),a},wd=(e,t,n,o)=>{if(e.length<2||o<=1e-6)return lo(e,t);const i=e.length,s=n==="fixed"?"absolute":n,a=[],r=l=>{const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=Nr(d,h),g=Nr(f,h),p=Math.hypot(u.x,u.y),y=Math.hypot(g.x,g.y);if(p<=1e-6||y<=1e-6)return null;const S=Math.min(p,y)*.5;let m,x,I;if(s==="absolute"?(m=Math.max(0,Math.min(o,S))*2,x=Or(g),I=Or(u)):(m=Math.max(0,Math.min(1,o)),x=g,I=u),m<=1e-6)return null;const b=m*.5,v=s==="absolute"?p*.5:.5,C=s==="absolute"?y*.5:.5,w={x:h.x+I.x*v,y:h.y+I.y*v},P={x:h.x+x.x*C,y:h.y+x.y*C},T={x:h.x+I.x*b,y:h.y+I.y*b},M={x:h.x+x.x*b,y:h.y+x.y*b},E=Math.PI,N=-Math.PI/2,_=Cd(E,N);return{origin:h,axisX:x,axisY:I,baseScale:m,midIn:w,midOut:P,arcStart:T,arcEnd:M,startAngle:E,sweep:_}};if(t){const l=[];for(let d=0;d<i;d++){const h=r(d);h&&l.push(h)}return l.length?(a.push({type:"line",a:l[0].midIn,b:l[0].arcStart}),l.forEach(d=>{a.push({type:"affineArc",origin:d.origin,axisX:d.axisX,axisY:d.axisY,baseScale:d.baseScale,startAngle:d.startAngle,sweep:d.sweep}),a.push({type:"line",a:d.arcEnd,b:d.midOut})}),a.push({type:"line",a:l[l.length-1].midOut,b:l[0].midIn}),a):lo(e,!0)}const c=[];for(let l=1;l<i-1;l++){const d=r(l);d&&c.push(d)}return c.length?(a.push({type:"line",a:e[0],b:c[0].midIn}),c.forEach(l=>{a.push({type:"line",a:l.midIn,b:l.arcStart}),a.push({type:"affineArc",origin:l.origin,axisX:l.axisX,axisY:l.axisY,baseScale:l.baseScale,startAngle:l.startAngle,sweep:l.sweep}),a.push({type:"line",a:l.arcEnd,b:l.midOut})}),a.push({type:"line",a:c[c.length-1].midOut,b:e[i-1]}),a):lo(e,!1)};function Td(e,t,n=!1){return!t||e.length<2?[]:t.type==="linear"?lo(e,n):t.type==="cubic_spline"?Ed(e,n,t.tension??.5):t.type==="circular_arc"?wd(e,n,t.radiusMode??"relative",t.radiusValue??0):lo(e,n)}function Pd(e,t){const n=[];return e.forEach((o,i)=>{const s=(a,r=!1)=>{i>0,n.push(a)};if(o.type==="line"){const a=o.a,r=o.b,c=t?t(a):a,l=t?t(r):r,d=Math.hypot(l.x-c.x,l.y-c.y),h=Math.max(2,Math.ceil(d/8));for(let f=0;f<=h;f++){const u=f/h;s({x:a.x+(r.x-a.x)*u,y:a.y+(r.y-a.y)*u},f===0)}return}if(o.type==="cubic"){const a=o.coeffX,r=o.coeffY,c=p=>({x:((a[0]*p+a[1])*p+a[2])*p+a[3],y:((r[0]*p+r[1])*p+r[2])*p+r[3]}),l=c(0),d=c(1),h=t?t(l):l,f=t?t(d):d,u=Math.hypot(f.x-h.x,f.y-h.y),g=Math.max(4,Math.ceil(u/6));for(let p=0;p<=g;p++){const y=p/g;s(c(y),p===0)}return}if(o.type==="affineArc"){const{origin:a,axisX:r,axisY:c,baseScale:l,startAngle:d,sweep:h}=o,f=l*.5,u={x:f,y:f},g=24;for(let p=0;p<=g;p++){const y=p/g,S=d+h*y,m={x:u.x+Math.cos(S)*f,y:u.y+Math.sin(S)*f};s({x:a.x+r.x*m.x+c.x*m.y,y:a.y+r.y*m.x+c.y*m.y},p===0)}}}),n}function qs(e,t,n=!1,o=null){const i=Td(e,t,n);return i.length?Pd(i,o):e}function lt(e,t,n=!1){if(e===0)return"0";const o=Math.abs(e),i=e<0?"-":"";let s;if(n||o>=ha||o!==0&&o<fa){if(e===0)return"0";const r=o.toExponential(Math.max(0,t-1)).split("e");let c=parseFloat(r[0]).toString(),l=parseInt(r[1],10);s=`${c} \\cdot 10^{${l}}`}else{const a=o<1?0:Math.floor(Math.log10(o))+1;let r;if(o===0)r=t-1;else if(o<1){let d=0,h=o;for(;h<1&&d<t+5;)h*=10,d++;r=Math.max(0,d-1+t)}else r=Math.max(0,t-a);let c=o.toFixed(r),l=parseFloat(c);if(Math.abs(l)===0&&e!==0)return"0";s=Math.abs(l).toString()}return i+s}function Va(e,t){return t===0?e:Va(t,e%t)}function ne(e){return e.id1<e.id2?`${e.id1}${Gs}${e.id2}`:`${e.id2}${Gs}${e.id1}`}function $o(e,t,n,o,i,s){const a=i-n,r=s-o,c=a*a+r*r;if(c===0){const g=e-n,p=t-o;return Math.sqrt(g*g+p*p)}let l=-((n-e)*a+(o-t)*r)/c;l<0&&(l=0),l>1&&(l=1);const d=n+l*a,h=o+l*r,f=e-d,u=t-h;return Math.sqrt(f*f+u*u)}function ge(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function Wn(e,t,n,o,i=!1){const s=[];if(t==="none"||!n||n<=0)return s;if(t==="polar"){const a=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,r=Math.hypot(e.x,e.y),c=Math.round(r/n)*n;o.forEach(l=>{if(l.alpha>.01&&l.angle>0){const d=l.angle,f=Math.round(a/d)*d*Math.PI/180;s.push({x:c*Math.cos(f),y:c*Math.sin(f),isGridPoint:!0})}})}else if(t==="triangular"){const a=n*wa,r=e.x/n-e.y/(n*Math.sqrt(3)),c=e.y/a;let l=Math.round(r),d=Math.round(c),h=Math.round(-r-c);const f=Math.abs(l-r),u=Math.abs(d-c),g=Math.abs(h-(-r-c));f>u&&f>g?l=-d-h:u>g&&(d=-l-h);const p=l*n+d*n/2,y=d*a;s.push({x:p,y,isGridPoint:!0})}else if(i){const a=Math.floor(e.x/n)*n,r=Math.floor(e.y/n)*n;s.push({x:a,y:r,isGridPoint:!0},{x:a+n,y:r,isGridPoint:!0},{x:a,y:r+n,isGridPoint:!0},{x:a+n,y:r+n,isGridPoint:!0})}else s.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return s}function Nt(){return crypto.randomUUID()}function Mn(e){for(;e<0;)e+=$e;for(;e>=$e;)e-=$e;return e}function Br(e,t,n=0){let o=t-e,i=Math.round((n-o)/(2*Math.PI));return o+i*(2*Math.PI)}function nt(e){return e=Mn(e),e>Math.PI&&(e-=$e),e}function _d(e){for(;e<0;)e+=$i;for(;e>=$i;)e-=$i;return e}function Xa(e,t){const{p1:n,p2:o}=e,{center:i,radius:s}=t,a={x:o.x-n.x,y:o.y-n.y},r={x:n.x-i.x,y:n.y-i.y},c=a.x*a.x+a.y*a.y,l=2*(r.x*a.x+r.y*a.y),d=r.x*r.x+r.y*r.y-s*s;let h=l*l-4*c*d;if(h<0)return[];h=Math.sqrt(h);const f=(-l-h)/(2*c),u=(-l+h)/(2*c);return[{x:n.x+f*a.x,y:n.y+f*a.y},{x:n.x+u*a.x,y:n.y+u*a.y}]}function ds(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let o=2;o*o<=n;o++)for(;n%(o*o)===0;)n/=o*o,t*=o;return[t,n]}function hs(e,t,n=""){const o=n?`\\${n}`:"";return t===1?e===1&&n?o:`${e}${o}`:e===1?`\\sqrt{${t}}${o}`:`${e}\\sqrt{${t}}${o}`}function J(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Jt(e,t=as,n=Rs){if(Math.abs(e)<oi)return"0";const o=e<0?"-":"",i=Math.abs(e);if(Math.abs(i-Math.round(i))<t){const r=Math.round(i);return o+r.toString()}const s=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[r,c]of s)if(c<=n&&Math.abs(i-r/c)<t)return o+`${r}/${c}`;for(let r=1;r<=n;r++){const c=Math.round(i*r);if(!(c===0&&i>oi)&&Math.abs(i-c/r)<t/r){const l=Va(c,r),d=c/l,h=r/l;return h===1?o+`${d}`:o+`${d}/${h}`}}let a=2;return i<.01?a=3:i<.1?a=2:i<10?a=1:a=0,o+i.toFixed(a)}function ys(e,t){if(t.length<3)return!1;const n=e.x,o=e.y;let i=!1;for(let s=0,a=t.length-1;s<t.length;a=s++){const r=t[s].x,c=t[s].y,l=t[a].x,d=t[a].y;if(r===n&&c===o||c===d&&c===o&&n>=Math.min(r,l)&&n<=Math.max(r,l)||r===l&&r===n&&o>=Math.min(c,d)&&o<=Math.max(c,d))return!0;c>o!=d>o&&n<(l-r)*(o-c)/(d-c)+r&&(i=!i)}return i}function Us(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function Ad(e,t,n){const o=t.localCoordSystem;if(!o)return null;const i=n(o.origin),s=wc;if(J(e,i)<s)return{face:t,type:"center"};const a=Tc,r=Dn({x:1,y:0},o),c=n(r);if(bt(e,i,c).distance<a)return{face:t,type:"x_axis"};const d=Dn({x:0,y:1},o),h=n(d);return bt(e,i,h).distance<a?{face:t,type:"y_axis"}:null}function js(e,t){if(ys(e,t))return e;let n=e,o=1/0;for(let i=0;i<t.length;i++){const s=t[i],a=t[(i+1)%t.length],r=bt(e,s,a);r.distance<o&&(o=r.distance,n={x:r.x,y:r.y})}return n}function Dd(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:o,isColorModePanelExpanded:i,isInterpolationPanelExpanded:s,isTransformPanelExpanded:a,isDisplayPanelExpanded:r,isVisibilityPanelExpanded:c,isSessionsPanelExpanded:l}){const d=(h,f)=>f?h.x>=f.x&&h.x<=f.x+f.width&&h.y>=f.y&&h.y<=f.y+f.height:!1;if(o){for(const h of t.colorTargetIcons||[])if(d(e,h))return{...h,type:"colorTargetIcon"};for(const h of t.colorSwatches||[])if(d(e,h))return{...h,type:"colorSwatch"};if(d(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(d(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(d(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(d(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(i){for(const h of t.colorModeIcons||[])if(d(e,h))return{...h,type:"colorModeIcon"}}if(a){for(const h of t.transformIcons||[])if(d(e,h))return{...h,type:"transformIcon"}}if(s){for(const h of t.interpolationIcons||[])if(d(e,h))return{...h,type:"interpolationIcon"}}if(r){for(const h of t.displayIcons||[])if(d(e,h))return{...h,type:"displayIcon"}}if(c){for(const h of t.visibilityIcons||[])if(d(e,h))return{...h,type:"visibilityIcon"}}if(l){for(const h of t.sessionIcons||[])if(d(e,h))return{...h,type:"sessionIcon"};if(d(e,t.removeSessionButton))return{...t.removeSessionButton,type:"button"};if(d(e,t.addSessionButton))return{...t.addSessionButton,type:"button"}}if(n){if(d(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(d(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(d(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(d(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(d(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(d(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"};if(d(e,t.sessionsToolButton))return{...t.sessionsToolButton,type:"toolButton"};if(d(e,t.colorModeToolButton))return{...t.colorModeToolButton,type:"toolButton"}}return d(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function kd(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function bt(e,t,n){const o=n.x-t.x,i=n.y-t.y,s=e.x-t.x,a=e.y-t.y,r=o*o+i*i;if(r===0)return{x:t.x,y:t.y,distance:J(e,t),onSegmentStrict:!0,t:0};let c=(s*o+a*i)/r;const l=c>Dc&&c<kc,d=Math.max(0,Math.min(1,c)),h=t.x+d*o,f=t.y+d*i,u=J(e,{x:h,y:f});return{x:h,y:f,distance:u,onSegmentStrict:l,t:d}}function ol(e,t,n){const o=n.x-t.x,i=n.y-t.y,s=e.x-t.x,a=e.y-t.y,r=o*o+i*i;if(r===0)return{x:t.x,y:t.y,distance:J(e,t)};let c=(s*o+a*i)/r;const l=t.x+c*o,d=t.y+c*i,h=J(e,{x:l,y:d});return{x:l,y:d,distance:h}}function $s(e,t={},n=0){if(!e||typeof e!="string")return n;const o=e.trim();if(!o)return n;try{const i={...t},s=Object.keys(i),a=s.map(l=>i[l]),c=new Function(...s,`'use strict'; return (${o});`)(...a);return Number.isFinite(c)?c:n}catch{return n}}function so(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function Ui(e,t,n){e/=255,t/=255,n/=255;const o=Math.max(e,t,n),i=Math.min(e,t,n);let s,a,r=(o+i)/2;if(o===i)s=a=0;else{const c=o-i;switch(a=r>.5?c/(2-o-i):c/(o+i),o){case e:s=(t-n)/c+(t<n?6:0);break;case t:s=(n-e)/c+2;break;case n:s=(e-t)/c+4;break}s/=6}return[s,a,r]}function Rd(e,t,n,o,i=null){const s=Math.atan2(e.y-t.y,e.x-t.x);if(!o)return{angle:s,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=Pc;let r={angle:s,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},l=(h,f,u=null,g=null)=>{const p=nt(h),y=Math.abs(nt(s-p));if(y<a){const S=c[f],m=r.snapType?c[r.snapType]:1/0;S<m?r={angle:p,difference:y,edgeIndex:u,snapType:f,targetVertexId:g}:S===m&&y<r.difference&&(r={angle:p,difference:y,edgeIndex:u,snapType:f,targetVertexId:g})}};return o.edgeAngles&&o.edgeAngles.forEach((h,f)=>{[h,h+Math.PI/2,h-Math.PI/2,h+Math.PI].forEach(u=>{l(u,"edge",f)})}),o.vertices&&o.vertices.forEach(h=>{if(J(t,h)>re){const f=Math.atan2(h.y-t.y,h.x-t.x);l(f,"vertex_direction",null,h.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(h=>l(h,"cardinal")),{angle:r.angle,edgeIndex:r.edgeIndex,snapType:r.snapType,snapped:r.difference<1/0,targetVertexId:r.targetVertexId}}function Ld(e,t,n,o,i,s=null,a=null,r="x_axis"){if(!s||!a||!n.alignedEdgeInfo)return{snapped:!1};const c=_c/a.scale;let l=[];const{v1Id:d,v2Id:h}=n.alignedEdgeInfo,f=i(d),u=i(h);if(f&&u&&f.type==="regular"&&u.type==="regular"){const p=J(f,u);[.25,1/3,.5,2/3,.75,1].forEach(S=>{const m=p*S,x=Math.abs(s-m);l.push({scale:m,distance:x,type:"edge_fraction",priority:S===.5?1:S===1?2:3,fraction:S})})}if(l.length===0)return{snapped:!1};l.sort((p,y)=>p.priority!==y.priority?p.priority-y.priority:p.distance-y.distance);const g=l.find(p=>p.distance<c);return g?{snapped:!0,scale:g.scale,snapType:"edge_fraction",edgeFraction:g.fraction}:{snapped:!1}}function Od(e,t,n,o,i){let s=null,a=1/0;if(t&&(t.vertices&&t.vertices.forEach(r=>{const c=J(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:r,snapType:"vertex",vertexId:r.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(r=>{const c=J(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:{x:r.x,y:r.y},snapType:"edge",edgeInfo:{v1:r.v1,v2:r.v2}})}),t.faceCenters&&t.faceCenters.forEach(r=>{const c=J(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:r,snapType:"faceCenter"})})),n&&n!=="none"&&o&&o.interval1){const r=o.alpha2>o.alpha1&&o.interval2?o.interval2:o.interval1;Wn(e,n,r,i,!0).forEach(l=>{const d=J(e,l);d<a&&(a=d,s={snapped:!0,snapPoint:l,snapType:"grid"})})}return s||{snapped:!1}}function Nd(e){if(Array.isArray(e)){const[t,n,o]=Ui(e[0],e[1],e[2]),i=1-o,[s,a,r]=ji(t,n,i);return[s,a,r]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,o,i,s]=t,a=parseInt(n),r=parseInt(o),c=parseInt(i),[l,d,h]=Ui(a,r,c),f=1-h,[u,g,p]=ji(l,d,f);return`rgba(${u}, ${g}, ${p}, ${s})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16),[i,s,a]=Ui(t,n,o),r=1-a,[c,l,d]=ji(i,s,r);return`#${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function Pi(e){let t=0;const n=e.length;for(let o=0;o<n;o++){const i=(o+1)%n;t+=e[o].x*e[i].y,t-=e[i].x*e[o].y}return t/2}function Bd(e,t,n){return Math.max(t,Math.min(n,e))}function Fd(e,t){return e==="light"?yc:t}function ji(e,t,n){let o,i,s;if(t===0)o=i=s=n;else{const a=(l,d,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?l+(d-l)*6*h:h<.5?d:h<.6666666666666666?l+(d-l)*(6*(.6666666666666666-h)):l),r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;o=a(c,r,e+1/3),i=a(c,r,e),s=a(c,r,e-1/3)}return[Math.round(o*255),Math.round(i*255),Math.round(s*255)]}function As(e,t){const n=Jt(e,.001),o=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${o}`;if(n==="1")return o;if(n==="-1")return`-${o}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${o}`;if(n.includes("/")){let i="",s=n;s.startsWith("-")&&(i="-",s=s.substring(1));const a=s.split("/"),r=a[0],c=a[1];return r==="1"?`${i}\\frac{1}{${c}}${o}`:`${i}\\frac{${r}}{${c}}${o}`}return`${n}${o}`}function ze(e,t,n,o,i,s){const a={x:e.x-t.x,y:e.y-t.y};if(i){const r=Math.hypot(s.x,s.y);if(r>re){const c={x:s.x/r,y:s.y/r},l=a.x*c.x+a.y*c.y,d={x:a.x-l*c.x,y:a.y-l*c.y},h=l*o,f={x:h*c.x+d.x,y:h*c.y+d.y};return{x:t.x+f.x,y:t.y+f.y}}return{x:e.x,y:e.y}}else{let r={...a};r.x*=o,r.y*=o;const c=r.x,l=r.y;return r.x=c*Math.cos(n)-l*Math.sin(n),r.y=c*Math.sin(n)+l*Math.cos(n),{x:t.x+r.x,y:t.y+r.y}}}function _i(e){if(e.length<3)return null;if(e.length===3){const[t,n,o]=e,i=J(n,o),s=J(t,o),a=J(t,n),r=i+s+a;if(r<re)return null;const c=(i*t.x+s*n.x+a*o.x)/r,l=(i*t.y+s*n.y+a*o.y)/r,h=2*(Math.abs((n.x-t.x)*(o.y-t.y)-(o.x-t.x)*(n.y-t.y))/2)/r;return{center:{x:c,y:l},radius:h}}return Vd(e)}function $d(e,t,n){const o=qr.reduce((s,a)=>Math.abs(a-e.t)<Math.abs(s-e.t)?a:s),i={x:t.x+o*(n.x-t.x),y:t.y+o*(n.y-t.y)};return{fraction:o,point:i}}function Vd(e){if(e.length<3)return null;let t={x:e.reduce((i,s)=>i+s.x,0)/e.length,y:e.reduce((i,s)=>i+s.y,0)/e.length};ys(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,o=Fr(t,e);for(let i=0;i<mc;i++){let s=!1;const a=o*xc,r=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of r){const l={x:n.x+c.x,y:n.y+c.y};if(ys(l,e)){const d=Fr(l,e);d>o&&(n=l,o=d,s=!0)}}if(!s)break}return{center:n,radius:Math.max(o,re)}}function Fr(e,t){let n=1/0;for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length],a=il(e,i,s);n=Math.min(n,a)}return n}function il(e,t,n){return bt(e,t,n).distance}function Xd(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=$r(n,t);else if(!n.localCoordSystem.isCustom){const o=$r(n,t);o&&(n.localCoordSystem.origin=o.origin,n.localCoordSystem.scale=o.scale)}})}function Yd(e,t,n){const o=[e];let i=e,s=t;const a=n.size+2;for(let r=0;r<a;r++){if(o.push(s),s===e)return o.pop(),o;const c=n.get(s);if(!c||c.length<1)return null;const l=c.indexOf(i);if(l===-1)return null;const d=(l+1)%c.length,h=c[d];i=s,s=h}return null}function Hd(e,t,n){if(e.length<=1)return e;const o=new Set(t.map(i=>[i.id1,i.id2].sort().join("_")));return e.filter(i=>{const s=i.vertexIds;if(s.length<3)return!1;for(let a=0;a<s.length;a++)for(let r=a+2;r<s.length;r++){if(a===0&&r===s.length-1)continue;const c=s[a],l=s[r],d=[c,l].sort().join("_");if(o.has(d))return!1}return!0})}function Ai(e,t){const n=new Map,o=new Map;e.forEach(l=>{const d=t(l.id1),h=t(l.id2);!d||!h||d.type!=="regular"||h.type!=="regular"||(o.has(d.id)||o.set(d.id,d),o.has(h.id)||o.set(h.id,h),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,d]of n.entries()){const h=o.get(l);h&&d.sort((f,u)=>{const g=o.get(f),p=o.get(u);if(!g||!p)return 0;const y=Math.atan2(g.y-h.y,g.x-h.x),S=Math.atan2(p.y-h.y,p.x-h.x);return y-S})}const i=[],s=new Set;for(const[l,d]of n.entries())for(const h of d){const f=`${l}->${h}`;if(s.has(f))continue;const u=Yd(l,h,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const S=u[y],m=u[(y+1)%u.length];s.add(`${S}->${m}`)}const p={vertexIds:u};p.id=ge(p),i.push(p)}}const a=Hd(i,e),r=[],c=new Set;return a.forEach(l=>{const d=[...l.vertexIds].sort().join("_");c.has(d)||(r.push(l),c.add(d))}),r}function ms(e,t,n,o){const i={id1:e.id,id2:t.id},s=e.x-t.x,a=e.y-t.y,r=s/n,c=a/n,l=1e-5;if(n&&Math.abs(r-Math.round(r))<l&&Math.abs(c-Math.round(c))<l){i.labelMode="exact";const h=Math.round(r),f=Math.round(c);i.exactValue={g2gSquaredSum:h*h+f*f,gridInterval:n}}else i.labelMode="decimal";return i.color=o(Re),i}function al(e,t){let n=null,o=1/0;return t.forEach(i=>{if(!i)return;const s=Math.abs(e.x-(i.x+i.width/2));s<o&&s<i.width/2+je&&(o=s,n=i)}),n}function zd(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function Ae(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],g=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${g})`}t=Math.max(0,Math.min(1,t));let o=n[0],i=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){o=n[u],i=n[u+1];break}const s=i.pos-o.pos,a=s>0?(t-o.pos)/s:0,r=Math.round(o.color[0]+(i.color[0]-o.color[0])*a),c=Math.round(o.color[1]+(i.color[1]-o.color[1])*a),l=Math.round(o.color[2]+(i.color[2]-o.color[2])*a),d=o.alpha!==void 0?o.alpha:1,h=i.alpha!==void 0?i.alpha:1,f=d+(h-d)*a;return`rgba(${r},${c},${l},${f})`}function $r(e,t){const n=e.vertexIds.map(i=>t(i)).filter(i=>i&&i.type==="regular");if(n.length<3)return null;const o=_i(n);return o?{origin:{...o.center},angle:0,scale:o.radius,isCustom:!1,showCoordSystem:!1}:null}function Ki(e,t){if(!t)return e;const n={x:e.x-t.origin.x,y:e.y-t.origin.y},o=Math.cos(-t.angle),i=Math.sin(-t.angle),s={x:n.x*o-n.y*i,y:n.x*i+n.y*o};return t.scale===0?{x:0,y:0}:{x:s.x/t.scale,y:s.y/t.scale}}function hn(e,t){const n=new Set;return t.forEach(o=>{o.id1===e?n.add(o.id2):o.id2===e&&n.add(o.id1)}),Array.from(n)}function Dn(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},o=Math.cos(t.angle),i=Math.sin(t.angle),s={x:n.x*o-n.y*i,y:n.x*i+n.y*o};return{x:s.x+t.origin.x,y:s.y+t.origin.y}}function Gd(e,t,n,o){const i=(e.x-t.x)*(n.y-o.y)-(e.y-t.y)*(n.x-o.x);if(Math.abs(i)<re)return null;const s=((e.x-n.x)*(n.y-o.y)-(e.y-n.y)*(n.x-o.x))/i,a=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/i;return s>re&&s<1-re&&a>re&&a<1-re?{x:e.x+s*(t.x-e.x),y:e.y+s*(t.y-e.y)}:null}function Wd(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length];if(il(n,i,s)<re)return!1}if(!ys(n,t))return!1}return!0}function qd(e,t,n){const o=[];for(let i=0;i<t.length;i++)o.push({p1:t[i],p2:t[(i+1)%t.length]});for(const i of e){const s=n(i.id1),a=n(i.id2);if(!(!s||!a)){for(const r of o)if(Gd(s,a,r.p1,r.p2))return!0}}return!1}function Vr(e,t,n){const o=[];for(const i of e)for(const s of t){if(i.originalId===s.originalId&&i.transformIndex===s.transformIndex)continue;const a=J(i,s);a<n&&o.push({dist:a,sourceVertex:i,targetVertex:s,correctionVector:{x:s.x-i.x,y:s.y-i.y},type:"vertex-vertex"})}return o}function Vo(e,t,n){const o=[];for(const i of e)for(const s of t){if(!s||!s.originalEdge||!s.p1||!s.p2)continue;const a=i.transformIndex===s.transformIndex,r=i.originalId===s.originalEdge.id1||i.originalId===s.originalEdge.id2;if(a&&r)continue;const c=bt(i,s.p1,s.p2);c.distance<n&&c.onSegmentStrict&&o.push({dist:c.distance,sourceVertex:i,targetEdge:s,snapPoint:{x:c.x,y:c.y},correctionVector:{x:c.x-i.x,y:c.y-i.y},type:"vertex-to-edge"})}return o}function rl(e,t,n,o,i,s,a,r){const c=Be*2/s.scale,l=Be/s.scale,d=String(An).trim(),h=e.filter(X=>(X&&X.type?String(X.type).trim():"undefined")===d);if(h.length===0||i<=0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const f=new Set(e.map(X=>X.id)),u=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const z=X,G=X;h.forEach(W=>{u.push({...r(W,z,a),originalId:W.id,transformIndex:G,type:"regular"})})}const g=t.filter(X=>X.type==="regular"&&!f.has(X.id)).map(X=>({...X,originalId:X.id,transformIndex:void 0})),p=n.filter(X=>f.has(X.id1)&&f.has(X.id2)),y=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const z=X,G=u.filter(W=>W.transformIndex===z);G.length>0&&p.forEach(W=>{const Q=G.find(pe=>pe.originalId===W.id1),te=G.find(pe=>pe.originalId===W.id2);Q&&te&&y.push({p1:Q,p2:te,originalEdge:W,transformIndex:z,originalEdgeId:ne(W)})})}const S=n.filter(X=>!f.has(X.id1)||!f.has(X.id2)).map(X=>({p1:o(X.id1),p2:o(X.id2),originalEdge:X,transformIndex:void 0,originalEdgeId:ne(X)})).filter(X=>X.p1&&X.p2),m=[...g,...u],x=[...S,...y],I=Vr(u,m,c),b=Vo(u,x,l),C=Vo(g,y,l).map(X=>({dist:X.dist,sourceEdge:X.targetEdge,targetVertex:X.sourceVertex,correctionVector:{x:X.sourceVertex.x-X.snapPoint.x,y:X.sourceVertex.y-X.snapPoint.y},type:"edge-to-vertex"})),w=[...I,...b,...C];if(w.length===0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const P={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};w.sort((X,z)=>{const G=P[X.type]??99,W=P[z.type]??99;return G!==W?G-W:X.dist-z.dist});const T=w[0];let M={...T.correctionVector};const E=T.sourceVertex?T.sourceVertex.transformIndex:T.sourceEdge.transformIndex,N=T.targetVertex?T.targetVertex.transformIndex:T.targetEdge?T.targetEdge.transformIndex:void 0;let _;N===void 0?_=E:_=E-N;let D={x:0,y:0};Math.abs(_)>1e-9?(D.x=M.x/_,D.y=M.y/_):D={x:0,y:0};const F={...a,delta:{x:a.delta.x+D.x,y:a.delta.y+D.y}},R=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const z=X,G=X;h.forEach(W=>{R.push({...r(W,z,F),id:`final_${W.id}_${X}`,originalId:W.id,transformIndex:G,type:"regular"})})}const B=g.map(X=>({...X})),L=[...B,...R],O=Vr(R,L,re),$=S.map(X=>({...X})),A=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const z=X,G=R.filter(W=>W.transformIndex===z);G.length>0&&p.forEach(W=>{const Q=G.find(pe=>pe.originalId===W.id1),te=G.find(pe=>pe.originalId===W.id2);Q&&te&&A.push({p1:Q,p2:te,originalEdge:W,transformIndex:z,originalEdgeId:ne(W)})})}const k=[...$,...A],V=Vo(R,k,re),Y=Vo(B,A,re);return{snapped:!0,finalTransform:F,bestSnap:T,mergePairs:O.map(X=>({source:{originalId:X.sourceVertex.originalId,transformIndex:X.sourceVertex.transformIndex},target:{originalId:X.targetVertex.originalId,transformIndex:X.targetVertex.transformIndex}})),edgeSnaps:[...V,...Y].map(X=>({sourceVertex:{originalId:X.sourceVertex.originalId,transformIndex:X.sourceVertex.transformIndex},targetEdge:{originalEdgeId:X.targetEdge.originalEdgeId,transformIndex:X.targetEdge.transformIndex}}))}}function Ud(e,t,n,o,i,s,a){const r={delta:i},l=rl(e,t,n,o,s,a,r,(d,h,f=r)=>({x:d.x+f.delta.x*h,y:d.y+f.delta.y*h}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const Vs=e=>Math.max(0,Math.min(1,e)),ct=(e,t)=>{const n=Us(e);return n||t},St=(e,t,n)=>e+(t-e)*n,Xr=(e,t)=>{let n=0,o=0,i=0,s=0,a=0;return e.forEach((r,c)=>{const l=t[c]||0;a+=l,n+=r.r*l,o+=r.g*l,i+=r.b*l,s+=r.a*l}),a<=0?{r:0,g:0,b:0,a:1}:{r:n/a,g:o/a,b:i/a,a:s/a}};function jd(e){const t=cd/e;let n=Math.pow(10,Math.floor(Math.log10(t))),o=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-o)<re||n===0)&&(o=n===0?.001:n*10,n===0&&(n=1e-4));const i=n,s=o;let a=0;s>i&&i>0&&(a=(Math.log10(t)-Math.log10(i))/(Math.log10(s)-Math.log10(i)));let r=(a-Cr)/(dd-Cr);r=Math.max(0,Math.min(1,r)),r=r*r*(3-2*r);let c=1-r,l=r;c<Fo?c=0:c>1-Fo&&(c=1),l<Fo?l=0:l>1-Fo&&(l=1);const d=c+l;return d>0&&d!==2&&(c/=d,l/=d),{grid1Interval:i,grid2Interval:s,alpha1:c,alpha2:l}}function Kd(e,t,n,o){const i=o({x:0,y:0}),s={x:t/2,y:n/2},a=J(i,s);let r;a<1e-6?r=wr:r=wr/a*(180/Math.PI),(isNaN(r)||r<=re)&&(r=re);const c=[];let l=[...Wi],d=l[l.length-1];const h=1e-15;for(;d>h;)d/=10,l.includes(d)||l.push(d);l.sort((y,S)=>S-y);let f=null,u=null;for(let y=l.length-1;y>=0;y--){const S=l[y];if(r<S){f={angle:S,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!f&&l.length>0?(f={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!f&&l.length===0&&(f={angle:Wi[0],alpha:1}),c.push(f),u){const y=Math.log10(f.angle),S=Math.log10(u.angle),m=Math.log10(r);let x;S===y?x=0:x=(m-y)/(S-y),x=Math.max(0,Math.min(1,x));const I=x*x*(3-2*x);I>fd&&(u.alpha=I,c.push(u))}const g=[],p=new Set;c.sort((y,S)=>S.angle-y.angle);for(const y of c)p.has(y.angle)||(g.push(y),p.add(y.angle));return g.length===0&&g.push({angle:Wi[0],alpha:1}),g}function ll(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:o,colors:i,isDragConfirmed:s,dragPreviewVertices:a,currentAltPressed:r},c,l,d){if(!n&&o.length===0)return;const h=new Map;s&&a&&a.forEach(u=>{if(u&&u.id){const g=u.originalId||u.id;h.set(g,u)}});const f=u=>s&&h.has(u)?h.get(u):l(u);t.forEach(u=>{const g=d(u),p=o.includes(g),y=!r&&g===n;if(s&&u.vertexIds.some(S=>h.has(S)),(p||y)&&u.color!=="transparent"){e.save(),e.fillStyle=i.selectionGlow,e.globalAlpha=zc,e.beginPath();const S=u.vertexIds.map(x=>f(x)).filter(x=>x&&x.type==="regular");if(S.length<3){e.restore();return}S.map(x=>c(x)).forEach((x,I)=>{I===0?e.moveTo(x.x,x.y):e.lineTo(x.x,x.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(x=>{const I=t.find(b=>b.id===x);if(I){const b=I.vertexIds.map(v=>f(v)).filter(v=>v&&v.type==="regular");if(b.length>=3){const v=b.map(C=>c(C));e.moveTo(v[0].x,v[0].y),v.slice(1).forEach(C=>e.lineTo(C.x,C.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function Ya(e,t,{colors:n,verticesVisible:o=!0,isSnapped:i=!1},s){if(t.type===An&&!o&&!i)return;const a=s(t);switch(t.type){case An:e.beginPath(),e.arc(a.x,a.y,Be,0,$e),e.fillStyle=i?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case Qt:case On:case an:case Zn:const r=Mi*2,c={type:t.type,x:a.x-r/2,y:a.y-r/2,width:r,height:r};Di(e,c,n);break}}function cl(e,t,n,o){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=o)return{ranges:[[0,360]],isFullCircle:!0};const i={left:0,right:n,top:0,bottom:o};if(e.x+t<i.left||e.x-t>i.right||e.y+t<i.top||e.y-t>i.bottom)return null;const s=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(s.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const r=[];if(s.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const p=u.x-e.x,y=u.y-e.y,S=Math.atan2(-y,p),m=S<0?S+2*Math.PI:S;r.push(m*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{Xa({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(p=>{const y=p.x-e.x,S=p.y-e.y,m=Math.atan2(-S,y),x=m<0?m+2*Math.PI:m;r.push(x*180/Math.PI)})}),r.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(r.map(u=>Math.round(u*1e6)/1e6))].sort((u,g)=>u-g);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let d=0,h=0,f=0;for(let u=0;u<l.length;u++){const g=l[u],p=l[(u+1)%l.length];let y;u===l.length-1?y=360-g+p:y=p-g,y>d&&(d=y,h=g,f=p)}return f>h?{ranges:[[f,h+360]],isFullCircle:!1}:{ranges:[[f,h]],isFullCircle:!1}}function Jd(e,{canvas:t,dpr:n,colors:o}){const i=t.width/n,s=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=o.background,e.fillRect(0,0,i,s)}function Zd(e,{allFaces:t,allEdges:n,facesVisible:o,isDragConfirmed:i,dragPreviewVertices:s,transformIndicatorData:a,initialDragVertexStates:r,colors:c,initialCoordSystemStates:l,interpolationStyle:d,getInterpolationStyleById:h,faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:g="x",faceColorPolarExpression:p="r",edgeColorExpression:y="x"},S,m){if(!o||!t||!c||!e)return;const x=v=>m(v);t.filter(v=>!v.parentFaceId).forEach(v=>{if(!v||!v.vertexIds||v.vertexIds.length<3)return;const C=v.vertexIds.map(E=>x(E)).filter(E=>E&&E.type==="regular");if(C.length<3)return;const w=v.interpolationStyleId&&h?h(v.interpolationStyleId):d,T=(w?qs(C,w,!0,S):C).map(E=>S(E));let M=v;v.localCoordSystem,T.every(E=>E&&typeof E.x=="number"&&typeof E.y=="number")&&li(e,T,M,c,S,m,n,t,x,!0,d,{faceColorMode:f,edgeColorMode:u,faceColorExpression:g,faceColorPolarExpression:p,edgeColorExpression:y})}),t.filter(v=>v.parentFaceId&&v.color!=="transparent").forEach(v=>{if(!v||!v.vertexIds||v.vertexIds.length<3)return;const C=v.vertexIds.map(E=>x(E)).filter(E=>E&&E.type==="regular");if(C.length<3)return;const w=v.interpolationStyleId&&h?h(v.interpolationStyleId):d,T=(w?qs(C,w,!0,S):C).map(E=>S(E));let M=v;v.localCoordSystem,T.every(E=>E&&typeof E.x=="number"&&typeof E.y=="number")&&li(e,T,M,c,S,m,n,t,x,!1,d,{faceColorMode:f,edgeColorMode:u,faceColorExpression:g,faceColorPolarExpression:p,edgeColorExpression:y})})}function Qd(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:o,findVertexById:i,transformIndicatorData:s}){if(!t)return e.localCoordSystem;const a=new Set(e.vertexIds),r=new Set(o.map(g=>g.id));if([...a].every(g=>r.has(g))){const g=JSON.parse(JSON.stringify(t));if(s){const{center:p,rotation:y,scale:S,directionalScale:m,startPos:x}=s,I={x:x.x-p.x,y:x.y-p.y};if(g.origin=ze(t.origin,p,y,S,m,I),m){const b=Dn({x:1,y:0},t),v=ze(b,p,y,S,m,I);g.scale=J(g.origin,v)}else g.angle=Mn(t.angle+y),g.scale=t.scale*S}else if(o.length>0&&n.length>0){const p=o.find(S=>a.has(S.id)),y=p?n.find(S=>S.id===p.id):null;if(y){const S=y.x-p.x,m=y.y-p.y;g.origin.x+=S,g.origin.y+=m}}return g}const l=e.vertexIds.map(g=>n.find(p=>p&&p.id===g)||i(g)).filter(g=>g&&g.type==="regular");if(!t.isCustom){const g=_i(l);if(g){const p=s?s.rotation:0;return{...t,origin:g.center,scale:g.radius,angle:Mn(t.angle+p)}}return t}const d=JSON.parse(JSON.stringify(t));if(s){const{center:g,rotation:p,scale:y,directionalScale:S,startPos:m}=s,x={x:m.x-g.x,y:m.y-g.y};if(d.origin=ze(t.origin,g,p,y,S,x),S){const I=Dn({x:1,y:0},t),b=ze(I,g,p,y,S,x);d.scale=J(d.origin,b)}else d.angle=Mn(t.angle+p),d.scale=t.scale*y}let h={...d.origin},f=d.angle,u=d.scale;if(d.attachedToVertex){if(r.has(d.attachedToVertex)){const g=n.find(p=>p.id===d.attachedToVertex);g&&(h={...g})}}else if(d.attachedToEdge&&(r.has(d.attachedToEdge.v1)||r.has(d.attachedToEdge.v2))){const g=n.find(y=>y.id===d.attachedToEdge.v1)||i(d.attachedToEdge.v1),p=n.find(y=>y.id===d.attachedToEdge.v2)||i(d.attachedToEdge.v2);g&&p&&(h={x:g.x+d.attachedToEdge.t*(p.x-g.x),y:g.y+d.attachedToEdge.t*(p.y-g.y)})}if(d.rotationAlignedToEdge&&(r.has(d.rotationAlignedToEdge.v1)||r.has(d.rotationAlignedToEdge.v2))){const g=n.find(y=>y.id===d.rotationAlignedToEdge.v1)||i(d.rotationAlignedToEdge.v1),p=n.find(y=>y.id===d.rotationAlignedToEdge.v2)||i(d.rotationAlignedToEdge.v2);if(g&&p){const y=Math.atan2(p.y-g.y,p.x-g.x),{originalAngle:S,originalSystemAngle:m}=d.rotationAlignedToEdge,x=m-S;f=Mn(y+x)}}if(d.scaleAttachedToEdge&&(r.has(d.scaleAttachedToEdge.v1)||r.has(d.scaleAttachedToEdge.v2))){const g=n.find(y=>y.id===d.scaleAttachedToEdge.v1)||i(d.scaleAttachedToEdge.v1),p=n.find(y=>y.id===d.scaleAttachedToEdge.v2)||i(d.scaleAttachedToEdge.v2);g&&p&&(u=J(g,p)*d.scaleAttachedToEdge.scaleRatio)}return l.length>=3?d.origin=js(h,l):d.origin=h,d.angle=f,d.scale=Math.max(.01,u),d}function eh(e,t,n){const{copyCount:o,isDragConfirmed:i,initialDragVertexStates:s,dragPreviewVertices:a,transformIndicatorData:r,allEdges:c,allFaces:l,findVertexById:d,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:g="fixed",faceColorMode:p="fixed",edgeColorExpression:y="x",faceColorExpression:S="x",faceColorPolarExpression:m="r"}=t,x=s.length===1&&!r&&s[0].type==="regular";if(!i||!s.length||o<=0||x)return;const I=s.filter(P=>P.type==="regular");if(I.length===0)return;const b=new Set(I.map(P=>P.id)),v=c.filter(P=>b.has(P.id1)&&b.has(P.id2)),C=c.filter(P=>b.has(P.id1)&&!b.has(P.id2)||b.has(P.id2)&&!b.has(P.id1)),w=l.filter(P=>P.vertexIds.every(T=>b.has(T)));e.save(),e.globalAlpha=1;for(let P=0;P<o;P++){P+=o==1;const T=P,M=P;let E;const N=new Map;if(r){const{center:R,rotation:B,scale:L,directionalScale:O,startPos:$}=r,A={x:$.x-R.x,y:$.y-R.y};E=I.map(k=>{const V=ze(k,R,B*M,Math.pow(L,M),O,A);return{...k,...V,id:`preview_${k.id}_${T}`,originalId:k.id,transformIndex:T}})}else{const R=a.length>0?a[0].x-s[0].x:0,B=a.length>0?a[0].y-s[0].y:0;E=I.map(L=>({...L,x:L.x+R*M,y:L.y+B*M,id:`preview_${L.id}_${T}`,originalId:L.id,transformIndex:T}))}if(!E||E.length===0)continue;E.forEach(R=>N.set(R.originalId,R)),w.forEach(R=>{const B=R.vertexIds.map(L=>N.get(L)).filter(Boolean);if(B.length===R.vertexIds.length){const L=B.map(O=>n(O));li(e,L,R,h,n,d,c,[],O=>N.get(O),!1,null,{faceColorMode:p,edgeColorMode:g,faceColorExpression:S,faceColorPolarExpression:m,edgeColorExpression:y})}}),e.setLineDash([]),e.lineWidth=ns;const _=ct(h.edge,{r:255,g:255,b:255,a:1}),D=R=>ct(R?.color||h.vertex||h.edge,_),F=(R,B,L,O)=>{if(g==="inherit_vertices"&&L&&O){const $=D(L),A=D(O);return{r:St($.r,A.r,B),g:St($.g,A.g,B),b:St($.b,A.b,B),a:St($.a,A.a,B)}}if(g==="colormap"&&R.colormapItem){const $=$s(y,{x:B},B),A=Vs($),k=Ae(R.colormapItem,A);return ct(k,_)}return ct(R.color||h.edge,_)};v.forEach(R=>{const B=N.get(R.id1),L=N.get(R.id2);if(B&&L){const O=n(B),$=n(L);if(g==="colormap"||g==="inherit_vertices"){const V=F(R,.5,B,L);e.beginPath(),e.moveTo(O.x,O.y),e.lineTo($.x,$.y),e.strokeStyle=`rgba(${Math.round(V.r)},${Math.round(V.g)},${Math.round(V.b)},${V.a})`,e.stroke()}else if(R.colormapItem){const V=e.createLinearGradient(O.x,O.y,$.x,$.y),Y=Ae(R.colormapItem,R.gradientStart),X=Ae(R.colormapItem,R.gradientEnd);V.addColorStop(0,Y),V.addColorStop(1,X),e.strokeStyle=V,e.stroke()}else e.strokeStyle=R.color||h.edge,e.stroke();const A=ne(R);if((f?.get(A)||[]).some(V=>V.copyIndex===T)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=ps,e.lineWidth=Gn,e.lineCap="round",e.lineJoin="round";const V=$.x-O.x,Y=$.y-O.y,X=Math.hypot(V,Y),z=ta;if(X>re){const G=-Y/X,W=V/X,Q=G*z,te=W*z;e.beginPath(),e.arc(O.x,O.y,z,Math.atan2(te,Q),Math.atan2(-te,-Q)),e.lineTo($.x-Q,$.y-te),e.arc($.x,$.y,z,Math.atan2(-te,-Q),Math.atan2(te,Q)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(O.x,O.y,z,0,$e),e.stroke();e.restore()}}}),C.forEach(R=>{const B=b.has(R.id1)?R.id2:R.id1,L=b.has(R.id1)?R.id1:R.id2,O=N.get(L),$=d(B);if(O&&$){const A=n(O),k=n($);if(g==="colormap"||g==="inherit_vertices"){const X=F(R,.5,O,$);e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(k.x,k.y),e.strokeStyle=`rgba(${Math.round(X.r)},${Math.round(X.g)},${Math.round(X.b)},${X.a})`,e.stroke()}else if(R.colormapItem){const X=e.createLinearGradient(A.x,A.y,k.x,k.y),z=Ae(R.colormapItem,R.gradientStart),G=Ae(R.colormapItem,R.gradientEnd);X.addColorStop(0,z),X.addColorStop(1,G),e.strokeStyle=X,e.stroke()}else e.strokeStyle=R.color||h.edge,e.stroke();const V=ne(R);if((f?.get(V)||[]).some(X=>X.copyIndex===T)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=ps,e.lineWidth=Gn,e.lineCap="round",e.lineJoin="round";const X=k.x-A.x,z=k.y-A.y,G=Math.hypot(X,z),W=ta;if(G>re){const Q=-z/G,te=X/G,pe=Q*W,me=te*W;e.beginPath(),e.arc(A.x,A.y,W,Math.atan2(me,pe),Math.atan2(-me,-pe)),e.lineTo(k.x-pe,k.y-me),e.arc(k.x,k.y,W,Math.atan2(-me,-pe),Math.atan2(me,pe)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(A.x,A.y,W,0,$e),e.stroke();e.restore()}}}),E.forEach(R=>{const B=R.originalId,L=u.get(B)||[],O=L.some(k=>k.copyIndex===T),$=L.find(k=>k.copyIndex===T),A=$?$.type:null;Ya(e,R,{colors:h,verticesVisible:!0,isSnapped:!1},n),O&&Ha(e,R,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:A,currentAltPressed:!1},n)})}e.restore()}function Ha(e,t,n,o,i){const{selectedVertexIds:s,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,isSnapped:h=!1,snapType:f=null,currentAltPressed:u}=n;if(u&&d)return;let g;if(t.type===An){if(g=s.includes(t.id),!l&&!g&&!d&&!h)return}else g=a.includes(t.id);if(g||d||h){const y=o(t);e.save();let S=c.selectionGlow;t.id===r&&t.type!=="regular"?S=c.activeCenterGlow:h?S=c.feedbackSnapped:d&&(S=c.selectionGlow),e.shadowColor=S,e.shadowBlur=ka,e.globalAlpha=ps,e.strokeStyle=S,e.lineWidth=Gn,e.beginPath();let m;t.type===An?m=Be+ii:m=Mi+ii,e.arc(y.x,y.y,m,0,$e),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function th(e,t,n){const{copyCount:o=1,initialDragVertexStates:i,dragPreviewVertices:s,allEdges:a,allFaces:r,findVertexById:c,findAllVerticesInSubgraph:l,colors:d,snappedEdgesInfo:h,snappedVertexIds:f,edgeColorMode:u="fixed",faceColorMode:g="fixed",edgeColorExpression:p="x",faceColorExpression:y="x",faceColorPolarExpression:S="r"}=t;if(!i||i.length!==1||!s||s.length===0)return;const m=i[0];for(let x=0;x<o;x++){x+=o==1;const I=x,b=x;let v;const C=s.length>0?s[0].x-i[0].x:0,w=s.length>0?s[0].y-i[0].y:0;v={x:m.x+C*b,y:m.y+w*b};const P={...m,...v,originalId:m.id,transformIndex:I},T=new Set(l(m.id)),M=a.filter(R=>T.has(R.id1)&&T.has(R.id2)),E=r.filter(R=>R.vertexIds.every(B=>T.has(B))),N=R=>R===m.id?P:T.has(R)?c(R):null;E.forEach(R=>{const B=R.vertexIds.map(N).filter(Boolean);if(B.length>=3){const L=B.map(O=>n(O));li(e,L,R,d,n,c,a,r,N,!0,null,{faceColorMode:g,edgeColorMode:u,faceColorExpression:y,faceColorPolarExpression:S,edgeColorExpression:p})}}),e.save(),e.lineWidth=ns,e.setLineDash([]);const _=ct(d.edge,{r:255,g:255,b:255,a:1}),D=R=>ct(R?.color||d.vertex||d.edge,_),F=(R,B,L,O)=>{if(u==="inherit_vertices"&&L&&O){const $=D(L),A=D(O);return{r:St($.r,A.r,B),g:St($.g,A.g,B),b:St($.b,A.b,B),a:St($.a,A.a,B)}}if(u==="colormap"&&R.colormapItem){const $=$s(p,{x:B},B),A=Vs($),k=Ae(R.colormapItem,A);return ct(k,_)}return ct(R.color||d.edge,_)};M.forEach(R=>{const B=N(R.id1),L=N(R.id2);if(B&&L){const O=n(B),$=n(L);if(e.beginPath(),e.moveTo(O.x,O.y),e.lineTo($.x,$.y),u==="colormap"||u==="inherit_vertices"){const V=F(R,.5,B,L);e.strokeStyle=`rgba(${Math.round(V.r)},${Math.round(V.g)},${Math.round(V.b)},${V.a})`,e.stroke()}else if(R.colormapItem){const V=e.createLinearGradient(O.x,O.y,$.x,$.y),Y=Ae(R.colormapItem,R.gradientStart),X=Ae(R.colormapItem,R.gradientEnd);V.addColorStop(0,Y),V.addColorStop(1,X),e.strokeStyle=V,e.stroke()}else e.strokeStyle=R.color||d.edge,e.stroke();const A=ne(R);if((h?.get(A)||[]).some(V=>V.copyIndex===I)){e.save(),e.strokeStyle=d.feedbackSnapped,e.globalAlpha=ps,e.lineWidth=Gn,e.lineCap="round",e.lineJoin="round";const V=$.x-O.x,Y=$.y-O.y,X=Math.hypot(V,Y),z=ta;if(X>re){const G=-Y/X,W=V/X,Q=G*z,te=W*z;e.beginPath(),e.arc(O.x,O.y,z,Math.atan2(te,Q),Math.atan2(-te,-Q)),e.lineTo($.x-Q,$.y-te),e.arc($.x,$.y,z,Math.atan2(-te,-Q),Math.atan2(te,Q)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(O.x,O.y,z,0,$e),e.stroke();e.restore()}}}),e.restore(),T.forEach(R=>{const B=N(R);if(!B)return;const L=R===m.id,O=f.get(m.id)||[],$=L&&O.some(Y=>Y.copyIndex===I),A=L?O.find(Y=>Y.copyIndex===I):null,k=A?A.type:null,V={...B,id:`preview_${B.originalId||B.id}_${I}`,originalId:B.originalId||B.id,transformIndex:I};Ya(e,V,{colors:d,verticesVisible:!0,isSnapped:!1},n),$&&Ha(e,V,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:d,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:k,currentAltPressed:!1},n)})}}function dl(e,{startVertex:t,snappedData:n,isShiftPressed:o,currentColor:i,nextCreationColor:s,nextEdgeColor:a,colors:r,edgeColormapInfo:c,interpolationStyle:l},d){const h=d(t),f=d(n);e.save();let u=[{x:t.x,y:t.y},{x:n.x,y:n.y}];if(l&&l.type&&l.type!=="linear"?(u=qs(u,l,!1,null),e.setLineDash([])):e.setLineDash(En),c&&c.colormapItem){const S=e.createLinearGradient(h.x,h.y,f.x,f.y),m=Ae(c.colormapItem,c.startT),x=Ae(c.colormapItem,c.endT);S.addColorStop(0,m),S.addColorStop(1,x),e.strokeStyle=S}else n.snapped||o?e.strokeStyle=r.feedbackSnapped:e.strokeStyle=a;e.lineWidth=ns;const p=u.map(S=>d(S));e.beginPath(),e.moveTo(p[0].x,p[0].y);for(let S=1;S<p.length;S++)e.lineTo(p[S].x,p[S].y);if(e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(f.x,f.y,Be,0,$e),n.snapped?e.fillStyle=r.feedbackSnapped:e.fillStyle=s,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=r.feedbackSnapped,e.shadowBlur=ka,e.globalAlpha=ps,e.strokeStyle=r.feedbackSnapped,e.lineWidth=Gn;const S=Be+ii;e.beginPath(),e.arc(f.x,f.y,S,0,$e),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function ai(e,t,n){const o=[];if(n>360){const s=n-360,a=Math.floor(t/e)*e;for(let r=a;r<360;r+=e)r>=t&&o.push(r);for(let r=0;r<=s+e;r+=e)r<=s&&o.push(r)}else{const s=Math.floor(t/e)*e;for(let a=s;a<=n+e;a+=e)a>=t&&a<=n&&a>=0&&a<360&&o.push(a)}return[...new Set(o)].sort((s,a)=>s-a)}function nh(e,t,n){return e.x>=-20&&e.x<=t+mt&&e.y>=-20&&e.y<=n+mt}function sh(e,t,n,o,i,{canvas:s,dpr:a,viewTransform:r,angleDisplayMode:c,colors:l},d,h){if(typeof d!="function"||typeof n!="function")return;const f=d({x:0,y:0}),u=s.width/a,g=s.height/a,p={x:u/2,y:g/2},y=Math.min(u,g)/4,S=J(f,p),m=y+S;if(m<nl||!hl(f.x,f.y,m,u,g))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=Zt;const x=Math.min(u,g)*400,I=m>x;let b=null;if(I){const E={x:0,y:0,w:u,h:g},N={x:f.x,y:f.y,r:m},_=ua(N,E);if(_.length>=2){let D=_[0],F=_[1],R=0;for(let O=0;O<_.length;O++)for(let $=O+1;$<_.length;$++){const A=(_[O].x-_[$].x)**2+(_[O].y-_[$].y)**2;A>R&&(R=A,D=_[O],F=_[$])}e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(F.x,F.y),e.stroke();const B=(Math.atan2(f.y-D.y,D.x-f.x)*180/Math.PI+360)%360,L=(Math.atan2(f.y-F.y,F.x-f.x)*180/Math.PI+360)%360;b={minAngle:Math.min(B,L),maxAngle:Math.max(B,L),isFullCircle:!1},Math.abs(B-L)>180&&(b={minAngle:Math.max(B,L),maxAngle:Math.min(B,L)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(f.x,f.y,m,0,2*Math.PI),e.stroke(),b=cl(f,m,u,g);if(e.restore(),!b)return;const v=m/(r.scale/a),C=new Set,w=new Map;h.forEach(E=>{const N=E.alpha;if(N<Kr||m*(E.angle*Math.PI/180)<sl*.5)return;const D=`rgba(${l.feedbackDefault.join(",")}, ${N*Rc})`;let F;if(b.isFullCircle){F=[];for(let R=0;R<360;R+=E.angle)F.push(R)}else F=[],b.ranges&&Array.isArray(b.ranges)?b.ranges.forEach(R=>{const[B,L]=R,O=ai(E.angle,B,L);F.push(...O)}):b.minAngle!==void 0&&b.maxAngle!==void 0&&(F=ai(E.angle,b.minAngle,b.maxAngle)),F=[...new Set(F)];F.forEach(R=>{if(R=Math.round(R*1e10)/1e10,c==="degrees"){if(C.has(R))return}else if(c==="radians"){const V=`${R}-${E.angle}`;if(w.has(V))return}const B=R*Math.PI/180,L={x:f.x+(m+ni)*Math.cos(B),y:f.y-(m+ni)*Math.sin(B)},O=Lc;if(!(L.x>-O&&L.x<u+O&&L.y>-O&&L.y<g+O))return;let A={textAlign:"center",textBaseline:"middle"};if(c==="radians"&&(A={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=D,e.lineWidth=_n,R%90===0&&R<360){const V={x:f.x+m*Math.cos(B),y:f.y-m*Math.sin(B)};let Y;const X=et*1.5;switch(R){case 0:Y={x:Math.SQRT1_2,y:-Math.SQRT1_2},A={textAlign:"left",textBaseline:"bottom"};break;case 90:Y={x:Math.SQRT1_2,y:-Math.SQRT1_2},A={textAlign:"left",textBaseline:"bottom"};break;case 180:Y={x:-Math.SQRT1_2,y:-Math.SQRT1_2},A={textAlign:"right",textBaseline:"bottom"};break;case 270:Y={x:Math.SQRT1_2,y:Math.SQRT1_2},A={textAlign:"left",textBaseline:"top"};break}const z={x:V.x+Y.x*X,y:V.y+Y.y*X};e.lineWidth=Oc,e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(z.x,z.y),e.stroke(),L.x=z.x,L.y=z.y}else{const V={x:f.x+(m-Be)*Math.cos(B),y:f.y-(m-Be)*Math.sin(B)},Y={x:f.x+(m+Be)*Math.cos(B),y:f.y-(m+Be)*Math.sin(B)};nh(Y,u,g)&&(e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(Y.x,Y.y),e.stroke())}e.restore();let k="";if(c==="degrees"){let V=Math.max(0,(E.angle.toString().split(".")[1]||"").length);E.angle<1&&(V=Math.max(V,Math.ceil(-Math.log10(E.angle))+1));const Y=Math.round(R*Math.pow(10,V))/Math.pow(10,V),X=parseFloat(Y.toFixed(V));k=`${Math.round(X*1e10)/1e10}^{\\circ}`}else if(R===0&&c==="radians")k="0";else if(R!==0)if(E.angle<=5){const Y=R*Math.PI/180,X=Math.max(0,(E.angle.toString().split(".")[1]||"").length),z=Math.max(3,X+2);let G=Y.toFixed(z);G=parseFloat(G).toString(),parseFloat(G)!==0&&(k=G)}else{const Y=R,X=180,z=Va(Y,X),G=Y/z,W=X/z;W===1?G===1?k="\\pi":G===-1?k="-\\pi":k=`${G}\\pi`:G===1?k=`\\frac{\\pi}{${W}}`:G===-1?k=`-\\frac{\\pi}{${W}}`:G<0?k=`-\\frac{${Math.abs(G)}\\pi}{${W}}`:k=`\\frac{${G}\\pi}{${W}}`}if(k){const V=c==="radians"?`circ-label-${R}-${E.angle}-${v.toExponential(15)}`:`circ-label-${R}-${v.toExponential(15)}`;if(n({id:V,content:k,x:L.x,y:L.y,color:D,fontSize:da,options:A}),c==="degrees")C.add(R);else{const Y=`${R}-${E.angle}`;w.set(Y,{levelAngle:E.angle,alpha:N,labelId:V})}}})});const P=l.feedbackDefault;let T=-1/0;const M={x:f.x+m,y:f.y};if(M.x>-20&&M.x<u+mt&&M.y>-20&&M.y<g+mt)T=0;else{const E={x:0,y:0,w:u,h:g},N={x:f.x,y:f.y,r:m},_=ua(N,E);if(_.length>0){let D=-1/0;_.forEach(R=>{const B=Math.atan2(f.y-R.y,R.x-f.x),L=B>=0?B:B+2*Math.PI,O={x:f.x+m*Math.cos(L),y:f.y-m*Math.sin(L)},$=mt;O.x>-$&&O.x<u+$&&O.y>-$&&O.y<g+$&&L>D&&(D=L)}),[{x:0,y:0},{x:E.w,y:0},{x:E.w,y:E.h},{x:0,y:E.h}].forEach(R=>{if(J(R,f)<N.r){const B=Math.atan2(f.y-R.y,R.x-f.x),L=B>=0?B:B+2*Math.PI,O={x:f.x+m*Math.cos(L),y:f.y-m*Math.sin(L)},$=mt;O.x>-$&&O.x<u+$&&O.y>-$&&O.y<g+$&&L>D&&(D=L)}}),D>-1/0&&(T=D)}}if(T>-1/0){const E=T,N={x:f.x+m*Math.cos(E),y:f.y-m*Math.sin(E)},_={x:-Math.sin(E),y:-Math.cos(E)},D={x:Math.cos(E),y:-Math.sin(E)},F={x:N.x-De*_.x+De/2*D.x,y:N.y-De*_.y+De/2*D.y},R={x:N.x-De*_.x-De/2*D.x,y:N.y-De*_.y-De/2*D.y};e.save(),e.fillStyle=`rgba(${P.join(",")}, 1.0)`,e.beginPath(),e.moveTo(N.x,N.y),e.lineTo(F.x,F.y),e.lineTo(R.x,R.y),e.closePath(),e.fill(),e.restore();let B;if(E===0)B={x:N.x-Vi,y:N.y+Xi+De};else{const L={x:-Math.cos(E),y:Math.sin(E)};B={x:N.x+L.x*(Xi+De)+_.x*Vi,y:N.y+L.y*(Xi+De)+_.y*Vi}}n({id:"theta-label-sticky",content:"\\theta",x:B.x,y:B.y,color:`rgba(${P.join(",")}, 1.0)`,fontSize:ss,options:{textAlign:"center",textBaseline:"middle"}})}}function ua(e,t){const{x:n,y:o,r:i}=e,{x:s,y:a,w:r,h:c}=t,l=[],d={center:{x:n,y:o},radius:i},h=(f,u,g,p)=>{Xa({p1:{x:f,y:u},p2:{x:g,y:p}},d).forEach(m=>{const x=g-f,I=p-u;let b;Math.abs(x)>Math.abs(I)?b=(m.x-f)/x:b=(m.y-u)/I,b>=0&&b<=1&&l.push({x:m.x,y:m.y})})};return h(s,a,s+r,a),h(s+r,a,s+r,a+c),h(s+r,a+c,s,a+c),h(s,a+c,s,a),l}function hl(e,t,n,o,i){return!(e+n<0||e-n>o||t+n<0||t-n>i)}function oh(e,t,n,o,i,s,a){const r=`rgba(${a.axisTickLabel.join(",")}, ${Qo})`,c=et*bc;e.save(),e.strokeStyle=r,e.lineWidth=vc,e.setLineDash([]);const l=c,d=l/Math.tan(Ic),h=t.x-d,f=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(h,f),e.stroke(),e.restore(),s({id:"tick-label-origin",content:Fc,x:t.x-et-Fn,y:t.y+et+Fn,color:r,fontSize:os,options:{textAlign:"right",textBaseline:"top"}})}function ih(e,t,{canvas:n,dpr:o,coordsDisplayMode:i,viewTransform:s,angleDisplayMode:a,colors:r},c,l,d,h,f){e.save();const u=n.width/o,g=n.height/o,p=c({x:0,y:0}),y=(x,I,b,v)=>{e.beginPath(),e.moveTo(x,I),e.lineTo(b,v),e.stroke();const C=Math.atan2(v-I,b-x);e.beginPath(),e.moveTo(b,v),e.lineTo(b-De*Math.cos(C-Kt),v-De*Math.sin(C-Kt)),e.lineTo(b-De*Math.cos(C+Kt),v-De*Math.sin(C+Kt)),e.closePath(),e.fill()},S=(x,I,b,v,C)=>{const w=new Map,P=new Map,T=(B,L,O)=>{if(!B||L<Ci)return;const $=l({x:0,y:0}),A=l({x:u,y:g}),k=B*re;{const V=Math.floor($.x/B),Y=Math.ceil(A.x/B),X=Math.floor(A.y/B),z=Math.ceil($.y/B);for(let G=V;G<=Y;G++){const W=G*B;if(Math.abs(W)<k)continue;const Q=w.get(W);Q?O?w.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!0}):Q.isCoarser||w.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!1}):w.set(W,{alpha:L,isCoarser:O})}for(let G=X;G<=z;G++){const W=G*B;if(Math.abs(W)<k)continue;const Q=P.get(W);Q?O?P.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!0}):Q.isCoarser||P.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!1}):P.set(W,{alpha:L,isCoarser:O})}}},M=!b||x>=b;T(x,I,M),T(b,v,!M);let E=!1;const N=B=>{const L=Math.abs(B);(L>=ha||L>0&&L<fa)&&(E=!0)};w.forEach((B,L)=>N(L)),P.forEach((B,L)=>N(L));const _=l({x:0,y:0}),D=l({x:u,y:g});N(_.x),N(_.y),N(D.x),N(D.y);const F=x||b||1,R=F>0?Math.max(0,-Math.floor(Math.log10(F))):0;return w.forEach((B,L)=>{const O=B.isCoarser?1:B.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${Qo*O})`;e.strokeStyle=$,e.lineWidth=_n;{const A=c({x:L,y:0}).x;e.beginPath(),e.moveTo(A,p.y),e.lineTo(A,p.y+et),e.stroke();let k;if(E){const Y=Math.log10(Math.abs(L)),X=Math.floor(Y),z=F/Math.pow(10,X),G=Math.max(0,-Math.floor(Math.log10(z))+1),Q=Math.abs(L).toExponential(G).split("e");let te=Q[0];te=te.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let pe=parseInt(Q[1],10);k=`${L<0?"-":""}${te} \\cdot 10^{${pe}}`}else k=L.toFixed(R).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");f({id:((Y,X)=>`${Y}-${X.toExponential(15)}`)("tick-label-x",L),content:k,x:A,y:p.y+et+Fn,color:$,fontSize:os,options:{textAlign:"center",textBaseline:"top"}})}}),P.forEach((B,L)=>{const O=B.isCoarser?1:B.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${Qo*O})`;e.strokeStyle=$,e.lineWidth=_n;const A=c({x:0,y:L}).y;let k;if(E){const Y=Math.log10(Math.abs(L)),X=Math.floor(Y),z=F/Math.pow(10,X),G=Math.max(0,-Math.floor(Math.log10(z))+1),Q=Math.abs(L).toExponential(G).split("e");let te=Q[0];te=te.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let pe=parseInt(Q[1],10);k=`${L<0?"-":""}${te} \\cdot 10^{${pe}}`}else k=L.toFixed(R).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");i===go&&Math.abs(L)>re&&(k==="1"?k=Go:k==="-1"?k=`-${Go}`:k+=Go),e.beginPath(),e.moveTo(p.x,A),e.lineTo(p.x-et,A),e.stroke(),f({id:((Y,X)=>`${Y}-${X.toExponential(15)}`)("tick-label-y",L),content:k,x:p.x-et-Fn,y:A,color:$,fontSize:os,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:E}};e.lineWidth=Bc,e.strokeStyle=r.axis,e.fillStyle=r.axis;let m={useScientific:!1};if(i===Ti){const{interval1:x,interval2:I,alpha1:b,alpha2:v}=d;rh(e,t,{canvas:n,dpr:o,colors:r},c,f);let C=!1;const w=M=>{const E=Math.abs(M);(E>=ha||E>0&&E<fa)&&(C=!0)},P=l({x:0,y:0}),T=l({x:u,y:g});w(P.x),w(P.y),w(T.x),w(T.y),ah(e,t,{canvas:n,dpr:o,colors:r},c,l,d,f,C),sh(e,t,f,0,0,{canvas:n,dpr:o,viewTransform:s,angleDisplayMode:a,colors:r},c,h),m={useScientific:C}}else{p.y>0&&p.y<g&&y(0,p.y,u,p.y),p.x>0&&p.x<u&&y(p.x,g,p.x,0);let x="x",I="y";i===go&&(x=$c,I=Vc),f({id:"axis-label-x",content:x,x:u-De-sa,y:p.y-na,color:r.axis,fontSize:ss,options:{textAlign:"center",textBaseline:"bottom"}}),f({id:"axis-label-y",content:I,x:p.x+oa,y:De+ia,color:r.axis,fontSize:ss,options:{textAlign:"left",textBaseline:"middle"}}),m=S(d.interval1,d.alpha1,d.interval2,d.alpha2)}return oh(e,p,u,g,i,f,r),e.restore(),m}function ah(e,t,{canvas:n,dpr:o,colors:i},s,a,r,c,l){const d=n.width/o,h=n.height/o,f=s({x:0,y:0}),u=f.y>-20&&f.y<h+mt,g=f.x>-20&&f.x<d+mt;if(!u&&!g)return;const{interval1:p,interval2:y,alpha1:S,alpha2:m}=r,x=new Map,I=p||y||1,b=I>0?Math.max(0,-Math.floor(Math.log10(I))):0,v=(w,P,T)=>{if(!w||P<Ci)return;let M=0;if(u){const F=a({x:0,y:f.y}),R=a({x:d,y:f.y});M=Math.max(M,Math.abs(F.x),Math.abs(R.x))}if(g){const F=a({x:f.x,y:0}),R=a({x:f.x,y:h});M=Math.max(M,Math.abs(F.y),Math.abs(R.y))}M*=1.1;const E=1,N=Math.ceil(M/w),D=Math.min(N,E+1e3);for(let F=E;F<=D;F++){const R=F*w;let B=!1;if(u){const L=s({x:R,y:0}).x,O=s({x:-R,y:0}).x;(L>=-20&&L<=d+mt||O>=-20&&O<=d+mt)&&(B=!0)}if(!B&&g){const L=s({x:0,y:R}).y,O=s({x:0,y:-R}).y;(L>=-20&&L<=h+mt||O>=-20&&O<=h+mt)&&(B=!0)}if(B){const L=x.get(R);L?T?x.set(R,{alpha:Math.max(L.alpha,P),isCoarser:!0}):L.isCoarser||x.set(R,{alpha:Math.max(L.alpha,P),isCoarser:!1}):x.set(R,{alpha:P,isCoarser:T})}}},C=!y||p>=y;v(p,S,C),v(y,m,!C),x.forEach((w,P)=>{const T=w.isCoarser?1:w.alpha,M=`rgba(${i.axisTickLabel.join(",")}, ${Qo*T})`;e.strokeStyle=M,e.lineWidth=_n;let E;if(l){const _=Math.log10(Math.abs(P)),D=Math.floor(_),F=I/Math.pow(10,D),R=Math.max(0,-Math.floor(Math.log10(F))+1),L=Math.abs(P).toExponential(R).split("e");let O=L[0];O=O.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let $=parseInt(L[1],10);E=`${P<0?"-":""}${O} \\cdot 10^{${$}}`}else E=P.toFixed(b).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const N=P.toExponential(15);if(u){const _=s({x:P,y:0});_.x>-20&&_.x<d+mt&&(e.beginPath(),e.moveTo(_.x,f.y-et/2),e.lineTo(_.x,f.y+et/2),e.stroke(),c({id:`polartick-r-x-${N}`,content:E,x:_.x,y:f.y+et+Fn,color:M,fontSize:os,options:{textAlign:"center",textBaseline:"top"}}));const D=s({x:-P,y:0});D.x>-20&&D.x<d+mt&&(e.beginPath(),e.moveTo(D.x,f.y-et/2),e.lineTo(D.x,f.y+et/2),e.stroke(),c({id:`polartick-r-negx-${N}`,content:E,x:D.x,y:f.y+et+Fn,color:M,fontSize:os,options:{textAlign:"center",textBaseline:"top"}}))}if(g){const _=s({x:0,y:P});_.y>-20&&_.y<h+mt&&(e.beginPath(),e.moveTo(f.x-et/2,_.y),e.lineTo(f.x+et/2,_.y),e.stroke(),c({id:`polartick-r-posy-${N}`,content:E,x:f.x-et-Fn,y:_.y,color:M,fontSize:os,options:{textAlign:"right",textBaseline:"middle"}}));const D=s({x:0,y:-P});D.y>-20&&D.y<h+mt&&(e.beginPath(),e.moveTo(f.x-et/2,D.y),e.lineTo(f.x+et/2,D.y),e.stroke(),c({id:`polartick-r-negy-${N}`,content:E,x:f.x-et-Fn,y:D.y,color:M,fontSize:os,options:{textAlign:"right",textBaseline:"middle"}}))}})}function rh(e,t,{canvas:n,dpr:o,colors:i},s,a){const r=n.width/o,c=n.height/o,l=s({x:0,y:0}),d=(p,y,S,m)=>{e.beginPath(),e.moveTo(p,y),e.lineTo(S,m),e.stroke();const x=Math.atan2(m-y,S-p);e.beginPath(),e.moveTo(S,m),e.lineTo(S-De*Math.cos(x-Kt),m-De*Math.sin(x-Kt)),e.lineTo(S-De*Math.cos(x+Kt),m-De*Math.sin(x+Kt)),e.closePath(),e.fill()};e.lineWidth=_n;const h=r>l.x,f=0<l.x,u=0<l.y,g=c>l.y;h&&(d(l.x,l.y,r,l.y),a({id:"axis-label-r-posx",content:Bo,x:r-De-sa,y:l.y-na,color:i.axis,fontSize:ss,options:{textAlign:"center",textBaseline:"bottom"}})),f&&(d(l.x,l.y,0,l.y),a({id:"axis-label-r-negx",content:Bo,x:De+sa,y:l.y-na,color:i.axis,fontSize:ss,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(d(l.x,l.y,l.x,0),a({id:"axis-label-r-posy",content:Bo,x:l.x+oa,y:De+ia,color:i.axis,fontSize:ss,options:{textAlign:"left",textBaseline:"middle"}})),g&&(d(l.x,l.y,l.x,c),a({id:"axis-label-r-negy",content:Bo,x:l.x+oa,y:c-De-ia,color:i.axis,fontSize:ss,options:{textAlign:"left",textBaseline:"middle"}}))}function lh(e,{canvas:t,dpr:n,colors:o,gridAlpha:i},s,a,r,c,l){const d=t.width/n,h=t.height/n,f=Math.min(d,h)*Sc;let u,g;if(s.x>=0&&s.x<=d&&s.y>=0&&s.y<=h)u=0;else{const M=[$o(s.x,s.y,0,0,d,0),$o(s.x,s.y,d,0,d,h),$o(s.x,s.y,d,h,0,h),$o(s.x,s.y,0,h,0,0)];u=Math.min(...M)}const y=[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(M=>Math.sqrt((M.x-s.x)**2+(M.y-s.y)**2));g=Math.max(...y);const S=u*n/r.scale,m=g*n/r.scale,x=(M,E)=>{if(!M||E<Ci||M*r.scale/n<hd)return;e.strokeStyle=`rgba(${o.grid.join(",")}, ${E*i})`,e.lineWidth=_n;const _=S===0?1:Math.ceil(S/M),D=Math.floor(m/M);for(let F=_;F<=D;F++){const B=F*M*r.scale/n;if(B>f){const L=[],O={center:{x:s.x,y:s.y},radius:B};if([{p1:{x:0,y:0},p2:{x:d,y:0}},{p1:{x:d,y:0},p2:{x:d,y:h}},{p1:{x:d,y:h},p2:{x:0,y:h}},{p1:{x:0,y:h},p2:{x:0,y:0}}].forEach(A=>{Xa(A,O).forEach(V=>{V.x>=0&&V.x<=d&&V.y>=0&&V.y<=h&&L.push(V)})}),L.length>=2){let A=L[0],k=L[1],V=0;for(let Y=0;Y<L.length;Y++)for(let X=Y+1;X<L.length;X++){const z=(L[Y].x-L[X].x)**2+(L[Y].y-L[X].y)**2;z>V&&(V=z,A=L[Y],k=L[X])}e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(k.x,k.y),e.stroke()}}else e.beginPath(),e.arc(s.x,s.y,B,0,$e),e.stroke()}};if(x(c.interval1,c.alpha1),x(c.interval2,c.alpha2),!l||!Array.isArray(l))return;const I={x:d/2,y:h/2},b=Math.min(d,h)/4,v=Math.sqrt((s.x-I.x)**2+(s.y-I.y)**2),C=b+v;if(C<nl||!hl(s.x,s.y,C,d,h))return;const w=C>f;let P=null;if(w){const M={x:0,y:0,w:d,h},E={x:s.x,y:s.y,r:C},N=ua(E,M);if(N.length>=2){let _=N[0],D=N[1],F=0;for(let L=0;L<N.length;L++)for(let O=L+1;O<N.length;O++){const $=(N[L].x-N[O].x)**2+(N[L].y-N[O].y)**2;$>F&&(F=$,_=N[L],D=N[O])}const R=(Math.atan2(s.y-_.y,_.x-s.x)*180/Math.PI+360)%360,B=(Math.atan2(s.y-D.y,D.x-s.x)*180/Math.PI+360)%360;P={minAngle:Math.min(R,B),maxAngle:Math.max(R,B),isFullCircle:!1},Math.abs(R-B)>180&&(P={minAngle:Math.max(R,B),maxAngle:Math.min(R,B)+360,isFullCircle:!1})}}else P=cl(s,C,d,h);if(!P)return;const T=new Set;l.forEach(M=>{const E=M.alpha;if(E<Kr||C*(M.angle*Math.PI/180)<sl*.5)return;e.strokeStyle=`rgba(${o.grid.join(",")}, ${E*i})`,e.lineWidth=_n*Nc;let _;if(P.isFullCircle){_=[];for(let D=0;D<360;D+=M.angle)_.push(D)}else{if(_=[],P.ranges&&Array.isArray(P.ranges))P.ranges.forEach(D=>{let[F,R]=D;if(w){const $=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(V=>(Math.atan2(s.y-V.y,V.x-s.x)*180/Math.PI+360)%360),F,R].sort((V,Y)=>V-Y),A=Math.min(...$)-M.angle*2,k=Math.max(...$)+M.angle*2;F=A,R=k}const B=ai(M.angle,F,R);_.push(...B)});else if(P.minAngle!==void 0&&P.maxAngle!==void 0){let D=P.minAngle,F=P.maxAngle;if(w){const L=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(A=>(Math.atan2(s.y-A.y,A.x-s.x)*180/Math.PI+360)%360),D,F].sort((A,k)=>A-k),O=Math.min(...L)-M.angle*2,$=Math.max(...L)+M.angle*2;D=O,F=$}_=ai(M.angle,D,F)}_=[...new Set(_)]}_.forEach(D=>{if(D=Math.round(D*1e10)/1e10,T.has(D))return;const F=D*Math.PI/180,R={x:s.x+S*r.scale/n*Math.cos(F),y:s.y-S*r.scale/n*Math.sin(F)},B={x:s.x+m*r.scale/n*Math.cos(F),y:s.y-m*r.scale/n*Math.sin(F)};e.beginPath(),e.moveTo(R.x,R.y),e.lineTo(B.x,B.y),e.stroke(),T.add(D)})})}function ch(e,{gridDisplayMode:t,canvas:n,dpr:o,viewTransform:i,gridAlpha:s,colors:a},r,c,l,d){if(t===Mo)return;e.save();const h=r({x:0,y:0}),f=n.width/o,u=n.height/o;if(t===$a){const g=c({x:0,y:0}),p=c({x:f,y:u}),y=Math.hypot(Math.max(Math.abs(g.x),Math.abs(p.x)),Math.max(Math.abs(g.y),Math.abs(p.y)));lh(e,{canvas:n,dpr:o,colors:a,gridAlpha:s},h,y,i,l,d)}else{const g=(p,y)=>{if(!p||y<Ci)return;const S=`rgba(${a.grid.join(",")}, ${y*s})`,m=c({x:0,y:u}),x=c({x:f,y:0}),I=Math.floor(m.x/p),b=Math.ceil(x.x/p),v=Math.floor(m.y/p),C=Math.ceil(x.y/p);if(t===Na){e.strokeStyle=S,e.lineWidth=_n;for(let w=I;w<=b;w++){const P=w*p,T=r({x:P,y:0}).x;e.beginPath(),e.moveTo(T,0),e.lineTo(T,u),e.stroke()}for(let w=v;w<=C;w++){const P=w*p,T=r({x:0,y:P}).y;e.beginPath(),e.moveTo(0,T),e.lineTo(f,T),e.stroke()}}else if(t===Ba){e.fillStyle=S;const w=Er*o;for(let P=I;P<=b;P++){const T=P*p;for(let M=v;M<=C;M++){const E=M*p,N=r({x:T,y:E});e.beginPath(),e.arc(N.x,N.y,w,0,$e),e.fill()}}}else if(t===Fa){e.fillStyle=S;const w=Er*o,P=p*wa,T=Math.floor(m.y/P),M=Math.ceil(x.y/P);for(let E=T;E<=M;E++){const N=E*P,D=E%2!==0?p/2:0;for(let F=I;F<=b;F++){const B=F*p+D,L=r({x:B,y:N});e.beginPath(),e.arc(L.x,L.y,w,0,$e),e.fill()}}}};g(l.interval1,l.alpha1),g(l.interval2,l.alpha2)}e.restore()}function za(e,t,n,o,i,s,a=!1){e.save(),e.strokeStyle=s,e.lineWidth=_n,e.setLineDash(a?Ur:[]);const r=-n,c=-o;let l=nt(o-n);e.beginPath(),e.arc(t.x,t.y,i,r,c,l>0),e.stroke(),e.restore()}function fl(e,{info:t,colors:n,idPrefix:o,startVertexScreen:i},s,a,r){if(!t||!t.edge)return;const{edge:c,fraction:l,snapPoint:d}=t,h=a(c.id1),f=a(c.id2);if(!h||!f)return;const u=s(h),g=s(f),p=s(d),y=n.feedbackSnapped,S=kd({x:-(g.y-u.y),y:g.x-u.x});let m=1;i&&(m=(g.x-u.x)*(i.y-u.y)-(g.y-u.y)*(i.x-u.x)>0?-1:1);const x=io,I={x:(u.x+p.x)/2,y:(u.y+p.y)/2},b={x:I.x+m*S.x*x,y:I.y+m*S.y*x},v=Jt(l,.001,8);r({id:`${o}-1`,content:v,x:b.x,y:b.y,color:y,fontSize:ea,options:{textAlign:"center",textBaseline:"middle"}});const C={x:(p.x+g.x)/2,y:(p.y+g.y)/2},w={x:C.x+m*S.x*x,y:C.y+m*S.y*x},P=Jt(1-l,.001,8);r({id:`${o}-2`,content:P,x:w.x,y:w.y,color:y,fontSize:ea,options:{textAlign:"center",textBaseline:"middle"}})}function dh(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:o,isDragConfirmed:i,dragPreviewVertices:s,colors:a,edgesVisible:r,snappedEdgeIds:c,currentAltPressed:l,interpolationStyle:d,getInterpolationStyleById:h,edgeColorMode:f="fixed",edgeColorExpression:u="x"},g,p,y){e.lineWidth=ns;const S=ct(a.defaultStroke,{r:255,g:255,b:255,a:1}),m=I=>{const b=I?.color||a.vertex||a.defaultStroke;return ct(b,S)},x=(I,b,v,C)=>{if(f==="inherit_vertices"&&v&&C){const w=m(v),P=m(C);return{r:St(w.r,P.r,b),g:St(w.g,P.g,b),b:St(w.b,P.b,b),a:St(w.a,P.a,b)}}if(f==="colormap"&&I.colormapItem){const w=$s(u,{x:b},b),P=Vs(w),T=Ae(I.colormapItem,P);return ct(T,S)}return ct(I.color||a.defaultStroke,S)};t.forEach(I=>{const b=p(I.id1),v=p(I.id2);if(!b||!v||b.type!==An||v.type!==An)return;const C=y(I),w=n.includes(C),P=c&&c.has(C)&&c.get(C).some(B=>B.copyIndex===void 0||B.copyIndex===0),T=!l&&C===o;if(!r&&!w&&!P&&!T)return;let M=b,E=v;const N=I.interpolationStyleId&&h?h(I.interpolationStyleId):d,D=(N?qs([M,E],N,!1,g):[M,E]).map(B=>g(B));if(D.length<2)return;const F=D[0],R=D[D.length-1];e.beginPath(),e.moveTo(D[0].x,D[0].y);for(let B=1;B<D.length;B++)e.lineTo(D[B].x,D[B].y);if(f==="colormap"||f==="inherit_vertices"){let B=0;for(let O=1;O<D.length;O++)B+=Math.hypot(D[O].x-D[O-1].x,D[O].y-D[O-1].y);let L=0;for(let O=1;O<D.length;O++){const $=D[O-1],A=D[O],k=Math.hypot(A.x-$.x,A.y-$.y),V=B>0?L/B:0,Y=B>0?(L+k)/B:1,X=(V+Y)/2,z=x(I,X,M,E);e.strokeStyle=`rgba(${Math.round(z.r)},${Math.round(z.g)},${Math.round(z.b)},${z.a})`,e.beginPath(),e.moveTo($.x,$.y),e.lineTo(A.x,A.y),e.setLineDash([]),e.lineWidth=ns,e.stroke(),L+=k}}else if(I.colormapItem){const B=e.createLinearGradient(F.x,F.y,R.x,R.y),L=Ae(I.colormapItem,I.gradientStart),O=Ae(I.colormapItem,I.gradientEnd);B.addColorStop(0,L),B.addColorStop(1,O),e.strokeStyle=B,e.setLineDash([]),e.lineWidth=ns,e.stroke()}else e.strokeStyle=I.color||a.defaultStroke,e.setLineDash([]),e.lineWidth=ns,e.stroke();if(w||P||T){e.save(),e.strokeStyle=P?a.feedbackSnapped:a.selectionGlow,e.globalAlpha=ps,e.lineWidth=Gn,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(D[0].x,D[0].y);for(let B=1;B<D.length;B++)e.lineTo(D[B].x,D[B].y);e.stroke(),e.restore()}}),e.setLineDash([]),e.strokeStyle=a.defaultStroke,e.globalAlpha=1}function ri(e,t,n,o,i){const{selectedVertexIds:s,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,snappedVertexIds:h,isDragConfirmed:f,dragPreviewVertices:u,currentAltPressed:g}=n;let p=t,y=!1,S=null,m;if(f&&u){const v=u.find(C=>C&&(C.id===t.id||C.originalId===t.id));v&&(p=v,m=v.transformIndex)}if(h&&p.originalId&&h.has(p.originalId)){const C=h.get(p.originalId).find(w=>w.copyIndex===m);C&&(y=!0,S=C.type)}else if(h&&!p.originalId&&h.has(p.id)){const C=h.get(p.id).find(w=>w.copyIndex===m);C&&(y=!0,S=C.type)}let x;if(p.type===An){if(x=s.includes(p.id),!l&&!x&&!d&&!y&&!(g&&d))return}else x=a.includes(p.id);const I=o(p);switch(p.type){case An:e.beginPath(),e.arc(I.x,I.y,Be,0,$e),e.fillStyle=p.color||c.vertex,e.fill();break;case Qt:case On:case an:case Zn:const v=Mi*2,C={type:p.type,x:I.x-v/2,y:I.y-v/2,width:v,height:v};Di(e,C,c);break}const b={...n,isSnapped:y,snapType:S};Ha(e,p,b,o)}function hh(e,{altHoverInfo:t,colors:n},o,i,s){if(!t)return;const{point:a,element:r,shiftKey:c,fraction:l}=t,d=o(a),h=n.feedbackSnapped,f=n.feedbackSnapped;e.save(),e.shadowColor=f,e.shadowBlur=ka,e.globalAlpha=ps,e.beginPath();const u=Be+ii;e.arc(d.x,d.y,u,0,$e),e.strokeStyle=f,e.lineWidth=Gn,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(d.x,d.y,Be,0,$e),e.fillStyle=h,e.fill(),e.restore(),r.type==="edge"&&c&&fh(e,{info:{edge:r.edge,fraction:l,snapPoint:a},colors:n},o,i,s)}function fh(e,{info:t,colors:n},o,i,s){fl(e,{info:t,colors:n,idPrefix:"alt-snap-label"},o,i,s)}function uh(e,{info:t,colors:n},o,i,s){if(!t||!t.startVertex)return;const a=o(t.startVertex);fl(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:a},o,i,s)}function ph(e,{transformIndicatorData:t,colors:n,currentShiftPressed:o},i){const{center:s,startPos:a,currentPos:r,rotation:c,isSnapping:l,snapType:d}=t,h=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(s),u=i(a),g=i(r);if(e.save(),e.lineWidth=Zt,e.strokeStyle=h,e.setLineDash(En),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!o||o&&d==="projection"){const y=ze(a,s,c,1),S=i(y);e.beginPath(),e.moveTo(S.x,S.y),e.lineTo(g.x,g.y),e.stroke()}if(Math.abs(c)>Pa){e.setLineDash([]);const y=J(f,u),S=Math.atan2(u.y-f.y,u.x-f.x),m=-c,x=c>0;e.beginPath(),e.arc(f.x,f.y,y,S,S+m,x),e.stroke()}e.restore()}function gh(e,{transformIndicatorData:t,colors:n,currentShiftPressed:o},i){const{center:s,startPos:a,scale:r,isSnapping:c,snapType:l,currentPos:d}=t,h=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(s),u=i(a),g=i(d);if(e.save(),e.lineWidth=Zt,e.strokeStyle=h,e.setLineDash(En),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!o){const m=J(f,g),x=Math.atan2(u.y-f.y,u.x-f.x),I=Math.atan2(g.y-f.y,g.x-f.x);let b=I-x;b>Math.PI?b-=2*Math.PI:b<-Math.PI&&(b+=2*Math.PI);const v=b<0;e.beginPath(),e.arc(f.x,f.y,m,x,I,v),e.stroke()}const y={x:s.x+(a.x-s.x)*r,y:s.y+(a.y-s.y)*r},S=i(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(S.x,S.y),e.stroke(),e.restore()}function yh(e,{transformIndicatorData:t,colors:n,currentShiftPressed:o},i){const{center:s,startPos:a,currentPos:r,scale:c,startVector:l,isSnapping:d,snapType:h,projectionSource:f}=t,u=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,g=i(s),p=i(a),y=i(r);e.save(),e.lineWidth=Zt,e.strokeStyle=u,e.setLineDash(En),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(p.x,p.y),e.stroke();const S=ze(a,s,0,c,!0,l),m=i(S);if((!o||o&&h==="projection")&&(e.setLineDash(En),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(m.x,m.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(m.x,m.y),e.stroke(),d&&h==="projection"&&f){const I=i(f),b=s,v={x:s.x+l.x,y:s.y+l.y},C=ol(f,b,v),w=i(C);e.setLineDash(En),e.beginPath(),e.moveTo(I.x,I.y),e.lineTo(w.x,w.y),e.stroke()}e.restore()}function mh(e,{transformIndicatorData:t,colors:n},o){const{center:i,startPos:s,rotation:a,scale:r,isSnapping:c}=t,l=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,d=o(i),h=o(s);e.save(),e.lineWidth=Zt,e.strokeStyle=l,e.setLineDash(En),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(h.x,h.y),e.stroke();const f={x:i.x+(s.x-i.x)*r,y:i.y+(s.y-i.y)*r},u=o(f);if(e.setLineDash([]),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(a)>Pa){const g=J(d,u),p=Math.atan2(h.y-d.y,h.x-d.x),y=-a,S=a>0;e.beginPath(),e.arc(d.x,d.y,g,p,p+y,S),e.stroke()}e.restore()}function xh(e,t,{transformIndicatorData:n,colors:o,coordSystemTransformIndicatorData:i,currentShiftPressed:s},a,r){if(n){const{isSnapping:c,snapType:l,transformType:d}=n;switch(e.save(),e.lineWidth=Zt,d){case an:mh(e,{transformIndicatorData:n,colors:o},a);break;case Qt:ph(e,{transformIndicatorData:n,colors:o,currentShiftPressed:s},a);break;case On:gh(e,{transformIndicatorData:n,colors:o,currentShiftPressed:s},a);break;case Zn:yh(e,{transformIndicatorData:n,colors:o,currentShiftPressed:s},a);break}c&&l==="projection"&&s&&Sh(e,{transformIndicatorData:n,colors:o},a),e.restore(),Ih(t,{transformIndicatorData:n,colors:o},a,r)}i&&bh(t,{coordSystemTransformIndicatorData:i,colors:o},a,r)}function Sh(e,{transformIndicatorData:t,colors:n},o){const{transformType:i,projectionSource:s,projectionCenter:a,projectionPoint:r,currentPos:c}=t;if(i!==an){if(e.setLineDash(En),e.strokeStyle=n.feedbackSnapped,i===Qt&&r){const l=o(c),d=o(r),h=o(s);e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(d.x,d.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(d.x,d.y),e.stroke()}else if(i===On&&a){const l=o(a),d=o(s),h=o(c),f=J(l,d);let u=Math.atan2(d.y-l.y,d.x-l.x),g=Math.atan2(h.y-l.y,h.x-l.x);const p=2*Math.PI;u=(u+p)%p,g=(g+p)%p;const y=(g-u+p)%p,m=(u-g+p)%p<y;e.beginPath(),e.arc(l.x,l.y,f,u,g,m),e.stroke()}}}function Ih(e,{transformIndicatorData:t,colors:n},o,i){const{center:s,startPos:a,rotation:r,scale:c,isSnapping:l,snapType:d,snappedScaleValue:h,transformType:f}=t,u=o(s),g=o(a),p=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(f===On||f===an||f===Zn){let y;const S=h!==null?h:c;d==="projection"||d==="merge"&&f===an?y=`\\times ${parseFloat(S.toFixed(Gi)).toString()}`:l&&h!==null?y=`\\times ${Jt(h,as,sd)}`:y=`\\times ${parseFloat(S.toFixed(Gi)).toString()}`;const x=(u.x+g.x)/2,I=(u.y+g.y)/2,b=Math.atan2(g.y-u.y,g.x-u.x),v=b-Math.PI/2,C=x+Math.cos(v)*br,w=I+Math.sin(v)*br;let P=b*(180/Math.PI);(P>90||P<-90)&&(P+=180),i({id:"transform-scale-indicator",content:y,x:C,y:w,color:p,fontSize:sn,options:{textAlign:"center",textBaseline:"bottom",rotation:P}})}else i({id:"transform-scale-indicator",content:"",x:0,y:0,color:p,fontSize:sn,options:{}});if((f===Qt||f===an)&&Math.abs(r)>Pa){const y=r*(180/Math.PI),S=`${parseFloat(y.toFixed(Gi)).toString()}^{\\circ}`,m={x:g.x-u.x,y:g.y-u.y},x=Math.atan2(m.y,m.x)+-r/2,b=Math.hypot(m.x,m.y)+nd,v=u.x+b*Math.cos(x),C=u.y+b*Math.sin(x);let w=x*(180/Math.PI);(w>90||w<-90)&&(w+=180),i({id:"transform-angle-indicator",content:S,x:v,y:C,color:p,fontSize:sn,options:{rotation:w}})}else i({id:"transform-angle-indicator",content:"",x:0,y:0,color:p,fontSize:sn,options:{}})}function bh(e,{coordSystemTransformIndicatorData:t,colors:n},o,i){const{edgeFraction:s,orthogonalDistanceFraction:a,v1:r,v2:c,snapPosition:l}=t;let d="",h={x:0,y:0};if(a!==void 0){d=Jt(a,.001,8);const f=o(l.origin),u=o(l.closest),g=(f.x+u.x)/2,p=(f.y+u.y)/2,y=Math.atan2(u.y-f.y,u.x-f.x);h.x=g+Math.cos(y+Math.PI/2)*io,h.y=p+Math.sin(y+Math.PI/2)*io}else if(s!==void 0){const f=o(r),u=o(c),g=o(l),p=Math.atan2(u.y-f.y,u.x-f.x),y=Math.cos(p+Math.PI/2)*io,S=Math.sin(p+Math.PI/2)*io;h.x=g.x+y,h.y=g.y+S,d=Jt(s,.001,8)}d&&i({id:"coord-system-edge-fraction",content:d,x:h.x,y:h.y,color:n.feedbackSnapped,fontSize:ea,options:{textAlign:"center",textBaseline:"middle"}})}function vh(e,t,n,o,{showAngles:i,showDistances:s,viewTransform:a,mousePos:r,colors:c}){if(!i&&!s||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,d=o(r);if(J(l,d)<re)return;const f=c.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,g=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const p=n(l),y=g+u;if(e.save(),e.lineWidth=Zt,e.strokeStyle=f,i&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>re){const S=Ws+e.lineWidth/2,m={x:l.x+Math.cos(g)*(S/a.scale),y:l.y+Math.sin(g)*(S/a.scale)},x=n(m);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(x.x,x.y),e.setLineDash(Cc),e.stroke(),za(e,p,g,y,Ws,f,!1)}e.restore()}function ul(e,t,n,o,i,{showDistances:s,showAngles:a,currentShiftPressed:r,distanceSigFigs:c,angleSigFigs:l,angleDisplayMode:d,viewTransform:h,frozenReference_D_du:f,gridDisplayMode:u,frozenReference_A_rad:g,colors:p,lastGridState:y},S,m,x){if(!a&&!s||i.distance<re){x({id:"snap-dist",content:"",x:0,y:0}),x({id:"snap-angle",content:"",x:0,y:0});return}const I=S(n),{angle:b,distance:v,lengthSnapFactor:C,angleSnapFactor:w,angleTurn:P,gridToGridSquaredSum:T,gridInterval:M,snapType:E}=i,{offsetAngleRad:N,isFirstSegmentBeingDrawn:_,currentSegmentReferenceD:D}=m,F=i.snapped||r?p.feedbackSnapped:p.geometryInfoText,R=Math.atan2(o.y-n.y,o.x-n.x);if(v*h.scale/window.devicePixelRatio<tl){x({id:"snap-dist",content:"",x:0,y:0}),x({id:"snap-angle",content:"",x:0,y:0});return}const B=a&&v>re&&(_||Math.abs(P)>re);if(s){let L="",O=i.gridInterval||null;if(!O&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&(O=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),r&&i.snapped)if(_)if(E==="grid"&&T!==null&&O)if(T===0)L="0";else{const[$,A]=ds(T),k=O*$,V=parseFloat(k.toFixed(10));L=hs(V,A)}else if(E==="geometric"&&C!==null){const $=C*D;L=Jt($,as,Rs),(L===$.toFixed(2)||L===String(Math.round($)))&&(L=lt($,c))}else if(E==="vertex"||E==="edge_fraction"||E==="edge"){let $=!1;if(O){const A=i.x-n.x,k=i.y-n.y,V=A/O,Y=k/O;if(Math.abs(V-Math.round(V))<1e-5&&Math.abs(Y-Math.round(Y))<1e-5){const X=Math.round(V),z=Math.round(Y),G=X*X+z*z;if(G===0)L="0";else{const[W,Q]=ds(G),te=O*W,pe=parseFloat(te.toFixed(10));L=hs(pe,Q)}$=!0}}$||(L=lt(v,c))}else L=lt(v,c);else if(E==="geometric"&&C!==null)L=As(C,"D");else if(E==="grid"&&T!==null&&O&&f!==null&&f>re){const A=O*Math.sqrt(T)/f;let k=!1;for(const V of Vn)if(Math.abs(A-V)<re){L=As(V,"D"),k=!0;break}if(!k)if(T===0)L="0";else{const[V,Y]=ds(T),X=O*V,z=parseFloat(X.toFixed(10));L=hs(z,Y)}}else if(E==="vertex"||E==="edge_fraction"||E==="edge")if(f!==null&&f>re){const $=v/f;let A=!1;for(const k of Vn)if(Math.abs($-k)<re){L=As(k,"D"),A=!0;break}A||(L=lt(v,c))}else L=lt(v,c);else L=lt(v,c);else if(!_&&f!==null&&f>re){const $=v/f;let A=!1;for(const k of Vn)if(Math.abs($-k)<re){L=As(k,"D"),A=!0;break}A||(L=lt(v,c))}else L=lt(v,c);if(L){const $=S(n),A=S(o),k=Math.atan2(A.y-$.y,A.x-$.x),V=($.x+A.x)/2,Y=($.y+A.y)/2;let X;if(B){const Q=_?-R:-P;Q<0&&Q>-Math.PI||Q>Math.PI?X=k-Math.PI/2:X=k+Math.PI/2}else X=k-Math.PI/2,Math.sin(X)>0&&(X+=Math.PI);const z=V+Math.cos(X)*$n,G=Y+Math.sin(X)*$n;let W=k*(ro/Math.PI);(W>jr||W<-90)&&(W+=ro),x({id:"snap-dist",content:L,x:z,y:G,color:F,fontSize:sn,options:{rotation:W}},t)}else x({id:"snap-dist",content:"",x:0,y:0})}else x({id:"snap-dist",content:"",x:0,y:0});if(B){const L=_?0:N;za(e,I,L,R,Ws,F),e.save(),e.beginPath();const O=Ws+e.lineWidth/2,$={x:n.x+O/h.scale*Math.cos(L),y:n.y+O/h.scale*Math.sin(L)},A=S($);e.moveTo(I.x,I.y),e.lineTo(A.x,A.y),e.strokeStyle=F,e.setLineDash(Mc),e.lineWidth=Zt,e.stroke(),e.restore();let k="";const V=!_&&g!==null&&Math.abs(g)>re,Y=m.currentSegmentReferenceA_for_display,X=_?R:P;if(d===gs){let z=nt(X)*(180/Math.PI);r&&!_&&i.snapped&&E==="geometric"&&w!==null||r&&V&&w!==null&&i.snapped&&E!=="geometric"?k=As(w,"A"):Math.abs(z)>oi&&(k=`${lt(z,l)}^{\\circ}`)}else if(d===Co){let z=nt(X);if(r&&!_&&i.snapped&&E==="geometric"&&w!==null&&Y){const G=Jt(w*(Y/Math.PI),as,Rs);G==="0"?k="0":G==="1"?k=Et:G==="-1"?k=`-${Et}`:k=`${G}${Et}`}else if(r&&V&&w!==null&&i.snapped&&E!=="geometric"&&Y){const G=Jt(w*(Y/Math.PI),as,Rs);G==="0"?k="0":G==="1"?k=Et:G==="-1"?k=`-${Et}`:k=`${G}${Et}`}else if(Math.abs(z)>oi){const G=Jt(z/Math.PI,as,Rs);G!==z.toFixed(2)?G==="0"?k="0":G==="1"?k=Et:G==="-1"?k=`-${Et}`:k=`${G}${Et}`:k=lt(z,l)}}if(k){const z=-L,G=-R,W=Math.cos(z)+Math.cos(G),Q=Math.sin(z)+Math.sin(G),te=Math.atan2(Q,W),pe=si;let me=te*(180/Math.PI);const vt={x:pe*Math.cos(te),y:pe*Math.sin(te)},Qe={x:I.x+vt.x,y:I.y+vt.y};(me>90||me<-90)&&(me+=180),x({id:"snap-angle",content:k,x:Qe.x,y:Qe.y,color:F,fontSize:sn,options:{rotation:me}},t)}else x({id:"snap-angle",content:"",x:0,y:0})}else x({id:"snap-angle",content:"",x:0,y:0})}function Mh(e,t,{showAngles:n,showDistances:o,viewTransform:i,mousePos:s,frozenReference_D_du:a,distanceSigFigs:r,angleSigFigs:c,angleDisplayMode:l,colors:d},h,f,u){const g=tl/i.scale;let p=-1;if(t.frozen_Origin_Data_to_display){const M=t.frozen_Origin_Data_to_display,E=h(s);p=J(M,E)}if(!n&&!o||!t.frozen_Origin_Data_to_display||p<g)return;const y=d.frozenReference,S=t.frozen_Origin_Data_to_display,m=t.displayAngleA_valueRad_for_A_equals_label,x=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,I=t.frozen_D_du_to_display,b=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,v=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!S)return;const C=x+m,w={x:S.x+I*Math.cos(C),y:S.y+I*Math.sin(C)},P=f(S),T=f(w);if(o&&I!==null&&I>g){let M="";if(b!==null&&b>0&&v){const[L,O]=ds(b),$=v*L,A=parseFloat($.toFixed(10));M=`${Mr}${hs(A,O)}`}else{const L=I/aa;M=`${Mr}${lt(L,r)}`}const E=Math.atan2(T.y-P.y,T.x-P.x),N=(P.x+T.x)/2,_=(P.y+T.y)/2;let D=E*(ro/Math.PI);(D>jr||D<-90)&&(D+=ro);let F;m!==null&&Math.abs(m)>re?-m<0?F=E-Math.PI/2:F=E+Math.PI/2:(F=E-Math.PI/2,Math.sin(F)>0&&(F+=Math.PI));const R=N+Math.cos(F)*ni,B=_+Math.sin(F)*ni;u({id:"ref-dist",content:M,x:R,y:B,color:y,fontSize:da,options:{rotation:D}},e)}if(n&&m!==null&&Math.abs(m)>re){const M=-x,E=-(x+m),N=Math.cos(M)+Math.cos(E),_=Math.sin(M)+Math.sin(E),D=Math.atan2(_,N),F=si,R=P.x+Math.cos(D)*F,B=P.y+Math.sin(D)*F;let L=D*(180/Math.PI);(L>90||L<-90)&&(L+=180);let O="";if(l===gs){let $=m*(ro/Math.PI);O=`${oo}${lt($,c)}^{\\circ}`}else l===Co&&(O=`${oo}${Jt(m/Math.PI,as,Rs)}${Et}`,O===`${oo}1${Et}`&&(O=Et),O===`${oo}-1${Et}`&&(O=`-${Et}`),O===`${oo}0${Et}`&&(O="0"));u({id:"ref-angle",content:O,x:R,y:B,color:y,fontSize:da,options:{rotation:L}},e)}}function Ch(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:o,ghostVertexPosition:i,gridDisplayMode:s,lastGridState:a,angleDisplayMode:r,canvas:c,dpr:l,mousePos:d,colors:h,useScientific:f},u,g){if(t===wi||!d||!n)return;let p;o&&i?p=i:p=u(d);let y=1;s!==Mo&&a&&a.interval1&&(y=a.interval1);let S=y;a&&a.interval2&&a.interval2<S&&(S=a.interval2);let m,x=1;S>=1e4?(x=100,m=0):S>=1e3?(x=10,m=0):S>=100?(x=1,m=0):S>=10?m=1:m=Math.max(0,-Math.floor(Math.log10(S)))+2;const v=(M=>1)(S)+2,C=M=>{if(f){const E=v-1,_=Math.abs(M).toExponential(E).split("e");let D=_[0],F=parseInt(_[1],10);return`${M<0?"-":""}${D} \\cdot 10^{${F}}`}else return x>1?(Math.round(M/x)*x).toFixed(m):M.toFixed(m)},w=Math.min(m,od);let P="";switch(t){case Oa:{let M=C(p.x);p.x>=0&&!M.includes("cdot")&&(M=`${_s}${M}`);let E=C(p.y);p.y>=0&&!E.includes("cdot")&&(E=`${_s}${E}`),P=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${M} \\\\ ${E} \\end{pmatrix*}`;break}case go:{let M=C(p.x);p.x>=0&&!M.includes("cdot")&&(M=`${_s}${M}`);const E=Math.abs(p.y);let N=C(E);const _=p.y<0?"-":"+";P=`z = ${M} ${_} ${N}${Go}`;break}case Ti:{const M=Math.hypot(p.x,p.y),E=Math.atan2(p.y,p.x);let N=C(M);M>=0&&!N.includes("cdot")&&(N=`${_s}${N}`);let _;if(r===gs){let D=_d(E*180/Math.PI);_=D.toFixed(w),D>=0&&(_=`${_s}${_}`),_+="^{\\circ}"}else{let D=nt(E);_=D.toFixed(w),D>=0&&(_=`${_s}${_}`)}P=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${N} \\\\ ${_} \\end{pmatrix*}`;break}}const T=c.width/l;g({id:"mouse-coord-text",content:P,x:T-Ir,y:Ir,color:h.mouseCoords,fontSize:id,options:{textAlign:"right",textBaseline:"top"}})}function pl(e,t,n,o){e.save();const i=t.x+t.width/2,s=t.y+t.height/2,a=t.width/2*.6;if(e.strokeStyle=o.uiIcon,e.fillStyle=o.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(i,s,a*.7,0,2*Math.PI),e.fill();for(let r=0;r<8;r++){const c=r/8*2*Math.PI,l=i+Math.cos(c)*(a*.85),d=s+Math.sin(c)*(a*.85),h=i+Math.cos(c)*(a*1.1),f=s+Math.sin(c)*(a*1.1);e.beginPath(),e.moveTo(l,d),e.lineTo(h,f),e.stroke()}}else e.beginPath(),e.arc(i,s,a,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i-5,s-3,a,0,2*Math.PI),e.fillStyle=o.background,e.fill();e.restore()}function Eh(e,t,n,o,i,s,a){const r=o?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/to;e.scale(l,l),e.translate(-16,-16);const d=1;e.strokeStyle=r,e.lineWidth=xn,e.lineCap="round",e.beginPath(),e.moveTo(2+d,30),e.lineTo(30+d,30),e.moveTo(2+d,30),e.lineTo(2+d,2),e.stroke(),e.fillStyle=r;const h={x:16+d,y:16};let f={x:17+d,y:8},u="";switch(n){case Oa:e.setLineDash(Hi),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(h.x,30),e.moveTo(h.x,h.y),e.lineTo(2+d,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,wn,0,$e),e.fill(),u="(x,y)";break;case go:e.setLineDash(Hi),e.beginPath(),e.moveTo(2+d,30),e.lineTo(h.x,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,wn,0,$e),e.fill(),u="x+iy";break;case Ti:e.setLineDash(Hi),e.beginPath(),e.moveTo(2+d,30),e.lineTo(h.x,h.y),e.stroke(),e.beginPath(),e.arc(2+d,30,8,-Math.atan2(30-h.y,h.x-(2+d)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,wn,0,$e),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const g="icon-label-coords",p=o?a.uiTextSelected:a.uiTextDefault;s({id:g,content:u,x:c.x+(f.x-16)*l,y:c.y+(f.y-16)*l,color:p,fontSize:Da,options:{textAlign:"center",textBaseline:"middle"}},i)}}function gl(e,t,n,o,i,s,a){const r=o?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(c.x,c.y);const d=t.width/to;e.scale(d,d),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=xn;const h={x:28,y:30},f={x:4,y:30},u={x:16,y:8};e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke();let g="",p={x:20,y:22};if(n!==yo){e.beginPath();const y=Math.atan2(u.y-f.y,u.x-f.x);e.arc(f.x,f.y,8,y,0),e.stroke(),n===gs?g="60^\\circ":n===Co&&(g="\\frac{\\pi}{3}",l=2)}if(e.restore(),g){const y="icon-label-angles",S=o?a.uiTextSelected:a.uiTextDefault;s({id:y,content:g,x:c.x+(p.x-16)*d,y:c.y+(p.y-20)*d,color:S,fontSize:Da+l,options:{textAlign:"center",textBaseline:"middle"}},i)}}function yl(e,t,n,o,i,s,a){const r=o?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/to;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=xn,e.beginPath(),e.moveTo(2,30),e.lineTo(30,30),e.stroke();let d="",h={x:16,y:22};if(n===mo&&(d="3.14"),e.restore(),d){const f="icon-label-distances",u=o?a.uiTextSelected:a.uiTextDefault;s({id:f,content:d,x:c.x+(h.x-16)*l,y:c.y+(h.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function wh(e,t,n,o,i){const s=o?i.uiIconSelected:i.uiIconDefault,a={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(a.x,a.y);const r=t.width/to;switch(e.scale(r,r),e.translate(-16,-16),e.strokeStyle=s,e.fillStyle=s,e.lineWidth=xn,n){case Na:e.strokeRect(2,2,28,28),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Ba:e.strokeRect(2,2,28,28),e.beginPath(),[8,16,24].forEach(h=>{[8,16,24].forEach(f=>{e.moveTo(h,f),e.arc(h,f,wn,0,$e)})}),e.fill();break;case Fa:e.strokeRect(2,2,28,28);const c=8,l=16,d=16;e.beginPath(),e.arc(l,d,wn,0,$e);for(let h=0;h<6;h++){const f=Math.PI/3*h,u=l+c*Math.cos(f),g=d+c*Math.sin(f);e.moveTo(u,g),e.arc(u,g,wn,0,$e)}e.fill();break;case $a:e.beginPath(),e.arc(16,16,14,0,$e),e.stroke(),e.beginPath(),e.arc(16,16,7,0,$e),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Mo:e.strokeRect(2,2,28,28);break}e.restore()}function Di(e,t,n){const o={x:t.x+t.width/2,y:t.y+t.height/2},i=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=xn,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(o.x,o.y),t.type){case Qt:{const s=-Math.PI/4;e.beginPath(),e.arc(0,0,i,s,-s),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+s,Math.PI-s),e.stroke();const a=i*.25,r=i*Math.cos(s),c=i*Math.sin(s);e.save(),e.translate(r,c),e.rotate(s-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+s),d=i*Math.sin(Math.PI+s);e.save(),e.translate(l,d),e.rotate(s+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();break}case On:{const s=i*.8,a=i*.25;e.beginPath(),e.moveTo(-s,0),e.lineTo(s,0),e.moveTo(0,-s),e.lineTo(0,s),e.stroke(),[{x:s,y:0,dirX:1,dirY:0},{x:-s,y:0,dirX:-1,dirY:0},{x:0,y:-s,dirX:0,dirY:-1},{x:0,y:s,dirX:0,dirY:1}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}case an:{const s=-Math.PI/4;e.beginPath(),e.arc(0,0,i,s,-s),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+s,Math.PI-s),e.stroke();let a=i*.25;const r=i*Math.cos(s),c=i*Math.sin(s);e.save(),e.translate(r,c),e.rotate(s-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+s),d=i*Math.sin(Math.PI+s);e.save(),e.translate(l,d),e.rotate(s+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const h=i*.8;a=i*.25,e.beginPath(),e.moveTo(-h,0),e.lineTo(h,0),e.moveTo(0,-h),e.lineTo(0,h),e.stroke(),[{x:h,y:0,dirX:1,dirY:0},{x:-h,y:0,dirX:-1,dirY:0},{x:0,y:-h,dirX:0,dirY:-1},{x:0,y:h,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a+u.dirY*a*.5,u.y-u.dirY*a-u.dirX*a*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a-u.dirY*a*.5,u.y-u.dirY*a+u.dirX*a*.5),e.stroke()});break}case Zn:{const s=i*.8,a=i*.25;e.beginPath(),e.moveTo(-s/Math.sqrt(2),-s/Math.sqrt(2)),e.lineTo(s/Math.sqrt(2),s/Math.sqrt(2)),e.moveTo(s/Math.sqrt(2),-s/Math.sqrt(2)),e.lineTo(-s/Math.sqrt(2),s/Math.sqrt(2)),e.stroke(),[{x:s/Math.sqrt(2),y:-s/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-s/Math.sqrt(2),y:s/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}}e.restore()}function Th(e,t,n){const o=t.x+t.width/2,i=t.y+t.height/2,s=t.width*.6,a=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=xn,e.lineCap="round",e.beginPath(),e.ellipse(o,i,s/2,a/2,0,0,2*Math.PI),e.stroke();const r=a*.3;e.beginPath(),e.arc(o,i,r,0,2*Math.PI),e.fill(),e.restore()}function Ph(e,t,n,o){const{canvasUI:i,colors:s,allColors:a,namedColors:r,colorAssignments:c,activeColorTargets:l,verticesVisible:d,edgesVisible:h,facesVisible:f,isDraggingColorTarget:u,draggedColorTargetInfo:g,mousePos:p}=n,y=s.checkerboardColor1,S=s.checkerboardColor2;function m(C){const w=C.height/3,P=Math.ceil(C.width/w);for(let T=0;T<3;T++)for(let M=0;M<P;M++){e.fillStyle=(T+M)%2===0?y:S;const E=C.x+M*w,N=C.y+T*w,_=Math.min(w,C.x+C.width-E),D=Math.min(w,C.y+C.height-N);_>0&&D>0&&e.fillRect(E,N,_,D)}}const x=i.randomColorButton;if(x){e.fillStyle="#000000",e.fillRect(x.x,x.y,x.width,x.height),e.strokeStyle=s.uiDefault,e.lineWidth=is,e.strokeRect(x.x,x.y,x.width,x.height);const C=x.x+x.width/2,w=x.y+x.height/2,P=x.width*.35,T=8;for(let M=0;M<T;M++){const E=M/T*2*Math.PI,N=(M+1)/T*2*Math.PI,_=M/T*360;e.fillStyle=`hsl(${_}, 70%, 60%)`,e.beginPath(),e.moveTo(C,w),e.arc(C,w,P,E,N),e.closePath(),e.fill()}e.fillStyle=s.background,e.beginPath(),e.arc(C,w,P*.4,0,2*Math.PI),e.fill()}const I=i.removeColorButton;I&&(e.strokeStyle=s.uiDefault,e.lineWidth=is,e.strokeRect(I.x,I.y,I.width,I.height),e.beginPath(),e.moveTo(I.x+Wt,I.y+I.height/2),e.lineTo(I.x+I.width-Wt,I.y+I.height/2),e.stroke()),i.colorSwatches.forEach(C=>{const w=C.item;let P=!1;if(w&&w.type==="color"){const T=Us(w.value);T&&T.a<1&&(P=!0)}else w&&w.type==="colormap"&&w.vertices.some(T=>T.alpha!==void 0&&T.alpha<1)&&(P=!0);if(P&&m(C),w&&w.type==="colormap"){const T=e.createLinearGradient(C.x,C.y,C.x+C.width,C.y);w.vertices.forEach(M=>{let E=M.color;typeof E=="string"&&(E=r[E]||[0,0,0]),T.addColorStop(M.pos,`rgba(${E.join(",")},${M.alpha||1})`)}),e.fillStyle=T}else w&&(e.fillStyle=w.value);e.fillRect(C.x,C.y,C.width,C.height)});const b=i.addColorButton;if(b&&(e.strokeStyle=s.uiDefault,e.lineWidth=is,e.strokeRect(b.x,b.y,b.width,b.height),e.beginPath(),e.moveTo(b.x+b.width/2,b.y+Wt),e.lineTo(b.x+b.width/2,b.y+b.height-Wt),e.moveTo(b.x+Wt,b.y+b.height/2),e.lineTo(b.x+b.width-Wt,b.y+b.height/2),e.stroke()),i.colorTargetIcons){const C=T=>{let M=c[T];return u&&g&&g.target===T&&g.previewColorIndex!==void 0&&(M=g.previewColorIndex),M},w=T=>{let M=C(T);const E=M===-1?null:a[M],N={};if(T===_e)N.vertexState=d?"filled":"disabled",M===-1?N.vertexColor=ks:E&&E.type==="color"?N.vertexColor=E.value:E&&E.type==="colormap"&&(N.vertexColormapItem=E);else if(T===Re)N.edgeState=h?"solid":"disabled",M===-1?N.edgeColor=ks:E&&E.type==="color"?N.edgeColor=E.value:E&&E.type==="colormap"&&(N.edgeColormapItem=E);else if(T===we)N.faceState=f?"filled":"disabled",M===-1?N.faceColor=ks:E&&E.type==="color"?N.faceColor=E.value:E&&E.type==="colormap"&&(N.faceColormapItem=E);else if(T===It){M===-1?N.textColor=ks:E&&E.type==="color"?N.textColor=E.value:E&&E.type==="colormap"&&(N.textColor=Ae(E,.5));const _=C(we);if(_===M){const D=_===-1?null:a[_];D?D.type==="color"?N.faceColorForContrast=D.value:D.type==="colormap"&&(N.faceColorForContrast=Ae(D,.5)):N.faceColorForContrast=ks}}return N};[we,Re,_e,It].forEach(T=>{const M=i.colorTargetIcons.find(E=>E.target===T);if(M){const E=l.includes(T),N=w(T);if(u&&g&&g.target===we&&T===we){const _=i.colorSwatches.find(D=>p.x>=D.x&&p.x<=D.x+D.width&&p.y>=D.y&&p.y<=D.y+D.height);if(_&&_.item.type==="colormap"){const D=Bd((p.x-_.x)/_.width,0,1);N.faceColor=Ae(_.item,D),N.faceState="filled"}}T===It?Rh(e,M,N,s,E):xo(e,M,N,s,E)}})}const v=new Set;l.forEach(C=>{let w=c[C];if(u&&g&&g.target===C&&g.previewColorIndex!==void 0&&(w=g.previewColorIndex),w===-1||v.has(w))return;const P=i.colorSwatches.find(T=>T.index===w);if(P){const T=Object.keys(c).filter(E=>{let N=c[E];return u&&g&&g.target===E&&g.previewColorIndex!==void 0&&(N=g.previewColorIndex),N===P.index&&l.includes(E)}),M=i.colorTargetIcons.filter(E=>T.includes(E.target));if(M.length>0){const E=Math.min(...M.map(B=>B.y));e.strokeStyle=s.selectionGlow,e.lineWidth=is;const N=2,_=P.x-N,D=E-N,F=P.width+N*2,R=P.y+P.height-D+N;e.strokeRect(_,D,F,R),v.add(w)}}})}function _h(e,t,n,o){const{canvasUI:i,colors:s,allColors:a,activeThemeName:r,edgeColorMode:c,faceColorMode:l,edgeColorExpression:d,faceColorExpression:h,faceColorPolarExpression:f}=n,u=i.colorModeIcons||[];if(!u.length)return;const g=r==="light",p=g?"#000000":"#ffffff",m={backgroundColor:g?"#ffffff":"#000000",borderColor:g?"#000000":"#ffffff",borderWidth:ti,borderRadius:el,paddingX:Zr,paddingY:Qr,minHeight:In},x=()=>a&&a.find(v=>v&&v.type==="colormap")||null;u.forEach(v=>{e.save(),e.strokeStyle=s.uiDefault,e.lineWidth=Fs,e.strokeRect(v.x,v.y,v.width,v.height),e.strokeStyle=s.uiIcon,e.fillStyle=s.uiIcon,e.lineWidth=xn;const C={vertexState:"none",edgeState:"none",faceState:"none",faceColor:s.uiIcon,edgeColor:s.uiIcon,vertexColor:s.uiIcon};if(v.group==="edge"){const w={...C,edgeState:"solid"};c==="inherit_vertices"&&(w.vertexState="solid"),c==="colormap"&&(w.edgeColormapItem=x()),xo(e,v,w,s,!1)}else if(v.group==="face"){const w={...C,faceState:"filled"};l==="inherit_vertices"&&(w.vertexState="solid"),l==="inherit_edges"&&(w.edgeState="solid"),(l==="colormap_xy"||l==="colormap_polar")&&(w.faceColormapItem=x()),xo(e,v,w,s,!1)}e.restore()});const I=u.find(v=>v.group==="edge"),b=u.find(v=>v.group==="face");c==="colormap"&&I&&o({id:"edge-color-mode-label",content:`c(${d||"x"}) =`,x:I.x+I.width+po,y:I.y+I.height/2,color:p,fontSize:ca,options:{textAlign:"left",textBaseline:"middle",boxStyle:m}},t),(l==="colormap_xy"||l==="colormap_polar")&&b&&o({id:"face-color-mode-label",content:`${l==="colormap_polar"?"c(r,\\phi) =":"c(x,y) ="}`,x:b.x+b.width+po,y:b.y+b.height/2,color:p,fontSize:ca,options:{textAlign:"left",textBaseline:"middle",boxStyle:m}},t)}function Ah(e,t,n,o){const i=(n?.vertices||[]).filter(C=>C&&C.type==="regular");if(!i.length){e.save(),e.fillStyle=o.uiIconDefault,e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width*.08,0,2*Math.PI),e.fill(),e.restore();return}let s=1/0,a=1/0,r=-1/0,c=-1/0;i.forEach(C=>{C.x<s&&(s=C.x),C.y<a&&(a=C.y),C.x>r&&(r=C.x),C.y>c&&(c=C.y)});const l=3,d=Math.max(t.width-l*2,1),h=Math.max(t.height-l*2,1),f=Math.max(r-s,1e-6),u=Math.max(c-a,1e-6),g=Math.min(d/f,h/u),p=(s+r)/2,y=(a+c)/2,S=t.x+t.width/2,m=t.y+t.height/2,x=C=>({x:S+(C.x-p)*g,y:m+(C.y-y)*g}),I=n?.edges||[],b=n?.faces||[],v=new Map(i.map(C=>[C.id,C]));e.save(),e.lineWidth=1,b.length>0&&(e.fillStyle=o.uiIconDefault,e.globalAlpha=.2,b.forEach(C=>{const w=(C.vertexIds||[]).map(T=>v.get(T)).filter(Boolean);if(w.length<3)return;e.beginPath();const P=x(w[0]);e.moveTo(P.x,P.y);for(let T=1;T<w.length;T++){const M=x(w[T]);e.lineTo(M.x,M.y)}e.closePath(),e.fill()}),e.globalAlpha=1),e.strokeStyle=o.uiIconDefault,I.forEach(C=>{const w=v.get(C.id1),P=v.get(C.id2);if(!w||!P)return;const T=x(w),M=x(P);e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(M.x,M.y),e.stroke()}),e.fillStyle=o.uiIconDefault,i.forEach(C=>{const w=x(C);e.beginPath(),e.arc(w.x,w.y,1.2,0,2*Math.PI),e.fill()}),e.restore()}function Dh(e,t){const{canvasUI:n,colors:o,sessions:i,activeSessionIndex:s,selectedSessionIndex:a}=t,r=n.removeSessionButton;r&&(e.strokeStyle=o.uiDefault,e.lineWidth=is,e.strokeRect(r.x,r.y,r.width,r.height),e.beginPath(),e.moveTo(r.x+Wt,r.y+r.height/2),e.lineTo(r.x+r.width-Wt,r.y+r.height/2),e.stroke()),(n.sessionIcons||[]).forEach(l=>{const d=l.index===a,h=l.index===s;e.save(),e.strokeStyle=d?o.selectionGlow:o.uiDefault,e.lineWidth=Fs,e.strokeRect(l.x,l.y,l.width,l.height),h&&!d&&(e.strokeStyle=o.selectionGlow,e.lineWidth=Fs,e.strokeRect(l.x+2,l.y+2,l.width-4,l.height-4)),Ah(e,l,l.session?.state,o),e.restore()});const c=n.addSessionButton;c&&(e.strokeStyle=o.uiDefault,e.lineWidth=is,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width/2,c.y+Wt),e.lineTo(c.x+c.width/2,c.y+c.height-Wt),e.moveTo(c.x+Wt,c.y+c.height/2),e.lineTo(c.x+c.width-Wt,c.y+c.height/2),e.stroke())}function kh(e,t,{verticesVisible:n,edgesVisible:o,facesVisible:i,colorAssignments:s,allColors:a},r){const c=!n&&!o&&!i,l={vertexState:n||c?"filled":"hidden",edgeState:o||c?"solid":"hidden",faceState:i||c?"filled":"hidden",showAllDisabled:c},d=s[_e];if(d!==-1){const u=a[d];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=r.vertex;const h=s[Re];if(h!==-1){const u=a[h];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=r.edge;const f=s[we];if(f!==-1){const u=a[f];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=r.face;xo(e,t,l,r)}function ml(e){const t={x:e.x+e.width/2,y:e.y+e.height/2},o=26*(e.width/to),i=o*Math.sqrt(3)/2,s=[{x:t.x,y:t.y-i/1.5},{x:t.x-o/2,y:t.y+i/3},{x:t.x+o/2,y:t.y+i/3}],a=new Path2D;a.moveTo(s[0].x,s[0].y),a.lineTo(s[1].x,s[1].y),a.lineTo(s[2].x,s[2].y),a.closePath();const r=Math.min(s[0].x,s[1].x,s[2].x),c=Math.max(s[0].x,s[1].x,s[2].x),l=Math.min(s[0].y,s[1].y,s[2].y),d=Math.max(s[0].y,s[1].y,s[2].y);return{vertices:s,facePath:a,bounds:{x:r,y:l,w:c-r,h:d-l}}}function xo(e,t,n,o,i=!1){const{vertexState:s="none",edgeState:a="none",faceState:r="none",faceColor:c,edgeColor:l,vertexColor:d,faceColormapItem:h,showAllDisabled:f=!1}=n;e.save();const{vertices:u,facePath:g}=ml(t);if(r==="filled"){if(h&&h.type==="colormap"){const y=e.createLinearGradient(u[1].x,0,u[2].x,0);h.vertices.forEach(S=>{const m=S.color,x=S.alpha!==void 0?S.alpha:1,I=`rgba(${m.join(",")},${x})`;y.addColorStop(S.pos,I)}),e.fillStyle=y}else e.fillStyle=c||o.face;e.fill(g)}else r==="disabled"&&(e.fillStyle=Yc,e.fill(g));if(a==="solid"||a==="disabled"){e.lineWidth=xn,e.setLineDash([]);const y=[[u[0],u[1]],[u[1],u[2]],[u[2],u[0]]];y.forEach((S,m)=>{const[x,I]=S;if(n.edgeColormapItem&&n.edgeColormapItem.type==="colormap"&&a==="solid"){const b=e.createLinearGradient(x.x,x.y,I.x,I.y),v=y.length>1?m/(y.length-1):.5,C=Math.max(0,Math.min(1,v)),w=Math.max(0,Math.min(1,v+.3)),P=Ae(n.edgeColormapItem,C),T=Ae(n.edgeColormapItem,w);b.addColorStop(0,P),b.addColorStop(1,T),e.strokeStyle=b}else a==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||o.edge;e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(I.x,I.y),e.stroke()})}(s==="filled"||s==="disabled")&&(e.lineWidth=xn,u.forEach((y,S)=>{let m=d||o.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&s==="filled"){const I=u.length>1?S/(u.length-1):.5;m=Ae(n.vertexColormapItem,I)}s==="disabled"&&(m="#808080");const x=new Path2D;x.moveTo(y.x+wn*2,y.y),x.arc(y.x,y.y,wn*2,0,2*Math.PI),e.fillStyle=m,e.setLineDash([]),e.fill(x)})),f?(e.strokeStyle=o.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(s==="disabled"||a==="disabled"||r==="disabled")&&(e.strokeStyle=o.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),e.restore()}function Rh(e,t,n,o,i=!1){e.save();const s={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(s.x,s.y);const a=t.width/to;e.scale(a,a),e.translate(-16,-16);let r=n.textColor||o.uiTextDefault;if(n.faceColorForContrast){const c=Us(n.faceColorForContrast);r=(.2126*c.r+.7152*c.g+.0722*c.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=r,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function li(e,t,n,o,i,s,a,r,c,l,d,h={}){if(!t||t.length<3)return;e.save(),e.beginPath(),t.forEach((v,C)=>{C===0?e.moveTo(v.x,v.y):e.lineTo(v.x,v.y)}),e.closePath(),l&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(v=>{const C=r.find(w=>w.id===v);if(C){const w=C.vertexIds.map(P=>c(P)).filter(P=>P&&P.type==="regular");if(w.length>=3){const T=(d?qs(w,d,!0,i):w).map(M=>i(M));e.moveTo(T[0].x,T[0].y),T.slice(1).forEach(M=>{e.lineTo(M.x,M.y)}),e.closePath()}}});const{faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:g="x",faceColorPolarExpression:p="r",edgeColorExpression:y="x"}=h,S=n?.vertexIds?n.vertexIds.map(v=>c(v)).filter(Boolean):[],m=v=>v?.color||o.face,x=ct(o.face,{r:255,g:255,b:255,a:1}),I=(v,C)=>{const w=e.createPattern(v,"no-repeat"),P=i(C.origin),T=Dn({x:1,y:0},C),M=Dn({x:0,y:1},C),E=i(T),N=i(M),_=E.x-P.x,D=E.y-P.y,F=N.x-P.x,R=N.y-P.y,B=v.width,L=B/2,O=_/L,$=D/L,A=F/L,k=R/L,V=P.x-(_+F)*(B/2)/L,Y=P.y-(D+R)*(B/2)/L,X=new DOMMatrix([O,$,A,k,V,Y]);return w.setTransform(X),w},b=(v,C)=>{const P=document.createElement("canvas");P.width=64,P.height=64;const T=P.getContext("2d"),M=T.createImageData(64,64),E=M.data,N=1/63,_=S.filter(L=>L.type==="regular"),D=_.map(L=>Ki(L,C)),F=_.map(L=>ct(m(L),x)),R=[];if(n?.vertexIds&&n.vertexIds.length>1)for(let L=0;L<n.vertexIds.length;L++){const O=n.vertexIds[L],$=n.vertexIds[(L+1)%n.vertexIds.length],A=a?.find(Y=>Y.id1===O&&Y.id2===$||Y.id1===$&&Y.id2===O)||{id1:O,id2:$},k=c(A.id1),V=c(A.id2);k&&V&&R.push({edge:A,v1:k,v2:V,v1Local:Ki(k,C),v2Local:Ki(V,C)})}const B=(L,O)=>{const{edge:$,v1:A,v2:k}=L;if(u==="inherit_vertices"&&A&&k){const V=ct(m(A),x),Y=ct(m(k),x);return{r:St(V.r,Y.r,O),g:St(V.g,Y.g,O),b:St(V.b,Y.b,O),a:St(V.a,Y.a,O)}}if(u==="colormap"&&$.colormapItem){const V=$s(y,{x:O},O),Y=Vs(V),X=Ae($.colormapItem,Y);return ct(X,x)}return ct($.color||o.edge,x)};for(let L=0;L<64;L++)for(let O=0;O<64;O++){const $=O*N*2-1,A=L*N*2-1;let k=x;if(v==="colormap_xy"||v==="colormap_polar")if(n?.colormapItem){let Y=.5;if(v==="colormap_xy")Y=$s(g,{x:$,y:A},$);else{const G=Math.hypot($,A),W=Math.atan2(A,$);Y=$s(p,{r:G,phi:W},G)}const X=Vs(Y),z=Ae(n.colormapItem,X);k=ct(z,x)}else k=x;else if(v==="inherit_vertices"&&D.length>0){const Y=D.map(X=>{const z=$-X.x,G=A-X.y,W=Math.hypot(z,G);return 1/Math.max(W,1e-4)});k=Xr(F,Y)}else if(v==="inherit_edges"&&R.length>0){const Y=R.map(z=>{const G=bt({x:$,y:A},z.v1Local,z.v2Local);return 1/Math.max(G.distance,1e-4)}),X=R.map((z,G)=>{const W=bt({x:$,y:A},z.v1Local,z.v2Local);return B(z,W.t)});k=Xr(X,Y)}const V=(L*64+O)*4;E[V]=Math.round(k.r),E[V+1]=Math.round(k.g),E[V+2]=Math.round(k.b),E[V+3]=Math.round(Vs(k.a)*255)}return T.putImageData(M,0,0),P};if(f==="fixed")e.fillStyle=n?.color||o.face,e.fill(l?"evenodd":"nonzero");else if(n.localCoordSystem){const v=b(f,n.localCoordSystem),C=I(v,n.localCoordSystem);e.fillStyle=C||n?.color||o.face,e.fill(l?"evenodd":"nonzero")}else n?.colormapItem&&n.localCoordSystem,e.fillStyle=n?.color||o.face,e.fill(l?"evenodd":"nonzero");e.restore()}function Lh(e,t,n,o,i,s){const{angleDisplayMode:a,distanceDisplayMode:r,colors:c}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":gl(e,l,a,a!==yo,o,i,c);break;case"distances":yl(e,l,r,r===mo,o,i,c);break}}function Oh(e,t,n,o){const{canvasUI:i,colorAssignments:s,allColors:a,colors:r}=n,c=l=>{if(!s||!a)return r.uiIcon;const d=s[l];if(d===-1)return ks;const h=a[d];return h&&h.type==="color"?h.value:r.uiIcon};c(_e),c(Re),c(we),i.visibilityIcons.forEach(l=>{Lh(e,l,n,t,o)})}function xl(e,t,n,o){const i={x:t.x+t.width*.22,y:t.y+t.height*.78},s={x:t.x+t.width*.22,y:t.y+t.height*.22},a={x:t.x+t.width*.78,y:t.y+t.height*.22},r=[i,s,a],l=!o||o.type==="linear"?r:qs(r,o,!1,null),d=(h,f)=>{const u=Math.atan2(f.y-h.y,f.x-h.x),g=t.width*.08,p={x:f.x-Math.cos(u)*g+Math.cos(u+Math.PI/2)*g*.6,y:f.y-Math.sin(u)*g+Math.sin(u+Math.PI/2)*g*.6},y={x:f.x-Math.cos(u)*g+Math.cos(u-Math.PI/2)*g*.6,y:f.y-Math.sin(u)*g+Math.sin(u-Math.PI/2)*g*.6};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(p.x,p.y),e.lineTo(y.x,y.y),e.closePath(),e.fill()};e.save(),e.strokeStyle=n.uiIcon,e.lineWidth=Aa,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let h=1;h<l.length;h++)e.lineTo(l[h].x,l[h].y);e.stroke(),e.fillStyle=n.uiIcon,r.forEach(h=>{e.beginPath(),e.arc(h.x,h.y,wn+.5,0,Math.PI*2),e.fill()}),o?.linearStyle==="arrows"&&(d(i,s),d(s,a)),e.restore()}function Nh(e,t,n,o){const{canvasUI:i,colors:s,activeInterpolationStyleId:a,selectedInterpolationStyleId:r,interpolationStyles:c}=n;i.interpolationIcons.forEach(l=>{const d={x:l.x,y:l.y,width:l.width,height:l.height};if(l.type==="interpolationStyle"){const h=l.styleId===(r||a);e.strokeStyle=s.uiDefault,e.lineWidth=Fs,e.strokeRect(d.x,d.y,d.width,d.height),h&&(e.strokeStyle=s.selectionGlow,e.lineWidth=is,e.strokeRect(d.x-2,d.y-2,d.width+4,d.height+4));const f=c.find(g=>g.id===l.styleId);xl(e,d,s,f);const u=f?.name||"";u&&u.toLowerCase()!=="linear"&&o({id:`interpolation-label-${l.styleId}`,content:u.length>6?`${u.slice(0,6)}...`:u,x:d.x+d.width/2,y:d.y+d.height+10,color:s.uiTextDefault,fontSize:Da,options:{textAlign:"center",textBaseline:"top"}},t)}else l.type==="interpolationRemove"?(e.strokeStyle=s.uiDefault,e.lineWidth=Fs,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.strokeStyle=s.uiIcon,e.lineWidth=Aa,e.stroke()):l.type==="interpolationAdd"&&(e.strokeStyle=s.uiDefault,e.lineWidth=Fs,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width/2,d.y+d.height*.25),e.lineTo(d.x+d.width/2,d.y+d.height*.75),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.stroke())})}function Bh(e,t,n,o){const{canvasUI:i,colors:s,activeThemeName:a,colorAssignments:r,allColors:c,verticesVisible:l,edgesVisible:d,facesVisible:h}=n,f=i.toolbarButton;e.strokeStyle=s.uiDefault,e.lineWidth=Jr,e.beginPath();for(let b=0;b<3;b++){const v=f.y+5+b*10;e.moveTo(f.x+4,v),e.lineTo(f.x+f.width-4,v)}e.stroke();const u=i.colorToolButton;u&&kh(e,u,{verticesVisible:l,edgesVisible:d,facesVisible:h,colorAssignments:r,allColors:c},s);const g=i.colorModeToolButton;if(g){const b=g,v={x:b.x+4,y:b.y+3,width:b.width-8,height:b.height-8};(w=>{const{vertices:P}=ml(w),T=[[P[0],P[1]],[P[1],P[2]],[P[2],P[0]]],M=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"];T.forEach((E,N)=>{e.strokeStyle=M[N],e.lineWidth=2,e.beginPath(),e.moveTo(E[0].x,E[0].y),e.lineTo(E[1].x,E[1].y),e.stroke()})})(v),e.fillStyle="#ffffff",xo(e,v,{edgeState:"none",faceState:"filled",vertexState:"none",faceColor:"#ffffff"},s)}const p=i.transformToolButton;p&&o({id:"transform-tool-label",content:Kc,x:p.x+p.width/2,y:p.y+p.height/2,color:s.uiIcon,fontSize:jc,options:{textAlign:"center",textBaseline:"middle"}},t);const y=i.interpolationToolButton;y&&xl(e,y,s);const S=i.displayToolButton;if(S){e.strokeStyle=s.uiDefault,e.fillStyle=s.uiDefault,e.lineWidth=Aa;const b=S.width-Zc;for(let v=0;v<3;v++){const C=S.y+Qc+v*ed;e.beginPath(),e.moveTo(S.x+6,C),e.lineTo(S.x+6+b,C),e.stroke(),e.beginPath(),e.arc(S.x+6+b*(v/2),C,td,0,2*Math.PI),e.fill()}}const m=i.visibilityToolButton;m&&Th(e,m,s);const x=i.sessionsToolButton;if(x){e.save(),e.strokeStyle=s.uiDefault,e.lineWidth=xn;const b=6,v=Math.min(x.width,x.height)-b*2,C=x.x+b,w=x.y+b;e.strokeRect(C+4,w+2,v,v),e.strokeRect(C,w+6,v,v),e.restore()}const I=i.themeToggleButton;I&&pl(e,I,a,s)}function Fh(e,t){const{canvasUI:n,colors:o}=t;n.transformIcons.forEach(i=>{Di(e,i,o)})}function $h(e,t,n,o){const{canvasUI:i,colors:s,coordsDisplayMode:a,gridDisplayMode:r,angleDisplayMode:c,distanceDisplayMode:l,activeThemeName:d}=n;i.displayIcons.forEach(h=>{const f={x:h.x,y:h.y,width:h.width,height:h.height};switch(h.group){case"coords":Eh(e,f,a,a!==wi,t,o,s);break;case"grid":wh(e,f,r,r!==Mo,s);break;case"angles":gl(e,f,c,c!==yo,t,o,s);break;case"distances":yl(e,f,l,l===mo,t,o,s);break;case"theme":pl(e,f,d,s);break}})}function Vh(e,t,n,o){const{dpr:i,isToolbarExpanded:s,isColorPaletteExpanded:a,isColorModePanelExpanded:r,isInterpolationPanelExpanded:c,isTransformPanelExpanded:l,isDisplayPanelExpanded:d,isVisibilityPanelExpanded:h,isSessionsPanelExpanded:f,isPlacingTransform:u,placingTransformType:g,placingSnapPos:p,mousePos:y,colors:S}=n;if(e.save(),e.resetTransform(),e.scale(i,i),s)Bh(e,t,n,o);else{const m=n.canvasUI.toolbarButton;e.strokeStyle=S.uiDefault,e.lineWidth=Jr,e.beginPath();for(let x=0;x<3;x++){const I=m.y+5+x*10;e.moveTo(m.x+4,I),e.lineTo(m.x+m.width-4,I)}e.stroke()}if(a&&Ph(e,t,n),r&&_h(e,t,n,o),c&&Nh(e,t,n,o),l&&Fh(e,n),d&&$h(e,t,n,o),h&&Oh(e,t,n,o),f&&Dh(e,n),u){const m=p||y;if(m){const x=zi/2,I={type:g,x:m.x-x,y:m.y-x,width:zi,height:zi};Di(e,I,S)}}e.restore()}function Yr(e,t,n,o,{showDistances:i,distanceSigFigs:s,colors:a,lastGridState:r,currentShiftPressed:c},l,d,h,f,u=null,g=null,p=null){!i||n.length===0||n.forEach(y=>{const S=o.find(m=>d(m)===y);if(S){let m=l(S.id1),x=l(S.id2);if(u){const I=u.find(v=>v.id===S.id1),b=u.find(v=>v.id===S.id2);I&&(m=I),b&&(x=b)}if(m&&x&&m.type==="regular"&&x.type==="regular"){let I;const b=u&&p;if(S.labelMode==="exact"&&S.exactValue){const[D,F]=ds(S.exactValue.g2gSquaredSum);let R=S.exactValue.gridInterval*D;if(b&&p.transformType!==Qt){const B=p.snappedScaleValue!==null?p.snappedScaleValue:p.scale;R*=B}I=hs(parseFloat(R.toFixed(10)),F)}else I=lt(J(m,x),s);const v=h(m),C=h(x),w=(v.x+C.x)/2,P=(v.y+C.y)/2,T=Math.atan2(C.y-v.y,C.x-v.x);let M=T-Math.PI/2;Math.sin(M)>0&&(M+=Math.PI);const E=w+Math.cos(M)*$n,N=P+Math.sin(M)*$n;let _=T*(180/Math.PI);(_>90||_<-90)&&(_+=180),f({id:`selected-edge-dist-${y}`,content:I,x:E,y:N,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:sn,options:{rotation:_}})}}})}function Xh(e,t,n,o){e.save(),e.strokeStyle=o.mouseCoords,e.lineWidth=Zt,e.setLineDash(En);const i=Math.min(t.x,n.x),s=Math.min(t.y,n.y),a=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);e.strokeRect(i,s,a,r),e.restore()}function co(e,t,n,o,{lastGridState:i,showDistances:s,showAngles:a,distanceSigFigs:r,angleDisplayMode:c,angleSigFigs:l,currentShiftPressed:d,viewTransform:h,colors:f},u,g,p,y=!1,S=null,m=null,x=[],I=!1,b=[],v=null,C=new Map){const w=y?f.feedbackSnapped:`rgba(${f.feedbackDefault.join(",")}, 1.0)`,P=new Map(o.map(O=>[O.id,{...O}])),T=O=>P.get(O),M=T(n);if(!M)return;const E=g(M.id).map(T).filter(Boolean),N=u(M),_=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,F=(C.get(n)||[]).find(O=>O.type==="projection"&&O.projectionLine);if(F){const[O,$]=F.projectionLine,A=u(O),k=u($),V={x:k.x-A.x,y:k.y-A.y},Y=Math.hypot(V.x,V.y);if(Y>0){const X={x:V.x/Y,y:V.y/Y},z=1e4,G={x:A.x-X.x*z,y:A.y-X.y*z},W={x:A.x+X.x*z,y:A.y+X.y*z};e.save(),e.strokeStyle=w,e.lineWidth=Zt,e.setLineDash(Ur),e.beginPath(),e.moveTo(G.x,G.y),e.lineTo(W.x,W.y),e.stroke(),e.restore()}}const R=(O,$)=>{if(!O||!$||$<=0)return!1;const A=$*1e-6,k=Math.abs(O.x/$-Math.round(O.x/$))<A,V=Math.abs(O.y/$-Math.round(O.y/$))<A;return k&&V},B=E.every(O=>x.includes(O.id)),L=b.find(O=>O.id===n);if(!v&&I&&d&&B&&L&&J(L,M)>re){const O=u(L),$=N,A=Math.atan2($.y-O.y,$.x-O.x),k=Math.atan2(M.y-L.y,M.x-L.x);if(s){let V;const Y=_&&R(L,_),X=_&&R(M,_);if(Y&&X){const me=M.x-L.x,vt=M.y-L.y,Qe=Math.round(me/_),rt=Math.round(vt/_),zt=Qe*Qe+rt*rt;if(zt===0)V="0";else{const[Ft,ve]=ds(zt),Je=_*Ft,Mt=parseFloat(Je.toFixed(10));V=hs(Mt,ve)}}else{const me=r+2;V=lt(J(L,M),me)}const z=(O.x+$.x)/2,G=(O.y+$.y)/2;let W;a&&Math.abs(k)>re?-k<0?W=A-Math.PI/2:W=A+Math.PI/2:(W=A-Math.PI/2,Math.sin(W)>0&&(W+=Math.PI));const Q=z+Math.cos(W)*$n,te=G+Math.sin(W)*$n;let pe=A*(180/Math.PI);(pe>90||pe<-90)&&(pe+=180),m({id:`drag-dist-vector-${M.id}`,content:V,x:Q,y:te,color:w,fontSize:sn,options:{rotation:pe}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=w,e.lineWidth=Zt,e.beginPath(),e.moveTo(O.x,O.y),e.lineTo($.x,$.y),e.stroke(),e.restore(),a&&Math.abs(A)>re){za(e,O,0,k,Ws,w);let V;if(c===gs?V=`${lt(k*(180/Math.PI),l)}^{\\circ}`:V=lt(k,l),V){const Y=-k/2,X=si,z={x:X*Math.cos(Y),y:X*Math.sin(Y)},G={x:O.x+z.x,y:O.y+z.y};let W=Y*(180/Math.PI);(W>90||W<-90)&&(W+=180),m({id:`drag-angle-vector-${M.id}`,content:V,x:G.x,y:G.y,color:w,fontSize:sn,options:{rotation:W}},t)}}}if(s&&E.forEach(O=>{const $=x.includes(O.id);if(!I||!$){const A=M,k=O,V=p({id1:A.id,id2:k.id});let Y;if(_&&R(A,_)&&R(k,_)){const rt=A.x-k.x,zt=A.y-k.y,Ft=Math.round(rt/_),ve=Math.round(zt/_),Je=Ft*Ft+ve*ve;if(Je===0)Y="0";else{const[Mt,Ts]=ds(Je),cn=_*Mt,en=parseFloat(cn.toFixed(10));Y=hs(en,Ts)}}else{const rt=J(A,k);Y=lt(rt,r)}const z=u(A),G=u(k),W=(z.x+G.x)/2,Q=(z.y+G.y)/2,te=Math.atan2(G.y-z.y,G.x-z.x);let pe=te-Math.PI/2;Math.sin(pe)>0&&(pe+=Math.PI);const me=W+Math.cos(pe)*$n,vt=Q+Math.sin(pe)*$n;let Qe=te*(180/Math.PI);(Qe>90||Qe<-90)&&(Qe+=180),m({id:`drag-dist-${V}`,content:Y,x:me,y:vt,color:w,fontSize:sn,options:{rotation:Qe}})}}),a&&E.length>=2&&(!I||E.some(O=>!x.includes(O.id)))){const O=[...E].sort(($,A)=>{const k=Math.atan2($.y-M.y,$.x-M.x),V=Math.atan2(A.y-M.y,A.x-M.x);return k-V});for(let $=0;$<O.length;$++){const A=O[$],k=O[($+1)%O.length],V=x.includes(A.id),Y=x.includes(k.id);if(!(!I||!V||!Y))continue;const z={x:A.x-M.x,y:A.y-M.y},G={x:k.x-M.x,y:k.y-M.y},W=Math.atan2(z.y,z.x),Q=Math.atan2(G.y,G.x);let te=Q-W;if(te<0&&(te+=2*Math.PI),te<re)continue;const pe=W+te/2;e.save(),e.strokeStyle=w,e.lineWidth=Zt,e.beginPath(),e.arc(N.x,N.y,Ws,-W,-Q,!1),e.stroke(),e.restore();let me;if(c===gs?me=`${lt(te*(180/Math.PI),l)}^{\\circ}`:c===Co&&(d?(me=Jt(te/Math.PI,.015,32)+"\\pi",me.startsWith("1\\pi")&&(me="\\pi"),me.startsWith("-1\\pi")&&(me="-\\pi"),me==="0\\pi"&&(me="0")):me=lt(te,l)),me){const vt=`drag-angle-${M.id}-${A.id}-${k.id}`,Qe={x:M.x+Math.cos(pe),y:M.y+Math.sin(pe)},rt=u(Qe),zt=Math.atan2(rt.y-N.y,rt.x-N.x),Ft=si,ve={x:Ft*Math.cos(zt),y:Ft*Math.sin(zt)},Je={x:N.x+ve.x,y:N.y+ve.y};let Mt=zt*(180/Math.PI);(Mt>90||Mt<-90)&&(Mt+=180),m({id:vt,content:me,x:Je.x,y:Je.y,color:w,fontSize:sn,options:{rotation:Mt}},t)}}}}function Yh(e,t,n,o,{showAngles:i,angleSigFigs:s,angleDisplayMode:a,currentShiftPressed:r,distanceSigFigs:c,viewTransform:l,lastGridState:d,colors:h},f,u,g,p,y){!i||n.length===0||n.forEach(S=>{const m=o.find(x=>u(x)===S);if(m){const x=f(m.id1),I=f(m.id2);if(x&&I&&x.type==="regular"&&I.type==="regular"){const b={lastGridState:d,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:s,currentShiftPressed:r,viewTransform:l,colors:h};co(e,t,x.id,[x,I],b,g,p,u,!1,null,y),co(e,t,I.id,[x,I],b,g,p,u,!1,null,y)}}})}function Sl(e,{allFaces:t,selectedFaceIds:n,colors:o,isDragConfirmed:i,dragPreviewVertices:s,initialDragVertexStates:a,transformIndicatorData:r,highlightedEdgeForSnap:c,draggedFaceId:l,coordSystemSnapAngle:d,coordSystemSnapType:h,coordSystemSnapScale:f,initialCoordSystemStates:u},g,p){if(n.length>ld)return;const y=new Set(n);y.size!==0&&y.forEach(S=>{const m=t.find(I=>I.id===S);if(!m||!m.localCoordSystem)return;let x=m.localCoordSystem;if(i&&m.vertexIds.some(I=>s.some(b=>b.id===I))){const I=u.get(m.id);x=Qd(m,{initialSystem:I,dragPreviewVertices:s,initialDragVertexStates:a,findVertexById:p,transformIndicatorData:r})}if(l===S&&d!==null){const I=v=>{if(i&&s){const C=s.find(w=>w&&w.id===v);if(C)return C}return p(v)},b=g(x.origin);if(h==="edge"&&c!==null){const v=m.vertexIds.map(C=>I(C)).filter(C=>C&&C.type==="regular");if(c<v.length){const C=v[c],w=v[(c+1)%v.length],P=g(C),T=g(w);e.save(),e.strokeStyle=o.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(T.x,T.y),e.stroke(),e.restore()}}else if(h==="cardinal"){const C=b.x+Math.cos(-d)*100,w=b.y+Math.sin(-d)*100,P=b.x-Math.cos(-d)*100,T=b.y-Math.sin(-d)*100;e.save(),e.strokeStyle=o.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(P,T),e.lineTo(C,w),e.stroke(),e.restore()}}Hh(e,x,o,g,f)})}function Hh(e,t,n,o,i=null){const s=o(t.origin),a=Dn({x:1,y:0},t),r=Dn({x:0,y:1},t),c=o(a),l=o(r);e.save(),e.lineWidth=Gn,e.lineCap="round";const d=(u,g,p,y)=>{e.strokeStyle=p,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(g.x,g.y),e.stroke(),e.fillStyle=y;const S=Math.atan2(g.y-u.y,g.x-u.x);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(g.x-De*Math.cos(S-Kt),g.y-De*Math.sin(S-Kt)),e.lineTo(g.x-De*Math.cos(S+Kt),g.y-De*Math.sin(S+Kt)),e.closePath(),e.fill()},h=i!==null?n.feedbackSnapped:n.coordSysX,f=i!==null?n.feedbackSnapped:n.coordSysY;d(s,c,h,h),d(s,l,f,f),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(s.x,s.y,Hc,0,2*Math.PI),e.fill(),e.restore()}const fe=document.getElementById("drawingCanvas"),Me=fe.getContext("2d",{willReadFrequently:!0}),tt=document.getElementById("html-overlay"),Ve=window.devicePixelRatio||1,So=new Map,Ga=18,Xo=8,Ji={x:12,y:-12},zh={x:8,y:-8};let rs={activeId:null,inputEl:null};const kn={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0,radiusMode:"relative",radiusValue:.25},Wa="platonic-play",ci=1,Zi=`${Wa}.user-id`;let tn=null,Yo=null,Il=!1,Bn,Ls,pn=[JSON.parse(JSON.stringify(kn))],Eo=kn.id;const H={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,colorModeToolButton:null,colorModeIcons:[],colorModePanelBounds:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[],sessionsToolButton:null,sessionIcons:[],addSessionButton:null,removeSessionButton:null,sessionsPanelBounds:null};let ht,Os=null,Ns=null,Rt=null,pa=[],di=null,xs=new Map,fn=null,Cn=null,Ks=null,wo=null,Ss=null,bn=null,Xs=!1,wt=null,Ce=[],Lt=null,qn=null,dt=null,Rn=null,Io=!1,To=null,un=!1,qa=!1,nn=!1,pt=!1,jt=!1,Is="regular",st="lines",on="degrees",Wo="on",hi=!0,fi=!0,Ln=!0,gn=null,Tn=null,yn=null,ui=!1,Ys=!1,ae=[],U=[],Z=[],qe=[],bs=new Map,gt=new Map,le=[],ie=[],se=[],ye=[],Xe=null,K={x:0,y:0},Un=null,ls=!1,ot=!1,pi=!1,ho=null,vn=!1,Yt=!1,Js=null,Ze=[],qt=0,Nn=!0,Sn=!0,Ke=null,qo=4,es=3,Gh=.5,Ye=null,$t=!1,Oe=!1,fs=!1,jn=!1,mn=-1,Ut={x:0,y:0},Qi={x:0,y:0},ce=[],bl={x:0,y:0},ee=null,ue=Ei,Ue=!1,it=null,gi=null,Se=[],Bs=[],ga=[],ke=!1,Tt={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},de={targetId:null,type:null,count:0,timestamp:0},Ho={id:null,timestamp:0},ft=[],Te=[],Xt=0,yt=0,fo=null,yi=[],At="fixed",Fe="fixed",Pn="x",Xn="x",Yn="r",Dt=null,kt=null,_t=!1,dn=null;function Wh(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,o=Array.prototype.splice;ft.pop=function(){return e.call(this)},ft.push=function(...i){return t.call(this,...i)},ft.shift=function(){return n.call(this)},ft.splice=function(...i){return o.call(this,...i)}}let ya=!1,Hn=[],Ne=null,Ie=[],Ot="",Vt=null,vs=[],Uo=0,j={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},oe={scale:Xc,offsetX:0,offsetY:0},rn={angle1:30,angle2:15,alpha1:1,alpha2:0},Ua=new Set,bo="dark",He=[],us=!1,Pt=null,uo=!1,jo=null,cs={edge:0,face:0},ma=!1,he={[_e]:0,[Re]:1,[we]:2,[It]:0},Kn=!1,ln=null,mi=null,Hs=new Set,ts=!1;function Es(){Xd(Z,q)}function ja(){return Fd(bo,gc)}function Pe(e,t=0,n=1){let o=he[e];(o<0||o>=ue.length)&&(o=0);const i=ue[o];if(i?.type==="color")return i.value;if(i?.type==="colormap"){const a=n>1?t/(n-1):.5;return Ae(i,a)}const s=ja();return e===_e?s.vertex:e===Re?s.edge:e===we?s.face:e===It?s.uiTextDefault||s.geometryInfoText:s.vertex}function ki(){At==="inherit_vertices"&&(he[Re]=he[_e]),Fe==="inherit_vertices"?he[we]=he[_e]:Fe==="inherit_edges"&&(he[we]=he[Re])}function vl(e){if(e===Re&&At==="inherit_vertices")return _e;if(e===we){if(Fe==="inherit_vertices")return _e;if(Fe==="inherit_edges")return Re}return e}function xi(e){const t=[];return e===_e&&(At==="inherit_vertices"&&t.push(Re),Fe==="inherit_vertices"&&t.push(we)),e===Re&&Fe==="inherit_edges"&&t.push(we),t}function Ml(){if(At==="fixed"){const e=Pe(Re);U.forEach(t=>{t.color=t.color||e,delete t.colormapItem,delete t.gradientStart,delete t.gradientEnd})}if(Fe==="fixed"){const e=Pe(we);Z.forEach(t=>{t.color=t.color||e,delete t.colormapItem,delete t.colormapDistribution})}if(Fe.startsWith("colormap")){const e=he[we],t=ue[e];t&&t.type==="colormap"&&Z.forEach(n=>{n.colormapItem=n.colormapItem||t,n.colormapDistribution="x"})}}function Ka(){He.forEach(e=>{const t=he[e];if(e===_e){const n=ue[t];if(n&&n.type==="colormap"){const o=le.map(i=>q(i)).filter(i=>i&&i.type==="regular");o.forEach((i,s)=>{const a=o.length>1?s/(o.length-1):.5;i.color=Ae(n,a)})}else le.forEach(o=>{const i=q(o);i&&i.type==="regular"&&(i.color=Pe(_e))})}else if(e===Re){const n=ue[t];if(At==="colormap"&&n&&n.type==="colormap")ie.forEach((o,i)=>{const s=U.find(a=>ne(a)===o);if(s){const a=ie.length,r=a>1?i/a:0,c=a>1?(i+1)/a:1;s.gradientStart=r,s.gradientEnd=c,s.colormapItem=n,delete s.color}});else{const o=n&&n.type==="colormap"?Ae(n,.5):Pe(Re);U.forEach(i=>{ie.includes(ne(i))&&(i.color=o,delete i.gradientStart,delete i.gradientEnd,delete i.colormapItem)})}}else if(e===we){const n=he[e];if(Fe==="inherit_vertices"||Fe==="inherit_edges")return;if(n===-1){const o=Pe(we);Z.forEach(i=>{se.includes(ge(i))&&(i.color=o,delete i.colormapItem,delete i.colormapDistribution)})}else{const o=ue[n];if(Fe.startsWith("colormap")&&o&&o.type==="colormap")Z.forEach(i=>{se.includes(ge(i))&&(i.colormapItem=o,i.colormapDistribution="x",delete i.color)});else{const i=o&&o.type==="colormap"?Ae(o,.5):Pe(we);Z.forEach(s=>{se.includes(ge(s))&&(s.color=i,delete s.colormapItem,delete s.colormapDistribution)})}}}else if(e===It){const n=ue[t];if(n&&n.type==="colormap")ye.forEach((o,i)=>{const s=vo(o);if(!s)return;const a=ye.length>1?i/(ye.length-1):.5;s.color=Ae(n,a)});else{const o=Pe(It);ye.forEach(i=>{const s=vo(i);s&&(s.color=o)})}}})}function xt({id:e,content:t,x:n,y:o,color:i,fontSize:s,options:a={}}){Ua.add(e);let r=So.get(e);if(r){if(!r.contentEl||!r.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const g=document.createElement("div");g.style.display="inline-block",g.style.whiteSpace="nowrap",g.style.lineHeight="1",u.appendChild(g),r.textContent="",r.appendChild(u),r.contentEl=u,r.katexEl=g,r.katexContent=null,r.style.pointerEvents="none"}}else{r=document.createElement("div"),r.style.position="absolute",r.style.fontFamily="KaTeX_Main, Times New Roman, serif",r.style.whiteSpace="nowrap",r.style.lineHeight="1",r.style.display="inline-block",r.style.padding="0",r.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const g=document.createElement("div");g.style.display="inline-block",g.style.whiteSpace="nowrap",g.style.lineHeight="1",u.appendChild(g),r.appendChild(u),r.contentEl=u,r.katexEl=g,tt.appendChild(r),So.set(e,r)}let c="-50%",l="-50%",d="center";switch(a.textAlign){case"left":c="0%";break;case"right":c="-100%";break}switch(a.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}if(a.textAlign==="left"&&a.textBaseline==="top"?d="top left":a.textAlign==="right"&&a.textBaseline==="top"?d="top right":a.textAlign==="left"&&a.textBaseline==="bottom"?d="bottom left":a.textAlign==="right"&&a.textBaseline==="bottom"&&(d="bottom right"),r.style.left=`${n}px`,r.style.top=`${o}px`,r.style.transformOrigin=d,r.style.transform=`translate(${c}, ${l}) rotate(${a.rotation||0}deg)`,a.boxStyle){const{backgroundColor:u,borderColor:g,borderWidth:p,borderRadius:y,paddingX:S,paddingY:m,minHeight:x}=a.boxStyle;r.style.display="inline-flex",r.style.alignItems="center",r.style.justifyContent="flex-start",r.style.background=u||"transparent",r.style.border=g?`${p||1}px solid ${g}`:"none",r.style.borderRadius=`${y||0}px`,r.style.padding=`${m||0}px ${S||0}px`,r.style.minHeight=x?`${x}px`:"0"}else r.style.display="inline-block",r.style.background="transparent",r.style.border="none",r.style.borderRadius="0",r.style.padding="0",r.style.minHeight="0",r.style.alignItems="",r.style.justifyContent="";r.style.color=i,r.style.fontSize=`${s}px`;const h=t==null?"":String(t),f=pc(h);if(r.katexContent!==f){const u=r.katexEl||r.contentEl||r;uc(u,f),r.katexContent=f}if(e==="edge-color-mode-label"||e==="face-color-mode-label"){const u=Math.round(r.getBoundingClientRect().width),g=e==="edge-color-mode-label"?cs.edge:cs.face;Math.abs(u-g)>1&&(e==="edge-color-mode-label"?cs.edge=u:cs.face=u,ma=!0)}}function Hr(e,{placeholder:t,onChange:n}){if(e)return e;const o=document.createElement("input");return o.type="text",o.placeholder=t,o.style.position="absolute",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize=`${ca}px`,o.style.padding=`${Qr}px ${Zr}px`,o.style.borderRadius=`${el}px`,o.style.border=`${ti}px solid rgba(0,0,0,0.3)`,o.style.background="#ffffff",o.style.color="#111111",o.style.width=`${ei}px`,o.style.height=`${In}px`,o.style.lineHeight=`${In}px`,o.style.display="none",o.style.pointerEvents="auto",o.addEventListener("input",()=>{n&&n(o.value)}),tt.appendChild(o),o}function qh(e){const t=e.match(/[A-Za-z_][A-Za-z0-9_]*/g);return t||[]}function zr(e,t){const n=(e||"").trim();return n?qh(n).every(i=>t.includes(i)):!0}function Uh(){Dt=Hr(Dt,{placeholder:"x",onChange:i=>{const s=i.trim();if(!zr(s,["x"])){Dt.value=Pn||"x";return}Pn=s||"x",Ht()}}),kt=Hr(kt,{placeholder:"x",onChange:i=>{const s=i.trim();if(!zr(s,Fe==="colormap_polar"?["r","phi"]:["x","y"])){const r=Fe==="colormap_polar"?Yn||"r":Xn||"x";kt.value=r;return}Fe==="colormap_polar"?Yn=s||"r":Xn=s||"x",Ht()}});const e=bo==="light",t=e?"#000000":"#ffffff",n=e?"#ffffff":"#000000",o=e?"#000000":"#ffffff";if(Dt.style.display="none",kt.style.display="none",!(!jt||!H.colorModeIcons.length)){if(At==="colormap"){const i=H.colorModeIcons.find(s=>s.group==="edge");if(i){Dt.value=Pn||"x";const s=cs.edge||la,a=i.x+i.width+po+s+ra;Dt.style.left=`${a}px`,Dt.style.top=`${i.y+i.height/2-In/2}px`,Dt.style.width=`${ei}px`,Dt.style.height=`${In}px`,Dt.style.lineHeight=`${In}px`,Dt.style.background=n,Dt.style.border=`${ti}px solid ${o}`,Dt.style.color=t,Dt.style.display="block"}}if(Fe==="colormap_xy"||Fe==="colormap_polar"){const i=H.colorModeIcons.find(s=>s.group==="face");if(i){const s=Fe==="colormap_polar"?Yn:Xn;kt.value=s||(Fe==="colormap_polar"?"r":"x");const a=cs.face||la,r=i.x+i.width+po+a+ra;kt.style.left=`${r}px`,kt.style.top=`${i.y+i.height/2-In/2}px`,kt.style.width=`${ei}px`,kt.style.height=`${In}px`,kt.style.lineHeight=`${In}px`,kt.style.background=n,kt.style.border=`${ti}px solid ${o}`,kt.style.color=t,kt.style.display="block"}}}}function jh(e,t,n){const o=Us(e),i=Us(t),s=Math.max(0,Math.min(1,n)),a=Math.round(o.r*(1-s)+i.r*s),r=Math.round(o.g*(1-s)+i.g*s),c=Math.round(o.b*(1-s)+i.b*s),l=o.a;return`rgba(${a}, ${r}, ${c}, ${l})`}function Kh(){for(const[e,t]of So.entries())Ua.has(e)||(t.remove(),So.delete(e))}function zs(e){return{x:e.x*Ve/oe.scale,y:-e.y*Ve/oe.scale}}function vo(e){return qe.find(t=>t.id===e)}function Ja(e,t,n,o=null){if(!e||!t||!n)return null;const i={x:n.x-t.x,y:n.y-t.y},s=Math.hypot(i.x,i.y);if(s<1e-6)return null;let a={x:-i.y/s,y:i.x/s};if(o&&o.length>=3){const r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},c=o.reduce((h,f)=>({x:h.x+f.x,y:h.y+f.y}),{x:0,y:0});c.x/=o.length,c.y/=o.length;const l={x:c.x-r.x,y:c.y-r.y};a.x*l.x+a.y*l.y>0&&(a={x:-a.x,y:-a.y})}return{normalData:a,edgeLen:s}}function Cl(e){const t=U.find(l=>ne(l)===e);if(!t)return zs(Xo);const n=q(t.id1),o=q(t.id2);if(!n||!o)return zs(Xo);const i=Z.filter(l=>{const d=l.vertexIds||[];for(let h=0;h<d.length;h++){const f=d[h],u=d[(h+1)%d.length];if(f===t.id1&&u===t.id2||f===t.id2&&u===t.id1)return!0}return!1});let s=null;i.length===1&&(s=(i[0].vertexIds||[]).map(d=>q(d)).filter(Boolean));const a=Ja(t,n,o,s);if(!a)return zs(Xo);const r=a.normalData,c=Xo*Ve/oe.scale;return{x:r.x*c,y:r.y*c}}function xa(e,t){const n=U.find(l=>ne(l)===e);if(!n||!t)return null;const o=q(n.id1),i=q(n.id2);if(!o||!i)return null;const s=Ja(n,o,i);if(!s)return null;const{normalData:a,edgeLen:r}=s;return r<1e-6?null:(t.x*a.x+t.y*a.y)/r}function Sa(e){const t=q(e);if(!t)return{offset:zs(Ji),align:"left",baseline:"middle"};const o=hn(e,U).map(f=>q(f)).filter(Boolean);let i={x:1,y:0};if(o.length===2){const f={x:o[0].x-t.x,y:o[0].y-t.y},u={x:o[1].x-t.x,y:o[1].y-t.y},g=Math.hypot(f.x,f.y),p=Math.hypot(u.x,u.y);if(g>1e-6&&p>1e-6){const y={x:f.x/g,y:f.y/g},S={x:u.x/p,y:u.y/p},m={x:y.x+S.x,y:y.y+S.y},x=Math.hypot(m.x,m.y);x>1e-6?i={x:-m.x/x,y:-m.y/x}:i={x:-y.y,y:y.x}}}const s=xe(t),a=xe({x:t.x+i.x,y:t.y+i.y});let r={x:a.x-s.x,y:a.y-s.y};const c=Math.hypot(r.x,r.y);c>1e-6?(r.x/=c,r.y/=c):r={x:1,y:0};const l=Math.hypot(Ji.x,Ji.y),d={x:r.x*l,y:r.y*l},h=r.x>=0?"left":"right";return{offset:zs(d),align:h,baseline:"middle"}}function Si(e){return pn.find(t=>t.id===e)||null}function Ii(){return Si(Eo)||pn[0]||kn}function Ia(e){e&&(Eo=e,Ht())}function Jh(){const e=new Set(ie),t=new Set(se),n=new Set(le),o=new Set,i=s=>{const a=s||kn.id;o.add(a)};return e.size>0&&U.forEach(s=>{const a=ne(s);e.has(a)&&i(s.interpolationStyleId)}),t.size>0&&Z.forEach(s=>{const a=ge(s);a&&t.has(a)&&i(s.interpolationStyleId)}),e.size===0&&t.size===0&&n.size>0&&(U.forEach(s=>{(n.has(s.id1)||n.has(s.id2))&&i(s.interpolationStyleId)}),Z.forEach(s=>{s.vertexIds&&s.vertexIds.some(a=>n.has(a))&&i(s.interpolationStyleId)})),o.size===1?[...o][0]:null}function Zh(e){if(!e)return;const t=new Set(ie),n=new Set(se),o=new Set(le);let i=!1;t.size>0&&U.forEach(s=>{const a=ne(s);t.has(a)&&(s.interpolationStyleId=e,i=!0)}),n.size>0&&Z.forEach(s=>{const a=ge(s);a&&n.has(a)&&(s.interpolationStyleId=e,i=!0)}),t.size===0&&n.size===0&&o.size>0&&(U.forEach(s=>{(o.has(s.id1)||o.has(s.id2))&&(s.interpolationStyleId=e,i=!0)}),Z.forEach(s=>{s.vertexIds&&s.vertexIds.some(a=>o.has(a))&&(s.interpolationStyleId=e,i=!0)})),i&&Ht()}function Qh(){const e=new Set(ie),t=new Set(se),n=new Set(le);let o=!1;e.size>0&&U.forEach(i=>{const s=ne(i);e.has(s)&&(delete i.interpolationStyleId,o=!0)}),t.size>0&&Z.forEach(i=>{const s=ge(i);s&&t.has(s)&&(delete i.interpolationStyleId,o=!0)}),e.size===0&&t.size===0&&n.size>0&&(U.forEach(i=>{(n.has(i.id1)||n.has(i.id2))&&(delete i.interpolationStyleId,o=!0)}),Z.forEach(i=>{i.vertexIds&&i.vertexIds.some(s=>n.has(s))&&(delete i.interpolationStyleId,o=!0)})),o&&Ht()}function Ms(e){const t=Ii();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function El(e){if(!e)return null;const t=new Map;Oe&&Array.isArray(Se)&&Se.length>0&&Se.forEach(o=>{if(!o||!o.id)return;const i=o.originalId||o.id;t.set(i,o)});const n=o=>t.has(o)?t.get(o):q(o);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const o=n(e.anchorId);return o?{anchor:{x:o.x,y:o.y}}:null}if(e.anchorType==="edge"){const o=U.find(p=>ne(p)===e.anchorId);if(!o)return null;const i=n(o.id1),s=n(o.id2);if(!i||!s)return null;const a={x:(i.x+s.x)/2,y:(i.y+s.y)/2},r=Math.atan2(s.y-i.y,s.x-i.x),c=xe(i),l=xe(s),d=Math.atan2(l.y-c.y,l.x-c.x),h=Z.filter(p=>{const y=p.vertexIds||[];for(let S=0;S<y.length;S++){const m=y[S],x=y[(S+1)%y.length];if(m===o.id1&&x===o.id2||m===o.id2&&x===o.id1)return!0}return!1});let f=null;h.length===1&&(f=(h[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=Ja(o,i,s,f),g=u?u.normalData:null;return{anchor:a,edgeAngleRad:r,edgeAngleRadScreen:d,edgeNormalData:g,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const o=Z.find(a=>ge(a)===e.anchorId);if(!o)return null;const i=o.vertexIds.map(a=>n(a)).filter(a=>a&&a.type==="regular");return i.length<3?null:{anchor:{x:i.reduce((a,r)=>a+r.x,0)/i.length,y:i.reduce((a,r)=>a+r.y,0)/i.length}}}return null}function wl(){return ee?.finalSnapResult?.finalDelta?ee.finalSnapResult.finalDelta:ee?.textFinalDelta?ee.textFinalDelta:Se.length>0&&ce.length>0?{x:Se[0].x-ce[0].x,y:Se[0].y-ce[0].y}:null}function Tl(e){const t=El(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=Cl(e.anchorId);const l=xa(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let o={x:t.anchor.x+n.x,y:t.anchor.y+n.y},i=e.rotationDeg||0,s=e.scale||1,a="center",r="middle";if(e.anchorType==="vertex"){const l=Sa(e.anchorId);a=e.vertexAlign||l.align||"left",r=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(a="center",r="middle",typeof t.edgeAngleRadScreen=="number"?i+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(i+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(a="left",r="top");e.anchorType==="edge"&&(i>90||i<-90)&&(i+=180,i>180&&(i-=360),r="top");const c=ye.includes(e.id);if(Oe&&c)if(Ye){const{center:l,rotation:d,scale:h,directionalScale:f,startVector:u}=Ye;o=ze(o,l,d,h,f,u),i-=d*(180/Math.PI),s*=h}else{const l=wl();l&&(o={x:o.x+l.x,y:o.y+l.y})}return{id:e.id,content:e.content||"",position:o,rotationDeg:i,scale:s,textAlign:a,textBaseline:r}}function ef(e){const t=tt.getBoundingClientRect(),n=[];qe.forEach(o=>{const i=Tl(o);if(!i){n.push(o.id);return}const s=xe(i.position),a=`text-${i.id}`,r=ye.includes(o.id),c=o.color||Pe(It)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",d=jh(c,l,.35);xt({id:a,content:i.content,x:s.x,y:s.y,color:r?d:c,fontSize:(o.fontSize||Ga)*i.scale,options:{textAlign:i.textAlign,textBaseline:i.textBaseline,rotation:i.rotationDeg}});const h=So.get(a);if(h){const f=h.contentEl||h;f.style.outline="none",f.style.textShadow="none",f.style.color=r?d:c;const g=(h.katexEl||f).getBoundingClientRect();o.screenBounds={left:g.left-t.left,top:g.top-t.top,right:g.right-t.left,bottom:g.bottom-t.top}}}),n.length>0&&(qe=qe.filter(o=>!n.includes(o.id)),ye=ye.filter(o=>!n.includes(o)))}function Pl(e){for(let t=qe.length-1;t>=0;t--){const n=qe[t],o=n.screenBounds;if(o&&e.x>=o.left&&e.x<=o.right&&e.y>=o.top&&e.y<=o.bottom)return n}return null}function _l(e,t=""){if(!rs.inputEl){const s=document.createElement("input");s.type="text",s.style.position="absolute",s.style.zIndex="5",s.style.pointerEvents="auto",s.style.fontFamily="KaTeX_Main, Times New Roman, serif",s.style.fontSize=`${e.fontSize||Ga}px`,s.style.border="1px solid rgba(255, 255, 255, 0.4)",s.style.borderRadius="4px",s.style.padding="2px 4px",s.style.background="rgba(0, 0, 0, 0.6)",s.style.color="#ffffff",s.style.outline="none",s.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),zo(!0)):a.key==="Escape"&&(a.preventDefault(),zo(!1))}),s.addEventListener("mouseleave",()=>zo(!0)),s.addEventListener("blur",()=>zo(!0)),tt.appendChild(s),rs.inputEl=s}const n=Tl(e);if(!n)return;const o=xe(n.position),i=rs.inputEl;i.value=t||e.content||"",i.style.left=`${o.x}px`,i.style.top=`${o.y}px`,i.style.transform="translate(-10%, -10%)",i.style.display="block",rs.activeId=e.id,i.focus(),i.setSelectionRange(i.value.length,i.value.length)}function zo(e){const t=rs.inputEl;if(!t)return;const n=rs.activeId;if(n&&e){const o=vo(n);if(o){Ge();const i=t.value.trim();!i&&o.isDraft?(qe=qe.filter(s=>s.id!==o.id),ye=ye.filter(s=>s!==o.id)):(o.content=i||o.content||"",delete o.isDraft)}}t.style.display="none",rs.activeId=null}function tf(e=""){let t="canvas",n=null,o={x:0,y:0},i=Ee(K);if(gn)t="vertex",n=gn,o=Sa(n).offset;else if(Tn)t="edge",n=Tn,o=Cl(n);else if(yn)t="face",n=yn;else{const a=zs(zh);i={x:i.x+a.x,y:i.y+a.y}}const s={id:Nt(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?i:null,offset:t==="canvas"?{x:0,y:0}:o,rotationDeg:0,scale:1,fontSize:Ga,color:Pe(It),isDraft:!0};if(t==="vertex"){const a=Sa(n);s.vertexAlign=a.align,s.vertexBaseline=a.baseline}qe.push(s),ye=[s.id],_l(s,e)}function Za(e,t,n){if(n){const o=Ie.indexOf(e);if(o>-1){Ie.splice(o,1),Xe===e&&(Xe=Ie.length>0?Ie[Ie.length-1]:null);return}Ie.push(e),Xe=e;return}Ie.includes(e)||Ie.push(e),Xe=e}function Ko(e){const t=Wn(e,st,j.interval1,rn,!0);if(ae.forEach(o=>{o.type==="regular"&&t.push({x:o.x,y:o.y,isGridVertex:!1})}),U.forEach(o=>{const i=q(o.id1),s=q(o.id2);if(i&&s&&i.type==="regular"&&s.type==="regular"){const a={x:(i.x+s.x)/2,y:(i.y+s.y)/2,isGridVertex:!1};t.push(a)}}),t.length===0)return null;const n=(o,i)=>(o.x-i.x)**2+(o.y-i.y)**2;return t.reduce((o,i)=>{const s=n(e,o);return n(e,i)<s?i:o})}function Bt(){const e=new Set(ae.map(a=>a.id)),t=new Set,n=[];for(const a of e)if(!t.has(a)){const r=ko(a),c=new Set(r);n.push(c),r.forEach(l=>t.add(l))}const o=a=>[...a].sort().join(","),i=[],s=new Set;pa.forEach(a=>{const r=o(a);for(let c=0;c<n.length;c++){if(s.has(c))continue;const l=n[c];if(r===o(l)){i.push(l),s.add(c);break}}});for(let a=0;a<n.length;a++)s.has(a)||i.push(n[a]);pa=i}function nf(e,t,n=!1,o=[],i=1){if(n&&o.length>0&&[...e].some(l=>o.some(d=>d.id===l)))return;const s=Z.filter(c=>c.vertexIds.every(l=>e.has(l)));Zd(Me,{allFaces:s,allEdges:U,facesVisible:Ln,isDragConfirmed:!1,dragPreviewVertices:[],transformIndicatorData:null,initialDragVertexStates:[],colors:t,initialCoordSystemStates:new Map,interpolationStyle:Ii(),getInterpolationStyleById:Si,faceColorMode:Fe,edgeColorMode:At,faceColorExpression:Xn,faceColorPolarExpression:Yn,edgeColorExpression:Pn},xe,q);const a=U.filter(c=>e.has(c.id1)&&e.has(c.id2));dh(Me,{allEdges:a,selectedEdgeIds:ie,hoveredEdgeId:Tn,isDragConfirmed:!1,dragPreviewVertices:[],colors:t,edgesVisible:fi,snappedEdgeIds:bs,currentAltPressed:_t,interpolationStyle:Ii(),getInterpolationStyleById:Si,edgeColorMode:At,edgeColorExpression:Pn},xe,q,ne),ae.filter(c=>e.has(c.id)).forEach(c=>{let l=!1;gt.has(c.id)&&gt.get(c.id).some(h=>h.copyIndex===void 0)&&(l=!0),ri(Me,c,{selectedVertexIds:le,selectedCenterIds:Ie,activeCenterId:Xe,colors:t,verticesVisible:hi,isHovered:gn===c.id,isSnapped:l,snappedVertexIds:gt,isDragConfirmed:!1,dragPreviewVertices:[],currentAltPressed:_t},xe)})}function Po(e,t,n,o=!1,i=null){const s=Ee(t),a=i||or(e.id),r=Ea/oe.scale,c=Ta/oe.scale,l=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j?.interval1,d=Be*2/oe.scale,h=Be/oe.scale,f=Be*2/oe.scale,u=Be*2/oe.scale,g=Ue&&Ce.length>=1;if(n){const p=[];let y=!1;for(const x of ae)if(x.id!==e.id&&x.type==="regular"&&J(s,x)<r){y=!0;break}if(!y)for(const x of U){const I=q(x.id1),b=q(x.id2);if(I&&b&&I.type==="regular"&&b.type==="regular"&&bt(s,I,b).distance<c){y=!0;break}}if(g){if(ae.forEach(M=>{if(M.id!==e.id&&M.type==="regular"){const E=J(s,M);p.push({priority:1,dist:E,pos:M,snapType:"vertex",targetVertex:M})}}),U.forEach(M=>{const E=q(M.id1),N=q(M.id2);E&&N&&E.type==="regular"&&N.type==="regular"&&E.id!==e.id&&N.id!==e.id&&bt(s,E,N).distance<h*1.5&&qr.forEach(D=>{const F={x:E.x+D*(N.x-E.x),y:E.y+D*(N.y-E.y)},R=J(s,F);p.push({priority:2,dist:R,pos:F,snapType:"edge_fraction",targetEdge:M,fraction:D})})}),st!=="none"&&l){const M=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j.interval1;M&&Wn(s,st,M,rn,!0).forEach(N=>{const _=J(s,N);p.push({priority:3,dist:_,pos:N,snapType:"grid"})})}const x=a.currentSegmentReferenceA_for_display,I=a.currentSegmentReferenceD,b=new Set([0,...La.flatMap(M=>[M,-M])]),C=Array.from(b).sort((M,E)=>M-E).map(M=>({factor:M,angle:Mn(a.offsetAngleRad+M*x),turn:nt(M*x)})),w=J(e,s),P=[];if([0,...Vn].forEach(M=>P.push({factor:M,dist:M*I})),I>re){const M=w/I,E=Math.round(M),N=Math.round(M*2)/2;[E,N].forEach(_=>{_>=0&&!P.some(D=>Math.abs(D.factor-_)<re)&&P.push({factor:_,dist:_*I})})}if(P.sort((M,E)=>M.dist-E.dist),C.length>0&&P.length>0)for(const M of C)for(const E of P){if(E.dist<re&&(M.factor!==0||P.length>1))continue;const N={x:e.x+E.dist*Math.cos(M.angle),y:e.y+E.dist*Math.sin(M.angle)},_=J(s,N);p.push({priority:4,dist:_,pos:N,snapType:"geometric",lengthSnapFactor:E.factor,angleSnapFactor:M.factor,angleTurn:M.turn})}}else if(!y&&st!=="none"&&l){const x=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j.interval1;if(x){const I=Wn(s,st,x,rn,!0);if(I.length>0){const b=I.sort((v,C)=>J(s,v)-J(s,C))[0];p.push({priority:3,dist:J(s,b),pos:b,snapType:"grid"})}}}let S=null;if(p.length>0)if(!g)S=p[0];else{let x=!1;for(let I=1;I<=3;I++){let b;I===1?b=d:I===2?b=h:b=f;const v=p.filter(C=>C.priority===I&&C.dist<b);if(v.length>0){S=v.sort((C,w)=>C.dist-w.dist)[0],x=!0;break}}if(!x){const I=p.filter(b=>b.priority===4);if(I.length>0){const b=I.sort((v,C)=>v.dist-C.dist)[0];b.dist<u&&(S=b)}}S||(S=p.sort((I,b)=>I.dist-b.dist)[0])}if(S){const x=Math.atan2(S.pos.y-e.y,S.pos.x-e.x)||0,I=parseFloat(J(e,S.pos).toFixed(10));let b=null,v=null;if(S.snapType==="grid"&&l){const w=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j.interval1;if(w){const P=S.pos.x-e.x,T=S.pos.y-e.y,M=w*1e-5;if(st==="triangular"){const E=w*wa,N=T/E,_=Math.round(N),D=_%2!==0?w/2:0,F=(P-D)/w;if(Math.abs(N-_)<M/E&&Math.abs(F-Math.round(F))<M/w){const R=_,B=Math.round(F);b=B*B+B*R+R*R,v=w}}else{const E=P/w,N=T/w;if(Math.abs(E-Math.round(E))<M/w&&Math.abs(N-Math.round(N))<M/w){const _=Math.round(E),D=Math.round(N);b=_*_+D*D,v=w}}}}let C=S.angleTurn!=null?S.angleTurn:nt(x-a.offsetAngleRad);return{x:parseFloat(S.pos.x.toFixed(vr)),y:parseFloat(S.pos.y.toFixed(vr)),angle:x*(180/Math.PI),distance:I,snapped:!0,snapType:S.snapType,targetEdge:S.targetEdge,fraction:S.fraction,targetVertex:S.targetVertex,gridSnapped:S.snapType==="grid",lengthSnapFactor:S.lengthSnapFactor||null,angleSnapFactor:S.angleSnapFactor||null,angleTurn:C,gridToGridSquaredSum:b,gridInterval:v}}const m=Math.atan2(s.y-e.y,s.x-e.x)||0;return{x:s.x,y:s.y,angle:m*(180/Math.PI),distance:J(e,s),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:nt(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const p=[];for(const m of ae)if(m.id!==e.id&&m.type==="regular"){const x=J(s,m);x<r&&p.push({priority:1,dist:x,pos:m,snapType:"vertex",targetVertex:m})}for(const m of U){const x=q(m.id1),I=q(m.id2);if(x&&I&&x.type==="regular"&&I.type==="regular"){const b=bt(s,x,I);b.distance<c&&b.onSegmentStrict&&p.push({priority:2,dist:b.distance,pos:{x:b.x,y:b.y},snapType:"edge",targetEdge:m})}}let y=null;if(p.length>0){y=p.sort((x,I)=>x.priority!==I.priority?x.priority-I.priority:x.dist-I.dist)[0];const m=y.priority===1?d:h;y.dist>m&&(y=null)}if(y){const m=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:m*(180/Math.PI),distance:J(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:nt(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const S=Math.atan2(s.y-e.y,s.x-e.x)||0;return{x:s.x,y:s.y,angle:S*(180/Math.PI),distance:J(e,s),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:nt(S-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function sf(e,t,n){const o=[],i=Ea/oe.scale,s=Ta/oe.scale;if(ae.forEach(a=>{if(a.id!==e.id&&a.type==="regular"){const r=J(t,a);r<i&&o.push({priority:1,dist:r,pos:a,snapType:"vertex",targetVertex:a})}}),U.forEach(a=>{if(a.id1===e.id||a.id2===e.id)return;const r=q(a.id1),c=q(a.id2);if(r&&c&&r.type==="regular"&&c.type==="regular"){const l=bt(t,r,c);l.distance<s&&l.onSegmentStrict&&o.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:a})}}),o.length>0){const a=o.sort((r,c)=>r.priority!==c.priority?r.priority-c.priority:r.dist-c.dist)[0];return{pos:a.pos,snapped:!0,snapType:a.snapType,targetEdge:a.targetEdge,targetVertex:a.targetVertex}}return{pos:t,snapped:!1}}function of(){ue=ue.map(e=>e.type==="color"?{...e,value:Nd(e.value)}:e)}function af(){H.toolbarButton={id:"toolbar-button",x:je,y:je,width:Gc,height:Wc,type:"menuButton"}}function Al(){const e=fe.height/Ve;H.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:Le,height:e,type:"toolbar"};const t=je;let n=H.toolbarButton.y+H.toolbarButton.height+qc;H.colorToolButton={id:"color-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,H.colorModeToolButton={id:"color-mode-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,H.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,H.transformToolButton={id:"transform-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,H.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,H.sessionsToolButton={id:"sessions-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut}}function at(){H.colorSwatches=[],H.colorTargetIcons=[];const e=zn+no,t=Le+je,n=H.colorToolButton.y+ut/2,o=_a,s=n-o/2+-2;let a=t;H.removeColorButton={id:"remove-color-button",type:"button",x:a+(e-o)/2,y:s,width:o,height:o},a+=e,ue.forEach((l,d)=>{H.colorSwatches.push({id:`swatch-${d}`,type:"colorSwatch",x:a+(e-o)/2,y:s,width:o,height:o,index:d,item:l}),a+=e}),H.addColorButton={id:"add-color-button",type:"button",x:a+(e-o)/2,y:s,width:o,height:o},Object.entries(he).forEach(([l,d])=>{const h=o*.75,f=H.colorSwatches.find(u=>u.index===d);f&&H.colorTargetIcons.push({id:`target-icon-${l}`,type:"colorTargetIcon",target:l,x:f.x+(f.width-h)/2,y:f.y-h-5,width:h,height:h})});const r=new Map(H.colorTargetIcons.map(l=>[l.target,l]));Object.keys(he).forEach(l=>{const d=vl(l);if(d!==l){const h=r.get(d),f=r.get(l);h&&f&&(f.x=h.x,f.y=h.y,f.width=h.width,f.height=h.height)}});const c=[...H.colorSwatches,H.removeColorButton,H.addColorButton,...H.colorTargetIcons].filter(Boolean);if(c.length>0){const l=Math.min(...c.map(u=>u.y)),d=Math.max(...c.map(u=>u.x+u.width)),h=Math.max(...c.map(u=>u.y+u.height)),f=5;H.colorPaletteBounds={x:Le,y:l-f,width:d-Le+f,height:h-l+f*2}}else H.colorPaletteBounds=null}function Qa(){if(H.colorModeIcons=[],!H.colorModeToolButton)return;const e=Le+je,t=H.colorModeToolButton.y+ut/2,n=_a,i=t-n/2+-2,s=zn+no,a=(s-n*2)/2,r=cs.edge||la,c=po+r+ra+ei+Uc,l=[{id:"edge-color-mode",group:"edge"},{id:"face-color-mode",group:"face"}];let d=e;l.forEach(f=>{const u=f.group==="face"&&At==="colormap"?Math.max(0,c-a):0;H.colorModeIcons.push({id:f.id,type:"colorModeIcon",group:f.group,x:d+(s-n)/2,y:i,width:n,height:n}),d+=s+u});const h=H.colorModeIcons.filter(Boolean);if(h.length>0){const f=Math.min(...h.map(y=>y.y)),u=Math.max(...h.map(y=>y.x+y.width)),g=Math.max(...h.map(y=>y.y+y.height)),p=5;H.colorModePanelBounds={x:Le,y:f-p,width:u-Le+p,height:g-f+p*2}}else H.colorModePanelBounds=null}function Dl(){if(H.interpolationIcons=[],!H.interpolationToolButton)return;const e=Le+je,t=H.interpolationToolButton.y+ut/2,n=zn,i=t-n/2+-2,s=zn+no;let a=e;H.interpolationIcons.push({id:"interpolation-remove",type:"interpolationRemove",x:a+(s-n)/2,y:i,width:n,height:n}),a+=s,pn.forEach(c=>{H.interpolationIcons.push({id:`interpolation-${c.id}`,type:"interpolationStyle",styleId:c.id,x:a+(s-n)/2,y:i,width:n,height:n}),a+=s}),H.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:a+(s-n)/2,y:i,width:n,height:n});const r=H.interpolationIcons.filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;H.interpolationPanelBounds={x:Le,y:c-h,width:l-Le+h,height:d-c+h*2}}else H.interpolationPanelBounds=null}function rf(){if(H.displayIcons=[],!H.visibilityToolButton)return;const e=zn+no,t=Le+je,n=H.visibilityToolButton.y+ut/2,o=Jc,s=n-o/2+-2;let a=t;if(["coords","grid","angles","distances","theme"].forEach(c=>{H.displayIcons.push({id:`display-icon-${c}`,group:c,x:a+(e-o)/2,y:s,width:o,height:o}),a+=e}),H.displayIcons.length>0){const c=H.displayIcons[0],l=H.displayIcons[H.displayIcons.length-1],d=5;H.displayPanelBounds={x:Le,y:c.y-d,width:l.x+l.width-Le+d,height:c.height+d*2}}else H.displayPanelBounds=null}function Ri(){if(H.sessionIcons=[],!H.sessionsToolButton)return;const e=Le+je,t=H.sessionsToolButton.y+ut/2,n=_a,i=t-n/2+-2,s=zn+no;let a=e;H.removeSessionButton={id:"remove-session-button",type:"button",x:a+(s-n)/2,y:i,width:n,height:n},a+=s,Te.forEach((c,l)=>{H.sessionIcons.push({id:`session-${c.id}`,type:"sessionIcon",x:a+(s-n)/2,y:i,width:n,height:n,index:l,session:c}),a+=s}),H.addSessionButton={id:"add-session-button",type:"button",x:a+(s-n)/2,y:i,width:n,height:n};const r=[...H.sessionIcons,H.removeSessionButton,H.addSessionButton].filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;H.sessionsPanelBounds={x:Le,y:c-h,width:l-Le+h,height:d-c+h*2}}else H.sessionsPanelBounds=null}function lf(){H.transformIcons=[];const e=zn,t=e+no,n=Le+je,i=H.transformToolButton.y+ut/2-e/2,s=[Qt,On,an,Zn];let a=n;if(s.forEach(r=>{H.transformIcons.push({id:`transform-icon-${r}`,type:r,x:a+(t-e)/2,y:i,width:e,height:e}),a+=t}),H.transformIcons.length>0){const r=H.transformIcons[0],c=H.transformIcons[H.transformIcons.length-1],l=5;H.transformPanelBounds={x:Le,y:r.y-l,width:c.x+c.width-Le+l,height:r.height+l*2}}else H.transformPanelBounds=null}function er(e){e<0||e>=ue.length||ue.length<=1||(ue.splice(e,1),Object.keys(he).forEach(t=>{he[t]>e?he[t]--:he[t]===e&&(he[t]=Math.min(e,ue.length-1))}),ki(),at())}function cf(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}ue.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(ue.push(e),ot&&at())}function kl(e,t=[]){const n=q(e);if(!n)return null;for(let o=U.length-1;o>=0;o--){const i=U[o],s=ne(i);if(t.includes(s))continue;let a=null;if(i.id1===e?a=i.id2:i.id2===e&&(a=i.id1),a){const r=q(a);if(r){const c=n.x-r.x,l=n.y-r.y;return{p1:r,p2:n,angleRad:Math.atan2(l,c),length:Math.sqrt(c*c+l*l),edgeId:s}}}}return null}function Ge(){const e=Ao();ue.length,ue[0]?.value,ae.length,ft.push(e),ft.length>Ra&&ft.shift(),Hn=[],Ht()}function tr(e){const t=H.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!ls)return!1;const n=[];H.mainToolbar&&n.push(H.mainToolbar),ot&&H.colorPaletteBounds&&n.push(H.colorPaletteBounds),nn&&H.interpolationPanelBounds&&n.push(H.interpolationPanelBounds),vn&&H.transformPanelBounds&&n.push(H.transformPanelBounds),un&&H.displayPanelBounds&&n.push(H.displayPanelBounds),pt&&H.sessionsPanelBounds&&n.push(H.sessionsPanelBounds),jt&&H.colorModePanelBounds&&n.push(H.colorModePanelBounds);for(const i of n)if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;const o=[];ot&&H.colorPaletteBounds&&o.push(H.colorPaletteBounds),nn&&H.interpolationPanelBounds&&o.push(H.interpolationPanelBounds),vn&&H.transformPanelBounds&&o.push(H.transformPanelBounds),un&&H.displayPanelBounds&&o.push(H.displayPanelBounds),pt&&H.sessionsPanelBounds&&o.push(H.sessionsPanelBounds),jt&&H.colorModePanelBounds&&o.push(H.colorModePanelBounds),o.sort((i,s)=>i.y-s.y);for(let i=0;i<o.length-1;i++){const s=o[i],a=o[i+1],r=s.y+s.height,c=a.y;if(e.y>r&&e.y<c){const l=Le,d=s.x+s.width-l,h=a.x+a.width-l,f=Math.min(d,h),u=l+f;if(e.x<Le||e.x>=l&&e.x<=u)return!0}}return!1}function _o(e){ae=JSON.parse(JSON.stringify(e.vertices)),U=JSON.parse(JSON.stringify(e.edges)),Z=JSON.parse(JSON.stringify(e.faces||[])),qe=JSON.parse(JSON.stringify(e.textElements||[])),le=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),ie=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),se=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),ye=JSON.parse(JSON.stringify(e.selectedTextIds||[])),Ie=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),He=JSON.parse(JSON.stringify(e.activeColorTargets||[])),pn=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(kn))],Eo=e.activeInterpolationStyleId||pn[0]?.id||kn.id,ue=e.allColors?JSON.parse(JSON.stringify(e.allColors)):Ei.map(n=>typeof n=="string"?{type:"color",value:n}:n),he=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[_e]:0,[Re]:1,[we]:2,[It]:0},At=e.edgeColorMode||"fixed",Fe=e.faceColorMode||"fixed",Pn=e.edgeColorExpression||"x",Xn=e.faceColorExpression||"x",Yn=e.faceColorPolarExpression||"r",he[It]===void 0&&(he[It]=0),ki(),Ml(),Xe=e.activeCenterId!==void 0?e.activeCenterId:null,Ue=e.isDrawingMode!==void 0?e.isDrawingMode:!1,it=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,Lt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,qn=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,dt=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,Rn=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,Un=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,Hs=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,$t=!1,Oe=!1,jn=!1,fs=!1,Se=[],gi=null,mn=-1,de={targetId:null,type:null,count:0,timestamp:0},fe.style.cursor="crosshair",ot&&at();const t=Ao();ft.length===0&&ft.push(t),Ht()}function Ao(){return{vertices:JSON.parse(JSON.stringify(ae)),edges:JSON.parse(JSON.stringify(U)),faces:JSON.parse(JSON.stringify(Z)),textElements:JSON.parse(JSON.stringify(qe)),selectedVertexIds:JSON.parse(JSON.stringify(le)),selectedEdgeIds:JSON.parse(JSON.stringify(ie)),selectedFaceIds:JSON.parse(JSON.stringify(se)),selectedTextIds:JSON.parse(JSON.stringify(ye)),selectedCenterIds:JSON.parse(JSON.stringify(Ie)),activeColorTargets:JSON.parse(JSON.stringify(He)),interpolationStyles:JSON.parse(JSON.stringify(pn)),activeInterpolationStyleId:Eo,colorAssignments:JSON.parse(JSON.stringify(he)),edgeColorMode:At,faceColorMode:Fe,edgeColorExpression:Pn,faceColorExpression:Xn,faceColorPolarExpression:Yn,allColors:JSON.parse(JSON.stringify(ue)),activeCenterId:Xe,isDrawingMode:Ue,previewLineStartVertexId:it,frozenReference_A_rad:Lt,frozenReference_A_baseRad:qn,frozenReference_D_du:dt,frozenReference_Origin_Data:Rn,frozenReference_D_g2g:Un,deletedFaceIds:new Set(Hs)}}function Rl(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function df(){try{const e=new URLSearchParams(window.location.search);return Rl(e.get("user"))}catch{return""}}function Ll(){if(tn)return tn;const e=df();if(e){tn=e;try{localStorage.setItem(Zi,tn)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return tn}try{tn=localStorage.getItem(Zi)}catch{tn=null}if(!tn){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}tn=Rl(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(Zi,tn)}catch(o){console.warn("Could not persist user id to localStorage.",o)}}return tn}function Ol(){const e=Ll();return`${Wa}.state.v${ci}.${e}`}function Nl(){const e=Ll();return`${Wa}.sessions.v${ci}.${e}`}function Bl(){return{vertices:[],edges:[],faces:[],textElements:[],selectedVertexIds:[],selectedEdgeIds:[],selectedFaceIds:[],selectedTextIds:[],selectedCenterIds:[],activeColorTargets:[],interpolationStyles:[JSON.parse(JSON.stringify(kn))],activeInterpolationStyleId:kn.id,colorAssignments:{[_e]:0,[Re]:1,[we]:2,[It]:0},edgeColorMode:"fixed",faceColorMode:"fixed",edgeColorExpression:"x",faceColorExpression:"x",faceColorPolarExpression:"r",allColors:Ei.map(e=>typeof e=="string"?{type:"color",value:e}:e),activeCenterId:null,isDrawingMode:!1,previewLineStartVertexId:null,frozenReference_A_rad:null,frozenReference_A_baseRad:null,frozenReference_D_du:null,frozenReference_Origin_Data:null,frozenReference_D_g2g:null,deletedFaceIds:[]}}function Do(){if(!Te.length)return;const e=Te[Xt];e&&(e.state=sr())}function nr(e,t=""){return{id:Nt(),name:t,state:JSON.parse(JSON.stringify(e))}}function sr(){const e=Ao();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function Fl(){if(!window.localStorage)return;const e=Ol(),t={version:ci,savedAt:Date.now(),state:sr()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}if(Te.length>0){Do();const n=Nl(),o={version:ci,savedAt:Date.now(),activeSessionIndex:Xt,sessions:Te.map(i=>({...i,state:JSON.parse(JSON.stringify(i.state))}))};try{localStorage.setItem(n,JSON.stringify(o))}catch(i){console.warn("Could not persist sessions to localStorage.",i)}}}function Ht(){window.localStorage&&(Yo&&clearTimeout(Yo),Yo=setTimeout(()=>{Yo=null,Fl()},300))}function hf(){if(!window.localStorage)return!1;const e=Ol();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(_o(n.state),Bt(),Il=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function ff(){if(!window.localStorage)return!1;const e=Nl();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!Array.isArray(n.sessions)||n.sessions.length===0?!1:(Te=n.sessions.map(o=>({id:o.id||Nt(),name:o.name||"",state:o.state||Bl()})),Xt=Math.min(Math.max(n.activeSessionIndex||0,0),Te.length-1),yt=Xt,ft=[],Hn=[],_o(Te[Xt].state),Bt(),Il=!0,!0)}catch(t){return console.warn("Could not load sessions from localStorage.",t),!1}}function uf(){const e=sr();Te=[nr(e,"World 1")],Xt=0,yt=0}function ws(e){e<0||e>=Te.length||(Do(),Xt=e,yt=e,ft=[],Hn=[],_o(Te[Xt].state),Bt(),pt&&Ri(),Ht())}function pf(){Do();const e=nr(Bl(),`World ${Te.length+1}`),t=yt!==null?yt+1:Te.length;Te.splice(t,0,e),ws(t)}function gf(){if(!fo||!fo.state)return;Do();const e=nr(fo.state,`World ${Te.length+1}`),t=yt!==null?yt+1:Te.length;Te.splice(t,0,e),ws(t)}function $l(e){if(e<0||e>=Te.length||(Do(),Te.length===1))return;const t=e<Te.length-1?e:e-1,[n]=Te.splice(e,1);yi.push({session:n,index:e}),Xt===e?ws(Math.max(0,Math.min(t,Te.length-1))):(Xt>e&&(Xt-=1),yt>e&&(yt-=1),pt&&Ri(),Ht())}function yf(){if(!yi.length)return!1;const{session:e,index:t}=yi.pop(),n=Math.max(0,Math.min(t,Te.length));return Te.splice(n,0,e),ws(n),!0}function mf(){if(!Te.length)return;const e=(yt+1)%Te.length;ws(e)}function xf(){if(!Te.length)return;const e=(yt-1+Te.length)%Te.length;ws(e)}function bi(){Z.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=Z.map(t=>{const n=t.vertexIds.map(o=>q(o));return n.some(o=>!o)?null:{face:t,vertices:n,area:Math.abs(Pi(n))}}).filter(Boolean);e.forEach(t=>{let n=null,o=1/0;e.forEach(i=>{if(t.face.id===i.face.id||i.area<=t.area)return;const s=t.face.vertexIds,a=s.map(c=>q(c));if(a.some(c=>!c))return;if(Wd(a,i.vertices)){const c=new Set(s),l=U.filter(h=>c.has(h.id1)&&c.has(h.id2));!qd(l,i.vertices,q)&&i.area<o&&(o=i.area,n=i.face)}}),n&&(t.face.parentFaceId=n.id)}),Z.forEach(t=>{if(t.parentFaceId){const n=Z.find(o=>o.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function Ee(e){const t=e.x*Ve,n=e.y*Ve,o=fe.height;return{x:(t-oe.offsetX)/oe.scale,y:(o-n-oe.offsetY)/oe.scale}}function xe(e){const t=fe.height,n=e.x*oe.scale+oe.offsetX,o=t-(e.y*oe.scale+oe.offsetY);return{x:n/Ve,y:o/Ve}}function q(e){return ae.find(t=>t.id===e)}function ko(e){if(!q(e))return[];const t=new Set,n=[e],o=[];for(t.add(e);n.length>0;){const i=n.shift();o.push(i),hn(i,U).forEach(s=>{t.has(s)||(t.add(s),n.push(s))})}return o}function Zs(e){const t=Ee(e),n=Be*2/oe.scale,o=(Mi+Be)/oe.scale;for(let i=ae.length-1;i>=0;i--){const s=ae[i];if(s.type!=="regular"&&J(t,s)<o)return s}for(let i=ae.length-1;i>=0;i--){const s=ae[i];if(s.type==="regular"&&J(t,s)<n)return s}return null}function Qs(e){const t=Ee(e),n=Ta/oe.scale;for(let o=U.length-1;o>=0;o--){const i=U[o],s=q(i.id1),a=q(i.id2);if(s&&a&&s.type==="regular"&&a.type==="regular"){const r=bt(t,s,a);if(r.distance<n&&r.onSegmentStrict)return i}}return null}function eo(e){const t=Ee(e),n=[];for(const s of Z){if(s.color==="transparent")continue;const a=s.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular");a.length<3||ys(t,a)&&n.push(s)}if(n.length===0)return null;let o=null,i=1/0;for(const s of n){let a=!1;if(s.childFaceIds&&s.childFaceIds.length>0)for(const r of s.childFaceIds){const c=Z.find(l=>l.id===r);if(c&&c.color==="transparent"){const l=c.vertexIds.map(d=>q(d)).filter(Boolean);if(l.length>=3&&ys(t,l)){a=!0;break}}}if(!a){const r=s.vertexIds.map(c=>q(c));if(r.every(Boolean)){const c=Math.abs(Pi(r));c<i&&(i=c,o=s)}}}return o}function ba(e){return U.filter(t=>t.id1===e||t.id2===e)}function Sf(){le.length===0&&ie.length===0&&Ie.length===0||(Ge(),Vl(),Ro())}function Vl(){const e=new Set(le);Xe&&e.add(Xe);const t=[];se.length>0&&se.forEach(s=>{const a=Z.find(r=>ge(r)===s);a&&(t.push(a),a.vertexIds.forEach(r=>e.add(r)))}),ie.forEach(s=>{const[a,r]=s.split(Gs);e.add(a),e.add(r)}),Tt.vertices=Array.from(e).map(s=>{const a=q(s);return a?{...a}:null}).filter(s=>s),Tt.edges=[],U.forEach(s=>{e.has(s.id1)&&e.has(s.id2)&&Tt.edges.push({...s})}),Tt.faces=t.map(s=>JSON.parse(JSON.stringify(s)));const n=new Set(ye),o=new Set(se),i=new Set(ie);Tt.texts=qe.filter(s=>{if(n.has(s.id))return!0;if(s.anchorType==="vertex")return e.has(s.anchorId);if(s.anchorType==="edge"){if(i.has(s.anchorId))return!0;const a=U.find(r=>ne(r)===s.anchorId);return a?e.has(a.id1)&&e.has(a.id2):!1}if(s.anchorType==="face"){if(o.has(s.anchorId))return!0;const a=Z.find(r=>ge(r)===s.anchorId);return a?a.vertexIds.every(r=>e.has(r)):!1}return!1}).map(s=>JSON.parse(JSON.stringify(s))),Tt.referenceVertex=Ee(K)}function If(){if(Tt.vertices.length===0||!Tt.referenceVertex)return;Ge();const e=Ee(K),t=e.x-Tt.referenceVertex.x,n=e.y-Tt.referenceVertex.y,o=new Map,i=[];let s=null;Jn(),Tt.vertices.forEach(c=>{const l=Nt(),d={...c,id:l,x:c.x+t,y:c.y+n};ae.push(d),o.set(c.id,l),d.type==="regular"?i.push(l):s=l}),Tt.edges.forEach(c=>{const l=o.get(c.id1),d=o.get(c.id2);l&&d&&U.push({...c,id1:l,id2:d})});const a=[];Tt.faces.forEach(c=>{const l=c.vertexIds.map(d=>o.get(d)).filter(Boolean);if(l.length===c.vertexIds.length){const d={...c,id:ge({vertexIds:l}),vertexIds:l};d.localCoordSystem&&(d.localCoordSystem.origin.x+=t,d.localCoordSystem.origin.y+=n,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=o.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=o.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=o.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=o.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=o.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=o.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=o.get(d.localCoordSystem.scaleAttachedToEdge.v2))),d.parentFaceId=null,d.childFaceIds=[],Z.push(d),a.push(d.id)}}),Es();const r=[];Tt.texts.forEach(c=>{const l=JSON.parse(JSON.stringify(c));if(l.id=Nt(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const d=o.get(l.anchorId);if(!d)return;l.anchorId=d}else if(l.anchorType==="edge"){const d=U.find(u=>ne(u)===l.anchorId);if(!d)return;const h=o.get(d.id1),f=o.get(d.id2);if(!h||!f)return;l.anchorId=ne({id1:h,id2:f})}else if(l.anchorType==="face"){const d=Z.find(f=>ge(f)===l.anchorId);if(!d)return;const h=d.vertexIds.map(f=>o.get(f));if(!h.every(Boolean))return;l.anchorId=ge({vertexIds:h})}qe.push(l),r.push(l.id)}),le=i,ie=Tt.edges.map(c=>ne({id1:o.get(c.id1),id2:o.get(c.id2)})),se=a,ye=r,Xe=s,Bt()}function Ro(){const e=new Set(le),t=new Set(Ie),n=new Set(ie),o=new Set(se),i=new Set(ye);if(e.size===0&&t.size===0&&n.size===0&&o.size===0&&i.size===0)return;if(Ge(),o.size>0){const l=new Set;Z.forEach(d=>{const h=d.id||ge(d);o.has(h)&&(Hs.add(h),d.childFaceIds&&d.childFaceIds.length>0&&d.childFaceIds.forEach(f=>{const u=Z.find(g=>g.id===f);u&&(u.parentFaceId=null)}),d.parentFaceId?d.color="transparent":l.add(h))}),l.size>0&&(Z=Z.filter(d=>!l.has(d.id||ge(d))))}const s=[...U];if(n.size>0&&(U=U.filter(l=>!n.has(ne(l)))),e.size>0){const l=JSON.parse(JSON.stringify(U)),d=[],h=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1,f=new Set(e);for(;f.size>0;){const u=f.values().next().value,g=new Set,p=[u];for(;p.length>0;){const x=p.shift();f.has(x)&&(g.add(x),f.delete(x),hn(x,U).forEach(b=>{f.has(b)&&p.push(b)}))}const y=U.filter(x=>g.has(x.id1)&&!g.has(x.id2)||g.has(x.id2)&&!g.has(x.id1)),S=new Set;y.forEach(x=>{g.has(x.id1)||S.add(x.id1),g.has(x.id2)||S.add(x.id2)});const m=Array.from(S);if(m.length===2){const[x,I]=m,b=q(x),v=q(I),C=U.some(w=>w.id1===x&&w.id2===I||w.id1===I&&w.id2===x);if(b&&v&&!C){const w=ms(b,v,h,Pe);Ms(w),d.push(w)}}}ae=ae.filter(u=>!e.has(u.id)),U=U.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),d.length>0&&(U.push(...d),Cs(l,U),Es())}Cs(s,U),t.size>0&&(ae=ae.filter(l=>!t.has(l.id))),i.size>0&&(qe=qe.filter(l=>!i.has(l.id)));const a=new Set(ae.map(l=>l.id)),r=new Set(U.map(l=>ne(l))),c=new Set(Z.map(l=>ge(l)));qe=qe.filter(l=>l.anchorType==="vertex"?a.has(l.anchorId):l.anchorType==="edge"?r.has(l.anchorId):l.anchorType==="face"?c.has(l.anchorId):!0),ye=ye.filter(l=>qe.some(d=>d.id===l)),Jn(),Bt()}function va(e,t){let n=oe.scale*t;n<mr&&(n=mr),n>xr&&(n=xr);const o=n/oe.scale,i=e.x*Ve,s=e.y*Ve;oe.offsetX=i*(1-o)+oe.offsetX*o,oe.offsetY=(fe.height-s)*(1-o)+oe.offsetY*o,oe.scale=n}function or(e){let t=0,n,o=Math.PI/2,i=!0;const s=q(e);if(!s)return i=!0,st!=="none"&&j.interval1?n=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1:n=aa,dt!==null&&(n=dt),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:o,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=kl(s.id);return a?(i=!1,t=a.angleRad,n=dt!==null?dt:a.length,Lt!==null?Math.abs(Lt)<re?o=Yi:o=Math.abs(Lt):o=Yi):(i=!0,st!=="none"&&j.interval1?n=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1:n=aa,dt!==null&&(n=dt),t=0,o=Yi),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:o,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:Lt,displayAngleA_originVertexData_for_A_equals_label:Rn,frozen_A_baseRad_to_display:qn,frozen_D_du_to_display:dt,frozen_D_g2g_to_display:Un}}function Gr(e,t,n){if(!e||!t)return null;const o=Math.atan2(t.y-e.y,t.x-e.x),i=J(e,t);let s=0,a=!0;for(let c=n.length-1;c>=0;c--){const l=n[c];let d=null;if(l.id1===e.id&&q(l.id2)?.type==="regular"?d=l.id2:l.id2===e.id&&q(l.id1)?.type==="regular"&&(d=l.id1),d&&d!==t.id){const h=q(d);if(h){s=Math.atan2(e.y-h.y,e.x-h.x),a=!1;break}}}const r=nt(o-s);return{startVertex:e,endVertex:t,absoluteAngleRad:o,length:i,precedingSegmentAbsoluteAngleRad:s,turnAngleRad:r,isFirstSegmentOfLine:a}}function Xl(e,t){const n=new Set,o=[e],i=new Set([e]);for(;o.length>0;){const s=o.shift(),a=t.find(r=>r.id===s);a&&(a.vertexIds.forEach(r=>n.add(r)),a.childFaceIds&&a.childFaceIds.forEach(r=>{i.has(r)||(i.add(r),o.push(r))}))}return Array.from(n)}function bf(){const e=le.filter(i=>{const s=q(i);return s&&s.type==="regular"});if(e.length<2)return;Ge();const t=JSON.parse(JSON.stringify(U));let n=!1;const o=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;for(let i=0;i<e.length;i++)for(let s=i+1;s<e.length;s++){const a=e[i],r=e[s];if(!U.some(l=>l.id1===a&&l.id2===r||l.id1===r&&l.id2===a)){const l=q(a),d=q(r);if(l&&d){const h=ms(l,d,o,Pe);Ms(h),U.push(h),n=!0}}}n&&Ln&&(Cs(t,U),Z.forEach(i=>{i.color||(i.color=Pe(we))}),Es()),Bt()}function Ct(e=[],t=[],n=[],o,i,s=!1,a=[]){s?Za(e[0],o,i):o?(le=[...new Set([...le,...e])],ie=[...new Set([...ie,...t])],se=[...new Set([...se,...n])],ye=[...new Set([...ye,...a])]):i?(e.forEach(r=>{const c=le.indexOf(r);c>-1?le.splice(c,1):le.push(r)}),t.forEach(r=>{const c=ie.indexOf(r);c>-1?ie.splice(c,1):ie.push(r)}),n.forEach(r=>{const c=se.indexOf(r);c>-1?se.splice(c,1):se.push(r)}),a.forEach(r=>{const c=ye.indexOf(r);c>-1?ye.splice(c,1):ye.push(r)})):(le=[...e],ie=[...t],se=[...n],ye=[...a])}function vf(e,t,n,o,i=0){const s={x:n.x-e.x,y:n.y-e.y},a={x:t.x-e.x,y:t.y-e.y},r=Math.hypot(s.x,s.y),c=Math.hypot(a.x,a.y),l=Math.atan2(s.y,s.x),d=Math.atan2(a.y,a.x);let h=0,f=1,u=!1;if(o===Qt)f=1,h=Br(l,d,i);else if(o===On)h=0,r>re&&(f=c/r);else if(o===an)h=Br(l,d,i),r>re&&(f=c/r);else if(o===Zn&&(u=!0,h=0,r>re)){const g={x:s.x/r,y:s.y/r};f=(a.x*g.x+a.y*g.y)/r}return{rotation:h,scale:f,directionalScale:u}}function Cs(e,t){if(!Ln){Z=[],Hs.clear();return}const n=new Set(e.map(p=>ne(p))),o=new Set(t.map(p=>ne(p))),i=t.filter(p=>!n.has(ne(p))),s=e.filter(p=>!o.has(ne(p)));if(i.length===0&&s.length===0)return;const a=new Set;i.forEach(p=>{a.add(p.id1),a.add(p.id2)}),s.forEach(p=>{a.add(p.id1),a.add(p.id2)});const r=new Set,c=new Set;for(const p of a)c.has(p)||ko(p).forEach(S=>{r.add(S),c.add(S)});const l=U.filter(p=>r.has(p.id1)&&r.has(p.id2)),d=Z.filter(p=>p.vertexIds.every(y=>r.has(y))),h=Ai(l,q),f=new Set(d.map(p=>p.id));Z=Z.filter(p=>!f.has(p.id));let u=h;if(h.length>1){const p=h.map(y=>{const S=y.vertexIds.map(m=>q(m));return S.some(m=>!m)?null:{face:y,area:Math.abs(Pi(S))}}).filter(Boolean);if(p.length>1){p.sort((m,x)=>x.area-m.area);const y=p[0],S=p.slice(1).reduce((m,x)=>m+x.area,0);Math.abs(y.area-S)<re&&(u=p.slice(1).map(m=>m.face))}}const g=new Set(i.map(p=>ne(p)));u.forEach(p=>{let y=!1;if(i.length>0)for(let m=0;m<p.vertexIds.length;m++){const x=p.vertexIds[m],I=p.vertexIds[(m+1)%p.vertexIds.length],b=ne({id1:x,id2:I});if(g.has(b)){y=!0;break}}if(Hs.has(p.id))if(y)Hs.delete(p.id);else return;const S=he[we];if(S!==-1){const m=ue[S];m&&m.type==="colormap"?(p.colormapItem=m,p.colormapDistribution="x",delete p.color):(p.color=Pe(we),delete p.colormapItem,delete p.colormapDistribution)}else p.color=Pe(we),delete p.colormapItem,delete p.colormapDistribution;p.parentFaceId=null,p.childFaceIds=[],Z.push(p)}),Es()}function Yl(e,t,n,o){const i=q(e.id1),s=q(e.id2);if(!i||!s)return null;const a=[...U],r={id:Nt(),x:t.x,y:t.y,type:"regular",color:o(_e)};ae.push(r),U=U.filter(d=>ne(d)!==ne(e));const c=ms(i,r,n,o),l=ms(r,s,n,o);return Ms(c),Ms(l),U.push(c),U.push(l),Ln&&Cs(a,U),r}function Mf(e,t,n,o,i){const s=ze(n,e,o,i,!1,null),a={x:n.x-e.x,y:n.y-e.y},r=2*Be/oe.scale,c=t.filter(d=>d.type==="regular"),l=[];if(c.length>0){const d=ae.filter(f=>f.type==="regular"&&!t.some(u=>u.id===f.id)),h=parseInt(Ot||"1",10)||1;for(let f=1;f<=h;f++)c.forEach(u=>{d.forEach(g=>{const p={x:u.x-e.x,y:u.y-e.y},y={x:g.x-e.x,y:g.y-e.y},S=Math.hypot(p.x,p.y),m=Math.hypot(y.x,y.y);if(S>re){const x=Math.pow(m/S,1/f);let I=Math.atan2(y.y,y.x)-Math.atan2(p.y,p.x);const v=(I+Math.round((o*f-I)/(2*Math.PI))*(2*Math.PI))/f,C=ze(n,e,v,x,!1,a),w=J(s,C);l.push({dist:w,rotation:v,scale:x,pos:C})}})})}if(l.length>0){const d=l.sort((h,f)=>h.dist-f.dist)[0];if(d.dist<r)return{...d,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}if(ke){const d=[],h=[],f=La.flatMap(m=>{const x=m*Math.PI/2;return x===0?[0]:[x,-x]}).sort((m,x)=>Math.abs(nt(o-m))-Math.abs(nt(o-x))),u=Vn.filter(m=>m>0).sort((m,x)=>Math.abs(i-m)-Math.abs(i-x)),g=f.slice(0,2),p=u.slice(0,2);g.forEach(m=>{p.forEach(x=>{const I=m+Math.round((o-m)/(2*Math.PI))*(2*Math.PI),b=ze(n,e,I,x,!1,a);d.push({dist:J(s,b),rotation:I,scale:x,pos:b})})});const y=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;if(y){const m=Wn(s,st,y,rn,!0),x=Math.hypot(a.x,a.y);m.forEach(I=>{if(x>re){const b={x:I.x-e.x,y:I.y-e.y},v=Math.hypot(b.x,b.y)/x,C=Math.atan2(b.y,b.x)-Math.atan2(a.y,a.x),w=C+Math.round((o-C)/(2*Math.PI))*(2*Math.PI);h.push({dist:J(s,I),rotation:w,scale:v,pos:I})}})}const S=[...d,...h].sort((m,x)=>m.dist-x.dist)[0];return{...S,snapped:!0,snapType:"geometric",snappedScaleValue:S.scale}}return{rotation:o,scale:i,pos:s,snapped:!1}}function Cf(e,t,n,o,i){const s=parseInt(Ot||"1",10);let a=[];const r=Math.hypot(n.x-e.x,n.y-e.y),c=2*Be/oe.scale,l=t.filter(p=>p.type==="regular"),d=ae.filter(p=>p.type==="regular"&&!t.some(y=>y.id===p.id));if(Array.from({length:s},(p,y)=>y+1).forEach(p=>{l.forEach(y=>{d.forEach(S=>{const m={x:y.x-e.x,y:y.y-e.y},x={x:S.x-e.x,y:S.y-e.y};if(Math.abs(Math.hypot(m.x,m.y)-Math.hypot(x.x,x.y))<re){let I=Math.atan2(x.y,x.x)-Math.atan2(m.y,m.x);const b=I+Math.round((o*p-I)/(2*Math.PI))*(2*Math.PI);a.push({rotation:b/p,priority:Math.abs(nt(b/p-o)),snapType:"merge"})}})})}),ke){La.flatMap(m=>{const x=m*Math.PI/2;return x===0?[0]:[x,-x]}).forEach(m=>{const x=Math.abs(nt(o-m)),I=m+Math.round((o-m)/(2*Math.PI))*(2*Math.PI);a.push({rotation:I,priority:x,snapType:"geometric"})});const y=new Set(t.map(m=>m.id));let S=ae.filter(m=>m.type==="regular"&&!y.has(m.id));if(j){const m=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;m&&S.push(...Wn(i,st,m,rn,!0))}S.forEach(m=>{const x=J(i,m);if(x<Ea/oe.scale){const I=Math.atan2(n.y-e.y,n.x-e.x),b=Math.atan2(m.y-e.y,m.x-e.x),v=nt(b-I),C=v+Math.round((o-v)/(2*Math.PI))*(2*Math.PI);a.push({rotation:C,priority:x/1e3,snapType:"projection",projectionSource:m})}})}if(a.length===0)return{rotation:o,snapped:!1,snapType:null};a.sort((p,y)=>p.priority-y.priority);const f=a[0];if(f.snapType==="merge"){const p=ze(n,e,f.rotation,1,!1,null);if(J(i,p)>c)return{rotation:o,snapped:!1,snapType:null}}const u=ze(n,e,f.rotation,1,!1,null);let g=null;return f.snapType==="projection"&&(g={x:e.x+r*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation),y:e.y+r*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation)}),{rotation:f.rotation,pos:u,snapped:!0,snapType:f.snapType,projectionSource:f.projectionSource||null,projectionPoint:g}}function Ef(e,t,n,o){const i=Ee(K),s=2*Be/oe.scale,a=t.filter(c=>c.type==="regular"),r=[];if(a.length>0){const c=ae.filter(h=>h.type==="regular"&&!t.some(f=>f.id===h.id)),l=s/100,d=parseInt(Ot||"1",10);for(let h=1;h<=d;h++)a.forEach(f=>{c.forEach(u=>{const g={x:f.x-e.x,y:f.y-e.y},p={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(g.x,g.y),S=Math.hypot(p.x,p.y);if(y>re){const m=Math.atan2(g.y,g.x),x=Math.atan2(p.y,p.y);if(Math.abs(nt(m-x))<l){const I=Math.pow(S/y,1/h),b=ze(n,e,0,I,!1,null);r.push({scale:I,dist:J(i,b)})}}})})}if(r.length>0){const c=r.sort((l,d)=>l.dist-d.dist)[0];if(c.dist<s){const l=ze(n,e,0,c.scale,!1,null);return{...c,pos:l,snapped:!0,snapType:"merge"}}}if(ke){let c,l,d=1,h=1/0;Vn.forEach(p=>{const y=Math.abs(o-p);y<h&&(h=y,d=p)});const f=ze(n,e,0,d,!1,null);c={scale:d,pos:f,dist:J(i,f),snapType:"geometric",snappedScaleValue:d};const u=new Set(t.map(p=>p.id)),g=ae.filter(p=>p.type==="regular"&&!u.has(p.id));if(j){const p=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;p&&g.push(...Wn(i,st,p,rn,!0))}if(g.length>0){const p=g.reduce((m,x)=>J(i,m)<J(i,x)?m:x),y=Math.hypot(n.x-e.x,n.y-e.y),S=J(e,p);if(y>re){const m=S/y,x=Math.atan2(n.y-e.y,n.x-e.x),I={x:e.x+S*Math.cos(x),y:e.y+S*Math.sin(x)};l={scale:m,pos:I,dist:J(i,I),snapType:"projection",snappedScaleValue:m,projectionSource:p}}}return l&&J(i,l.projectionSource)<s?{...l,snapped:!0}:{...c,snapped:!0}}return{scale:o,snapped:!1,snapType:null}}function wf(e,t,n,o,i,s){let a=[];const r=2*Be/oe.scale;if(t.filter(l=>l.type==="regular"),ke){let l=null,d=null,h=1,f=1/0;[...Vn,...Vn.map(S=>-S)].forEach(S=>{const m=Math.abs(o-S);m<f&&(f=m,h=S)});const g=ze(n,e,0,h,!0,i);l={scale:h,pos:g,dist:J(s,g),snapType:"geometric",snappedScaleValue:h};const p=new Set(t.map(S=>S.id)),y=ae.filter(S=>S.type==="regular"&&!p.has(S.id));if(j){const S=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;S&&y.push(...Wn(s,st,S,rn,!0))}if(y.length>0){const S=y.reduce((x,I)=>J(s,I)<J(s,x)?I:x),m=Math.hypot(i.x,i.y);if(m>re){const x={x:i.x/m,y:i.y/m},I=v=>(v.x-e.x)*x.x+(v.y-e.y)*x.y,b=I(n);if(Math.abs(b)>re){const C=I(S)/b,w=ze(n,e,0,C,!0,i);d={scale:C,pos:w,dist:J(s,w),snapType:"projection",snappedScaleValue:C,projectionSource:S}}}}d&&J(s,d.projectionSource)<r?a.push({...d,priority:0}):a.push({...l,priority:1})}return a.length===0?{scale:o,snapped:!1,snapType:null}:{...a.sort((l,d)=>l.priority-d.priority)[0],snapped:!0}}function Tf(e){const t=fe.width/Ve,n=fe.height/Ve,{grid1Interval:o,grid2Interval:i,alpha1:s,alpha2:a}=jd(oe.scale);j={interval1:o,interval2:i,alpha1:s,alpha2:a,scale:oe.scale},rn=Kd(oe,t,n,xe),ch(Me,{gridDisplayMode:st,canvas:fe,dpr:Ve,viewTransform:oe,gridAlpha:Gh,colors:e},xe,Ee,j,rn);let r={useScientific:!1};return Is!==wi&&(r=ih(Me,tt,{canvas:fe,dpr:Ve,coordsDisplayMode:Is,viewTransform:oe,angleDisplayMode:on,colors:e},xe,Ee,j,rn,xt)),r}function Pf(e){const t=Oe&&ce.length===1&&!Ye&&ce[0].type==="regular";if(pa.forEach(n=>{Oe&&ce.length>0&&[...n].some(i=>ce.some(s=>s.id===i))||nf(n,e,!1,[],0)}),ae.forEach(n=>{if(n.type!=="regular"){const o=Oe&&ce.some(c=>c.id===n.id);let i=n,s=!1,a=o?0:void 0;if(o&&!t&&Se.length>0){const c=Se.find(l=>l&&l.originalId===n.id&&l.transformIndex===0);c&&(i=c)}if(gt){const c=n.originalId||n.id;gt.has(c)&&gt.get(c).find(h=>h.copyIndex===a)&&(s=!0)}const r={selectedVertexIds:[],selectedCenterIds:Ie,activeCenterId:Xe,colors:e,verticesVisible:!0,isHovered:gn===n.id&&!_t,isSnapped:s,snappedVertexIds:gt,isDragConfirmed:Oe,dragPreviewVertices:Se,currentAltPressed:_t};ri(Me,i,r,xe)}}),Oe){const o={copyCount:parseInt(Ot||"1",10),isDragConfirmed:Oe,initialDragVertexStates:ce,dragPreviewVertices:Se,transformIndicatorData:Ye,allEdges:U,allFaces:Z,findVertexById:q,findAllVerticesInSubgraph:i=>ko(i),colors:e,edgeColorMode:At,faceColorMode:Fe,edgeColorExpression:Pn,faceColorExpression:Xn,faceColorPolarExpression:Yn,snappedEdgesInfo:bs,snappedVertexIds:gt};t?th(Me,o,xe):eh(Me,o,xe)}}function _f(e,t){Ch(tt,{coordsDisplayMode:Is,isMouseOverCanvas:Io,currentShiftPressed:ke,ghostVertexPosition:Ne,gridDisplayMode:st,lastGridState:j,angleDisplayMode:on,canvas:fe,dpr:Ve,mousePos:K,colors:e,useScientific:t.useScientific},Ee,xt),ma&&jt&&(Qa(),ma=!1),Uh();const n={dpr:Ve,canvasUI:H,isToolbarExpanded:ls,isColorPaletteExpanded:ot,isColorModePanelExpanded:jt,isInterpolationPanelExpanded:nn,isTransformPanelExpanded:vn,isDisplayPanelExpanded:un,isVisibilityPanelExpanded:qa,isSessionsPanelExpanded:pt,isPlacingTransform:Yt,placingTransformType:Js,placingSnapPos:To,mousePos:K,allColors:ue,activeThemeName:bo,colors:e,verticesVisible:hi,edgesVisible:fi,facesVisible:Ln,coordsDisplayMode:Is,gridDisplayMode:st,angleDisplayMode:on,distanceDisplayMode:Wo,namedColors:Bn.namedColors,colorAssignments:he,activeColorTargets:He,interpolationStyles:pn,activeInterpolationStyleId:Eo,sessions:Te,activeSessionIndex:Xt,selectedSessionIndex:yt,edgeColorMode:At,faceColorMode:Fe,edgeColorExpression:Pn,faceColorExpression:Xn,faceColorPolarExpression:Yn,isDraggingColorTarget:Xs,draggedColorTargetInfo:wt};n.selectedInterpolationStyleId=Jh(),Vh(Me,tt,n,xt)}function Hl(){Ua.clear();const e=ja();Jd(Me,{canvas:fe,dpr:Ve,colors:e});const t=Tf(e);Pf(e),ll(Me,{allFaces:Z,hoveredFaceId:yn,selectedFaceIds:se,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,currentAltPressed:_t},xe,q,ge),se.length>0&&Sl(Me,{allFaces:Z,selectedFaceIds:se,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,initialDragVertexStates:ce,transformIndicatorData:Ye,highlightedEdgeForSnap:Cn,draggedFaceId:wo,coordSystemSnapAngle:Ks,coordSystemSnapType:Ss,coordSystemSnapScale:bn,initialCoordSystemStates:xs},xe,q),fu(e),ef(e),hh(Me,{altHoverInfo:Ke,colors:e},xe,q,xt),_f(e,t),Kh()}function zl(){if(!Ce||Ce.length<2)return;const e=he[_e];if(e===-1)return;const t=ue[e];if(!t||t.type!=="colormap")return;const n=Ce.length;Ce.forEach((o,i)=>{const s=q(o);if(s&&s.type==="regular"){const a=n>1?i/(n-1):.5;s.color=Ae(t,a)}})}function Gl(){if(!Ce||Ce.length<2)return;const e=he[Re];if(e===-1)return;const t=ue[e];if(!t||t.type!=="colormap")return;const o=Ce.length-1;for(let i=0;i<o;i++){const s=Ce[i],a=Ce[i+1],r=U.find(c=>c.id1===s&&c.id2===a||c.id1===a&&c.id2===s);if(r){const c=i/o,l=(i+1)/o;r.gradientStart=c,r.gradientEnd=l,r.colormapItem=t,delete r.colormapOffset,delete r.color}}}function Af(e,t,n){if(!ot)return!1;const o=H.removeColorButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height){if(ue.length>1&&He.length>0){const s=He[He.length-1],a=he[s];a>=0&&(Ge(),er(a))}return!0}const i=H.addColorButton;return i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height?(pi=!1,ho=null,Bn.show(),!0):!1}function Jn(){if(Vt&&clearTimeout(Vt),Ot="",Vt=null,us&&(ue=Pt.originalAllColors,he=Pt.originalAssignments,at(),ft.length>0&&ft.pop(),us=!1,Pt=null,ts=!1),Ue){Ue=!1,it=null,Lt=null,qn=null,dt=null,Un=null,Rn=null,Ze=[],qt=0,Ce=[],di=null;return}Yt&&(Yt=!1,Js=null,To=null),le=[],ie=[],se=[],Ie=[],ye=[],Xe=null,He=[],ot&&at(),fn=null,$t=!1,Oe=!1,jn=!1,ui=!1,Ys=!1,fs=!1,Se=[],ce=[],gi=null,mn=-1,de={targetId:null,type:null,count:0,timestamp:0},fe.style.cursor="crosshair",Ye=null,vs=[],Ne=null,Cn=null,Ks=null,wo=null,Ss=null,fn=null,Ke=null}function Df(){if(!Ue||!it||Ze.length===0)return;Ge();const e=q(it);if(!e){Jn();return}const t=kl(e.id);if(!t){Jn();return}const n=t.angleRad;if(Ze.length===1)return;const o=Ze.length-1,i=(qt-1)%o+1,s=Ze[i],a=s.length;let r;if(i===Ze.length-1){const S=Ze.length>2?1:0;r=Ze[S].turn}else r=s.turn;let c,l;if(i===Ze.length-1){const S=[Ze[0].endVertexColor,Ze[1].endVertexColor],m=(qt-1)%S.length;l=S[m];const x=qt%S.length;c=S[x],e.color=l}else c=s.endVertexColor;const d=Mn(n+r),h=e.x+a*Math.cos(d),f=e.y+a*Math.sin(d);let u=null,g=!1;const p=Be*2/oe.scale;for(const S of ae)if(S.type==="regular"&&J({x:h,y:f},S)<p){u=S,g=!0;break}g||(u={id:Nt(),x:h,y:f,type:"regular",color:c},ae.push(u)),U.some(S=>S.id1===e.id&&S.id2===u.id||S.id2===e.id&&S.id1===u.id)||U.push({id1:e.id,id2:u.id,color:Pe(Re)}),Ln&&(Z=Ai(U,q),Es()),Ce.push(u.id),window.currentDrawingPath=Ce,zl(),Gl(),it=u.id,qt++,qt>=Ze.length&&(qt=1),dt=null,Un=null,Lt=null,qn=null,Rn=null}function Wl(){Hl(),requestAnimationFrame(Wl)}function kf(e){if(se.length===0)return!1;const t=so(e,fe);for(const n of se){const o=Z.find(s=>s.id===n);if(!o||!o.localCoordSystem)continue;const i=Ad(t,o,xe);if(i)return Kn=!0,ln=i,wo=o.id,mi=Rf(o),i.type==="center"&&(o.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function Rf(e){const t=[],n=[],o=[],i=[],s=[];e.vertexIds.forEach(a=>{const r=q(a);r&&r.type==="regular"&&t.push({...r,id:a})});for(let a=0;a<t.length;a++){const r=t[a],c=t[(a+1)%t.length];n.push({x:(r.x+c.x)/2,y:(r.y+c.y)/2,v1:r.id,v2:c.id}),o.push(r.id,c.id),s.push(Math.atan2(c.y-r.y,c.x-r.x))}return Z.forEach(a=>{a.id!==e.id&&a.localCoordSystem&&i.push(a.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:o,faceCenters:i,edgeAngles:s}}function Ma(e,t){const n=e.vertexIds[t],o=e.vertexIds[(t+1)%e.vertexIds.length],i=q(n),s=q(o);return i&&s?{v1Id:n,v2Id:o,edgeAngle:Math.atan2(s.y-i.y,s.x-i.x)}:null}function Lf(e,t){if(e.length===0||t&&t.transformType===Qt||!t)return;const i=new Set;e.forEach(a=>{ba(a).forEach(r=>i.add(r))});const s=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;i.forEach(a=>{const r=q(a.id1),c=q(a.id2);if(!r||!c)return;const l=r.x-c.x,d=r.y-c.y,h=l/s,f=d/s,u=1e-5;if(s&&Math.abs(h-Math.round(h))<u&&Math.abs(f-Math.round(f))<u){a.labelMode="exact";const p=Math.round(h),y=Math.round(f);a.exactValue={g2gSquaredSum:p*p+y*y,gridInterval:s}}else a.labelMode="decimal",delete a.exactValue})}function Of(){if(Rt){Ge();let e=Z.find(t=>t.id===Rt);if(e)e.color=Pe(we),bi();else{const n=Ai(U,q).find(o=>o.id===Rt);n&&(n.color=Pe(we),Z.push(n),bi(),Es())}Rt=null}ht.style.display="none"}function Nf(e,t){const n=[],o=t.find(a=>a.id===e);if(!o)return[];const i=[...o.childFaceIds||[]],s=new Set(o.childFaceIds);for(;i.length>0;){const a=i.shift(),r=t.find(c=>c.id===a);r&&(n.push(r),r.childFaceIds&&r.childFaceIds.forEach(c=>{s.has(c)||(s.add(c),i.push(c))}))}return n}function Bf(e,t,n,o,i){if(!t.isCustom){const l=e.vertexIds.map(d=>o.find(h=>h.id===d)||i(d)).filter(d=>d&&d.type==="regular");if(l.length>=3){const d=_i(l);d&&(e.localCoordSystem.origin=d.center,e.localCoordSystem.scale=d.radius)}return}let s={...t.origin},a=t.angle,r=t.scale;if(e.localCoordSystem.attachedToVertex){const l=o.find(d=>d.id===e.localCoordSystem.attachedToVertex);l&&(s={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=o.find(h=>h.id===e.localCoordSystem.attachedToEdge.v1)||i(e.localCoordSystem.attachedToEdge.v1),d=o.find(h=>h.id===e.localCoordSystem.attachedToEdge.v2)||i(e.localCoordSystem.attachedToEdge.v2);l&&d&&(s={x:l.x+e.localCoordSystem.attachedToEdge.t*(d.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(d.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=o.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v1)||i(e.localCoordSystem.rotationAlignedToEdge.v1),d=o.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v2)||i(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&d){const h=Math.atan2(d.y-l.y,d.x-l.x),f=e.localCoordSystem.rotationAlignedToEdge.originalAngle,g=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-f;a=Mn(h+g),e.localCoordSystem.rotationAlignedToEdge.originalAngle=h,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(e.localCoordSystem.scaleAttachedToEdge){const l=o.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v1)||i(e.localCoordSystem.scaleAttachedToEdge.v1),d=o.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v2)||i(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&d){const h=J(l,d);r=h*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=h}}const c=e.vertexIds.map(l=>o.find(d=>d.id===l)||i(l)).filter(l=>l&&l.type==="regular");c.length>=3&&(e.localCoordSystem.origin=js(s,c),e.localCoordSystem.angle=a,e.localCoordSystem.scale=Math.max(.01,r),e.localCoordSystem.isCustom=!0)}function Ff(e,t){const n=new Map;return e.forEach(o=>{const i=[...new Set(o.vertexIds.map(s=>t(s)))];if(i.length>=3){const s=ge({vertexIds:i});if(o.localCoordSystem&&o.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(o.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=t(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=t(a.attachedToEdge.v1),a.attachedToEdge.v2=t(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=t(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=t(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=t(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=t(a.scaleAttachedToEdge.v2)),n.set(s,a)}}}),n}function $f(e){ht.innerHTML="",ht.style.display="none",K=so(e,fe);const t=Zs(K),n=t?null:Qs(K),o=!t&&!n?eo(K):null;if(t||n||o){let d=!1;t?d=le.includes(t.id):n?d=ie.includes(ne(n)):o&&(d=se.includes(ge(o))),d||(le=[],ie=[],se=[],Ie=[],ye=[],t?le=[t.id]:n?ie=[ne(n)]:o&&(se=[ge(o)]))}else Jn();const s=Ee(K);let a=[];Rt=null,Ns=null,Os=null;const r=(le.length>0?1:0)+(ie.length>0?1:0)+(se.length>0?1:0),c=Zs(K),l=c?null:Qs(K);if(c&&c.type==="regular"){Os=c.id;const d=r>1?"Remove Geometry":"Remove Vertex";a.push({text:d,handler:Jf})}else if(l){Ns=ne(l);const d=r>1?"Remove Geometry":"Remove Edge";a.push({text:d,handler:Zf})}else{const d=eo(K);if(d){Rt=ge(d);const h=r>1?"Remove Geometry":"Remove Face";a.push({text:h,handler:Qf}),d.childFaceIds&&d.childFaceIds.length>0&&a.push({text:"Remove Face and Children",handler:Kf})}else{const h=Ai(U,q);let f=null,u=1/0;h.forEach(g=>{const p=g.vertexIds.map(y=>q(y));if(p.every(Boolean)&&ys(s,p)){const y=Math.abs(Pi(p));y<u&&(u=y,f=g)}}),f&&(Rt=f.id||ge(f),a.push({text:"Add Face",handler:Of}))}}if(a.length>0){const d=document.createElement("ul");a.forEach(h=>{const f=document.createElement("li");f.textContent=h.text,f.addEventListener("click",h.handler),d.appendChild(f)}),ht.appendChild(d),ht.style.left=`${e.clientX-yr}px`,ht.style.top=`${e.clientY-yr}px`,ht.style.display="block"}}function Vf(e){if(un){for(const t of H.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[wi,Oa,go,Ti];Is=n[(n.indexOf(Is)+1)%n.length];break;case"grid":const o=[Na,Ba,Fa,$a,Mo];st=o[(o.indexOf(st)+1)%o.length];break;case"angles":const i=[gs,Co,yo];on=i[(i.indexOf(on)+1)%i.length],Nn=on!==yo;break;case"distances":const s=[mo,yd];Wo=s[(s.indexOf(Wo)+1)%s.length],Sn=Wo===mo;break;case"theme":Wf();break}return!0}}return!1}function Xf(e){if(!nn)return!1;for(const t of H.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationRemove")return ie.length>0||se.length>0||le.length>0?Qh():Ia(kn.id),!0;if(t.type==="interpolationAdd")return Ls?.initialize?.(),Ls?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(Ho.id===t.styleId&&n-Ho.timestamp<Zo){const i=Si(t.styleId);return i&&(Ls?.initialize?.(),Ls?.show(i)),Ho={id:null,timestamp:0},!0}return Ho={id:t.styleId,timestamp:n},(ie.length>0||se.length>0||le.length>0)&&Zh(t.styleId),Ia(t.styleId),!0}}return!1}function Yf(e){if(!jt)return!1;for(const t of H.colorModeIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.group==="edge"){const n=["fixed","inherit_vertices","colormap"];At=n[(n.indexOf(At)+1)%n.length]}else if(t.group==="face"){const n=["fixed","inherit_vertices","inherit_edges","colormap_xy","colormap_polar"];Fe=n[(n.indexOf(Fe)+1)%n.length]}return ki(),Ml(),at(),Qa(),Ht(),!0}return!1}function Hf(e,t=!1,n=!1){const o=H.toolbarButton;if(e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return ls=!ls,ls?Al():(ot=!1,jt=!1,nn=!1,vn=!1,un=!1,qa=!1,pt=!1,He=[]),!0;if(ls){const i=H.colorToolButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return jf(),!0;const s=H.colorModeToolButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return jt=!jt,jt&&Qa(),!0;const a=H.interpolationToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return nn=!nn,nn&&Dl(),!0;const r=H.transformToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return vn=!vn,vn&&lf(),!0;const c=H.visibilityToolButton;if(c&&e.x>=c.x&&e.x<=c.x+c.width&&e.y>=c.y&&e.y<=c.y+c.height)return un=!un,un&&rf(),!0;const l=H.sessionsToolButton;if(l&&e.x>=l.x&&e.x<=l.x+l.width&&e.y>=l.y&&e.y<=l.y+l.height)return pt=!pt,pt&&(yt=Xt,Ri()),!0}if(ot&&Af(e)||jt&&Yf(e)||nn&&Xf(e))return!0;if(vn){for(const i of H.transformIcons)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return Yt?Js=i.type:(Yt=!0,Js=i.type,fe.style.cursor="none"),!0}if(un&&Vf(e))return!0;if(pt&&H.sessionsPanelBounds){const i=H.sessionsPanelBounds;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return mf(),!0}return!!tr(e)}function zf(){if(ft.length===0)return;const e=Ao();ue.length,ue[0]?.value,ae.length,Hn.push(e),Hn.length>Ra&&Hn.shift();const t=ft.pop();_o(t),ue.length,ue[0]?.value,ae.length,Bt()}function Gf(){if(Hn.length===0)return;const e=Ao();ft.push(e),ft.length>Ra&&ft.shift();const t=Hn.pop();_o(t),Bt()}function ir(e,t){const n=Ee(e),o=Zs(e),i=o?null:Qs(e),s=!o&&!i?eo(e):null;if(o)Ke={point:{x:o.x,y:o.y},element:{type:"vertex",id:o.id},shiftKey:t};else if(i){const a=q(i.id1),r=q(i.id2);if(a&&r){let c,l;const d=bt(n,a,r);if(t){const h=$d(d,a,r);c=h.point,l=h.fraction}else c={x:d.x,y:d.y},l=d.t;Ke={point:c,element:{type:"edge",edge:i},shiftKey:t,fraction:l}}}else s?Ke={point:n,element:{type:"face",id:ge(s)},shiftKey:t}:Ke=null;gn=null,Tn=null,yn=null}function Wf(){Ge(),bo=bo==="dark"?"light":"dark",of(),ot&&at()}function qf(e){if(!Kn||!ln)return!1;const t=so(e,fe),n=Ee(t),o=ln,i=o.face,s=i.localCoordSystem,a=i.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular"&&r.x!==void 0&&r.y!==void 0);if(o.type==="center"){let r,c={snapped:!1};if(e.shiftKey){if(c=Od(n,mi,st,j,rn),c.snapped){if(r=c.snapPoint,c.snapType==="edge"){const l=c.edgeInfo,d=q(l.v1),h=q(l.v2);d&&h&&(r=c.snapPoint,fn=null)}}else{const l=_i(a);r=l?l.center:a[0]}o.type==="center"&&(Ne=r)}else r=n,Ne=null,fn=null;a.length>0&&a.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(r=js(r,a),Ne&&(Ne=js(Ne,a))),s.origin.x=r.x,s.origin.y=r.y,s.isCustom=!0,c.snapped?(s.attachedToVertex=c.vertexId||null,s.attachedToEdge=c.edgeInfo||null):(s.attachedToVertex=null,s.attachedToEdge=null)}else if(o.type==="x_axis"||o.type==="y_axis"){const r={x:n.x-s.origin.x,y:n.y-s.origin.y};let c=Math.atan2(r.y,r.x),l=Math.hypot(r.x,r.y);if(Cn=null,Ks=null,Ss=null,vs=[],Ne=null,fn=null,bn=null,e.shiftKey){const d=Rd(n,s.origin,!0,mi);if(d.snapped){c=d.angle,Ks=c,Ss=d.snapType;const h={x:Math.cos(c),y:Math.sin(c)},f={x:n.x-s.origin.x,y:n.y-s.origin.y},u=f.x*h.x+f.y*h.y;if(d.snapType==="vertex_direction"){const g=q(d.targetVertexId);g&&(l=J(s.origin,g),bn=l)}else if(d.edgeIndex!==null){Cn=d.edgeIndex;const g=Ma(i,d.edgeIndex);if(g){const p=Math.abs(nt(c-g.edgeAngle))>Math.PI/4&&Math.abs(nt(c-g.edgeAngle))<3*Math.PI/4;if(o.type==="x_axis"&&p){const y=q(g.v1Id),S=q(g.v2Id);if(y&&S){const m=ol(s.origin,y,S),x=m.distance,I=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};I.forEach(C=>{const w=x*C,P=Math.abs(u-w);P<b.dist&&(b={scale:w,dist:P,fraction:C})});const v=15/oe.scale;b.dist<v?(l=b.scale,bn=l,fn={orthogonalDistanceFraction:b.fraction,v1:y,v2:S,snapPosition:{origin:s.origin,closest:m}}):(l=u>0?u:0,bn=l)}}else{const y=Ld(s.origin,o.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:g},i,q,u,oe,o.type);if(y.snapped){if(l=y.scale,bn=l,y.edgeFraction!==null){const S={x:s.origin.x+l*Math.cos((o.type==="y_axis",c)),y:s.origin.y+l*Math.sin((o.type==="y_axis",c))};fn={edgeFraction:y.edgeFraction,v1:q(g.v1Id),v2:q(g.v2Id),snapPosition:S}}}else l=u>0?u:0}}}}else l=Math.hypot(r.x,r.y)}o.type==="y_axis"?s.angle=c-Math.PI/2:s.angle=c,l>.01&&(s.scale=l),s.isCustom=!0}return!0}function Uf(){if(Kn){const e=ln,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const o=Ec;let i=null,s=null,a=1/0,r={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(c=>{const l=q(c);if(l&&l.type==="regular"){const d=J(n.origin,l);d<a&&(a=d,d<o&&(i=c))}}),!i){for(let c=0;c<t.vertexIds.length;c++){const l=q(t.vertexIds[c]),d=q(t.vertexIds[(c+1)%t.vertexIds.length]);if(l&&d&&l.type==="regular"&&d.type==="regular"){const h=bt(n.origin,l,d);h.distance<r.dist&&(r={dist:h.distance,t:h.t,v1:l.id,v2:d.id})}}if(r.dist<o){const c=J(q(r.v1),q(r.v2));c>re&&(s={v1:r.v1,v2:r.v2,t:r.t,originalLength:c,scaleRatio:n.scale/c})}}n.attachedToVertex=i,n.attachedToEdge=s}if(e.type==="x_axis"||e.type==="y_axis"){let o=!1,i=!1;if(Ss==="edge"&&Cn!==null){const s=Ma(t,Cn);s&&(n.rotationAlignedToEdge={v1:s.v1Id,v2:s.v2Id,originalAngle:s.edgeAngle,originalSystemAngle:n.angle},o=!0)}if(bn!==null&&n.rotationAlignedToEdge){const s=Ma(t,Cn);if(s){const a=q(s.v1Id),r=q(s.v2Id);if(a&&r){const c=J(a,r);c>re&&(n.scaleAttachedToEdge={v1:s.v1Id,v2:s.v2Id,scaleRatio:n.scale/c,originalLength:c},i=!0)}}}o||(n.rotationAlignedToEdge=null),i||(n.scaleAttachedToEdge=null)}return bn=null,fn=null,Kn=!1,ln=null,mi=null,Cn=null,Ks=null,Ss=null,wo=null,Ne=null,vs=[],!0}return!1}function jf(){ot=!ot,ot&&at()}function Kf(){if(Rt){Ge();const e=Z.find(t=>t.id===Rt);if(e){const t=Nf(e.id,Z),n=new Set(t.map(s=>s.id)),o=new Set;t.forEach(s=>{s.vertexIds.forEach(a=>o.add(a))}),ae=ae.filter(s=>!o.has(s.id)),U=U.filter(s=>!o.has(s.id1)&&!o.has(s.id2));const i=new Set([e.id,...n]);Z=Z.filter(s=>!i.has(s.id)),Jn()}Rt=null}ht.style.display="none"}function Jf(){Os&&(Ge(),le.includes(Os)||(ie=[],se=[],Ie=[],ye=[],le=[Os]),Ro(),Os=null),ht.style.display="none"}function Zf(){Ns&&(Ge(),ie.includes(Ns)||(le=[],se=[],Ie=[],ye=[],ie=[Ns]),Ro(),Ns=null),ht.style.display="none"}function Qf(){Rt&&(Ge(),se.includes(Rt)||(le=[],ie=[],Ie=[],ye=[],se=[Rt]),Ro(),Rt=null),ht.style.display="none"}function eu(e){const t=Dd(K,H,{isToolbarExpanded:ls,isColorPaletteExpanded:ot,isColorModePanelExpanded:jt,isInterpolationPanelExpanded:nn,isTransformPanelExpanded:vn,isDisplayPanelExpanded:un,isVisibilityPanelExpanded:qa,isSessionsPanelExpanded:pt});if(Yt&&(!t||t.type!=="transformIcon")){Ge();const h=Ee(K),f=ke?Ko(h):h,u={id:Nt(),x:f.x,y:f.y,type:Js};ae.push(u),Ie=[u.id],Xe=u.id,le=[],ie=[],se=[],ye=[],Yt=!1,Js=null,To=null,fe.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!Ue){ir(K,e.shiftKey);const h=Ke&&Ke.element.type==="vertex"?q(Ke.element.id):null,f=Ke&&Ke.element.type==="edge"?Ke.element.edge:null,u=Ke&&Ke.element.type==="face"?Z.find(g=>ge(g)===Ke.element.id):null;if(h||f||u){Ge(),le=[],ie=[],se=[],Ie=[],ye=[],Xe=null,He=[],ot&&at();const g=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j?.interval1;if(h&&h.type==="regular")Ue=!0,it=h.id,Ze=[],qt=0,Ce=[h.id],window.currentDrawingPath=Ce;else if(f&&Ke){const p=Ke.point,y=Yl(f,p,g,Pe);y&&(Ue=!0,it=y.id,Ze=[],qt=0,Ce=[y.id],window.currentDrawingPath=Ce,Bt())}else if(u&&Ke){const p=Ke.point;let y=Pe(_e);const S=he[_e];if(S!==-1){const x=ue[S];x&&x.type==="colormap"&&(y=Ae(x,0))}const m={id:Nt(),...p,type:"regular",color:y};ae.push(m),Ue=!0,it=m.id,Ze=[],qt=0,Ce=[m.id],window.currentDrawingPath=Ce,Bt()}$t=!1,e.preventDefault();return}}if($t=!0,Oe=!1,fs=!1,ot){const h=(H.colorTargetIcons||[]).filter(f=>K.x>=f.x&&K.x<=f.x+f.width&&K.y>=f.y&&K.y<=f.y+f.height);if(h.length>0){const f=h[h.length-1],{element:u,shiftKey:g,ctrlKey:p}={element:f,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};g?He.includes(u.target)||He.push(u.target):p?He.includes(u.target)?He=He.filter(y=>y!==u.target):He.push(u.target):He=[u.target],at(),ee={target:"ui_icon_click",element:{...f,type:"colorTargetIcon"}},fe.style.cursor="default";return}for(const f of H.colorSwatches)if(K.x>=f.x&&K.x<=f.x+f.width&&K.y>=f.y&&K.y<=f.y+f.height){ee={target:"ui_swatch",element:{...f}},fe.style.cursor="default";return}}if(pt){const h=H.removeSessionButton;if(h&&K.x>=h.x&&K.x<=h.x+h.width&&K.y>=h.y&&K.y<=h.y+h.height){ee={target:"ui_session_remove"},fe.style.cursor="default";return}const f=H.addSessionButton;if(f&&K.x>=f.x&&K.x<=f.x+f.width&&K.y>=f.y&&K.y<=f.y+f.height){ee={target:"ui_session_add"},fe.style.cursor="default";return}for(const u of H.sessionIcons)if(K.x>=u.x&&K.x<=u.x+u.width&&K.y>=u.y&&K.y<=u.y+u.height){ee={target:"ui_session",element:{...u}},fe.style.cursor="default";return}}if(Hf(K,e.shiftKey,e.ctrlKey||e.metaKey)){ee={target:"ui"},fe.style.cursor="default";return}if(kf(e)){ee={target:"coord_system"};return}const n=Pl(K);let o=n?null:Zs(K),i=!n&&!o?Qs(K):null,s=!n&&!o&&!i?eo(K):null;const a=e.shiftKey||e.ctrlKey||e.metaKey,r=n||o||i||s;let c=!1;n?c=ye.includes(n.id):o?c=le.includes(o.id)||Ie.includes(o.id):i?c=ie.includes(ne(i)):s&&(c=se.includes(ge(s))),!Ue&&!a&&r&&!c&&(n?Ct([],[],[],!1,!1,!1,[n.id]):o?Ct([o.id],[],[],!1,!1,o.type!=="regular"):i?Ct([],[ne(i)],[],!1,!1):s&&Ct([],[],[ge(s)],!1,!1));let l=null;if(n)l=Ee(K);else if(o)l=o;else if(i){const h=q(i.id1),f=q(i.id2);l=bt(Ee(K),h,f)}else s&&(l=Ee(K));const d=Xe&&(le.length>0||ie.length>0||se.length>0||ye.length>0);ce=[],Se=[],ee={targetVertex:o,dragHandle:l,targetEdge:i,targetFace:s,targetText:n,target:r||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:d},o&&o.type!=="regular"&&(Ys=!0,Za(o.id,e.shiftKey,e.ctrlKey||e.metaKey))}function tu(){Ge();const e=[...le],t=[...ie],n=[...se],o=[...Ie],i=Xe;le=[],ie=[],se=[],Ie=[],ye=[],Xe=null;const s=parseInt(Ot,10)||1;let a=null;const r=Oe&&ce.length===1&&ee?.finalSnapResult?.snapType==="edge",c=new Set(Bs.map(y=>y.id));if(c.size>0){const y=new Map(Bs.map(P=>[P.id,P])),S=new Set(e);t.forEach(P=>{const[T,M]=P.split(Gs);T&&S.add(T),M&&S.add(M)}),n.forEach(P=>{const T=Z.find(M=>ge(M)===P);T&&Xl(T.id,Z).forEach(E=>S.add(E))});const m=Ye?null:wl(),{center:x,rotation:I=0,scale:b=1,directionalScale:v=!1,startVector:C}=Ye||{},w=-I*(180/Math.PI);qe.forEach(P=>{if(!c.has(P.id))return;const T=y.get(P.id)||P,M=El(T);if(T.anchorType!=="canvas"&&!M)return;const E=T.anchorType==="canvas"?T.position||P.position:M.anchor,N=T.anchorType==="canvas"?{x:0,y:0}:T.offset||{x:0,y:0},_=T.anchorType==="canvas"?T.position||P.position||{x:0,y:0}:{x:E.x+N.x,y:E.y+N.y},D=(()=>{if(T.anchorType==="vertex")return S.has(T.anchorId);if(T.anchorType==="edge"){if(t.includes(T.anchorId))return!0;const F=U.find(R=>ne(R)===T.anchorId);return F?S.has(F.id1)&&S.has(F.id2):!1}if(T.anchorType==="face"){if(n.includes(T.anchorId))return!0;const F=Z.find(R=>ge(R)===T.anchorId);return F?F.vertexIds.every(R=>S.has(R)):!1}return!1})();if(Ye){const F=ze(_,x,I,b,v,C);if(P.rotationDeg=(T.rotationDeg||0)+w,P.scale=(T.scale||1)*b,T.anchorType==="canvas")P.position=F;else{const R=D?ze(E,x,I,b,v,C):E,B={x:F.x-R.x,y:F.y-R.y};if(P.offset=B,P.anchorType==="edge"){const L=xa(P.anchorId,B);typeof L=="number"&&(P.edgeOffsetFactor=L)}}}else if(m){if(T.anchorType==="canvas"){const F=T.position||P.position||{x:0,y:0};P.position={x:F.x+m.x,y:F.y+m.y}}else if(!D){const F=T.offset||{x:0,y:0},R={x:F.x+m.x,y:F.y+m.y};if(P.offset=R,P.anchorType==="edge"){const B=xa(P.anchorId,R);typeof B=="number"&&(P.edgeOffsetFactor=B)}}}})}if(r){const y=ee.finalSnapResult,S=ce[0].id,m=y.targetEdge,x=q(S);if(x&&m){const I=JSON.parse(JSON.stringify(U)),b=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;x.x=y.pos.x,x.y=y.pos.y,U=U.filter(T=>ne(T)!==ne(m));const v=q(m.id1),C=q(m.id2),w=ms(v,x,b,Pe),P=ms(C,x,b,Pe);Ms(w),Ms(P),U.push(w),U.push(P),Cs(I,U)}}else if(Ye){const{center:y,rotation:S,scale:m,directionalScale:x,startPos:I}=Ye,b={x:I.x-y.x,y:I.y-y.y};ce.forEach(v=>{const C=q(v.id);if(C){const w=ze(v,y,S,m,x,b);C.x=w.x,C.y=w.y}})}else if(Se.length>0){const y=ee.finalSnapResult&&ee.finalSnapResult.snapped?ee.finalSnapResult.finalDelta:{x:Se[0].x-ce[0].x,y:Se[0].y-ce[0].y},S=ce.filter(m=>m.type==="regular");if(s>1&&S.length>0){const m=new Set(S.map(_=>_.id)),x=new Set(se),I=new Set(ie);se.forEach(_=>{const D=Z.find(F=>ge(F)===_);D&&D.vertexIds.forEach(F=>m.add(F))});const b=new Set;se.forEach(_=>{const D=Z.find(F=>ge(F)===_);if(D)for(let F=0;F<D.vertexIds.length;F++){const R=D.vertexIds[F],B=D.vertexIds[(F+1)%D.vertexIds.length];b.add(ne({id1:R,id2:B}))}});const v=U.filter(_=>{const D=ne(_);return I.has(D)||b.has(D)?!0:m.has(_.id1)&&m.has(_.id2)}),C=se.length>0?Z.filter(_=>x.has(ge(_))):Z.filter(_=>_.vertexIds.every(D=>m.has(D))),w=U.filter(_=>m.has(_.id1)&&!m.has(_.id2)||m.has(_.id2)&&!m.has(_.id1)),P=[],T=[],M=[];a={vertices:[],edges:[],faces:[],texts:[]};const E=new Set(ye),N=qe.filter(_=>{if(E.has(_.id))return!0;if(_.anchorType==="vertex")return m.has(_.anchorId);if(_.anchorType==="edge"){const D=U.find(F=>ne(F)===_.anchorId);return D?m.has(D.id1)&&m.has(D.id2):!1}if(_.anchorType==="face"){if(x.has(_.anchorId))return!0;const D=Z.find(F=>ge(F)===_.anchorId);return D?D.vertexIds.every(F=>m.has(F)):!1}return!1});for(let _=1;_<s;_++){const D=new Map,F=[],R=[],B=[],L=[];S.forEach(O=>{const $={x:O.x+y.x*_,y:O.y+y.y*_},A={...O,...$,id:Nt()};P.push(A),D.set(O.id,A.id),F.push(A.id)}),v.forEach(O=>{const $=D.get(O.id1),A=D.get(O.id2);if($&&A){const k={...O,id1:$,id2:A};T.push(k),R.push(ne(k))}}),w.forEach(O=>{const $=m.has(O.id1)?O.id2:O.id1,A=m.has(O.id1)?O.id1:O.id2,k=D.get(A);if(k){const V={...O,id1:k,id2:$};T.push(V)}}),C.forEach(O=>{const $=xs.get(O.id),A=O.vertexIds.map(k=>D.get(k));if(A.every(Boolean)){const k=JSON.parse(JSON.stringify(O));if(k.id=ge({vertexIds:A}),k.vertexIds=A,k.localCoordSystem&&$){const V={x:y.x*_,y:y.y*_};k.localCoordSystem.origin.x=$.origin.x+V.x,k.localCoordSystem.origin.y=$.origin.y+V.y}M.push(k),B.push(k.id)}}),N.forEach(O=>{const $=JSON.parse(JSON.stringify(O));if($.id=Nt(),O.anchorType==="canvas"){if(!$.position)return;$.position={x:$.position.x+y.x*_,y:$.position.y+y.y*_}}else if(O.anchorType==="vertex"){const A=D.get(O.anchorId);if(!A)return;$.anchorId=A}else if(O.anchorType==="edge"){const A=U.find(Y=>ne(Y)===O.anchorId);if(!A)return;const k=D.get(A.id1),V=D.get(A.id2);if(!k||!V)return;$.anchorId=ne({id1:k,id2:V})}else if(O.anchorType==="face"){const A=Z.find(V=>ge(V)===O.anchorId);if(!A)return;const k=A.vertexIds.map(V=>D.get(V));if(!k.every(Boolean))return;$.anchorId=ge({vertexIds:k})}qe.push($),E.has(O.id)&&L.push($.id)}),_===1&&(a={vertices:F,edges:R,faces:B,texts:L})}ae.push(...P),U.push(...T),Z.push(...M)}else s===1&&ce.forEach(m=>{const x=q(m.id);x&&(x.x=m.x+y.x,x.y=m.y+y.y)})}const l=new Set(ce.map(y=>y.id)),d=Z.filter(y=>y.vertexIds.some(S=>l.has(S)));d.length>0&&d.forEach(y=>{const S=xs.get(y.id);if(y.localCoordSystem&&S){const m=new Set(y.vertexIds),x=new Set(ce.map(b=>b.id));if([...m].every(b=>x.has(b))){if(Ye){const{center:b,rotation:v,scale:C,directionalScale:w,startPos:P}=Ye,T={x:P.x-b.x,y:P.y-b.y},M=ze(S.origin,b,v,C,w,T);if(y.localCoordSystem.origin=M,w){const E=Dn({x:1,y:0},S),N=ze(E,b,v,C,w,T);y.localCoordSystem.scale=J(M,N)}else y.localCoordSystem.angle=Mn(S.angle+v),y.localCoordSystem.scale=S.scale*C}else if(s===1){const b=ee.finalSnapResult&&ee.finalSnapResult.snapped?ee.finalSnapResult.finalDelta:{x:Se[0].x-ce[0].x,y:Se[0].y-ce[0].y};y.localCoordSystem.origin.x=S.origin.x+b.x,y.localCoordSystem.origin.y=S.origin.y+b.y}}else{const b=y.vertexIds.map(v=>q(v)).filter(Boolean);Bf(y,S,ce,b,q)}}}),Lf(Array.from(l),Ye);const{vertexMerges:h,edgeSplits:f}=xu(ae,U,oe),u=new Map;ae.forEach(y=>u.set(y.id,y.id));const g=y=>{if(!u.has(y)||u.get(y)===y)return y;const S=g(u.get(y));return u.set(y,S),S};h.forEach((y,S)=>{const m=g(S),x=g(y);m!==x&&u.set(x,m)});const p=new Set;if(ae.forEach(y=>{const S=g(y.id);y.id!==S&&p.add(y.id)}),p.size>0||f.size>0){const y=JSON.parse(JSON.stringify(U)),S=Ff(Z,g);U.forEach(m=>{m.id1=g(m.id1),m.id2=g(m.id2)}),ae=ae.filter(m=>!p.has(m.id)),U=U.filter((m,x,I)=>m.id1!==m.id2&&x===I.findIndex(b=>ne(b)===ne(m))),Cs(y,U),Z.forEach(m=>{const x=S.get(m.id);x&&(m.localCoordSystem=x)}),Es()}s>1&&a?(le=e.length>0?a.vertices.map(y=>g(y)):[],ie=t.length>0?a.edges:[],se=n.length>0?a.faces:[],ye=Bs.length>0?a.texts:[]):s===1&&(le=e.map(y=>g(y)),ie=t,se=n,ye=Bs.map(y=>y.id).filter(y=>qe.some(S=>S.id===y))),Ie=o,Xe=i,bi(),Bt()}function nu(e){const{shiftKey:t,ctrlKey:n,targetVertex:o,targetEdge:i,targetFace:s,targetText:a}=e,r=q(it);if(Ue&&r){Ge();const c=JSON.parse(JSON.stringify(U)),l=Po(r,K,t);let d=null;const h=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;if(l.snapType==="vertex"&&l.targetVertex)d=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)d=Yl(l.targetEdge,{x:l.x,y:l.y},h,Pe);else{let f=Pe(_e);const u=he[_e];if(u!==-1){const g=ue[u];g&&g.type==="colormap"&&(f=Ae(g,.5))}d={id:Nt(),x:l.x,y:l.y,type:"regular",color:f},ae.push(d)}if(d){if(!U.some(g=>g.id1===r.id&&g.id2===d.id||g.id2===r.id&&g.id1===d.id)){const g=ms(r,d,h,Pe);Ms(g),U.push(g),Cs(c,U),bi(),Z.forEach(p=>{p.color||(p.color=Pe(we))})}const u=Gr(r,d,U);u&&(Ze.length>0&&(Ze[Ze.length-1].turn=u.turnAngleRad),Ze.push({length:u.length,turn:0,endVertexColor:d.color}),qt=Ze.length-1,Rn=u.startVertex,dt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,Un=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Lt=u.turnAngleRad,qn=u.precedingSegmentAbsoluteAngleRad),Ce.push(d.id),window.currentDrawingPath=Ce,zl(),Gl(),Bt(),it=d.id}if(t&&d&&l){const f=Gr(r,d,U);f&&(Rn=f.startVertex,dt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):f.length,Un=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Lt=f.turnAngleRad,qn=f.precedingSegmentAbsoluteAngleRad)}de.count=0}else if(e.target==="canvas"){Ge();const c=Ne||Ee(K);let l=Pe(_e);const d=he[_e];if(d!==-1){const f=ue[d];f&&f.type==="colormap"&&(l=Ae(f,0))}const h={id:Nt(),...c,type:"regular",color:l};ae.push(h),Ue=!0,it=h.id,Ze=[],qt=0,Ce=[h.id],window.currentDrawingPath=Ce,Bt()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(a||o||i||s)){Ge();const l=a?a.id:s?ge(s):i?ne(i):o.id;let d;switch(a?d="text":s?d="face":o&&o.type!=="regular"?d="center":o?d="vertex":i&&(d="edge"),l&&de.targetId===l&&Date.now()-de.timestamp<Zo?de.count++:de.count=1,de.targetId=l,de.type=d,de.timestamp=Date.now(),de.count){case 1:de.type==="text"?Ct([],[],[],t,n,!1,[de.targetId]):de.type==="face"?Ct([],[],[de.targetId],t,n):de.type==="edge"?Ct([],[de.targetId],[],t,n):de.type==="vertex"?Ct([de.targetId],[],[],t,n):de.type==="center"&&Za(de.targetId,t,n);break;case 2:if(de.type==="text"){const f=vo(de.targetId);f&&_l(f,f.content||"")}else if(de.type==="vertex"){const f=hn(de.targetId,U);Ct([de.targetId,...f],[],[],t,n)}else if(de.type==="edge"){const f=U.find(u=>ne(u)===de.targetId);if(f){const u=[...ba(f.id1),...ba(f.id2)];Ct([],Array.from(new Set(u.map(g=>ne(g)))),[],t,n)}}else if(de.type==="face"){const f=Z.find(u=>ge(u)===de.targetId);if(f){const u=[],g=new Set;for(let p=0;p<f.vertexIds.length;p++){const y=f.vertexIds[p],S=f.vertexIds[(p+1)%f.vertexIds.length];g.add(ne({id1:y,id2:S}))}Z.forEach(p=>{if(ge(p)!==ge(f))for(let y=0;y<p.vertexIds.length;y++){const S=p.vertexIds[y],m=p.vertexIds[(y+1)%p.vertexIds.length];if(g.has(ne({id1:S,id2:m}))){u.push(ge(p));break}}}),Ct([],[],[ge(f),...u],t,n)}}break;case 3:if(de.type==="vertex"||de.type==="edge"||de.type==="face"){let f;if(de.type==="vertex")f=de.targetId;else if(de.type==="edge")f=de.targetId.split(Gs)[0];else if(de.type==="face"){const u=Z.find(g=>ge(g)===de.targetId);u&&(f=u.vertexIds[0])}if(f){const u=new Set(ko(f));if(de.type==="vertex")Ct(Array.from(u),[],[],t,n);else if(de.type==="edge"){const g=U.filter(p=>u.has(p.id1)&&u.has(p.id2)).map(p=>ne(p));Ct([],g,[],t,n)}else if(de.type==="face"){const g=Z.filter(p=>p.vertexIds.every(y=>u.has(y))).map(p=>ge(p));Ct([],[],g,t,n)}}}de.count=0;break}const h=[];se.length>0&&h.push(we),ie.length>0&&h.push(Re),le.length>0&&h.push(_e),ye.length>0&&h.push(It),h.length>0&&(He=h,ot&&at())}}}function su(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),o=`icon-${t.target}`;if(de.targetId===o&&n-de.timestamp<Zo){switch(Ge(),t.target){case _e:hi=!hi;break;case Re:fi=!fi;break;case we:Ln=!Ln;break}at(),de.count=0}de.targetId=o,de.timestamp=n;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),o=`swatch-${t.index}`;if(de.targetId===o&&n-de.timestamp<Zo){pi=!0,ho=t.index;const i=ue[t.index];let s;if(i.type==="color"){const a=Us(i.value);s={type:"colormap",points:[{pos:.5,alpha:a.a,color:[a.r,a.g,a.b],order:1}]}}else i.type==="colormap"&&(s={type:"colormap",points:i.vertices.map(a=>({pos:a.pos,alpha:a.alpha!==void 0?a.alpha:1,color:Array.isArray(a.color)?[...a.color]:[a.color.r||0,a.color.g||0,a.color.b||0],order:a.order||1})),isCyclic:i.isCyclic===!0});Bn.show(void 0,void 0,s),de.count=0}else He.length>0&&(Ge(),He.forEach(i=>he[i]=t.index),ki(),Ka(),at());de.targetId=o,de.timestamp=n;return}if(e.target==="ui_session"){const{element:t}=e;t&&t.index!==void 0&&ws(t.index);return}if(e.target==="ui_session_add"){pf();return}if(e.target==="ui_session_remove"){yt!==null&&$l(yt);return}}function ou(e){if(Xs||us||uo){if(Xs){if(H.colorTargetIcons.find(n=>n.target===wt.target)){const n=H.colorSwatches,o=al(K,n);o&&(he[wt.target]=o.index,xi(wt.target).forEach(i=>{he[i]=o.index}),Ka())}}else if(us){const t=H.removeColorButton;if(t&&K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height&&ue.length>1){const o=ue.indexOf(Pt.item);o!==-1&&er(o)}}else if(uo){const t=H.removeSessionButton;t&&K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height&&jo&&$l(jo.index)}Xs=!1,wt=null,us=!1,Pt=null,uo=!1,jo=null,ts=!1,ot&&at(),pt&&Ri()}else Oe?tu():ee&&(typeof ee.target=="string"&&ee.target.startsWith("ui")?su(ee):nu(ee));Ul()}function iu(e){$t=!0,jn=!1,bl=Ut,ee={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function au(e){if(Oe&&jn){const t=Ee({x:Math.min(Ut.x,K.x),y:Math.min(Ut.y,K.y)}),n=Ee({x:Math.max(Ut.x,K.x),y:Math.max(Ut.y,K.y)}),o=Math.min(t.x,n.x),i=Math.max(t.x,n.x),s=Math.min(t.y,n.y),a=Math.max(t.y,n.y),r=ae.filter(u=>u.type==="regular"&&u.x>=o&&u.x<=i&&u.y>=s&&u.y<=a).map(u=>u.id),c=ae.filter(u=>u.type!=="regular"&&u.x>=o&&u.x<=i&&u.y>=s&&u.y<=a).map(u=>u.id),l=new Set(r),d=U.filter(u=>l.has(u.id1)&&l.has(u.id2)).map(u=>ne(u)),h=Z.filter(u=>u.vertexIds.every(g=>l.has(g))).map(u=>ge(u));ee.shiftKey?(le=[...new Set([...le,...r])],ie=[...new Set([...ie,...d])],se=[...new Set([...se,...h])],Ie=[...new Set([...Ie,...c])]):ee.ctrlKey?(r.forEach(u=>{const g=le.indexOf(u);g>-1?le.splice(g,1):le.push(u)}),d.forEach(u=>{const g=ie.indexOf(u);g>-1?ie.splice(g,1):ie.push(u)}),h.forEach(u=>{const g=se.indexOf(u);g>-1?se.splice(g,1):se.push(u)}),c.forEach(u=>{const g=Ie.indexOf(u);g>-1?Ie.splice(g,1):Ie.push(u)})):(le=r,ie=d,se=h,Ie=c);const f=[];se.length>0&&f.push(we),ie.length>0&&f.push(Re),le.length>0&&f.push(_e),ye.length>0&&f.push(It),f.length>0&&(He=f,ot&&at())}else{if(pt&&H.sessionsPanelBounds){const t=H.sessionsPanelBounds;if(K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height){xf();return}}$f(e)}}function ru(e){e.preventDefault();const t=so(e,fe),n=e.deltaY>0?1/1.15:1.15;va(t,n)}function lu(){Io=!0}function cu(){Io=!1,Hl()}function du(e){e.preventDefault()}function hu(e,t){const n=parseInt(Ot||"1",10)||1,o=Ud(ce,ae,U,q,e,n,oe),i=o.finalDelta;ce.forEach(s=>{const a=Se.find(r=>r&&r.id===s.id);a&&(a.x=s.x+i.x,a.y=s.y+i.y)}),ql(i,o),ee.finalSnapResult=o}function fu(e){if(Ln&&ae.length>0&&(ll(Me,{allFaces:Z,hoveredFaceId:yn,selectedFaceIds:se,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,currentAltPressed:_t},xe,q,ge),se.length>0&&Sl(Me,{allFaces:Z,selectedFaceIds:se,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,initialDragVertexStates:ce,transformIndicatorData:Ye,highlightedEdgeForSnap:Cn,draggedFaceId:wo,coordSystemSnapAngle:Ks,coordSystemSnapType:Ss,coordSystemSnapScale:bn,initialCoordSystemStates:xs},xe,q)),Ue&&ke&&(dt!==null||Lt!==null)&&Ce.length>=1&&Rn){const o=q(Rn.id);if(o){const i={frozen_Origin_Data_to_display:o,displayAngleA_valueRad_for_A_equals_label:Lt,frozen_A_baseRad_to_display:qn,frozen_D_du_to_display:dt,frozen_D_g2g_to_display:Un};vh(Me,i,xe,Ee,{showAngles:Nn,showDistances:Sn,viewTransform:oe,mousePos:K,colors:e}),Mh(tt,i,{showAngles:Nn,showDistances:Sn,viewTransform:oe,mousePos:K,frozenReference_D_du:dt,distanceSigFigs:es,angleDisplayMode:on,colors:e},Ee,xe,xt)}}const t={lastGridState:j,showDistances:Sn,showAngles:Nn,distanceSigFigs:es,angleDisplayMode:on,angleSigFigs:qo,currentShiftPressed:ke,viewTransform:oe,colors:e};if(Oe){const o=new Set(ce.map(a=>a.id));let i=!1;if(ce.length>0){const a=new Set(ko(ce[0].id));i=!(o.size===a.size&&[...o].every(r=>a.has(r)))}const s=ae.map(a=>Se.find(c=>c.id===a.id)||a);if(i&&ke)ce.forEach(a=>{hn(a.id,U).some(c=>!o.has(c))&&co(Me,tt,a.id,s,t,xe,c=>hn(c,U),ne,ke,null,xt,le,!0,ce,Xe,gt)});else if(ee&&(ee.targetVertex||ee.targetEdge)){const a=ee.targetVertex?ee.targetVertex.id:ce[0]?.id;a&&co(Me,tt,a,s,t,xe,r=>hn(r,U),ne,ke,null,xt,le,!0,ce,Xe,gt),ee.targetEdge&&Yr(Me,tt,ie,U,{showDistances:Sn,distanceSigFigs:es,colors:e,lastGridState:j,currentShiftPressed:ke},q,ne,xe,xt,Se,ce,Ye)}}else(Sn||Nn)&&!Ue&&!(parseInt(Ot||"1",10)>1&&Oe)&&!Yt&&(le.length>0&&le.length<=ad&&le.forEach(o=>{co(Me,tt,o,ae,{...t,currentShiftPressed:!1},xe,i=>hn(i,U),ne,!1,null,xt,le,!1,[],Xe)}),ie.length>0&&ie.length<=rd&&(Yr(Me,tt,ie,U,{showDistances:Sn,distanceSigFigs:es,colors:e,lastGridState:j},q,ne,xe,xt,Se,ce,Ye),Yh(Me,tt,ie,U,{showAngles:Nn,angleSigFigs:qo,angleDisplayMode:on,currentShiftPressed:ke,distanceSigFigs:es,viewTransform:oe,lastGridState:j,colors:e},q,ne,xe,o=>hn(o,U),xt)));const n=!_t&&(gn||Tn||yn);if(Ue&&it&&!n){const o=q(it);if(o){const i=or(o.id),s=Po(o,K,ke);let a=Pe(Re),r=null;const c=he[Re];if(c!==-1){const h=ue[c];if(h&&h.type==="colormap"&&Ce&&Ce.length>=1){const f=Ce.length,u=Ce.length-1,g=f>1?u/(f-1):0,p=f>1?(u+1)/f:1;r={colormapItem:h,startT:g,endT:p}}}dl(Me,{startVertex:o,snappedData:s,isShiftPressed:ke,currentColor:Pe(_e),nextCreationColor:Pe(_e),nextEdgeColor:a,colors:e,edgeColormapInfo:r,interpolationStyle:Ii()},xe);const l={x:s.x,y:s.y};ul(Me,tt,o,l,s,{showDistances:Sn,showAngles:Nn,currentShiftPressed:ke,distanceSigFigs:es,angleSigFigs:qo,angleDisplayMode:on,viewTransform:oe,frozenReference_D_du:dt,gridDisplayMode:st,frozenReference_A_rad:Lt,colors:e},xe,i,xt)}}if(Ne&&!n){const o={...Ne,id:"ghost",type:"regular"};ri(Me,o,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:dn==="vertex"||dn==="edge_fraction"||dn==="edge"?dn:null,currentAltPressed:_t},xe)}if(jn&&Oe&&Xh(Me,bl,K,e),uh(Me,{info:{...di,startVertex:q(it)},colors:e},xe,q,xt),(Ye||fn)&&xh(Me,tt,{transformIndicatorData:Ye,colors:e,coordSystemTransformIndicatorData:fn,currentShiftPressed:ke},xe,xt),Ne&&!n){const o={...Ne,id:"ghost",type:"regular"},i=dn==="vertex"||dn==="edge_fraction"||dn==="edge";i?ri(Me,o,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:i?dn:null,currentAltPressed:_t},xe):Ya(Me,o,{colors:e,verticesVisible:!0,isSnapped:!0},xe)}}function uu(e){if(gn=null,Tn=null,yn=null,Ne=null,dn=null,!$t){if(!_t){const s=Pl(e);if(s){s.id;return}}const t=Zs(e),n=t?null:Qs(e),o=!t&&!n?eo(e):null,i=t||n||o;if(_t)i?ir(e,ke):Ke=null,gn=null,Tn=null,yn=null;else if(t?gn=t.id:n?Tn=ne(n):o&&(yn=o.id),ke&&!i){Ee(e);const s=Po({id:"dummy_start",x:0,y:0},e,!0);s.snapped&&(Ne={x:s.x,y:s.y},dn=s.snapType)}}}function pu(e){if(it){const t=q(it);if(t)if(ke){const n=Po(t,e,ke);di=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else di=null}Ne=null}function gu(e,t,n,o){const i=vf(n,e,t,o,Uo);let s={},a={};if(o===Qt)s=Cf(n,ce,t,i.rotation,e),a={rotation:s.rotation,scale:1,directionalScale:!1},Uo=i.rotation;else if(o===On)s=Ef(n,ce,t,i.scale),a={rotation:0,scale:s.scale||i.scale,directionalScale:!1};else if(o===an)s=Mf(n,ce,t,i.rotation,i.scale),a={rotation:s.rotation,scale:s.scale,directionalScale:!1},Uo=i.rotation;else if(o===Zn){const h={x:t.x-n.x,y:t.y-n.y};s=wf(n,ce,t,i.scale,h,e),a={rotation:0,scale:s.scale||i.scale,directionalScale:!0}}s.snapped&&s.snapType==="projection"&&s.projectionSource&&(Ne=s.projectionSource);const r={x:t.x-n.x,y:t.y-n.y};Ye={center:n,startPos:t,currentPos:s.pos||e,rotation:a.rotation,scale:a.scale,isSnapping:s.snapped||!1,transformType:o,directionalScale:a.directionalScale,snappedScaleValue:s.snappedScaleValue||null,gridToGridInfo:s.gridToGridInfo||null,gridPoint:s.gridPoint||null,nearbyVertex:s.nearbyVertex||null,projectionPoint:s.projectionPoint||null,projectionSource:s.projectionSource||null,snapType:s.snapType||null,projectionCenter:s.snapType==="projection"?n:null,projectionHandleInitial:s.projectionHandleInitial||null,startVector:r};const c={x:t.x-n.x,y:t.y-n.y};if(Se=ce.map(h=>{const f=ze(h,n,a.rotation,a.scale,a.directionalScale,c);return{...h,x:f.x,y:f.y}}),s.snapped&&s.snapType==="merge"&&s.mergingVertex&&s.mergeTarget){const h=ce.find(f=>f.id===s.mergingVertex.id);if(h){const f=Se.find(u=>u.id===h.id);if(f){const u={x:s.mergeTarget.x-f.x,y:s.mergeTarget.y-f.y};Se.forEach(g=>{g.x+=u.x,g.y+=u.y}),Ye.currentPos&&(Ye.currentPos.x+=u.x,Ye.currentPos.y+=u.y)}}}const l=Be*2/oe.scale,d=ae.filter(h=>h.type==="regular"&&!ce.some(f=>f.id===h.id));Se.forEach(h=>{h.type==="regular"&&d.forEach(f=>{J(h,f)<l&&vs.push({x:f.x,y:f.y})})});for(let h=0;h<Se.length;h++)for(let f=h+1;f<Se.length;f++){const u=Se[h],g=Se[f];u.type==="regular"&&g.type==="regular"&&J(u,g)<l&&vs.push({x:(u.x+g.x)/2,y:(u.y+g.y)/2})}}function yu(e){if(Xs&&wt){const t=H.colorTargetIcons.find(n=>n.target===wt.target);if(t){const n=[...H.colorSwatches],o=al(e,n);o?(t.x=o.x+(o.width-t.width)/2,t.y=o.y-t.height-5,wt.previewColorIndex=o.index,xi(wt.target).forEach(i=>{const s=H.colorTargetIcons.find(a=>a.target===i);s&&(s.x=t.x,s.y=t.y)})):(t.x=e.x-wt.offsetX,t.y=e.y-wt.offsetY,wt.previewColorIndex=wt.originalColorIndex,xi(wt.target).forEach(i=>{const s=H.colorTargetIcons.find(a=>a.target===i);s&&(s.x=t.x,s.y=t.y)}))}return!0}if(us){const t=H.removeColorButton,n=t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height;if(n&&ue.length>1&&!ts){ts=!0;const s=ue.indexOf(Pt.item);return s>=0&&(er(s),at()),!0}else if(!n&&ts)return ts=!1,ue.splice(Pt.originalIndex,0,Pt.item),Object.keys(he).forEach(s=>{he[s]>=Pt.originalIndex&&he[s]++}),Object.keys(Pt.originalAssignments).forEach(s=>{Pt.originalAssignments[s]===Pt.originalIndex&&(he[s]=Pt.originalIndex)}),at(),!0;if(ts)return!0;const o=ue.indexOf(Pt.item);let i=o;for(let s=0;s<H.colorSwatches.length;s++){const a=H.colorSwatches[s];if(e.x>=a.x&&e.x<=a.x+a.width){i=ue.indexOf(a.item);break}}if(i!==o){const s=ue[o];ue.splice(o,1),ue.splice(i,0,s),Object.keys(he).forEach(a=>{he[a]===o?he[a]=i:he[a]>o&&he[a]<=i?he[a]--:he[a]<o&&he[a]>=i&&he[a]++}),at()}return!0}return!!uo}function ar(){if($t||Ue){Ke=null,Ne=null,gn=null,Tn=null,yn=null;return}_t?ir(K,ke):(Ke=null,uu(K))}function mu(e){if(K=so(e,fe),ke=e.shiftKey,_t=e.altKey,tr(K)?fe.style.cursor="default":Yt?fe.style.cursor="none":fs||Oe?fe.style.cursor="grabbing":fe.style.cursor="crosshair",$t){if(!Oe&&J(K,Ut)>Ac&&!Ue){if(Oe=!0,ee&&ee.target==="coord_system")return;if(gi=ee.dragHandle,ui=ee.target==="edge",ee.target==="ui_icon_click"){Xs=!0;const t=vl(ee.element.target);wt={target:t,offsetX:K.x-ee.element.x,offsetY:K.y-ee.element.y,originalColorIndex:he[t],previewColorIndex:he[t]},ee.target="ui_icon_drag",He=[t,...xi(t)]}else if(ee.target==="ui_swatch")Ge(),us=!0,Pt={index:ee.element.index,item:ee.element.item,offsetX:K.x-ee.element.x,originalIndex:ee.element.index,originalAllColors:JSON.parse(JSON.stringify(ue)),originalAssignments:JSON.parse(JSON.stringify(he))};else if(ee.target==="ui_session")uo=!0,jo={index:ee.element.index,session:ee.element.session,offsetX:K.x-ee.element.x,offsetY:K.y-ee.element.y},ee.target="ui_session_drag";else if(mn===2){jn=!0;return}else if(ee.target==="canvas")fs=!0,Qi={x:oe.offsetX,y:oe.offsetY},fe.style.cursor="move";else{fe.style.cursor="grabbing",Ys=ee.targetVertex&&ee.targetVertex.type!=="regular"&&!ee.isTransformDrag;let n;if(Ys)n=[ee.targetVertex];else{let i=new Set(le);ie.forEach(s=>{const[a,r]=s.split(Gs);i.add(a),i.add(r)}),se.forEach(s=>{const a=Z.find(r=>ge(r)===s);a&&Xl(a.id,Z).forEach(c=>i.add(c))}),n=Array.from(i).map(s=>q(s)).filter(s=>s&&s.type==="regular")}if(Ys&&ee.targetVertex.type===Qt){const i=ee.targetVertex,s=Ee(Ut),a={x:s.x-i.x,y:s.y-i.y};ee.initialRotationStartAngle=Math.atan2(a.y,a.x),Uo=0}const o=ye.map(i=>vo(i)).filter(Boolean);if(n.length>0||o.length>0){ce=JSON.parse(JSON.stringify(n)),Se=JSON.parse(JSON.stringify(n)),Bs=JSON.parse(JSON.stringify(o)),ga=JSON.parse(JSON.stringify(o)),xs.clear();const i=new Set(ce.map(s=>s.id));Z.forEach(s=>{s.vertexIds.some(a=>i.has(a))&&s.localCoordSystem&&xs.set(s.id,JSON.parse(JSON.stringify(s.localCoordSystem)))})}}}if(Oe){if(fs){const t=K.x-Ut.x,n=K.y-Ut.y;oe.offsetX=Qi.x+t*Ve,oe.offsetY=Qi.y-n*Ve}else if(!jn){if(yu(K)||qf(e))return;if(Xe&&(le.length>0||ie.length>0||se.length>0||ye.length>0)&&!ui){const n=q(Xe);let o=gi;!o&&ce.length>0&&(o=ce.find(i=>i.type==="regular"&&J(i,n)>1e-6)||ce.find(i=>i.type==="regular")),n&&o&&gu(Ee(K),o,n,n.type)}else if(Se.length>0){const n=ce.length===1&&ce[0].type==="regular",o=Ee(K);if(n){const i=ce[0];hn(i.id,U).filter(a=>!ce.some(r=>r.id===a)).map(a=>q(a));const s=sf(i,o);if(Se[0].x=s.pos.x,Se[0].y=s.pos.y,gt.clear(),bs.clear(),s.snapped){const a={copyIndex:0,type:s.snapType,projectionLine:s.projectionLine};gt.set(i.id,[a]),s.targetEdge&&bs.set(ne(s.targetEdge),[{copyIndex:0,type:"external_to_static"}])}ee.finalSnapResult={...s,finalDelta:{x:s.pos.x-i.x,y:s.pos.y-i.y}}}else{const i=Ee(Ut),s={x:o.x-i.x,y:o.y-i.y};hu(s)}}else if(ga.length>0){const n=Ee(Ut),o=Ee(K),i={x:o.x-n.x,y:o.y-n.y};ee.textFinalDelta=i}}}}else Ue?pu(K):ar()}function ql(e,t){if(gt.clear(),bs.clear(),!t||!t.snapped)return;const n=(o,i,s,a)=>{if(i===void 0)return;let r;if(s===void 0)r=void 0;else if(s===-1)r=0;else if(s>=0)r=s;else return;(r===void 0||r>=0)&&(o.has(i)||o.set(i,[]),o.get(i).some(c=>c.copyIndex===r&&c.type===a)||o.get(i).push({copyIndex:r,type:a}))};t.mergePairs.forEach(o=>{n(gt,o.source.originalId,o.source.transformIndex,"vertex"),n(gt,o.target.originalId,o.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:o,targetEdge:i})=>{n(gt,o.originalId,o.transformIndex,"edge"),n(bs,i.originalEdgeId,i.transformIndex,"vertex_on_edge")})}function xu(e,t,n){const o=2*Be/n.scale,i=new Map,s=new Map,a=new Map;e.forEach(d=>a.set(d.id,d.id));const r=d=>{if(!a.has(d)||a.get(d)===d)return d;const h=r(a.get(d));return a.set(d,h),h};for(let d=0;d<e.length;d++)for(let h=d+1;h<e.length;h++){const f=e[d],u=e[h];if(f.type==="regular"&&u.type==="regular"&&J(f,u)<o){const g=r(f.id),p=r(u.id);g!==p&&a.set(p,g)}}e.forEach(d=>{const h=r(d.id);d.id!==h&&i.set(d.id,h)});const c=new Set(i.keys()),l=new Map(e.map(d=>[d.id,d]));return t.forEach(d=>{const h=r(d.id1),f=r(d.id2);if(h===f)return;const u=l.get(h),g=l.get(f);!u||!g||e.forEach(p=>{if(p.type!=="regular"||c.has(p.id)||p.id===h||p.id===f)return;const y=bt(p,u,g);if(y.distance<o&&y.onSegmentStrict){const S=ne({id1:h,id2:f});s.has(S)||s.set(S,{edge:{id1:h,id2:f},pointsToInsert:[]}),s.get(S).pointsToInsert.push(p)}})}),{vertexMerges:i,edgeSplits:s}}function Su(e){Kn?Uf():mn===0?ou():mn===2&&au(e),Kn||Ul(),tr(K)?fe.style.cursor="default":Yt||(fe.style.cursor="crosshair"),Ht()}function Ul(){Vt&&clearTimeout(Vt),Ot="",Vt=null,$t=!1,Oe=!1,jn=!1,ui=!1,Ys=!1,fs=!1,Se=[],ce=[],ga=[],Bs=[],ee=null,Ye=null,vs=[],Ne=null,bs.clear(),gt.clear(),xs.clear(),mn=-1}function Iu(e){Vt&&clearTimeout(Vt),Ot="",Vt=null,ht.style.display==="block"&&(ht.style.display="none");const t=e.target;if(t&&(t.tagName==="INPUT"||t.closest(".katex"))){e.stopPropagation();return}if((Ue||Yt)&&e.button===2){Jn(),e.preventDefault();return}K=so(e,fe),Ut={...K},mn=e.button,mn===0?eu(e):mn===2&&iu(e)}function bu(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;if(e.key==="Alt"&&!e.repeat&&(e.preventDefault(),_t=!0,ar()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!Ue&&!Yt&&!$t){e.preventDefault(),tf(e.key);return}const n=e.ctrlKey||e.metaKey;if(n&&(e.key==="a"||e.key==="A")){e.preventDefault();const i=ae.filter(c=>c.type==="regular").map(c=>c.id),s=U.map(c=>ne(c)),a=Z.map(c=>ge(c)),r=qe.map(c=>c.id);Ct(i,s,a,!1,!1,!1,r),Ie=ae.filter(c=>c.type!=="regular").map(c=>c.id),Xe=Ie.length>0?Ie[Ie.length-1]:null;return}if(e.key==="Shift"&&!ke){ke=!0;const i=Ee(K);if(Yt){const s=Ko(i);s&&(To=xe(s),Ne=s)}else if(Ue&&it){const s=q(it);if(s){const a=ja(),r=or(s.id),c=Po(s,K,ke);let l=Pe(Re),d=null;const h=he[Re];if(h!==-1){const u=ue[h];if(u&&u.type==="colormap"&&Ce&&Ce.length>=1){const g=Ce.length,p=Ce.length-1,y=g>1?p/(g-1):0,S=g>1?(p+1)/g:1;d={colormapItem:u,startT:y,endT:S}}}dl(Me,{startVertex:s,snappedData:c,isShiftPressed:ke,currentColor:Pe(_e),nextCreationColor:Pe(_e),nextEdgeColor:l,colors:a,edgeColormapInfo:d},xe),ul(Me,tt,s,c,c,{showDistances:Sn,showAngles:Nn,currentShiftPressed:ke,distanceSigFigs:es,angleSigFigs:qo,angleDisplayMode:on,viewTransform:oe,frozenReference_D_du:dt,gridDisplayMode:st,frozenReference_A_rad:Lt,colors:a},xe,r,xt)}}else if(!$t)if(Kn&&ln&&ln.type==="center"){const s=Ko(i);if(s){Ne=s;const a=ln.face,r=a.localCoordSystem,c=a.vertexIds.map(d=>q(d)).filter(d=>d&&d.type==="regular"),l=js(s,c);r.origin.x=l.x,r.origin.y=l.y,r.isCustom=!0}}else{const s=Zs(K),a=s?null:Qs(K),r=!s&&!a?eo(K):null;!s&&!a&&!r?Ne=Ko(i):Ne=null}}if($t&&mn===0&&(ee?.targetVertex||ee?.targetEdge||ee?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(Vt),Vt===null||Ot.length>=2?Ot=e.key:Ot+=e.key;const i=parseInt(Ot,10)||1;if(ee?.finalSnapResult?.finalDelta){const s=ee.finalSnapResult.finalDelta,a={delta:s},c=rl(ce,ae,U,q,i,oe,a,(l,d,h=a)=>({x:l.x+h.delta.x*d,y:l.y+h.delta.y*d}));ql(s,c),ee.finalSnapResult={...c,finalDelta:s}}Vt=setTimeout(()=>{Vt=null},500)}if(n&&e.key.toLowerCase()===bd){e.preventDefault(),Ue&&it&&Df();return}if(!($t&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(n&&[Ar,kr,Dr,qi,Rr,Lr,_r,Tr,Pr].includes(e.key.toLowerCase())))){if(Io&&n&&(e.key===Tr||e.key===Pr)){e.preventDefault();const i={x:fe.width/Ve/2,y:fe.height/Ve/2};va(i,Sr);return}if(Io&&n&&e.key===_r){e.preventDefault();const i={x:fe.width/Ve/2,y:fe.height/Ve/2};va(i,1/Sr);return}if(e.key===md)e.preventDefault(),bf();else if(e.key===xd)Jn();else if(e.key===Sd||e.key===Id)e.preventDefault(),Ro();else if(n&&e.key.toLowerCase()===Ar){if(pt&&Te[yt]){e.preventDefault(),fo=JSON.parse(JSON.stringify(Te[yt]));return}e.preventDefault(),Vl()}else if(n&&e.key.toLowerCase()===kr)e.preventDefault(),Sf();else if(n&&e.key.toLowerCase()===Dr){if(pt&&fo){e.preventDefault(),gf();return}e.preventDefault(),If()}else if(n&&e.key.toLowerCase()===qi&&!e.shiftKey){if(pt&&yi.length>0){e.preventDefault(),yf();return}e.preventDefault(),zf()}else if(n&&(e.key.toLowerCase()===Rr||e.shiftKey&&e.key.toLowerCase()===qi))e.preventDefault(),Gf();else if(n&&e.key.toLowerCase()===Lr&&!ya){e.preventDefault(),Ge(),le=ae.filter(s=>s.type==="regular").map(s=>s.id),ie=U.map(s=>ne(s)),se=Z.map(s=>s.id),Ie=ae.filter(s=>s.type!=="regular").map(s=>s.id),Xe=null;const i=[];se.length>0&&i.push(we),ie.length>0&&i.push(Re),le.length>0&&i.push(_e),ye.length>0&&i.push(It),i.length>0&&(He=i,ot&&at())}}}function vu(e){if(e.key==="Shift"&&(ke=!1,Ne=null,To=null,vs=[],Kn&&ln&&ln.type==="center")){const t=Ee(K),n=ln.face,o=n.localCoordSystem,i=n.vertexIds.map(a=>q(a)).filter(a=>a&&a.type==="regular"),s=js(t,i);o.origin.x=s.x,o.origin.y=s.y,o.isCustom=!0}e.key==="Alt"&&(_t=!1,ar()),Ht()}function jl(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,o=t.offsetHeight;fe.width=n*Ve,fe.height=o*Ve,fe.style.width=`${n}px`,fe.style.height=`${o}px`,tt&&(tt.style.width=`${n}px`,tt.style.height=`${o}px`)}function Mu(){Wh(),ue=Ei.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),af(),Al(),jl(),Bn=new ec,Bn.initialize(),document.body.appendChild(Bn.getElement());const e=Bn.getElement();e.addEventListener("mouseenter",()=>{ya=!0}),e.addEventListener("mouseleave",()=>{ya=!1}),Bn.getElement().addEventListener("select",n=>{const o=n.detail,i=zd(o);if(i){if(pi&&ho!==null)ue[ho]=i;else{cf(i);const s=ue.length-1;He.forEach(a=>{he[a]=s})}Ka(),pi=!1,ho=null,at()}}),Ls=new dc({container:document.body,onSelect:n=>{if(!n)return;const o={...n};o.id||(o.id=Nt());const i=pn.findIndex(s=>s.id===o.id);i>=0?pn[i]=o:pn.push(o),Ia(o.id),nn&&Dl(),Ht()}}),Ls.initialize(),oe.scale=70,oe.offsetX=fe.width/2,oe.offsetY=fe.height/2,Is="regular",ht=document.getElementById("context-menu"),window.addEventListener("click",()=>{ht&&(ht.style.display="none")}),ht.addEventListener("mouseleave",()=>{ht.style.display="none"}),ff()||(hf()||Ge(),uf()),Wl(),Bt()}fe.addEventListener("wheel",ru,{passive:!1});fe.addEventListener("mouseenter",lu);fe.addEventListener("mouseleave",cu);window.addEventListener("contextmenu",du);fe.addEventListener("mousemove",mu);fe.addEventListener("mouseup",Su);fe.addEventListener("mousedown",Iu);window.addEventListener("keyup",vu);window.addEventListener("keydown",bu);window.addEventListener("resize",jl);window.addEventListener("beforeunload",()=>{Fl()});window.addEventListener("load",Mu);

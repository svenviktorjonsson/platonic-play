(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const Yo="#3b82f6",Xo="#4a5568",Ho="#718096",kr=300,Go="#242c3a",Zn=2,ta=3,Se=9,zo=12,Rr=5,na=8,Ve=8,sa=.9,oa=5,Us=[4,4],Lr={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},Nr={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class Or{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=Lr,this.namedColormaps=Nr,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,i=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let o=.5,s=1;if(i&&i.type==="colormap"&&(i.points||i.controlPoints)){this.state.isCyclic=i.isCyclic===!0;let a=JSON.parse(JSON.stringify(i.controlPoints||i.points));if(a.length===1){a[0].pos=.5;const r=a[0].color,c=r[0]/255,l=r[1]/255,d=r[2]/255;o=(c+l+d)/3,s=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(r=>{const c=r.color,l=r.alpha!==void 0?r.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,l,r.pos,r.order??1)})}else this.state.points=[];this.state.viewLightness=o,this.state.viewAlpha=s,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async i=>{const o=await fetch(i);if(!o.ok)throw new Error(`Failed to fetch preset file at ${i}: Status ${o.status}`);return await o.json()},n=i=>{try{const o=localStorage.getItem(i);return o?JSON.parse(o):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:i}=t.dataset;if(i==="named_colors"||i==="custom_colors"){let o;if(i==="named_colors"?o=this.namedColors[n]:o=this.customColors[n]?.rgb,!o){console.error(`RGB undefined for ${n} in ${i}`);return}this.applyColorToSelection(o)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const o=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(o==="Cancel"||o==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,i)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,i=t[1]/255,o=t[2]/255;if(this.state.selectedPointIds.size===0){const s=this.state.points.length;s>0&&this.state.points.forEach(c=>{c.pos=c.pos*(s/(s+1))});const a=s===0?.5:1,r=this.createPointFromRgb(n,i,o,1,a,1);this.state.points.push(r),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const r=this.convertRgbToCurrentColorspace(n,i,o);a.hsPos=r.hsPos,a.originalHsPos={...r.hsPos},a.lightness=r.lightness}});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha)}this.drawAll()}loadColormap(t,n,i=!1){i||this.saveState();const o=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!o||!o.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const s=o.points.map(a=>{let r=[0,0,0];typeof a.color=="string"?r=this.namedColors[a.color]||this.customColors[a.color]?.rgb||r:Array.isArray(a.color)&&(r=a.color);const c=r[0]/255,l=r[1]/255,d=r[2]/255,f=a.alpha??1;return this.createPointFromRgb(c,l,d,f,a.pos,a.order)});this.state.points=s,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=o.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=(V,F={})=>{const O=document.createElement(V);if(F.id){O.id=F.id;const H=F.id.replace(/-(\w)/g,(U,$)=>$.toUpperCase());this.elements[H]=O}return F.className&&(O.className=F.className),F.text&&(O.textContent=F.text),F.type&&(O.type=F.type),F.placeholder&&(O.placeholder=F.placeholder),O};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),i=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),o=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const s=t("div",{id:"selected-color-section",className:"control-section"}),a=t("div",{id:"current-colormap-section",className:"control-section"}),r=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),r.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(r,c);const d=t("h2",{className:"panel-header",text:"Lightness"}),f=t("div",{id:"lightness-slider-container",className:"canvas-container"}),h=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});f.append(t("canvas",{id:"lightness-bg-canvas"}),h),i.append(d,f);const u=t("h2",{className:"panel-header",text:"Alpha"}),p=t("div",{id:"alpha-slider-container",className:"canvas-container"}),g=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});p.append(t("canvas",{id:"alpha-bg-canvas"}),g),o.append(u,p);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const S=t("div",{className:"preset-category-header"});S.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(S,t("div",{className:"preset-items-container"}));const m=t("h3",{className:"section-title",text:"Selected Color"}),I=t("div",{className:"preview-container"});I.append(t("canvas",{id:"selected-color-preview-canvas"}));const x=t("div",{className:"space-y-2"}),v=t("div",{className:"values-grid"});v.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const A=t("div");A.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const T=t("div");T.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const E=t("div");E.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),v.append(A,T,E),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const M=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),w=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),b=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(M,w,b),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const C=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),_=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(C,_);const P=t("h3",{className:"input-label",text:"Interpolation"});P.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const D=t("div",{className:"interpolation-grid"});D.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),D.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),x.append(v,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,P,D),s.append(m,I,x);const R=t("h3",{className:"section-title text-center",text:"Current Colormap"}),N=t("div",{className:"preview-container"});N.append(t("canvas",{id:"colormap-preview-canvas"}));const B=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const k=t("div",{className:"button-row"});k.append(this.elements.reverseButton,this.elements.cycleButton),B.append(k,this.elements.closeButton,this.elements.selectButton),a.append(R,N,B),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const L=t("div",{id:"modal-dialog",className:"modal-dialog"});L.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),L.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(L),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,i,this.elements.colorsPresetsWrapper,s,o,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(h,"lightness"),this.createInteractiveCanvas(g,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",o=>{o.preventDefault(),o.stopPropagation(),o.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(o=>{o.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),o.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",o=>this.handleMouseDown(o,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",o=>this.handleMouseDown(o,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",o=>this.handleMouseDown(o,"alpha")),document.addEventListener("keydown",o=>this.handleKeyDown(o)),this.elements.lightnessInput.addEventListener("change",o=>this.handleInputChange(o,"lightness")),this.elements.alphaInput.addEventListener("change",o=>this.handleInputChange(o,"alpha")),this.elements.positionInput.addEventListener("change",o=>this.handleInputChange(o,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const i=o=>{const s=o.target.closest(".preset-item");s&&(o.type==="click"?this.handlePresetClick(s):o.type==="contextmenu"&&s.dataset.custom==="true"&&(o.preventDefault(),o.stopPropagation(),this.showContextMenu(o,s.dataset.name,s.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",i),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",i),this.elements.colormapsPresetsWrapper.addEventListener("click",i),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",i),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let o=[];const s=this.state.points,a=s.length,r=(u,p)=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(g);return{pos:parseFloat((p!==void 0?p:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let p=0;p<u;p++){const g=s[p],y=s[(p+1)%a];o.push(r(g));const S=Math.max(g.order,y.order);if(S===0){let m=g.pos,I=y.pos;this.state.isCyclic&&I<m&&(I+=1);const x=m+(I-m)*.5;o.push(r(g,this.wrapPositionCyclic(x-1e-6))),o.push(r(y,this.wrapPositionCyclic(x)))}else if(S===3){const I=g.pos;let x=y.pos;this.state.isCyclic&&x<I&&(x+=1);const v=x-I;for(let A=1;A<16;A++){const T=A/16,E=I+T*v,M=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(E));if(M){const w=this.abstractToRgb(M.u,M.v,M.lightness),b=this.clampColor(w);o.push({pos:parseFloat(this.wrapPositionCyclic(E).toFixed(6)),alpha:parseFloat(M.alpha.toFixed(4)),color:[b.r,b.g,b.b],order:M.order})}}}}this.state.isCyclic||o.push(r(s[a-1]))}const c=new Map;o.forEach(u=>c.set(u.pos,u));let l=Array.from(c.values()).sort((u,p)=>u.pos-p.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const d=this.state.points.map(u=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),g=this.clampColor(p);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[g.r,g.g,g.b],order:u.order}}),f={points:l,controlPoints:d,isCyclic:this.state.isCyclic},h=new CustomEvent("select",{detail:f,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(h)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,i){this.hideContextMenu();const o=this.elements.contextMenu;o.innerHTML="";const s={Rename:()=>this.handlePresetAction("rename",n,i),Delete:()=>this.handlePresetAction("delete",n,i)};for(const[a,r]of Object.entries(s)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=r,o.appendChild(c)}o.style.left=`${t.clientX}px`,o.style.top=`${t.clientY}px`,o.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,i){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(i==="custom_colors"&&delete this.customColors[n],i==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(i),this.populatePresets());else if(t==="rename"){const o=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(o&&o!==n){const s=i==="custom_colors"?this.customColors:this.customColormaps;if(s[o]){this.showPrompt(`"${o}" already exists.`,["OK"]);return}s[o]=s[n],delete s[n],this.saveCustomPresets(i),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const i=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!i)return!1;if(t==="custom_colors"){const o=this.getLastSelectedPoint();if(!o)return!1;const s=this.abstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness),a=this.clampColor(s);this.customColors[i]={rgb:[a.r,a.g,a.b],alpha:o.alpha}}else{const o=this.state.points.map(s=>{const a=this.abstractToRgb(s.hsPos.u,s.hsPos.v,s.lightness),r=this.clampColor(a);return{pos:s.pos,alpha:s.alpha,color:[r.r,r.g,r.b],order:s.order}});this.customColormaps[i]={points:o,isCyclic:this.state.isCyclic},this.state.loadedColormapName=i,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(s,a)=>{const r=document.createElement("div");r.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=s;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=a,r.appendChild(c),r.appendChild(l),r},n=(s,a,r,c)=>{Object.keys(a).sort().forEach(l=>{const d=document.createElement("div");d.className="preset-item",d.dataset.name=l,d.dataset.type=r,d.dataset.custom=c;const f=document.createElement("canvas");f.className="preset-icon",r.includes("colormap")?(f.width=64,f.height=16):(f.width=16,f.height=16);const h=document.createElement("span");if(h.textContent=l,d.appendChild(f),d.appendChild(h),s.appendChild(d),r==="named_colors"||r==="custom_colors"){const u=a[l],p=c?u.rgb:u;this.drawColorIcon(f,p)}else this.drawColormapIcon(f,a[l].points,this.namedColors,this.customColors)})},i=document.createElement("div");i.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(i),n(i,this.namedColors,"named_colors",!1),n(i,this.customColors,"custom_colors",!0);const o=document.createElement("div");o.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(o),n(o,this.namedColormaps,"named_colormaps",!1),n(o,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,i,o){const s=n.map(d=>{let f=[0,0,0];typeof d.color=="string"?f=i[d.color]||(o[d.color]?o[d.color].rgb:[0,0,0]):Array.isArray(d.color)&&(f=d.color);const{hsPos:h,lightness:u}=this.convertRgbToCurrentColorspace(f[0]/255,f[1]/255,f[2]/255);return{id:Math.random(),hsPos:h,originalHsPos:{...h},lightness:u,alpha:d.alpha??1,pos:d.pos,order:1}}).sort((d,f)=>d.pos-f.pos),a=this.state.points;this.state.points=s;const r=t.getContext("2d"),{width:c,height:l}=t;if(this.drawCheckerboard(r),this.state.points.length>0)for(let d=0;d<c;d++){const f=d/(c-1),h=this.getInterpolatedPropertiesAt(f);if(!h)continue;const u=this.clampAbstractPoint(h.u,h.v,h.lightness),p=this.abstractToRgb(u.u,u.v,h.lightness),{r:g,g:y,b:S}=this.clampColor(p);r.fillStyle=`rgba(${g}, ${y}, ${S}, ${h.alpha})`,r.fillRect(d,0,1,l)}this.state.points=a}showPrompt(t,n,i=null){return new Promise(o=>{const{modalOverlay:s,modalTitle:a,modalInputContainer:r,modalInput:c,modalButtons:l}=this.elements,d=document.querySelectorAll("[data-tick-canvas]");d.forEach(f=>f.style.display="none"),a.textContent=t,l.innerHTML="",i?(c.value=i.value||"",c.placeholder=i.placeholder||"",r.classList.remove("hidden")):r.classList.add("hidden"),n.forEach(f=>{const h=document.createElement("button");h.className=`modal-button ${f==="Save"||f==="Delete"||f==="Rename"?"modal-button-primary":"modal-button-secondary"}`,h.textContent=f,h.onclick=()=>{s.classList.add("hidden"),d.forEach(u=>u.style.display=""),o(i?c.value:f)},l.appendChild(h)}),s.classList.remove("hidden"),i&&c.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(i=>i.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(i=>Math.abs(i.pos)<1e-6),n=this.state.points.some(i=>Math.abs(i.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(s=>({id:s.id,pos:s.pos}));const o=1-1/this.state.points.length;this.state.points.forEach(s=>{s.pos*=o})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const i=t.getContext("2d");i.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,i.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,i,o,s,a){const{hsPos:r,lightness:c}=this.convertRgbToCurrentColorspace(t,n,i);return{id:Date.now()+Math.random(),hsPos:r,originalHsPos:{...r},lightness:c,alpha:o,pos:s,order:a}}convertRgbToCurrentColorspace(t,n,i){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:i}),lightness:(t+n+i)/3};{const o=this.rgbToHsl(t,n,i);return{hsPos:this.rgbToHslDiConeAbstract(t,n,i),lightness:o.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:d,clientHeight:f}=l.container;(l.c.width!==d||l.c.height!==f)&&(l.c.width=d,l.c.height=f)});const o=this.elements.hsBgCanvas,s=this.elements.interactiveCanvases.hs,a=o.parentElement,r=a.clientWidth,c=a.clientHeight;[o,s].forEach(l=>{l&&(l.width=r,l.height=c,l.style.width=`${r}px`,l.style.height=`${c}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(o=>{let s;n==="RGB_CUBE"?s=this.rgbCubeAbstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness):s=this.hslDiConeAbstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness);let a,r;if(t==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(s),r=(s.r+s.g+s.b)/3;else{const c=this.rgbToHsl(s.r,s.g,s.b);a=this.rgbToHslDiConeAbstract(s.r,s.g,s.b),r=c.l}o.hsPos=a,o.originalHsPos={...a},o.lightness=r});const i=this.getLastSelectedPoint();i&&(this.state.viewLightness=i.lightness,this.state.viewAlpha=i.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const i=Date.now(),o=this.elements.interactiveCanvases[n];if(!o)return;const s=o.getBoundingClientRect(),a=o.width/s.width,r=o.height/s.height,c=(t.clientX-s.left)*a,l=(t.clientY-s.top)*r,d={x:c,y:l};let f=!1,h=null,u=!1;if(n==="hs")h=this.findHitPointHS(c,l);else{const S=this.findHitPointSlider(c,l,n);h=S.hitPoint,u=S.hitLine}if(i-this.lastClickTime<kr&&h&&h.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=i,this.lastClickTarget=h?h.id:null,h){this.state.viewLightness=h.lightness,this.state.viewAlpha=h.alpha;const S=t.ctrlKey||t.metaKey,m=t.shiftKey;!this.state.selectedPointIds.has(h.id)&&!S&&!m&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(h.id),this.state.lastSelectedPointId=h.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=o,this.state.activeDrag.pointId=h?h.id:null,h){const S=new Map;if(n==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:m,offsetX:I,offsetY:x}=this.state.transform;this.state.points.forEach(v=>{if(this.state.selectedPointIds.has(v.id)){const A=v.hsPos.u*m+I,T=v.hsPos.v*m+x;this.state.activeDrag.initialPointPositions.set(v.id,{x:A,y:T})}})}else this.state.points.forEach(m=>{this.state.selectedPointIds.has(m.id)&&S.set(m.id,{lightness:m.lightness-h.lightness,alpha:m.alpha-h.alpha,pos:m.pos-h.pos})}),this.state.activeDrag.offsets=S}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const g=S=>{const m=(S.clientX-s.left)*a,I=(S.clientY-s.top)*r,x=Math.sqrt((m-d.x)**2+(I-d.y)**2);!f&&x>Rr&&(f=!0,h&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(S)},y=S=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y),f||this.handleClick(c,l,n,h,S),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",g),document.addEventListener("mouseup",y)}handleClick(t,n,i,o,s){const{shiftKey:a,ctrlKey:r,metaKey:c}=s,l=r||c;if(o){const{selectedPointIds:d}=this.state,f=o.id;if(this.clickCount===3)this.state.points.forEach(h=>d.add(h.id)),this.state.lastSelectedPointId=f;else if(this.clickCount===2){const h=this.state.points.findIndex(p=>p.id===f);d.clear(),[h-1,h,h+1].forEach(p=>{p>=0&&p<this.state.points.length&&d.add(this.state.points[p].id)}),this.state.lastSelectedPointId=f}else l?d.has(f)?(d.delete(f),this.state.lastSelectedPointId===f&&(this.state.lastSelectedPointId=d.size>0?Array.from(d)[0]:null)):(d.add(f),this.state.lastSelectedPointId=f):a?(d.add(f),this.state.lastSelectedPointId=f):(d.clear(),d.add(f),this.state.lastSelectedPointId=f)}else if(i==="hs")this.createNewPointHS(t,n);else if(i==="lightness"||i==="alpha"){const d=this.elements.interactiveCanvases[i],f=Math.ceil(Se*2.2),h=d.height-2*f,p=(d.height-f-n)/h,g=Math.max(0,Math.min(1,p));i==="lightness"?this.state.viewLightness=g:this.state.viewAlpha=g}this.drawAll()}findHitPointHS(t,n){const i=Math.ceil(Se*2.2),o=Math.ceil(Ve/2),s=i+o,a=s,r=s,c=this.elements.hsBgCanvas.width-s-i,l=this.elements.hsBgCanvas.height-s-i;for(const d of this.state.points){const f=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,h=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(f>=a-Se&&f<=a+c+Se&&h>=r-Se&&h<=r+l+Se&&Math.sqrt((t-f)**2+(n-h)**2)<=zo)return d}return null}handleInputChange(t,n){const i=t.target.value;if(this.state.selectedPointIds.size===0)return;let o=!1;if(n==="lightness"||n==="alpha"){const s=parseFloat(i);!isNaN(s)&&s>=0&&s<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[n]=s,n==="lightness"&&this.constrainPointToValidArea(a))}),o=!0)}else if(n==="position"){const s=parseFloat(i);!isNaN(s)&&s>=0&&s<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=s)}),this.sortPoints(),o=!0)}if(o){const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,i,o,s,a,r=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),i=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(i))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,i=Math.max(0,Math.min(255,i))/255;const c=this.rgbCubeRgbToAbstract({r:t,g:n,b:i}),l=(t+n+i)/3;this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...c},d.originalHsPos={...c},d.lightness=l)}),r=!0}else{if(o=parseFloat(this.elements.hslHInput.value),s=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(o)||isNaN(s))return;this.markAsDirty(),o=Math.max(0,Math.min(1,o)),s=Math.max(0,Math.min(1,s));const c=this.hslToRgb(o,s,a),l=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...l},d.originalHsPos={...l})}),r=!0}if(r){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const i=document.createElement("canvas");i.className=`interactive-canvas ${n}-interactive`,i.dataset.type=n,t.appendChild(i),this.elements.interactiveCanvases[n]=i}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:i,pointId:o}=this.state.activeDrag,s=i,a=s.getBoundingClientRect(),r=s.width/a.width,c=s.height/a.height,l=(t.clientX-a.left)*r,d=(t.clientY-a.top)*c;n.endsWith("-line")?this.handleLineDrag(d,s.height,n):o&&this.handlePointDrag(l,d,s,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),i=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:i}}rgbToHslDiConeAbstract(t,n,i){const o=this.rgbToHsl(t,n,i),s=1-Math.abs(2*o.l-1),a=o.s*s,r=o.h*2*Math.PI,c=a*Math.cos(r),l=a*Math.sin(r);return{u:c,v:l}}hslDiConeAbstractToRgb(t,n,i){const o=(Math.atan2(n,t)/(2*Math.PI)+1)%1,s=Math.sqrt(t*t+n*n),a=i,r=1-Math.abs(2*a-1);if(r<1e-9)return{r:a,g:a,b:a};const c=s/r;return this.hslToRgb(o,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,i=n&&n.tagName==="INPUT",o=t.ctrlKey||t.metaKey;if(o&&t.key==="z"){t.preventDefault(),this.undo();return}if(o&&t.key==="y"){t.preventDefault(),this.redo();return}if(i){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(o&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(s=>this.state.selectedPointIds.add(s.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(s=>!this.state.selectedPointIds.has(s.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,i,o=null){let s=t,a=oa+1;const r=Math.ceil(Se*2.2),c=Math.ceil(Ve/2),l=r+c,d=n-l-r,f=n-r;return this.state.points.forEach(h=>{if(h.id===o)return;const u=f-h[i]*d,p=Math.abs(t-u);p<oa&&p<a&&(s=u,a=p)}),s}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:i}=this.state,o=this.elements.hsBgCanvas.width,s=this.elements.hsBgCanvas.height;if(o===0||s===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=Go,a.fillRect(0,0,o,s);const r=Math.ceil(Se*2.2),c=Math.ceil(Ve/2),l=r+c,d=o-l-r,f=s-l-r;if(d<=0||f<=0)return;const h=i==="RGB_CUBE"?Math.min(d,f)/(Math.sqrt(2/3)*2)*sa:Math.min(d,f)/2*sa;this.state.transform.scale=h,this.state.transform.offsetX=o/2,this.state.transform.offsetY=s/2;const u=l,p=l,g=d,y=f,S=Ve,m=Math.round(g/S),I=Math.round(y/S),x=g/m,v=y/I;for(let w=0;w<I;w++)for(let b=0;b<m;b++){const C=u+b*x,_=p+w*v;(w+b)%2===0?a.fillStyle=Ho:a.fillStyle=Xo,a.fillRect(C,_,x,v)}if(i==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const b=o/2,C=s/2,_=t<.5?0:255;a.fillStyle=`rgba(${_}, ${_}, ${_}, ${n})`,a.fillRect(Math.floor(b),Math.floor(C),1,1);return}const A=a.createImageData(g,y),T=A.data;for(let w=0;w<y;w++)for(let b=0;b<g;b++){const C=u+b,_=p+w,P=(C-this.state.transform.offsetX)/this.state.transform.scale,D=(_-this.state.transform.offsetY)/this.state.transform.scale,{r:R,g:N,b:B}=this.abstractToRgb(P,D,t),k=(w*g+b)*4;this.isValidColor(R,N,B)&&(T[k]=Math.round(R*255),T[k+1]=Math.round(N*255),T[k+2]=Math.round(B*255),T[k+3]=255)}const E=document.createElement("canvas");E.width=g,E.height=y,E.getContext("2d").putImageData(A,0,0),a.globalAlpha=n,a.drawImage(E,u,p),a.globalAlpha=1}evaluateCubicSpline(t,n){const i=this.state.points,o=i.length;if(t<0||t>=o)return null;let s,a,r,c;if(this.state.isCyclic){const u=p=>{const g=(p%o+o)%o;return i[g]};t===o-1?(s=u(t-1),a=u(t),r=u(0),c=u(1)):(s=u(t-1),a=u(t),r=u(t+1),c=u(t+2))}else a=i[t],r=i[t+1],s=t>0?i[t-1]:i[t],c=t+2<o?i[t+2]:i[t+1];const l=n,d=l*l,f=d*l,h=(u,p,g,y)=>.5*(2*p+(-u+g)*l+(2*u-5*p+4*g-y)*d+(-u+3*p-3*g+y)*f);return{u:h(s.hsPos.u,a.hsPos.u,r.hsPos.u,c.hsPos.u),v:h(s.hsPos.v,a.hsPos.v,r.hsPos.v,c.hsPos.v),lightness:h(s.lightness,a.lightness,r.lightness,c.lightness),alpha:h(s.alpha,a.alpha,r.alpha,c.alpha),order:2}}isValidColor(t,n,i){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&i>=-.001&&i<=1.001}drawSliderBackgrounds(){const t=Math.ceil(Se*2.2),n=Math.ceil(Ve/2),i=t+n,o=this.elements.lightnessBgCanvas.getContext("2d"),s=this.elements.lightnessBgCanvas;o.fillStyle=Go,o.fillRect(0,0,s.width,s.height);const a=i,r=s.width-t,c=i,l=s.height-t,d=r-a,f=l-c;if(f>0&&d>0){const x=o.createLinearGradient(0,c,0,l);x.addColorStop(0,"white"),x.addColorStop(1,"black"),o.fillStyle=x,o.fillRect(a,c,d,f)}const h=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;h.fillStyle=Go,h.fillRect(0,0,u.width,u.height);const p=i,g=u.width-t,y=i,S=u.height-t,m=g-p,I=S-y;if(I>0&&m>0){const x=Ve,v=Math.round(m/x),A=Math.ceil(I/x),T=m/v,E=x,M=S-A*E;for(let b=0;b<A;b++)for(let C=0;C<v;C++){const _=p+C*T,P=M+b*E;if(P<S&&P+E>y){(b+C)%2===0?h.fillStyle=Ho:h.fillStyle=Xo;const D=Math.max(P,y),R=Math.min(P+E,S)-D;R>0&&h.fillRect(_,D,T,R)}}const w=h.createLinearGradient(0,y,0,S);w.addColorStop(0,"white"),w.addColorStop(1,"rgba(255,255,255,0)"),h.fillStyle=w,h.fillRect(p,y,m,I)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=Yo,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const i=Math.ceil(Se*2.2),o=Math.ceil(Ve/2),s=i+o,a=s,r=s,c=t.width-s-i,l=t.height-s-i;if(this.state.points.length>1){const d=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let f=0;f<d;f++){const h=this.state.points[f],u=this.state.points[(f+1)%this.state.points.length];if(Math.max(h.order,u.order)===0)continue;let g=h.pos,y=u.pos;this.state.isCyclic&&y<g&&(y+=1);const S=y-g;if(S<1e-9)continue;const m=Math.max(10,Math.ceil(S*100)),I=[];for(let v=0;v<=m;v++){const A=g+v/m*S,T=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(A));if(!T)continue;const E=this.clampAbstractPoint(T.u,T.v,T.lightness),M=E.u*this.state.transform.scale+this.state.transform.offsetX,w=E.v*this.state.transform.scale+this.state.transform.offsetY;I.push({x:M,y:w,isOnPlane:Math.abs(T.lightness-this.state.viewLightness)<1e-10})}if(I.length<2)continue;const x=I.every(v=>v.isOnPlane);n.strokeStyle="black",n.lineWidth=Zn,n.globalAlpha=x?.7:.4,n.setLineDash(x?[]:Us),n.beginPath(),n.moveTo(I[0].x,I[0].y);for(let v=1;v<I.length;v++)n.lineTo(I[v].x,I[v].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(a,r,c,l),n.clip(),this.state.points.forEach(d=>{const f=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,h=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(f>=a-Se&&f<=a+c+Se&&h>=r-Se&&h<=r+l+Se){const u=this.abstractToRgb(d.hsPos.u,d.hsPos.v,d.lightness),{r:p,g,b:y}=this.clampColor(u),S=this.state.selectedPointIds.has(d.id),m=d.id===this.state.lastSelectedPointId,I=Math.abs(d.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),d.order){case 0:this._drawCircle(n,f,h,Se);break;case 1:this._drawDroplet(n,f,h,Se);break;case 3:this._drawTriangle(n,f,h,Se);break;default:this._drawCircle(n,f,h,Se)}n.globalAlpha=d.alpha,n.fillStyle=`rgb(${p}, ${g}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=S?Yo:"black",n.lineWidth=m?ta:Zn,n.setLineDash(I?[]:Us),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const i=Math.ceil(Se*2.2),o=Math.ceil(Ve/2),s=i+o,a=s,r=t.width-i,c=s,l=t.height-i,d=r-a,f=l-c;let h=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(h=p.lightness)}const u=l-h*f;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.lightness*f,S=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:m,g:I,b:x}=this.clampColor(S),v=this.state.selectedPointIds.has(p.id),A=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,m,I,x,v,A,p.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=Zn;const i=this.state.points,o=i.length;if(n==="hs"){t.restore();return}const s=Math.ceil(Se*2.2),a=Math.ceil(Ve/2),r=s+a,c=r,l=t.canvas.height-s,d=t.canvas.width-r-s,f=l-r,h=c+d;if(d<=0){t.restore();return}const u=this.state.isCyclic?o:o-1;for(let p=0;p<u;p++){const g=i[p],y=i[(p+1)%o],S=Math.max(g.order,y.order),m=this.state.isCyclic&&p===o-1;if(S===0){const I=l-g[n]*f,x=l-y[n]*f,v=c+g.pos*d,A=c+y.pos*d;if(m&&g.pos>y.pos){let T=g.pos,E=y.pos+1;const M=T+(E-T)*.5,w=c+(M-Math.floor(M))*d,b=this.getInterpolatedPropertiesAt(g.pos),C=this.getInterpolatedPropertiesAt(y.pos);if(b){const _=this.abstractToRgb(b.u,b.v,b.lightness),P=this.clampColor(_);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${b.alpha})`,t.setLineDash([]),M>1?(t.beginPath(),t.moveTo(v,I),t.lineTo(h,I),t.stroke(),t.beginPath(),t.moveTo(c,I),t.lineTo(w,I),t.stroke()):(t.beginPath(),t.moveTo(v,I),t.lineTo(w,I),t.stroke())}if(C){const _=this.abstractToRgb(C.u,C.v,C.lightness),P=this.clampColor(_);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${C.alpha})`,t.setLineDash([]),M>1?(t.beginPath(),t.moveTo(w,x),t.lineTo(A,x),t.stroke()):(t.beginPath(),t.moveTo(w,x),t.lineTo(h,x),t.stroke(),t.beginPath(),t.moveTo(c,x),t.lineTo(A,x),t.stroke())}t.beginPath(),t.setLineDash(Us),t.strokeStyle="black",t.moveTo(w,I),t.lineTo(w,x),t.stroke()}else if(!m){let T=g.pos,E=y.pos;const M=T+(E-T)*.5,w=c+M*d,b=this.getInterpolatedPropertiesAt(g.pos),C=this.getInterpolatedPropertiesAt(y.pos);if(b){const _=this.abstractToRgb(b.u,b.v,b.lightness),P=this.clampColor(_);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${b.alpha})`,t.setLineDash([]);const D=p===0&&!this.state.isCyclic?c:v;t.beginPath(),t.moveTo(D,I),t.lineTo(w,I),t.stroke()}if(C){const _=this.abstractToRgb(C.u,C.v,C.lightness),P=this.clampColor(_);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${C.alpha})`,t.setLineDash([]);const D=p===u-1&&!this.state.isCyclic?h:A;t.beginPath(),t.moveTo(w,x),t.lineTo(D,x),t.stroke()}t.beginPath(),t.setLineDash(Us),t.strokeStyle="black",t.moveTo(w,I),t.lineTo(w,x),t.stroke()}}else if(t.setLineDash([]),m&&g.pos>y.pos){const I=l-g[n]*f,x=l-y[n]*f,v=c+g.pos*d,A=c+y.pos*d,T=1-g.pos;if(T>1e-6){const E=t.createLinearGradient(v,0,h,0),M=Math.max(2,Math.ceil(T*20));for(let C=0;C<=M;C++){const _=g.pos+C/M*T,P=this.getInterpolatedPropertiesAt(_);if(P){const D=this.abstractToRgb(P.u,P.v,P.lightness),{r:R,g:N,b:B}=this.clampColor(D);E.addColorStop(C/M,`rgba(${R}, ${N}, ${B}, ${P.alpha})`)}}const w=this.getInterpolatedPropertiesAt(1),b=w?l-w[n]*f:I;t.beginPath(),t.moveTo(v,I),t.lineTo(h,b),t.strokeStyle=E,t.stroke()}if(y.pos>1e-6){const E=t.createLinearGradient(c,0,A,0),M=Math.max(2,Math.ceil(y.pos*20));for(let C=0;C<=M;C++){const _=C/M*y.pos,P=this.getInterpolatedPropertiesAt(_);if(P){const D=this.abstractToRgb(P.u,P.v,P.lightness),{r:R,g:N,b:B}=this.clampColor(D);E.addColorStop(C/M,`rgba(${R}, ${N}, ${B}, ${P.alpha})`)}}const w=this.getInterpolatedPropertiesAt(0),b=w?l-w[n]*f:x;t.beginPath(),t.moveTo(c,b),t.lineTo(A,x),t.strokeStyle=E,t.stroke()}}else if(!m){const I=c+g.pos*d,x=c+y.pos*d,v=(A,T,E,M)=>{const w=T-A;if(Math.abs(w)<1e-9)return;const b=t.createLinearGradient(E,0,M,0),C=Math.ceil(Math.abs(M-E)/2);for(let _=0;_<=C;_++){const P=A+_/C*w,D=this.getInterpolatedPropertiesAt(P);if(!D)continue;const R=this.abstractToRgb(D.u,D.v,D.lightness),{r:N,g:B,b:k}=this.clampColor(R);b.addColorStop(_/C,`rgba(${N}, ${B}, ${k}, ${D.alpha})`)}t.beginPath();for(let _=0;_<=C;_++){const P=A+_/C*w,D=this.getInterpolatedPropertiesAt(P);if(!D)continue;const R=Math.max(0,Math.min(1,P)),N=c+R*d,B=l-D[n]*f;_===0?t.moveTo(N,B):t.lineTo(N,B)}t.strokeStyle=b,t.stroke()};if(p===0&&!this.state.isCyclic&&Math.abs(g.pos)>=1e-6){const A=this.getInterpolatedPropertiesAt(g.pos);if(A){const T=this.abstractToRgb(A.u,A.v,A.lightness),{r:E,g:M,b:w}=this.clampColor(T);t.strokeStyle=`rgba(${E}, ${M}, ${w}, ${A.alpha})`;const b=l-A[n]*f;t.beginPath(),t.moveTo(c,b),t.lineTo(I,b),t.stroke()}}if(v(g.pos,y.pos,I,x),p===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const A=this.getInterpolatedPropertiesAt(y.pos);if(A){const T=this.abstractToRgb(A.u,A.v,A.lightness),{r:E,g:M,b:w}=this.clampColor(T);t.strokeStyle=`rgba(${E}, ${M}, ${w}, ${A.alpha})`;const b=l-A[n]*f;t.beginPath(),t.moveTo(x,b),t.lineTo(h,b),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const i=t.lightness<.05||t.lightness>.95,o=n.lightness<.05||n.lightness>.95;if(i&&o)return!0;const s=10;for(let a=0;a<=s;a++){const r=a/s,c=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*r,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*r,d=t.lightness+(n.lightness-t.lightness)*r,f=this.abstractToRgb(c,l,d);if(!this.isValidColor(f.r,f.g,f.b))return!1}return!0}drawInterpolatedPath(t,n,i,o){const s=i.pos-n.pos;if(s<1e-6)return;const a=Math.max(2,Math.ceil(s*t.canvas.width/4));let r=!1;for(let c=0;c<=a;c++){const l=n.pos+c/a*s,d=this.getInterpolatedPropertiesAt(l);if(!d)continue;const f=this.clampAbstractPoint(d.u,d.v,d.lightness),h=f.u*this.state.transform.scale+this.state.transform.offsetX,u=f.v*this.state.transform.scale+this.state.transform.offsetY;!r||c===0?(t.moveTo(h,u),r=!0):t.lineTo(h,u)}}drawHSSegment(t,n,i,o,s){let a=n.pos,r=i.pos;this.state.isCyclic&&r<a&&(r+=1);const c=r-a;if(c<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(c*t.canvas.width/8)),d=[];for(let h=0;h<=l;h++){const u=a+h/l*c,p=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!p)continue;const g=this.clampAbstractPoint(p.u,p.v,p.lightness),y=g.u*this.state.transform.scale+this.state.transform.offsetX,S=g.v*this.state.transform.scale+this.state.transform.offsetY,m=Math.abs(p.lightness-this.state.viewLightness)<1e-10;d.push({x:y,y:S,isOnPlane:m,u:g.u,v:g.v})}if(d.length<2)return;if(d.every(h=>h.isOnPlane)){t.strokeStyle="black",t.lineWidth=Zn,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let h=1;h<d.length;h++)t.lineTo(d[h].x,d[h].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=Zn,t.globalAlpha=.4;const h=Math.sqrt((i.hsPos.u-n.hsPos.u)**2+(i.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+h*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let p=1;p<d.length;p++)t.lineTo(d[p].x,d[p].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const i=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let o=0;o<i;o++){const s=this.state.points[o],a=this.state.points[(o+1)%this.state.points.length];if(Math.max(s.order,a.order)===0)continue;const c=Math.abs(s.lightness-this.state.viewLightness)<1e-10,l=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&l)continue;const d=s.lightness,f=a.lightness,h=this.state.viewLightness;if(d<h&&f>h||d>h&&f<h){const u=this.findLightnessIntersection(s,a,h);if(u!==null){let p=a.pos-s.pos;this.state.isCyclic&&a.pos<s.pos&&(p+=1);const g=s.pos+u*p,y=this.getInterpolatedPropertiesAt(g);if(!y)continue;const S=this.clampAbstractPoint(y.u,y.v,y.lightness),m=S.u*this.state.transform.scale+this.state.transform.offsetX,I=S.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(m,I,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,i){const o=t.lightness,s=n.lightness;if(Math.abs(s-o)<1e-10)return null;if(Math.max(t.order,n.order)===1){const f=(i-o)/(s-o);return f>0&&f<1?f:null}let r=0,c=1;const l=25;for(let f=0;f<l;f++){const h=(r+c)/2,u=t.pos+(n.pos-t.pos)*h,p=this.getInterpolatedPropertiesAt(u);if(!p)break;if(Math.abs(p.lightness-i)<1e-10)return h;p.lightness<i?s>o?r=h:c=h:s>o?c=h:r=h}const d=(r+c)/2;return d>.01&&d<.99?d:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const i=t.canvas,o=Math.ceil(Se*2.2),s=Math.ceil(Ve/2),a=o+s;t.save(),t.strokeStyle="white",t.lineWidth=1;const r=a,c=i.width-o,l=a,d=i.height-o,f=c-r,h=d-l;this.clearTickLabels(i);const u=[0,.2,.4,.6,.8,1],p=["0","0.2","0.4","0.6","0.8","1"],g=i.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,S=window.pageYOffset||document.documentElement.scrollTop;for(let m=0;m<u.length;m++){const I=u[m],x=Math.floor(r+I*f)+.5;I===0?(t.beginPath(),t.moveTo(x,l),t.lineTo(x,d+5),t.stroke()):(t.beginPath(),t.moveTo(x,d),t.lineTo(x,d+5),t.stroke());const v=g.left+y+x,A=g.top+S+d+8;this.createKaTeXLabel(p[m],v,A,"bottom",i)}for(let m=0;m<u.length;m++){const I=u[m],x=Math.floor(d-I*h)+.5;I===0?(t.beginPath(),t.moveTo(r-5,x),t.lineTo(c,x),t.stroke()):(t.beginPath(),t.moveTo(r-5,x),t.lineTo(r,x),t.stroke());const v=g.left+y+r-8,A=g.top+S+x;this.createKaTeXLabel(p[m],v,A,"left",i)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(i=>i.remove())}createKaTeXLabel(t,n,i,o,s){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${i}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${o==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=s.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${i}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${o==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=s.dataset.type,katex.render(t,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,i,o,s)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const i=Math.ceil(Se*2.2),o=Math.ceil(Ve/2),s=i+o,a=s,r=t.width-i,c=s,l=t.height-i,d=r-a,f=l-c;let h=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(h=p.alpha)}const u=l-h*f;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.alpha*f,S=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:m,g:I,b:x}=this.clampColor(S),v=this.state.selectedPointIds.has(p.id),A=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,m,I,x,v,A,p.order)})}_drawCircle(t,n,i,o){t.arc(n,i,o,0,2*Math.PI)}_drawJoukowsky(t,n,i,o,s){const r=[];let c=1/0,l=-1/0,d=1/0,f=-1/0;for(let S=0;S<=50;S++){const m=S/50*2*Math.PI,I=Math.cos(m),x=Math.sin(m),v=1-s+s*I,A=s*x,T=v*v+A*A;if(Math.abs(T)<1e-9)continue;const E=s*x-s*x/T,M=s*I+v/T;r.push({x:E,y:M}),E<c&&(c=E),E>l&&(l=E),M<d&&(d=M),M>f&&(f=M)}const h=f-d,u=o*2.5/h,p=(l+c)/2,g=(f+d)/2;t.beginPath();const y=r[0];t.moveTo(n+(y.x-p)*u,i-(y.y-g)*u);for(let S=1;S<r.length;S++){const m=r[S];t.lineTo(n+(m.x-p)*u,i-(m.y-g)*u)}t.closePath()}_drawDroplet(t,n,i,o){this._drawJoukowsky(t,n,i,o,.6666666666666666)}_drawTriangle(t,n,i,o){const s=o*1.4;t.moveTo(n,i-s),t.lineTo(n+s*Math.sqrt(3)/2,i+s/2),t.lineTo(n-s*Math.sqrt(3)/2,i+s/2),t.closePath()}drawPoint(t,n,i,o,s,a,r,c,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,i,Se);break;case 1:this._drawDroplet(t,n,i,Se);break;case 3:this._drawTriangle(t,n,i,Se);break;default:this._drawCircle(t,n,i,Se)}t.fillStyle=`rgb(${o}, ${s}, ${a})`,t.fill(),t.strokeStyle=r?Yo:"black",t.lineWidth=c?ta:Zn,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,i=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),o=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!o),this.elements.hslInputsContainer.classList.toggle("hidden",o),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){i||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!i){const{lightness:s,hsPos:a}=t,r=this.abstractToRgb(a.u,a.v,s);if(o){const{r:c,g:l,b:d}=this.clampColor(r);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=d}else{const c=this.rgbToHsl(r.r,r.g,r.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:i}=t.parentElement;(t.width!==n||t.height!==i)&&(t.width=n,t.height=i);const o=t.getContext("2d");o.clearRect(0,0,t.width,t.height),this.drawCheckerboard(o);const s=this.getLastSelectedPoint();if(s){const{hsPos:a,lightness:r,alpha:c}=s,l=this.abstractToRgb(a.u,a.v,r),{r:d,g:f,b:h}=this.clampColor(l);o.fillStyle=`rgba(${d}, ${f}, ${h}, ${c})`,o.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,i=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let o=0;o<n;o++){const s=o/(n-1),a=this.getInterpolatedPropertiesAt(s);if(!a)continue;const r=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(r.u,r.v,a.lightness),{r:l,g:d,b:f}=this.clampColor(c);t.fillStyle=`rgba(${l}, ${d}, ${f}, ${a.alpha})`,t.fillRect(o,0,1,i)}}getInterpolatedPropertiesAt(t){const n=this.state.points,i=n.length;if(i===0)return null;if(i===1){const h=n[0];return{u:h.hsPos.u,v:h.hsPos.v,lightness:h.lightness,alpha:h.alpha,order:h.order}}const o=this.state.isCyclic,s=o?(t%1+1)%1:t;let a,r,c=-1;for(let h=0;h<i-1;h++)if(s>=n[h].pos&&s<=n[h+1].pos){c=h,a=n[h],r=n[h+1];break}if(c===-1)if(o)c=i-1,a=n[i-1],r=n[0];else{const h=s<n[0].pos?n[0]:n[i-1];return{u:h.hsPos.u,v:h.hsPos.v,lightness:h.lightness,alpha:h.alpha,order:h.order}}if(!a||!r)return null;let l=r.pos-a.pos;if(o&&c===i-1&&(l+=1),Math.abs(l)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let d;o&&c===i-1?d=s>=a.pos?(s-a.pos)/l:(s+1-a.pos)/l:d=(s-a.pos)/l;const f=Math.max(a.order,r.order);if(f===0){const h=d<.5?a:r;return{u:h.hsPos.u,v:h.hsPos.v,lightness:h.lightness,alpha:h.alpha,order:h.order}}if(f===3){const h=this.evaluateCubicSpline(c,d);if(h){const u=Math.max(0,Math.min(1,h.lightness)),p=Math.max(0,Math.min(1,h.alpha)),g=this.clampAbstractPoint(h.u,h.v,u);return{u:g.u,v:g.v,lightness:u,alpha:p,order:2}}}return{u:a.hsPos.u+(r.hsPos.u-a.hsPos.u)*d,v:a.hsPos.v+(r.hsPos.v-a.hsPos.v)*d,lightness:a.lightness+(r.lightness-a.lightness)*d,alpha:a.alpha+(r.alpha-a.alpha)*d,order:1}}abstractToRgb(t,n,i){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,i);const o=this.rgbCubeAbstractToRgb(t,n,i);return this.isValidColor(o.r,o.g,o.b)?o:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,i){if(this.state.colorSpace==="HSL_DI_CONE"){const h=Math.sqrt(t*t+n*n),u=1-Math.abs(2*i-1);return h>u&&u>1e-6?{u:t/h*u,v:n/h*u}:{u:t,v:n}}if(i<=.01||i>=.99)return{u:0,v:0};let{r:o,g:s,b:a}=this.abstractToRgb(t,n,i);if(this.isValidColor(o,s,a))return{u:t,v:n};let r=0,c=0,l=1/0;const d=Math.max(Math.abs(t),Math.abs(n),.5),f=50;for(let h=0;h<=f;h++)for(let u=0;u<=f;u++){const p=t+(h/f-.5)*2*d,g=n+(u/f-.5)*2*d,y=this.abstractToRgb(p,g,i);if(this.isValidColor(y.r,y.g,y.b)){const S=Math.sqrt((p-t)**2+(g-n)**2);S<l&&(l=S,r=p,c=g)}}return l<1/0?{u:r,v:c}:{u:0,v:0}}hslToRgb(t,n,i){if(n===0)return{r:i,g:i,b:i};const o=i<.5?i*(1+n):i+n-i*n,s=2*i-o,a=(d,f,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<1/6?d+(f-d)*6*h:h<1/2?f:h<2/3?d+(f-d)*(2/3-h)*6:d),r=a(s,o,t+1/3),c=a(s,o,t),l=a(s,o,t-1/3);return{r,g:c,b:l}}rgbToHsl(t,n,i){const o=Math.max(t,n,i),s=Math.min(t,n,i);let a=0,r=0,c=(o+s)/2;if(o!==s){const l=o-s;switch(r=c>.5?l/(2-o-s):l/(o+s),o){case t:a=(n-i)/l+(n<i?6:0);break;case n:a=(i-t)/l+2;break;case i:a=(t-n)/l+4;break}a/=6}return{h:a,s:r,l:c}}drawCheckerboard(t){const n=t.canvas.width,i=t.canvas.height,o=n/Ve,s=i/Ve;t.fillStyle=Xo,t.fillRect(0,0,n,i),t.fillStyle=Ho;for(let a=0;a<s;a++)for(let r=0;r<o;r++)(a+r)%2===0&&t.fillRect(r*Ve,a*Ve,Ve,Ve)}findClosestValidPoint(t,n,i){const o=Math.ceil(Se*2.2),s=Math.ceil(Ve/2),a=o+s,r=a,c=a,l=this.elements.hsBgCanvas.width-a-o,d=this.elements.hsBgCanvas.height-a-o,f=Math.max(r,Math.min(r+l,t)),h=Math.max(c,Math.min(c+d,n)),{scale:u,offsetX:p,offsetY:g}=this.state.transform,y=(f-p)/u,S=(h-g)/u,m=this.abstractToRgb(y,S,i);if(this.isValidColor(m.r,m.g,m.b))return{x:f,y:h};if(this.state.colorSpace==="HSL_DI_CONE"){const I=Math.sqrt(y*y+S*S),x=1-Math.abs(2*i-1);if(I>x&&x>1e-6){const v=y/I*x,A=S/I*x;return{x:v*u+p,y:A*u+g}}return{x:f,y:h}}return this.findClosestPointOnRgbGamut(y,S,i,u,p,g,r,c,l,d)}getGamutVerticesRgb(t){const n=[],i=r=>r>=-1e-6&&r<=1.000001,o=(r,c)=>Math.abs(r.r-c.r)<1e-6&&Math.abs(r.g-c.g)<1e-6&&Math.abs(r.b-c.b)<1e-6,s=(r,c,l)=>{if(i(r)&&i(c)&&i(l)){const d={r,g:c,b:l};n.some(f=>o(f,d))||n.push(d)}},a=3*t;return s(a,0,0),s(0,a,0),s(0,0,a),s(1,a-1,0),s(1,0,a-1),s(a-1,1,0),s(0,1,a-1),s(a-1,0,1),s(0,a-1,1),s(1,1,a-2),s(1,a-2,1),s(a-2,1,1),n}rgbCubeAbstractToRgb(t,n,i){const o={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},s={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=i+t*o.x+n*s.x,r=i+t*o.y+n*s.y,c=i+t*o.z+n*s.z;return{r:a,g:r,b:c}}findClosestPointOnRgbGamut(t,n,i,o,s,a,r,c,l,d){let f=t,h=n,u=1/0;const p=.5,g=50;for(let m=0;m<=g;m++)for(let I=0;I<=g;I++){const x=t+(m/g-.5)*2*p,v=n+(I/g-.5)*2*p,A=this.abstractToRgb(x,v,i);if(this.isValidColor(A.r,A.g,A.b)){const T=Math.sqrt((x-t)**2+(v-n)**2);T<u&&(u=T,f=x,h=v)}}if(u<1/0){const m=this.refineClosestPoint(t,n,f,h,i);f=m.u,h=m.v}const y=f*o+s,S=h*o+a;return{x:Math.max(r,Math.min(r+l,y)),y:Math.max(c,Math.min(c+d,S))}}refineClosestPoint(t,n,i,o,s){let a=i,r=o,c=.02;for(let l=0;l<5;l++){let d=!1;const f=20;for(let h=0;h<=f;h++)for(let u=0;u<=f;u++){const p=a+(h/f-.5)*2*c,g=r+(u/f-.5)*2*c,y=this.abstractToRgb(p,g,s);if(this.isValidColor(y.r,y.g,y.b)){const S=Math.sqrt((a-t)**2+(r-n)**2);Math.sqrt((p-t)**2+(g-n)**2)<S&&(a=p,r=g,d=!0)}}if(c*=.5,!d)break}return{u:a,v:r}}findClosestPointOnPolygon(t,n){let i=null,o=1/0;for(let s=0;s<n.length;s++){const a=n[s],r=n[(s+1)%n.length],c=r.x-a.x,l=r.y-a.y;let d;if(c===0&&l===0)d=a;else{const h=((t.x-a.x)*c+(t.y-a.y)*l)/(c*c+l*l);h<0?d=a:h>1?d=r:d={x:a.x+h*c,y:a.y+h*l}}const f=(t.x-d.x)**2+(t.y-d.y)**2;f<o&&(o=f,i=d)}return i}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}findHitPointSlider(t,n,i){const o=this.elements.interactiveCanvases[i],s=Math.ceil(Se*2.2),a=Math.ceil(Ve/2),r=s+a,c=o.height-r-s,l=o.height-s,d=i==="lightness"?l-this.state.viewLightness*c:l-this.state.viewAlpha*c;let f=Math.abs(n-d)<=na,h=null;for(let u=0;u<this.state.points.length;u++){const p=this.state.points[u],g=o.width-r-s,y=r+p.pos*g,S=i==="lightness"?l-p.lightness*c:l-p.alpha*c;if(Math.sqrt((t-y)**2+(n-S)**2)<=zo){h=p;break}}return{hitPoint:h,hitLine:f}}findHitPointSlider(t,n,i){const o=this.elements.interactiveCanvases[i],s=Math.ceil(Se*2.2),a=o.height-2*s,r=o.height-s,c=i==="lightness"?r-this.state.viewLightness*a:r-this.state.viewAlpha*a;let l=Math.abs(n-c)<=na,d=null;for(let f=0;f<this.state.points.length;f++){const h=this.state.points[f],u=o.width-2*s,p=s+h.pos*u,g=i==="lightness"?r-h.lightness*a:r-h.alpha*a;if(Math.sqrt((t-p)**2+(n-g)**2)<=zo){d=h;break}}return{hitPoint:d,hitLine:l}}createNewPointHS(t,n){const i=Math.ceil(Se*2.2),o=Math.ceil(Ve/2),s=i+o,a=s,r=s,c=this.elements.hsBgCanvas.width-s-i,l=this.elements.hsBgCanvas.height-s-i;if(t<a||t>a+c||n<r||n>r+l)return;const d=(t-this.state.transform.offsetX)/this.state.transform.scale,f=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:h,viewAlpha:u}=this.state,{r:p,g,b:y}=this.abstractToRgb(d,f,h);if(this.isValidColor(p,g,y)){this.markAsDirty();const S=this.state.points.length;S>0&&this.state.points.forEach(I=>{I.pos=I.pos-I.pos/S});const m={id:Date.now(),hsPos:{u:d,v:f},originalHsPos:{u:d,v:f},lightness:h,alpha:u,pos:S===0?.5:1,order:1};this.state.points.push(m),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(m.id),this.state.lastSelectedPointId=m.id,this.drawAll()}}handleLineDrag(t,n,i){const o=i.startsWith("lightness")?"lightness":"alpha",s=i.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(Se*2.2),r=Math.ceil(Ve/2),c=a+r,l=n-c-a,f=(this.findSnapPosition(t,n,o)-c)/l,h=Math.max(0,Math.min(1,1-f));this.state[s]=h,this.drawAll()}handlePointDrag(t,n,i,o){const s=this.getPointById(this.state.activeDrag.pointId);s&&(o==="hs"?this.handleHSPointDrag(t,n):(o==="lightness"||o==="alpha")&&this.handleSliderPointDrag(s,t,n,i,o),this.drawAll())}handleHSPointDrag(t,n){const{startX:i,startY:o,initialPointPositions:s}=this.state.activeDrag,{scale:a,offsetX:r,offsetY:c}=this.state.transform,l=Math.ceil(Se*2.2),d=Math.ceil(Ve/2),f=l+d,h=f,u=f,p=this.elements.hsBgCanvas.width-f-l,g=this.elements.hsBgCanvas.height-f-l,y=t-i,S=n-o;this.state.points.forEach(m=>{if(s.has(m.id)){const I=s.get(m.id),x=I.x+y,v=I.y+S,A=Math.max(h,Math.min(h+p,x)),T=Math.max(u,Math.min(u+g,v)),E=this.findClosestValidPoint(A,T,m.lightness),M=(E.x-r)/a,w=(E.y-c)/a;m.hsPos={u:M,v:w};const b=this.abstractToRgb(M,w,m.lightness);this.isValidColor(b.r,b.g,b.b)&&(m.originalHsPos={u:M,v:w})}})}adjustPointForNewLightness(t,n){const i=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(i.r,i.g,i.b)){t.hsPos={...t.originalHsPos};return}const o=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=o.u,t.hsPos.v=o.v}handleSliderPointDrag(t,n,i,o,s){const{offsets:a}=this.state.activeDrag,r=Math.ceil(Se*2.2),c=Math.ceil(Ve/2),l=r+c;o.width-r,o.height-r;const d=this.findSnapPosition(i,o.height,s,t.id),f=l,h=o.width-r,u=l,p=o.height-r,g=h-f,y=p-u,S=(d-u)/y,m=Math.max(0,Math.min(1,1-S));let I=(n-f)/g,x=I;this.state.isCyclic?(I<0?x=1+I:I>1&&(x=I-1),x=this.wrapPositionCyclic(x)):x=Math.max(0,Math.min(1,I));for(const v of this.state.points)if(a.has(v.id)){const A=a.get(v.id),T=m+A[s];let E=x+A.pos;if(this.state.isCyclic?E=this.wrapPositionCyclic(E):E=Math.max(0,Math.min(1,E)),v.pos=E,s==="lightness"){const M=Math.max(0,Math.min(1,T));v.lightness=M;const w=this.abstractToRgb(v.originalHsPos.u,v.originalHsPos.v,M);if(this.isValidColor(w.r,w.g,w.b))v.hsPos={...v.originalHsPos};else{const b=this.clampAbstractPoint(v.originalHsPos.u,v.originalHsPos.v,M);v.hsPos.u=b.u,v.hsPos.v=b.v}this.state.viewLightness=M}else v.alpha=Math.max(0,Math.min(1,T)),this.state.viewAlpha=v.alpha}this.sortPoints()}}const Fr={CUBIC_SPLINE:"cubic_spline"},so={PASS_THROUGH:"pass_through",CUT_ALL:"cut_all",MIXED:"mixed"},Br={LEFT:"left"},$r={RELATIVE:"relative"},ia={id:`style_${Date.now()}`,name:"New Spline Style",type:Fr.CUBIC_SPLINE,cornerHandling:so.MIXED,side:Br.LEFT,radiusMode:$r.RELATIVE,radiusValue:.5,tension:.5},Vr=256,Yr=256,Xr="#2D3748",Hr="#A0AEC0",Gr="#3B82F6",zr=4;function Wr(e,t=.5,n=!1,i=16){if(e.length<2)return e;const o=[],s=[...e];n?(s.unshift(e[e.length-1]),s.push(e[0],e[1])):(s.unshift(e[0]),s.push(e[e.length-1]));const a=n?s.length-2:s.length-1;for(let r=1;r<a;r++){r>1&&!n&&o.push({...s[r]});for(let c=0;c<=i;c++){const l=c/i,d=s[r-1],f=s[r],h=s[r+1],u=s[r+2]||h,p=Math.pow(Math.hypot(f.x-d.x,f.y-d.y),t),g=Math.pow(Math.hypot(h.x-f.x,h.y-f.y),t),y=Math.pow(Math.hypot(u.x-h.x,u.y-h.y),t),S={x:((h.x-f.x)/g-(f.x-d.x)/p)*(1-t)*g,y:((h.y-f.y)/g-(f.y-d.y)/p)*(1-t)*g},m={x:((u.x-h.x)/y-(h.x-f.x)/g)*(1-t)*g,y:((u.y-h.y)/y-(h.y-f.y)/g)*(1-t)*g},I=2*(f.x-h.x)+S.x+m.x,x=-3*(f.x-h.x)-2*S.x-m.x,v=S.x,A=f.x,T=2*(f.y-h.y)+S.y+m.y,E=-3*(f.y-h.y)-2*S.y-m.y,M=S.y,w=f.y;o.push({x:I*l*l*l+x*l*l+v*l+A,y:T*l*l*l+E*l*l+M*l+w})}}return o}class Ur{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:JSON.parse(JSON.stringify(ia)),isDirty:!1,undoStack:[],redoStack:[]},this.wrapper=null,this.elements={},this.previewCtx=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this.drawPreview())}_initializeDOM(){this.elements={};const t=(g,y={})=>{const S=document.createElement(g);if(y.id){S.id=y.id;const m=y.id.replace(/-(\w)/g,(I,x)=>x.toUpperCase());this.elements[m]=S}y.className&&(S.className=y.className),y.text&&(S.textContent=y.text),y.value&&(S.value=y.value),y.type&&(S.type=y.type),y.name&&(S.name=y.name);for(const m in y.attrs)S.setAttribute(m,y.attrs[m]);return S};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"editor-panel preview-panel"}),i=t("div",{className:"panel-header",text:"Preview"}),o=t("div",{className:"preview-canvas-container"});this.elements.previewCanvas=t("canvas",{id:"preview-canvas"}),this.elements.previewCanvas.width=Vr,this.elements.previewCanvas.height=Yr,this.previewCtx=this.elements.previewCanvas.getContext("2d"),o.append(this.elements.previewCanvas),n.append(i,o);const s=t("div",{className:"editor-panel style-panel"}),a=t("div",{className:"panel-header",text:"Style"}),r=t("div",{className:"parameter-group"});r.append(t("div",{className:"parameter-group-header",text:"Style Name"}),t("input",{type:"text",id:"style-name-input",className:"value-input",attrs:{style:"text-align: left; padding: 4px 8px;"}})),s.append(a,r);const c=t("div",{className:"editor-panel options-panel"}),l=t("div",{className:"panel-header",text:"Options"}),d=t("div",{className:"parameter-group"}),f=t("div",{className:"radio-button-group"});f.append(t("input",{type:"radio",id:"ch-pass",name:"cornerHandling",value:so.PASS_THROUGH}),t("label",{text:"Pass Through",attrs:{for:"ch-pass"}}),t("input",{type:"radio",id:"ch-cut",name:"cornerHandling",value:so.CUT_ALL}),t("label",{text:"Cut All",attrs:{for:"ch-cut"}}),t("input",{type:"radio",id:"ch-mixed",name:"cornerHandling",value:so.MIXED}),t("label",{text:"Mixed",attrs:{for:"ch-mixed"}})),d.append(t("div",{className:"parameter-group-header",text:"Corner Handling"}),f);const h=t("div",{className:"parameter-group"}),u=t("div",{className:"slider-container"});u.append(t("input",{type:"range",id:"tension-slider",attrs:{min:"0",max:"1",step:"0.01"}}),t("input",{type:"number",id:"tension-input",attrs:{min:"0",max:"1",step:"0.01"}})),h.append(t("div",{className:"parameter-group-header",text:"Tension"}),u);const p=t("div",{className:"button-row"});p.append(t("button",{id:"cancel-button",className:"editor-button secondary",text:"Cancel"}),t("button",{id:"save-button",className:"editor-button primary",text:"Save Style"})),c.append(l,d,h,p),this.wrapper.append(n,s,c),this.container.appendChild(this.wrapper)}_setupEventListeners(){const{tensionSlider:t,tensionInput:n,saveButton:i,cancelButton:o,styleNameInput:s}=this.elements;s.addEventListener("change",r=>{this.state.style.name=r.target.value}),this.wrapper.querySelectorAll('input[name="cornerHandling"]').forEach(r=>{r.addEventListener("change",c=>{c.target.checked&&(this.state.style.cornerHandling=c.target.value,this.drawPreview())})});const a=r=>{this.state.style.tension=parseFloat(r),t.value=this.state.style.tension,n.value=this.state.style.tension,this.drawPreview()};t.addEventListener("input",r=>a(r.target.value)),n.addEventListener("change",r=>a(r.target.value)),i.addEventListener("click",()=>{this.state.style.name=this.elements.styleNameInput.value,this.onSelect(this.state.style),this.hide()}),o.addEventListener("click",()=>{this.hide()})}_updateUIFromState(){const{style:t}=this.state,{styleNameInput:n,tensionSlider:i,tensionInput:o}=this.elements;n.value=t.name,this.wrapper.querySelector(`input[name="cornerHandling"][value="${t.cornerHandling}"]`).checked=!0,i.value=t.tension,o.value=t.tension}drawPreview(){if(!this.previewCtx)return;const t=this.previewCtx,n=this.elements.previewCanvas.width,i=this.elements.previewCanvas.height;t.fillStyle=Xr,t.fillRect(0,0,n,i);const o=[{x:n*.1,y:i*.2},{x:n*.4,y:i*.8},{x:n*.6,y:i*.2},{x:n*.9,y:i*.8}],s=Wr(o,this.state.style.tension,!1);t.strokeStyle=Gr,t.lineWidth=2,t.beginPath(),s.forEach((a,r)=>{r===0?t.moveTo(a.x,a.y):t.lineTo(a.x,a.y)}),t.stroke(),t.fillStyle=Hr,o.forEach(a=>{t.beginPath(),t.arc(a.x,a.y,zr,0,Math.PI*2),t.fill()})}show(t=null){t?this.state.style=JSON.parse(JSON.stringify(t)):(this.state.style=JSON.parse(JSON.stringify(ia)),this.state.style.id=`style_${Date.now()}`),this.wrapper.style.display="grid",this._updateUIFromState(),this.drawPreview()}hide(){this.wrapper.style.display="none"}}function Ps(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function jr(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,i=[];let o=0,s;for(;(s=n.exec(t))!==null;){const c=s[0],l=s.index;l>o&&i.push({type:"text",content:t.substring(o,l)}),c==="\\$"?i.push({type:"text",content:"$"}):i.push({type:"math",content:c}),o=l+c.length}o<t.length&&i.push({type:"text",content:t.substring(o)});const a=[];let r=null;for(const c of i)c.type==="text"?r===null?r={type:"text",content:c.content}:r.content+=c.content:(r!==null&&(a.push(r),r=null),a.push(c));return r!==null&&a.push(r),a.length===0&&i.length===1&&i[0].type==="text"?i:a}function qr(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let i=null,o=!1;if(t&&t[1]?.trim()?(i=t[1].trim(),o=!0):n&&n[1]?.trim()&&(i=n[1].trim(),o=!1),i===null)return`<span class="text-segment">${Ps(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(i,{throwOnError:!1,displayMode:o,output:"html",strict:"warn"})}catch(s){return console.error("KaTeX renderToString unexpected error:",s),`<span class="katex-error" title="${Ps(s.message||"Unknown KaTeX error")}">${Ps(e)}</span>`}}function Kr(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const i=t==null?"":String(t);let o="";try{o=jr(i).map(a=>a.type==="text"?`<span class="text-segment">${Ps(a.content)}</span>`:a.type==="math"?qr(a.content):"").join("")}catch(s){console.error("Error processing string segments for rendering:",s,i),o=`<span class="katex-error" title="${Ps(String(s.message||"Unknown error"))}">Error</span>`}e.innerHTML=o}function Jr(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const i=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let o;const s=[];for(i.lastIndex=0;(o=i.exec(e))!==null;){const[,h,u,p,g,y,S,m,I,x,v,A]=o;let T={};if(h){const E=h.split("_"),M=E[0].slice(1),w=E[1].slice(1);T={type:"backslashSubscript",value:`\\mathrm{${M}}_\\mathrm{${w}}`}}else if(u)T={type:"doubleBackslash",value:"\\\\"};else if(p)T={type:"command",value:p};else if(g)T={type:"backslashLetter",value:g.slice(1)};else if(y){T={type:"word",value:y};const E=s[s.length-1],M=s[s.length-2],w=E?.type==="other"&&E.value==="{"&&M?.type==="command";T.isArgument=w}else S?T={type:"number",value:S}:m?T={type:"dollar",value:"\\$"}:I?T={type:"ampersand",value:"&"}:x?T={type:"space",value:" "}:v?T={type:"newline",value:"\\\\"}:A&&(T={type:"other",value:A});T.type&&s.push(T)}const a=["a","I"],r=["+","-","=","*","/","<",">"],c=(h,u)=>{let p=h+u;for(;p>=0&&p<s.length;){if(s[p].type!=="space")return s[p];p+=u}return null},l=h=>h?h.type==="other"&&r.includes(h.value):!1,d=h=>h?h.type==="backslashLetter"||h.type==="word"&&h.value.length===1&&!a.includes(h.value):!1;let f="";for(let h=0;h<s.length;h++){const u=s[h];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":f+=u.value;break;case"other":["#","%"].includes(u.value)?f+="\\"+u.value:f+=u.value;break;case"backslashLetter":f+=u.value;break;case"word":if(u.isArgument)f+=u.value;else if(u.value.length>1)f+=`\\mathrm{${u.value}}`;else{const m=s[h-1],I=s[h-2],x=m?.type==="other"&&m.value==="(",v=x&&I?.type==="space",A=x&&I?.type!=="space",T=c(h,-1),E=c(h,1),M=l(T)||l(E);v?f+=`\\mathrm{${u.value}}`:a.includes(u.value)?M||A?f+=u.value:f+=`\\mathrm{${u.value}}`:f+=u.value}break;case"space":let g=!0;const y=c(h,-1),S=c(h,1);if(!y||!S)g=!0;else{const m=d(y),I=d(S),x=l(y),v=l(S);(x||v)&&(g=!1),m&&I&&(g=!1)}f+=g?"\\ ":" ";break;default:f+=u.value;break}}if(f.endsWith("\\ ")){const h=f.match(/(\\ )+$/);if(h){const u=h[0].length/2,p="\\,".repeat(u);f=f.replace(/(\\ )+$/,p)}}return f===""?"":`$$${f}$$`}const Zr={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},Qr={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},aa=5,Es=25,ii=20,el=20,tl=.1,ka=[1/4,1/3,1/2,2/3,3/4],ho=4,us=30,_e=5,Do=us/2,Ci=10,Ds=2,on=1,en=[6,6],Ra=[3,3],Wo=360,ws=180,La=90,Ae=2*Math.PI,ko=.01,Mi=Math.sqrt(3)/2,nl=400,sl=Math.PI/3,ol=1.5,Tt=Math.PI/6,il=1.5,al=[2,3],rl=[1,3],ll=.01,cl=8,dl=5,hl=Math.PI/24,fl=15,ps="_EDGE_",fo=300,ul=3,Ti=7,ra=1e-15,la=1e13,ca=1.15,pl=1e-5,gl=1-1e-5,Ei=.001,Na=.01,yl=.95,ml=100,Sl=1.5,Il=.5,xl=1.5,We=4,uo=.9,kn=24,Rn=10,yn=8,it=20,Te=12,ai=5,ri=20,li=10,ci=5,Uo=20,jo=12,vl="\\phantom{-}0",oo="i",js="r",bl="\\mathrm{Re}",Cl="\\mathrm{Im}",Ml=80,di=1,qo=Math.PI/2,Tl="#808080",ns="rgba(128, 128, 128, 1)",El=4,Pl=.25,rt=10,Qe=56,wl=35,da=10,Al=36,_l=30,kt=40,Dl=20,bs=32,Oa=2,an=1.5,io=[2,4],tn=1.5,Pi=10,Fa=3,Ro=15,kl=24,Rl="T",Ll=35,Nl=12,Ol=10,Fl=10,Bl=3,qs=2,Qn=7,Ko=30,wi=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],Jo=4,Nt=12,gs=30,mn=18,Pt=1,Ba=1.5,hi=11,po=18,go=60,$a=20,Va=8,$l=20,ha=18,fi=1e6,ui=1e-6,yo=1e-5,Ln=.015,ss=32,Vl=10,fa=16,Yl=12,Xl=14,es="\\hphantom{-}",dt="\\pi",ua="\\delta = ",Ts="\\theta = ",Ai=15,Yn=.8,mo=3,In=2,Hl=1,Gl=3,zl=1,Wl=140,pa=.4,Ul=.9,Ks=.05,jl=10,ga=1.5,Zo=[15,5,1],ya=80,ql=.01,ne=1e-9,_i=50,Kl=6,Jl=10,Di=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let i=1;i<=n*4;i++)e.add(i/n);return Array.from(e).sort((n,i)=>n-i)})();function Zl(e,t){const n=new Set;n.add(0);for(let i=1;i<=e;i++)for(let o=1;o<=i*t;o++)n.add(o/i);return Array.from(n).sort((i,o)=>i-o)}const Sn=Zl(Kl,Jl),rn="regular",_t=" transformation_rotation",dn=" transformation_scale",Ft="transformation_rotate_scale",En="transformation_directional_scale",Lo="none",ki="regular",ks="complex",No="polar",$s="none",Ri="lines",Li="points",Ni="triangular",Oi="polar",Xn="degrees",Vs="radians",Rs="none",Ls="on",Ql="none",ec=" ",tc="Escape",nc="Delete",sc="Backspace",oc="r",ma="=",Sa="+",Ia="-",xa="c",va="v",ba="x",Qo="z",Ca="y",Ma="a",ke="vertex",qe="edge",Fe="face",pt="text";function Je(e,t,n=!1){if(e===0)return"0";const i=Math.abs(e),o=e<0?"-":"";let s;if(n||i>=fi||i!==0&&i<ui){if(e===0)return"0";const r=i.toExponential(Math.max(0,t-1)).split("e");let c=parseFloat(r[0]).toString(),l=parseInt(r[1],10);s=`${c} \\cdot 10^{${l}}`}else{const a=i<1?0:Math.floor(Math.log10(i))+1;let r;if(i===0)r=t-1;else if(i<1){let d=0,f=i;for(;f<1&&d<t+5;)f*=10,d++;r=Math.max(0,d-1+t)}else r=Math.max(0,t-a);let c=i.toFixed(r),l=parseFloat(c);if(Math.abs(l)===0&&e!==0)return"0";s=Math.abs(l).toString()}return o+s}function Fi(e,t){return t===0?e:Fi(t,e%t)}function ee(e){return e.id1<e.id2?`${e.id1}${ps}${e.id2}`:`${e.id2}${ps}${e.id1}`}function Js(e,t,n,i,o,s){const a=o-n,r=s-i,c=a*a+r*r;if(c===0){const p=e-n,g=t-i;return Math.sqrt(p*p+g*g)}let l=-((n-e)*a+(i-t)*r)/c;l<0&&(l=0),l>1&&(l=1);const d=n+l*a,f=i+l*r,h=e-d,u=t-f;return Math.sqrt(h*h+u*u)}function he(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function xn(e,t,n,i,o=!1){const s=[];if(t==="none"||!n||n<=0)return s;if(t==="polar"){const a=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,r=Math.hypot(e.x,e.y),c=Math.round(r/n)*n;i.forEach(l=>{if(l.alpha>.01&&l.angle>0){const d=l.angle,h=Math.round(a/d)*d*Math.PI/180;s.push({x:c*Math.cos(h),y:c*Math.sin(h),isGridPoint:!0})}})}else if(t==="triangular"){const a=n*Mi,r=e.x/n-e.y/(n*Math.sqrt(3)),c=e.y/a;let l=Math.round(r),d=Math.round(c),f=Math.round(-r-c);const h=Math.abs(l-r),u=Math.abs(d-c),p=Math.abs(f-(-r-c));h>u&&h>p?l=-d-f:u>p&&(d=-l-f);const g=l*n+d*n/2,y=d*a;s.push({x:g,y,isGridPoint:!0})}else if(o){const a=Math.floor(e.x/n)*n,r=Math.floor(e.y/n)*n;s.push({x:a,y:r,isGridPoint:!0},{x:a+n,y:r,isGridPoint:!0},{x:a,y:r+n,isGridPoint:!0},{x:a+n,y:r+n,isGridPoint:!0})}else s.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return s}function wt(){return crypto.randomUUID()}function Zt(e){for(;e<0;)e+=Ae;for(;e>=Ae;)e-=Ae;return e}function Ta(e,t,n=0){let i=t-e,o=Math.round((n-i)/(2*Math.PI));return i+o*(2*Math.PI)}function Ue(e){return e=Zt(e),e>Math.PI&&(e-=Ae),e}function ic(e){for(;e<0;)e+=Wo;for(;e>=Wo;)e-=Wo;return e}function Bi(e,t){const{p1:n,p2:i}=e,{center:o,radius:s}=t,a={x:i.x-n.x,y:i.y-n.y},r={x:n.x-o.x,y:n.y-o.y},c=a.x*a.x+a.y*a.y,l=2*(r.x*a.x+r.y*a.y),d=r.x*r.x+r.y*r.y-s*s;let f=l*l-4*c*d;if(f<0)return[];f=Math.sqrt(f);const h=(-l-f)/(2*c),u=(-l+f)/(2*c);return[{x:n.x+h*a.x,y:n.y+h*a.y},{x:n.x+u*a.x,y:n.y+u*a.y}]}function Fn(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let i=2;i*i<=n;i++)for(;n%(i*i)===0;)n/=i*i,t*=i;return[t,n]}function Bn(e,t,n=""){const i=n?`\\${n}`:"";return t===1?e===1&&n?i:`${e}${i}`:e===1?`\\sqrt{${t}}${i}`:`${e}\\sqrt{${t}}${i}`}function j(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Et(e,t=Ln,n=ss){if(Math.abs(e)<yo)return"0";const i=e<0?"-":"",o=Math.abs(e);if(Math.abs(o-Math.round(o))<t){const r=Math.round(o);return i+r.toString()}const s=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[r,c]of s)if(c<=n&&Math.abs(o-r/c)<t)return i+`${r}/${c}`;for(let r=1;r<=n;r++){const c=Math.round(o*r);if(!(c===0&&o>yo)&&Math.abs(o-c/r)<t/r){const l=Fi(c,r),d=c/l,f=r/l;return f===1?i+`${d}`:i+`${d}/${f}`}}let a=2;return o<.01?a=3:o<.1?a=2:o<10?a=1:a=0,i+o.toFixed(a)}function Hn(e,t){if(t.length<3)return!1;const n=e.x,i=e.y;let o=!1;for(let s=0,a=t.length-1;s<t.length;a=s++){const r=t[s].x,c=t[s].y,l=t[a].x,d=t[a].y;if(r===n&&c===i||c===d&&c===i&&n>=Math.min(r,l)&&n<=Math.max(r,l)||r===l&&r===n&&i>=Math.min(c,d)&&i<=Math.max(c,d))return!0;c>i!=d>i&&n<(l-r)*(i-c)/(d-c)+r&&(o=!o)}return o}function Ns(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function ac(e,t,n){const i=t.localCoordSystem;if(!i)return null;const o=n(i.origin),s=cl;if(j(e,o)<s)return{face:t,type:"center"};const a=dl,r=Gt({x:1,y:0},i),c=n(r);if(St(e,o,c).distance<a)return{face:t,type:"x_axis"};const d=Gt({x:0,y:1},i),f=n(d);return St(e,o,f).distance<a?{face:t,type:"y_axis"}:null}function ys(e,t){if(Hn(e,t))return e;let n=e,i=1/0;for(let o=0;o<t.length;o++){const s=t[o],a=t[(o+1)%t.length],r=St(e,s,a);r.distance<i&&(i=r.distance,n={x:r.x,y:r.y})}return n}function rc(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:i,isInterpolationPanelExpanded:o,isTransformPanelExpanded:s,isDisplayPanelExpanded:a,isVisibilityPanelExpanded:r}){const c=(l,d)=>d?l.x>=d.x&&l.x<=d.x+d.width&&l.y>=d.y&&l.y<=d.y+d.height:!1;if(i){for(const l of t.colorTargetIcons||[])if(c(e,l))return{...l,type:"colorTargetIcon"};for(const l of t.colorSwatches||[])if(c(e,l))return{...l,type:"colorSwatch"};if(c(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(c(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(c(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(c(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(s){for(const l of t.transformIcons||[])if(c(e,l))return{...l,type:"transformIcon"}}if(o){for(const l of t.interpolationIcons||[])if(c(e,l))return{...l,type:"interpolationIcon"}}if(a){for(const l of t.displayIcons||[])if(c(e,l))return{...l,type:"displayIcon"}}if(r){for(const l of t.visibilityIcons||[])if(c(e,l))return{...l,type:"visibilityIcon"}}if(n){if(c(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(c(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(c(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(c(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(c(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(c(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"}}return c(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function lc(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function St(e,t,n){const i=n.x-t.x,o=n.y-t.y,s=e.x-t.x,a=e.y-t.y,r=i*i+o*o;if(r===0)return{x:t.x,y:t.y,distance:j(e,t),onSegmentStrict:!0,t:0};let c=(s*i+a*o)/r;const l=c>pl&&c<gl,d=Math.max(0,Math.min(1,c)),f=t.x+d*i,h=t.y+d*o,u=j(e,{x:f,y:h});return{x:f,y:h,distance:u,onSegmentStrict:l,t:d}}function Ya(e,t,n){const i=n.x-t.x,o=n.y-t.y,s=e.x-t.x,a=e.y-t.y,r=i*i+o*o;if(r===0)return{x:t.x,y:t.y,distance:j(e,t)};let c=(s*i+a*o)/r;const l=t.x+c*i,d=t.y+c*o,f=j(e,{x:l,y:d});return{x:l,y:d,distance:f}}function Cs(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function ei(e,t,n){e/=255,t/=255,n/=255;const i=Math.max(e,t,n),o=Math.min(e,t,n);let s,a,r=(i+o)/2;if(i===o)s=a=0;else{const c=i-o;switch(a=r>.5?c/(2-i-o):c/(i+o),i){case e:s=(t-n)/c+(t<n?6:0);break;case t:s=(n-e)/c+2;break;case n:s=(e-t)/c+4;break}s/=6}return[s,a,r]}function cc(e,t,n,i,o=null){const s=Math.atan2(e.y-t.y,e.x-t.x);if(!i)return{angle:s,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=hl;let r={angle:s,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},l=(f,h,u=null,p=null)=>{const g=Ue(f),y=Math.abs(Ue(s-g));if(y<a){const S=c[h],m=r.snapType?c[r.snapType]:1/0;S<m?r={angle:g,difference:y,edgeIndex:u,snapType:h,targetVertexId:p}:S===m&&y<r.difference&&(r={angle:g,difference:y,edgeIndex:u,snapType:h,targetVertexId:p})}};return i.edgeAngles&&i.edgeAngles.forEach((f,h)=>{[f,f+Math.PI/2,f-Math.PI/2,f+Math.PI].forEach(u=>{l(u,"edge",h)})}),i.vertices&&i.vertices.forEach(f=>{if(j(t,f)>ne){const h=Math.atan2(f.y-t.y,f.x-t.x);l(h,"vertex_direction",null,f.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(f=>l(f,"cardinal")),{angle:r.angle,edgeIndex:r.edgeIndex,snapType:r.snapType,snapped:r.difference<1/0,targetVertexId:r.targetVertexId}}function dc(e,t,n,i,o,s=null,a=null,r="x_axis"){if(!s||!a||!n.alignedEdgeInfo)return{snapped:!1};const c=fl/a.scale;let l=[];const{v1Id:d,v2Id:f}=n.alignedEdgeInfo,h=o(d),u=o(f);if(h&&u&&h.type==="regular"&&u.type==="regular"){const g=j(h,u);[.25,1/3,.5,2/3,.75,1].forEach(S=>{const m=g*S,I=Math.abs(s-m);l.push({scale:m,distance:I,type:"edge_fraction",priority:S===.5?1:S===1?2:3,fraction:S})})}if(l.length===0)return{snapped:!1};l.sort((g,y)=>g.priority!==y.priority?g.priority-y.priority:g.distance-y.distance);const p=l.find(g=>g.distance<c);return p?{snapped:!0,scale:p.scale,snapType:"edge_fraction",edgeFraction:p.fraction}:{snapped:!1}}function hc(e,t,n,i,o){let s=null,a=1/0;if(t&&(t.vertices&&t.vertices.forEach(r=>{const c=j(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:r,snapType:"vertex",vertexId:r.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(r=>{const c=j(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:{x:r.x,y:r.y},snapType:"edge",edgeInfo:{v1:r.v1,v2:r.v2}})}),t.faceCenters&&t.faceCenters.forEach(r=>{const c=j(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:r,snapType:"faceCenter"})})),n&&n!=="none"&&i&&i.interval1){const r=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1;xn(e,n,r,o,!0).forEach(l=>{const d=j(e,l);d<a&&(a=d,s={snapped:!0,snapPoint:l,snapType:"grid"})})}return s||{snapped:!1}}function fc(e){if(Array.isArray(e)){const[t,n,i]=ei(e[0],e[1],e[2]),o=1-i,[s,a,r]=ti(t,n,o);return[s,a,r]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,i,o,s]=t,a=parseInt(n),r=parseInt(i),c=parseInt(o),[l,d,f]=ei(a,r,c),h=1-f,[u,p,g]=ti(l,d,h);return`rgba(${u}, ${p}, ${g}, ${s})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16),[o,s,a]=ei(t,n,i),r=1-a,[c,l,d]=ti(o,s,r);return`#${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function Oo(e){let t=0;const n=e.length;for(let i=0;i<n;i++){const o=(i+1)%n;t+=e[i].x*e[o].y,t-=e[o].x*e[i].y}return t/2}function uc(e,t,n){return Math.max(t,Math.min(n,e))}function pc(e,t){return e==="light"?Qr:t}function ti(e,t,n){let i,o,s;if(t===0)i=o=s=n;else{const a=(l,d,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<.16666666666666666?l+(d-l)*6*f:f<.5?d:f<.6666666666666666?l+(d-l)*(6*(.6666666666666666-f)):l),r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;i=a(c,r,e+1/3),o=a(c,r,e),s=a(c,r,e-1/3)}return[Math.round(i*255),Math.round(o*255),Math.round(s*255)]}function ts(e,t){const n=Et(e,.001),i=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${i}`;if(n==="1")return i;if(n==="-1")return`-${i}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${i}`;if(n.includes("/")){let o="",s=n;s.startsWith("-")&&(o="-",s=s.substring(1));const a=s.split("/"),r=a[0],c=a[1];return r==="1"?`${o}\\frac{1}{${c}}${i}`:`${o}\\frac{${r}}{${c}}${i}`}return`${n}${i}`}function Be(e,t,n,i,o,s){const a={x:e.x-t.x,y:e.y-t.y};if(o){const r=Math.hypot(s.x,s.y);if(r>ne){const c={x:s.x/r,y:s.y/r},l=a.x*c.x+a.y*c.y,d={x:a.x-l*c.x,y:a.y-l*c.y},f=l*i,h={x:f*c.x+d.x,y:f*c.y+d.y};return{x:t.x+h.x,y:t.y+h.y}}return{x:e.x,y:e.y}}else{let r={...a};r.x*=i,r.y*=i;const c=r.x,l=r.y;return r.x=c*Math.cos(n)-l*Math.sin(n),r.y=c*Math.sin(n)+l*Math.cos(n),{x:t.x+r.x,y:t.y+r.y}}}function Fo(e){if(e.length<3)return null;if(e.length===3){const[t,n,i]=e,o=j(n,i),s=j(t,i),a=j(t,n),r=o+s+a;if(r<ne)return null;const c=(o*t.x+s*n.x+a*i.x)/r,l=(o*t.y+s*n.y+a*i.y)/r,f=2*(Math.abs((n.x-t.x)*(i.y-t.y)-(i.x-t.x)*(n.y-t.y))/2)/r;return{center:{x:c,y:l},radius:f}}return yc(e)}function gc(e,t,n){const i=ka.reduce((s,a)=>Math.abs(a-e.t)<Math.abs(s-e.t)?a:s),o={x:t.x+i*(n.x-t.x),y:t.y+i*(n.y-t.y)};return{fraction:i,point:o}}function yc(e){if(e.length<3)return null;let t={x:e.reduce((o,s)=>o+s.x,0)/e.length,y:e.reduce((o,s)=>o+s.y,0)/e.length};Hn(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,i=Ea(t,e);for(let o=0;o<el;o++){let s=!1;const a=i*tl,r=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of r){const l={x:n.x+c.x,y:n.y+c.y};if(Hn(l,e)){const d=Ea(l,e);d>i&&(n=l,i=d,s=!0)}}if(!s)break}return{center:n,radius:Math.max(i,ne)}}function Ea(e,t){let n=1/0;for(let i=0;i<t.length;i++){const o=t[i],s=t[(i+1)%t.length],a=Xa(e,o,s);n=Math.min(n,a)}return n}function Xa(e,t,n){return St(e,t,n).distance}function mc(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=Pa(n,t);else if(!n.localCoordSystem.isCustom){const i=Pa(n,t);i&&(n.localCoordSystem.origin=i.origin,n.localCoordSystem.scale=i.scale)}})}function Sc(e,t,n){const i=[e];let o=e,s=t;const a=n.size+2;for(let r=0;r<a;r++){if(i.push(s),s===e)return i.pop(),i;const c=n.get(s);if(!c||c.length<1)return null;const l=c.indexOf(o);if(l===-1)return null;const d=(l+1)%c.length,f=c[d];o=s,s=f}return null}function Ic(e,t,n){if(e.length<=1)return e;const i=new Set(t.map(o=>[o.id1,o.id2].sort().join("_")));return e.filter(o=>{const s=o.vertexIds;if(s.length<3)return!1;for(let a=0;a<s.length;a++)for(let r=a+2;r<s.length;r++){if(a===0&&r===s.length-1)continue;const c=s[a],l=s[r],d=[c,l].sort().join("_");if(i.has(d))return!1}return!0})}function Bo(e,t){const n=new Map,i=new Map;e.forEach(l=>{const d=t(l.id1),f=t(l.id2);!d||!f||d.type!=="regular"||f.type!=="regular"||(i.has(d.id)||i.set(d.id,d),i.has(f.id)||i.set(f.id,f),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,d]of n.entries()){const f=i.get(l);f&&d.sort((h,u)=>{const p=i.get(h),g=i.get(u);if(!p||!g)return 0;const y=Math.atan2(p.y-f.y,p.x-f.x),S=Math.atan2(g.y-f.y,g.x-f.x);return y-S})}const o=[],s=new Set;for(const[l,d]of n.entries())for(const f of d){const h=`${l}->${f}`;if(s.has(h))continue;const u=Sc(l,f,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const S=u[y],m=u[(y+1)%u.length];s.add(`${S}->${m}`)}const g={vertexIds:u};g.id=he(g),o.push(g)}}const a=Ic(o,e),r=[],c=new Set;return a.forEach(l=>{const d=[...l.vertexIds].sort().join("_");c.has(d)||(r.push(l),c.add(d))}),r}function Gn(e,t,n,i){const o={id1:e.id,id2:t.id},s=e.x-t.x,a=e.y-t.y,r=s/n,c=a/n,l=1e-5;if(n&&Math.abs(r-Math.round(r))<l&&Math.abs(c-Math.round(c))<l){o.labelMode="exact";const f=Math.round(r),h=Math.round(c);o.exactValue={g2gSquaredSum:f*f+h*h,gridInterval:n}}else o.labelMode="decimal";return o.color=i(qe),o}function Ha(e,t){let n=null,i=1/0;return t.forEach(o=>{if(!o)return;const s=Math.abs(e.x-(o.x+o.width/2));s<i&&s<o.width/2+rt&&(i=s,n=o)}),n}function xc(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function He(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],p=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${p})`}t=Math.max(0,Math.min(1,t));let i=n[0],o=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){i=n[u],o=n[u+1];break}const s=o.pos-i.pos,a=s>0?(t-i.pos)/s:0,r=Math.round(i.color[0]+(o.color[0]-i.color[0])*a),c=Math.round(i.color[1]+(o.color[1]-i.color[1])*a),l=Math.round(i.color[2]+(o.color[2]-i.color[2])*a),d=i.alpha!==void 0?i.alpha:1,f=o.alpha!==void 0?o.alpha:1,h=d+(f-d)*a;return`rgba(${r},${c},${l},${h})`}function Pa(e,t){const n=e.vertexIds.map(o=>t(o)).filter(o=>o&&o.type==="regular");if(n.length<3)return null;const i=Fo(n);return i?{origin:{...i.center},angle:0,scale:i.radius,isCustom:!1,showCoordSystem:!1}:null}function Yt(e,t){const n=new Set;return t.forEach(i=>{i.id1===e?n.add(i.id2):i.id2===e&&n.add(i.id1)}),Array.from(n)}function Gt(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},i=Math.cos(t.angle),o=Math.sin(t.angle),s={x:n.x*i-n.y*o,y:n.x*o+n.y*i};return{x:s.x+t.origin.x,y:s.y+t.origin.y}}function vc(e,t,n,i){const o=(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x);if(Math.abs(o)<ne)return null;const s=((e.x-n.x)*(n.y-i.y)-(e.y-n.y)*(n.x-i.x))/o,a=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/o;return s>ne&&s<1-ne&&a>ne&&a<1-ne?{x:e.x+s*(t.x-e.x),y:e.y+s*(t.y-e.y)}:null}function bc(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let i=0;i<t.length;i++){const o=t[i],s=t[(i+1)%t.length];if(Xa(n,o,s)<ne)return!1}if(!Hn(n,t))return!1}return!0}function Cc(e,t,n){const i=[];for(let o=0;o<t.length;o++)i.push({p1:t[o],p2:t[(o+1)%t.length]});for(const o of e){const s=n(o.id1),a=n(o.id2);if(!(!s||!a)){for(const r of i)if(vc(s,a,r.p1,r.p2))return!0}}return!1}function wa(e,t,n){const i=[];for(const o of e)for(const s of t){if(o.originalId===s.originalId&&o.transformIndex===s.transformIndex)continue;const a=j(o,s);a<n&&i.push({dist:a,sourceVertex:o,targetVertex:s,correctionVector:{x:s.x-o.x,y:s.y-o.y},type:"vertex-vertex"})}return i}function Zs(e,t,n){const i=[];for(const o of e)for(const s of t){if(!s||!s.originalEdge||!s.p1||!s.p2)continue;const a=o.transformIndex===s.transformIndex,r=o.originalId===s.originalEdge.id1||o.originalId===s.originalEdge.id2;if(a&&r)continue;const c=St(o,s.p1,s.p2);c.distance<n&&c.onSegmentStrict&&i.push({dist:c.distance,sourceVertex:o,targetEdge:s,snapPoint:{x:c.x,y:c.y},correctionVector:{x:c.x-o.x,y:c.y-o.y},type:"vertex-to-edge"})}return i}function Ga(e,t,n,i,o,s,a,r){const c=_e*2/s.scale,l=_e/s.scale,d=String(rn).trim(),f=e.filter($=>($&&$.type?String($.type).trim():"undefined")===d);if(f.length===0||o<=0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const h=new Set(e.map($=>$.id)),u=[];for(let $=0;$<o&&($+=o==1,!($>=o));$++){const Z=$,W=$;f.forEach(q=>{u.push({...r(q,Z,a),originalId:q.id,transformIndex:W,type:"regular"})})}const p=t.filter($=>$.type==="regular"&&!h.has($.id)).map($=>({...$,originalId:$.id,transformIndex:void 0})),g=n.filter($=>h.has($.id1)&&h.has($.id2)),y=[];for(let $=0;$<o&&($+=o==1,!($>=o));$++){const Z=$,W=u.filter(q=>q.transformIndex===Z);W.length>0&&g.forEach(q=>{const ye=W.find(Me=>Me.originalId===q.id1),Ie=W.find(Me=>Me.originalId===q.id2);ye&&Ie&&y.push({p1:ye,p2:Ie,originalEdge:q,transformIndex:Z,originalEdgeId:ee(q)})})}const S=n.filter($=>!h.has($.id1)||!h.has($.id2)).map($=>({p1:i($.id1),p2:i($.id2),originalEdge:$,transformIndex:void 0,originalEdgeId:ee($)})).filter($=>$.p1&&$.p2),m=[...p,...u],I=[...S,...y],x=wa(u,m,c),v=Zs(u,I,l),T=Zs(p,y,l).map($=>({dist:$.dist,sourceEdge:$.targetEdge,targetVertex:$.sourceVertex,correctionVector:{x:$.sourceVertex.x-$.snapPoint.x,y:$.sourceVertex.y-$.snapPoint.y},type:"edge-to-vertex"})),E=[...x,...v,...T];if(E.length===0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const M={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};E.sort(($,Z)=>{const W=M[$.type]??99,q=M[Z.type]??99;return W!==q?W-q:$.dist-Z.dist});const w=E[0];let b={...w.correctionVector};const C=w.sourceVertex?w.sourceVertex.transformIndex:w.sourceEdge.transformIndex,_=w.targetVertex?w.targetVertex.transformIndex:w.targetEdge?w.targetEdge.transformIndex:void 0;let P;_===void 0?P=C:P=C-_;let D={x:0,y:0};Math.abs(P)>1e-9?(D.x=b.x/P,D.y=b.y/P):D={x:0,y:0};const R={...a,delta:{x:a.delta.x+D.x,y:a.delta.y+D.y}},N=[];for(let $=0;$<o&&($+=o==1,!($>=o));$++){const Z=$,W=$;f.forEach(q=>{N.push({...r(q,Z,R),id:`final_${q.id}_${$}`,originalId:q.id,transformIndex:W,type:"regular"})})}const B=p.map($=>({...$})),k=[...B,...N],L=wa(N,k,ne),V=S.map($=>({...$})),F=[];for(let $=0;$<o&&($+=o==1,!($>=o));$++){const Z=$,W=N.filter(q=>q.transformIndex===Z);W.length>0&&g.forEach(q=>{const ye=W.find(Me=>Me.originalId===q.id1),Ie=W.find(Me=>Me.originalId===q.id2);ye&&Ie&&F.push({p1:ye,p2:Ie,originalEdge:q,transformIndex:Z,originalEdgeId:ee(q)})})}const O=[...V,...F],H=Zs(N,O,ne),U=Zs(B,F,ne);return{snapped:!0,finalTransform:R,bestSnap:w,mergePairs:L.map($=>({source:{originalId:$.sourceVertex.originalId,transformIndex:$.sourceVertex.transformIndex},target:{originalId:$.targetVertex.originalId,transformIndex:$.targetVertex.transformIndex}})),edgeSnaps:[...H,...U].map($=>({sourceVertex:{originalId:$.sourceVertex.originalId,transformIndex:$.sourceVertex.transformIndex},targetEdge:{originalEdgeId:$.targetEdge.originalEdgeId,transformIndex:$.targetEdge.transformIndex}}))}}function Mc(e,t,n,i,o,s,a){const r={delta:o},l=Ga(e,t,n,i,s,a,r,(d,f,h=r)=>({x:d.x+h.delta.x*f,y:d.y+h.delta.y*f}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const Aa=new Map;function Tc(e){const t=Wl/e;let n=Math.pow(10,Math.floor(Math.log10(t))),i=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-i)<ne||n===0)&&(i=n===0?.001:n*10,n===0&&(n=1e-4));const o=n,s=i;let a=0;s>o&&o>0&&(a=(Math.log10(t)-Math.log10(o))/(Math.log10(s)-Math.log10(o)));let r=(a-pa)/(Ul-pa);r=Math.max(0,Math.min(1,r)),r=r*r*(3-2*r);let c=1-r,l=r;c<Ks?c=0:c>1-Ks&&(c=1),l<Ks?l=0:l>1-Ks&&(l=1);const d=c+l;return d>0&&d!==2&&(c/=d,l/=d),{grid1Interval:o,grid2Interval:s,alpha1:c,alpha2:l}}function Ec(e,t,n,i){const o=i({x:0,y:0}),s={x:t/2,y:n/2},a=j(o,s);let r;a<1e-6?r=ya:r=ya/a*(180/Math.PI),(isNaN(r)||r<=ne)&&(r=ne);const c=[];let l=[...Zo],d=l[l.length-1];const f=1e-15;for(;d>f;)d/=10,l.includes(d)||l.push(d);l.sort((y,S)=>S-y);let h=null,u=null;for(let y=l.length-1;y>=0;y--){const S=l[y];if(r<S){h={angle:S,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!h&&l.length>0?(h={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!h&&l.length===0&&(h={angle:Zo[0],alpha:1}),c.push(h),u){const y=Math.log10(h.angle),S=Math.log10(u.angle),m=Math.log10(r);let I;S===y?I=0:I=(m-y)/(S-y),I=Math.max(0,Math.min(1,I));const x=I*I*(3-2*I);x>ql&&(u.alpha=x,c.push(u))}const p=[],g=new Set;c.sort((y,S)=>S.angle-y.angle);for(const y of c)g.has(y.angle)||(p.push(y),g.add(y.angle));return p.length===0&&p.push({angle:Zo[0],alpha:1}),p}function za(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:i,colors:o,isDragConfirmed:s,dragPreviewVertices:a,currentAltPressed:r},c,l,d){if(!n&&i.length===0)return;const f=new Map;s&&a&&a.forEach(u=>{if(u&&u.id){const p=u.originalId||u.id;f.set(p,u)}});const h=u=>s&&f.has(u)?f.get(u):l(u);t.forEach(u=>{const p=d(u),g=i.includes(p),y=!r&&p===n;if(s&&u.vertexIds.some(S=>f.has(S)),(g||y)&&u.color!=="transparent"){e.save(),e.fillStyle=o.selectionGlow,e.globalAlpha=Pl,e.beginPath();const S=u.vertexIds.map(I=>h(I)).filter(I=>I&&I.type==="regular");if(S.length<3){e.restore();return}S.map(I=>c(I)).forEach((I,x)=>{x===0?e.moveTo(I.x,I.y):e.lineTo(I.x,I.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(I=>{const x=t.find(v=>v.id===I);if(x){const v=x.vertexIds.map(A=>h(A)).filter(A=>A&&A.type==="regular");if(v.length>=3){const A=v.map(T=>c(T));e.moveTo(A[0].x,A[0].y),A.slice(1).forEach(T=>e.lineTo(T.x,T.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function $i(e,t,{colors:n,verticesVisible:i=!0,isSnapped:o=!1},s){if(t.type===rn&&!i&&!o)return;const a=s(t);switch(t.type){case rn:e.beginPath(),e.arc(a.x,a.y,_e,0,Ae),e.fillStyle=o?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case _t:case dn:case Ft:case En:const r=Do*2,c={type:t.type,x:a.x-r/2,y:a.y-r/2,width:r,height:r};$o(e,c,n);break}}function Wa(e,t,n,i){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=i)return{ranges:[[0,360]],isFullCircle:!0};const o={left:0,right:n,top:0,bottom:i};if(e.x+t<o.left||e.x-t>o.right||e.y+t<o.top||e.y-t>o.bottom)return null;const s=[{x:o.left,y:o.top},{x:o.right,y:o.top},{x:o.right,y:o.bottom},{x:o.left,y:o.bottom}];if(s.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const r=[];if(s.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const g=u.x-e.x,y=u.y-e.y,S=Math.atan2(-y,g),m=S<0?S+2*Math.PI:S;r.push(m*180/Math.PI)}}),[{x1:o.left,y1:o.top,x2:o.right,y2:o.top},{x1:o.right,y1:o.top,x2:o.right,y2:o.bottom},{x1:o.right,y1:o.bottom,x2:o.left,y2:o.bottom},{x1:o.left,y1:o.bottom,x2:o.left,y2:o.top}].forEach(u=>{Bi({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(g=>{const y=g.x-e.x,S=g.y-e.y,m=Math.atan2(-S,y),I=m<0?m+2*Math.PI:m;r.push(I*180/Math.PI)})}),r.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(r.map(u=>Math.round(u*1e6)/1e6))].sort((u,p)=>u-p);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let d=0,f=0,h=0;for(let u=0;u<l.length;u++){const p=l[u],g=l[(u+1)%l.length];let y;u===l.length-1?y=360-p+g:y=g-p,y>d&&(d=y,f=p,h=g)}return h>f?{ranges:[[h,f+360]],isFullCircle:!1}:{ranges:[[h,f]],isFullCircle:!1}}function Pc(e,{canvas:t,dpr:n,colors:i}){const o=t.width/n,s=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=i.background,e.fillRect(0,0,o,s)}function wc(e,{allFaces:t,facesVisible:n,isDragConfirmed:i,dragPreviewVertices:o,transformIndicatorData:s,initialDragVertexStates:a,colors:r,initialCoordSystemStates:c},l,d){if(!n||!t||!r||!e)return;const f=p=>d(p);t.filter(p=>!p.parentFaceId).forEach(p=>{if(!p||!p.vertexIds||p.vertexIds.length<3)return;const g=p.vertexIds.map(m=>f(m)).filter(m=>m&&m.type==="regular");if(g.length<3)return;const y=g.map(m=>l(m));let S=p;p.localCoordSystem,y.every(m=>m&&typeof m.x=="number"&&typeof m.y=="number")&&xo(e,y,S,r,l,d,t,f,!0)}),t.filter(p=>p.parentFaceId&&p.color!=="transparent").forEach(p=>{if(!p||!p.vertexIds||p.vertexIds.length<3)return;const g=p.vertexIds.map(m=>f(m)).filter(m=>m&&m.type==="regular");if(g.length<3)return;const y=g.map(m=>l(m));let S=p;p.localCoordSystem,y.every(m=>m&&typeof m.x=="number"&&typeof m.y=="number")&&xo(e,y,S,r,l,d,t,f,!1)})}function Ac(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:i,findVertexById:o,transformIndicatorData:s}){if(!t)return e.localCoordSystem;const a=new Set(e.vertexIds),r=new Set(i.map(p=>p.id));if([...a].every(p=>r.has(p))){const p=JSON.parse(JSON.stringify(t));if(s){const{center:g,rotation:y,scale:S,directionalScale:m,startPos:I}=s,x={x:I.x-g.x,y:I.y-g.y};if(p.origin=Be(t.origin,g,y,S,m,x),m){const v=Gt({x:1,y:0},t),A=Be(v,g,y,S,m,x);p.scale=j(p.origin,A)}else p.angle=Zt(t.angle+y),p.scale=t.scale*S}else if(i.length>0&&n.length>0){const g=i.find(S=>a.has(S.id)),y=g?n.find(S=>S.id===g.id):null;if(y){const S=y.x-g.x,m=y.y-g.y;p.origin.x+=S,p.origin.y+=m}}return p}const l=e.vertexIds.map(p=>n.find(g=>g&&g.id===p)||o(p)).filter(p=>p&&p.type==="regular");if(!t.isCustom){const p=Fo(l);if(p){const g=s?s.rotation:0;return{...t,origin:p.center,scale:p.radius,angle:Zt(t.angle+g)}}return t}const d=JSON.parse(JSON.stringify(t));if(s){const{center:p,rotation:g,scale:y,directionalScale:S,startPos:m}=s,I={x:m.x-p.x,y:m.y-p.y};if(d.origin=Be(t.origin,p,g,y,S,I),S){const x=Gt({x:1,y:0},t),v=Be(x,p,g,y,S,I);d.scale=j(d.origin,v)}else d.angle=Zt(t.angle+g),d.scale=t.scale*y}let f={...d.origin},h=d.angle,u=d.scale;if(d.attachedToVertex){if(r.has(d.attachedToVertex)){const p=n.find(g=>g.id===d.attachedToVertex);p&&(f={...p})}}else if(d.attachedToEdge&&(r.has(d.attachedToEdge.v1)||r.has(d.attachedToEdge.v2))){const p=n.find(y=>y.id===d.attachedToEdge.v1)||o(d.attachedToEdge.v1),g=n.find(y=>y.id===d.attachedToEdge.v2)||o(d.attachedToEdge.v2);p&&g&&(f={x:p.x+d.attachedToEdge.t*(g.x-p.x),y:p.y+d.attachedToEdge.t*(g.y-p.y)})}if(d.rotationAlignedToEdge&&(r.has(d.rotationAlignedToEdge.v1)||r.has(d.rotationAlignedToEdge.v2))){const p=n.find(y=>y.id===d.rotationAlignedToEdge.v1)||o(d.rotationAlignedToEdge.v1),g=n.find(y=>y.id===d.rotationAlignedToEdge.v2)||o(d.rotationAlignedToEdge.v2);if(p&&g){const y=Math.atan2(g.y-p.y,g.x-p.x),{originalAngle:S,originalSystemAngle:m}=d.rotationAlignedToEdge,I=m-S;h=Zt(y+I)}}if(d.scaleAttachedToEdge&&(r.has(d.scaleAttachedToEdge.v1)||r.has(d.scaleAttachedToEdge.v2))){const p=n.find(y=>y.id===d.scaleAttachedToEdge.v1)||o(d.scaleAttachedToEdge.v1),g=n.find(y=>y.id===d.scaleAttachedToEdge.v2)||o(d.scaleAttachedToEdge.v2);p&&g&&(u=j(p,g)*d.scaleAttachedToEdge.scaleRatio)}return l.length>=3?d.origin=ys(f,l):d.origin=f,d.angle=h,d.scale=Math.max(.01,u),d}function _c(e,t,n){const{copyCount:i,isDragConfirmed:o,initialDragVertexStates:s,dragPreviewVertices:a,transformIndicatorData:r,allEdges:c,allFaces:l,findVertexById:d,colors:f,snappedEdgesInfo:h,snappedVertexIds:u}=t,p=s.length===1&&!r&&s[0].type==="regular";if(!o||!s.length||i<=0||p)return;const g=s.filter(x=>x.type==="regular");if(g.length===0)return;const y=new Set(g.map(x=>x.id)),S=c.filter(x=>y.has(x.id1)&&y.has(x.id2)),m=c.filter(x=>y.has(x.id1)&&!y.has(x.id2)||y.has(x.id2)&&!y.has(x.id1)),I=l.filter(x=>x.vertexIds.every(v=>y.has(v)));e.save(),e.globalAlpha=1;for(let x=0;x<i;x++){x+=i==1;const v=x,A=x;let T;const E=new Map;if(r){const{center:M,rotation:w,scale:b,directionalScale:C,startPos:_}=r,P={x:_.x-M.x,y:_.y-M.y};T=g.map(D=>{const R=Be(D,M,w*A,Math.pow(b,A),C,P);return{...D,...R,id:`preview_${D.id}_${v}`,originalId:D.id,transformIndex:v}})}else{const M=a.length>0?a[0].x-s[0].x:0,w=a.length>0?a[0].y-s[0].y:0;T=g.map(b=>({...b,x:b.x+M*A,y:b.y+w*A,id:`preview_${b.id}_${v}`,originalId:b.id,transformIndex:v}))}!T||T.length===0||(T.forEach(M=>E.set(M.originalId,M)),I.forEach(M=>{const w=M.vertexIds.map(b=>E.get(b)).filter(Boolean);if(w.length===M.vertexIds.length){const b=w.map(C=>n(C));xo(e,b,M,f,n,d,[],C=>E.get(C),!1)}}),e.setLineDash([]),e.lineWidth=Ds,S.forEach(M=>{const w=E.get(M.id1),b=E.get(M.id2);if(w&&b){const C=n(w),_=n(b);if(e.beginPath(),e.moveTo(C.x,C.y),e.lineTo(_.x,_.y),M.colormapItem){const R=e.createLinearGradient(C.x,C.y,_.x,_.y),N=He(M.colormapItem,M.gradientStart),B=He(M.colormapItem,M.gradientEnd);R.addColorStop(0,N),R.addColorStop(1,B),e.strokeStyle=R}else e.strokeStyle=M.color||f.edge;e.stroke();const P=ee(M);if((h?.get(P)||[]).some(R=>R.copyIndex===v)){e.save(),e.strokeStyle=f.feedbackSnapped,e.globalAlpha=Yn,e.lineWidth=In,e.lineCap="round",e.lineJoin="round";const R=_.x-C.x,N=_.y-C.y,B=Math.hypot(R,N),k=ho;if(B>ne){const L=-N/B,V=R/B,F=L*k,O=V*k;e.beginPath(),e.arc(C.x,C.y,k,Math.atan2(O,F),Math.atan2(-O,-F)),e.lineTo(_.x-F,_.y-O),e.arc(_.x,_.y,k,Math.atan2(-O,-F),Math.atan2(O,F)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(C.x,C.y,k,0,Ae),e.stroke();e.restore()}}}),m.forEach(M=>{const w=y.has(M.id1)?M.id2:M.id1,b=y.has(M.id1)?M.id1:M.id2,C=E.get(b),_=d(w);if(C&&_){const P=n(C),D=n(_);if(e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(D.x,D.y),M.colormapItem){const B=e.createLinearGradient(P.x,P.y,D.x,D.y),k=He(M.colormapItem,M.gradientStart),L=He(M.colormapItem,M.gradientEnd);B.addColorStop(0,k),B.addColorStop(1,L),e.strokeStyle=B}else e.strokeStyle=M.color||f.edge;e.stroke();const R=ee(M);if((h?.get(R)||[]).some(B=>B.copyIndex===v)){e.save(),e.strokeStyle=f.feedbackSnapped,e.globalAlpha=Yn,e.lineWidth=In,e.lineCap="round",e.lineJoin="round";const B=D.x-P.x,k=D.y-P.y,L=Math.hypot(B,k),V=ho;if(L>ne){const F=-k/L,O=B/L,H=F*V,U=O*V;e.beginPath(),e.arc(P.x,P.y,V,Math.atan2(U,H),Math.atan2(-U,-H)),e.lineTo(D.x-H,D.y-U),e.arc(D.x,D.y,V,Math.atan2(-U,-H),Math.atan2(U,H)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(P.x,P.y,V,0,Ae),e.stroke();e.restore()}}}),T.forEach(M=>{const w=M.originalId,b=u.get(w)||[],C=b.some(D=>D.copyIndex===v),_=b.find(D=>D.copyIndex===v),P=_?_.type:null;$i(e,M,{colors:f,verticesVisible:!0,isSnapped:!1},n),C&&Vi(e,M,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:f,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:P,currentAltPressed:!1},n)}))}e.restore()}function Vi(e,t,n,i,o){const{selectedVertexIds:s,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,isSnapped:f=!1,snapType:h=null,currentAltPressed:u}=n;if(u&&d)return;let p;if(t.type===rn){if(p=s.includes(t.id),!l&&!p&&!d&&!f)return}else p=a.includes(t.id);if(p||d||f){const y=i(t);e.save();let S=c.selectionGlow;t.id===r&&t.type!=="regular"?S=c.activeCenterGlow:f?S=c.feedbackSnapped:d&&(S=c.selectionGlow),e.shadowColor=S,e.shadowBlur=Ai,e.globalAlpha=Yn,e.strokeStyle=S,e.lineWidth=In,e.beginPath();let m;t.type===rn?m=_e+mo:m=Do+mo,e.arc(y.x,y.y,m,0,Ae),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function Dc(e,t,n){const{copyCount:i=1,initialDragVertexStates:o,dragPreviewVertices:s,allEdges:a,allFaces:r,findVertexById:c,findAllVerticesInSubgraph:l,colors:d,snappedEdgesInfo:f,snappedVertexIds:h}=t;if(!o||o.length!==1||!s||s.length===0)return;const u=o[0];for(let p=0;p<i;p++){p+=i==1;const g=p,y=p;let S;const m=s.length>0?s[0].x-o[0].x:0,I=s.length>0?s[0].y-o[0].y:0;S={x:u.x+m*y,y:u.y+I*y};const x={...u,...S,originalId:u.id,transformIndex:g},v=new Set(l(u.id)),A=a.filter(M=>v.has(M.id1)&&v.has(M.id2)),T=r.filter(M=>M.vertexIds.every(w=>v.has(w))),E=M=>M===u.id?x:v.has(M)?c(M):null;T.forEach(M=>{const w=M.vertexIds.map(E).filter(Boolean);if(w.length>=3){const b=w.map(C=>n(C));xo(e,b,M,d,n,c,r,E,!0)}}),e.save(),e.lineWidth=Ds,e.setLineDash([]),A.forEach(M=>{const w=E(M.id1),b=E(M.id2);if(w&&b){const C=n(w),_=n(b);if(e.beginPath(),e.moveTo(C.x,C.y),e.lineTo(_.x,_.y),M.colormapItem){const R=e.createLinearGradient(C.x,C.y,_.x,_.y),N=He(M.colormapItem,M.gradientStart),B=He(M.colormapItem,M.gradientEnd);R.addColorStop(0,N),R.addColorStop(1,B),e.strokeStyle=R}else e.strokeStyle=M.color||d.edge;e.stroke();const P=ee(M);if((f?.get(P)||[]).some(R=>R.copyIndex===g)){e.save(),e.strokeStyle=d.feedbackSnapped,e.globalAlpha=Yn,e.lineWidth=In,e.lineCap="round",e.lineJoin="round";const R=_.x-C.x,N=_.y-C.y,B=Math.hypot(R,N),k=ho;if(B>ne){const L=-N/B,V=R/B,F=L*k,O=V*k;e.beginPath(),e.arc(C.x,C.y,k,Math.atan2(O,F),Math.atan2(-O,-F)),e.lineTo(_.x-F,_.y-O),e.arc(_.x,_.y,k,Math.atan2(-O,-F),Math.atan2(O,F)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(C.x,C.y,k,0,Ae),e.stroke();e.restore()}}}),e.restore(),v.forEach(M=>{const w=E(M);if(!w)return;const b=M===u.id,C=h.get(u.id)||[],_=b&&C.some(N=>N.copyIndex===g),P=b?C.find(N=>N.copyIndex===g):null,D=P?P.type:null,R={...w,id:`preview_${w.originalId||w.id}_${g}`,originalId:w.originalId||w.id,transformIndex:g};$i(e,R,{colors:d,verticesVisible:!0,isSnapped:!1},n),_&&Vi(e,R,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:d,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:D,currentAltPressed:!1},n)})}}function Ua(e,{startVertex:t,snappedData:n,isShiftPressed:i,currentColor:o,nextCreationColor:s,nextEdgeColor:a,colors:r,edgeColormapInfo:c},l){const d=l(t),f=l(n);if(e.save(),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(f.x,f.y),e.setLineDash(en),c&&c.colormapItem){const u=e.createLinearGradient(d.x,d.y,f.x,f.y),p=He(c.colormapItem,c.startT),g=He(c.colormapItem,c.endT);u.addColorStop(0,p),u.addColorStop(1,g),e.strokeStyle=u}else n.snapped||i?e.strokeStyle=r.feedbackSnapped:e.strokeStyle=a;if(e.lineWidth=Ds,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(f.x,f.y,_e,0,Ae),n.snapped?e.fillStyle=r.feedbackSnapped:e.fillStyle=s,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=r.feedbackSnapped,e.shadowBlur=Ai,e.globalAlpha=Yn,e.strokeStyle=r.feedbackSnapped,e.lineWidth=In;const u=_e+mo;e.beginPath(),e.arc(f.x,f.y,u,0,Ae),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function So(e,t,n){const i=[];if(n>360){const s=n-360,a=Math.floor(t/e)*e;for(let r=a;r<360;r+=e)r>=t&&i.push(r);for(let r=0;r<=s+e;r+=e)r<=s&&i.push(r)}else{const s=Math.floor(t/e)*e;for(let a=s;a<=n+e;a+=e)a>=t&&a<=n&&a>=0&&a<360&&i.push(a)}return[...new Set(i)].sort((s,a)=>s-a)}function kc(e,t,n){return e.x>=-20&&e.x<=t+it&&e.y>=-20&&e.y<=n+it}function Rc(e,t,n,i,o,{canvas:s,dpr:a,viewTransform:r,angleDisplayMode:c,colors:l},d,f){if(typeof d!="function"||typeof n!="function")return;const h=d({x:0,y:0}),u=s.width/a,p=s.height/a,g={x:u/2,y:p/2},y=Math.min(u,p)/4,S=j(h,g),m=y+S;if(m<$a||!ja(h.x,h.y,m,u,p))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=Pt;const I=Math.min(u,p)*400,x=m>I;let v=null;if(x){const C={x:0,y:0,w:u,h:p},_={x:h.x,y:h.y,r:m},P=pi(_,C);if(P.length>=2){let D=P[0],R=P[1],N=0;for(let L=0;L<P.length;L++)for(let V=L+1;V<P.length;V++){const F=(P[L].x-P[V].x)**2+(P[L].y-P[V].y)**2;F>N&&(N=F,D=P[L],R=P[V])}e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(R.x,R.y),e.stroke();const B=(Math.atan2(h.y-D.y,D.x-h.x)*180/Math.PI+360)%360,k=(Math.atan2(h.y-R.y,R.x-h.x)*180/Math.PI+360)%360;v={minAngle:Math.min(B,k),maxAngle:Math.max(B,k),isFullCircle:!1},Math.abs(B-k)>180&&(v={minAngle:Math.max(B,k),maxAngle:Math.min(B,k)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(h.x,h.y,m,0,2*Math.PI),e.stroke(),v=Wa(h,m,u,p);if(e.restore(),!v)return;const A=m/(r.scale/a),T=new Set,E=new Map;f.forEach(C=>{const _=C.alpha;if(_<Na||m*(C.angle*Math.PI/180)<Va*.5)return;const D=`rgba(${l.feedbackDefault.join(",")}, ${_*yl})`;let R;if(v.isFullCircle){R=[];for(let N=0;N<360;N+=C.angle)R.push(N)}else R=[],v.ranges&&Array.isArray(v.ranges)?v.ranges.forEach(N=>{const[B,k]=N,L=So(C.angle,B,k);R.push(...L)}):v.minAngle!==void 0&&v.maxAngle!==void 0&&(R=So(C.angle,v.minAngle,v.maxAngle)),R=[...new Set(R)];R.forEach(N=>{if(N=Math.round(N*1e10)/1e10,c==="degrees"){if(T.has(N))return}else if(c==="radians"){const H=`${N}-${C.angle}`;if(E.has(H))return}const B=N*Math.PI/180,k={x:h.x+(m+po)*Math.cos(B),y:h.y-(m+po)*Math.sin(B)},L=ml;if(!(k.x>-L&&k.x<u+L&&k.y>-L&&k.y<p+L))return;let F={textAlign:"center",textBaseline:"middle"};if(c==="radians"&&(F={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=D,e.lineWidth=on,N%90===0&&N<360){const H={x:h.x+m*Math.cos(B),y:h.y-m*Math.sin(B)};let U;const $=We*1.5;switch(N){case 0:U={x:Math.SQRT1_2,y:-Math.SQRT1_2},F={textAlign:"left",textBaseline:"bottom"};break;case 90:U={x:Math.SQRT1_2,y:-Math.SQRT1_2},F={textAlign:"left",textBaseline:"bottom"};break;case 180:U={x:-Math.SQRT1_2,y:-Math.SQRT1_2},F={textAlign:"right",textBaseline:"bottom"};break;case 270:U={x:Math.SQRT1_2,y:Math.SQRT1_2},F={textAlign:"left",textBaseline:"top"};break}const Z={x:H.x+U.x*$,y:H.y+U.y*$};e.lineWidth=Sl,e.beginPath(),e.moveTo(H.x,H.y),e.lineTo(Z.x,Z.y),e.stroke(),k.x=Z.x,k.y=Z.y}else{const H={x:h.x+(m-_e)*Math.cos(B),y:h.y-(m-_e)*Math.sin(B)},U={x:h.x+(m+_e)*Math.cos(B),y:h.y-(m+_e)*Math.sin(B)};kc(U,u,p)&&(e.beginPath(),e.moveTo(H.x,H.y),e.lineTo(U.x,U.y),e.stroke())}e.restore();let O="";if(c==="degrees"){let H=Math.max(0,(C.angle.toString().split(".")[1]||"").length);C.angle<1&&(H=Math.max(H,Math.ceil(-Math.log10(C.angle))+1));const U=Math.round(N*Math.pow(10,H))/Math.pow(10,H),$=parseFloat(U.toFixed(H));O=`${Math.round($*1e10)/1e10}^{\\circ}`}else if(N===0&&c==="radians")O="0";else if(N!==0)if(C.angle<=5){const U=N*Math.PI/180,$=Math.max(0,(C.angle.toString().split(".")[1]||"").length),Z=Math.max(3,$+2);let W=U.toFixed(Z);W=parseFloat(W).toString(),parseFloat(W)!==0&&(O=W)}else{const U=N,$=180,Z=Fi(U,$),W=U/Z,q=$/Z;q===1?W===1?O="\\pi":W===-1?O="-\\pi":O=`${W}\\pi`:W===1?O=`\\frac{\\pi}{${q}}`:W===-1?O=`-\\frac{\\pi}{${q}}`:W<0?O=`-\\frac{${Math.abs(W)}\\pi}{${q}}`:O=`\\frac{${W}\\pi}{${q}}`}if(O){const H=c==="radians"?`circ-label-${N}-${C.angle}-${A.toExponential(15)}`:`circ-label-${N}-${A.toExponential(15)}`;if(n({id:H,content:O,x:k.x,y:k.y,color:D,fontSize:hi,options:F}),c==="degrees")T.add(N);else{const U=`${N}-${C.angle}`;E.set(U,{levelAngle:C.angle,alpha:_,labelId:H})}}})});const M=l.feedbackDefault;let w=-1/0;const b={x:h.x+m,y:h.y};if(b.x>-20&&b.x<u+it&&b.y>-20&&b.y<p+it)w=0;else{const C={x:0,y:0,w:u,h:p},_={x:h.x,y:h.y,r:m},P=pi(_,C);if(P.length>0){let D=-1/0;P.forEach(N=>{const B=Math.atan2(h.y-N.y,N.x-h.x),k=B>=0?B:B+2*Math.PI,L={x:h.x+m*Math.cos(k),y:h.y-m*Math.sin(k)},V=it;L.x>-V&&L.x<u+V&&L.y>-V&&L.y<p+V&&k>D&&(D=k)}),[{x:0,y:0},{x:C.w,y:0},{x:C.w,y:C.h},{x:0,y:C.h}].forEach(N=>{if(j(N,h)<_.r){const B=Math.atan2(h.y-N.y,N.x-h.x),k=B>=0?B:B+2*Math.PI,L={x:h.x+m*Math.cos(k),y:h.y-m*Math.sin(k)},V=it;L.x>-V&&L.x<u+V&&L.y>-V&&L.y<p+V&&k>D&&(D=k)}}),D>-1/0&&(w=D)}}if(w>-1/0){const C=w,_={x:h.x+m*Math.cos(C),y:h.y-m*Math.sin(C)},P={x:-Math.sin(C),y:-Math.cos(C)},D={x:Math.cos(C),y:-Math.sin(C)},R={x:_.x-Te*P.x+Te/2*D.x,y:_.y-Te*P.y+Te/2*D.y},N={x:_.x-Te*P.x-Te/2*D.x,y:_.y-Te*P.y-Te/2*D.y};e.save(),e.fillStyle=`rgba(${M.join(",")}, 1.0)`,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(R.x,R.y),e.lineTo(N.x,N.y),e.closePath(),e.fill(),e.restore();let B;if(C===0)B={x:_.x-Uo,y:_.y+jo+Te};else{const k={x:-Math.cos(C),y:Math.sin(C)};B={x:_.x+k.x*(jo+Te)+P.x*Uo,y:_.y+k.y*(jo+Te)+P.y*Uo}}n({id:"theta-label-sticky",content:"\\theta",x:B.x,y:B.y,color:`rgba(${M.join(",")}, 1.0)`,fontSize:kn,options:{textAlign:"center",textBaseline:"middle"}})}}function pi(e,t){const{x:n,y:i,r:o}=e,{x:s,y:a,w:r,h:c}=t,l=[],d={center:{x:n,y:i},radius:o},f=(h,u,p,g)=>{Bi({p1:{x:h,y:u},p2:{x:p,y:g}},d).forEach(m=>{const I=p-h,x=g-u;let v;Math.abs(I)>Math.abs(x)?v=(m.x-h)/I:v=(m.y-u)/x,v>=0&&v<=1&&l.push({x:m.x,y:m.y})})};return f(s,a,s+r,a),f(s+r,a,s+r,a+c),f(s+r,a+c,s,a+c),f(s,a+c,s,a),l}function ja(e,t,n,i,o){return!(e+n<0||e-n>i||t+n<0||t-n>o)}function Lc(e,t,n,i,o,s,a){const r=`rgba(${a.axisTickLabel.join(",")}, ${uo})`,c=We*ol;e.save(),e.strokeStyle=r,e.lineWidth=il,e.setLineDash([]);const l=c,d=l/Math.tan(sl),f=t.x-d,h=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(f,h),e.stroke(),e.restore(),s({id:"tick-label-origin",content:vl,x:t.x-We-yn,y:t.y+We+yn,color:r,fontSize:Rn,options:{textAlign:"right",textBaseline:"top"}})}function Nc(e,t,{canvas:n,dpr:i,coordsDisplayMode:o,viewTransform:s,angleDisplayMode:a,colors:r},c,l,d,f,h){e.save();const u=n.width/i,p=n.height/i,g=c({x:0,y:0}),y=(I,x,v,A)=>{e.beginPath(),e.moveTo(I,x),e.lineTo(v,A),e.stroke();const T=Math.atan2(A-x,v-I);e.beginPath(),e.moveTo(v,A),e.lineTo(v-Te*Math.cos(T-Tt),A-Te*Math.sin(T-Tt)),e.lineTo(v-Te*Math.cos(T+Tt),A-Te*Math.sin(T+Tt)),e.closePath(),e.fill()},S=(I,x,v,A,T)=>{const E=new Map,M=new Map,w=(B,k,L)=>{if(!B||k<ko)return;const V=l({x:0,y:0}),F=l({x:u,y:p}),O=B*ne;{const H=Math.floor(V.x/B),U=Math.ceil(F.x/B),$=Math.floor(F.y/B),Z=Math.ceil(V.y/B);for(let W=H;W<=U;W++){const q=W*B;if(Math.abs(q)<O)continue;const ye=E.get(q);ye?L?E.set(q,{alpha:Math.max(ye.alpha,k),isCoarser:!0}):ye.isCoarser||E.set(q,{alpha:Math.max(ye.alpha,k),isCoarser:!1}):E.set(q,{alpha:k,isCoarser:L})}for(let W=$;W<=Z;W++){const q=W*B;if(Math.abs(q)<O)continue;const ye=M.get(q);ye?L?M.set(q,{alpha:Math.max(ye.alpha,k),isCoarser:!0}):ye.isCoarser||M.set(q,{alpha:Math.max(ye.alpha,k),isCoarser:!1}):M.set(q,{alpha:k,isCoarser:L})}}},b=!v||I>=v;w(I,x,b),w(v,A,!b);let C=!1;const _=B=>{const k=Math.abs(B);(k>=fi||k>0&&k<ui)&&(C=!0)};E.forEach((B,k)=>_(k)),M.forEach((B,k)=>_(k));const P=l({x:0,y:0}),D=l({x:u,y:p});_(P.x),_(P.y),_(D.x),_(D.y);const R=I||v||1,N=R>0?Math.max(0,-Math.floor(Math.log10(R))):0;return E.forEach((B,k)=>{const L=B.isCoarser?1:B.alpha,V=`rgba(${r.axisTickLabel.join(",")}, ${uo*L})`;e.strokeStyle=V,e.lineWidth=on;{const F=c({x:k,y:0}).x;e.beginPath(),e.moveTo(F,g.y),e.lineTo(F,g.y+We),e.stroke();let O;if(C){const U=Math.log10(Math.abs(k)),$=Math.floor(U),Z=R/Math.pow(10,$),W=Math.max(0,-Math.floor(Math.log10(Z))+1),ye=Math.abs(k).toExponential(W).split("e");let Ie=ye[0];Ie=Ie.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let Me=parseInt(ye[1],10);O=`${k<0?"-":""}${Ie} \\cdot 10^{${Me}}`}else O=k.toFixed(N).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");h({id:((U,$)=>`${U}-${$.toExponential(15)}`)("tick-label-x",k),content:O,x:F,y:g.y+We+yn,color:V,fontSize:Rn,options:{textAlign:"center",textBaseline:"top"}})}}),M.forEach((B,k)=>{const L=B.isCoarser?1:B.alpha,V=`rgba(${r.axisTickLabel.join(",")}, ${uo*L})`;e.strokeStyle=V,e.lineWidth=on;const F=c({x:0,y:k}).y;let O;if(C){const U=Math.log10(Math.abs(k)),$=Math.floor(U),Z=R/Math.pow(10,$),W=Math.max(0,-Math.floor(Math.log10(Z))+1),ye=Math.abs(k).toExponential(W).split("e");let Ie=ye[0];Ie=Ie.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let Me=parseInt(ye[1],10);O=`${k<0?"-":""}${Ie} \\cdot 10^{${Me}}`}else O=k.toFixed(N).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");o===ks&&Math.abs(k)>ne&&(O==="1"?O=oo:O==="-1"?O=`-${oo}`:O+=oo),e.beginPath(),e.moveTo(g.x,F),e.lineTo(g.x-We,F),e.stroke(),h({id:((U,$)=>`${U}-${$.toExponential(15)}`)("tick-label-y",k),content:O,x:g.x-We-yn,y:F,color:V,fontSize:Rn,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:C}};e.lineWidth=xl,e.strokeStyle=r.axis,e.fillStyle=r.axis;let m={useScientific:!1};if(o===No){const{interval1:I,interval2:x,alpha1:v,alpha2:A}=d;Fc(e,t,{canvas:n,dpr:i,colors:r},c,h);let T=!1;const E=b=>{const C=Math.abs(b);(C>=fi||C>0&&C<ui)&&(T=!0)},M=l({x:0,y:0}),w=l({x:u,y:p});E(M.x),E(M.y),E(w.x),E(w.y),Oc(e,t,{canvas:n,dpr:i,colors:r},c,l,d,h,T),Rc(e,t,h,0,0,{canvas:n,dpr:i,viewTransform:s,angleDisplayMode:a,colors:r},c,f),m={useScientific:T}}else{g.y>0&&g.y<p&&y(0,g.y,u,g.y),g.x>0&&g.x<u&&y(g.x,p,g.x,0);let I="x",x="y";o===ks&&(I=bl,x=Cl),h({id:"axis-label-x",content:I,x:u-Te-ri,y:g.y-ai,color:r.axis,fontSize:kn,options:{textAlign:"center",textBaseline:"bottom"}}),h({id:"axis-label-y",content:x,x:g.x+li,y:Te+ci,color:r.axis,fontSize:kn,options:{textAlign:"left",textBaseline:"middle"}}),m=S(d.interval1,d.alpha1,d.interval2,d.alpha2)}return Lc(e,g,u,p,o,h,r),e.restore(),m}function Oc(e,t,{canvas:n,dpr:i,colors:o},s,a,r,c,l){const d=n.width/i,f=n.height/i,h=s({x:0,y:0}),u=h.y>-20&&h.y<f+it,p=h.x>-20&&h.x<d+it;if(!u&&!p)return;const{interval1:g,interval2:y,alpha1:S,alpha2:m}=r,I=new Map,x=g||y||1,v=x>0?Math.max(0,-Math.floor(Math.log10(x))):0,A=(E,M,w)=>{if(!E||M<ko)return;let b=0;if(u){const R=a({x:0,y:h.y}),N=a({x:d,y:h.y});b=Math.max(b,Math.abs(R.x),Math.abs(N.x))}if(p){const R=a({x:h.x,y:0}),N=a({x:h.x,y:f});b=Math.max(b,Math.abs(R.y),Math.abs(N.y))}b*=1.1;const C=1,_=Math.ceil(b/E),D=Math.min(_,C+1e3);for(let R=C;R<=D;R++){const N=R*E;let B=!1;if(u){const k=s({x:N,y:0}).x,L=s({x:-N,y:0}).x;(k>=-20&&k<=d+it||L>=-20&&L<=d+it)&&(B=!0)}if(!B&&p){const k=s({x:0,y:N}).y,L=s({x:0,y:-N}).y;(k>=-20&&k<=f+it||L>=-20&&L<=f+it)&&(B=!0)}if(B){const k=I.get(N);k?w?I.set(N,{alpha:Math.max(k.alpha,M),isCoarser:!0}):k.isCoarser||I.set(N,{alpha:Math.max(k.alpha,M),isCoarser:!1}):I.set(N,{alpha:M,isCoarser:w})}}},T=!y||g>=y;A(g,S,T),A(y,m,!T),I.forEach((E,M)=>{const w=E.isCoarser?1:E.alpha,b=`rgba(${o.axisTickLabel.join(",")}, ${uo*w})`;e.strokeStyle=b,e.lineWidth=on;let C;if(l){const P=Math.log10(Math.abs(M)),D=Math.floor(P),R=x/Math.pow(10,D),N=Math.max(0,-Math.floor(Math.log10(R))+1),k=Math.abs(M).toExponential(N).split("e");let L=k[0];L=L.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let V=parseInt(k[1],10);C=`${M<0?"-":""}${L} \\cdot 10^{${V}}`}else C=M.toFixed(v).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const _=M.toExponential(15);if(u){const P=s({x:M,y:0});P.x>-20&&P.x<d+it&&(e.beginPath(),e.moveTo(P.x,h.y-We/2),e.lineTo(P.x,h.y+We/2),e.stroke(),c({id:`polartick-r-x-${_}`,content:C,x:P.x,y:h.y+We+yn,color:b,fontSize:Rn,options:{textAlign:"center",textBaseline:"top"}}));const D=s({x:-M,y:0});D.x>-20&&D.x<d+it&&(e.beginPath(),e.moveTo(D.x,h.y-We/2),e.lineTo(D.x,h.y+We/2),e.stroke(),c({id:`polartick-r-negx-${_}`,content:C,x:D.x,y:h.y+We+yn,color:b,fontSize:Rn,options:{textAlign:"center",textBaseline:"top"}}))}if(p){const P=s({x:0,y:M});P.y>-20&&P.y<f+it&&(e.beginPath(),e.moveTo(h.x-We/2,P.y),e.lineTo(h.x+We/2,P.y),e.stroke(),c({id:`polartick-r-posy-${_}`,content:C,x:h.x-We-yn,y:P.y,color:b,fontSize:Rn,options:{textAlign:"right",textBaseline:"middle"}}));const D=s({x:0,y:-M});D.y>-20&&D.y<f+it&&(e.beginPath(),e.moveTo(h.x-We/2,D.y),e.lineTo(h.x+We/2,D.y),e.stroke(),c({id:`polartick-r-negy-${_}`,content:C,x:h.x-We-yn,y:D.y,color:b,fontSize:Rn,options:{textAlign:"right",textBaseline:"middle"}}))}})}function Fc(e,t,{canvas:n,dpr:i,colors:o},s,a){const r=n.width/i,c=n.height/i,l=s({x:0,y:0}),d=(g,y,S,m)=>{e.beginPath(),e.moveTo(g,y),e.lineTo(S,m),e.stroke();const I=Math.atan2(m-y,S-g);e.beginPath(),e.moveTo(S,m),e.lineTo(S-Te*Math.cos(I-Tt),m-Te*Math.sin(I-Tt)),e.lineTo(S-Te*Math.cos(I+Tt),m-Te*Math.sin(I+Tt)),e.closePath(),e.fill()};e.lineWidth=on;const f=r>l.x,h=0<l.x,u=0<l.y,p=c>l.y;f&&(d(l.x,l.y,r,l.y),a({id:"axis-label-r-posx",content:js,x:r-Te-ri,y:l.y-ai,color:o.axis,fontSize:kn,options:{textAlign:"center",textBaseline:"bottom"}})),h&&(d(l.x,l.y,0,l.y),a({id:"axis-label-r-negx",content:js,x:Te+ri,y:l.y-ai,color:o.axis,fontSize:kn,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(d(l.x,l.y,l.x,0),a({id:"axis-label-r-posy",content:js,x:l.x+li,y:Te+ci,color:o.axis,fontSize:kn,options:{textAlign:"left",textBaseline:"middle"}})),p&&(d(l.x,l.y,l.x,c),a({id:"axis-label-r-negy",content:js,x:l.x+li,y:c-Te-ci,color:o.axis,fontSize:kn,options:{textAlign:"left",textBaseline:"middle"}}))}function Bc(e,{canvas:t,dpr:n,colors:i,gridAlpha:o},s,a,r,c,l){const d=t.width/n,f=t.height/n,h=Math.min(d,f)*nl;let u,p;if(s.x>=0&&s.x<=d&&s.y>=0&&s.y<=f)u=0;else{const b=[Js(s.x,s.y,0,0,d,0),Js(s.x,s.y,d,0,d,f),Js(s.x,s.y,d,f,0,f),Js(s.x,s.y,0,f,0,0)];u=Math.min(...b)}const y=[{x:0,y:0},{x:d,y:0},{x:d,y:f},{x:0,y:f}].map(b=>Math.sqrt((b.x-s.x)**2+(b.y-s.y)**2));p=Math.max(...y);const S=u*n/r.scale,m=p*n/r.scale,I=(b,C)=>{if(!b||C<ko||b*r.scale/n<jl)return;e.strokeStyle=`rgba(${i.grid.join(",")}, ${C*o})`,e.lineWidth=on;const P=S===0?1:Math.ceil(S/b),D=Math.floor(m/b);for(let R=P;R<=D;R++){const B=R*b*r.scale/n;if(B>h){const k=[],L={center:{x:s.x,y:s.y},radius:B};if([{p1:{x:0,y:0},p2:{x:d,y:0}},{p1:{x:d,y:0},p2:{x:d,y:f}},{p1:{x:d,y:f},p2:{x:0,y:f}},{p1:{x:0,y:f},p2:{x:0,y:0}}].forEach(F=>{Bi(F,L).forEach(H=>{H.x>=0&&H.x<=d&&H.y>=0&&H.y<=f&&k.push(H)})}),k.length>=2){let F=k[0],O=k[1],H=0;for(let U=0;U<k.length;U++)for(let $=U+1;$<k.length;$++){const Z=(k[U].x-k[$].x)**2+(k[U].y-k[$].y)**2;Z>H&&(H=Z,F=k[U],O=k[$])}e.beginPath(),e.moveTo(F.x,F.y),e.lineTo(O.x,O.y),e.stroke()}}else e.beginPath(),e.arc(s.x,s.y,B,0,Ae),e.stroke()}};if(I(c.interval1,c.alpha1),I(c.interval2,c.alpha2),!l||!Array.isArray(l))return;const x={x:d/2,y:f/2},v=Math.min(d,f)/4,A=Math.sqrt((s.x-x.x)**2+(s.y-x.y)**2),T=v+A;if(T<$a||!ja(s.x,s.y,T,d,f))return;const E=T>h;let M=null;if(E){const b={x:0,y:0,w:d,h:f},C={x:s.x,y:s.y,r:T},_=pi(C,b);if(_.length>=2){let P=_[0],D=_[1],R=0;for(let k=0;k<_.length;k++)for(let L=k+1;L<_.length;L++){const V=(_[k].x-_[L].x)**2+(_[k].y-_[L].y)**2;V>R&&(R=V,P=_[k],D=_[L])}const N=(Math.atan2(s.y-P.y,P.x-s.x)*180/Math.PI+360)%360,B=(Math.atan2(s.y-D.y,D.x-s.x)*180/Math.PI+360)%360;M={minAngle:Math.min(N,B),maxAngle:Math.max(N,B),isFullCircle:!1},Math.abs(N-B)>180&&(M={minAngle:Math.max(N,B),maxAngle:Math.min(N,B)+360,isFullCircle:!1})}}else M=Wa(s,T,d,f);if(!M)return;const w=new Set;l.forEach(b=>{const C=b.alpha;if(C<Na||T*(b.angle*Math.PI/180)<Va*.5)return;e.strokeStyle=`rgba(${i.grid.join(",")}, ${C*o})`,e.lineWidth=on*Il;let P;if(M.isFullCircle){P=[];for(let D=0;D<360;D+=b.angle)P.push(D)}else{if(P=[],M.ranges&&Array.isArray(M.ranges))M.ranges.forEach(D=>{let[R,N]=D;if(E){const V=[...[{x:0,y:0},{x:d,y:0},{x:d,y:f},{x:0,y:f}].map(H=>(Math.atan2(s.y-H.y,H.x-s.x)*180/Math.PI+360)%360),R,N].sort((H,U)=>H-U),F=Math.min(...V)-b.angle*2,O=Math.max(...V)+b.angle*2;R=F,N=O}const B=So(b.angle,R,N);P.push(...B)});else if(M.minAngle!==void 0&&M.maxAngle!==void 0){let D=M.minAngle,R=M.maxAngle;if(E){const k=[...[{x:0,y:0},{x:d,y:0},{x:d,y:f},{x:0,y:f}].map(F=>(Math.atan2(s.y-F.y,F.x-s.x)*180/Math.PI+360)%360),D,R].sort((F,O)=>F-O),L=Math.min(...k)-b.angle*2,V=Math.max(...k)+b.angle*2;D=L,R=V}P=So(b.angle,D,R)}P=[...new Set(P)]}P.forEach(D=>{if(D=Math.round(D*1e10)/1e10,w.has(D))return;const R=D*Math.PI/180,N={x:s.x+S*r.scale/n*Math.cos(R),y:s.y-S*r.scale/n*Math.sin(R)},B={x:s.x+m*r.scale/n*Math.cos(R),y:s.y-m*r.scale/n*Math.sin(R)};e.beginPath(),e.moveTo(N.x,N.y),e.lineTo(B.x,B.y),e.stroke(),w.add(D)})})}function $c(e,{gridDisplayMode:t,canvas:n,dpr:i,viewTransform:o,gridAlpha:s,colors:a},r,c,l,d){if(t===$s)return;e.save();const f=r({x:0,y:0}),h=n.width/i,u=n.height/i;if(t===Oi){const p=c({x:0,y:0}),g=c({x:h,y:u}),y=Math.hypot(Math.max(Math.abs(p.x),Math.abs(g.x)),Math.max(Math.abs(p.y),Math.abs(g.y)));Bc(e,{canvas:n,dpr:i,colors:a,gridAlpha:s},f,y,o,l,d)}else{const p=(g,y)=>{if(!g||y<ko)return;const S=`rgba(${a.grid.join(",")}, ${y*s})`,m=c({x:0,y:u}),I=c({x:h,y:0}),x=Math.floor(m.x/g),v=Math.ceil(I.x/g),A=Math.floor(m.y/g),T=Math.ceil(I.y/g);if(t===Ri){e.strokeStyle=S,e.lineWidth=on;for(let E=x;E<=v;E++){const M=E*g,w=r({x:M,y:0}).x;e.beginPath(),e.moveTo(w,0),e.lineTo(w,u),e.stroke()}for(let E=A;E<=T;E++){const M=E*g,w=r({x:0,y:M}).y;e.beginPath(),e.moveTo(0,w),e.lineTo(h,w),e.stroke()}}else if(t===Li){e.fillStyle=S;const E=ga*i;for(let M=x;M<=v;M++){const w=M*g;for(let b=A;b<=T;b++){const C=b*g,_=r({x:w,y:C});e.beginPath(),e.arc(_.x,_.y,E,0,Ae),e.fill()}}}else if(t===Ni){e.fillStyle=S;const E=ga*i,M=g*Mi,w=Math.floor(m.y/M),b=Math.ceil(I.y/M);for(let C=w;C<=b;C++){const _=C*M,D=C%2!==0?g/2:0;for(let R=x;R<=v;R++){const B=R*g+D,k=r({x:B,y:_});e.beginPath(),e.arc(k.x,k.y,E,0,Ae),e.fill()}}}};p(l.interval1,l.alpha1),p(l.interval2,l.alpha2)}e.restore()}function Yi(e,t,n,i,o,s,a=!1){e.save(),e.strokeStyle=s,e.lineWidth=on,e.setLineDash(a?Ra:[]);const r=-n,c=-i;let l=Ue(i-n);e.beginPath(),e.arc(t.x,t.y,o,r,c,l>0),e.stroke(),e.restore()}function qa(e,{info:t,colors:n,idPrefix:i,startVertexScreen:o},s,a,r){if(!t||!t.edge)return;const{edge:c,fraction:l,snapPoint:d}=t,f=a(c.id1),h=a(c.id2);if(!f||!h)return;const u=s(f),p=s(h),g=s(d),y=n.feedbackSnapped,S=lc({x:-(p.y-u.y),y:p.x-u.x});let m=1;o&&(m=(p.x-u.x)*(o.y-u.y)-(p.y-u.y)*(o.x-u.x)>0?-1:1);const I=Es,x={x:(u.x+g.x)/2,y:(u.y+g.y)/2},v={x:x.x+m*S.x*I,y:x.y+m*S.y*I},A=Et(l,.001,8);r({id:`${i}-1`,content:A,x:v.x,y:v.y,color:y,fontSize:ii,options:{textAlign:"center",textBaseline:"middle"}});const T={x:(g.x+p.x)/2,y:(g.y+p.y)/2},E={x:T.x+m*S.x*I,y:T.y+m*S.y*I},M=Et(1-l,.001,8);r({id:`${i}-2`,content:M,x:E.x,y:E.y,color:y,fontSize:ii,options:{textAlign:"center",textBaseline:"middle"}})}function Vc(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:i,isDragConfirmed:o,dragPreviewVertices:s,colors:a,edgesVisible:r,snappedEdgeIds:c,currentAltPressed:l},d,f,h){e.lineWidth=Ds,t.forEach(u=>{const p=f(u.id1),g=f(u.id2);if(!p||!g||p.type!==rn||g.type!==rn)return;const y=h(u),S=n.includes(y),m=c&&c.has(y)&&c.get(y).some(E=>E.copyIndex===void 0||E.copyIndex===0),I=!l&&y===i;if(!r&&!S&&!m&&!I)return;let x=p,v=g;const A=d(x),T=d(v);if(e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(T.x,T.y),u.colormapItem){const E=e.createLinearGradient(A.x,A.y,T.x,T.y),M=He(u.colormapItem,u.gradientStart),w=He(u.colormapItem,u.gradientEnd);E.addColorStop(0,M),E.addColorStop(1,w),e.strokeStyle=E}else e.strokeStyle=u.color||a.defaultStroke;if(e.setLineDash([]),e.lineWidth=Ds,e.stroke(),S||m||I){const E=T.x-A.x,M=T.y-A.y,w=Math.hypot(E,M),b=ho;if(e.save(),e.strokeStyle=m?a.feedbackSnapped:a.selectionGlow,e.globalAlpha=Yn,e.lineWidth=In,e.lineCap="round",e.lineJoin="round",w>ne){const C=-M/w,_=E/w,P=C*b,D=_*b;e.beginPath(),e.arc(A.x,A.y,b,Math.atan2(D,P),Math.atan2(-D,-P)),e.lineTo(T.x-P,T.y-D),e.arc(T.x,T.y,b,Math.atan2(-D,-P),Math.atan2(D,P)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(A.x,A.y,b,0,Ae),e.stroke();e.restore()}}),e.setLineDash([]),e.strokeStyle=a.defaultStroke,e.globalAlpha=1}function Io(e,t,n,i,o){const{selectedVertexIds:s,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,snappedVertexIds:f,isDragConfirmed:h,dragPreviewVertices:u,currentAltPressed:p}=n;let g=t,y=!1,S=null,m;if(h&&u){const A=u.find(T=>T&&(T.id===t.id||T.originalId===t.id));A&&(g=A,m=A.transformIndex)}if(f&&g.originalId&&f.has(g.originalId)){const T=f.get(g.originalId).find(E=>E.copyIndex===m);T&&(y=!0,S=T.type)}else if(f&&!g.originalId&&f.has(g.id)){const T=f.get(g.id).find(E=>E.copyIndex===m);T&&(y=!0,S=T.type)}let I;if(g.type===rn){if(I=s.includes(g.id),!l&&!I&&!d&&!y&&!(p&&d))return}else I=a.includes(g.id);const x=i(g);switch(g.type){case rn:e.beginPath(),e.arc(x.x,x.y,_e,0,Ae),e.fillStyle=g.color||c.vertex,e.fill();break;case _t:case dn:case Ft:case En:const A=Do*2,T={type:g.type,x:x.x-A/2,y:x.y-A/2,width:A,height:A};$o(e,T,c);break}const v={...n,isSnapped:y,snapType:S};Vi(e,g,v,i)}function Yc(e,{altHoverInfo:t,colors:n},i,o,s){if(!t)return;const{point:a,element:r,shiftKey:c,fraction:l}=t,d=i(a),f=n.feedbackSnapped,h=n.feedbackSnapped;e.save(),e.shadowColor=h,e.shadowBlur=Ai,e.globalAlpha=Yn,e.beginPath();const u=_e+mo;e.arc(d.x,d.y,u,0,Ae),e.strokeStyle=h,e.lineWidth=In,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(d.x,d.y,_e,0,Ae),e.fillStyle=f,e.fill(),e.restore(),r.type==="edge"&&c&&Xc(e,{info:{edge:r.edge,fraction:l,snapPoint:a},colors:n},i,o,s)}function Xc(e,{info:t,colors:n},i,o,s){qa(e,{info:t,colors:n,idPrefix:"alt-snap-label"},i,o,s)}function Hc(e,{info:t,colors:n},i,o,s){if(!t||!t.startVertex)return;const a=i(t.startVertex);qa(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:a},i,o,s)}function Gc(e,{transformIndicatorData:t,colors:n,currentShiftPressed:i},o){const{center:s,startPos:a,currentPos:r,rotation:c,isSnapping:l,snapType:d}=t,f=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,h=o(s),u=o(a),p=o(r);if(e.save(),e.lineWidth=Pt,e.strokeStyle=f,e.setLineDash(en),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),!i||i&&d==="projection"){const y=Be(a,s,c,1),S=o(y);e.beginPath(),e.moveTo(S.x,S.y),e.lineTo(p.x,p.y),e.stroke()}if(Math.abs(c)>Ei){e.setLineDash([]);const y=j(h,u),S=Math.atan2(u.y-h.y,u.x-h.x),m=-c,I=c>0;e.beginPath(),e.arc(h.x,h.y,y,S,S+m,I),e.stroke()}e.restore()}function zc(e,{transformIndicatorData:t,colors:n,currentShiftPressed:i},o){const{center:s,startPos:a,scale:r,isSnapping:c,snapType:l,currentPos:d}=t,f=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,h=o(s),u=o(a),p=o(d);if(e.save(),e.lineWidth=Pt,e.strokeStyle=f,e.setLineDash(en),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),!i){const m=j(h,p),I=Math.atan2(u.y-h.y,u.x-h.x),x=Math.atan2(p.y-h.y,p.x-h.x);let v=x-I;v>Math.PI?v-=2*Math.PI:v<-Math.PI&&(v+=2*Math.PI);const A=v<0;e.beginPath(),e.arc(h.x,h.y,m,I,x,A),e.stroke()}const y={x:s.x+(a.x-s.x)*r,y:s.y+(a.y-s.y)*r},S=o(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(S.x,S.y),e.stroke(),e.restore()}function Wc(e,{transformIndicatorData:t,colors:n,currentShiftPressed:i},o){const{center:s,startPos:a,currentPos:r,scale:c,startVector:l,isSnapping:d,snapType:f,projectionSource:h}=t,u=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,p=o(s),g=o(a),y=o(r);e.save(),e.lineWidth=Pt,e.strokeStyle=u,e.setLineDash(en),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(g.x,g.y),e.stroke();const S=Be(a,s,0,c,!0,l),m=o(S);if((!i||i&&f==="projection")&&(e.setLineDash(en),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(m.x,m.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(m.x,m.y),e.stroke(),d&&f==="projection"&&h){const x=o(h),v=s,A={x:s.x+l.x,y:s.y+l.y},T=Ya(h,v,A),E=o(T);e.setLineDash(en),e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(E.x,E.y),e.stroke()}e.restore()}function Uc(e,{transformIndicatorData:t,colors:n},i){const{center:o,startPos:s,rotation:a,scale:r,isSnapping:c}=t,l=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,d=i(o),f=i(s);e.save(),e.lineWidth=Pt,e.strokeStyle=l,e.setLineDash(en),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(f.x,f.y),e.stroke();const h={x:o.x+(s.x-o.x)*r,y:o.y+(s.y-o.y)*r},u=i(h);if(e.setLineDash([]),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(a)>Ei){const p=j(d,u),g=Math.atan2(f.y-d.y,f.x-d.x),y=-a,S=a>0;e.beginPath(),e.arc(d.x,d.y,p,g,g+y,S),e.stroke()}e.restore()}function jc(e,t,{transformIndicatorData:n,colors:i,coordSystemTransformIndicatorData:o,currentShiftPressed:s},a,r){if(n){const{isSnapping:c,snapType:l,transformType:d}=n;switch(e.save(),e.lineWidth=Pt,d){case Ft:Uc(e,{transformIndicatorData:n,colors:i},a);break;case _t:Gc(e,{transformIndicatorData:n,colors:i,currentShiftPressed:s},a);break;case dn:zc(e,{transformIndicatorData:n,colors:i,currentShiftPressed:s},a);break;case En:Wc(e,{transformIndicatorData:n,colors:i,currentShiftPressed:s},a);break}c&&l==="projection"&&s&&qc(e,{transformIndicatorData:n,colors:i},a),e.restore(),Kc(t,{transformIndicatorData:n,colors:i},a,r)}o&&Jc(t,{coordSystemTransformIndicatorData:o,colors:i},a,r)}function qc(e,{transformIndicatorData:t,colors:n},i){const{transformType:o,projectionSource:s,projectionCenter:a,projectionPoint:r,currentPos:c}=t;if(o!==Ft){if(e.setLineDash(en),e.strokeStyle=n.feedbackSnapped,o===_t&&r){const l=i(c),d=i(r),f=i(s);e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(d.x,d.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(d.x,d.y),e.stroke()}else if(o===dn&&a){const l=i(a),d=i(s),f=i(c),h=j(l,d);let u=Math.atan2(d.y-l.y,d.x-l.x),p=Math.atan2(f.y-l.y,f.x-l.x);const g=2*Math.PI;u=(u+g)%g,p=(p+g)%g;const y=(p-u+g)%g,m=(u-p+g)%g<y;e.beginPath(),e.arc(l.x,l.y,h,u,p,m),e.stroke()}}}function Kc(e,{transformIndicatorData:t,colors:n},i,o){const{center:s,startPos:a,rotation:r,scale:c,isSnapping:l,snapType:d,snappedScaleValue:f,transformType:h}=t,u=i(s),p=i(a),g=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(h===dn||h===Ft||h===En){let y;const S=f!==null?f:c;d==="projection"||d==="merge"&&h===Ft?y=`\\times ${parseFloat(S.toFixed(Jo)).toString()}`:l&&f!==null?y=`\\times ${Et(f,Ln,Vl)}`:y=`\\times ${parseFloat(S.toFixed(Jo)).toString()}`;const I=(u.x+p.x)/2,x=(u.y+p.y)/2,v=Math.atan2(p.y-u.y,p.x-u.x),A=v-Math.PI/2,T=I+Math.cos(A)*ha,E=x+Math.sin(A)*ha;let M=v*(180/Math.PI);(M>90||M<-90)&&(M+=180),o({id:"transform-scale-indicator",content:y,x:T,y:E,color:g,fontSize:Nt,options:{textAlign:"center",textBaseline:"bottom",rotation:M}})}else o({id:"transform-scale-indicator",content:"",x:0,y:0,color:g,fontSize:Nt,options:{}});if((h===_t||h===Ft)&&Math.abs(r)>Ei){const y=r*(180/Math.PI),S=`${parseFloat(y.toFixed(Jo)).toString()}^{\\circ}`,m={x:p.x-u.x,y:p.y-u.y},I=Math.atan2(m.y,m.x)+-r/2,v=Math.hypot(m.x,m.y)+$l,A=u.x+v*Math.cos(I),T=u.y+v*Math.sin(I);let E=I*(180/Math.PI);(E>90||E<-90)&&(E+=180),o({id:"transform-angle-indicator",content:S,x:A,y:T,color:g,fontSize:Nt,options:{rotation:E}})}else o({id:"transform-angle-indicator",content:"",x:0,y:0,color:g,fontSize:Nt,options:{}})}function Jc(e,{coordSystemTransformIndicatorData:t,colors:n},i,o){const{edgeFraction:s,orthogonalDistanceFraction:a,v1:r,v2:c,snapPosition:l}=t;let d="",f={x:0,y:0};if(a!==void 0){d=Et(a,.001,8);const h=i(l.origin),u=i(l.closest),p=(h.x+u.x)/2,g=(h.y+u.y)/2,y=Math.atan2(u.y-h.y,u.x-h.x);f.x=p+Math.cos(y+Math.PI/2)*Es,f.y=g+Math.sin(y+Math.PI/2)*Es}else if(s!==void 0){const h=i(r),u=i(c),p=i(l),g=Math.atan2(u.y-h.y,u.x-h.x),y=Math.cos(g+Math.PI/2)*Es,S=Math.sin(g+Math.PI/2)*Es;f.x=p.x+y,f.y=p.y+S,d=Et(s,.001,8)}d&&o({id:"coord-system-edge-fraction",content:d,x:f.x,y:f.y,color:n.feedbackSnapped,fontSize:ii,options:{textAlign:"center",textBaseline:"middle"}})}function Zc(e,t,n,i,{showAngles:o,showDistances:s,viewTransform:a,mousePos:r,colors:c}){if(!o&&!s||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,d=i(r);if(j(l,d)<ne)return;const h=c.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,p=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const g=n(l),y=p+u;if(e.save(),e.lineWidth=Pt,e.strokeStyle=h,o&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>ne){const S=gs+e.lineWidth/2,m={x:l.x+Math.cos(p)*(S/a.scale),y:l.y+Math.sin(p)*(S/a.scale)},I=n(m);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(I.x,I.y),e.setLineDash(rl),e.stroke(),Yi(e,g,p,y,gs,h,!1)}e.restore()}function Ka(e,t,n,i,o,{showDistances:s,showAngles:a,currentShiftPressed:r,distanceSigFigs:c,angleSigFigs:l,angleDisplayMode:d,viewTransform:f,frozenReference_D_du:h,gridDisplayMode:u,frozenReference_A_rad:p,colors:g,lastGridState:y},S,m,I){if(!a&&!s||o.distance<ne){I({id:"snap-dist",content:"",x:0,y:0}),I({id:"snap-angle",content:"",x:0,y:0});return}const x=S(n),{angle:v,distance:A,lengthSnapFactor:T,angleSnapFactor:E,angleTurn:M,gridToGridSquaredSum:w,gridInterval:b,snapType:C}=o,{offsetAngleRad:_,isFirstSegmentBeingDrawn:P,currentSegmentReferenceD:D}=m,R=o.snapped||r?g.feedbackSnapped:g.geometryInfoText,N=Math.atan2(i.y-n.y,i.x-n.x);if(A*f.scale/window.devicePixelRatio<Ba){I({id:"snap-dist",content:"",x:0,y:0}),I({id:"snap-angle",content:"",x:0,y:0});return}const B=a&&A>ne&&(P||Math.abs(M)>ne);if(s){let k="",L=o.gridInterval||null;if(!L&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&(L=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),r&&o.snapped)if(P)if(C==="grid"&&w!==null&&L)if(w===0)k="0";else{const[V,F]=Fn(w),O=L*V,H=parseFloat(O.toFixed(10));k=Bn(H,F)}else if(C==="geometric"&&T!==null){const V=T*D;k=Et(V,Ln,ss),(k===V.toFixed(2)||k===String(Math.round(V)))&&(k=Je(V,c))}else if(C==="vertex"||C==="edge_fraction"||C==="edge"){let V=!1;if(L){const F=o.x-n.x,O=o.y-n.y,H=F/L,U=O/L;if(Math.abs(H-Math.round(H))<1e-5&&Math.abs(U-Math.round(U))<1e-5){const $=Math.round(H),Z=Math.round(U),W=$*$+Z*Z;if(W===0)k="0";else{const[q,ye]=Fn(W),Ie=L*q,Me=parseFloat(Ie.toFixed(10));k=Bn(Me,ye)}V=!0}}V||(k=Je(A,c))}else k=Je(A,c);else if(C==="geometric"&&T!==null)k=ts(T,"D");else if(C==="grid"&&w!==null&&L&&h!==null&&h>ne){const F=L*Math.sqrt(w)/h;let O=!1;for(const H of Sn)if(Math.abs(F-H)<ne){k=ts(H,"D"),O=!0;break}if(!O)if(w===0)k="0";else{const[H,U]=Fn(w),$=L*H,Z=parseFloat($.toFixed(10));k=Bn(Z,U)}}else if(C==="vertex"||C==="edge_fraction"||C==="edge")if(h!==null&&h>ne){const V=A/h;let F=!1;for(const O of Sn)if(Math.abs(V-O)<ne){k=ts(O,"D"),F=!0;break}F||(k=Je(A,c))}else k=Je(A,c);else k=Je(A,c);else if(!P&&h!==null&&h>ne){const V=A/h;let F=!1;for(const O of Sn)if(Math.abs(V-O)<ne){k=ts(O,"D"),F=!0;break}F||(k=Je(A,c))}else k=Je(A,c);if(k){const V=S(n),F=S(i),O=Math.atan2(F.y-V.y,F.x-V.x),H=(V.x+F.x)/2,U=(V.y+F.y)/2;let $;if(B){const ye=P?-N:-M;ye<0&&ye>-Math.PI||ye>Math.PI?$=O-Math.PI/2:$=O+Math.PI/2}else $=O-Math.PI/2,Math.sin($)>0&&($+=Math.PI);const Z=H+Math.cos($)*mn,W=U+Math.sin($)*mn;let q=O*(ws/Math.PI);(q>La||q<-90)&&(q+=ws),I({id:"snap-dist",content:k,x:Z,y:W,color:R,fontSize:Nt,options:{rotation:q}},t)}else I({id:"snap-dist",content:"",x:0,y:0})}else I({id:"snap-dist",content:"",x:0,y:0});if(B){const k=P?0:_;Yi(e,x,k,N,gs,R),e.save(),e.beginPath();const L=gs+e.lineWidth/2,V={x:n.x+L/f.scale*Math.cos(k),y:n.y+L/f.scale*Math.sin(k)},F=S(V);e.moveTo(x.x,x.y),e.lineTo(F.x,F.y),e.strokeStyle=R,e.setLineDash(al),e.lineWidth=Pt,e.stroke(),e.restore();let O="";const H=!P&&p!==null&&Math.abs(p)>ne,U=m.currentSegmentReferenceA_for_display,$=P?N:M;if(d===Xn){let Z=Ue($)*(180/Math.PI);r&&!P&&o.snapped&&C==="geometric"&&E!==null||r&&H&&E!==null&&o.snapped&&C!=="geometric"?O=ts(E,"A"):Math.abs(Z)>yo&&(O=`${Je(Z,l)}^{\\circ}`)}else if(d===Vs){let Z=Ue($);if(r&&!P&&o.snapped&&C==="geometric"&&E!==null&&U){const W=Et(E*(U/Math.PI),Ln,ss);W==="0"?O="0":W==="1"?O=dt:W==="-1"?O=`-${dt}`:O=`${W}${dt}`}else if(r&&H&&E!==null&&o.snapped&&C!=="geometric"&&U){const W=Et(E*(U/Math.PI),Ln,ss);W==="0"?O="0":W==="1"?O=dt:W==="-1"?O=`-${dt}`:O=`${W}${dt}`}else if(Math.abs(Z)>yo){const W=Et(Z/Math.PI,Ln,ss);W!==Z.toFixed(2)?W==="0"?O="0":W==="1"?O=dt:W==="-1"?O=`-${dt}`:O=`${W}${dt}`:O=Je(Z,l)}}if(O){const Z=-k,W=-N,q=Math.cos(Z)+Math.cos(W),ye=Math.sin(Z)+Math.sin(W),Ie=Math.atan2(ye,q),Me=go;let De=Ie*(180/Math.PI);const hn={x:Me*Math.cos(Ie),y:Me*Math.sin(Ie)},bt={x:x.x+hn.x,y:x.y+hn.y};(De>90||De<-90)&&(De+=180),I({id:"snap-angle",content:O,x:bt.x,y:bt.y,color:R,fontSize:Nt,options:{rotation:De}},t)}else I({id:"snap-angle",content:"",x:0,y:0})}else I({id:"snap-angle",content:"",x:0,y:0})}function Qc(e,t,{showAngles:n,showDistances:i,viewTransform:o,mousePos:s,frozenReference_D_du:a,distanceSigFigs:r,angleSigFigs:c,angleDisplayMode:l,colors:d},f,h,u){const p=Ba/o.scale;let g=-1;if(t.frozen_Origin_Data_to_display){const b=t.frozen_Origin_Data_to_display,C=f(s);g=j(b,C)}if(!n&&!i||!t.frozen_Origin_Data_to_display||g<p)return;const y=d.frozenReference,S=t.frozen_Origin_Data_to_display,m=t.displayAngleA_valueRad_for_A_equals_label,I=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,x=t.frozen_D_du_to_display,v=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,A=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!S)return;const T=I+m,E={x:S.x+x*Math.cos(T),y:S.y+x*Math.sin(T)},M=h(S),w=h(E);if(i&&x!==null&&x>p){let b="";if(v!==null&&v>0&&A){const[k,L]=Fn(v),V=A*k,F=parseFloat(V.toFixed(10));b=`${ua}${Bn(F,L)}`}else{const k=x/di;b=`${ua}${Je(k,r)}`}const C=Math.atan2(w.y-M.y,w.x-M.x),_=(M.x+w.x)/2,P=(M.y+w.y)/2;let D=C*(ws/Math.PI);(D>La||D<-90)&&(D+=ws);let R;m!==null&&Math.abs(m)>ne?-m<0?R=C-Math.PI/2:R=C+Math.PI/2:(R=C-Math.PI/2,Math.sin(R)>0&&(R+=Math.PI));const N=_+Math.cos(R)*po,B=P+Math.sin(R)*po;u({id:"ref-dist",content:b,x:N,y:B,color:y,fontSize:hi,options:{rotation:D}},e)}if(n&&m!==null&&Math.abs(m)>ne){const b=-I,C=-(I+m),_=Math.cos(b)+Math.cos(C),P=Math.sin(b)+Math.sin(C),D=Math.atan2(P,_),R=go,N=M.x+Math.cos(D)*R,B=M.y+Math.sin(D)*R;let k=D*(180/Math.PI);(k>90||k<-90)&&(k+=180);let L="";if(l===Xn){let V=m*(ws/Math.PI);L=`${Ts}${Je(V,c)}^{\\circ}`}else l===Vs&&(L=`${Ts}${Et(m/Math.PI,Ln,ss)}${dt}`,L===`${Ts}1${dt}`&&(L=dt),L===`${Ts}-1${dt}`&&(L=`-${dt}`),L===`${Ts}0${dt}`&&(L="0"));u({id:"ref-angle",content:L,x:N,y:B,color:y,fontSize:hi,options:{rotation:k}},e)}}function ed(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:i,ghostVertexPosition:o,gridDisplayMode:s,lastGridState:a,angleDisplayMode:r,canvas:c,dpr:l,mousePos:d,colors:f,useScientific:h},u,p){if(t===Lo||!d||!n)return;let g;i&&o?g=o:g=u(d);let y=1;s!==$s&&a&&a.interval1&&(y=a.interval1);let S=y;a&&a.interval2&&a.interval2<S&&(S=a.interval2);let m,I=1;S>=1e4?(I=100,m=0):S>=1e3?(I=10,m=0):S>=100?(I=1,m=0):S>=10?m=1:m=Math.max(0,-Math.floor(Math.log10(S)))+2;const A=(b=>1)(S)+2,T=b=>{if(h){const C=A-1,P=Math.abs(b).toExponential(C).split("e");let D=P[0],R=parseInt(P[1],10);return`${b<0?"-":""}${D} \\cdot 10^{${R}}`}else return I>1?(Math.round(b/I)*I).toFixed(m):b.toFixed(m)},E=Math.min(m,Yl);let M="";switch(t){case ki:{let b=T(g.x);g.x>=0&&!b.includes("cdot")&&(b=`${es}${b}`);let C=T(g.y);g.y>=0&&!C.includes("cdot")&&(C=`${es}${C}`),M=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${b} \\\\ ${C} \\end{pmatrix*}`;break}case ks:{let b=T(g.x);g.x>=0&&!b.includes("cdot")&&(b=`${es}${b}`);const C=Math.abs(g.y);let _=T(C);const P=g.y<0?"-":"+";M=`z = ${b} ${P} ${_}${oo}`;break}case No:{const b=Math.hypot(g.x,g.y),C=Math.atan2(g.y,g.x);let _=T(b);b>=0&&!_.includes("cdot")&&(_=`${es}${_}`);let P;if(r===Xn){let D=ic(C*180/Math.PI);P=D.toFixed(E),D>=0&&(P=`${es}${P}`),P+="^{\\circ}"}else{let D=Ue(C);P=D.toFixed(E),D>=0&&(P=`${es}${P}`)}M=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${_} \\\\ ${P} \\end{pmatrix*}`;break}}const w=c.width/l;p({id:"mouse-coord-text",content:M,x:w-da,y:da,color:f.mouseCoords,fontSize:Xl,options:{textAlign:"right",textBaseline:"top"}})}function Ja(e,t,n,i){e.save();const o=t.x+t.width/2,s=t.y+t.height/2,a=t.width/2*.6;if(e.strokeStyle=i.uiIcon,e.fillStyle=i.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(o,s,a*.7,0,2*Math.PI),e.fill();for(let r=0;r<8;r++){const c=r/8*2*Math.PI,l=o+Math.cos(c)*(a*.85),d=s+Math.sin(c)*(a*.85),f=o+Math.cos(c)*(a*1.1),h=s+Math.sin(c)*(a*1.1);e.beginPath(),e.moveTo(l,d),e.lineTo(f,h),e.stroke()}}else e.beginPath(),e.arc(o,s,a,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(o-5,s-3,a,0,2*Math.PI),e.fillStyle=i.background,e.fill();e.restore()}function td(e,t,n,i,o,s,a){const r=i?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/bs;e.scale(l,l),e.translate(-16,-16);const d=1;e.strokeStyle=r,e.lineWidth=an,e.lineCap="round",e.beginPath(),e.moveTo(2+d,30),e.lineTo(30+d,30),e.moveTo(2+d,30),e.lineTo(2+d,2),e.stroke(),e.fillStyle=r;const f={x:16+d,y:16};let h={x:17+d,y:8},u="";switch(n){case ki:e.setLineDash(io),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(f.x,30),e.moveTo(f.x,f.y),e.lineTo(2+d,f.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(f.x,f.y,tn,0,Ae),e.fill(),u="(x,y)";break;case ks:e.setLineDash(io),e.beginPath(),e.moveTo(2+d,30),e.lineTo(f.x,f.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(f.x,f.y,tn,0,Ae),e.fill(),u="x+iy";break;case No:e.setLineDash(io),e.beginPath(),e.moveTo(2+d,30),e.lineTo(f.x,f.y),e.stroke(),e.beginPath(),e.arc(2+d,30,8,-Math.atan2(30-f.y,f.x-(2+d)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(f.x,f.y,tn,0,Ae),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const p="icon-label-coords",g=i?a.uiTextSelected:a.uiTextDefault;s({id:p,content:u,x:c.x+(h.x-16)*l,y:c.y+(h.y-16)*l,color:g,fontSize:Pi,options:{textAlign:"center",textBaseline:"middle"}},o)}}function Za(e,t,n,i,o,s,a){const r=i?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(c.x,c.y);const d=t.width/bs;e.scale(d,d),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=an;const f={x:28,y:30},h={x:4,y:30},u={x:16,y:8};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke();let p="",g={x:20,y:22};if(n!==Rs){e.beginPath();const y=Math.atan2(u.y-h.y,u.x-h.x);e.arc(h.x,h.y,8,y,0),e.stroke(),n===Xn?p="60^\\circ":n===Vs&&(p="\\frac{\\pi}{3}",l=2)}if(e.restore(),p){const y="icon-label-angles",S=i?a.uiTextSelected:a.uiTextDefault;s({id:y,content:p,x:c.x+(g.x-16)*d,y:c.y+(g.y-20)*d,color:S,fontSize:Pi+l,options:{textAlign:"center",textBaseline:"middle"}},o)}}function Qa(e,t,n,i,o,s,a){const r=i?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/bs;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=an,e.beginPath(),e.moveTo(2,30),e.lineTo(30,30),e.stroke();let d="",f={x:16,y:22};if(n===Ls&&(d="3.14"),e.restore(),d){const h="icon-label-distances",u=i?a.uiTextSelected:a.uiTextDefault;s({id:h,content:d,x:c.x+(f.x-16)*l,y:c.y+(f.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},o)}}function nd(e,t,n,i,o){const s=i?o.uiIconSelected:o.uiIconDefault,a={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(a.x,a.y);const r=t.width/bs;switch(e.scale(r,r),e.translate(-16,-16),e.strokeStyle=s,e.fillStyle=s,e.lineWidth=an,n){case Ri:e.strokeRect(2,2,28,28),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Li:e.strokeRect(2,2,28,28),e.beginPath(),[8,16,24].forEach(f=>{[8,16,24].forEach(h=>{e.moveTo(f,h),e.arc(f,h,tn,0,Ae)})}),e.fill();break;case Ni:e.strokeRect(2,2,28,28);const c=8,l=16,d=16;e.beginPath(),e.arc(l,d,tn,0,Ae);for(let f=0;f<6;f++){const h=Math.PI/3*f,u=l+c*Math.cos(h),p=d+c*Math.sin(h);e.moveTo(u,p),e.arc(u,p,tn,0,Ae)}e.fill();break;case Oi:e.beginPath(),e.arc(16,16,14,0,Ae),e.stroke(),e.beginPath(),e.arc(16,16,7,0,Ae),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case $s:e.strokeRect(2,2,28,28);break}e.restore()}function $o(e,t,n){const i={x:t.x+t.width/2,y:t.y+t.height/2},o=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=an,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(i.x,i.y),t.type){case _t:{const s=-Math.PI/4;e.beginPath(),e.arc(0,0,o,s,-s),e.stroke(),e.beginPath(),e.arc(0,0,o,Math.PI+s,Math.PI-s),e.stroke();const a=o*.25,r=o*Math.cos(s),c=o*Math.sin(s);e.save(),e.translate(r,c),e.rotate(s-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=o*Math.cos(Math.PI+s),d=o*Math.sin(Math.PI+s);e.save(),e.translate(l,d),e.rotate(s+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();break}case dn:{const s=o*.8,a=o*.25;e.beginPath(),e.moveTo(-s,0),e.lineTo(s,0),e.moveTo(0,-s),e.lineTo(0,s),e.stroke(),[{x:s,y:0,dirX:1,dirY:0},{x:-s,y:0,dirX:-1,dirY:0},{x:0,y:-s,dirX:0,dirY:-1},{x:0,y:s,dirX:0,dirY:1}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}case Ft:{const s=-Math.PI/4;e.beginPath(),e.arc(0,0,o,s,-s),e.stroke(),e.beginPath(),e.arc(0,0,o,Math.PI+s,Math.PI-s),e.stroke();let a=o*.25;const r=o*Math.cos(s),c=o*Math.sin(s);e.save(),e.translate(r,c),e.rotate(s-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=o*Math.cos(Math.PI+s),d=o*Math.sin(Math.PI+s);e.save(),e.translate(l,d),e.rotate(s+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const f=o*.8;a=o*.25,e.beginPath(),e.moveTo(-f,0),e.lineTo(f,0),e.moveTo(0,-f),e.lineTo(0,f),e.stroke(),[{x:f,y:0,dirX:1,dirY:0},{x:-f,y:0,dirX:-1,dirY:0},{x:0,y:-f,dirX:0,dirY:-1},{x:0,y:f,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a+u.dirY*a*.5,u.y-u.dirY*a-u.dirX*a*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a-u.dirY*a*.5,u.y-u.dirY*a+u.dirX*a*.5),e.stroke()});break}case En:{const s=o*.8,a=o*.25;e.beginPath(),e.moveTo(-s/Math.sqrt(2),-s/Math.sqrt(2)),e.lineTo(s/Math.sqrt(2),s/Math.sqrt(2)),e.moveTo(s/Math.sqrt(2),-s/Math.sqrt(2)),e.lineTo(-s/Math.sqrt(2),s/Math.sqrt(2)),e.stroke(),[{x:s/Math.sqrt(2),y:-s/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-s/Math.sqrt(2),y:s/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}}e.restore()}function sd(e,t,n){const i=t.x+t.width/2,o=t.y+t.height/2,s=t.width*.6,a=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=an,e.lineCap="round",e.beginPath(),e.ellipse(i,o,s/2,a/2,0,0,2*Math.PI),e.stroke();const r=a*.3;e.beginPath(),e.arc(i,o,r,0,2*Math.PI),e.fill(),e.restore()}function od(e,t,n,i){const{canvasUI:o,colors:s,allColors:a,namedColors:r,colorAssignments:c,activeColorTargets:l,verticesVisible:d,edgesVisible:f,facesVisible:h,isDraggingColorTarget:u,draggedColorTargetInfo:p,mousePos:g}=n,y=s.checkerboardColor1,S=s.checkerboardColor2;function m(T){const E=T.height/3,M=Math.ceil(T.width/E);for(let w=0;w<3;w++)for(let b=0;b<M;b++){e.fillStyle=(w+b)%2===0?y:S;const C=T.x+b*E,_=T.y+w*E,P=Math.min(E,T.x+T.width-C),D=Math.min(E,T.y+T.height-_);P>0&&D>0&&e.fillRect(C,_,P,D)}}const I=o.randomColorButton;if(I){e.fillStyle="#000000",e.fillRect(I.x,I.y,I.width,I.height),e.strokeStyle=s.uiDefault,e.lineWidth=qs,e.strokeRect(I.x,I.y,I.width,I.height);const T=I.x+I.width/2,E=I.y+I.height/2,M=I.width*.35,w=8;for(let b=0;b<w;b++){const C=b/w*2*Math.PI,_=(b+1)/w*2*Math.PI,P=b/w*360;e.fillStyle=`hsl(${P}, 70%, 60%)`,e.beginPath(),e.moveTo(T,E),e.arc(T,E,M,C,_),e.closePath(),e.fill()}e.fillStyle=s.background,e.beginPath(),e.arc(T,E,M*.4,0,2*Math.PI),e.fill()}const x=o.removeColorButton;x&&(e.strokeStyle=s.uiDefault,e.lineWidth=qs,e.strokeRect(x.x,x.y,x.width,x.height),e.beginPath(),e.moveTo(x.x+Qn,x.y+x.height/2),e.lineTo(x.x+x.width-Qn,x.y+x.height/2),e.stroke()),o.colorSwatches.forEach(T=>{const E=T.item;let M=!1;if(E&&E.type==="color"){const w=Ns(E.value);w&&w.a<1&&(M=!0)}else E&&E.type==="colormap"&&E.vertices.some(w=>w.alpha!==void 0&&w.alpha<1)&&(M=!0);if(M&&m(T),E&&E.type==="colormap"){const w=e.createLinearGradient(T.x,T.y,T.x+T.width,T.y);E.vertices.forEach(b=>{let C=b.color;typeof C=="string"&&(C=r[C]||[0,0,0]),w.addColorStop(b.pos,`rgba(${C.join(",")},${b.alpha||1})`)}),e.fillStyle=w}else E&&(e.fillStyle=E.value);e.fillRect(T.x,T.y,T.width,T.height)});const v=o.addColorButton;if(v&&(e.strokeStyle=s.uiDefault,e.lineWidth=qs,e.strokeRect(v.x,v.y,v.width,v.height),e.beginPath(),e.moveTo(v.x+v.width/2,v.y+Qn),e.lineTo(v.x+v.width/2,v.y+v.height-Qn),e.moveTo(v.x+Qn,v.y+v.height/2),e.lineTo(v.x+v.width-Qn,v.y+v.height/2),e.stroke()),o.colorTargetIcons){const T=w=>{let b=c[w];return u&&p&&p.target===w&&p.previewColorIndex!==void 0&&(b=p.previewColorIndex),b},E=w=>{let b=T(w);const C=b===-1?null:a[b],_={};if(w===ke)_.vertexState=d?"filled":"disabled",b===-1?_.vertexColor=ns:C&&C.type==="color"?_.vertexColor=C.value:C&&C.type==="colormap"&&(_.vertexColormapItem=C);else if(w===qe)_.edgeState=f?"solid":"disabled",b===-1?_.edgeColor=ns:C&&C.type==="color"?_.edgeColor=C.value:C&&C.type==="colormap"&&(_.edgeColormapItem=C);else if(w===Fe)_.faceState=h?"filled":"disabled",b===-1?_.faceColor=ns:C&&C.type==="color"?_.faceColor=C.value:C&&C.type==="colormap"&&(_.faceColormapItem=C);else if(w===pt){b===-1?_.textColor=ns:C&&C.type==="color"?_.textColor=C.value:C&&C.type==="colormap"&&(_.textColor=He(C,.5));const P=T(Fe);if(P===b){const D=P===-1?null:a[P];D?D.type==="color"?_.faceColorForContrast=D.value:D.type==="colormap"&&(_.faceColorForContrast=He(D,.5)):_.faceColorForContrast=ns}}return _};[Fe,qe,ke,pt].forEach(w=>{const b=o.colorTargetIcons.find(C=>C.target===w);if(b){const C=l.includes(w),_=E(w);if(u&&p&&p.target===Fe&&w===Fe){const P=o.colorSwatches.find(D=>g.x>=D.x&&g.x<=D.x+D.width&&g.y>=D.y&&g.y<=D.y+D.height);if(P&&P.item.type==="colormap"){const D=uc((g.x-P.x)/P.width,0,1);_.faceColor=He(P.item,D),_.faceState="filled"}}w===pt?ad(e,b,_,s,C):er(e,b,_,s,C)}})}const A=new Set;l.forEach(T=>{let E=c[T];if(u&&p&&p.target===T&&p.previewColorIndex!==void 0&&(E=p.previewColorIndex),E===-1||A.has(E))return;const M=o.colorSwatches.find(w=>w.index===E);if(M){const w=Object.keys(c).filter(C=>{let _=c[C];return u&&p&&p.target===C&&p.previewColorIndex!==void 0&&(_=p.previewColorIndex),_===M.index&&l.includes(C)}),b=o.colorTargetIcons.filter(C=>w.includes(C.target));if(b.length>0){const C=Math.min(...b.map(B=>B.y));e.strokeStyle=s.selectionGlow,e.lineWidth=qs;const _=2,P=M.x-_,D=C-_,R=M.width+_*2,N=M.y+M.height-D+_;e.strokeRect(P,D,R,N),A.add(E)}}})}function id(e,t,{verticesVisible:n,edgesVisible:i,facesVisible:o,colorAssignments:s,allColors:a},r){const c=!n&&!i&&!o,l={vertexState:n||c?"filled":"hidden",edgeState:i||c?"solid":"hidden",faceState:o||c?"filled":"hidden",showAllDisabled:c},d=s[ke];if(d!==-1){const u=a[d];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=r.vertex;const f=s[qe];if(f!==-1){const u=a[f];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=r.edge;const h=s[Fe];if(h!==-1){const u=a[h];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=r.face;er(e,t,l,r)}function er(e,t,n,i,o=!1){const{vertexState:s="none",edgeState:a="none",faceState:r="none",faceColor:c,edgeColor:l,vertexColor:d,faceColormapItem:f,showAllDisabled:h=!1}=n;e.save();const u={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(u.x,u.y);const p=t.width/bs;e.scale(p,p),e.translate(-16,-16);const g=26,y=g*Math.sqrt(3)/2,S=[{x:16,y:16-y/1.5},{x:16-g/2,y:16+y/3},{x:16+g/2,y:16+y/3}],m=new Path2D;if(m.moveTo(S[0].x,S[0].y),m.lineTo(S[1].x,S[1].y),m.lineTo(S[2].x,S[2].y),m.closePath(),r==="filled"){if(f&&f.type==="colormap"){const x=e.createLinearGradient(S[1].x,0,S[2].x,0);f.vertices.forEach(v=>{const A=v.color,T=v.alpha!==void 0?v.alpha:1,E=`rgba(${A.join(",")},${T})`;x.addColorStop(v.pos,E)}),e.fillStyle=x}else e.fillStyle=c||i.face;e.fill(m)}else r==="disabled"&&(e.fillStyle=Tl,e.fill(m));if(a==="solid"||a==="disabled"){e.lineWidth=an,e.setLineDash([]);const x=[[S[0],S[1]],[S[1],S[2]],[S[2],S[0]]];x.forEach((v,A)=>{const[T,E]=v;if(n.edgeColormapItem&&n.edgeColormapItem.type==="colormap"&&a==="solid"){const M=e.createLinearGradient(T.x,T.y,E.x,E.y),w=x.length>1?A/(x.length-1):.5,b=Math.max(0,Math.min(1,w)),C=Math.max(0,Math.min(1,w+.3)),_=He(n.edgeColormapItem,b),P=He(n.edgeColormapItem,C);M.addColorStop(0,_),M.addColorStop(1,P),e.strokeStyle=M}else a==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||i.edge;e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(E.x,E.y),e.stroke()})}(s==="filled"||s==="disabled")&&(e.lineWidth=an,S.forEach((x,v)=>{let A=d||i.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&s==="filled"){const E=S.length>1?v/(S.length-1):.5;A=He(n.vertexColormapItem,E)}s==="disabled"&&(A="#808080");const T=new Path2D;T.moveTo(x.x+tn*2,x.y),T.arc(x.x,x.y,tn*2,0,2*Math.PI),e.fillStyle=A,e.setLineDash([]),e.fill(T)})),h?(e.strokeStyle=i.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(s==="disabled"||a==="disabled"||r==="disabled")&&(e.strokeStyle=i.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),e.restore()}function ad(e,t,n,i,o=!1){e.save();const s={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(s.x,s.y);const a=t.width/bs;e.scale(a,a),e.translate(-16,-16);let r=n.textColor||i.uiTextDefault;if(n.faceColorForContrast){const c=Ns(n.faceColorForContrast);r=(.2126*c.r+.7152*c.g+.0722*c.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=r,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function xo(e,t,n,i,o,s,a,r,c){if(!(!t||t.length<3)){if(e.save(),e.beginPath(),t.forEach((l,d)=>{d===0?e.moveTo(l.x,l.y):e.lineTo(l.x,l.y)}),e.closePath(),c&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(l=>{const d=a.find(f=>f.id===l);if(d){const f=d.vertexIds.map(h=>r(h)).filter(h=>h&&h.type==="regular");if(f.length>=3){const h=f.map(u=>o(u));e.moveTo(h[0].x,h[0].y),h.slice(1).forEach(u=>{e.lineTo(u.x,u.y)}),e.closePath()}}}),n&&n.colormapItem&&n.localCoordSystem)if(n.colormapItem.isCyclic===!0){const d=JSON.stringify(n.colormapItem.vertices);let f=Aa.get(d);if(!f){f=document.createElement("canvas"),f.width=256,f.height=1;const v=f.getContext("2d"),A=v.createLinearGradient(0,0,256,0);n.colormapItem.vertices.forEach(T=>{const E=T.color,M=T.alpha!==void 0?T.alpha:1;let w=`rgba(255,255,255,${M})`;typeof E=="string"?w=E:Array.isArray(E)&&(w=`rgba(${E.join(",")},${M})`),A.addColorStop(T.pos,w)}),v.fillStyle=A,v.fillRect(0,0,256,1),Aa.set(d,f)}const h=e.createPattern(f,"repeat"),u=o(n.localCoordSystem.origin),p=Gt({x:1,y:0},n.localCoordSystem),g=o(p),y=g.x-u.x,S=g.y-u.y,m=Math.hypot(y,S),I=m>0?m/256:0,x=new DOMMatrix;x.translateSelf(u.x,u.y),x.rotateSelf(0,0,-n.localCoordSystem.angle*180/Math.PI),x.scaleSelf(I,I),h.setTransform(x),e.fillStyle=h,e.fill(c?"evenodd":"nonzero")}else{const d={x:0,y:0},f={x:1,y:0},h=Gt(d,n.localCoordSystem),u=Gt(f,n.localCoordSystem),p=o(h),g=o(u),y=e.createLinearGradient(p.x,p.y,g.x,g.y);n.colormapItem.vertices.forEach(S=>{let m=S.color;if(typeof m=="string")y.addColorStop(S.pos,m);else{const I=S.alpha!==void 0?S.alpha:1;y.addColorStop(S.pos,`rgba(${m.join(",")},${I})`)}}),e.fillStyle=y,e.fill(c?"evenodd":"nonzero")}else e.fillStyle=n?.color||i.face,e.fill(c?"evenodd":"nonzero");e.restore()}}function rd(e,t,n,i,o,s){const{angleDisplayMode:a,distanceDisplayMode:r,colors:c}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":Za(e,l,a,a!==Rs,i,o,c);break;case"distances":Qa(e,l,r,r===Ls,i,o,c);break}}function ld(e,t,n,i){const{canvasUI:o,colorAssignments:s,allColors:a,colors:r}=n,c=l=>{if(!s||!a)return r.uiIcon;const d=s[l];if(d===-1)return ns;const f=a[d];return f&&f.type==="color"?f.value:r.uiIcon};c(ke),c(qe),c(Fe),o.visibilityIcons.forEach(l=>{rd(e,l,n,t,i)})}function tr(e,t,n,i=!1){const o={x:t.x+t.width*.2,y:t.y+t.height*.7},s={x:t.x+t.width*.5,y:t.y+t.height*.2},a={x:t.x+t.width*.8,y:t.y+t.height*.6},r={x:(o.x+a.x)/2,y:(o.y+a.y)/2};e.save(),e.strokeStyle=n.uiDefault,e.lineWidth=an,e.setLineDash(io),e.beginPath(),e.moveTo(o.x,o.y),i||e.lineTo(s.x,s.y),e.lineTo(a.x,a.y),e.stroke(),e.setLineDash([]),e.strokeStyle=n.uiIcon,e.lineWidth=Oa,e.beginPath(),e.moveTo(o.x,o.y),i?e.lineTo(a.x,a.y):e.quadraticCurveTo(s.x,s.y,a.x,a.y),e.stroke(),e.fillStyle=n.uiIcon,(i?[o,r,a]:[o,s,a]).forEach(l=>{e.beginPath(),e.arc(l.x,l.y,tn+.5,0,Math.PI*2),e.fill()}),e.restore()}function cd(e,t,n,i){const{canvasUI:o,colors:s,activeInterpolationStyleId:a,interpolationStyles:r}=n;o.interpolationIcons.forEach(c=>{const l={x:c.x,y:c.y,width:c.width,height:c.height};if(c.type==="interpolationStyle"){const d=c.styleId===a;e.strokeStyle=d?s.uiIconSelected:s.uiDefault,e.lineWidth=d?2:1,e.strokeRect(l.x,l.y,l.width,l.height);const f=r.find(u=>u.id===c.styleId),h=!!(f?.type==="linear"||f?.type==="cubic_spline"&&Number(f?.tension)===0||(f?.name||"").toLowerCase().includes("linear"));tr(e,l,s,h),f?.name&&i({id:`interpolation-label-${c.styleId}`,content:f.name.length>6?`${f.name.slice(0,6)}...`:f.name,x:l.x+l.width/2,y:l.y+l.height+10,color:s.uiTextDefault,fontSize:Pi,options:{textAlign:"center",textBaseline:"top"}},t)}else c.type==="interpolationAdd"&&(e.strokeStyle=s.uiDefault,e.lineWidth=2,e.strokeRect(l.x,l.y,l.width,l.height),e.beginPath(),e.moveTo(l.x+l.width/2,l.y+l.height*.25),e.lineTo(l.x+l.width/2,l.y+l.height*.75),e.moveTo(l.x+l.width*.25,l.y+l.height/2),e.lineTo(l.x+l.width*.75,l.y+l.height/2),e.stroke())})}function dd(e,t,n,i){const{canvasUI:o,colors:s,activeThemeName:a,colorAssignments:r,allColors:c,verticesVisible:l,edgesVisible:d,facesVisible:f}=n,h=o.toolbarButton;e.strokeStyle=s.uiDefault,e.lineWidth=Fa,e.beginPath();for(let I=0;I<3;I++){const x=h.y+5+I*10;e.moveTo(h.x+4,x),e.lineTo(h.x+h.width-4,x)}e.stroke();const u=o.colorToolButton;u&&id(e,u,{verticesVisible:l,edgesVisible:d,facesVisible:f,colorAssignments:r,allColors:c},s);const p=o.transformToolButton;p&&i({id:"transform-tool-label",content:Rl,x:p.x+p.width/2,y:p.y+p.height/2,color:s.uiIcon,fontSize:kl,options:{textAlign:"center",textBaseline:"middle"}},t);const g=o.interpolationToolButton;g&&tr(e,g,s);const y=o.displayToolButton;if(y){e.strokeStyle=s.uiDefault,e.fillStyle=s.uiDefault,e.lineWidth=Oa;const I=y.width-Nl;for(let x=0;x<3;x++){const v=y.y+Ol+x*Fl;e.beginPath(),e.moveTo(y.x+6,v),e.lineTo(y.x+6+I,v),e.stroke(),e.beginPath(),e.arc(y.x+6+I*(x/2),v,Bl,0,2*Math.PI),e.fill()}}const S=o.visibilityToolButton;S&&sd(e,S,s);const m=o.themeToggleButton;m&&Ja(e,m,a,s)}function hd(e,t){const{canvasUI:n,colors:i}=t;n.transformIcons.forEach(o=>{$o(e,o,i)})}function fd(e,t,n,i){const{canvasUI:o,colors:s,coordsDisplayMode:a,gridDisplayMode:r,angleDisplayMode:c,distanceDisplayMode:l,activeThemeName:d}=n;o.displayIcons.forEach(f=>{const h={x:f.x,y:f.y,width:f.width,height:f.height};switch(f.group){case"coords":td(e,h,a,a!==Lo,t,i,s);break;case"grid":nd(e,h,r,r!==$s,s);break;case"angles":Za(e,h,c,c!==Rs,t,i,s);break;case"distances":Qa(e,h,l,l===Ls,t,i,s);break;case"theme":Ja(e,h,d,s);break}})}function ud(e,t,n,i){const{dpr:o,isToolbarExpanded:s,isColorPaletteExpanded:a,isInterpolationPanelExpanded:r,isTransformPanelExpanded:c,isDisplayPanelExpanded:l,isVisibilityPanelExpanded:d,isPlacingTransform:f,placingTransformType:h,placingSnapPos:u,mousePos:p,colors:g}=n;if(e.save(),e.resetTransform(),e.scale(o,o),s)dd(e,t,n,i);else{const y=n.canvasUI.toolbarButton;e.strokeStyle=g.uiDefault,e.lineWidth=Fa,e.beginPath();for(let S=0;S<3;S++){const m=y.y+5+S*10;e.moveTo(y.x+4,m),e.lineTo(y.x+y.width-4,m)}e.stroke()}if(a&&od(e,t,n),r&&cd(e,t,n,i),c&&hd(e,n),l&&fd(e,t,n,i),d&&ld(e,t,n,i),f){const y=u||p;if(y){const S=Ko/2,m={type:h,x:y.x-S,y:y.y-S,width:Ko,height:Ko};$o(e,m,g)}}e.restore()}function _a(e,t,n,i,{showDistances:o,distanceSigFigs:s,colors:a,lastGridState:r,currentShiftPressed:c},l,d,f,h,u=null,p=null,g=null){!o||n.length===0||n.forEach(y=>{const S=i.find(m=>d(m)===y);if(S){let m=l(S.id1),I=l(S.id2);if(u){const x=u.find(A=>A.id===S.id1),v=u.find(A=>A.id===S.id2);x&&(m=x),v&&(I=v)}if(m&&I&&m.type==="regular"&&I.type==="regular"){let x;const v=u&&g;if(S.labelMode==="exact"&&S.exactValue){const[D,R]=Fn(S.exactValue.g2gSquaredSum);let N=S.exactValue.gridInterval*D;if(v&&g.transformType!==_t){const B=g.snappedScaleValue!==null?g.snappedScaleValue:g.scale;N*=B}x=Bn(parseFloat(N.toFixed(10)),R)}else x=Je(j(m,I),s);const A=f(m),T=f(I),E=(A.x+T.x)/2,M=(A.y+T.y)/2,w=Math.atan2(T.y-A.y,T.x-A.x);let b=w-Math.PI/2;Math.sin(b)>0&&(b+=Math.PI);const C=E+Math.cos(b)*mn,_=M+Math.sin(b)*mn;let P=w*(180/Math.PI);(P>90||P<-90)&&(P+=180),h({id:`selected-edge-dist-${y}`,content:x,x:C,y:_,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:Nt,options:{rotation:P}})}}})}function pd(e,t,n,i){e.save(),e.strokeStyle=i.mouseCoords,e.lineWidth=Pt,e.setLineDash(en);const o=Math.min(t.x,n.x),s=Math.min(t.y,n.y),a=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);e.strokeRect(o,s,a,r),e.restore()}function As(e,t,n,i,{lastGridState:o,showDistances:s,showAngles:a,distanceSigFigs:r,angleDisplayMode:c,angleSigFigs:l,currentShiftPressed:d,viewTransform:f,colors:h},u,p,g,y=!1,S=null,m=null,I=[],x=!1,v=[],A=null,T=new Map){const E=y?h.feedbackSnapped:`rgba(${h.feedbackDefault.join(",")}, 1.0)`,M=new Map(i.map(L=>[L.id,{...L}])),w=L=>M.get(L),b=w(n);if(!b)return;const C=p(b.id).map(w).filter(Boolean),_=u(b),P=o.alpha2>o.alpha1&&o.interval2?o.interval2:o.interval1,R=(T.get(n)||[]).find(L=>L.type==="projection"&&L.projectionLine);if(R){const[L,V]=R.projectionLine,F=u(L),O=u(V),H={x:O.x-F.x,y:O.y-F.y},U=Math.hypot(H.x,H.y);if(U>0){const $={x:H.x/U,y:H.y/U},Z=1e4,W={x:F.x-$.x*Z,y:F.y-$.y*Z},q={x:F.x+$.x*Z,y:F.y+$.y*Z};e.save(),e.strokeStyle=E,e.lineWidth=Pt,e.setLineDash(Ra),e.beginPath(),e.moveTo(W.x,W.y),e.lineTo(q.x,q.y),e.stroke(),e.restore()}}const N=(L,V)=>{if(!L||!V||V<=0)return!1;const F=V*1e-6,O=Math.abs(L.x/V-Math.round(L.x/V))<F,H=Math.abs(L.y/V-Math.round(L.y/V))<F;return O&&H},B=C.every(L=>I.includes(L.id)),k=v.find(L=>L.id===n);if(!A&&x&&d&&B&&k&&j(k,b)>ne){const L=u(k),V=_,F=Math.atan2(V.y-L.y,V.x-L.x),O=Math.atan2(b.y-k.y,b.x-k.x);if(s){let H;const U=P&&N(k,P),$=P&&N(b,P);if(U&&$){const De=b.x-k.x,hn=b.y-k.y,bt=Math.round(De/P),jt=Math.round(hn/P),fn=bt*bt+jt*jt;if(fn===0)H="0";else{const[Pn,wn]=Fn(fn),An=P*Pn,un=parseFloat(An.toFixed(10));H=Bn(un,wn)}}else{const De=r+2;H=Je(j(k,b),De)}const Z=(L.x+V.x)/2,W=(L.y+V.y)/2;let q;a&&Math.abs(O)>ne?-O<0?q=F-Math.PI/2:q=F+Math.PI/2:(q=F-Math.PI/2,Math.sin(q)>0&&(q+=Math.PI));const ye=Z+Math.cos(q)*mn,Ie=W+Math.sin(q)*mn;let Me=F*(180/Math.PI);(Me>90||Me<-90)&&(Me+=180),m({id:`drag-dist-vector-${b.id}`,content:H,x:ye,y:Ie,color:E,fontSize:Nt,options:{rotation:Me}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=E,e.lineWidth=Pt,e.beginPath(),e.moveTo(L.x,L.y),e.lineTo(V.x,V.y),e.stroke(),e.restore(),a&&Math.abs(F)>ne){Yi(e,L,0,O,gs,E);let H;if(c===Xn?H=`${Je(O*(180/Math.PI),l)}^{\\circ}`:H=Je(O,l),H){const U=-O/2,$=go,Z={x:$*Math.cos(U),y:$*Math.sin(U)},W={x:L.x+Z.x,y:L.y+Z.y};let q=U*(180/Math.PI);(q>90||q<-90)&&(q+=180),m({id:`drag-angle-vector-${b.id}`,content:H,x:W.x,y:W.y,color:E,fontSize:Nt,options:{rotation:q}},t)}}}if(s&&C.forEach(L=>{const V=I.includes(L.id);if(!x||!V){const F=b,O=L,H=g({id1:F.id,id2:O.id});let U;if(P&&N(F,P)&&N(O,P)){const jt=F.x-O.x,fn=F.y-O.y,Pn=Math.round(jt/P),wn=Math.round(fn/P),An=Pn*Pn+wn*wn;if(An===0)U="0";else{const[un,Ar]=Fn(An),_r=P*un,Dr=parseFloat(_r.toFixed(10));U=Bn(Dr,Ar)}}else{const jt=j(F,O);U=Je(jt,r)}const Z=u(F),W=u(O),q=(Z.x+W.x)/2,ye=(Z.y+W.y)/2,Ie=Math.atan2(W.y-Z.y,W.x-Z.x);let Me=Ie-Math.PI/2;Math.sin(Me)>0&&(Me+=Math.PI);const De=q+Math.cos(Me)*mn,hn=ye+Math.sin(Me)*mn;let bt=Ie*(180/Math.PI);(bt>90||bt<-90)&&(bt+=180),m({id:`drag-dist-${H}`,content:U,x:De,y:hn,color:E,fontSize:Nt,options:{rotation:bt}})}}),a&&C.length>=2&&(!x||C.some(L=>!I.includes(L.id)))){const L=[...C].sort((V,F)=>{const O=Math.atan2(V.y-b.y,V.x-b.x),H=Math.atan2(F.y-b.y,F.x-b.x);return O-H});for(let V=0;V<L.length;V++){const F=L[V],O=L[(V+1)%L.length],H=I.includes(F.id),U=I.includes(O.id);if(!(!x||!H||!U))continue;const Z={x:F.x-b.x,y:F.y-b.y},W={x:O.x-b.x,y:O.y-b.y},q=Math.atan2(Z.y,Z.x),ye=Math.atan2(W.y,W.x);let Ie=ye-q;if(Ie<0&&(Ie+=2*Math.PI),Ie<ne)continue;const Me=q+Ie/2;e.save(),e.strokeStyle=E,e.lineWidth=Pt,e.beginPath(),e.arc(_.x,_.y,gs,-q,-ye,!1),e.stroke(),e.restore();let De;if(c===Xn?De=`${Je(Ie*(180/Math.PI),l)}^{\\circ}`:c===Vs&&(d?(De=Et(Ie/Math.PI,.015,32)+"\\pi",De.startsWith("1\\pi")&&(De="\\pi"),De.startsWith("-1\\pi")&&(De="-\\pi"),De==="0\\pi"&&(De="0")):De=Je(Ie,l)),De){const hn=`drag-angle-${b.id}-${F.id}-${O.id}`,bt={x:b.x+Math.cos(Me),y:b.y+Math.sin(Me)},jt=u(bt),fn=Math.atan2(jt.y-_.y,jt.x-_.x),Pn=go,wn={x:Pn*Math.cos(fn),y:Pn*Math.sin(fn)},An={x:_.x+wn.x,y:_.y+wn.y};let un=fn*(180/Math.PI);(un>90||un<-90)&&(un+=180),m({id:hn,content:De,x:An.x,y:An.y,color:E,fontSize:Nt,options:{rotation:un}},t)}}}}function gd(e,t,n,i,{showAngles:o,angleSigFigs:s,angleDisplayMode:a,currentShiftPressed:r,distanceSigFigs:c,viewTransform:l,lastGridState:d,colors:f},h,u,p,g,y){!o||n.length===0||n.forEach(S=>{const m=i.find(I=>u(I)===S);if(m){const I=h(m.id1),x=h(m.id2);if(I&&x&&I.type==="regular"&&x.type==="regular"){const v={lastGridState:d,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:s,currentShiftPressed:r,viewTransform:l,colors:f};As(e,t,I.id,[I,x],v,p,g,u,!1,null,y),As(e,t,x.id,[I,x],v,p,g,u,!1,null,y)}}})}function nr(e,{allFaces:t,selectedFaceIds:n,colors:i,isDragConfirmed:o,dragPreviewVertices:s,initialDragVertexStates:a,transformIndicatorData:r,highlightedEdgeForSnap:c,draggedFaceId:l,coordSystemSnapAngle:d,coordSystemSnapType:f,coordSystemSnapScale:h,initialCoordSystemStates:u},p,g){if(n.length>zl)return;const y=new Set(n);y.size!==0&&y.forEach(S=>{const m=t.find(x=>x.id===S);if(!m||!m.localCoordSystem)return;let I=m.localCoordSystem;if(o&&m.vertexIds.some(x=>s.some(v=>v.id===x))){const x=u.get(m.id);I=Ac(m,{initialSystem:x,dragPreviewVertices:s,initialDragVertexStates:a,findVertexById:g,transformIndicatorData:r})}if(l===S&&d!==null){const x=A=>{if(o&&s){const T=s.find(E=>E&&E.id===A);if(T)return T}return g(A)},v=p(I.origin);if(f==="edge"&&c!==null){const A=m.vertexIds.map(T=>x(T)).filter(T=>T&&T.type==="regular");if(c<A.length){const T=A[c],E=A[(c+1)%A.length],M=p(T),w=p(E);e.save(),e.strokeStyle=i.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(M.x,M.y),e.lineTo(w.x,w.y),e.stroke(),e.restore()}}else if(f==="cardinal"){const T=v.x+Math.cos(-d)*100,E=v.y+Math.sin(-d)*100,M=v.x-Math.cos(-d)*100,w=v.y-Math.sin(-d)*100;e.save(),e.strokeStyle=i.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(M,w),e.lineTo(T,E),e.stroke(),e.restore()}}yd(e,I,i,p,h)})}function yd(e,t,n,i,o=null){const s=i(t.origin),a=Gt({x:1,y:0},t),r=Gt({x:0,y:1},t),c=i(a),l=i(r);e.save(),e.lineWidth=In,e.lineCap="round";const d=(u,p,g,y)=>{e.strokeStyle=g,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(p.x,p.y),e.stroke(),e.fillStyle=y;const S=Math.atan2(p.y-u.y,p.x-u.x);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(p.x-Te*Math.cos(S-Tt),p.y-Te*Math.sin(S-Tt)),e.lineTo(p.x-Te*Math.cos(S+Tt),p.y-Te*Math.sin(S+Tt)),e.closePath(),e.fill()},f=o!==null?n.feedbackSnapped:n.coordSysX,h=o!==null?n.feedbackSnapped:n.coordSysY;d(s,c,f,f),d(s,l,h,h),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(s.x,s.y,El,0,2*Math.PI),e.fill(),e.restore()}const de=document.getElementById("drawingCanvas"),xe=de.getContext("2d",{willReadFrequently:!0}),Ze=document.getElementById("html-overlay"),Re=window.devicePixelRatio||1,Os=new Map,Xi=18,Qs=8,ni={x:12,y:-12},md={x:8,y:-8};let Nn={activeId:null,inputEl:null};const vo={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0},sr="platonic-play",or=1,si=`${sr}.user-id`;let Dt=null,eo=null,Sd=!1,gn,os,nn=[JSON.parse(JSON.stringify(vo))],Vo=vo.id;const z={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[]};let st,is=null,as=null,gt=null,gi=[],bo=null,zn=new Map,Xt=null,Qt=null,ms=null,Ys=null,Wn=null,Kt=null,ls=!1,Rt=null,ve=[],yt=null,vn=null,nt=null,ln=null,Fs=!1,Xs=null,Ht=!1,Hi=!1,Lt=!1,Un="regular",je="lines",Ot="degrees",ao="on",Co=!0,Mo=!0,cn=!0,zt=null,sn=null,Wt=null,To=!1,cs=!1,oe=[],X=[],J=[],Ye=[],jn=new Map,ot=new Map,le=[],re=[],se=[],ue=[],Le=null,K={x:0,y:0},bn=null,On=!1,et=!1,Eo=!1,_s=null,Jt=!1,vt=!1,Ss=null,ze=[],Ct=0,pn=!0,qt=!0,Ge=null,ro=4,_n=3,Id=.5,Ne=null,It=!1,Pe=!1,$n=!1,Cn=!1,Ut=-1,Mt={x:0,y:0},oi={x:0,y:0},ie=[],ir={x:0,y:0},Q=null,ce=wi,Xe=!1,Ke=null,Po=null,ge=[],rs=[],yi=[],Ee=!1,ht={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},ae={targetId:null,type:null,count:0,timestamp:0},to={id:null,timestamp:0},lt=[],ut=!1,Vt=null;function xd(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,i=Array.prototype.splice;lt.pop=function(){return e.call(this)},lt.push=function(...o){return t.call(this,...o)},lt.shift=function(){return n.call(this)},lt.splice=function(...o){return i.call(this,...o)}}let mi=!1,ds=[],we=null,me=[],mt="",xt=null,qn=[],lo=0,G={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},te={scale:Ml,offsetX:0,offsetY:0},Bt={angle1:30,angle2:15,alpha1:1,alpha2:0},Gi=new Set,wo="dark",Oe=[],Vn=!1,ft=null,fe={[ke]:0,[qe]:1,[Fe]:2,[pt]:0},Mn=!1,$t=null,Ao=null,hs=new Set,Dn=!1;function Jn(){mc(J,Y)}function zi(){return pc(wo,Zr)}function Ce(e,t=0,n=1){let i=fe[e];(i<0||i>=ce.length)&&(i=0);const o=ce[i];if(o?.type==="color")return o.value;if(o?.type==="colormap"){const a=n>1?t/(n-1):.5;return He(o,a)}const s=zi();return e===ke?s.vertex:e===qe?s.edge:e===Fe?s.face:e===pt?s.uiTextDefault||s.geometryInfoText:s.vertex}function Wi(){Oe.forEach(e=>{const t=fe[e];if(e===ke){const n=ce[t];if(n&&n.type==="colormap"){const i=le.map(o=>Y(o)).filter(o=>o&&o.type==="regular");i.forEach((o,s)=>{const a=i.length>1?s/(i.length-1):.5;o.color=He(n,a)})}else le.forEach(i=>{const o=Y(i);o&&o.type==="regular"&&(o.color=Ce(ke))})}else if(e===qe){const n=ce[t];if(n&&n.type==="colormap")re.forEach((i,o)=>{const s=X.find(a=>ee(a)===i);if(s){const a=re.length,r=a>1?o/a:0,c=a>1?(o+1)/a:1;s.gradientStart=r,s.gradientEnd=c,s.colormapItem=n,delete s.color}});else{const i=Ce(qe);X.forEach(o=>{re.includes(ee(o))&&(o.color=i,delete o.gradientStart,delete o.gradientEnd,delete o.colormapItem)})}}else if(e===Fe){const n=fe[e];if(n===-1){const i=Ce(Fe);J.forEach(o=>{se.includes(he(o))&&(o.color=i,delete o.colormapItem,delete o.colormapDistribution)})}else{const i=ce[n];if(i&&i.type==="colormap")J.forEach(o=>{se.includes(he(o))&&(o.colormapItem=i,o.colormapDistribution="x",delete o.color)});else{const o=Ce(Fe);J.forEach(s=>{se.includes(he(s))&&(s.color=o,delete s.colormapItem,delete s.colormapDistribution)})}}}else if(e===pt){const n=ce[t];if(n&&n.type==="colormap")ue.forEach((i,o)=>{const s=Bs(i);if(!s)return;const a=ue.length>1?o/(ue.length-1):.5;s.color=He(n,a)});else{const i=Ce(pt);ue.forEach(o=>{const s=Bs(o);s&&(s.color=i)})}}})}function at({id:e,content:t,x:n,y:i,color:o,fontSize:s,options:a={}}){Gi.add(e);let r=Os.get(e);if(r){if(!r.contentEl||!r.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.textContent="",r.appendChild(u),r.contentEl=u,r.katexEl=p,r.katexContent=null,r.style.pointerEvents="none"}}else{r=document.createElement("div"),r.style.position="absolute",r.style.fontFamily="KaTeX_Main, Times New Roman, serif",r.style.whiteSpace="nowrap",r.style.lineHeight="1",r.style.display="inline-block",r.style.padding="0",r.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.appendChild(u),r.contentEl=u,r.katexEl=p,Ze.appendChild(r),Os.set(e,r)}let c="-50%",l="-50%",d="center";switch(a.textAlign){case"left":c="0%";break;case"right":c="-100%";break}switch(a.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}a.textAlign==="left"&&a.textBaseline==="top"?d="top left":a.textAlign==="right"&&a.textBaseline==="top"?d="top right":a.textAlign==="left"&&a.textBaseline==="bottom"?d="bottom left":a.textAlign==="right"&&a.textBaseline==="bottom"&&(d="bottom right"),r.style.left=`${n}px`,r.style.top=`${i}px`,r.style.transformOrigin=d,r.style.transform=`translate(${c}, ${l}) rotate(${a.rotation||0}deg)`,r.style.color=o,r.style.fontSize=`${s}px`;const f=t==null?"":String(t),h=Jr(f);if(r.katexContent!==h){const u=r.katexEl||r.contentEl||r;Kr(u,h),r.katexContent=h}}function vd(e,t,n){const i=Ns(e),o=Ns(t),s=Math.max(0,Math.min(1,n)),a=Math.round(i.r*(1-s)+o.r*s),r=Math.round(i.g*(1-s)+o.g*s),c=Math.round(i.b*(1-s)+o.b*s),l=i.a;return`rgba(${a}, ${r}, ${c}, ${l})`}function bd(){for(const[e,t]of Os.entries())Gi.has(e)||(t.remove(),Os.delete(e))}function fs(e){return{x:e.x*Re/te.scale,y:-e.y*Re/te.scale}}function Bs(e){return Ye.find(t=>t.id===e)}function Ui(e,t,n,i=null){if(!e||!t||!n)return null;const o={x:n.x-t.x,y:n.y-t.y},s=Math.hypot(o.x,o.y);if(s<1e-6)return null;let a={x:-o.y/s,y:o.x/s};if(i&&i.length>=3){const r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},c=i.reduce((f,h)=>({x:f.x+h.x,y:f.y+h.y}),{x:0,y:0});c.x/=i.length,c.y/=i.length;const l={x:c.x-r.x,y:c.y-r.y};a.x*l.x+a.y*l.y>0&&(a={x:-a.x,y:-a.y})}return{normalData:a,edgeLen:s}}function ar(e){const t=X.find(l=>ee(l)===e);if(!t)return fs(Qs);const n=Y(t.id1),i=Y(t.id2);if(!n||!i)return fs(Qs);const o=J.filter(l=>{const d=l.vertexIds||[];for(let f=0;f<d.length;f++){const h=d[f],u=d[(f+1)%d.length];if(h===t.id1&&u===t.id2||h===t.id2&&u===t.id1)return!0}return!1});let s=null;o.length===1&&(s=(o[0].vertexIds||[]).map(d=>Y(d)).filter(Boolean));const a=Ui(t,n,i,s);if(!a)return fs(Qs);const r=a.normalData,c=Qs*Re/te.scale;return{x:r.x*c,y:r.y*c}}function Si(e,t){const n=X.find(l=>ee(l)===e);if(!n||!t)return null;const i=Y(n.id1),o=Y(n.id2);if(!i||!o)return null;const s=Ui(n,i,o);if(!s)return null;const{normalData:a,edgeLen:r}=s;return r<1e-6?null:(t.x*a.x+t.y*a.y)/r}function Ii(e){const t=Y(e);if(!t)return{offset:fs(ni),align:"left",baseline:"middle"};const i=Yt(e,X).map(h=>Y(h)).filter(Boolean);let o={x:1,y:0};if(i.length===2){const h={x:i[0].x-t.x,y:i[0].y-t.y},u={x:i[1].x-t.x,y:i[1].y-t.y},p=Math.hypot(h.x,h.y),g=Math.hypot(u.x,u.y);if(p>1e-6&&g>1e-6){const y={x:h.x/p,y:h.y/p},S={x:u.x/g,y:u.y/g},m={x:y.x+S.x,y:y.y+S.y},I=Math.hypot(m.x,m.y);I>1e-6?o={x:-m.x/I,y:-m.y/I}:o={x:-y.y,y:y.x}}}const s=pe(t),a=pe({x:t.x+o.x,y:t.y+o.y});let r={x:a.x-s.x,y:a.y-s.y};const c=Math.hypot(r.x,r.y);c>1e-6?(r.x/=c,r.y/=c):r={x:1,y:0};const l=Math.hypot(ni.x,ni.y),d={x:r.x*l,y:r.y*l},f=r.x>=0?"left":"right";return{offset:fs(d),align:f,baseline:"middle"}}function Cd(e){return nn.find(t=>t.id===e)||null}function rr(e){e&&(Vo=e,Ms())}function lr(e){if(!e)return null;const t=new Map;Pe&&Array.isArray(ge)&&ge.length>0&&ge.forEach(i=>{if(!i||!i.id)return;const o=i.originalId||i.id;t.set(o,i)});const n=i=>t.has(i)?t.get(i):Y(i);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const i=n(e.anchorId);return i?{anchor:{x:i.x,y:i.y}}:null}if(e.anchorType==="edge"){const i=X.find(g=>ee(g)===e.anchorId);if(!i)return null;const o=n(i.id1),s=n(i.id2);if(!o||!s)return null;const a={x:(o.x+s.x)/2,y:(o.y+s.y)/2},r=Math.atan2(s.y-o.y,s.x-o.x),c=pe(o),l=pe(s),d=Math.atan2(l.y-c.y,l.x-c.x),f=J.filter(g=>{const y=g.vertexIds||[];for(let S=0;S<y.length;S++){const m=y[S],I=y[(S+1)%y.length];if(m===i.id1&&I===i.id2||m===i.id2&&I===i.id1)return!0}return!1});let h=null;f.length===1&&(h=(f[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=Ui(i,o,s,h),p=u?u.normalData:null;return{anchor:a,edgeAngleRad:r,edgeAngleRadScreen:d,edgeNormalData:p,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const i=J.find(a=>he(a)===e.anchorId);if(!i)return null;const o=i.vertexIds.map(a=>n(a)).filter(a=>a&&a.type==="regular");return o.length<3?null:{anchor:{x:o.reduce((a,r)=>a+r.x,0)/o.length,y:o.reduce((a,r)=>a+r.y,0)/o.length}}}return null}function cr(){return Q?.finalSnapResult?.finalDelta?Q.finalSnapResult.finalDelta:Q?.textFinalDelta?Q.textFinalDelta:ge.length>0&&ie.length>0?{x:ge[0].x-ie[0].x,y:ge[0].y-ie[0].y}:null}function dr(e){const t=lr(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=ar(e.anchorId);const l=Si(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let i={x:t.anchor.x+n.x,y:t.anchor.y+n.y},o=e.rotationDeg||0,s=e.scale||1,a="center",r="middle";if(e.anchorType==="vertex"){const l=Ii(e.anchorId);a=e.vertexAlign||l.align||"left",r=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(a="center",r="middle",typeof t.edgeAngleRadScreen=="number"?o+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(o+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(a="left",r="top");e.anchorType==="edge"&&(o>90||o<-90)&&(o+=180,o>180&&(o-=360),r="top");const c=ue.includes(e.id);if(Pe&&c)if(Ne){const{center:l,rotation:d,scale:f,directionalScale:h,startVector:u}=Ne;i=Be(i,l,d,f,h,u),o-=d*(180/Math.PI),s*=f}else{const l=cr();l&&(i={x:i.x+l.x,y:i.y+l.y})}return{id:e.id,content:e.content||"",position:i,rotationDeg:o,scale:s,textAlign:a,textBaseline:r}}function Md(e){const t=Ze.getBoundingClientRect(),n=[];Ye.forEach(i=>{const o=dr(i);if(!o){n.push(i.id);return}const s=pe(o.position),a=`text-${o.id}`,r=ue.includes(i.id),c=i.color||Ce(pt)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",d=vd(c,l,.35);at({id:a,content:o.content,x:s.x,y:s.y,color:r?d:c,fontSize:(i.fontSize||Xi)*o.scale,options:{textAlign:o.textAlign,textBaseline:o.textBaseline,rotation:o.rotationDeg}});const f=Os.get(a);if(f){const h=f.contentEl||f;h.style.outline="none",h.style.textShadow="none",h.style.color=r?d:c;const p=(f.katexEl||h).getBoundingClientRect();i.screenBounds={left:p.left-t.left,top:p.top-t.top,right:p.right-t.left,bottom:p.bottom-t.top}}}),n.length>0&&(Ye=Ye.filter(i=>!n.includes(i.id)),ue=ue.filter(i=>!n.includes(i)))}function hr(e){for(let t=Ye.length-1;t>=0;t--){const n=Ye[t],i=n.screenBounds;if(i&&e.x>=i.left&&e.x<=i.right&&e.y>=i.top&&e.y<=i.bottom)return n}return null}function fr(e,t=""){if(!Nn.inputEl){const s=document.createElement("input");s.type="text",s.style.position="absolute",s.style.zIndex="5",s.style.pointerEvents="auto",s.style.fontFamily="KaTeX_Main, Times New Roman, serif",s.style.fontSize=`${e.fontSize||Xi}px`,s.style.border="1px solid rgba(255, 255, 255, 0.4)",s.style.borderRadius="4px",s.style.padding="2px 4px",s.style.background="rgba(0, 0, 0, 0.6)",s.style.color="#ffffff",s.style.outline="none",s.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),no(!0)):a.key==="Escape"&&(a.preventDefault(),no(!1))}),s.addEventListener("mouseleave",()=>no(!0)),s.addEventListener("blur",()=>no(!0)),Ze.appendChild(s),Nn.inputEl=s}const n=dr(e);if(!n)return;const i=pe(n.position),o=Nn.inputEl;o.value=t||e.content||"",o.style.left=`${i.x}px`,o.style.top=`${i.y}px`,o.style.transform="translate(-10%, -10%)",o.style.display="block",Nn.activeId=e.id,o.focus(),o.setSelectionRange(o.value.length,o.value.length)}function no(e){const t=Nn.inputEl;if(!t)return;const n=Nn.activeId;if(n&&e){const i=Bs(n);if(i){$e();const o=t.value.trim();!o&&i.isDraft?(Ye=Ye.filter(s=>s.id!==i.id),ue=ue.filter(s=>s!==i.id)):(i.content=o||i.content||"",delete i.isDraft)}}t.style.display="none",Nn.activeId=null}function Td(e=""){let t="canvas",n=null,i={x:0,y:0},o=be(K);if(zt)t="vertex",n=zt,i=Ii(n).offset;else if(sn)t="edge",n=sn,i=ar(n);else if(Wt)t="face",n=Wt;else{const a=fs(md);o={x:o.x+a.x,y:o.y+a.y}}const s={id:wt(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?o:null,offset:t==="canvas"?{x:0,y:0}:i,rotationDeg:0,scale:1,fontSize:Xi,color:Ce(pt),isDraft:!0};if(t==="vertex"){const a=Ii(n);s.vertexAlign=a.align,s.vertexBaseline=a.baseline}Ye.push(s),ue=[s.id],fr(s,e)}function ji(e,t,n){if(n){const i=me.indexOf(e);if(i>-1){me.splice(i,1),Le===e&&(Le=me.length>0?me[me.length-1]:null);return}me.push(e),Le=e;return}me.includes(e)||me.push(e),Le=e}function co(e){const t=xn(e,je,G.interval1,Bt,!0);if(oe.forEach(i=>{i.type==="regular"&&t.push({x:i.x,y:i.y,isGridVertex:!1})}),X.forEach(i=>{const o=Y(i.id1),s=Y(i.id2);if(o&&s&&o.type==="regular"&&s.type==="regular"){const a={x:(o.x+s.x)/2,y:(o.y+s.y)/2,isGridVertex:!1};t.push(a)}}),t.length===0)return null;const n=(i,o)=>(i.x-o.x)**2+(i.y-o.y)**2;return t.reduce((i,o)=>{const s=n(e,i);return n(e,o)<s?o:i})}function At(){const e=new Set(oe.map(a=>a.id)),t=new Set,n=[];for(const a of e)if(!t.has(a)){const r=zs(a),c=new Set(r);n.push(c),r.forEach(l=>t.add(l))}const i=a=>[...a].sort().join(","),o=[],s=new Set;gi.forEach(a=>{const r=i(a);for(let c=0;c<n.length;c++){if(s.has(c))continue;const l=n[c];if(r===i(l)){o.push(l),s.add(c);break}}});for(let a=0;a<n.length;a++)s.has(a)||o.push(n[a]);gi=o}function Ed(e,t,n=!1,i=[],o=1){if(n&&i.length>0&&[...e].some(l=>i.some(d=>d.id===l)))return;const s=J.filter(c=>c.vertexIds.every(l=>e.has(l)));wc(xe,{allFaces:s,facesVisible:cn,isDragConfirmed:!1,dragPreviewVertices:[],transformIndicatorData:null,initialDragVertexStates:[],colors:t,initialCoordSystemStates:new Map},pe,Y);const a=X.filter(c=>e.has(c.id1)&&e.has(c.id2));Vc(xe,{allEdges:a,selectedEdgeIds:re,hoveredEdgeId:sn,isDragConfirmed:!1,dragPreviewVertices:[],colors:t,edgesVisible:Mo,snappedEdgeIds:jn,currentAltPressed:ut},pe,Y,ee),oe.filter(c=>e.has(c.id)).forEach(c=>{let l=!1;ot.has(c.id)&&ot.get(c.id).some(f=>f.copyIndex===void 0)&&(l=!0),Io(xe,c,{selectedVertexIds:le,selectedCenterIds:me,activeCenterId:Le,colors:t,verticesVisible:Co,isHovered:zt===c.id,isSnapped:l,snappedVertexIds:ot,isDragConfirmed:!1,dragPreviewVertices:[],currentAltPressed:ut},pe)})}function Hs(e,t,n,i=!1,o=null){const s=be(t),a=o||Zi(e.id),r=Ci/te.scale,c=Ti/te.scale,l=G?.alpha2>=G?.alpha1&&G?.interval2?G.interval2:G?.interval1,d=_e*2/te.scale,f=_e/te.scale,h=_e*2/te.scale,u=_e*2/te.scale,p=Xe&&ve.length>=1;if(n){const g=[];let y=!1;for(const I of oe)if(I.id!==e.id&&I.type==="regular"&&j(s,I)<r){y=!0;break}if(!y)for(const I of X){const x=Y(I.id1),v=Y(I.id2);if(x&&v&&x.type==="regular"&&v.type==="regular"&&St(s,x,v).distance<c){y=!0;break}}if(p){if(oe.forEach(b=>{if(b.id!==e.id&&b.type==="regular"){const C=j(s,b);g.push({priority:1,dist:C,pos:b,snapType:"vertex",targetVertex:b})}}),X.forEach(b=>{const C=Y(b.id1),_=Y(b.id2);C&&_&&C.type==="regular"&&_.type==="regular"&&C.id!==e.id&&_.id!==e.id&&St(s,C,_).distance<f*1.5&&ka.forEach(D=>{const R={x:C.x+D*(_.x-C.x),y:C.y+D*(_.y-C.y)},N=j(s,R);g.push({priority:2,dist:N,pos:R,snapType:"edge_fraction",targetEdge:b,fraction:D})})}),je!=="none"&&l){const b=G?.alpha2>=G?.alpha1&&G?.interval2?G.interval2:G.interval1;b&&xn(s,je,b,Bt,!0).forEach(_=>{const P=j(s,_);g.push({priority:3,dist:P,pos:_,snapType:"grid"})})}const I=a.currentSegmentReferenceA_for_display,x=a.currentSegmentReferenceD,v=new Set([0,...Di.flatMap(b=>[b,-b])]),T=Array.from(v).sort((b,C)=>b-C).map(b=>({factor:b,angle:Zt(a.offsetAngleRad+b*I),turn:Ue(b*I)})),E=j(e,s),M=[];if([0,...Sn].forEach(b=>M.push({factor:b,dist:b*x})),x>ne){const b=E/x,C=Math.round(b),_=Math.round(b*2)/2;[C,_].forEach(P=>{P>=0&&!M.some(D=>Math.abs(D.factor-P)<ne)&&M.push({factor:P,dist:P*x})})}if(M.sort((b,C)=>b.dist-C.dist),T.length>0&&M.length>0)for(const b of T)for(const C of M){if(C.dist<ne&&(b.factor!==0||M.length>1))continue;const _={x:e.x+C.dist*Math.cos(b.angle),y:e.y+C.dist*Math.sin(b.angle)},P=j(s,_);g.push({priority:4,dist:P,pos:_,snapType:"geometric",lengthSnapFactor:C.factor,angleSnapFactor:b.factor,angleTurn:b.turn})}}else if(!y&&je!=="none"&&l){const I=G?.alpha2>=G?.alpha1&&G?.interval2?G.interval2:G.interval1;if(I){const x=xn(s,je,I,Bt,!0);if(x.length>0){const v=x.sort((A,T)=>j(s,A)-j(s,T))[0];g.push({priority:3,dist:j(s,v),pos:v,snapType:"grid"})}}}let S=null;if(g.length>0)if(!p)S=g[0];else{let I=!1;for(let x=1;x<=3;x++){let v;x===1?v=d:x===2?v=f:v=h;const A=g.filter(T=>T.priority===x&&T.dist<v);if(A.length>0){S=A.sort((T,E)=>T.dist-E.dist)[0],I=!0;break}}if(!I){const x=g.filter(v=>v.priority===4);if(x.length>0){const v=x.sort((A,T)=>A.dist-T.dist)[0];v.dist<u&&(S=v)}}S||(S=g.sort((x,v)=>x.dist-v.dist)[0])}if(S){const I=Math.atan2(S.pos.y-e.y,S.pos.x-e.x)||0,x=parseFloat(j(e,S.pos).toFixed(10));let v=null,A=null;if(S.snapType==="grid"&&l){const E=G?.alpha2>=G?.alpha1&&G?.interval2?G.interval2:G.interval1;if(E){const M=S.pos.x-e.x,w=S.pos.y-e.y,b=E*1e-5;if(je==="triangular"){const C=E*Mi,_=w/C,P=Math.round(_),D=P%2!==0?E/2:0,R=(M-D)/E;if(Math.abs(_-P)<b/C&&Math.abs(R-Math.round(R))<b/E){const N=P,B=Math.round(R);v=B*B+B*N+N*N,A=E}}else{const C=M/E,_=w/E;if(Math.abs(C-Math.round(C))<b/E&&Math.abs(_-Math.round(_))<b/E){const P=Math.round(C),D=Math.round(_);v=P*P+D*D,A=E}}}}let T=S.angleTurn!=null?S.angleTurn:Ue(I-a.offsetAngleRad);return{x:parseFloat(S.pos.x.toFixed(fa)),y:parseFloat(S.pos.y.toFixed(fa)),angle:I*(180/Math.PI),distance:x,snapped:!0,snapType:S.snapType,targetEdge:S.targetEdge,fraction:S.fraction,targetVertex:S.targetVertex,gridSnapped:S.snapType==="grid",lengthSnapFactor:S.lengthSnapFactor||null,angleSnapFactor:S.angleSnapFactor||null,angleTurn:T,gridToGridSquaredSum:v,gridInterval:A}}const m=Math.atan2(s.y-e.y,s.x-e.x)||0;return{x:s.x,y:s.y,angle:m*(180/Math.PI),distance:j(e,s),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:Ue(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const g=[];for(const m of oe)if(m.id!==e.id&&m.type==="regular"){const I=j(s,m);I<r&&g.push({priority:1,dist:I,pos:m,snapType:"vertex",targetVertex:m})}for(const m of X){const I=Y(m.id1),x=Y(m.id2);if(I&&x&&I.type==="regular"&&x.type==="regular"){const v=St(s,I,x);v.distance<c&&v.onSegmentStrict&&g.push({priority:2,dist:v.distance,pos:{x:v.x,y:v.y},snapType:"edge",targetEdge:m})}}let y=null;if(g.length>0){y=g.sort((I,x)=>I.priority!==x.priority?I.priority-x.priority:I.dist-x.dist)[0];const m=y.priority===1?d:f;y.dist>m&&(y=null)}if(y){const m=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:m*(180/Math.PI),distance:j(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:Ue(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const S=Math.atan2(s.y-e.y,s.x-e.x)||0;return{x:s.x,y:s.y,angle:S*(180/Math.PI),distance:j(e,s),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:Ue(S-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function Pd(e,t,n){const i=[],o=Ci/te.scale,s=Ti/te.scale;if(oe.forEach(a=>{if(a.id!==e.id&&a.type==="regular"){const r=j(t,a);r<o&&i.push({priority:1,dist:r,pos:a,snapType:"vertex",targetVertex:a})}}),X.forEach(a=>{if(a.id1===e.id||a.id2===e.id)return;const r=Y(a.id1),c=Y(a.id2);if(r&&c&&r.type==="regular"&&c.type==="regular"){const l=St(t,r,c);l.distance<s&&l.onSegmentStrict&&i.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:a})}}),i.length>0){const a=i.sort((r,c)=>r.priority!==c.priority?r.priority-c.priority:r.dist-c.dist)[0];return{pos:a.pos,snapped:!0,snapType:a.snapType,targetEdge:a.targetEdge,targetVertex:a.targetVertex}}return{pos:t,snapped:!1}}function wd(){ce=ce.map(e=>e.type==="color"?{...e,value:fc(e.value)}:e)}function Ad(){z.toolbarButton={id:"toolbar-button",x:rt,y:rt,width:Al,height:_l,type:"menuButton"}}function ur(){const e=de.height/Re;z.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:Qe,height:e,type:"toolbar"};const t=rt;let n=z.toolbarButton.y+z.toolbarButton.height+Dl;z.colorToolButton={id:"color-tool-button",type:"toolButton",x:rt,y:n,width:Qe-2*rt,height:kt},n+=kt+t,z.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:rt,y:n,width:Qe-2*rt,height:kt},n+=kt+t,z.transformToolButton={id:"transform-tool-button",type:"toolButton",x:rt,y:n,width:Qe-2*rt,height:kt},n+=kt+t,z.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:rt,y:n,width:Qe-2*rt,height:kt}}function tt(){z.colorSwatches=[],z.colorTargetIcons=[];const e=us+Ro,t=Qe+rt,n=z.colorToolButton.y+kt/2,i=wl,s=n-i/2+-2;let a=t;z.removeColorButton={id:"remove-color-button",type:"button",x:a+(e-i)/2,y:s,width:i,height:i},a+=e,ce.forEach((c,l)=>{z.colorSwatches.push({id:`swatch-${l}`,type:"colorSwatch",x:a+(e-i)/2,y:s,width:i,height:i,index:l,item:c}),a+=e}),z.addColorButton={id:"add-color-button",type:"button",x:a+(e-i)/2,y:s,width:i,height:i},Object.entries(fe).forEach(([c,l])=>{const d=i*.75,f=z.colorSwatches.find(h=>h.index===l);f&&z.colorTargetIcons.push({id:`target-icon-${c}`,type:"colorTargetIcon",target:c,x:f.x+(f.width-d)/2,y:f.y-d-5,width:d,height:d})});const r=[...z.colorSwatches,z.removeColorButton,z.addColorButton,...z.colorTargetIcons].filter(Boolean);if(r.length>0){const c=Math.min(...r.map(h=>h.y)),l=Math.max(...r.map(h=>h.x+h.width)),d=Math.max(...r.map(h=>h.y+h.height)),f=5;z.colorPaletteBounds={x:Qe,y:c-f,width:l-Qe+f,height:d-c+f*2}}else z.colorPaletteBounds=null}function pr(){if(z.interpolationIcons=[],!z.interpolationToolButton)return;const e=Qe+rt,t=z.interpolationToolButton.y+kt/2,n=us,o=t-n/2+-2,s=us+Ro;let a=e;nn.forEach(c=>{z.interpolationIcons.push({id:`interpolation-${c.id}`,type:"interpolationStyle",styleId:c.id,x:a+(s-n)/2,y:o,width:n,height:n}),a+=s}),z.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:a+(s-n)/2,y:o,width:n,height:n});const r=z.interpolationIcons.filter(Boolean);if(r.length>0){const c=Math.min(...r.map(h=>h.y)),l=Math.max(...r.map(h=>h.x+h.width)),d=Math.max(...r.map(h=>h.y+h.height)),f=5;z.interpolationPanelBounds={x:Qe,y:c-f,width:l-Qe+f,height:d-c+f*2}}else z.interpolationPanelBounds=null}function _d(){if(z.displayIcons=[],!z.visibilityToolButton)return;const e=us+Ro,t=Qe+rt,n=z.visibilityToolButton.y+kt/2,i=Ll,s=n-i/2+-2;let a=t;if(["coords","grid","angles","distances","theme"].forEach(c=>{z.displayIcons.push({id:`display-icon-${c}`,group:c,x:a+(e-i)/2,y:s,width:i,height:i}),a+=e}),z.displayIcons.length>0){const c=z.displayIcons[0],l=z.displayIcons[z.displayIcons.length-1],d=5;z.displayPanelBounds={x:Qe,y:c.y-d,width:l.x+l.width-Qe+d,height:c.height+d*2}}else z.displayPanelBounds=null}function Dd(){z.transformIcons=[];const e=us,t=e+Ro,n=Qe+rt,o=z.transformToolButton.y+kt/2-e/2,s=[_t,dn,Ft,En];let a=n;if(s.forEach(r=>{z.transformIcons.push({id:`transform-icon-${r}`,type:r,x:a+(t-e)/2,y:o,width:e,height:e}),a+=t}),z.transformIcons.length>0){const r=z.transformIcons[0],c=z.transformIcons[z.transformIcons.length-1],l=5;z.transformPanelBounds={x:Qe,y:r.y-l,width:c.x+c.width-Qe+l,height:r.height+l*2}}else z.transformPanelBounds=null}function qi(e){e<0||e>=ce.length||ce.length<=1||(ce.splice(e,1),Object.keys(fe).forEach(t=>{fe[t]>e?fe[t]--:fe[t]===e&&(fe[t]=Math.min(e,ce.length-1))}),tt())}function kd(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}ce.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(ce.push(e),et&&tt())}function gr(e,t=[]){const n=Y(e);if(!n)return null;for(let i=X.length-1;i>=0;i--){const o=X[i],s=ee(o);if(t.includes(s))continue;let a=null;if(o.id1===e?a=o.id2:o.id2===e&&(a=o.id1),a){const r=Y(a);if(r){const c=n.x-r.x,l=n.y-r.y;return{p1:r,p2:n,angleRad:Math.atan2(l,c),length:Math.sqrt(c*c+l*l),edgeId:s}}}}return null}function $e(){const e=Gs();ce.length,ce[0]?.value,oe.length,lt.push(e),lt.length>_i&&lt.shift(),ds=[],Ms()}function Ki(e){const t=z.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!On)return!1;const n=[];z.mainToolbar&&n.push(z.mainToolbar),et&&z.colorPaletteBounds&&n.push(z.colorPaletteBounds),Lt&&z.interpolationPanelBounds&&n.push(z.interpolationPanelBounds),Jt&&z.transformPanelBounds&&n.push(z.transformPanelBounds),Ht&&z.displayPanelBounds&&n.push(z.displayPanelBounds);for(const o of n)if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return!0;const i=[];et&&z.colorPaletteBounds&&i.push(z.colorPaletteBounds),Lt&&z.interpolationPanelBounds&&i.push(z.interpolationPanelBounds),Jt&&z.transformPanelBounds&&i.push(z.transformPanelBounds),Ht&&z.displayPanelBounds&&i.push(z.displayPanelBounds),i.sort((o,s)=>o.y-s.y);for(let o=0;o<i.length-1;o++){const s=i[o],a=i[o+1],r=s.y+s.height,c=a.y;if(e.y>r&&e.y<c){const l=Qe,d=s.x+s.width-l,f=a.x+a.width-l,h=Math.min(d,f),u=l+h;if(e.x<Qe||e.x>=l&&e.x<=u)return!0}}return!1}function Ji(e){oe=JSON.parse(JSON.stringify(e.vertices)),X=JSON.parse(JSON.stringify(e.edges)),J=JSON.parse(JSON.stringify(e.faces||[])),Ye=JSON.parse(JSON.stringify(e.textElements||[])),le=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),re=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),se=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),ue=JSON.parse(JSON.stringify(e.selectedTextIds||[])),me=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),Oe=JSON.parse(JSON.stringify(e.activeColorTargets||[])),nn=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(vo))],Vo=e.activeInterpolationStyleId||nn[0]?.id||vo.id,ce=e.allColors?JSON.parse(JSON.stringify(e.allColors)):wi.map(n=>typeof n=="string"?{type:"color",value:n}:n),fe=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[ke]:0,[qe]:1,[Fe]:2,[pt]:0},fe[pt]===void 0&&(fe[pt]=0),Le=e.activeCenterId!==void 0?e.activeCenterId:null,Xe=e.isDrawingMode!==void 0?e.isDrawingMode:!1,Ke=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,yt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,vn=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,nt=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,ln=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,bn=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,hs=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,It=!1,Pe=!1,Cn=!1,$n=!1,ge=[],Po=null,Ut=-1,ae={targetId:null,type:null,count:0,timestamp:0},de.style.cursor="crosshair",et&&tt();const t=Gs();lt.length===0&&lt.push(t),Ms()}function Gs(){return{vertices:JSON.parse(JSON.stringify(oe)),edges:JSON.parse(JSON.stringify(X)),faces:JSON.parse(JSON.stringify(J)),textElements:JSON.parse(JSON.stringify(Ye)),selectedVertexIds:JSON.parse(JSON.stringify(le)),selectedEdgeIds:JSON.parse(JSON.stringify(re)),selectedFaceIds:JSON.parse(JSON.stringify(se)),selectedTextIds:JSON.parse(JSON.stringify(ue)),selectedCenterIds:JSON.parse(JSON.stringify(me)),activeColorTargets:JSON.parse(JSON.stringify(Oe)),interpolationStyles:JSON.parse(JSON.stringify(nn)),activeInterpolationStyleId:Vo,colorAssignments:JSON.parse(JSON.stringify(fe)),allColors:JSON.parse(JSON.stringify(ce)),activeCenterId:Le,isDrawingMode:Xe,previewLineStartVertexId:Ke,frozenReference_A_rad:yt,frozenReference_A_baseRad:vn,frozenReference_D_du:nt,frozenReference_Origin_Data:ln,frozenReference_D_g2g:bn,deletedFaceIds:new Set(hs)}}function yr(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function Rd(){try{const e=new URLSearchParams(window.location.search);return yr(e.get("user"))}catch{return""}}function Ld(){if(Dt)return Dt;const e=Rd();if(e){Dt=e;try{localStorage.setItem(si,Dt)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return Dt}try{Dt=localStorage.getItem(si)}catch{Dt=null}if(!Dt){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}Dt=yr(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(si,Dt)}catch(i){console.warn("Could not persist user id to localStorage.",i)}}return Dt}function mr(){const e=Ld();return`${sr}.state.v${or}.${e}`}function Nd(){const e=Gs();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function Sr(){if(!window.localStorage)return;const e=mr(),t={version:or,savedAt:Date.now(),state:Nd()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}}function Ms(){window.localStorage&&(eo&&clearTimeout(eo),eo=setTimeout(()=>{eo=null,Sr()},300))}function Od(){if(!window.localStorage)return!1;const e=mr();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(Ji(n.state),At(),Sd=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function _o(){J.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=J.map(t=>{const n=t.vertexIds.map(i=>Y(i));return n.some(i=>!i)?null:{face:t,vertices:n,area:Math.abs(Oo(n))}}).filter(Boolean);e.forEach(t=>{let n=null,i=1/0;e.forEach(o=>{if(t.face.id===o.face.id||o.area<=t.area)return;const s=t.face.vertexIds,a=s.map(c=>Y(c));if(a.some(c=>!c))return;if(bc(a,o.vertices)){const c=new Set(s),l=X.filter(f=>c.has(f.id1)&&c.has(f.id2));!Cc(l,o.vertices,Y)&&o.area<i&&(i=o.area,n=o.face)}}),n&&(t.face.parentFaceId=n.id)}),J.forEach(t=>{if(t.parentFaceId){const n=J.find(i=>i.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function be(e){const t=e.x*Re,n=e.y*Re,i=de.height;return{x:(t-te.offsetX)/te.scale,y:(i-n-te.offsetY)/te.scale}}function pe(e){const t=de.height,n=e.x*te.scale+te.offsetX,i=t-(e.y*te.scale+te.offsetY);return{x:n/Re,y:i/Re}}function Y(e){return oe.find(t=>t.id===e)}function zs(e){if(!Y(e))return[];const t=new Set,n=[e],i=[];for(t.add(e);n.length>0;){const o=n.shift();i.push(o),Yt(o,X).forEach(s=>{t.has(s)||(t.add(s),n.push(s))})}return i}function Is(e){const t=be(e),n=_e*2/te.scale,i=(Do+_e)/te.scale;for(let o=oe.length-1;o>=0;o--){const s=oe[o];if(s.type!=="regular"&&j(t,s)<i)return s}for(let o=oe.length-1;o>=0;o--){const s=oe[o];if(s.type==="regular"&&j(t,s)<n)return s}return null}function xs(e){const t=be(e),n=Ti/te.scale;for(let i=X.length-1;i>=0;i--){const o=X[i],s=Y(o.id1),a=Y(o.id2);if(s&&a&&s.type==="regular"&&a.type==="regular"){const r=St(t,s,a);if(r.distance<n&&r.onSegmentStrict)return o}}return null}function vs(e){const t=be(e),n=[];for(const s of J){if(s.color==="transparent")continue;const a=s.vertexIds.map(r=>Y(r)).filter(r=>r&&r.type==="regular");a.length<3||Hn(t,a)&&n.push(s)}if(n.length===0)return null;let i=null,o=1/0;for(const s of n){let a=!1;if(s.childFaceIds&&s.childFaceIds.length>0)for(const r of s.childFaceIds){const c=J.find(l=>l.id===r);if(c&&c.color==="transparent"){const l=c.vertexIds.map(d=>Y(d)).filter(Boolean);if(l.length>=3&&Hn(t,l)){a=!0;break}}}if(!a){const r=s.vertexIds.map(c=>Y(c));if(r.every(Boolean)){const c=Math.abs(Oo(r));c<o&&(o=c,i=s)}}}return i}function xi(e){return X.filter(t=>t.id1===e||t.id2===e)}function Fd(){le.length===0&&re.length===0&&me.length===0||($e(),Ir(),Ws())}function Ir(){const e=new Set(le);Le&&e.add(Le);const t=[];se.length>0&&se.forEach(s=>{const a=J.find(r=>he(r)===s);a&&(t.push(a),a.vertexIds.forEach(r=>e.add(r)))}),re.forEach(s=>{const[a,r]=s.split(ps);e.add(a),e.add(r)}),ht.vertices=Array.from(e).map(s=>{const a=Y(s);return a?{...a}:null}).filter(s=>s),ht.edges=[],X.forEach(s=>{e.has(s.id1)&&e.has(s.id2)&&ht.edges.push({...s})}),ht.faces=t.map(s=>JSON.parse(JSON.stringify(s)));const n=new Set(ue),i=new Set(se),o=new Set(re);ht.texts=Ye.filter(s=>{if(n.has(s.id))return!0;if(s.anchorType==="vertex")return e.has(s.anchorId);if(s.anchorType==="edge"){if(o.has(s.anchorId))return!0;const a=X.find(r=>ee(r)===s.anchorId);return a?e.has(a.id1)&&e.has(a.id2):!1}if(s.anchorType==="face"){if(i.has(s.anchorId))return!0;const a=J.find(r=>he(r)===s.anchorId);return a?a.vertexIds.every(r=>e.has(r)):!1}return!1}).map(s=>JSON.parse(JSON.stringify(s))),ht.referenceVertex=be(K)}function Bd(){if(ht.vertices.length===0||!ht.referenceVertex)return;$e();const e=be(K),t=e.x-ht.referenceVertex.x,n=e.y-ht.referenceVertex.y,i=new Map,o=[];let s=null;Tn(),ht.vertices.forEach(c=>{const l=wt(),d={...c,id:l,x:c.x+t,y:c.y+n};oe.push(d),i.set(c.id,l),d.type==="regular"?o.push(l):s=l}),ht.edges.forEach(c=>{const l=i.get(c.id1),d=i.get(c.id2);l&&d&&X.push({...c,id1:l,id2:d})});const a=[];ht.faces.forEach(c=>{const l=c.vertexIds.map(d=>i.get(d)).filter(Boolean);if(l.length===c.vertexIds.length){const d={...c,id:he({vertexIds:l}),vertexIds:l};d.localCoordSystem&&(d.localCoordSystem.origin.x+=t,d.localCoordSystem.origin.y+=n,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=i.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=i.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=i.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=i.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=i.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=i.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=i.get(d.localCoordSystem.scaleAttachedToEdge.v2))),d.parentFaceId=null,d.childFaceIds=[],J.push(d),a.push(d.id)}}),Jn();const r=[];ht.texts.forEach(c=>{const l=JSON.parse(JSON.stringify(c));if(l.id=wt(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const d=i.get(l.anchorId);if(!d)return;l.anchorId=d}else if(l.anchorType==="edge"){const d=X.find(u=>ee(u)===l.anchorId);if(!d)return;const f=i.get(d.id1),h=i.get(d.id2);if(!f||!h)return;l.anchorId=ee({id1:f,id2:h})}else if(l.anchorType==="face"){const d=J.find(h=>he(h)===l.anchorId);if(!d)return;const f=d.vertexIds.map(h=>i.get(h));if(!f.every(Boolean))return;l.anchorId=he({vertexIds:f})}Ye.push(l),r.push(l.id)}),le=o,re=ht.edges.map(c=>ee({id1:i.get(c.id1),id2:i.get(c.id2)})),se=a,ue=r,Le=s,At()}function Ws(){const e=new Set(le),t=new Set(me),n=new Set(re),i=new Set(se),o=new Set(ue);if(e.size===0&&t.size===0&&n.size===0&&i.size===0&&o.size===0)return;if($e(),i.size>0){const l=new Set;J.forEach(d=>{const f=d.id||he(d);i.has(f)&&(hs.add(f),d.childFaceIds&&d.childFaceIds.length>0&&d.childFaceIds.forEach(h=>{const u=J.find(p=>p.id===h);u&&(u.parentFaceId=null)}),d.parentFaceId?d.color="transparent":l.add(f))}),l.size>0&&(J=J.filter(d=>!l.has(d.id||he(d))))}const s=[...X];if(n.size>0&&(X=X.filter(l=>!n.has(ee(l)))),e.size>0){const l=JSON.parse(JSON.stringify(X)),d=[],f=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1,h=new Set(e);for(;h.size>0;){const u=h.values().next().value,p=new Set,g=[u];for(;g.length>0;){const I=g.shift();h.has(I)&&(p.add(I),h.delete(I),Yt(I,X).forEach(v=>{h.has(v)&&g.push(v)}))}const y=X.filter(I=>p.has(I.id1)&&!p.has(I.id2)||p.has(I.id2)&&!p.has(I.id1)),S=new Set;y.forEach(I=>{p.has(I.id1)||S.add(I.id1),p.has(I.id2)||S.add(I.id2)});const m=Array.from(S);if(m.length===2){const[I,x]=m,v=Y(I),A=Y(x),T=X.some(E=>E.id1===I&&E.id2===x||E.id1===x&&E.id2===I);v&&A&&!T&&d.push(Gn(v,A,f,Ce))}}oe=oe.filter(u=>!e.has(u.id)),X=X.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),d.length>0&&(X.push(...d),Kn(l,X),Jn())}Kn(s,X),t.size>0&&(oe=oe.filter(l=>!t.has(l.id))),o.size>0&&(Ye=Ye.filter(l=>!o.has(l.id)));const a=new Set(oe.map(l=>l.id)),r=new Set(X.map(l=>ee(l))),c=new Set(J.map(l=>he(l)));Ye=Ye.filter(l=>l.anchorType==="vertex"?a.has(l.anchorId):l.anchorType==="edge"?r.has(l.anchorId):l.anchorType==="face"?c.has(l.anchorId):!0),ue=ue.filter(l=>Ye.some(d=>d.id===l)),Tn(),At()}function vi(e,t){let n=te.scale*t;n<ra&&(n=ra),n>la&&(n=la);const i=n/te.scale,o=e.x*Re,s=e.y*Re;te.offsetX=o*(1-i)+te.offsetX*i,te.offsetY=(de.height-s)*(1-i)+te.offsetY*i,te.scale=n}function Zi(e){let t=0,n,i=Math.PI/2,o=!0;const s=Y(e);if(!s)return o=!0,je!=="none"&&G.interval1?n=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1:n=di,nt!==null&&(n=nt),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:i,isFirstSegmentBeingDrawn:o,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=gr(s.id);return a?(o=!1,t=a.angleRad,n=nt!==null?nt:a.length,yt!==null?Math.abs(yt)<ne?i=qo:i=Math.abs(yt):i=qo):(o=!0,je!=="none"&&G.interval1?n=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1:n=di,nt!==null&&(n=nt),t=0,i=qo),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:i,isFirstSegmentBeingDrawn:o,displayAngleA_valueRad_for_A_equals_label:yt,displayAngleA_originVertexData_for_A_equals_label:ln,frozen_A_baseRad_to_display:vn,frozen_D_du_to_display:nt,frozen_D_g2g_to_display:bn}}function Da(e,t,n){if(!e||!t)return null;const i=Math.atan2(t.y-e.y,t.x-e.x),o=j(e,t);let s=0,a=!0;for(let c=n.length-1;c>=0;c--){const l=n[c];let d=null;if(l.id1===e.id&&Y(l.id2)?.type==="regular"?d=l.id2:l.id2===e.id&&Y(l.id1)?.type==="regular"&&(d=l.id1),d&&d!==t.id){const f=Y(d);if(f){s=Math.atan2(e.y-f.y,e.x-f.x),a=!1;break}}}const r=Ue(i-s);return{startVertex:e,endVertex:t,absoluteAngleRad:i,length:o,precedingSegmentAbsoluteAngleRad:s,turnAngleRad:r,isFirstSegmentOfLine:a}}function xr(e,t){const n=new Set,i=[e],o=new Set([e]);for(;i.length>0;){const s=i.shift(),a=t.find(r=>r.id===s);a&&(a.vertexIds.forEach(r=>n.add(r)),a.childFaceIds&&a.childFaceIds.forEach(r=>{o.has(r)||(o.add(r),i.push(r))}))}return Array.from(n)}function $d(){const e=le.filter(o=>{const s=Y(o);return s&&s.type==="regular"});if(e.length<2)return;$e();const t=JSON.parse(JSON.stringify(X));let n=!1;const i=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;for(let o=0;o<e.length;o++)for(let s=o+1;s<e.length;s++){const a=e[o],r=e[s];if(!X.some(l=>l.id1===a&&l.id2===r||l.id1===r&&l.id2===a)){const l=Y(a),d=Y(r);if(l&&d){const f=Gn(l,d,i,Ce);X.push(f),n=!0}}}n&&cn&&(Kn(t,X),J.forEach(o=>{o.color||(o.color=Ce(Fe))}),Jn()),At()}function ct(e=[],t=[],n=[],i,o,s=!1,a=[]){s?ji(e[0],i,o):i?(le=[...new Set([...le,...e])],re=[...new Set([...re,...t])],se=[...new Set([...se,...n])],ue=[...new Set([...ue,...a])]):o?(e.forEach(r=>{const c=le.indexOf(r);c>-1?le.splice(c,1):le.push(r)}),t.forEach(r=>{const c=re.indexOf(r);c>-1?re.splice(c,1):re.push(r)}),n.forEach(r=>{const c=se.indexOf(r);c>-1?se.splice(c,1):se.push(r)}),a.forEach(r=>{const c=ue.indexOf(r);c>-1?ue.splice(c,1):ue.push(r)})):(le=[...e],re=[...t],se=[...n],ue=[...a])}function Vd(e,t,n,i,o=0){const s={x:n.x-e.x,y:n.y-e.y},a={x:t.x-e.x,y:t.y-e.y},r=Math.hypot(s.x,s.y),c=Math.hypot(a.x,a.y),l=Math.atan2(s.y,s.x),d=Math.atan2(a.y,a.x);let f=0,h=1,u=!1;if(i===_t)h=1,f=Ta(l,d,o);else if(i===dn)f=0,r>ne&&(h=c/r);else if(i===Ft)f=Ta(l,d,o),r>ne&&(h=c/r);else if(i===En&&(u=!0,f=0,r>ne)){const p={x:s.x/r,y:s.y/r};h=(a.x*p.x+a.y*p.y)/r}return{rotation:f,scale:h,directionalScale:u}}function Kn(e,t){if(!cn){J=[],hs.clear();return}const n=new Set(e.map(g=>ee(g))),i=new Set(t.map(g=>ee(g))),o=t.filter(g=>!n.has(ee(g))),s=e.filter(g=>!i.has(ee(g)));if(o.length===0&&s.length===0)return;const a=new Set;o.forEach(g=>{a.add(g.id1),a.add(g.id2)}),s.forEach(g=>{a.add(g.id1),a.add(g.id2)});const r=new Set,c=new Set;for(const g of a)c.has(g)||zs(g).forEach(S=>{r.add(S),c.add(S)});const l=X.filter(g=>r.has(g.id1)&&r.has(g.id2)),d=J.filter(g=>g.vertexIds.every(y=>r.has(y))),f=Bo(l,Y),h=new Set(d.map(g=>g.id));J=J.filter(g=>!h.has(g.id));let u=f;if(f.length>1){const g=f.map(y=>{const S=y.vertexIds.map(m=>Y(m));return S.some(m=>!m)?null:{face:y,area:Math.abs(Oo(S))}}).filter(Boolean);if(g.length>1){g.sort((m,I)=>I.area-m.area);const y=g[0],S=g.slice(1).reduce((m,I)=>m+I.area,0);Math.abs(y.area-S)<ne&&(u=g.slice(1).map(m=>m.face))}}const p=new Set(o.map(g=>ee(g)));u.forEach(g=>{let y=!1;if(o.length>0)for(let m=0;m<g.vertexIds.length;m++){const I=g.vertexIds[m],x=g.vertexIds[(m+1)%g.vertexIds.length],v=ee({id1:I,id2:x});if(p.has(v)){y=!0;break}}if(hs.has(g.id))if(y)hs.delete(g.id);else return;const S=fe[Fe];if(S!==-1){const m=ce[S];m&&m.type==="colormap"?(g.colormapItem=m,g.colormapDistribution="x",delete g.color):(g.color=Ce(Fe),delete g.colormapItem,delete g.colormapDistribution)}else g.color=Ce(Fe),delete g.colormapItem,delete g.colormapDistribution;g.parentFaceId=null,g.childFaceIds=[],J.push(g)}),Jn()}function vr(e,t,n,i){const o=Y(e.id1),s=Y(e.id2);if(!o||!s)return null;const a=[...X],r={id:wt(),x:t.x,y:t.y,type:"regular",color:i(ke)};return oe.push(r),X=X.filter(c=>ee(c)!==ee(e)),X.push(Gn(o,r,n,i)),X.push(Gn(r,s,n,i)),cn&&Kn(a,X),r}function Yd(e,t,n,i,o){const s=Be(n,e,i,o,!1,null),a={x:n.x-e.x,y:n.y-e.y},r=2*_e/te.scale,c=t.filter(d=>d.type==="regular"),l=[];if(c.length>0){const d=oe.filter(h=>h.type==="regular"&&!t.some(u=>u.id===h.id)),f=parseInt(mt||"1",10)||1;for(let h=1;h<=f;h++)c.forEach(u=>{d.forEach(p=>{const g={x:u.x-e.x,y:u.y-e.y},y={x:p.x-e.x,y:p.y-e.y},S=Math.hypot(g.x,g.y),m=Math.hypot(y.x,y.y);if(S>ne){const I=Math.pow(m/S,1/h);let x=Math.atan2(y.y,y.x)-Math.atan2(g.y,g.x);const A=(x+Math.round((i*h-x)/(2*Math.PI))*(2*Math.PI))/h,T=Be(n,e,A,I,!1,a),E=j(s,T);l.push({dist:E,rotation:A,scale:I,pos:T})}})})}if(l.length>0){const d=l.sort((f,h)=>f.dist-h.dist)[0];if(d.dist<r)return{...d,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}if(Ee){const d=[],f=[],h=Di.flatMap(m=>{const I=m*Math.PI/2;return I===0?[0]:[I,-I]}).sort((m,I)=>Math.abs(Ue(i-m))-Math.abs(Ue(i-I))),u=Sn.filter(m=>m>0).sort((m,I)=>Math.abs(o-m)-Math.abs(o-I)),p=h.slice(0,2),g=u.slice(0,2);p.forEach(m=>{g.forEach(I=>{const x=m+Math.round((i-m)/(2*Math.PI))*(2*Math.PI),v=Be(n,e,x,I,!1,a);d.push({dist:j(s,v),rotation:x,scale:I,pos:v})})});const y=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;if(y){const m=xn(s,je,y,Bt,!0),I=Math.hypot(a.x,a.y);m.forEach(x=>{if(I>ne){const v={x:x.x-e.x,y:x.y-e.y},A=Math.hypot(v.x,v.y)/I,T=Math.atan2(v.y,v.x)-Math.atan2(a.y,a.x),E=T+Math.round((i-T)/(2*Math.PI))*(2*Math.PI);f.push({dist:j(s,x),rotation:E,scale:A,pos:x})}})}const S=[...d,...f].sort((m,I)=>m.dist-I.dist)[0];return{...S,snapped:!0,snapType:"geometric",snappedScaleValue:S.scale}}return{rotation:i,scale:o,pos:s,snapped:!1}}function Xd(e,t,n,i,o){const s=parseInt(mt||"1",10);let a=[];const r=Math.hypot(n.x-e.x,n.y-e.y),c=2*_e/te.scale,l=t.filter(g=>g.type==="regular"),d=oe.filter(g=>g.type==="regular"&&!t.some(y=>y.id===g.id));if(Array.from({length:s},(g,y)=>y+1).forEach(g=>{l.forEach(y=>{d.forEach(S=>{const m={x:y.x-e.x,y:y.y-e.y},I={x:S.x-e.x,y:S.y-e.y};if(Math.abs(Math.hypot(m.x,m.y)-Math.hypot(I.x,I.y))<ne){let x=Math.atan2(I.y,I.x)-Math.atan2(m.y,m.x);const v=x+Math.round((i*g-x)/(2*Math.PI))*(2*Math.PI);a.push({rotation:v/g,priority:Math.abs(Ue(v/g-i)),snapType:"merge"})}})})}),Ee){Di.flatMap(m=>{const I=m*Math.PI/2;return I===0?[0]:[I,-I]}).forEach(m=>{const I=Math.abs(Ue(i-m)),x=m+Math.round((i-m)/(2*Math.PI))*(2*Math.PI);a.push({rotation:x,priority:I,snapType:"geometric"})});const y=new Set(t.map(m=>m.id));let S=oe.filter(m=>m.type==="regular"&&!y.has(m.id));if(G){const m=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;m&&S.push(...xn(o,je,m,Bt,!0))}S.forEach(m=>{const I=j(o,m);if(I<Ci/te.scale){const x=Math.atan2(n.y-e.y,n.x-e.x),v=Math.atan2(m.y-e.y,m.x-e.x),A=Ue(v-x),T=A+Math.round((i-A)/(2*Math.PI))*(2*Math.PI);a.push({rotation:T,priority:I/1e3,snapType:"projection",projectionSource:m})}})}if(a.length===0)return{rotation:i,snapped:!1,snapType:null};a.sort((g,y)=>g.priority-y.priority);const h=a[0];if(h.snapType==="merge"){const g=Be(n,e,h.rotation,1,!1,null);if(j(o,g)>c)return{rotation:i,snapped:!1,snapType:null}}const u=Be(n,e,h.rotation,1,!1,null);let p=null;return h.snapType==="projection"&&(p={x:e.x+r*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+h.rotation),y:e.y+r*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+h.rotation)}),{rotation:h.rotation,pos:u,snapped:!0,snapType:h.snapType,projectionSource:h.projectionSource||null,projectionPoint:p}}function Hd(e,t,n,i){const o=be(K),s=2*_e/te.scale,a=t.filter(c=>c.type==="regular"),r=[];if(a.length>0){const c=oe.filter(f=>f.type==="regular"&&!t.some(h=>h.id===f.id)),l=s/100,d=parseInt(mt||"1",10);for(let f=1;f<=d;f++)a.forEach(h=>{c.forEach(u=>{const p={x:h.x-e.x,y:h.y-e.y},g={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(p.x,p.y),S=Math.hypot(g.x,g.y);if(y>ne){const m=Math.atan2(p.y,p.x),I=Math.atan2(g.y,g.y);if(Math.abs(Ue(m-I))<l){const x=Math.pow(S/y,1/f),v=Be(n,e,0,x,!1,null);r.push({scale:x,dist:j(o,v)})}}})})}if(r.length>0){const c=r.sort((l,d)=>l.dist-d.dist)[0];if(c.dist<s){const l=Be(n,e,0,c.scale,!1,null);return{...c,pos:l,snapped:!0,snapType:"merge"}}}if(Ee){let c,l,d=1,f=1/0;Sn.forEach(g=>{const y=Math.abs(i-g);y<f&&(f=y,d=g)});const h=Be(n,e,0,d,!1,null);c={scale:d,pos:h,dist:j(o,h),snapType:"geometric",snappedScaleValue:d};const u=new Set(t.map(g=>g.id)),p=oe.filter(g=>g.type==="regular"&&!u.has(g.id));if(G){const g=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;g&&p.push(...xn(o,je,g,Bt,!0))}if(p.length>0){const g=p.reduce((m,I)=>j(o,m)<j(o,I)?m:I),y=Math.hypot(n.x-e.x,n.y-e.y),S=j(e,g);if(y>ne){const m=S/y,I=Math.atan2(n.y-e.y,n.x-e.x),x={x:e.x+S*Math.cos(I),y:e.y+S*Math.sin(I)};l={scale:m,pos:x,dist:j(o,x),snapType:"projection",snappedScaleValue:m,projectionSource:g}}}return l&&j(o,l.projectionSource)<s?{...l,snapped:!0}:{...c,snapped:!0}}return{scale:i,snapped:!1,snapType:null}}function Gd(e,t,n,i,o,s){let a=[];const r=2*_e/te.scale;if(t.filter(l=>l.type==="regular"),Ee){let l=null,d=null,f=1,h=1/0;[...Sn,...Sn.map(S=>-S)].forEach(S=>{const m=Math.abs(i-S);m<h&&(h=m,f=S)});const p=Be(n,e,0,f,!0,o);l={scale:f,pos:p,dist:j(s,p),snapType:"geometric",snappedScaleValue:f};const g=new Set(t.map(S=>S.id)),y=oe.filter(S=>S.type==="regular"&&!g.has(S.id));if(G){const S=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;S&&y.push(...xn(s,je,S,Bt,!0))}if(y.length>0){const S=y.reduce((I,x)=>j(s,x)<j(s,I)?x:I),m=Math.hypot(o.x,o.y);if(m>ne){const I={x:o.x/m,y:o.y/m},x=A=>(A.x-e.x)*I.x+(A.y-e.y)*I.y,v=x(n);if(Math.abs(v)>ne){const T=x(S)/v,E=Be(n,e,0,T,!0,o);d={scale:T,pos:E,dist:j(s,E),snapType:"projection",snappedScaleValue:T,projectionSource:S}}}}d&&j(s,d.projectionSource)<r?a.push({...d,priority:0}):a.push({...l,priority:1})}return a.length===0?{scale:i,snapped:!1,snapType:null}:{...a.sort((l,d)=>l.priority-d.priority)[0],snapped:!0}}function zd(e){const t=de.width/Re,n=de.height/Re,{grid1Interval:i,grid2Interval:o,alpha1:s,alpha2:a}=Tc(te.scale);G={interval1:i,interval2:o,alpha1:s,alpha2:a,scale:te.scale},Bt=Ec(te,t,n,pe),$c(xe,{gridDisplayMode:je,canvas:de,dpr:Re,viewTransform:te,gridAlpha:Id,colors:e},pe,be,G,Bt);let r={useScientific:!1};return Un!==Lo&&(r=Nc(xe,Ze,{canvas:de,dpr:Re,coordsDisplayMode:Un,viewTransform:te,angleDisplayMode:Ot,colors:e},pe,be,G,Bt,at)),r}function Wd(e){const t=Pe&&ie.length===1&&!Ne&&ie[0].type==="regular";if(gi.forEach(n=>{(!(Pe&&ie.length>0&&[...n].some(o=>ie.some(s=>s.id===o)))||t)&&Ed(n,e,!1,[],0)}),oe.forEach(n=>{if(n.type!=="regular"){const i=Pe&&ie.some(c=>c.id===n.id);let o=n,s=!1,a=i?0:void 0;if(i&&!t&&ge.length>0){const c=ge.find(l=>l&&l.originalId===n.id&&l.transformIndex===0);c&&(o=c)}if(ot){const c=n.originalId||n.id;ot.has(c)&&ot.get(c).find(f=>f.copyIndex===a)&&(s=!0)}const r={selectedVertexIds:[],selectedCenterIds:me,activeCenterId:Le,colors:e,verticesVisible:!0,isHovered:zt===n.id&&!ut,isSnapped:s,snappedVertexIds:ot,isDragConfirmed:Pe,dragPreviewVertices:ge,currentAltPressed:ut};Io(xe,o,r,pe)}}),Pe){const i={copyCount:parseInt(mt||"1",10),isDragConfirmed:Pe,initialDragVertexStates:ie,dragPreviewVertices:ge,transformIndicatorData:Ne,allEdges:X,allFaces:J,findVertexById:Y,findAllVerticesInSubgraph:o=>zs(o),colors:e,snappedEdgesInfo:jn,snappedVertexIds:ot};t?Dc(xe,i,pe):_c(xe,i,pe)}}function Ud(e,t){ed(Ze,{coordsDisplayMode:Un,isMouseOverCanvas:Fs,currentShiftPressed:Ee,ghostVertexPosition:we,gridDisplayMode:je,lastGridState:G,angleDisplayMode:Ot,canvas:de,dpr:Re,mousePos:K,colors:e,useScientific:t.useScientific},be,at);const n={dpr:Re,canvasUI:z,isToolbarExpanded:On,isColorPaletteExpanded:et,isInterpolationPanelExpanded:Lt,isTransformPanelExpanded:Jt,isDisplayPanelExpanded:Ht,isVisibilityPanelExpanded:Hi,isPlacingTransform:vt,placingTransformType:Ss,placingSnapPos:Xs,mousePos:K,allColors:ce,activeThemeName:wo,colors:e,verticesVisible:Co,edgesVisible:Mo,facesVisible:cn,coordsDisplayMode:Un,gridDisplayMode:je,angleDisplayMode:Ot,distanceDisplayMode:ao,namedColors:gn.namedColors,colorAssignments:fe,activeColorTargets:Oe,interpolationStyles:nn,activeInterpolationStyleId:Vo,isDraggingColorTarget:ls,draggedColorTargetInfo:Rt};ud(xe,Ze,n,at)}function br(){Gi.clear();const e=zi();Pc(xe,{canvas:de,dpr:Re,colors:e});const t=zd(e);Wd(e),za(xe,{allFaces:J,hoveredFaceId:Wt,selectedFaceIds:se,colors:e,isDragConfirmed:Pe,dragPreviewVertices:ge,currentAltPressed:ut},pe,Y,he),se.length>0&&nr(xe,{allFaces:J,selectedFaceIds:se,colors:e,isDragConfirmed:Pe,dragPreviewVertices:ge,initialDragVertexStates:ie,transformIndicatorData:Ne,highlightedEdgeForSnap:Qt,draggedFaceId:Ys,coordSystemSnapAngle:ms,coordSystemSnapType:Wn,coordSystemSnapScale:Kt,initialCoordSystemStates:zn},pe,Y),Ah(e),Md(e),Yc(xe,{altHoverInfo:Ge,colors:e},pe,Y,at),Ud(e,t),bd()}function Cr(){if(!ve||ve.length<2)return;const e=fe[ke];if(e===-1)return;const t=ce[e];if(!t||t.type!=="colormap")return;const n=ve.length;ve.forEach((i,o)=>{const s=Y(i);if(s&&s.type==="regular"){const a=n>1?o/(n-1):.5;s.color=He(t,a)}})}function Mr(){if(!ve||ve.length<2)return;const e=fe[qe];if(e===-1)return;const t=ce[e];if(!t||t.type!=="colormap")return;const i=ve.length-1;for(let o=0;o<i;o++){const s=ve[o],a=ve[o+1],r=X.find(c=>c.id1===s&&c.id2===a||c.id1===a&&c.id2===s);if(r){const c=o/i,l=(o+1)/i;r.gradientStart=c,r.gradientEnd=l,r.colormapItem=t,delete r.colormapOffset,delete r.color}}}function jd(e,t,n){if(!et)return!1;const i=z.removeColorButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height){if(ce.length>1&&Oe.length>0){const s=Oe[Oe.length-1],a=fe[s];a>=0&&($e(),qi(a))}return!0}const o=z.addColorButton;return o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height?(Eo=!1,_s=null,gn.show(),!0):!1}function Tn(){if(xt&&clearTimeout(xt),mt="",xt=null,Vn&&(ce=ft.originalAllColors,fe=ft.originalAssignments,tt(),lt.length>0&&lt.pop(),Vn=!1,ft=null,Dn=!1),Xe){Xe=!1,Ke=null,yt=null,vn=null,nt=null,bn=null,ln=null,ze=[],Ct=0,ve=[],bo=null;return}vt&&(vt=!1,Ss=null,Xs=null),le=[],re=[],se=[],me=[],ue=[],Le=null,Oe=[],et&&tt(),Xt=null,It=!1,Pe=!1,Cn=!1,To=!1,cs=!1,$n=!1,ge=[],ie=[],Po=null,Ut=-1,ae={targetId:null,type:null,count:0,timestamp:0},de.style.cursor="crosshair",Ne=null,qn=[],we=null,Qt=null,ms=null,Ys=null,Wn=null,Xt=null,Ge=null}function qd(){if(!Xe||!Ke||ze.length===0)return;$e();const e=Y(Ke);if(!e){Tn();return}const t=gr(e.id);if(!t){Tn();return}const n=t.angleRad;if(ze.length===1)return;const i=ze.length-1,o=(Ct-1)%i+1,s=ze[o],a=s.length;let r;if(o===ze.length-1){const S=ze.length>2?1:0;r=ze[S].turn}else r=s.turn;let c,l;if(o===ze.length-1){const S=[ze[0].endVertexColor,ze[1].endVertexColor],m=(Ct-1)%S.length;l=S[m];const I=Ct%S.length;c=S[I],e.color=l}else c=s.endVertexColor;const d=Zt(n+r),f=e.x+a*Math.cos(d),h=e.y+a*Math.sin(d);let u=null,p=!1;const g=_e*2/te.scale;for(const S of oe)if(S.type==="regular"&&j({x:f,y:h},S)<g){u=S,p=!0;break}p||(u={id:wt(),x:f,y:h,type:"regular",color:c},oe.push(u)),X.some(S=>S.id1===e.id&&S.id2===u.id||S.id2===e.id&&S.id1===u.id)||X.push({id1:e.id,id2:u.id,color:Ce(qe)}),cn&&(J=Bo(X,Y),Jn()),ve.push(u.id),window.currentDrawingPath=ve,Cr(),Mr(),Ke=u.id,Ct++,Ct>=ze.length&&(Ct=1),nt=null,bn=null,yt=null,vn=null,ln=null}function Tr(){br(),requestAnimationFrame(Tr)}function Kd(e){if(se.length===0)return!1;const t=Cs(e,de);for(const n of se){const i=J.find(s=>s.id===n);if(!i||!i.localCoordSystem)continue;const o=ac(t,i,pe);if(o)return Mn=!0,$t=o,Ys=i.id,Ao=Jd(i),o.type==="center"&&(i.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function Jd(e){const t=[],n=[],i=[],o=[],s=[];e.vertexIds.forEach(a=>{const r=Y(a);r&&r.type==="regular"&&t.push({...r,id:a})});for(let a=0;a<t.length;a++){const r=t[a],c=t[(a+1)%t.length];n.push({x:(r.x+c.x)/2,y:(r.y+c.y)/2,v1:r.id,v2:c.id}),i.push(r.id,c.id),s.push(Math.atan2(c.y-r.y,c.x-r.x))}return J.forEach(a=>{a.id!==e.id&&a.localCoordSystem&&o.push(a.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:i,faceCenters:o,edgeAngles:s}}function bi(e,t){const n=e.vertexIds[t],i=e.vertexIds[(t+1)%e.vertexIds.length],o=Y(n),s=Y(i);return o&&s?{v1Id:n,v2Id:i,edgeAngle:Math.atan2(s.y-o.y,s.x-o.x)}:null}function Zd(e,t){if(e.length===0||t&&t.transformType===_t||!t)return;const o=new Set;e.forEach(a=>{xi(a).forEach(r=>o.add(r))});const s=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;o.forEach(a=>{const r=Y(a.id1),c=Y(a.id2);if(!r||!c)return;const l=r.x-c.x,d=r.y-c.y,f=l/s,h=d/s,u=1e-5;if(s&&Math.abs(f-Math.round(f))<u&&Math.abs(h-Math.round(h))<u){a.labelMode="exact";const g=Math.round(f),y=Math.round(h);a.exactValue={g2gSquaredSum:g*g+y*y,gridInterval:s}}else a.labelMode="decimal",delete a.exactValue})}function Qd(){if(gt){$e();let e=J.find(t=>t.id===gt);if(e)e.color=Ce(Fe),_o();else{const n=Bo(X,Y).find(i=>i.id===gt);n&&(n.color=Ce(Fe),J.push(n),_o(),Jn())}gt=null}st.style.display="none"}function eh(e,t){const n=[],i=t.find(a=>a.id===e);if(!i)return[];const o=[...i.childFaceIds||[]],s=new Set(i.childFaceIds);for(;o.length>0;){const a=o.shift(),r=t.find(c=>c.id===a);r&&(n.push(r),r.childFaceIds&&r.childFaceIds.forEach(c=>{s.has(c)||(s.add(c),o.push(c))}))}return n}function th(e,t,n,i,o){if(!t.isCustom){const l=e.vertexIds.map(d=>i.find(f=>f.id===d)||o(d)).filter(d=>d&&d.type==="regular");if(l.length>=3){const d=Fo(l);d&&(e.localCoordSystem.origin=d.center,e.localCoordSystem.scale=d.radius)}return}let s={...t.origin},a=t.angle,r=t.scale;if(e.localCoordSystem.attachedToVertex){const l=i.find(d=>d.id===e.localCoordSystem.attachedToVertex);l&&(s={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=i.find(f=>f.id===e.localCoordSystem.attachedToEdge.v1)||o(e.localCoordSystem.attachedToEdge.v1),d=i.find(f=>f.id===e.localCoordSystem.attachedToEdge.v2)||o(e.localCoordSystem.attachedToEdge.v2);l&&d&&(s={x:l.x+e.localCoordSystem.attachedToEdge.t*(d.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(d.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=i.find(f=>f.id===e.localCoordSystem.rotationAlignedToEdge.v1)||o(e.localCoordSystem.rotationAlignedToEdge.v1),d=i.find(f=>f.id===e.localCoordSystem.rotationAlignedToEdge.v2)||o(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&d){const f=Math.atan2(d.y-l.y,d.x-l.x),h=e.localCoordSystem.rotationAlignedToEdge.originalAngle,p=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-h;a=Zt(f+p),e.localCoordSystem.rotationAlignedToEdge.originalAngle=f,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(e.localCoordSystem.scaleAttachedToEdge){const l=i.find(f=>f.id===e.localCoordSystem.scaleAttachedToEdge.v1)||o(e.localCoordSystem.scaleAttachedToEdge.v1),d=i.find(f=>f.id===e.localCoordSystem.scaleAttachedToEdge.v2)||o(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&d){const f=j(l,d);r=f*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=f}}const c=e.vertexIds.map(l=>i.find(d=>d.id===l)||o(l)).filter(l=>l&&l.type==="regular");c.length>=3&&(e.localCoordSystem.origin=ys(s,c),e.localCoordSystem.angle=a,e.localCoordSystem.scale=Math.max(.01,r),e.localCoordSystem.isCustom=!0)}function nh(e,t){const n=new Map;return e.forEach(i=>{const o=[...new Set(i.vertexIds.map(s=>t(s)))];if(o.length>=3){const s=he({vertexIds:o});if(i.localCoordSystem&&i.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(i.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=t(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=t(a.attachedToEdge.v1),a.attachedToEdge.v2=t(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=t(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=t(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=t(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=t(a.scaleAttachedToEdge.v2)),n.set(s,a)}}}),n}function sh(e){st.innerHTML="",st.style.display="none",K=Cs(e,de);const t=Is(K),n=t?null:xs(K),i=!t&&!n?vs(K):null;if(t||n||i){let d=!1;t?d=le.includes(t.id):n?d=re.includes(ee(n)):i&&(d=se.includes(he(i))),d||(le=[],re=[],se=[],me=[],ue=[],t?le=[t.id]:n?re=[ee(n)]:i&&(se=[he(i)]))}else Tn();const s=be(K);let a=[];gt=null,as=null,is=null;const r=(le.length>0?1:0)+(re.length>0?1:0)+(se.length>0?1:0),c=Is(K),l=c?null:xs(K);if(c&&c.type==="regular"){is=c.id;const d=r>1?"Remove Geometry":"Remove Vertex";a.push({text:d,handler:ph})}else if(l){as=ee(l);const d=r>1?"Remove Geometry":"Remove Edge";a.push({text:d,handler:gh})}else{const d=vs(K);if(d){gt=he(d);const f=r>1?"Remove Geometry":"Remove Face";a.push({text:f,handler:yh}),d.childFaceIds&&d.childFaceIds.length>0&&a.push({text:"Remove Face and Children",handler:uh})}else{const f=Bo(X,Y);let h=null,u=1/0;f.forEach(p=>{const g=p.vertexIds.map(y=>Y(y));if(g.every(Boolean)&&Hn(s,g)){const y=Math.abs(Oo(g));y<u&&(u=y,h=p)}}),h&&(gt=h.id||he(h),a.push({text:"Add Face",handler:Qd}))}}if(a.length>0){const d=document.createElement("ul");a.forEach(f=>{const h=document.createElement("li");h.textContent=f.text,h.addEventListener("click",f.handler),d.appendChild(h)}),st.appendChild(d),st.style.left=`${e.clientX-aa}px`,st.style.top=`${e.clientY-aa}px`,st.style.display="block"}}function oh(e){if(Ht){for(const t of z.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[Lo,ki,ks,No];Un=n[(n.indexOf(Un)+1)%n.length];break;case"grid":const i=[Ri,Li,Ni,Oi,$s];je=i[(i.indexOf(je)+1)%i.length];break;case"angles":const o=[Xn,Vs,Rs];Ot=o[(o.indexOf(Ot)+1)%o.length],pn=Ot!==Rs;break;case"distances":const s=[Ls,Ql];ao=s[(s.indexOf(ao)+1)%s.length],qt=ao===Ls;break;case"theme":ch();break}return!0}}return!1}function ih(e){if(!Lt)return!1;for(const t of z.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationAdd")return os?.initialize?.(),os?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(to.id===t.styleId&&n-to.timestamp<fo){const i=Cd(t.styleId);return i&&(os?.initialize?.(),os?.show(i)),to={id:null,timestamp:0},!0}return to={id:t.styleId,timestamp:n},rr(t.styleId),!0}}return!1}function ah(e,t=!1,n=!1){const i=z.toolbarButton;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return On=!On,On?ur():(et=!1,Lt=!1,Jt=!1,Ht=!1,Hi=!1,Oe=[]),!0;if(On){const o=z.colorToolButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return fh(),!0;const s=z.interpolationToolButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return Lt=!Lt,Lt&&pr(),!0;const a=z.transformToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return Jt=!Jt,Jt&&Dd(),!0;const r=z.visibilityToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return Ht=!Ht,Ht&&_d(),!0}if(et&&jd(e)||Lt&&ih(e))return!0;if(Jt){for(const o of z.transformIcons)if(e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return vt?Ss=o.type:(vt=!0,Ss=o.type,de.style.cursor="none"),!0}return!!(Ht&&oh(e)||Ki(e))}function rh(){if(lt.length===0)return;const e=Gs();ce.length,ce[0]?.value,oe.length,ds.push(e),ds.length>_i&&ds.shift();const t=lt.pop();Ji(t),ce.length,ce[0]?.value,oe.length,At()}function lh(){if(ds.length===0)return;const e=Gs();lt.push(e),lt.length>_i&&lt.shift();const t=ds.pop();Ji(t),At()}function Qi(e,t){const n=be(e),i=Is(e),o=i?null:xs(e),s=!i&&!o?vs(e):null;if(i)Ge={point:{x:i.x,y:i.y},element:{type:"vertex",id:i.id},shiftKey:t};else if(o){const a=Y(o.id1),r=Y(o.id2);if(a&&r){let c,l;const d=St(n,a,r);if(t){const f=gc(d,a,r);c=f.point,l=f.fraction}else c={x:d.x,y:d.y},l=d.t;Ge={point:c,element:{type:"edge",edge:o},shiftKey:t,fraction:l}}}else s?Ge={point:n,element:{type:"face",id:he(s)},shiftKey:t}:Ge=null;zt=null,sn=null,Wt=null}function ch(){$e(),wo=wo==="dark"?"light":"dark",wd(),et&&tt()}function dh(e){if(!Mn||!$t)return!1;const t=Cs(e,de),n=be(t),i=$t,o=i.face,s=o.localCoordSystem,a=o.vertexIds.map(r=>Y(r)).filter(r=>r&&r.type==="regular"&&r.x!==void 0&&r.y!==void 0);if(i.type==="center"){let r,c={snapped:!1};if(e.shiftKey){if(c=hc(n,Ao,je,G,Bt),c.snapped){if(r=c.snapPoint,c.snapType==="edge"){const l=c.edgeInfo,d=Y(l.v1),f=Y(l.v2);d&&f&&(r=c.snapPoint,Xt=null)}}else{const l=Fo(a);r=l?l.center:a[0]}i.type==="center"&&(we=r)}else r=n,we=null,Xt=null;a.length>0&&a.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(r=ys(r,a),we&&(we=ys(we,a))),s.origin.x=r.x,s.origin.y=r.y,s.isCustom=!0,c.snapped?(s.attachedToVertex=c.vertexId||null,s.attachedToEdge=c.edgeInfo||null):(s.attachedToVertex=null,s.attachedToEdge=null)}else if(i.type==="x_axis"||i.type==="y_axis"){const r={x:n.x-s.origin.x,y:n.y-s.origin.y};let c=Math.atan2(r.y,r.x),l=Math.hypot(r.x,r.y);if(Qt=null,ms=null,Wn=null,qn=[],we=null,Xt=null,Kt=null,e.shiftKey){const d=cc(n,s.origin,!0,Ao);if(d.snapped){c=d.angle,ms=c,Wn=d.snapType;const f={x:Math.cos(c),y:Math.sin(c)},h={x:n.x-s.origin.x,y:n.y-s.origin.y},u=h.x*f.x+h.y*f.y;if(d.snapType==="vertex_direction"){const p=Y(d.targetVertexId);p&&(l=j(s.origin,p),Kt=l)}else if(d.edgeIndex!==null){Qt=d.edgeIndex;const p=bi(o,d.edgeIndex);if(p){const g=Math.abs(Ue(c-p.edgeAngle))>Math.PI/4&&Math.abs(Ue(c-p.edgeAngle))<3*Math.PI/4;if(i.type==="x_axis"&&g){const y=Y(p.v1Id),S=Y(p.v2Id);if(y&&S){const m=Ya(s.origin,y,S),I=m.distance,x=[.25,1/3,.5,2/3,.75,1];let v={scale:u,dist:1/0,fraction:null};x.forEach(T=>{const E=I*T,M=Math.abs(u-E);M<v.dist&&(v={scale:E,dist:M,fraction:T})});const A=15/te.scale;v.dist<A?(l=v.scale,Kt=l,Xt={orthogonalDistanceFraction:v.fraction,v1:y,v2:S,snapPosition:{origin:s.origin,closest:m}}):(l=u>0?u:0,Kt=l)}}else{const y=dc(s.origin,i.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:p},o,Y,u,te,i.type);if(y.snapped){if(l=y.scale,Kt=l,y.edgeFraction!==null){const S={x:s.origin.x+l*Math.cos((i.type==="y_axis",c)),y:s.origin.y+l*Math.sin((i.type==="y_axis",c))};Xt={edgeFraction:y.edgeFraction,v1:Y(p.v1Id),v2:Y(p.v2Id),snapPosition:S}}}else l=u>0?u:0}}}}else l=Math.hypot(r.x,r.y)}i.type==="y_axis"?s.angle=c-Math.PI/2:s.angle=c,l>.01&&(s.scale=l),s.isCustom=!0}return!0}function hh(){if(Mn){const e=$t,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const i=ll;let o=null,s=null,a=1/0,r={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(c=>{const l=Y(c);if(l&&l.type==="regular"){const d=j(n.origin,l);d<a&&(a=d,d<i&&(o=c))}}),!o){for(let c=0;c<t.vertexIds.length;c++){const l=Y(t.vertexIds[c]),d=Y(t.vertexIds[(c+1)%t.vertexIds.length]);if(l&&d&&l.type==="regular"&&d.type==="regular"){const f=St(n.origin,l,d);f.distance<r.dist&&(r={dist:f.distance,t:f.t,v1:l.id,v2:d.id})}}if(r.dist<i){const c=j(Y(r.v1),Y(r.v2));c>ne&&(s={v1:r.v1,v2:r.v2,t:r.t,originalLength:c,scaleRatio:n.scale/c})}}n.attachedToVertex=o,n.attachedToEdge=s}if(e.type==="x_axis"||e.type==="y_axis"){let i=!1,o=!1;if(Wn==="edge"&&Qt!==null){const s=bi(t,Qt);s&&(n.rotationAlignedToEdge={v1:s.v1Id,v2:s.v2Id,originalAngle:s.edgeAngle,originalSystemAngle:n.angle},i=!0)}if(Kt!==null&&n.rotationAlignedToEdge){const s=bi(t,Qt);if(s){const a=Y(s.v1Id),r=Y(s.v2Id);if(a&&r){const c=j(a,r);c>ne&&(n.scaleAttachedToEdge={v1:s.v1Id,v2:s.v2Id,scaleRatio:n.scale/c,originalLength:c},o=!0)}}}i||(n.rotationAlignedToEdge=null),o||(n.scaleAttachedToEdge=null)}return Kt=null,Xt=null,Mn=!1,$t=null,Ao=null,Qt=null,ms=null,Wn=null,Ys=null,we=null,qn=[],!0}return!1}function fh(){et=!et,et&&tt()}function uh(){if(gt){$e();const e=J.find(t=>t.id===gt);if(e){const t=eh(e.id,J),n=new Set(t.map(s=>s.id)),i=new Set;t.forEach(s=>{s.vertexIds.forEach(a=>i.add(a))}),oe=oe.filter(s=>!i.has(s.id)),X=X.filter(s=>!i.has(s.id1)&&!i.has(s.id2));const o=new Set([e.id,...n]);J=J.filter(s=>!o.has(s.id)),Tn()}gt=null}st.style.display="none"}function ph(){is&&($e(),le.includes(is)||(re=[],se=[],me=[],ue=[],le=[is]),Ws(),is=null),st.style.display="none"}function gh(){as&&($e(),re.includes(as)||(le=[],se=[],me=[],ue=[],re=[as]),Ws(),as=null),st.style.display="none"}function yh(){gt&&($e(),se.includes(gt)||(le=[],re=[],me=[],ue=[],se=[gt]),Ws(),gt=null),st.style.display="none"}function mh(e){const t=rc(K,z,{isToolbarExpanded:On,isColorPaletteExpanded:et,isInterpolationPanelExpanded:Lt,isTransformPanelExpanded:Jt,isDisplayPanelExpanded:Ht,isVisibilityPanelExpanded:Hi});if(vt&&(!t||t.type!=="transformIcon")){$e();const f=be(K),h=Ee?co(f):f,u={id:wt(),x:h.x,y:h.y,type:Ss};oe.push(u),me=[u.id],Le=u.id,le=[],re=[],se=[],ue=[],vt=!1,Ss=null,Xs=null,de.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!Xe){Qi(K,e.shiftKey);const f=Ge&&Ge.element.type==="vertex"?Y(Ge.element.id):null,h=Ge&&Ge.element.type==="edge"?Ge.element.edge:null,u=Ge&&Ge.element.type==="face"?J.find(p=>he(p)===Ge.element.id):null;if(f||h||u){$e(),le=[],re=[],se=[],me=[],ue=[],Le=null,Oe=[],et&&tt();const p=G?.alpha2>=G?.alpha1&&G?.interval2?G.interval2:G?.interval1;if(f&&f.type==="regular")Xe=!0,Ke=f.id,ze=[],Ct=0,ve=[f.id],window.currentDrawingPath=ve;else if(h&&Ge){const g=Ge.point,y=vr(h,g,p,Ce);y&&(Xe=!0,Ke=y.id,ze=[],Ct=0,ve=[y.id],window.currentDrawingPath=ve,At())}else if(u&&Ge){const g=Ge.point;let y=Ce(ke);const S=fe[ke];if(S!==-1){const I=ce[S];I&&I.type==="colormap"&&(y=He(I,0))}const m={id:wt(),...g,type:"regular",color:y};oe.push(m),Xe=!0,Ke=m.id,ze=[],Ct=0,ve=[m.id],window.currentDrawingPath=ve,At()}It=!1,e.preventDefault();return}}if(It=!0,Pe=!1,$n=!1,et){const f=(z.colorTargetIcons||[]).filter(h=>K.x>=h.x&&K.x<=h.x+h.width&&K.y>=h.y&&K.y<=h.y+h.height);if(f.length>0){const h=f[f.length-1],{element:u,shiftKey:p,ctrlKey:g}={element:h,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};p?Oe.includes(u.target)||Oe.push(u.target):g?Oe.includes(u.target)?Oe=Oe.filter(y=>y!==u.target):Oe.push(u.target):Oe=[u.target],tt(),Q={target:"ui_icon_click",element:{...h,type:"colorTargetIcon"}},de.style.cursor="default";return}for(const h of z.colorSwatches)if(K.x>=h.x&&K.x<=h.x+h.width&&K.y>=h.y&&K.y<=h.y+h.height){Q={target:"ui_swatch",element:{...h}},de.style.cursor="default";return}}if(ah(K,e.shiftKey,e.ctrlKey||e.metaKey)){Q={target:"ui"},de.style.cursor="default";return}if(Kd(e)){Q={target:"coord_system"};return}const n=hr(K);let i=n?null:Is(K),o=!n&&!i?xs(K):null,s=!n&&!i&&!o?vs(K):null;const a=e.shiftKey||e.ctrlKey||e.metaKey,r=n||i||o||s;let c=!1;n?c=ue.includes(n.id):i?c=le.includes(i.id)||me.includes(i.id):o?c=re.includes(ee(o)):s&&(c=se.includes(he(s))),!Xe&&!a&&r&&!c&&(n?ct([],[],[],!1,!1,!1,[n.id]):i?ct([i.id],[],[],!1,!1,i.type!=="regular"):o?ct([],[ee(o)],[],!1,!1):s&&ct([],[],[he(s)],!1,!1));let l=null;if(n)l=be(K);else if(i)l=i;else if(o){const f=Y(o.id1),h=Y(o.id2);l=St(be(K),f,h)}else s&&(l=be(K));const d=Le&&(le.length>0||re.length>0||se.length>0||ue.length>0);ie=[],ge=[],Q={targetVertex:i,dragHandle:l,targetEdge:o,targetFace:s,targetText:n,target:r||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:d},i&&i.type!=="regular"&&(cs=!0,ji(i.id,e.shiftKey,e.ctrlKey||e.metaKey))}function Sh(){$e();const e=[...le],t=[...re],n=[...se],i=[...me],o=Le;le=[],re=[],se=[],me=[],ue=[],Le=null;const s=parseInt(mt,10)||1;let a=null;const r=Pe&&ie.length===1&&Q?.finalSnapResult?.snapType==="edge",c=new Set(rs.map(y=>y.id));if(c.size>0){const y=new Map(rs.map(M=>[M.id,M])),S=new Set(e);t.forEach(M=>{const[w,b]=M.split(ps);w&&S.add(w),b&&S.add(b)}),n.forEach(M=>{const w=J.find(b=>he(b)===M);w&&xr(w.id,J).forEach(C=>S.add(C))});const m=Ne?null:cr(),{center:I,rotation:x=0,scale:v=1,directionalScale:A=!1,startVector:T}=Ne||{},E=-x*(180/Math.PI);Ye.forEach(M=>{if(!c.has(M.id))return;const w=y.get(M.id)||M,b=lr(w);if(w.anchorType!=="canvas"&&!b)return;const C=w.anchorType==="canvas"?w.position||M.position:b.anchor,_=w.anchorType==="canvas"?{x:0,y:0}:w.offset||{x:0,y:0},P=w.anchorType==="canvas"?w.position||M.position||{x:0,y:0}:{x:C.x+_.x,y:C.y+_.y},D=(()=>{if(w.anchorType==="vertex")return S.has(w.anchorId);if(w.anchorType==="edge"){if(t.includes(w.anchorId))return!0;const R=X.find(N=>ee(N)===w.anchorId);return R?S.has(R.id1)&&S.has(R.id2):!1}if(w.anchorType==="face"){if(n.includes(w.anchorId))return!0;const R=J.find(N=>he(N)===w.anchorId);return R?R.vertexIds.every(N=>S.has(N)):!1}return!1})();if(Ne){const R=Be(P,I,x,v,A,T);if(M.rotationDeg=(w.rotationDeg||0)+E,M.scale=(w.scale||1)*v,w.anchorType==="canvas")M.position=R;else{const N=D?Be(C,I,x,v,A,T):C,B={x:R.x-N.x,y:R.y-N.y};if(M.offset=B,M.anchorType==="edge"){const k=Si(M.anchorId,B);typeof k=="number"&&(M.edgeOffsetFactor=k)}}}else if(m){if(w.anchorType==="canvas"){const R=w.position||M.position||{x:0,y:0};M.position={x:R.x+m.x,y:R.y+m.y}}else if(!D){const R=w.offset||{x:0,y:0},N={x:R.x+m.x,y:R.y+m.y};if(M.offset=N,M.anchorType==="edge"){const B=Si(M.anchorId,N);typeof B=="number"&&(M.edgeOffsetFactor=B)}}}})}if(r){const y=Q.finalSnapResult,S=ie[0].id,m=y.targetEdge,I=Y(S);if(I&&m){const x=JSON.parse(JSON.stringify(X)),v=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;I.x=y.pos.x,I.y=y.pos.y,X=X.filter(E=>ee(E)!==ee(m));const A=Y(m.id1),T=Y(m.id2);X.push(Gn(A,I,v,Ce)),X.push(Gn(T,I,v,Ce)),Kn(x,X)}}else if(Ne){const{center:y,rotation:S,scale:m,directionalScale:I,startPos:x}=Ne,v={x:x.x-y.x,y:x.y-y.y};ie.forEach(A=>{const T=Y(A.id);if(T){const E=Be(A,y,S,m,I,v);T.x=E.x,T.y=E.y}})}else if(ge.length>0){const y=Q.finalSnapResult&&Q.finalSnapResult.snapped?Q.finalSnapResult.finalDelta:{x:ge[0].x-ie[0].x,y:ge[0].y-ie[0].y},S=ie.filter(m=>m.type==="regular");if(s>1&&S.length>0){const m=new Set(S.map(P=>P.id)),I=new Set(se),x=new Set(re);se.forEach(P=>{const D=J.find(R=>he(R)===P);D&&D.vertexIds.forEach(R=>m.add(R))});const v=new Set;se.forEach(P=>{const D=J.find(R=>he(R)===P);if(D)for(let R=0;R<D.vertexIds.length;R++){const N=D.vertexIds[R],B=D.vertexIds[(R+1)%D.vertexIds.length];v.add(ee({id1:N,id2:B}))}});const A=X.filter(P=>{const D=ee(P);return x.has(D)||v.has(D)?!0:m.has(P.id1)&&m.has(P.id2)}),T=se.length>0?J.filter(P=>I.has(he(P))):J.filter(P=>P.vertexIds.every(D=>m.has(D))),E=X.filter(P=>m.has(P.id1)&&!m.has(P.id2)||m.has(P.id2)&&!m.has(P.id1)),M=[],w=[],b=[];a={vertices:[],edges:[],faces:[],texts:[]};const C=new Set(ue),_=Ye.filter(P=>{if(C.has(P.id))return!0;if(P.anchorType==="vertex")return m.has(P.anchorId);if(P.anchorType==="edge"){const D=X.find(R=>ee(R)===P.anchorId);return D?m.has(D.id1)&&m.has(D.id2):!1}if(P.anchorType==="face"){if(I.has(P.anchorId))return!0;const D=J.find(R=>he(R)===P.anchorId);return D?D.vertexIds.every(R=>m.has(R)):!1}return!1});for(let P=1;P<s;P++){const D=new Map,R=[],N=[],B=[],k=[];S.forEach(L=>{const V={x:L.x+y.x*P,y:L.y+y.y*P},F={...L,...V,id:wt()};M.push(F),D.set(L.id,F.id),R.push(F.id)}),A.forEach(L=>{const V=D.get(L.id1),F=D.get(L.id2);if(V&&F){const O={...L,id1:V,id2:F};w.push(O),N.push(ee(O))}}),E.forEach(L=>{const V=m.has(L.id1)?L.id2:L.id1,F=m.has(L.id1)?L.id1:L.id2,O=D.get(F);if(O){const H={...L,id1:O,id2:V};w.push(H)}}),T.forEach(L=>{const V=zn.get(L.id),F=L.vertexIds.map(O=>D.get(O));if(F.every(Boolean)){const O=JSON.parse(JSON.stringify(L));if(O.id=he({vertexIds:F}),O.vertexIds=F,O.localCoordSystem&&V){const H={x:y.x*P,y:y.y*P};O.localCoordSystem.origin.x=V.origin.x+H.x,O.localCoordSystem.origin.y=V.origin.y+H.y}b.push(O),B.push(O.id)}}),_.forEach(L=>{const V=JSON.parse(JSON.stringify(L));if(V.id=wt(),L.anchorType==="canvas"){if(!V.position)return;V.position={x:V.position.x+y.x*P,y:V.position.y+y.y*P}}else if(L.anchorType==="vertex"){const F=D.get(L.anchorId);if(!F)return;V.anchorId=F}else if(L.anchorType==="edge"){const F=X.find(U=>ee(U)===L.anchorId);if(!F)return;const O=D.get(F.id1),H=D.get(F.id2);if(!O||!H)return;V.anchorId=ee({id1:O,id2:H})}else if(L.anchorType==="face"){const F=J.find(H=>he(H)===L.anchorId);if(!F)return;const O=F.vertexIds.map(H=>D.get(H));if(!O.every(Boolean))return;V.anchorId=he({vertexIds:O})}Ye.push(V),C.has(L.id)&&k.push(V.id)}),P===1&&(a={vertices:R,edges:N,faces:B,texts:k})}oe.push(...M),X.push(...w),J.push(...b)}else s===1&&ie.forEach(m=>{const I=Y(m.id);I&&(I.x=m.x+y.x,I.y=m.y+y.y)})}const l=new Set(ie.map(y=>y.id)),d=J.filter(y=>y.vertexIds.some(S=>l.has(S)));d.length>0&&d.forEach(y=>{const S=zn.get(y.id);if(y.localCoordSystem&&S){const m=new Set(y.vertexIds),I=new Set(ie.map(v=>v.id));if([...m].every(v=>I.has(v))){if(Ne){const{center:v,rotation:A,scale:T,directionalScale:E,startPos:M}=Ne,w={x:M.x-v.x,y:M.y-v.y},b=Be(S.origin,v,A,T,E,w);if(y.localCoordSystem.origin=b,E){const C=Gt({x:1,y:0},S),_=Be(C,v,A,T,E,w);y.localCoordSystem.scale=j(b,_)}else y.localCoordSystem.angle=Zt(S.angle+A),y.localCoordSystem.scale=S.scale*T}else if(s===1){const v=Q.finalSnapResult&&Q.finalSnapResult.snapped?Q.finalSnapResult.finalDelta:{x:ge[0].x-ie[0].x,y:ge[0].y-ie[0].y};y.localCoordSystem.origin.x=S.origin.x+v.x,y.localCoordSystem.origin.y=S.origin.y+v.y}}else{const v=y.vertexIds.map(A=>Y(A)).filter(Boolean);th(y,S,ie,v,Y)}}}),Zd(Array.from(l),Ne);const{vertexMerges:f,edgeSplits:h}=Nh(oe,X,te),u=new Map;oe.forEach(y=>u.set(y.id,y.id));const p=y=>{if(!u.has(y)||u.get(y)===y)return y;const S=p(u.get(y));return u.set(y,S),S};f.forEach((y,S)=>{const m=p(S),I=p(y);m!==I&&u.set(I,m)});const g=new Set;if(oe.forEach(y=>{const S=p(y.id);y.id!==S&&g.add(y.id)}),g.size>0||h.size>0){const y=JSON.parse(JSON.stringify(X)),S=nh(J,p);X.forEach(m=>{m.id1=p(m.id1),m.id2=p(m.id2)}),oe=oe.filter(m=>!g.has(m.id)),X=X.filter((m,I,x)=>m.id1!==m.id2&&I===x.findIndex(v=>ee(v)===ee(m))),Kn(y,X),J.forEach(m=>{const I=S.get(m.id);I&&(m.localCoordSystem=I)}),Jn()}s>1&&a?(le=e.length>0?a.vertices.map(y=>p(y)):[],re=t.length>0?a.edges:[],se=n.length>0?a.faces:[],ue=rs.length>0?a.texts:[]):s===1&&(le=e.map(y=>p(y)),re=t,se=n,ue=rs.map(y=>y.id).filter(y=>Ye.some(S=>S.id===y))),me=i,Le=o,_o(),At()}function Ih(e){const{shiftKey:t,ctrlKey:n,targetVertex:i,targetEdge:o,targetFace:s,targetText:a}=e,r=Y(Ke);if(Xe&&r){$e();const c=JSON.parse(JSON.stringify(X)),l=Hs(r,K,t);let d=null;const f=G.alpha2>G.alpha1&&G.interval2?G.interval2:G.interval1;if(l.snapType==="vertex"&&l.targetVertex)d=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)d=vr(l.targetEdge,{x:l.x,y:l.y},f,Ce);else{let h=Ce(ke);const u=fe[ke];if(u!==-1){const p=ce[u];p&&p.type==="colormap"&&(h=He(p,.5))}d={id:wt(),x:l.x,y:l.y,type:"regular",color:h},oe.push(d)}if(d){if(!X.some(p=>p.id1===r.id&&p.id2===d.id||p.id2===r.id&&p.id1===d.id)){const p=Gn(r,d,f,Ce);X.push(p),Kn(c,X),_o(),J.forEach(g=>{g.color||(g.color=Ce(Fe))})}const u=Da(r,d,X);u&&(ze.length>0&&(ze[ze.length-1].turn=u.turnAngleRad),ze.push({length:u.length,turn:0,endVertexColor:d.color}),Ct=ze.length-1,ln=u.startVertex,nt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,bn=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,yt=u.turnAngleRad,vn=u.precedingSegmentAbsoluteAngleRad),ve.push(d.id),window.currentDrawingPath=ve,Cr(),Mr(),At(),Ke=d.id}if(t&&d&&l){const h=Da(r,d,X);h&&(ln=h.startVertex,nt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):h.length,bn=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,yt=h.turnAngleRad,vn=h.precedingSegmentAbsoluteAngleRad)}ae.count=0}else if(e.target==="canvas"){$e();const c=we||be(K);let l=Ce(ke);const d=fe[ke];if(d!==-1){const h=ce[d];h&&h.type==="colormap"&&(l=He(h,0))}const f={id:wt(),...c,type:"regular",color:l};oe.push(f),Xe=!0,Ke=f.id,ze=[],Ct=0,ve=[f.id],window.currentDrawingPath=ve,At()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(a||i||o||s)){$e();const l=a?a.id:s?he(s):o?ee(o):i.id;let d;switch(a?d="text":s?d="face":i&&i.type!=="regular"?d="center":i?d="vertex":o&&(d="edge"),l&&ae.targetId===l&&Date.now()-ae.timestamp<fo?ae.count++:ae.count=1,ae.targetId=l,ae.type=d,ae.timestamp=Date.now(),ae.count){case 1:ae.type==="text"?ct([],[],[],t,n,!1,[ae.targetId]):ae.type==="face"?ct([],[],[ae.targetId],t,n):ae.type==="edge"?ct([],[ae.targetId],[],t,n):ae.type==="vertex"?ct([ae.targetId],[],[],t,n):ae.type==="center"&&ji(ae.targetId,t,n);break;case 2:if(ae.type==="text"){const h=Bs(ae.targetId);h&&fr(h,h.content||"")}else if(ae.type==="vertex"){const h=Yt(ae.targetId,X);ct([ae.targetId,...h],[],[],t,n)}else if(ae.type==="edge"){const h=X.find(u=>ee(u)===ae.targetId);if(h){const u=[...xi(h.id1),...xi(h.id2)];ct([],Array.from(new Set(u.map(p=>ee(p)))),[],t,n)}}else if(ae.type==="face"){const h=J.find(u=>he(u)===ae.targetId);if(h){const u=[],p=new Set;for(let g=0;g<h.vertexIds.length;g++){const y=h.vertexIds[g],S=h.vertexIds[(g+1)%h.vertexIds.length];p.add(ee({id1:y,id2:S}))}J.forEach(g=>{if(he(g)!==he(h))for(let y=0;y<g.vertexIds.length;y++){const S=g.vertexIds[y],m=g.vertexIds[(y+1)%g.vertexIds.length];if(p.has(ee({id1:S,id2:m}))){u.push(he(g));break}}}),ct([],[],[he(h),...u],t,n)}}break;case 3:if(ae.type==="vertex"||ae.type==="edge"||ae.type==="face"){let h;if(ae.type==="vertex")h=ae.targetId;else if(ae.type==="edge")h=ae.targetId.split(ps)[0];else if(ae.type==="face"){const u=J.find(p=>he(p)===ae.targetId);u&&(h=u.vertexIds[0])}if(h){const u=new Set(zs(h));if(ae.type==="vertex")ct(Array.from(u),[],[],t,n);else if(ae.type==="edge"){const p=X.filter(g=>u.has(g.id1)&&u.has(g.id2)).map(g=>ee(g));ct([],p,[],t,n)}else if(ae.type==="face"){const p=J.filter(g=>g.vertexIds.every(y=>u.has(y))).map(g=>he(g));ct([],[],p,t,n)}}}ae.count=0;break}const f=[];se.length>0&&f.push(Fe),re.length>0&&f.push(qe),le.length>0&&f.push(ke),ue.length>0&&f.push(pt),f.length>0&&(Oe=f,et&&tt())}}}function xh(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),i=`icon-${t.target}`;if(ae.targetId===i&&n-ae.timestamp<fo){switch($e(),t.target){case ke:Co=!Co;break;case qe:Mo=!Mo;break;case Fe:cn=!cn;break}tt(),ae.count=0}ae.targetId=i,ae.timestamp=n;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),i=`swatch-${t.index}`;if(ae.targetId===i&&n-ae.timestamp<fo){Eo=!0,_s=t.index;const o=ce[t.index];let s;if(o.type==="color"){const a=Ns(o.value);s={type:"colormap",points:[{pos:.5,alpha:a.a,color:[a.r,a.g,a.b],order:1}]}}else o.type==="colormap"&&(s={type:"colormap",points:o.vertices.map(a=>({pos:a.pos,alpha:a.alpha!==void 0?a.alpha:1,color:Array.isArray(a.color)?[...a.color]:[a.color.r||0,a.color.g||0,a.color.b||0],order:a.order||1})),isCyclic:o.isCyclic===!0});gn.show(void 0,void 0,s),ae.count=0}else Oe.length>0&&($e(),Oe.forEach(o=>fe[o]=t.index),Wi(),tt());ae.targetId=i,ae.timestamp=n;return}}function vh(e){if(ls||Vn){if(ls){if(z.colorTargetIcons.find(n=>n.target===Rt.target)){const n=z.colorSwatches,i=Ha(K,n);i&&(fe[Rt.target]=i.index,Wi())}}else if(Vn){const t=z.removeColorButton;if(t&&K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height&&ce.length>1){const i=ce.indexOf(ft.item);i!==-1&&qi(i)}}ls=!1,Rt=null,Vn=!1,ft=null,Dn=!1,tt()}else Pe?Sh():Q&&(typeof Q.target=="string"&&Q.target.startsWith("ui")?xh(Q):Ih(Q));Pr()}function bh(e){It=!0,Cn=!1,ir=Mt,Q={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function Ch(e){if(Pe&&Cn){const t=be({x:Math.min(Mt.x,K.x),y:Math.min(Mt.y,K.y)}),n=be({x:Math.max(Mt.x,K.x),y:Math.max(Mt.y,K.y)}),i=Math.min(t.x,n.x),o=Math.max(t.x,n.x),s=Math.min(t.y,n.y),a=Math.max(t.y,n.y),r=oe.filter(u=>u.type==="regular"&&u.x>=i&&u.x<=o&&u.y>=s&&u.y<=a).map(u=>u.id),c=oe.filter(u=>u.type!=="regular"&&u.x>=i&&u.x<=o&&u.y>=s&&u.y<=a).map(u=>u.id),l=new Set(r),d=X.filter(u=>l.has(u.id1)&&l.has(u.id2)).map(u=>ee(u)),f=J.filter(u=>u.vertexIds.every(p=>l.has(p))).map(u=>he(u));Q.shiftKey?(le=[...new Set([...le,...r])],re=[...new Set([...re,...d])],se=[...new Set([...se,...f])],me=[...new Set([...me,...c])]):Q.ctrlKey?(r.forEach(u=>{const p=le.indexOf(u);p>-1?le.splice(p,1):le.push(u)}),d.forEach(u=>{const p=re.indexOf(u);p>-1?re.splice(p,1):re.push(u)}),f.forEach(u=>{const p=se.indexOf(u);p>-1?se.splice(p,1):se.push(u)}),c.forEach(u=>{const p=me.indexOf(u);p>-1?me.splice(p,1):me.push(u)})):(le=r,re=d,se=f,me=c);const h=[];se.length>0&&h.push(Fe),re.length>0&&h.push(qe),le.length>0&&h.push(ke),ue.length>0&&h.push(pt),h.length>0&&(Oe=h,et&&tt())}else sh(e)}function Mh(e){e.preventDefault();const t=Cs(e,de),n=e.deltaY>0?1/1.15:1.15;vi(t,n)}function Th(){Fs=!0}function Eh(){Fs=!1,br()}function Ph(e){e.preventDefault()}function wh(e,t){const n=parseInt(mt||"1",10)||1,i=Mc(ie,oe,X,Y,e,n,te),o=i.finalDelta;ie.forEach(s=>{const a=ge.find(r=>r&&r.id===s.id);a&&(a.x=s.x+o.x,a.y=s.y+o.y)}),Er(o,i),Q.finalSnapResult=i}function Ah(e){if(cn&&oe.length>0&&(za(xe,{allFaces:J,hoveredFaceId:Wt,selectedFaceIds:se,colors:e,isDragConfirmed:Pe,dragPreviewVertices:ge,currentAltPressed:ut},pe,Y,he),se.length>0&&nr(xe,{allFaces:J,selectedFaceIds:se,colors:e,isDragConfirmed:Pe,dragPreviewVertices:ge,initialDragVertexStates:ie,transformIndicatorData:Ne,highlightedEdgeForSnap:Qt,draggedFaceId:Ys,coordSystemSnapAngle:ms,coordSystemSnapType:Wn,coordSystemSnapScale:Kt,initialCoordSystemStates:zn},pe,Y)),Xe&&Ee&&(nt!==null||yt!==null)&&ve.length>=1&&ln){const i=Y(ln.id);if(i){const o={frozen_Origin_Data_to_display:i,displayAngleA_valueRad_for_A_equals_label:yt,frozen_A_baseRad_to_display:vn,frozen_D_du_to_display:nt,frozen_D_g2g_to_display:bn};Zc(xe,o,pe,be,{showAngles:pn,showDistances:qt,viewTransform:te,mousePos:K,colors:e}),Qc(Ze,o,{showAngles:pn,showDistances:qt,viewTransform:te,mousePos:K,frozenReference_D_du:nt,distanceSigFigs:_n,angleDisplayMode:Ot,colors:e},be,pe,at)}}const t={lastGridState:G,showDistances:qt,showAngles:pn,distanceSigFigs:_n,angleDisplayMode:Ot,angleSigFigs:ro,currentShiftPressed:Ee,viewTransform:te,colors:e};if(Pe){const i=new Set(ie.map(a=>a.id));let o=!1;if(ie.length>0){const a=new Set(zs(ie[0].id));o=!(i.size===a.size&&[...i].every(r=>a.has(r)))}const s=oe.map(a=>ge.find(c=>c.id===a.id)||a);if(o&&Ee)ie.forEach(a=>{Yt(a.id,X).some(c=>!i.has(c))&&As(xe,Ze,a.id,s,t,pe,c=>Yt(c,X),ee,Ee,null,at,le,!0,ie,Le,ot)});else if(Q&&(Q.targetVertex||Q.targetEdge)){const a=Q.targetVertex?Q.targetVertex.id:ie[0]?.id;a&&As(xe,Ze,a,s,t,pe,r=>Yt(r,X),ee,Ee,null,at,le,!0,ie,Le,ot),Q.targetEdge&&_a(xe,Ze,re,X,{showDistances:qt,distanceSigFigs:_n,colors:e,lastGridState:G,currentShiftPressed:Ee},Y,ee,pe,at,ge,ie,Ne)}}else(qt||pn)&&!Xe&&!(parseInt(mt||"1",10)>1&&Pe)&&!vt&&(le.length>0&&le.length<=Hl&&le.forEach(i=>{As(xe,Ze,i,oe,{...t,currentShiftPressed:!1},pe,o=>Yt(o,X),ee,!1,null,at,le,!1,[],Le)}),re.length>0&&re.length<=Gl&&(_a(xe,Ze,re,X,{showDistances:qt,distanceSigFigs:_n,colors:e,lastGridState:G},Y,ee,pe,at,ge,ie,Ne),gd(xe,Ze,re,X,{showAngles:pn,angleSigFigs:ro,angleDisplayMode:Ot,currentShiftPressed:Ee,distanceSigFigs:_n,viewTransform:te,lastGridState:G,colors:e},Y,ee,pe,i=>Yt(i,X),at)));const n=!ut&&(zt||sn||Wt);if(Xe&&Ke&&!n){const i=Y(Ke);if(i){const o=Zi(i.id),s=Hs(i,K,Ee);let a=Ce(qe),r=null;const c=fe[qe];if(c!==-1){const f=ce[c];if(f&&f.type==="colormap"&&ve&&ve.length>=1){const h=ve.length,u=ve.length-1,p=h>1?u/(h-1):0,g=h>1?(u+1)/h:1;r={colormapItem:f,startT:p,endT:g}}}Ua(xe,{startVertex:i,snappedData:s,isShiftPressed:Ee,currentColor:Ce(ke),nextCreationColor:Ce(ke),nextEdgeColor:a,colors:e,edgeColormapInfo:r},pe);const l={x:s.x,y:s.y};Ka(xe,Ze,i,l,s,{showDistances:qt,showAngles:pn,currentShiftPressed:Ee,distanceSigFigs:_n,angleSigFigs:ro,angleDisplayMode:Ot,viewTransform:te,frozenReference_D_du:nt,gridDisplayMode:je,frozenReference_A_rad:yt,colors:e},pe,o,at)}}if(we&&!n){const i={...we,id:"ghost",type:"regular"};Io(xe,i,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:Vt==="vertex"||Vt==="edge_fraction"||Vt==="edge"?Vt:null,currentAltPressed:ut},pe)}if(Cn&&Pe&&pd(xe,ir,K,e),Hc(xe,{info:{...bo,startVertex:Y(Ke)},colors:e},pe,Y,at),(Ne||Xt)&&jc(xe,Ze,{transformIndicatorData:Ne,colors:e,coordSystemTransformIndicatorData:Xt,currentShiftPressed:Ee},pe,at),we&&!n){const i={...we,id:"ghost",type:"regular"},o=Vt==="vertex"||Vt==="edge_fraction"||Vt==="edge";o?Io(xe,i,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:o?Vt:null,currentAltPressed:ut},pe):$i(xe,i,{colors:e,verticesVisible:!0,isSnapped:!0},pe)}}function _h(e){if(zt=null,sn=null,Wt=null,we=null,Vt=null,!It){if(!ut){const s=hr(e);if(s){s.id;return}}const t=Is(e),n=t?null:xs(e),i=!t&&!n?vs(e):null,o=t||n||i;if(ut)o?Qi(e,Ee):Ge=null,zt=null,sn=null,Wt=null;else if(t?zt=t.id:n?sn=ee(n):i&&(Wt=i.id),Ee&&!o){be(e);const s=Hs({id:"dummy_start",x:0,y:0},e,!0);s.snapped&&(we={x:s.x,y:s.y},Vt=s.snapType)}}}function Dh(e){if(Ke){const t=Y(Ke);if(t)if(Ee){const n=Hs(t,e,Ee);bo=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else bo=null}we=null}function kh(e,t,n,i){const o=Vd(n,e,t,i,lo);let s={},a={};if(i===_t)s=Xd(n,ie,t,o.rotation,e),a={rotation:s.rotation,scale:1,directionalScale:!1},lo=o.rotation;else if(i===dn)s=Hd(n,ie,t,o.scale),a={rotation:0,scale:s.scale||o.scale,directionalScale:!1};else if(i===Ft)s=Yd(n,ie,t,o.rotation,o.scale),a={rotation:s.rotation,scale:s.scale,directionalScale:!1},lo=o.rotation;else if(i===En){const f={x:t.x-n.x,y:t.y-n.y};s=Gd(n,ie,t,o.scale,f,e),a={rotation:0,scale:s.scale||o.scale,directionalScale:!0}}s.snapped&&s.snapType==="projection"&&s.projectionSource&&(we=s.projectionSource);const r={x:t.x-n.x,y:t.y-n.y};Ne={center:n,startPos:t,currentPos:s.pos||e,rotation:a.rotation,scale:a.scale,isSnapping:s.snapped||!1,transformType:i,directionalScale:a.directionalScale,snappedScaleValue:s.snappedScaleValue||null,gridToGridInfo:s.gridToGridInfo||null,gridPoint:s.gridPoint||null,nearbyVertex:s.nearbyVertex||null,projectionPoint:s.projectionPoint||null,projectionSource:s.projectionSource||null,snapType:s.snapType||null,projectionCenter:s.snapType==="projection"?n:null,projectionHandleInitial:s.projectionHandleInitial||null,startVector:r};const c={x:t.x-n.x,y:t.y-n.y};if(ge=ie.map(f=>{const h=Be(f,n,a.rotation,a.scale,a.directionalScale,c);return{...f,x:h.x,y:h.y}}),s.snapped&&s.snapType==="merge"&&s.mergingVertex&&s.mergeTarget){const f=ie.find(h=>h.id===s.mergingVertex.id);if(f){const h=ge.find(u=>u.id===f.id);if(h){const u={x:s.mergeTarget.x-h.x,y:s.mergeTarget.y-h.y};ge.forEach(p=>{p.x+=u.x,p.y+=u.y}),Ne.currentPos&&(Ne.currentPos.x+=u.x,Ne.currentPos.y+=u.y)}}}const l=_e*2/te.scale,d=oe.filter(f=>f.type==="regular"&&!ie.some(h=>h.id===f.id));ge.forEach(f=>{f.type==="regular"&&d.forEach(h=>{j(f,h)<l&&qn.push({x:h.x,y:h.y})})});for(let f=0;f<ge.length;f++)for(let h=f+1;h<ge.length;h++){const u=ge[f],p=ge[h];u.type==="regular"&&p.type==="regular"&&j(u,p)<l&&qn.push({x:(u.x+p.x)/2,y:(u.y+p.y)/2})}}function Rh(e){if(ls&&Rt){const t=z.colorTargetIcons.find(n=>n.target===Rt.target);if(t){const n=[...z.colorSwatches],i=Ha(e,n);i?(t.x=i.x+(i.width-t.width)/2,Rt.previewColorIndex=i.index):(t.x=e.x-Rt.offsetX,Rt.previewColorIndex=Rt.originalColorIndex)}return!0}if(Vn){const t=z.removeColorButton,n=t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height;if(n&&ce.length>1&&!Dn){Dn=!0;const s=ce.indexOf(ft.item);return s>=0&&(qi(s),tt()),!0}else if(!n&&Dn)return Dn=!1,ce.splice(ft.originalIndex,0,ft.item),Object.keys(fe).forEach(s=>{fe[s]>=ft.originalIndex&&fe[s]++}),Object.keys(ft.originalAssignments).forEach(s=>{ft.originalAssignments[s]===ft.originalIndex&&(fe[s]=ft.originalIndex)}),tt(),!0;if(Dn)return!0;const i=ce.indexOf(ft.item);let o=i;for(let s=0;s<z.colorSwatches.length;s++){const a=z.colorSwatches[s];if(e.x>=a.x&&e.x<=a.x+a.width){o=ce.indexOf(a.item);break}}if(o!==i){const s=ce[i];ce.splice(i,1),ce.splice(o,0,s),Object.keys(fe).forEach(a=>{fe[a]===i?fe[a]=o:fe[a]>i&&fe[a]<=o?fe[a]--:fe[a]<i&&fe[a]>=o&&fe[a]++}),tt()}return!0}return!1}function ea(){if(It||Xe){Ge=null,we=null,zt=null,sn=null,Wt=null;return}ut?Qi(K,Ee):(Ge=null,_h(K))}function Lh(e){if(K=Cs(e,de),Ee=e.shiftKey,ut=e.altKey,Ki(K)?de.style.cursor="default":vt?de.style.cursor="none":$n||Pe?de.style.cursor="grabbing":de.style.cursor="crosshair",It){if(!Pe&&j(K,Mt)>ul&&!Xe){if(Pe=!0,Q&&Q.target==="coord_system")return;if(Po=Q.dragHandle,To=Q.target==="edge",Q.target==="ui_icon_click")ls=!0,Rt={target:Q.element.target,offsetX:K.x-Q.element.x,offsetY:K.y-Q.element.y,originalColorIndex:fe[Q.element.target],previewColorIndex:fe[Q.element.target]},Q.target="ui_icon_drag",Oe=[Q.element.target];else if(Q.target==="ui_swatch")$e(),Vn=!0,ft={index:Q.element.index,item:Q.element.item,offsetX:K.x-Q.element.x,originalIndex:Q.element.index,originalAllColors:JSON.parse(JSON.stringify(ce)),originalAssignments:JSON.parse(JSON.stringify(fe))};else if(Ut===2){Cn=!0;return}else if(Q.target==="canvas")$n=!0,oi={x:te.offsetX,y:te.offsetY},de.style.cursor="move";else{de.style.cursor="grabbing",cs=Q.targetVertex&&Q.targetVertex.type!=="regular"&&!Q.isTransformDrag;let n;if(cs)n=[Q.targetVertex];else{let o=new Set(le);re.forEach(s=>{const[a,r]=s.split(ps);o.add(a),o.add(r)}),se.forEach(s=>{const a=J.find(r=>he(r)===s);a&&xr(a.id,J).forEach(c=>o.add(c))}),n=Array.from(o).map(s=>Y(s)).filter(s=>s&&s.type==="regular")}if(cs&&Q.targetVertex.type===_t){const o=Q.targetVertex,s=be(Mt),a={x:s.x-o.x,y:s.y-o.y};Q.initialRotationStartAngle=Math.atan2(a.y,a.x),lo=0}const i=ue.map(o=>Bs(o)).filter(Boolean);if(n.length>0||i.length>0){ie=JSON.parse(JSON.stringify(n)),ge=JSON.parse(JSON.stringify(n)),rs=JSON.parse(JSON.stringify(i)),yi=JSON.parse(JSON.stringify(i)),zn.clear();const o=new Set(ie.map(s=>s.id));J.forEach(s=>{s.vertexIds.some(a=>o.has(a))&&s.localCoordSystem&&zn.set(s.id,JSON.parse(JSON.stringify(s.localCoordSystem)))})}}}if(Pe){if($n){const t=K.x-Mt.x,n=K.y-Mt.y;te.offsetX=oi.x+t*Re,te.offsetY=oi.y-n*Re}else if(!Cn){if(Rh(K)||dh(e))return;if(Le&&(le.length>0||re.length>0||se.length>0||ue.length>0)&&!To){const n=Y(Le);let i=Po;!i&&ie.length>0&&(i=ie.find(o=>o.type==="regular"&&j(o,n)>1e-6)||ie.find(o=>o.type==="regular")),n&&i&&kh(be(K),i,n,n.type)}else if(ge.length>0){const n=ie.length===1&&ie[0].type==="regular",i=be(K);if(n){const o=ie[0];Yt(o.id,X).filter(a=>!ie.some(r=>r.id===a)).map(a=>Y(a));const s=Pd(o,i);if(ge[0].x=s.pos.x,ge[0].y=s.pos.y,ot.clear(),jn.clear(),s.snapped){const a={copyIndex:0,type:s.snapType,projectionLine:s.projectionLine};ot.set(o.id,[a]),s.targetEdge&&jn.set(ee(s.targetEdge),[{copyIndex:0,type:"external_to_static"}])}Q.finalSnapResult={...s,finalDelta:{x:s.pos.x-o.x,y:s.pos.y-o.y}}}else{const o=be(Mt),s={x:i.x-o.x,y:i.y-o.y};wh(s)}}else if(yi.length>0){const n=be(Mt),i=be(K),o={x:i.x-n.x,y:i.y-n.y};Q.textFinalDelta=o}}}}else Xe?Dh(K):ea()}function Er(e,t){if(ot.clear(),jn.clear(),!t||!t.snapped)return;const n=(i,o,s,a)=>{if(o===void 0)return;let r;if(s===void 0)r=void 0;else if(s===-1)r=0;else if(s>=0)r=s;else return;(r===void 0||r>=0)&&(i.has(o)||i.set(o,[]),i.get(o).some(c=>c.copyIndex===r&&c.type===a)||i.get(o).push({copyIndex:r,type:a}))};t.mergePairs.forEach(i=>{n(ot,i.source.originalId,i.source.transformIndex,"vertex"),n(ot,i.target.originalId,i.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:i,targetEdge:o})=>{n(ot,i.originalId,i.transformIndex,"edge"),n(jn,o.originalEdgeId,o.transformIndex,"vertex_on_edge")})}function Nh(e,t,n){const i=2*_e/n.scale,o=new Map,s=new Map,a=new Map;e.forEach(d=>a.set(d.id,d.id));const r=d=>{if(!a.has(d)||a.get(d)===d)return d;const f=r(a.get(d));return a.set(d,f),f};for(let d=0;d<e.length;d++)for(let f=d+1;f<e.length;f++){const h=e[d],u=e[f];if(h.type==="regular"&&u.type==="regular"&&j(h,u)<i){const p=r(h.id),g=r(u.id);p!==g&&a.set(g,p)}}e.forEach(d=>{const f=r(d.id);d.id!==f&&o.set(d.id,f)});const c=new Set(o.keys()),l=new Map(e.map(d=>[d.id,d]));return t.forEach(d=>{const f=r(d.id1),h=r(d.id2);if(f===h)return;const u=l.get(f),p=l.get(h);!u||!p||e.forEach(g=>{if(g.type!=="regular"||c.has(g.id)||g.id===f||g.id===h)return;const y=St(g,u,p);if(y.distance<i&&y.onSegmentStrict){const S=ee({id1:f,id2:h});s.has(S)||s.set(S,{edge:{id1:f,id2:h},pointsToInsert:[]}),s.get(S).pointsToInsert.push(g)}})}),{vertexMerges:o,edgeSplits:s}}function Oh(e){Mn?hh():Ut===0?vh():Ut===2&&Ch(e),Mn||Pr(),Ki(K)?de.style.cursor="default":vt||(de.style.cursor="crosshair"),Ms()}function Pr(){xt&&clearTimeout(xt),mt="",xt=null,It=!1,Pe=!1,Cn=!1,To=!1,cs=!1,$n=!1,ge=[],ie=[],yi=[],rs=[],Q=null,Ne=null,qn=[],we=null,jn.clear(),ot.clear(),zn.clear(),Ut=-1}function Fh(e){xt&&clearTimeout(xt),mt="",xt=null,st.style.display==="block"&&(st.style.display="none");const t=e.target;if(t&&t.closest(".katex")){e.stopPropagation();return}if((Xe||vt)&&e.button===2){Tn(),e.preventDefault();return}K=Cs(e,de),Mt={...K},Ut=e.button,Ut===0?mh(e):Ut===2&&bh(e)}function Bh(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;if(e.key==="Alt"&&!e.repeat&&(e.preventDefault(),ut=!0,ea()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!Xe&&!vt&&!It){e.preventDefault(),Td(e.key);return}const n=e.ctrlKey||e.metaKey;if(n&&(e.key==="a"||e.key==="A")){e.preventDefault();const o=oe.filter(c=>c.type==="regular").map(c=>c.id),s=X.map(c=>ee(c)),a=J.map(c=>he(c)),r=Ye.map(c=>c.id);ct(o,s,a,!1,!1,!1,r),me=oe.filter(c=>c.type!=="regular").map(c=>c.id),Le=me.length>0?me[me.length-1]:null;return}if(e.key==="Shift"&&!Ee){Ee=!0;const o=be(K);if(vt){const s=co(o);s&&(Xs=pe(s),we=s)}else if(Xe&&Ke){const s=Y(Ke);if(s){const a=zi(),r=Zi(s.id),c=Hs(s,K,Ee);let l=Ce(qe),d=null;const f=fe[qe];if(f!==-1){const u=ce[f];if(u&&u.type==="colormap"&&ve&&ve.length>=1){const p=ve.length,g=ve.length-1,y=p>1?g/(p-1):0,S=p>1?(g+1)/p:1;d={colormapItem:u,startT:y,endT:S}}}Ua(xe,{startVertex:s,snappedData:c,isShiftPressed:Ee,currentColor:Ce(ke),nextCreationColor:Ce(ke),nextEdgeColor:l,colors:a,edgeColormapInfo:d},pe),Ka(xe,Ze,s,c,c,{showDistances:qt,showAngles:pn,currentShiftPressed:Ee,distanceSigFigs:_n,angleSigFigs:ro,angleDisplayMode:Ot,viewTransform:te,frozenReference_D_du:nt,gridDisplayMode:je,frozenReference_A_rad:yt,colors:a},pe,r,at)}}else if(!It)if(Mn&&$t&&$t.type==="center"){const s=co(o);if(s){we=s;const a=$t.face,r=a.localCoordSystem,c=a.vertexIds.map(d=>Y(d)).filter(d=>d&&d.type==="regular"),l=ys(s,c);r.origin.x=l.x,r.origin.y=l.y,r.isCustom=!0}}else{const s=Is(K),a=s?null:xs(K),r=!s&&!a?vs(K):null;!s&&!a&&!r?we=co(o):we=null}}if(It&&Ut===0&&(Q?.targetVertex||Q?.targetEdge||Q?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(xt),xt===null||mt.length>=2?mt=e.key:mt+=e.key;const o=parseInt(mt,10)||1;if(Q?.finalSnapResult?.finalDelta){const s=Q.finalSnapResult.finalDelta,a={delta:s},c=Ga(ie,oe,X,Y,o,te,a,(l,d,f=a)=>({x:l.x+f.delta.x*d,y:l.y+f.delta.y*d}));Er(s,c),Q.finalSnapResult={...c,finalDelta:s}}xt=setTimeout(()=>{xt=null},500)}if(n&&e.key.toLowerCase()===oc){e.preventDefault(),Xe&&Ke&&qd();return}if(!(It&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(n&&[xa,ba,va,Qo,Ca,Ma,Ia,ma,Sa].includes(e.key.toLowerCase())))){if(Fs&&n&&(e.key===ma||e.key===Sa)){e.preventDefault();const o={x:de.width/Re/2,y:de.height/Re/2};vi(o,ca);return}if(Fs&&n&&e.key===Ia){e.preventDefault();const o={x:de.width/Re/2,y:de.height/Re/2};vi(o,1/ca);return}if(e.key===ec)e.preventDefault(),$d();else if(e.key===tc)Tn();else if(e.key===nc||e.key===sc)e.preventDefault(),Ws();else if(n&&e.key.toLowerCase()===xa)e.preventDefault(),Ir();else if(n&&e.key.toLowerCase()===ba)e.preventDefault(),Fd();else if(n&&e.key.toLowerCase()===va)e.preventDefault(),Bd();else if(n&&e.key.toLowerCase()===Qo&&!e.shiftKey)e.preventDefault(),rh();else if(n&&(e.key.toLowerCase()===Ca||e.shiftKey&&e.key.toLowerCase()===Qo))e.preventDefault(),lh();else if(n&&e.key.toLowerCase()===Ma&&!mi){e.preventDefault(),$e(),le=oe.filter(s=>s.type==="regular").map(s=>s.id),re=X.map(s=>ee(s)),se=J.map(s=>s.id),me=oe.filter(s=>s.type!=="regular").map(s=>s.id),Le=null;const o=[];se.length>0&&o.push(Fe),re.length>0&&o.push(qe),le.length>0&&o.push(ke),ue.length>0&&o.push(pt),o.length>0&&(Oe=o,et&&tt())}}}function $h(e){if(e.key==="Shift"&&(Ee=!1,we=null,Xs=null,qn=[],Mn&&$t&&$t.type==="center")){const t=be(K),n=$t.face,i=n.localCoordSystem,o=n.vertexIds.map(a=>Y(a)).filter(a=>a&&a.type==="regular"),s=ys(t,o);i.origin.x=s.x,i.origin.y=s.y,i.isCustom=!0}e.key==="Alt"&&(ut=!1,ea()),Ms()}function wr(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,i=t.offsetHeight;de.width=n*Re,de.height=i*Re,de.style.width=`${n}px`,de.style.height=`${i}px`,Ze&&(Ze.style.width=`${n}px`,Ze.style.height=`${i}px`)}function Vh(){xd(),ce=wi.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),Ad(),ur(),wr(),gn=new Or,gn.initialize(),document.body.appendChild(gn.getElement());const e=gn.getElement();e.addEventListener("mouseenter",()=>{mi=!0}),e.addEventListener("mouseleave",()=>{mi=!1}),gn.getElement().addEventListener("select",n=>{const i=n.detail,o=xc(i);if(o){if(Eo&&_s!==null)ce[_s]=o;else{kd(o);const s=ce.length-1;Oe.forEach(a=>{fe[a]=s})}Wi(),Eo=!1,_s=null,tt()}}),os=new Ur({container:document.body,onSelect:n=>{if(!n)return;const i={...n};i.id||(i.id=wt());const o=nn.findIndex(s=>s.id===i.id);o>=0?nn[o]=i:nn.push(i),rr(i.id),Lt&&pr(),Ms()}}),os.initialize(),te.scale=70,te.offsetX=de.width/2,te.offsetY=de.height/2,Un="regular",st=document.getElementById("context-menu"),window.addEventListener("click",()=>{st&&(st.style.display="none")}),st.addEventListener("mouseleave",()=>{st.style.display="none"}),Od()||$e(),Tr(),At()}de.addEventListener("wheel",Mh,{passive:!1});de.addEventListener("mouseenter",Th);de.addEventListener("mouseleave",Eh);window.addEventListener("contextmenu",Ph);de.addEventListener("mousemove",Lh);de.addEventListener("mouseup",Oh);de.addEventListener("mousedown",Fh);window.addEventListener("keyup",$h);window.addEventListener("keydown",Bh);window.addEventListener("resize",wr);window.addEventListener("beforeunload",()=>{Sr()});window.addEventListener("load",Vh);

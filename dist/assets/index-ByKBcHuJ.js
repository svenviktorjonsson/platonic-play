(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}})();const Hn="#3b82f6",Wn="#4a5568",zn="#718096",fa=300,Un="#242c3a",Ss=2,Go=3,ct=9,qn=12,ua=5,Ho=8,Mt=8,Wo=.9,zo=5,ln=[4,4],pa={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},ga={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class ya{constructor(e={},s={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...e},this.namedColormaps={},this.customColormaps={...s},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=pa,this.namedColormaps=ga,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(e){console.error("FATAL: Could not initialize ColorEditor.",e),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(s=>s.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(e,s,n=null){if(!this.wrapper)return;e!==void 0&&s!==void 0?(this.wrapper.style.left=`${e}px`,this.wrapper.style.top=`${s}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,o=1;if(n&&n.type==="colormap"&&(n.points||n.controlPoints)){this.state.isCyclic=n.isCyclic===!0;let a=JSON.parse(JSON.stringify(n.controlPoints||n.points));if(a.length===1){a[0].pos=.5;const l=a[0].color,c=l[0]/255,d=l[1]/255,f=l[2]/255;i=(c+d+f)/3,o=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(l=>{const c=l.color,d=l.alpha!==void 0?l.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,d,l.pos,l.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=o,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(e){this.state.isDirty!==e&&(this.state.isDirty=e)}restoreState(e){Object.assign(this.state,e),this.state.selectedPointIds=new Set(e.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const e=async n=>{const i=await fetch(n);if(!i.ok)throw new Error(`Failed to fetch preset file at ${n}: Status ${i.status}`);return await i.json()},s=n=>{try{const i=localStorage.getItem(n);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([e("named_colors.json"),s("custom_colors"),e("named_colormaps.json"),s("custom_colormaps")])}saveCustomPresets(e){const s=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(s)}async handlePresetClick(e){var i;const{name:s,type:n}=e.dataset;if(n==="named_colors"||n==="custom_colors"){let o;if(n==="named_colors"?o=this.namedColors[s]:o=(i=this.customColors[s])==null?void 0:i.rgb,!o){console.error(`RGB undefined for ${s} in ${n}`);return}this.applyColorToSelection(o)}else{if(this.state.isDirty&&s!==this.state.loadedColormapName){const o=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(o==="Cancel"||o==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(s,n)}}applyColorToSelection(e){this.markAsDirty();const s=e[0]/255,n=e[1]/255,i=e[2]/255;if(this.state.selectedPointIds.size===0){const o=this.state.points.length;o>0&&this.state.points.forEach(c=>{c.pos=c.pos*(o/(o+1))});const a=o===0?.5:1,l=this.createPointFromRgb(s,n,i,1,a,1);this.state.points.push(l),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const l=this.convertRgbToCurrentColorspace(s,n,i);a.hsPos=l.hsPos,a.originalHsPos={...l.hsPos},a.lightness=l.lightness}});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}loadColormap(e,s,n=!1){n||this.saveState();const i=s==="named_colormaps"?this.namedColormaps[e]:this.customColormaps[e];if(!i||!i.points){console.error(`Colormap '${e}' not found or is invalid.`);return}const o=i.points.map(a=>{var r;let l=[0,0,0];typeof a.color=="string"?l=this.namedColors[a.color]||((r=this.customColors[a.color])==null?void 0:r.rgb)||l:Array.isArray(a.color)&&(l=a.color);const c=l[0]/255,d=l[1]/255,f=l[2]/255,h=a.alpha??1;return this.createPointFromRgb(c,d,f,h,a.pos,a.order)});this.state.points=o,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,s==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=e,this.state.loadedColormapType=s,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const e=(Y,B={})=>{const F=document.createElement(Y);if(B.id){F.id=B.id;const j=B.id.replace(/-(\w)/g,(Z,pt)=>pt.toUpperCase());this.elements[j]=F}return B.className&&(F.className=B.className),B.text&&(F.textContent=B.text),B.type&&(F.type=B.type),B.placeholder&&(F.placeholder=B.placeholder),F};this.wrapper=e("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const s=e("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),n=e("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=e("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=e("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=e("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const o=e("div",{id:"selected-color-section",className:"control-section"}),a=e("div",{id:"current-colormap-section",className:"control-section"}),l=e("div",{className:"panel-header"});this.elements.tabRgbCube=e("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=e("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),l.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=e("div",{id:"hs-canvas-container",className:"canvas-container"}),d=e("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(e("canvas",{id:"hs-bg-canvas"}),d),s.append(l,c);const f=e("h2",{className:"panel-header",text:"Lightness"}),h=e("div",{id:"lightness-slider-container",className:"canvas-container"}),r=e("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});h.append(e("canvas",{id:"lightness-bg-canvas"}),r),n.append(f,h);const u=e("h2",{className:"panel-header",text:"Alpha"}),p=e("div",{id:"alpha-slider-container",className:"canvas-container"}),g=e("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});p.append(e("canvas",{id:"alpha-bg-canvas"}),g),i.append(u,p);const y=e("div",{className:"preset-category-header"});y.append(e("span",{className:"preset-category-title",text:"Colors"}),e("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,e("div",{className:"preset-items-container"}));const m=e("div",{className:"preset-category-header"});m.append(e("span",{className:"preset-category-title",text:"Colormaps"}),e("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(m,e("div",{className:"preset-items-container"}));const S=e("h3",{className:"section-title",text:"Selected Color"}),x=e("div",{className:"preview-container"});x.append(e("canvas",{id:"selected-color-preview-canvas"}));const C=e("div",{className:"space-y-2"}),b=e("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const v=e("div");v.append(e("h3",{className:"input-label",text:"Lightness"}),e("input",{type:"text",id:"lightness-input",className:"value-input"}));const M=e("div");M.append(e("h3",{className:"input-label",text:"Alpha"}),e("input",{type:"text",id:"alpha-input",className:"value-input"}));const I=e("div");I.append(e("h3",{className:"input-label",text:"Position"}),e("input",{type:"text",id:"position-input",className:"value-input"})),b.append(v,M,I),this.elements.rgbInputsContainer=e("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const A=e("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),E=e("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),_=e("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(A,E,_),this.elements.hslInputsContainer=e("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const T=e("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),P=e("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(T,P);const D=e("h3",{className:"input-label",text:"Interpolation"});D.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const k=e("div",{className:"interpolation-grid"});k.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=e("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=e("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=e("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),k.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),C.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,D,k),o.append(S,x,C);const N=e("h3",{className:"section-title text-center",text:"Current Colormap"}),w=e("div",{className:"preview-container"});w.append(e("canvas",{id:"colormap-preview-canvas"}));const R=e("div",{className:"button-container"});this.elements.reverseButton=e("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=e("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=e("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=e("button",{id:"select-button",className:"select-button",text:"Select"});const L=e("div",{className:"button-row"});L.append(this.elements.reverseButton,this.elements.cycleButton),R.append(L,this.elements.closeButton,this.elements.selectButton),a.append(N,w,R),this.elements.modalOverlay=e("div",{id:"modal-overlay",className:"modal-overlay hidden"});const O=e("div",{id:"modal-dialog",className:"modal-dialog"});O.append(e("h3",{id:"modal-title",className:"modal-title"}),e("div",{id:"modal-input-container",className:"hidden"}),e("div",{id:"modal-buttons",className:"modal-buttons"})),O.querySelector("#modal-input-container").append(e("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(O),this.elements.contextMenu=e("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(s,n,this.elements.colorsPresetsWrapper,o,i,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(d,"hs"),this.createInteractiveCanvas(r,"lightness"),this.createInteractiveCanvas(g,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(e=>{e.pos=1-e.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const s=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",s),this.elements.rgbGInput.addEventListener("change",s),this.elements.rgbBInput.addEventListener("change",s),this.elements.hslHInput.addEventListener("change",s),this.elements.hslSInput.addEventListener("change",s);const n=i=>{const o=i.target.closest(".preset-item");o&&(i.type==="click"?this.handlePresetClick(o):i.type==="contextmenu"&&o.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,o.dataset.name,o.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",n),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",n),this.elements.colormapsPresetsWrapper.addEventListener("click",n),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",n),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const o=this.state.points,a=o.length,l=(u,p)=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(g);return{pos:parseFloat((p!==void 0?p:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let p=0;p<u;p++){const g=o[p],y=o[(p+1)%a];i.push(l(g));const m=Math.max(g.order,y.order);if(m===0){let S=g.pos,x=y.pos;this.state.isCyclic&&x<S&&(x+=1);const C=S+(x-S)*.5;i.push(l(g,this.wrapPositionCyclic(C-1e-6))),i.push(l(y,this.wrapPositionCyclic(C)))}else if(m===3){const x=g.pos;let C=y.pos;this.state.isCyclic&&C<x&&(C+=1);const b=C-x;for(let v=1;v<16;v++){const M=v/16,I=x+M*b,A=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(I));if(A){const E=this.abstractToRgb(A.u,A.v,A.lightness),_=this.clampColor(E);i.push({pos:parseFloat(this.wrapPositionCyclic(I).toFixed(6)),alpha:parseFloat(A.alpha.toFixed(4)),color:[_.r,_.g,_.b],order:A.order})}}}}this.state.isCyclic||i.push(l(o[a-1]))}const c=new Map;i.forEach(u=>c.set(u.pos,u));let d=Array.from(c.values()).sort((u,p)=>u.pos-p.pos);if(this.state.isCyclic&&d.length>0){const u=d[0];d[d.length-1].pos<1-1e-6&&d.push({...u,pos:1})}const f=this.state.points.map(u=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),g=this.clampColor(p);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[g.r,g.g,g.b],order:u.order}}),h={points:d,controlPoints:f,isCyclic:this.state.isCyclic},r=new CustomEvent("select",{detail:h,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(r)})}setInterpolationMode(e){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(s=>{this.state.selectedPointIds.has(s.id)&&(s.order=e)}),this.elements.constantButton.classList.toggle("active",e===0),this.elements.linearButton.classList.toggle("active",e===1),this.elements.cubicButton.classList.toggle("active",e===3),this.drawAll())}showContextMenu(e,s,n){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const o={Rename:()=>this.handlePresetAction("rename",s,n),Delete:()=>this.handlePresetAction("delete",s,n)};for(const[a,l]of Object.entries(o)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=l,i.appendChild(c)}i.style.left=`${e.clientX}px`,i.style.top=`${e.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(e,s,n){if(this.hideContextMenu(),e==="delete")await this.showPrompt(`Delete "${s}"?`,["Delete","Cancel"])==="Delete"&&(n==="custom_colors"&&delete this.customColors[s],n==="custom_colormaps"&&delete this.customColormaps[s],this.saveCustomPresets(n),this.populatePresets());else if(e==="rename"){const i=await this.showPrompt(`Rename "${s}"`,["Rename","Cancel"],{value:s});if(i&&i!==s){const o=n==="custom_colors"?this.customColors:this.customColormaps;if(o[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}o[i]=o[s],delete o[s],this.saveCustomPresets(n),this.populatePresets()}}}async promptAndSaveNewPreset(e,s=""){const n=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:s});if(!n)return!1;if(e==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const o=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),a=this.clampColor(o);this.customColors[n]={rgb:[a.r,a.g,a.b],alpha:i.alpha}}else{const i=this.state.points.map(o=>{const a=this.abstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness),l=this.clampColor(a);return{pos:o.pos,alpha:o.alpha,color:[l.r,l.g,l.b],order:o.order}});this.customColormaps[n]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=n,this.state.loadedColormapType=e,this.setDirty(!1)}return this.saveCustomPresets(e),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const e=(o,a)=>{const l=document.createElement("div");l.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=o;const d=document.createElement("button");return d.className="add-preset-btn",d.textContent="+",d.onclick=a,l.appendChild(c),l.appendChild(d),l},s=(o,a,l,c)=>{Object.keys(a).sort().forEach(d=>{const f=document.createElement("div");f.className="preset-item",f.dataset.name=d,f.dataset.type=l,f.dataset.custom=c;const h=document.createElement("canvas");h.className="preset-icon",l.includes("colormap")?(h.width=64,h.height=16):(h.width=16,h.height=16);const r=document.createElement("span");if(r.textContent=d,f.appendChild(h),f.appendChild(r),o.appendChild(f),l==="named_colors"||l==="custom_colors"){const u=a[d],p=c?u.rgb:u;this.drawColorIcon(h,p)}else this.drawColormapIcon(h,a[d].points,this.namedColors,this.customColors)})},n=document.createElement("div");n.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(e("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(n),s(n,this.namedColors,"named_colors",!1),s(n,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(e("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),s(i,this.namedColormaps,"named_colormaps",!1),s(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(e,s,n,i){const o=s.map(f=>{let h=[0,0,0];typeof f.color=="string"?h=n[f.color]||(i[f.color]?i[f.color].rgb:[0,0,0]):Array.isArray(f.color)&&(h=f.color);const{hsPos:r,lightness:u}=this.convertRgbToCurrentColorspace(h[0]/255,h[1]/255,h[2]/255);return{id:Math.random(),hsPos:r,originalHsPos:{...r},lightness:u,alpha:f.alpha??1,pos:f.pos,order:1}}).sort((f,h)=>f.pos-h.pos),a=this.state.points;this.state.points=o;const l=e.getContext("2d"),{width:c,height:d}=e;if(this.drawCheckerboard(l),this.state.points.length>0)for(let f=0;f<c;f++){const h=f/(c-1),r=this.getInterpolatedPropertiesAt(h);if(!r)continue;const u=this.clampAbstractPoint(r.u,r.v,r.lightness),p=this.abstractToRgb(u.u,u.v,r.lightness),{r:g,g:y,b:m}=this.clampColor(p);l.fillStyle=`rgba(${g}, ${y}, ${m}, ${r.alpha})`,l.fillRect(f,0,1,d)}this.state.points=a}showPrompt(e,s,n=null){return new Promise(i=>{const{modalOverlay:o,modalTitle:a,modalInputContainer:l,modalInput:c,modalButtons:d}=this.elements,f=document.querySelectorAll("[data-tick-canvas]");f.forEach(h=>h.style.display="none"),a.textContent=e,d.innerHTML="",n?(c.value=n.value||"",c.placeholder=n.placeholder||"",l.classList.remove("hidden")):l.classList.add("hidden"),s.forEach(h=>{const r=document.createElement("button");r.className=`modal-button ${h==="Save"||h==="Delete"||h==="Rename"?"modal-button-primary":"modal-button-secondary"}`,r.textContent=h,r.onclick=()=>{o.classList.add("hidden"),f.forEach(u=>u.style.display=""),i(n?c.value:h)},d.appendChild(r)}),o.classList.remove("hidden"),n&&c.focus()})}restoreOriginalPositions(){for(const e of this.state.originalPositions){const s=this.state.points.find(n=>n.id===e.id);s&&(s.pos=e.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const e=this.state.points.some(n=>Math.abs(n.pos)<1e-6),s=this.state.points.some(n=>Math.abs(n.pos-1)<1e-6);if(e&&s){this.state.originalPositions=this.state.points.map(o=>({id:o.id,pos:o.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(o=>{o.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(e,s){const n=e.getContext("2d");n.fillStyle=`rgb(${s[0]}, ${s[1]}, ${s[2]})`,n.fillRect(0,0,e.width,e.height)}createPointFromRgb(e,s,n,i,o,a){const{hsPos:l,lightness:c}=this.convertRgbToCurrentColorspace(e,s,n);return{id:Date.now()+Math.random(),hsPos:l,originalHsPos:{...l},lightness:c,alpha:i,pos:o,order:a}}convertRgbToCurrentColorspace(e,s,n){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:e,g:s,b:n}),lightness:(e+s+n)/3};{const i=this.rgbToHsl(e,s,n);return{hsPos:this.rgbToHslDiConeAbstract(e,s,n),lightness:i.l}}}sortPoints(){this.state.points.sort((e,s)=>e.pos-s.pos||e.id-s.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const e=this.elements.interactiveCanvases.lightness,s=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:e,container:e.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:s,container:s.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(d=>{if(!d.c||!d.container)return;const{clientWidth:f,clientHeight:h}=d.container;(d.c.width!==f||d.c.height!==h)&&(d.c.width=f,d.c.height=h)});const i=this.elements.hsBgCanvas,o=this.elements.interactiveCanvases.hs,a=i.parentElement,l=a.clientWidth,c=a.clientHeight;[i,o].forEach(d=>{d&&(d.width=l,d.height=c,d.style.width=`${l}px`,d.style.height=`${c}px`,d.style.left="0px",d.style.top="0px")}),this.drawAll()}setColorSpace(e){const s=this.state.colorSpace;if(e===s)return;this.markAsDirty(),this.state.points.forEach(i=>{let o;s==="RGB_CUBE"?o=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):o=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let a,l;if(e==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(o),l=(o.r+o.g+o.b)/3;else{const c=this.rgbToHsl(o.r,o.g,o.b);a=this.rgbToHslDiConeAbstract(o.r,o.g,o.b),l=c.l}i.hsPos=a,i.originalHsPos={...a},i.lightness=l});const n=this.getLastSelectedPoint();n&&(this.state.viewLightness=n.lightness,this.state.viewAlpha=n.alpha),this.state.colorSpace=e,this.updateTabs(),this.drawAll()}handleMouseDown(e,s){if(e.button===2)return;e.preventDefault(),e.stopPropagation();const n=Date.now(),i=this.elements.interactiveCanvases[s];if(!i)return;const o=i.getBoundingClientRect(),a=i.width/o.width,l=i.height/o.height,c=(e.clientX-o.left)*a,d=(e.clientY-o.top)*l,f={x:c,y:d};let h=!1,r=null,u=!1;if(s==="hs")r=this.findHitPointHS(c,d);else{const m=this.findHitPointSlider(c,d,s);r=m.hitPoint,u=m.hitLine}if(n-this.lastClickTime<fa&&r&&r.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=n,this.lastClickTarget=r?r.id:null,r){this.state.viewLightness=r.lightness,this.state.viewAlpha=r.alpha;const m=e.ctrlKey||e.metaKey,S=e.shiftKey;!this.state.selectedPointIds.has(r.id)&&!m&&!S&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(r.id),this.state.lastSelectedPointId=r.id)}if(this.state.activeDrag.type=s,this.state.activeDrag.element=i,this.state.activeDrag.pointId=r?r.id:null,r){const m=new Map;if(s==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=d,this.state.activeDrag.initialPointPositions=new Map;const{scale:S,offsetX:x,offsetY:C}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const v=b.hsPos.u*S+x,M=b.hsPos.v*S+C;this.state.activeDrag.initialPointPositions.set(b.id,{x:v,y:M})}})}else this.state.points.forEach(S=>{this.state.selectedPointIds.has(S.id)&&m.set(S.id,{lightness:S.lightness-r.lightness,alpha:S.alpha-r.alpha,pos:S.pos-r.pos})}),this.state.activeDrag.offsets=m}else u?this.state.activeDrag.type=s+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const g=m=>{const S=(m.clientX-o.left)*a,x=(m.clientY-o.top)*l,C=Math.sqrt((S-f.x)**2+(x-f.y)**2);!h&&C>ua&&(h=!0,r&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(m)},y=m=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y),h||this.handleClick(c,d,s,r,m),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",g),document.addEventListener("mouseup",y)}handleClick(e,s,n,i,o){const{shiftKey:a,ctrlKey:l,metaKey:c}=o,d=l||c;if(i){const{selectedPointIds:f}=this.state,h=i.id;if(this.clickCount===3)this.state.points.forEach(r=>f.add(r.id)),this.state.lastSelectedPointId=h;else if(this.clickCount===2){const r=this.state.points.findIndex(p=>p.id===h);f.clear(),[r-1,r,r+1].forEach(p=>{p>=0&&p<this.state.points.length&&f.add(this.state.points[p].id)}),this.state.lastSelectedPointId=h}else d?f.has(h)?(f.delete(h),this.state.lastSelectedPointId===h&&(this.state.lastSelectedPointId=f.size>0?Array.from(f)[0]:null)):(f.add(h),this.state.lastSelectedPointId=h):a?(f.add(h),this.state.lastSelectedPointId=h):(f.clear(),f.add(h),this.state.lastSelectedPointId=h)}else if(n==="hs")this.createNewPointHS(e,s);else if(n==="lightness"||n==="alpha"){const f=this.elements.interactiveCanvases[n],h=Math.ceil(ct*2.2),r=f.height-2*h,p=(f.height-h-s)/r,g=Math.max(0,Math.min(1,p));n==="lightness"?this.state.viewLightness=g:this.state.viewAlpha=g}this.drawAll()}findHitPointHS(e,s){const n=Math.ceil(ct*2.2),i=Math.ceil(Mt/2),o=n+i,a=o,l=o,c=this.elements.hsBgCanvas.width-o-n,d=this.elements.hsBgCanvas.height-o-n;for(const f of this.state.points){const h=f.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,r=f.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-ct&&h<=a+c+ct&&r>=l-ct&&r<=l+d+ct&&Math.sqrt((e-h)**2+(s-r)**2)<=qn)return f}return null}handleInputChange(e,s){const n=e.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(s==="lightness"||s==="alpha"){const o=parseFloat(n);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[s]=o,s==="lightness"&&this.constrainPointToValidArea(a))}),i=!0)}else if(s==="position"){const o=parseFloat(n);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=o)}),this.sortPoints(),i=!0)}if(i){const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let e,s,n,i,o,a,l=!1;if(this.state.colorSpace==="RGB_CUBE"){if(e=parseInt(this.elements.rgbRInput.value,10),s=parseInt(this.elements.rgbGInput.value,10),n=parseInt(this.elements.rgbBInput.value,10),isNaN(e)||isNaN(s)||isNaN(n))return;this.markAsDirty(),e=Math.max(0,Math.min(255,e))/255,s=Math.max(0,Math.min(255,s))/255,n=Math.max(0,Math.min(255,n))/255;const c=this.rgbCubeRgbToAbstract({r:e,g:s,b:n}),d=(e+s+n)/3;this.state.points.forEach(f=>{this.state.selectedPointIds.has(f.id)&&(f.hsPos={...c},f.originalHsPos={...c},f.lightness=d)}),l=!0}else{if(i=parseFloat(this.elements.hslHInput.value),o=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(i)||isNaN(o))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),o=Math.max(0,Math.min(1,o));const c=this.hslToRgb(i,o,a),d=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(f=>{this.state.selectedPointIds.has(f.id)&&(f.hsPos={...d},f.originalHsPos={...d})}),l=!0}if(l){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(e,s){const n=document.createElement("canvas");n.className=`interactive-canvas ${s}-interactive`,n.dataset.type=s,e.appendChild(n),this.elements.interactiveCanvases[s]=n}handleMouseMove(e){if(!this.state.activeDrag.type)return;e.preventDefault();const{type:s,element:n,pointId:i}=this.state.activeDrag,o=n,a=o.getBoundingClientRect(),l=o.width/a.width,c=o.height/a.height,d=(e.clientX-a.left)*l,f=(e.clientY-a.top)*c;s.endsWith("-line")?this.handleLineDrag(f,o.height,s):i&&this.handlePointDrag(d,f,o,s),this.drawAll()}rgbCubeRgbToAbstract(e){const s=(e.r-e.g)/Math.sqrt(2),n=(e.r+e.g-2*e.b)/Math.sqrt(6);return{u:s,v:n}}rgbToHslDiConeAbstract(e,s,n){const i=this.rgbToHsl(e,s,n),o=1-Math.abs(2*i.l-1),a=i.s*o,l=i.h*2*Math.PI,c=a*Math.cos(l),d=a*Math.sin(l);return{u:c,v:d}}hslDiConeAbstractToRgb(e,s,n){const i=(Math.atan2(s,e)/(2*Math.PI)+1)%1,o=Math.sqrt(e*e+s*s),a=n,l=1-Math.abs(2*a-1);if(l<1e-9)return{r:a,g:a,b:a};const c=o/l;return this.hslToRgb(i,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(e){const s=document.activeElement,n=s&&s.tagName==="INPUT",i=e.ctrlKey||e.metaKey;if(i&&e.key==="z"){e.preventDefault(),this.undo();return}if(i&&e.key==="y"){e.preventDefault(),this.redo();return}if(n){e.key==="Escape"&&(e.preventDefault(),s.blur());return}if(i&&e.key==="a"){e.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(o=>this.state.selectedPointIds.add(o.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(e.key==="Escape"){e.preventDefault(),this.deselectAll();return}(e.key==="Delete"||e.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(o=>!this.state.selectedPointIds.has(o.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(e,s,n,i=null){let o=e,a=zo+1;const l=Math.ceil(ct*2.2),c=Math.ceil(Mt/2),d=l+c,f=s-d-l,h=s-l;return this.state.points.forEach(r=>{if(r.id===i)return;const u=h-r[n]*f,p=Math.abs(e-u);p<zo&&p<a&&(o=u,a=p)}),o}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(e=>e.id===this.state.lastSelectedPointId)}getPointById(e){return this.state.points.find(s=>s.id===e)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:e,viewAlpha:s,colorSpace:n}=this.state,i=this.elements.hsBgCanvas.width,o=this.elements.hsBgCanvas.height;if(i===0||o===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=Un,a.fillRect(0,0,i,o);const l=Math.ceil(ct*2.2),c=Math.ceil(Mt/2),d=l+c,f=i-d-l,h=o-d-l;if(f<=0||h<=0)return;const r=n==="RGB_CUBE"?Math.min(f,h)/(Math.sqrt(2/3)*2)*Wo:Math.min(f,h)/2*Wo;this.state.transform.scale=r,this.state.transform.offsetX=i/2,this.state.transform.offsetY=o/2;const u=d,p=d,g=f,y=h,m=Mt,S=Math.round(g/m),x=Math.round(y/m),C=g/S,b=y/x;for(let E=0;E<x;E++)for(let _=0;_<S;_++){const T=u+_*C,P=p+E*b;(E+_)%2===0?a.fillStyle=zn:a.fillStyle=Wn,a.fillRect(T,P,C,b)}if(n==="HSL_DI_CONE"&&1-Math.abs(2*e-1)<.01){const _=i/2,T=o/2,P=e<.5?0:255;a.fillStyle=`rgba(${P}, ${P}, ${P}, ${s})`,a.fillRect(Math.floor(_),Math.floor(T),1,1);return}const v=a.createImageData(g,y),M=v.data;for(let E=0;E<y;E++)for(let _=0;_<g;_++){const T=u+_,P=p+E,D=(T-this.state.transform.offsetX)/this.state.transform.scale,k=(P-this.state.transform.offsetY)/this.state.transform.scale,{r:N,g:w,b:R}=this.abstractToRgb(D,k,e),L=(E*g+_)*4;this.isValidColor(N,w,R)&&(M[L]=Math.round(N*255),M[L+1]=Math.round(w*255),M[L+2]=Math.round(R*255),M[L+3]=255)}const I=document.createElement("canvas");I.width=g,I.height=y,I.getContext("2d").putImageData(v,0,0),a.globalAlpha=s,a.drawImage(I,u,p),a.globalAlpha=1}evaluateCubicSpline(e,s){const n=this.state.points,i=n.length;if(e<0||e>=i)return null;let o,a,l,c;if(this.state.isCyclic){const u=p=>{const g=(p%i+i)%i;return n[g]};e===i-1?(o=u(e-1),a=u(e),l=u(0),c=u(1)):(o=u(e-1),a=u(e),l=u(e+1),c=u(e+2))}else a=n[e],l=n[e+1],o=e>0?n[e-1]:n[e],c=e+2<i?n[e+2]:n[e+1];const d=s,f=d*d,h=f*d,r=(u,p,g,y)=>.5*(2*p+(-u+g)*d+(2*u-5*p+4*g-y)*f+(-u+3*p-3*g+y)*h);return{u:r(o.hsPos.u,a.hsPos.u,l.hsPos.u,c.hsPos.u),v:r(o.hsPos.v,a.hsPos.v,l.hsPos.v,c.hsPos.v),lightness:r(o.lightness,a.lightness,l.lightness,c.lightness),alpha:r(o.alpha,a.alpha,l.alpha,c.alpha),order:2}}isValidColor(e,s,n){return e>=-.001&&e<=1.001&&s>=-.001&&s<=1.001&&n>=-.001&&n<=1.001}drawSliderBackgrounds(){const e=Math.ceil(ct*2.2),s=Math.ceil(Mt/2),n=e+s,i=this.elements.lightnessBgCanvas.getContext("2d"),o=this.elements.lightnessBgCanvas;i.fillStyle=Un,i.fillRect(0,0,o.width,o.height);const a=n,l=o.width-e,c=n,d=o.height-e,f=l-a,h=d-c;if(h>0&&f>0){const C=i.createLinearGradient(0,c,0,d);C.addColorStop(0,"white"),C.addColorStop(1,"black"),i.fillStyle=C,i.fillRect(a,c,f,h)}const r=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;r.fillStyle=Un,r.fillRect(0,0,u.width,u.height);const p=n,g=u.width-e,y=n,m=u.height-e,S=g-p,x=m-y;if(x>0&&S>0){const C=Mt,b=Math.round(S/C),v=Math.ceil(x/C),M=S/b,I=C,A=m-v*I;for(let _=0;_<v;_++)for(let T=0;T<b;T++){const P=p+T*M,D=A+_*I;if(D<m&&D+I>y){(_+T)%2===0?r.fillStyle=zn:r.fillStyle=Wn;const k=Math.max(D,y),N=Math.min(D+I,m)-k;N>0&&r.fillRect(P,k,M,N)}}const E=r.createLinearGradient(0,y,0,m);E.addColorStop(0,"white"),E.addColorStop(1,"rgba(255,255,255,0)"),r.fillStyle=E,r.fillRect(p,y,S,x)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(e,s){e.strokeStyle=Hn,e.lineWidth=1.5,e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=8,e.beginPath(),e.moveTo(0,s),e.lineTo(e.canvas.width,s),e.stroke(),e.shadowBlur=0}drawHSElements(){const e=this.elements.interactiveCanvases.hs;if(!e)return;const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height);const n=Math.ceil(ct*2.2),i=Math.ceil(Mt/2),o=n+i,a=o,l=o,c=e.width-o-n,d=e.height-o-n;if(this.state.points.length>1){const f=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let h=0;h<f;h++){const r=this.state.points[h],u=this.state.points[(h+1)%this.state.points.length];if(Math.max(r.order,u.order)===0)continue;let g=r.pos,y=u.pos;this.state.isCyclic&&y<g&&(y+=1);const m=y-g;if(m<1e-9)continue;const S=Math.max(10,Math.ceil(m*100)),x=[];for(let b=0;b<=S;b++){const v=g+b/S*m,M=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(v));if(!M)continue;const I=this.clampAbstractPoint(M.u,M.v,M.lightness),A=I.u*this.state.transform.scale+this.state.transform.offsetX,E=I.v*this.state.transform.scale+this.state.transform.offsetY;x.push({x:A,y:E,isOnPlane:Math.abs(M.lightness-this.state.viewLightness)<1e-10})}if(x.length<2)continue;const C=x.every(b=>b.isOnPlane);s.strokeStyle="black",s.lineWidth=Ss,s.globalAlpha=C?.7:.4,s.setLineDash(C?[]:ln),s.beginPath(),s.moveTo(x[0].x,x[0].y);for(let b=1;b<x.length;b++)s.lineTo(x[b].x,x[b].y);s.stroke(),s.setLineDash([])}this.drawLightnessIntersectionDots(s)}s.save(),s.beginPath(),s.rect(a,l,c,d),s.clip(),this.state.points.forEach(f=>{const h=f.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,r=f.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-ct&&h<=a+c+ct&&r>=l-ct&&r<=l+d+ct){const u=this.abstractToRgb(f.hsPos.u,f.hsPos.v,f.lightness),{r:p,g,b:y}=this.clampColor(u),m=this.state.selectedPointIds.has(f.id),S=f.id===this.state.lastSelectedPointId,x=Math.abs(f.lightness-this.state.viewLightness)<.01;switch(s.save(),s.beginPath(),f.order){case 0:this._drawCircle(s,h,r,ct);break;case 1:this._drawDroplet(s,h,r,ct);break;case 3:this._drawTriangle(s,h,r,ct);break;default:this._drawCircle(s,h,r,ct)}s.globalAlpha=f.alpha,s.fillStyle=`rgb(${p}, ${g}, ${y})`,s.fill(),s.globalAlpha=1,s.strokeStyle=m?Hn:"black",s.lineWidth=S?Go:Ss,s.setLineDash(x?[]:ln),s.stroke(),s.restore()}}),s.restore()}drawLightnessElements(){const e=this.elements.interactiveCanvases.lightness;if(!e)return;const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height);const n=Math.ceil(ct*2.2),i=Math.ceil(Mt/2),o=n+i,a=o,l=e.width-n,c=o,d=e.height-n,f=l-a,h=d-c;let r=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(r=p.lightness)}const u=d-r*h;this.drawHorizontalLine(s,u),this.drawConnectingLine(s,"lightness"),this.drawTicks(s,"lightness"),this.state.points.forEach(p=>{const g=a+p.pos*f,y=d-p.lightness*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:S,g:x,b:C}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),v=p.id===this.state.lastSelectedPointId;this.drawPoint(s,g,y,S,x,C,b,v,p.order)})}drawConnectingLine(e,s){if(this.state.points.length<2)return;e.save(),e.lineWidth=Ss;const n=this.state.points,i=n.length;if(s==="hs"){e.restore();return}const o=Math.ceil(ct*2.2),a=Math.ceil(Mt/2),l=o+a,c=l,d=e.canvas.height-o,f=e.canvas.width-l-o,h=d-l,r=c+f;if(f<=0){e.restore();return}const u=this.state.isCyclic?i:i-1;for(let p=0;p<u;p++){const g=n[p],y=n[(p+1)%i],m=Math.max(g.order,y.order),S=this.state.isCyclic&&p===i-1;if(m===0){const x=d-g[s]*h,C=d-y[s]*h,b=c+g.pos*f,v=c+y.pos*f;if(S&&g.pos>y.pos){let M=g.pos,I=y.pos+1;const A=M+(I-M)*.5,E=c+(A-Math.floor(A))*f,_=this.getInterpolatedPropertiesAt(g.pos),T=this.getInterpolatedPropertiesAt(y.pos);if(_){const P=this.abstractToRgb(_.u,_.v,_.lightness),D=this.clampColor(P);e.strokeStyle=`rgba(${D.r},${D.g},${D.b},${_.alpha})`,e.setLineDash([]),A>1?(e.beginPath(),e.moveTo(b,x),e.lineTo(r,x),e.stroke(),e.beginPath(),e.moveTo(c,x),e.lineTo(E,x),e.stroke()):(e.beginPath(),e.moveTo(b,x),e.lineTo(E,x),e.stroke())}if(T){const P=this.abstractToRgb(T.u,T.v,T.lightness),D=this.clampColor(P);e.strokeStyle=`rgba(${D.r},${D.g},${D.b},${T.alpha})`,e.setLineDash([]),A>1?(e.beginPath(),e.moveTo(E,C),e.lineTo(v,C),e.stroke()):(e.beginPath(),e.moveTo(E,C),e.lineTo(r,C),e.stroke(),e.beginPath(),e.moveTo(c,C),e.lineTo(v,C),e.stroke())}e.beginPath(),e.setLineDash(ln),e.strokeStyle="black",e.moveTo(E,x),e.lineTo(E,C),e.stroke()}else if(!S){let M=g.pos,I=y.pos;const A=M+(I-M)*.5,E=c+A*f,_=this.getInterpolatedPropertiesAt(g.pos),T=this.getInterpolatedPropertiesAt(y.pos);if(_){const P=this.abstractToRgb(_.u,_.v,_.lightness),D=this.clampColor(P);e.strokeStyle=`rgba(${D.r},${D.g},${D.b},${_.alpha})`,e.setLineDash([]);const k=p===0&&!this.state.isCyclic?c:b;e.beginPath(),e.moveTo(k,x),e.lineTo(E,x),e.stroke()}if(T){const P=this.abstractToRgb(T.u,T.v,T.lightness),D=this.clampColor(P);e.strokeStyle=`rgba(${D.r},${D.g},${D.b},${T.alpha})`,e.setLineDash([]);const k=p===u-1&&!this.state.isCyclic?r:v;e.beginPath(),e.moveTo(E,C),e.lineTo(k,C),e.stroke()}e.beginPath(),e.setLineDash(ln),e.strokeStyle="black",e.moveTo(E,x),e.lineTo(E,C),e.stroke()}}else if(e.setLineDash([]),S&&g.pos>y.pos){const x=d-g[s]*h,C=d-y[s]*h,b=c+g.pos*f,v=c+y.pos*f,M=1-g.pos;if(M>1e-6){const I=e.createLinearGradient(b,0,r,0),A=Math.max(2,Math.ceil(M*20));for(let T=0;T<=A;T++){const P=g.pos+T/A*M,D=this.getInterpolatedPropertiesAt(P);if(D){const k=this.abstractToRgb(D.u,D.v,D.lightness),{r:N,g:w,b:R}=this.clampColor(k);I.addColorStop(T/A,`rgba(${N}, ${w}, ${R}, ${D.alpha})`)}}const E=this.getInterpolatedPropertiesAt(1),_=E?d-E[s]*h:x;e.beginPath(),e.moveTo(b,x),e.lineTo(r,_),e.strokeStyle=I,e.stroke()}if(y.pos>1e-6){const I=e.createLinearGradient(c,0,v,0),A=Math.max(2,Math.ceil(y.pos*20));for(let T=0;T<=A;T++){const P=T/A*y.pos,D=this.getInterpolatedPropertiesAt(P);if(D){const k=this.abstractToRgb(D.u,D.v,D.lightness),{r:N,g:w,b:R}=this.clampColor(k);I.addColorStop(T/A,`rgba(${N}, ${w}, ${R}, ${D.alpha})`)}}const E=this.getInterpolatedPropertiesAt(0),_=E?d-E[s]*h:C;e.beginPath(),e.moveTo(c,_),e.lineTo(v,C),e.strokeStyle=I,e.stroke()}}else if(!S){const x=c+g.pos*f,C=c+y.pos*f,b=(v,M,I,A)=>{const E=M-v;if(Math.abs(E)<1e-9)return;const _=e.createLinearGradient(I,0,A,0),T=Math.ceil(Math.abs(A-I)/2);for(let P=0;P<=T;P++){const D=v+P/T*E,k=this.getInterpolatedPropertiesAt(D);if(!k)continue;const N=this.abstractToRgb(k.u,k.v,k.lightness),{r:w,g:R,b:L}=this.clampColor(N);_.addColorStop(P/T,`rgba(${w}, ${R}, ${L}, ${k.alpha})`)}e.beginPath();for(let P=0;P<=T;P++){const D=v+P/T*E,k=this.getInterpolatedPropertiesAt(D);if(!k)continue;const N=Math.max(0,Math.min(1,D)),w=c+N*f,R=d-k[s]*h;P===0?e.moveTo(w,R):e.lineTo(w,R)}e.strokeStyle=_,e.stroke()};if(p===0&&!this.state.isCyclic&&Math.abs(g.pos)>=1e-6){const v=this.getInterpolatedPropertiesAt(g.pos);if(v){const M=this.abstractToRgb(v.u,v.v,v.lightness),{r:I,g:A,b:E}=this.clampColor(M);e.strokeStyle=`rgba(${I}, ${A}, ${E}, ${v.alpha})`;const _=d-v[s]*h;e.beginPath(),e.moveTo(c,_),e.lineTo(x,_),e.stroke()}}if(b(g.pos,y.pos,x,C),p===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const v=this.getInterpolatedPropertiesAt(y.pos);if(v){const M=this.abstractToRgb(v.u,v.v,v.lightness),{r:I,g:A,b:E}=this.clampColor(M);e.strokeStyle=`rgba(${I}, ${A}, ${E}, ${v.alpha})`;const _=d-v[s]*h;e.beginPath(),e.moveTo(C,_),e.lineTo(r,_),e.stroke()}}}}e.restore()}shouldDrawDirectPath(e,s){const n=e.lightness<.05||e.lightness>.95,i=s.lightness<.05||s.lightness>.95;if(n&&i)return!0;const o=10;for(let a=0;a<=o;a++){const l=a/o,c=e.hsPos.u+(s.hsPos.u-e.hsPos.u)*l,d=e.hsPos.v+(s.hsPos.v-e.hsPos.v)*l,f=e.lightness+(s.lightness-e.lightness)*l,h=this.abstractToRgb(c,d,f);if(!this.isValidColor(h.r,h.g,h.b))return!1}return!0}drawInterpolatedPath(e,s,n,i){const o=n.pos-s.pos;if(o<1e-6)return;const a=Math.max(2,Math.ceil(o*e.canvas.width/4));let l=!1;for(let c=0;c<=a;c++){const d=s.pos+c/a*o,f=this.getInterpolatedPropertiesAt(d);if(!f)continue;const h=this.clampAbstractPoint(f.u,f.v,f.lightness),r=h.u*this.state.transform.scale+this.state.transform.offsetX,u=h.v*this.state.transform.scale+this.state.transform.offsetY;!l||c===0?(e.moveTo(r,u),l=!0):e.lineTo(r,u)}}drawHSSegment(e,s,n,i,o){let a=s.pos,l=n.pos;this.state.isCyclic&&l<a&&(l+=1);const c=l-a;if(c<1e-6&&!this.state.isCyclic)return;const d=Math.max(10,Math.ceil(c*e.canvas.width/8)),f=[];for(let r=0;r<=d;r++){const u=a+r/d*c,p=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!p)continue;const g=this.clampAbstractPoint(p.u,p.v,p.lightness),y=g.u*this.state.transform.scale+this.state.transform.offsetX,m=g.v*this.state.transform.scale+this.state.transform.offsetY,S=Math.abs(p.lightness-this.state.viewLightness)<1e-10;f.push({x:y,y:m,isOnPlane:S,u:g.u,v:g.v})}if(f.length<2)return;if(f.every(r=>r.isOnPlane)){e.strokeStyle="black",e.lineWidth=Ss,e.setLineDash([]),e.globalAlpha=.7,e.beginPath(),e.moveTo(f[0].x,f[0].y);for(let r=1;r<f.length;r++)e.lineTo(f[r].x,f[r].y);e.stroke()}else{e.strokeStyle="black",e.lineWidth=Ss,e.globalAlpha=.4;const r=Math.sqrt((n.hsPos.u-s.hsPos.u)**2+(n.hsPos.v-s.hsPos.v)**2),u=((s.hsPos.u*73+s.hsPos.v*127)*50+r*100)%8;e.setLineDash([4,4]),e.lineDashOffset=u,e.beginPath(),e.moveTo(f[0].x,f[0].y);for(let p=1;p<f.length;p++)e.lineTo(f[p].x,f[p].y);e.stroke(),e.lineDashOffset=0}e.setLineDash([]),e.globalAlpha=.7}drawLightnessIntersectionDots(e,s){const n=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<n;i++){const o=this.state.points[i],a=this.state.points[(i+1)%this.state.points.length];if(Math.max(o.order,a.order)===0)continue;const c=Math.abs(o.lightness-this.state.viewLightness)<1e-10,d=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&d)continue;const f=o.lightness,h=a.lightness,r=this.state.viewLightness;if(f<r&&h>r||f>r&&h<r){const u=this.findLightnessIntersection(o,a,r);if(u!==null){let p=a.pos-o.pos;this.state.isCyclic&&a.pos<o.pos&&(p+=1);const g=o.pos+u*p,y=this.getInterpolatedPropertiesAt(g);if(!y)continue;const m=this.clampAbstractPoint(y.u,y.v,y.lightness),S=m.u*this.state.transform.scale+this.state.transform.offsetX,x=m.v*this.state.transform.scale+this.state.transform.offsetY;e.fillStyle="black",e.beginPath(),e.arc(S,x,2.5,0,2*Math.PI),e.fill()}}}}findLightnessIntersection(e,s,n){const i=e.lightness,o=s.lightness;if(Math.abs(o-i)<1e-10)return null;if(Math.max(e.order,s.order)===1){const h=(n-i)/(o-i);return h>0&&h<1?h:null}let l=0,c=1;const d=25;for(let h=0;h<d;h++){const r=(l+c)/2,u=e.pos+(s.pos-e.pos)*r,p=this.getInterpolatedPropertiesAt(u);if(!p)break;if(Math.abs(p.lightness-n)<1e-10)return r;p.lightness<n?o>i?l=r:c=r:o>i?c=r:l=r}const f=(l+c)/2;return f>.01&&f<.99?f:null}drawTicks(e,s){if(this.wrapper.style.display==="none")return;const n=e.canvas,i=Math.ceil(ct*2.2),o=Math.ceil(Mt/2),a=i+o;e.save(),e.strokeStyle="white",e.lineWidth=1;const l=a,c=n.width-i,d=a,f=n.height-i,h=c-l,r=f-d;this.clearTickLabels(n);const u=[0,.2,.4,.6,.8,1],p=["0","0.2","0.4","0.6","0.8","1"],g=n.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,m=window.pageYOffset||document.documentElement.scrollTop;for(let S=0;S<u.length;S++){const x=u[S],C=Math.floor(l+x*h)+.5;x===0?(e.beginPath(),e.moveTo(C,d),e.lineTo(C,f+5),e.stroke()):(e.beginPath(),e.moveTo(C,f),e.lineTo(C,f+5),e.stroke());const b=g.left+y+C,v=g.top+m+f+8;this.createKaTeXLabel(p[S],b,v,"bottom",n)}for(let S=0;S<u.length;S++){const x=u[S],C=Math.floor(f-x*r)+.5;x===0?(e.beginPath(),e.moveTo(l-5,C),e.lineTo(c,C),e.stroke()):(e.beginPath(),e.moveTo(l-5,C),e.lineTo(l,C),e.stroke());const b=g.left+y+l-8,v=g.top+m+C;this.createKaTeXLabel(p[S],b,v,"left",n)}e.restore()}clearTickLabels(e){document.querySelectorAll(`[data-tick-canvas="${e.dataset.type}"]`).forEach(n=>n.remove())}createKaTeXLabel(e,s,n,i,o){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=e.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${s}px;
            top: ${n}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${s}px;
            top: ${n}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,katex.render(e,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(e.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),s,n,i,o)}}}drawAlphaElements(){const e=this.elements.interactiveCanvases.alpha;if(!e)return;const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height);const n=Math.ceil(ct*2.2),i=Math.ceil(Mt/2),o=n+i,a=o,l=e.width-n,c=o,d=e.height-n,f=l-a,h=d-c;let r=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(r=p.alpha)}const u=d-r*h;this.drawHorizontalLine(s,u),this.drawConnectingLine(s,"alpha"),this.drawTicks(s,"alpha"),this.state.points.forEach(p=>{const g=a+p.pos*f,y=d-p.alpha*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:S,g:x,b:C}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),v=p.id===this.state.lastSelectedPointId;this.drawPoint(s,g,y,S,x,C,b,v,p.order)})}_drawCircle(e,s,n,i){e.arc(s,n,i,0,2*Math.PI)}_drawJoukowsky(e,s,n,i,o){const l=[];let c=1/0,d=-1/0,f=1/0,h=-1/0;for(let m=0;m<=50;m++){const S=m/50*2*Math.PI,x=Math.cos(S),C=Math.sin(S),b=1-o+o*x,v=o*C,M=b*b+v*v;if(Math.abs(M)<1e-9)continue;const I=o*C-o*C/M,A=o*x+b/M;l.push({x:I,y:A}),I<c&&(c=I),I>d&&(d=I),A<f&&(f=A),A>h&&(h=A)}const r=h-f,u=i*2.5/r,p=(d+c)/2,g=(h+f)/2;e.beginPath();const y=l[0];e.moveTo(s+(y.x-p)*u,n-(y.y-g)*u);for(let m=1;m<l.length;m++){const S=l[m];e.lineTo(s+(S.x-p)*u,n-(S.y-g)*u)}e.closePath()}_drawDroplet(e,s,n,i){this._drawJoukowsky(e,s,n,i,.6666666666666666)}_drawTriangle(e,s,n,i){const o=i*1.4;e.moveTo(s,n-o),e.lineTo(s+o*Math.sqrt(3)/2,n+o/2),e.lineTo(s-o*Math.sqrt(3)/2,n+o/2),e.closePath()}drawPoint(e,s,n,i,o,a,l,c,d){switch(e.beginPath(),d){case 0:this._drawCircle(e,s,n,ct);break;case 1:this._drawDroplet(e,s,n,ct);break;case 3:this._drawTriangle(e,s,n,ct);break;default:this._drawCircle(e,s,n,ct)}e.fillStyle=`rgb(${i}, ${o}, ${a})`,e.fill(),e.strokeStyle=l?Hn:"black",e.lineWidth=c?Go:Ss,e.stroke()}clampColor(e){return{r:Math.round(Math.max(0,Math.min(255,e.r*255))),g:Math.round(Math.max(0,Math.min(255,e.g*255))),b:Math.round(Math.max(0,Math.min(255,e.b*255)))}}updateUIReadouts(){const e=this.getLastSelectedPoint(),s=document.activeElement,n=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(s),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),s!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),s!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),s!==this.elements.positionInput&&(this.elements.positionInput.value=e?e.pos.toFixed(2):"--"),e?(this.elements.constantButton.classList.toggle("active",e.order===0),this.elements.linearButton.classList.toggle("active",e.order===1),this.elements.cubicButton.classList.toggle("active",e.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!e){n||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!n){const{lightness:o,hsPos:a}=e,l=this.abstractToRgb(a.u,a.v,o);if(i){const{r:c,g:d,b:f}=this.clampColor(l);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=d,this.elements.rgbBInput.value=f}else{const c=this.rgbToHsl(l.r,l.g,l.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const e=this.elements.selectedColorPreviewCanvas;if(!e)return;const{clientWidth:s,clientHeight:n}=e.parentElement;(e.width!==s||e.height!==n)&&(e.width=s,e.height=n);const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),this.drawCheckerboard(i);const o=this.getLastSelectedPoint();if(o){const{hsPos:a,lightness:l,alpha:c}=o,d=this.abstractToRgb(a.u,a.v,l),{r:f,g:h,b:r}=this.clampColor(d);i.fillStyle=`rgba(${f}, ${h}, ${r}, ${c})`,i.fillRect(0,0,e.width,e.height)}}wrapPositionCyclic(e){return this.state.isCyclic?(e%1+1)%1:Math.max(0,Math.min(1,e))}drawColormapPreview(){const e=this.elements.colormapPreviewCanvas.getContext("2d"),s=this.elements.colormapPreviewCanvas.width,n=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(e),this.state.points.length!==0)for(let i=0;i<s;i++){const o=i/(s-1),a=this.getInterpolatedPropertiesAt(o);if(!a)continue;const l=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(l.u,l.v,a.lightness),{r:d,g:f,b:h}=this.clampColor(c);e.fillStyle=`rgba(${d}, ${f}, ${h}, ${a.alpha})`,e.fillRect(i,0,1,n)}}getInterpolatedPropertiesAt(e){const s=this.state.points,n=s.length;if(n===0)return null;if(n===1){const r=s[0];return{u:r.hsPos.u,v:r.hsPos.v,lightness:r.lightness,alpha:r.alpha,order:r.order}}const i=this.state.isCyclic,o=i?(e%1+1)%1:e;let a,l,c=-1;for(let r=0;r<n-1;r++)if(o>=s[r].pos&&o<=s[r+1].pos){c=r,a=s[r],l=s[r+1];break}if(c===-1)if(i)c=n-1,a=s[n-1],l=s[0];else{const r=o<s[0].pos?s[0]:s[n-1];return{u:r.hsPos.u,v:r.hsPos.v,lightness:r.lightness,alpha:r.alpha,order:r.order}}if(!a||!l)return null;let d=l.pos-a.pos;if(i&&c===n-1&&(d+=1),Math.abs(d)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let f;i&&c===n-1?f=o>=a.pos?(o-a.pos)/d:(o+1-a.pos)/d:f=(o-a.pos)/d;const h=Math.max(a.order,l.order);if(h===0){const r=f<.5?a:l;return{u:r.hsPos.u,v:r.hsPos.v,lightness:r.lightness,alpha:r.alpha,order:r.order}}if(h===3){const r=this.evaluateCubicSpline(c,f);if(r){const u=Math.max(0,Math.min(1,r.lightness)),p=Math.max(0,Math.min(1,r.alpha)),g=this.clampAbstractPoint(r.u,r.v,u);return{u:g.u,v:g.v,lightness:u,alpha:p,order:2}}}return{u:a.hsPos.u+(l.hsPos.u-a.hsPos.u)*f,v:a.hsPos.v+(l.hsPos.v-a.hsPos.v)*f,lightness:a.lightness+(l.lightness-a.lightness)*f,alpha:a.alpha+(l.alpha-a.alpha)*f,order:1}}abstractToRgb(e,s,n){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(e,s,n);const i=this.rgbCubeAbstractToRgb(e,s,n);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(e,s,n){if(this.state.colorSpace==="HSL_DI_CONE"){const r=Math.sqrt(e*e+s*s),u=1-Math.abs(2*n-1);return r>u&&u>1e-6?{u:e/r*u,v:s/r*u}:{u:e,v:s}}if(n<=.01||n>=.99)return{u:0,v:0};let{r:i,g:o,b:a}=this.abstractToRgb(e,s,n);if(this.isValidColor(i,o,a))return{u:e,v:s};let l=0,c=0,d=1/0;const f=Math.max(Math.abs(e),Math.abs(s),.5),h=50;for(let r=0;r<=h;r++)for(let u=0;u<=h;u++){const p=e+(r/h-.5)*2*f,g=s+(u/h-.5)*2*f,y=this.abstractToRgb(p,g,n);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((p-e)**2+(g-s)**2);m<d&&(d=m,l=p,c=g)}}return d<1/0?{u:l,v:c}:{u:0,v:0}}hslToRgb(e,s,n){if(s===0)return{r:n,g:n,b:n};const i=n<.5?n*(1+s):n+s-n*s,o=2*n-i,a=(f,h,r)=>(r<0&&(r+=1),r>1&&(r-=1),r<1/6?f+(h-f)*6*r:r<1/2?h:r<2/3?f+(h-f)*(2/3-r)*6:f),l=a(o,i,e+1/3),c=a(o,i,e),d=a(o,i,e-1/3);return{r:l,g:c,b:d}}rgbToHsl(e,s,n){const i=Math.max(e,s,n),o=Math.min(e,s,n);let a=0,l=0,c=(i+o)/2;if(i!==o){const d=i-o;switch(l=c>.5?d/(2-i-o):d/(i+o),i){case e:a=(s-n)/d+(s<n?6:0);break;case s:a=(n-e)/d+2;break;case n:a=(e-s)/d+4;break}a/=6}return{h:a,s:l,l:c}}drawCheckerboard(e){const s=e.canvas.width,n=e.canvas.height,i=s/Mt,o=n/Mt;e.fillStyle=Wn,e.fillRect(0,0,s,n),e.fillStyle=zn;for(let a=0;a<o;a++)for(let l=0;l<i;l++)(a+l)%2===0&&e.fillRect(l*Mt,a*Mt,Mt,Mt)}findClosestValidPoint(e,s,n){const i=Math.ceil(ct*2.2),o=Math.ceil(Mt/2),a=i+o,l=a,c=a,d=this.elements.hsBgCanvas.width-a-i,f=this.elements.hsBgCanvas.height-a-i,h=Math.max(l,Math.min(l+d,e)),r=Math.max(c,Math.min(c+f,s)),{scale:u,offsetX:p,offsetY:g}=this.state.transform,y=(h-p)/u,m=(r-g)/u,S=this.abstractToRgb(y,m,n);if(this.isValidColor(S.r,S.g,S.b))return{x:h,y:r};if(this.state.colorSpace==="HSL_DI_CONE"){const x=Math.sqrt(y*y+m*m),C=1-Math.abs(2*n-1);if(x>C&&C>1e-6){const b=y/x*C,v=m/x*C;return{x:b*u+p,y:v*u+g}}return{x:h,y:r}}return this.findClosestPointOnRgbGamut(y,m,n,u,p,g,l,c,d,f)}getGamutVerticesRgb(e){const s=[],n=l=>l>=-1e-6&&l<=1.000001,i=(l,c)=>Math.abs(l.r-c.r)<1e-6&&Math.abs(l.g-c.g)<1e-6&&Math.abs(l.b-c.b)<1e-6,o=(l,c,d)=>{if(n(l)&&n(c)&&n(d)){const f={r:l,g:c,b:d};s.some(h=>i(h,f))||s.push(f)}},a=3*e;return o(a,0,0),o(0,a,0),o(0,0,a),o(1,a-1,0),o(1,0,a-1),o(a-1,1,0),o(0,1,a-1),o(a-1,0,1),o(0,a-1,1),o(1,1,a-2),o(1,a-2,1),o(a-2,1,1),s}rgbCubeAbstractToRgb(e,s,n){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},o={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=n+e*i.x+s*o.x,l=n+e*i.y+s*o.y,c=n+e*i.z+s*o.z;return{r:a,g:l,b:c}}findClosestPointOnRgbGamut(e,s,n,i,o,a,l,c,d,f){let h=e,r=s,u=1/0;const p=.5,g=50;for(let S=0;S<=g;S++)for(let x=0;x<=g;x++){const C=e+(S/g-.5)*2*p,b=s+(x/g-.5)*2*p,v=this.abstractToRgb(C,b,n);if(this.isValidColor(v.r,v.g,v.b)){const M=Math.sqrt((C-e)**2+(b-s)**2);M<u&&(u=M,h=C,r=b)}}if(u<1/0){const S=this.refineClosestPoint(e,s,h,r,n);h=S.u,r=S.v}const y=h*i+o,m=r*i+a;return{x:Math.max(l,Math.min(l+d,y)),y:Math.max(c,Math.min(c+f,m))}}refineClosestPoint(e,s,n,i,o){let a=n,l=i,c=.02;for(let d=0;d<5;d++){let f=!1;const h=20;for(let r=0;r<=h;r++)for(let u=0;u<=h;u++){const p=a+(r/h-.5)*2*c,g=l+(u/h-.5)*2*c,y=this.abstractToRgb(p,g,o);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((a-e)**2+(l-s)**2);Math.sqrt((p-e)**2+(g-s)**2)<m&&(a=p,l=g,f=!0)}}if(c*=.5,!f)break}return{u:a,v:l}}findClosestPointOnPolygon(e,s){let n=null,i=1/0;for(let o=0;o<s.length;o++){const a=s[o],l=s[(o+1)%s.length],c=l.x-a.x,d=l.y-a.y;let f;if(c===0&&d===0)f=a;else{const r=((e.x-a.x)*c+(e.y-a.y)*d)/(c*c+d*d);r<0?f=a:r>1?f=l:f={x:a.x+r*c,y:a.y+r*d}}const h=(e.x-f.x)**2+(e.y-f.y)**2;h<i&&(i=h,n=f)}return n}constrainPointToValidArea(e){const s=this.abstractToRgb(e.originalHsPos.u,e.originalHsPos.v,e.lightness);if(this.isValidColor(s.r,s.g,s.b)){e.hsPos={...e.originalHsPos};return}const n=this.clampAbstractPoint(e.originalHsPos.u,e.originalHsPos.v,e.lightness);e.hsPos.u=n.u,e.hsPos.v=n.v}findHitPointSlider(e,s,n){const i=this.elements.interactiveCanvases[n],o=Math.ceil(ct*2.2),a=Math.ceil(Mt/2),l=o+a,c=i.height-l-o,d=i.height-o,f=n==="lightness"?d-this.state.viewLightness*c:d-this.state.viewAlpha*c;let h=Math.abs(s-f)<=Ho,r=null;for(let u=0;u<this.state.points.length;u++){const p=this.state.points[u],g=i.width-l-o,y=l+p.pos*g,m=n==="lightness"?d-p.lightness*c:d-p.alpha*c;if(Math.sqrt((e-y)**2+(s-m)**2)<=qn){r=p;break}}return{hitPoint:r,hitLine:h}}findHitPointSlider(e,s,n){const i=this.elements.interactiveCanvases[n],o=Math.ceil(ct*2.2),a=i.height-2*o,l=i.height-o,c=n==="lightness"?l-this.state.viewLightness*a:l-this.state.viewAlpha*a;let d=Math.abs(s-c)<=Ho,f=null;for(let h=0;h<this.state.points.length;h++){const r=this.state.points[h],u=i.width-2*o,p=o+r.pos*u,g=n==="lightness"?l-r.lightness*a:l-r.alpha*a;if(Math.sqrt((e-p)**2+(s-g)**2)<=qn){f=r;break}}return{hitPoint:f,hitLine:d}}createNewPointHS(e,s){const n=Math.ceil(ct*2.2),i=Math.ceil(Mt/2),o=n+i,a=o,l=o,c=this.elements.hsBgCanvas.width-o-n,d=this.elements.hsBgCanvas.height-o-n;if(e<a||e>a+c||s<l||s>l+d)return;const f=(e-this.state.transform.offsetX)/this.state.transform.scale,h=(s-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:r,viewAlpha:u}=this.state,{r:p,g,b:y}=this.abstractToRgb(f,h,r);if(this.isValidColor(p,g,y)){this.markAsDirty();const m=this.state.points.length;m>0&&this.state.points.forEach(x=>{x.pos=x.pos-x.pos/m});const S={id:Date.now(),hsPos:{u:f,v:h},originalHsPos:{u:f,v:h},lightness:r,alpha:u,pos:m===0?.5:1,order:1};this.state.points.push(S),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(S.id),this.state.lastSelectedPointId=S.id,this.drawAll()}}handleLineDrag(e,s,n){const i=n.startsWith("lightness")?"lightness":"alpha",o=n.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(ct*2.2),l=Math.ceil(Mt/2),c=a+l,d=s-c-a,h=(this.findSnapPosition(e,s,i)-c)/d,r=Math.max(0,Math.min(1,1-h));this.state[o]=r,this.drawAll()}handlePointDrag(e,s,n,i){const o=this.getPointById(this.state.activeDrag.pointId);o&&(i==="hs"?this.handleHSPointDrag(e,s):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(o,e,s,n,i),this.drawAll())}handleHSPointDrag(e,s){const{startX:n,startY:i,initialPointPositions:o}=this.state.activeDrag,{scale:a,offsetX:l,offsetY:c}=this.state.transform,d=Math.ceil(ct*2.2),f=Math.ceil(Mt/2),h=d+f,r=h,u=h,p=this.elements.hsBgCanvas.width-h-d,g=this.elements.hsBgCanvas.height-h-d,y=e-n,m=s-i;this.state.points.forEach(S=>{if(o.has(S.id)){const x=o.get(S.id),C=x.x+y,b=x.y+m,v=Math.max(r,Math.min(r+p,C)),M=Math.max(u,Math.min(u+g,b)),I=this.findClosestValidPoint(v,M,S.lightness),A=(I.x-l)/a,E=(I.y-c)/a;S.hsPos={u:A,v:E};const _=this.abstractToRgb(A,E,S.lightness);this.isValidColor(_.r,_.g,_.b)&&(S.originalHsPos={u:A,v:E})}})}adjustPointForNewLightness(e,s){const n=this.abstractToRgb(e.originalHsPos.u,e.originalHsPos.v,e.lightness);if(this.isValidColor(n.r,n.g,n.b)){e.hsPos={...e.originalHsPos};return}const i=this.clampAbstractPoint(e.originalHsPos.u,e.originalHsPos.v,e.lightness);e.hsPos.u=i.u,e.hsPos.v=i.v}handleSliderPointDrag(e,s,n,i,o){const{offsets:a}=this.state.activeDrag,l=Math.ceil(ct*2.2),c=Math.ceil(Mt/2),d=l+c;i.width-l,i.height-l;const f=this.findSnapPosition(n,i.height,o,e.id),h=d,r=i.width-l,u=d,p=i.height-l,g=r-h,y=p-u,m=(f-u)/y,S=Math.max(0,Math.min(1,1-m));let x=(s-h)/g,C=x;this.state.isCyclic?(x<0?C=1+x:x>1&&(C=x-1),C=this.wrapPositionCyclic(C)):C=Math.max(0,Math.min(1,x));for(const b of this.state.points)if(a.has(b.id)){const v=a.get(b.id),M=S+v[o];let I=C+v.pos;if(this.state.isCyclic?I=this.wrapPositionCyclic(I):I=Math.max(0,Math.min(1,I)),b.pos=I,o==="lightness"){const A=Math.max(0,Math.min(1,M));b.lightness=A;const E=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,A);if(this.isValidColor(E.r,E.g,E.b))b.hsPos={...b.originalHsPos};else{const _=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,A);b.hsPos.u=_.u,b.hsPos.v=_.v}this.state.viewLightness=A}else b.alpha=Math.max(0,Math.min(1,M)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const ma={background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},Uo=5,rn=25,Sa=20,xa=20,Ca=.1,Pt=5,uo=Pt*2,vs=2,Ve=1,ks=[6,6],ba=[3,3],mn=360,me=180,Ao=90,Bt=2*Math.PI,Sn=.01,Ei=Math.sqrt(3)/2,Ma=400,va=Math.PI/3,Ia=1.5,Oe=Math.PI/6,Ta=1.5,Ea=[2,3],_a=[1,3],As="_EDGE_",cn=300,Aa=3,po=7,qo=1e-20,Ko=1.15,dn=Math.PI/48,Pa=.05,wa=1e-5,Da=1-1e-5,hn=.001,jo=1e5,Ra=1.5,Lt=4,go=.9,je=24,Je=10,ke=8,ye=20,St=12,Kn=5,jn=20,Jn=10,Zn=5,Qn=20,to=12,La="\\phantom{-}0",ka=1.1,Jo=80,Zo=40,Qo=20,xn="i",fn="r",Na="\\mathrm{Re}",Oa="\\mathrm{Im}",Ba=80,yo=1,eo=Math.PI/2,Wt=10,es=56,Ie=30,ti=10,Fa=36,$a=30,so=40,Va=20,Qs=32,Ya=2,Ge=1.5,no=[2,4],Ye=1.5,_i=10,Ai=3,Xa=30,Ga=15,Ha=5,Wa=24,za="T",Ua=40,qa=15,Ka=12,ja=10,Ja=10,Za=3,un=2,xs=7,oo=30,io=5,Po=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff"],fe=12,vn=30,Be=18,rs=1,Qa=1.5,mo=11,In=18,tl=50,pn=75,el=20,sl=8,ei=35,si=60,nl=20,ni=18,ol=1e3,il=.001,al=10,oi=1e-5,wo=.015,Pi=32,ll=10,rl=.999,cl=6,dl=4,hl=14,Cs="\\hphantom{-}",ae="\\pi",fl="\\delta",ii="\\delta = ",Bs="\\theta = ",ul=15,wi=.8,ai=3,Di=2,pl=4,gl=1,yl=3,ml=1,Sl=140,li=.4,xl=.9,gn=.05,Cl=10,bl=10,Ml=50,ri=1.5,ao=[15,5,1],ci=80,vl=.01,z=1e-9,di=.1,Ri=30,hi=.5,Il=50,Do=50,Tl=6,El=10,_l=5,cs=(()=>{const t=new Set,e=[1,2,3,4,5,6];for(const s of e)for(let n=1;n<=s*4;n++)t.add(n/s);return Array.from(t).sort((s,n)=>s-n)})();function Al(t,e){const s=new Set;s.add(0);for(let n=1;n<=t;n++)for(let i=1;i<=n*e;i++)s.add(i/n);return Array.from(s).sort((n,i)=>n-i)}const Tn=Al(Tl,El),Is="regular",be=" transformation_rotation",ds=" transformation_scale",hs="transformation_directional_scale",Bn="none",Ro="regular",Gs="complex",Fn="polar",Ns="none",Lo="lines",ko="points",No="triangular",Oo="polar",fs="degrees",tn="radians",Hs="none",Ws="on",Pl="none",wl=" ",Dl="Escape",Rl="Delete",Ll="Backspace",kl="r",fi="=",ui="+",pi="-",gi="c",yi="v",mi="x",lo="z",Si="y",xi="a",mt="vertex",wt="edge",Dt="face";function Et(t,e){if(t===0)return"0";const s=Math.abs(t),n=t<0?"-":"";let i;if(s>=ol||s!==0&&s<il){const a=s.toExponential(Math.max(0,e-1)).split("e");let l=parseFloat(a[0]).toString(),c=parseInt(a[1],10);i=`${l} \\cdot 10^{${c}}`}else{const o=s<1?0:Math.floor(Math.log10(s))+1;let a;if(s===0)a=e-1;else if(s<1){let d=0,f=s;for(;f<1&&d<e+5;)f*=10,d++;a=Math.max(0,d-1+e)}else a=Math.max(0,e-o);a=Math.min(a,al);let l=s.toFixed(a),c=parseFloat(l);if(Math.abs(c)===0&&t!==0)return"0";i=Math.abs(c).toString()}return n+i}function Bo(t,e){return e===0?t:Bo(e,t%e)}function lt(t){return t.id1<t.id2?`${t.id1}${As}${t.id2}`:`${t.id2}${As}${t.id1}`}function Ct(t){return t.id?t.id:t.vertexIds?`face_${[...t.vertexIds].sort().join("_")}`:null}function Ps(t,e,s,n,i=!1){const o=[];if(e==="none"||!s||s<=0)return o;if(e==="polar"){const a=(Math.atan2(t.y,t.x)*180/Math.PI+360)%360,l=Math.hypot(t.x,t.y),c=Math.round(l/s)*s;n.forEach(d=>{if(d.alpha>.01&&d.angle>0){const f=d.angle,r=Math.round(a/f)*f*Math.PI/180;o.push({x:c*Math.cos(r),y:c*Math.sin(r),isGridPoint:!0})}})}else if(e==="triangular"){const a=s*Ei,l=t.x/s-t.y/(s*Math.sqrt(3)),c=t.y/a;let d=Math.round(l),f=Math.round(c),h=Math.round(-l-c);const r=Math.abs(d-l),u=Math.abs(f-c),p=Math.abs(h-(-l-c));r>u&&r>p?d=-f-h:u>p&&(f=-d-h);const g=d*s+f*s/2,y=f*a;o.push({x:g,y,isGridPoint:!0})}else if(i){const a=Math.floor(t.x/s)*s,l=Math.floor(t.y/s)*s;o.push({x:a,y:l,isGridPoint:!0},{x:a+s,y:l,isGridPoint:!0},{x:a,y:l+s,isGridPoint:!0},{x:a+s,y:l+s,isGridPoint:!0})}else o.push({x:Math.round(t.x/s)*s,y:Math.round(t.y/s)*s,isGridPoint:!0});return o}function ns(){return crypto.randomUUID()}function Ce(t){for(;t<0;)t+=Bt;for(;t>=Bt;)t-=Bt;return t}function Nl(t,e,s=0){let n=e-t,i=Math.round((s-n)/(2*Math.PI));return n+i*(2*Math.PI)}function _t(t){return t=Ce(t),t>Math.PI&&(t-=Bt),t}function Ol(t){for(;t<0;)t+=mn;for(;t>=mn;)t-=mn;return t}function En(t,e){const{p1:s,p2:n}=t,{center:i,radius:o}=e,a={x:n.x-s.x,y:n.y-s.y},l={x:s.x-i.x,y:s.y-i.y},c=a.x*a.x+a.y*a.y,d=2*(l.x*a.x+l.y*a.y),f=l.x*l.x+l.y*l.y-o*o;let h=d*d-4*c*f;if(h<0)return[];h=Math.sqrt(h);const r=(-d-h)/(2*c),u=(-d+h)/(2*c);return[{x:s.x+r*a.x,y:s.y+r*a.y},{x:s.x+u*a.x,y:s.y+u*a.y}]}function Li(t,e){const s=t.p1,n=t.p2,i=e.p1,o=e.p2,a=(s.x-n.x)*(i.y-o.y)-(s.y-n.y)*(i.x-o.x);if(Math.abs(a)<z)return null;const l=((s.x-i.x)*(i.y-o.y)-(s.y-i.y)*(i.x-o.x))/a,c=-((s.x-n.x)*(s.y-i.y)-(s.y-n.y)*(s.x-i.x))/a;return c>=0&&c<=1?{x:s.x+l*(n.x-s.x),y:s.y+l*(n.y-s.y)}:null}function He(t){if(t<0||!Number.isInteger(t))return[null,null];if(t===0)return[0,1];let e=1,s=t;for(let n=2;n*n<=s;n++)for(;s%(n*n)===0;)s/=n*n,e*=n;return[e,s]}function We(t,e,s=""){const n=s?`\\${s}`:"";return e===1?t===1&&s?n:`${t}${n}`:t===1?`\\sqrt{${e}}${n}`:`${t}\\sqrt{${e}}${n}`}function G(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function Ts(t,e=wo,s=Pi){if(Math.abs(t)<oi)return"0";const n=t<0?"-":"",i=Math.abs(t);if(Math.abs(i-Math.round(i))<e){const l=Math.round(i);return n+l.toString()}const o=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[l,c]of o)if(c<=s&&Math.abs(i-l/c)<e)return n+`${l}/${c}`;for(let l=1;l<=s;l++){const c=Math.round(i*l);if(!(c===0&&i>oi)&&Math.abs(i-c/l)<e/l){const d=Bo(c,l),f=c/d,h=l/d;return h===1?n+`${f}`:n+`${f}/${h}`}}let a=2;return i<.01?a=3:i<.1?a=2:i<10?a=1:a=0,n+i.toFixed(a)}function ws(t,e){if(e.length<3)return!1;let s=!1;const n=t.x,i=t.y;for(let o=0,a=e.length-1;o<e.length;a=o++){const l=e[o].x,c=e[o].y,d=e[a].x,f=e[a].y;c>i!=f>i&&n<(d-l)*(i-c)/(f-c)+l&&(s=!s)}return s}function So(t){if(!t||typeof t!="string")return{r:255,g:255,b:255,a:1};if(t.startsWith("rgba(")){const e=t.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(e)return{r:Math.max(0,Math.min(255,parseInt(e[1]))),g:Math.max(0,Math.min(255,parseInt(e[2]))),b:Math.max(0,Math.min(255,parseInt(e[3]))),a:Math.max(0,Math.min(1,parseFloat(e[4])))}}if(t.startsWith("rgb(")){const e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(e)return{r:Math.max(0,Math.min(255,parseInt(e[1]))),g:Math.max(0,Math.min(255,parseInt(e[2]))),b:Math.max(0,Math.min(255,parseInt(e[3]))),a:1}}if(t.startsWith("#")){const e=t.slice(1);if(e.length===6)return{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16),a:1};if(e.length===3)return{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function Bl(t,e,s){const n=e.localCoordSystem;if(!n)return null;const i=s(n.origin);if(G(t,i)<8)return{face:e,type:"center"};const a=5,l=os({x:1,y:0},n),c=s(l);if(Me(t,i,c).distance<a)return{face:e,type:"x_axis"};const f=os({x:0,y:1},n),h=s(f);return Me(t,i,h).distance<a?{face:e,type:"y_axis"}:null}function Ds(t,e){if(ws(t,e))return t;let s=t,n=1/0;for(let i=0;i<e.length;i++){const o=e[i],a=e[(i+1)%e.length],l=Me(t,o,a);l.distance<n&&(n=l.distance,s={x:l.x,y:l.y})}return s}function Fl(t){const e=Math.hypot(t.x,t.y);return e===0?{x:0,y:0}:{x:t.x/e,y:t.y/e}}function Me(t,e,s){const n=s.x-e.x,i=s.y-e.y,o=t.x-e.x,a=t.y-e.y,l=n*n+i*i;if(l===0)return{x:e.x,y:e.y,distance:G(t,e),onSegmentStrict:!0,t:0};let c=(o*n+a*i)/l;const d=c>wa&&c<Da,f=Math.max(0,Math.min(1,c)),h=e.x+f*n,r=e.y+f*i,u=G(t,{x:h,y:r});return{x:h,y:r,distance:u,onSegmentStrict:d,t:f}}function xo(t,e,s){const n=s.x-e.x,i=s.y-e.y,o=t.x-e.x,a=t.y-e.y,l=n*n+i*i;if(l===0)return{x:e.x,y:e.y,distance:G(t,e)};let c=(o*n+a*i)/l;const d=e.x+c*n,f=e.y+c*i,h=G(t,{x:d,y:f});return{x:d,y:f,distance:h}}function Ci(t,e,s,n){if(Math.abs(s)<z||Math.abs(s-Math.PI)<z)return null;const i=G(t,e),o=Math.abs(i/2/Math.sin(s)),a={x:(t.x+e.x)/2,y:(t.y+e.y)/2},l=Math.sqrt(Math.max(0,o*o-i/2*(i/2))),c={x:-(e.y-t.y),y:e.x-t.x},d=Math.hypot(c.x,c.y),f={x:c.x/d,y:c.y/d},h={x:a.x+l*f.x,y:a.y+l*f.y},r={x:a.x-l*f.x,y:a.y-l*f.y},u=(e.x-t.x)*(n.y-t.y)-(e.y-t.y)*(n.x-t.x),p=(e.x-t.x)*(h.y-t.y)-(e.y-t.y)*(h.x-t.x);return{center:u*p>0?h:r,radius:o}}function Os(t,e){const s=e.getBoundingClientRect();return{x:t.clientX-s.left,y:t.clientY-s.top}}function ro(t,e,s){t/=255,e/=255,s/=255;const n=Math.max(t,e,s),i=Math.min(t,e,s);let o,a,l=(n+i)/2;if(n===i)o=a=0;else{const c=n-i;switch(a=l>.5?c/(2-n-i):c/(n+i),n){case t:o=(e-s)/c+(e<s?6:0);break;case e:o=(s-t)/c+2;break;case s:o=(t-e)/c+4;break}o/=6}return[o,a,l]}function $l(t,e,s,n,i=null){const o=Math.atan2(t.y-e.y,t.x-e.x);if(!n)return{angle:o,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=Math.PI/24;let l={angle:o,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},d=(h,r,u=null,p=null)=>{const g=_t(h),y=Math.abs(_t(o-g));if(y<a){const m=c[r],S=l.snapType?c[l.snapType]:1/0;m<S?l={angle:g,difference:y,edgeIndex:u,snapType:r,targetVertexId:p}:m===S&&y<l.difference&&(l={angle:g,difference:y,edgeIndex:u,snapType:r,targetVertexId:p})}};return n.edgeAngles&&n.edgeAngles.forEach((h,r)=>{[h,h+Math.PI/2,h-Math.PI/2,h+Math.PI].forEach(u=>{d(u,"edge",r)})}),n.vertices&&n.vertices.forEach(h=>{if(G(e,h)>z){const r=Math.atan2(h.y-e.y,h.x-e.x);d(r,"vertex_direction",null,h.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(h=>d(h,"cardinal")),{angle:l.angle,edgeIndex:l.edgeIndex,snapType:l.snapType,snapped:l.difference<1/0,targetVertexId:l.targetVertexId}}function Vl(t,e,s,n,i,o=null,a=null,l="x_axis"){if(!o||!a||!s.alignedEdgeInfo)return{snapped:!1};const c=15/a.scale;let d=[];const{v1Id:f,v2Id:h}=s.alignedEdgeInfo,r=i(f),u=i(h);if(r&&u&&r.type==="regular"&&u.type==="regular"){const g=G(r,u);[.25,1/3,.5,2/3,.75,1].forEach(m=>{const S=g*m,x=Math.abs(o-S);d.push({scale:S,distance:x,type:"edge_fraction",priority:m===.5?1:m===1?2:3,fraction:m})})}if(d.length===0)return{snapped:!1};d.sort((g,y)=>g.priority!==y.priority?g.priority-y.priority:g.distance-y.distance);const p=d.find(g=>g.distance<c);return p?{snapped:!0,scale:p.scale,snapType:"edge_fraction",edgeFraction:p.fraction}:{snapped:!1}}function Yl(t,e,s,n,i){let o=null,a=1/0;if(e){e.vertices.forEach(l=>{const c=G(t,l);c<a&&(a=c,o={snapped:!0,snapPoint:l,snapType:"vertex",vertexId:l.id})});for(let l=0;l<e.edgeMidvertices.length;l++){const c=e.edgeVertexIds[l*2],d=e.edgeVertexIds[l*2+1],f={...e.vertices.find(r=>r.id===c)},h={...e.vertices.find(r=>r.id===d)};f&&h&&[0,.25,.3333333333333333,.5,.6666666666666666,.75,1].forEach(u=>{const p={x:f.x+u*(h.x-f.x),y:f.y+u*(h.y-f.y)},g=G(t,p);g<a&&(a=g,o={snapped:!0,snapPoint:p,snapType:"edge",edgeInfo:{v1:c,v2:d,t:u,originalAngle:e.edgeAngles[l],edgeIndex:l}})})}}if(s&&s!=="none"&&n&&n.interval1){const l=n.alpha2>n.alpha1&&n.interval2?n.interval2:n.interval1;Ps(t,s,l,i,!0).forEach(d=>{const f=G(t,d);f<a&&(a=f,o={snapped:!0,snapPoint:d,snapType:"grid"})})}return o||{snapped:!1}}function Fo(t){if(Array.isArray(t)){const[e,s,n]=ro(t[0],t[1],t[2]),i=1-n,[o,a,l]=co(e,s,i);return[o,a,l]}if(typeof t=="string"){if(t.startsWith("rgba(")){const e=t.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(e){const[,s,n,i,o]=e,a=parseInt(s),l=parseInt(n),c=parseInt(i),[d,f,h]=ro(a,l,c),r=1-h,[u,p,g]=co(d,f,r);return`rgba(${u}, ${p}, ${g}, ${o})`}}if(t.startsWith("#")&&t.length===7){const e=parseInt(t.slice(1,3),16),s=parseInt(t.slice(3,5),16),n=parseInt(t.slice(5,7),16),[i,o,a]=ro(e,s,n),l=1-a,[c,d,f]=co(i,o,l);return`#${c.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${f.toString(16).padStart(2,"0")}`}if(t==="white")return"black";if(t==="black")return"white"}return t}function Xl(t){let e=0;const s=t.length;for(let n=0;n<s;n++){const i=(n+1)%s;e+=t[n].x*t[i].y,e-=t[i].x*t[n].y}return e/2}function ki(t,e,s){return Math.max(e,Math.min(s,t))}function Gl(t,e,s){const n={x:t.x-e.x,y:t.y-e.y},i={x:s.x-e.x,y:s.y-e.y},o=n.x*i.x+n.y*i.y,a=Math.hypot(n.x,n.y),l=Math.hypot(i.x,i.y);if(a===0||l===0)return Math.PI;const c=o/(a*l);return Math.acos(ki(c,-1,1))}function Hl(t,e){if(t==="dark")return e;{const s={};for(const[n,i]of Object.entries(e))n==="frozenReference"||n==="feedbackSnapped"||n==="geometryInfoTextSnapped"?s[n]="rgba(217, 119, 6, 0.95)":s[n]=Fo(i);return s}}function co(t,e,s){let n,i,o;if(e===0)n=i=o=s;else{const a=(d,f,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?d+(f-d)*6*h:h<.5?f:h<.6666666666666666?d+(f-d)*(6*(.6666666666666666-h)):d),l=s<.5?s*(1+e):s+e-s*e,c=2*s-l;n=a(c,l,t+1/3),i=a(c,l,t),o=a(c,l,t-1/3)}return[Math.round(n*255),Math.round(i*255),Math.round(o*255)]}function yn(t,e){const s=Ts(t,.001),n=e==="A"?"\\theta":e==="D"?"\\delta":e;if(s==="0")return`0${n}`;if(s==="1")return n;if(s==="-1")return`-${n}`;if(s.endsWith("/1"))return`${s.slice(0,-2)}${n}`;if(s.includes("/")){let i="",o=s;o.startsWith("-")&&(i="-",o=o.substring(1));const a=o.split("/"),l=a[0],c=a[1];return l==="1"?`${i}\\frac{1}{${c}}${n}`:`${i}\\frac{${l}}{${c}}${n}`}return`${s}${n}`}function Jt(t,e,s,n,i,o){const a={x:t.x-e.x,y:t.y-e.y};if(i){const l=Math.hypot(o.x,o.y);if(l>z){const c={x:o.x/l,y:o.y/l},d=a.x*c.x+a.y*c.y,f={x:a.x-d*c.x,y:a.y-d*c.y},h=d*n,r={x:h*c.x+f.x,y:h*c.y+f.y};return{x:e.x+r.x,y:e.y+r.y}}return{x:t.x,y:t.y}}else{let l={...a};l.x*=n,l.y*=n;const c=l.x,d=l.y;return l.x=c*Math.cos(s)-d*Math.sin(s),l.y=c*Math.sin(s)+d*Math.cos(s),{x:e.x+l.x,y:e.y+l.y}}}function en(t){if(t.length<3)return null;if(t.length===3){const[e,s,n]=t,i=G(s,n),o=G(e,n),a=G(e,s),l=i+o+a;if(l<z)return null;const c=(i*e.x+o*s.x+a*n.x)/l,d=(i*e.y+o*s.y+a*n.y)/l,h=2*(Math.abs((s.x-e.x)*(n.y-e.y)-(n.x-e.x)*(s.y-e.y))/2)/l;return{center:{x:c,y:d},radius:h}}return Wl(t)}function Wl(t){if(t.length<3)return null;let e={x:t.reduce((i,o)=>i+o.x,0)/t.length,y:t.reduce((i,o)=>i+o.y,0)/t.length};ws(e,t)||(e.x=(t[0].x+t[1].x+t[2].x)/3,e.y=(t[0].y+t[1].y+t[2].y)/3);let s=e,n=bi(e,t);for(let i=0;i<xa;i++){let o=!1;const a=n*Ca,l=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of l){const d={x:s.x+c.x,y:s.y+c.y};if(ws(d,t)){const f=bi(d,t);f>n&&(s=d,n=f,o=!0)}}if(!o)break}return{center:s,radius:Math.max(n,z)}}function bi(t,e){let s=1/0;for(let n=0;n<e.length;n++){const i=e[n],o=e[(n+1)%e.length],a=zl(t,i,o);s=Math.min(s,a)}return s}function zl(t,e,s){return Me(t,e,s).distance}function Ul(t,e){t.forEach(s=>{if(!s.localCoordSystem)s.localCoordSystem=Mi(s,e);else if(!s.localCoordSystem.isCustom){const n=Mi(s,e);n&&(s.localCoordSystem.origin=n.origin,s.localCoordSystem.scale=n.scale)}})}function ql(t,e,s){const n=[t];let i=t,o=e;const a=s.size+2;for(let l=0;l<a;l++){if(n.push(o),o===t)return n.pop(),n;const c=s.get(o);if(!c||c.length<1)return null;const d=c.indexOf(i);if(d===-1)return null;const f=(d+1)%c.length,h=c[f];i=o,o=h}return null}function Kl(t,e,s){if(t.length<=1)return t;const n=new Set,i=new Set;return e.forEach(o=>{n.add(o.id1),n.add(o.id2);const a=[o.id1,o.id2].sort().join("_");i.add(a)}),t.filter(o=>{const a=new Set(o.vertexIds);for(const c of n)if(!a.has(c)){const d=s(c),f=o.vertexIds.map(h=>s(h));if(d&&f.every(h=>h)&&ws(d,f))return!1}const l=new Set;for(let c=0;c<o.vertexIds.length;c++){const d=o.vertexIds[c],f=o.vertexIds[(c+1)%o.vertexIds.length],h=[d,f].sort().join("_");l.add(h)}for(let c=0;c<o.vertexIds.length;c++)for(let d=c+2;d<o.vertexIds.length;d++){if(d===o.vertexIds.length-1&&c===0)continue;const f=o.vertexIds[c],h=o.vertexIds[d],r=[f,h].sort().join("_");if(i.has(r))return!1}return!0})}function $n(t,e){const s=new Map,n=new Map;t.forEach(d=>{const f=e(d.id1),h=e(d.id2);!f||!h||f.type!=="regular"||h.type!=="regular"||(n.has(f.id)||n.set(f.id,f),n.has(h.id)||n.set(h.id,h),s.has(d.id1)||s.set(d.id1,[]),s.has(d.id2)||s.set(d.id2,[]),s.get(d.id1).push(d.id2),s.get(d.id2).push(d.id1))});for(const[d,f]of s.entries()){const h=n.get(d);h&&f.sort((r,u)=>{const p=n.get(r),g=n.get(u);if(!p||!g)return 0;const y=Math.atan2(p.y-h.y,p.x-h.x),m=Math.atan2(g.y-h.y,g.x-h.x);return y-m})}const i=[],o=new Set;for(const[d,f]of s.entries())for(const h of f){const r=`${d}->${h}`;if(o.has(r))continue;const u=ql(d,h,s);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const m=u[y],S=u[(y+1)%u.length];o.add(`${m}->${S}`)}const g={vertexIds:u};g.id=Ct(g),i.push(g)}}const a=Kl(i,t,e),l=[],c=new Set;return a.forEach(d=>{const f=[...d.vertexIds].sort().join("_");c.has(f)||(l.push(d),c.add(f))}),l}function _n(t,e,s,n){const i={id1:t.id,id2:e.id},o=t.x-e.x,a=t.y-e.y,l=o/s,c=a/s,d=1e-5;if(s&&Math.abs(l-Math.round(l))<d&&Math.abs(c-Math.round(c))<d){i.labelMode="exact";const h=Math.round(l),r=Math.round(c);i.exactValue={g2gSquaredSum:h*h+r*r,gridInterval:s}}else i.labelMode="decimal";return i.color=n(wt),i}function Ni(t,e){let s=null,n=1/0;return e.forEach(i=>{if(!i)return;const o=Math.abs(t.x-(i.x+i.width/2));o<n&&o<i.width/2+Wt&&(n=o,s=i)}),s}function jl(t){if(t&&t.points){const e=t.points.map(s=>({pos:s.pos,color:Array.isArray(s.color)?s.color:[s.color.r||0,s.color.g||0,s.color.b||0],alpha:s.alpha!==void 0?s.alpha:1}));if(e.length===1){const s=e[0];return{type:"color",value:s.alpha!==void 0&&s.alpha<1?`rgba(${s.color.join(",")},${s.alpha})`:`rgb(${s.color.join(",")})`}}return{type:"colormap",vertices:e,isCyclic:t.isCyclic===!0}}if(t&&t.vertices&&t.vertices.length===1){const e=t.vertices[0];return{type:"color",value:e.alpha!==void 0&&e.alpha<1?`rgba(${e.color.join(",")},${e.alpha})`:`rgb(${e.color.join(",")})`}}else if(t&&t.vertices)return{type:"colormap",vertices:t.vertices.map(s=>({...s,alpha:s.alpha!==void 0?s.alpha:1})),isCyclic:t.isCyclic===!0};return t}function ne(t,e){if(!t||t.type!=="colormap"||!t.vertices)return"#ffffff";const s=t.vertices;if(s.length===0)return"#ffffff";if(s.length===1){const u=s[0],p=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${p})`}e=Math.max(0,Math.min(1,e));let n=s[0],i=s[s.length-1];for(let u=0;u<s.length-1;u++)if(e>=s[u].pos&&e<=s[u+1].pos){n=s[u],i=s[u+1];break}const o=i.pos-n.pos,a=o>0?(e-n.pos)/o:0,l=Math.round(n.color[0]+(i.color[0]-n.color[0])*a),c=Math.round(n.color[1]+(i.color[1]-n.color[1])*a),d=Math.round(n.color[2]+(i.color[2]-n.color[2])*a),f=n.alpha!==void 0?n.alpha:1,h=i.alpha!==void 0?i.alpha:1,r=f+(h-f)*a;return`rgba(${l},${c},${d},${r})`}function Mi(t,e){const s=t.vertexIds.map(i=>e(i)).filter(i=>i&&i.type==="regular");if(s.length<3)return null;const n=en(s);return n?{origin:{...n.center},angle:0,scale:n.radius,isCustom:!1,showCoordSystem:!1}:null}function Ae(t,e){const s=new Set;return e.forEach(n=>{n.id1===t?s.add(n.id2):n.id2===t&&s.add(n.id1)}),Array.from(s)}function os(t,e){if(!e)return t;const s={x:t.x*e.scale,y:t.y*e.scale},n=Math.cos(e.angle),i=Math.sin(e.angle),o={x:s.x*n-s.y*i,y:s.x*i+s.y*n};return{x:o.x+e.origin.x,y:o.y+e.origin.y}}function Jl(t,e){const s={x:(t.x+e.x)/2,y:(t.y+e.y)/2},n={x:-(e.y-t.y),y:e.x-t.x};return{p1:s,p2:{x:s.x+n.x,y:s.y+n.y}}}function Zl(t,e){const s=G(t.center,e.center);if(s>t.radius+e.radius||s<Math.abs(t.radius-e.radius)||s===0)return[];const n=(t.radius*t.radius-e.radius*e.radius+s*s)/(2*s),i=Math.sqrt(Math.max(0,t.radius*t.radius-n*n)),o=t.center.x+n*(e.center.x-t.center.x)/s,a=t.center.y+n*(e.center.y-t.center.y)/s,l=i*(e.center.y-t.center.y)/s,c=i*(e.center.x-t.center.x)/s,d={x:o+l,y:a-c},f={x:o-l,y:a+c};return i===0?[d]:[d,f]}const vi=new Map;function Ql(t){const e=Sl/t;let s=Math.pow(10,Math.floor(Math.log10(e))),n=Math.pow(10,Math.ceil(Math.log10(e)));(Math.abs(s-n)<z||s===0)&&(n=s===0?.001:s*10,s===0&&(s=1e-4));const i=s,o=n;let a=0;o>i&&i>0&&(a=(Math.log10(e)-Math.log10(i))/(Math.log10(o)-Math.log10(i)));let l=(a-li)/(xl-li);l=Math.max(0,Math.min(1,l)),l=l*l*(3-2*l);let c=1-l,d=l;c<gn?c=0:c>1-gn&&(c=1),d<gn?d=0:d>1-gn&&(d=1);const f=c+d;return f>0&&f!==2&&(c/=f,d/=f),{grid1Interval:i,grid2Interval:o,alpha1:c,alpha2:d}}function tr(t,e,s,n){const i=n({x:0,y:0}),o={x:e/2,y:s/2},a=G(i,o);let l;a<1e-6?l=ci:l=ci/a*(180/Math.PI),(isNaN(l)||l<=z)&&(l=z);const c=[];let d=[...ao],f=d[d.length-1];const h=1e-15;for(;f>h;)f/=10,d.includes(f)||d.push(f);d.sort((y,m)=>m-y);let r=null,u=null;for(let y=d.length-1;y>=0;y--){const m=d[y];if(l<m){r={angle:m,alpha:1},y+1<d.length&&(u={angle:d[y+1],alpha:0});break}}if(!r&&d.length>0?(r={angle:d[0],alpha:1},d.length>1&&(u={angle:d[1],alpha:0})):!r&&d.length===0&&(r={angle:ao[0],alpha:1}),c.push(r),u){const y=Math.log10(r.angle),m=Math.log10(u.angle),S=Math.log10(l);let x;m===y?x=0:x=(S-y)/(m-y),x=Math.max(0,Math.min(1,x));const C=x*x*(3-2*x);C>vl&&(u.alpha=C,c.push(u))}const p=[],g=new Set;c.sort((y,m)=>m.angle-y.angle);for(const y of c)g.has(y.angle)||(p.push(y),g.add(y.angle));return p.length===0&&p.push({angle:ao[0],alpha:1}),p}function er(t,{allFaces:e,hoveredFaceId:s,selectedFaceIds:n,colors:i,isDragConfirmed:o,dragPreviewVertices:a},l,c,d){if(!s&&n.length===0)return;const f=h=>{if(o&&a){const r=a.find(u=>u&&u.id===h);if(r)return r}return c(h)};e.forEach(h=>{const r=d(h);if(n.includes(r)||r===s){const g=h.vertexIds.map(m=>f(m)).filter(m=>m&&m.type==="regular");if(g.length<3)return;const y=g.map(m=>l(m));t.save(),t.fillStyle=i.selectionGlow,t.globalAlpha=.25,t.beginPath(),y.forEach((m,S)=>{S===0?t.moveTo(m.x,m.y):t.lineTo(m.x,m.y)}),t.closePath(),t.fill(),t.restore()}})}function Oi(t,e,s,n){if(t.x>=0&&t.x<=s&&t.y>=0&&t.y<=n)return{minAngle:0,maxAngle:360,isFullCircle:!0};const i={left:0,right:s,top:0,bottom:n};if(t.x+e<i.left||t.x-e>i.right||t.y+e<i.top||t.y-e>i.bottom)return null;const o=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(o.every(u=>(u.x-t.x)**2+(u.y-t.y)**2<=e**2))return{minAngle:0,maxAngle:360,isFullCircle:!0};const l=[];if(o.forEach(u=>{if((u.x-t.x)**2+(u.y-t.y)**2>e**2){const g=u.x-t.x,y=u.y-t.y,m=Math.atan2(-y,g),S=m<0?m+2*Math.PI:m;l.push(S*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{En({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:t.x,y:t.y},radius:e}).forEach(g=>{const y=g.x-t.x,m=g.y-t.y,S=Math.atan2(-m,y),x=S<0?S+2*Math.PI:S;l.push(x*180/Math.PI)})}),l.length===0)return{minAngle:0,maxAngle:360,isFullCircle:!0};const d=[...new Set(l.map(u=>Math.round(u*1e6)/1e6))].sort((u,p)=>u-p);if(d.length<2)return{minAngle:0,maxAngle:360,isFullCircle:!0};let f=0,h=0,r=0;for(let u=0;u<d.length;u++){const p=d[u],g=d[(u+1)%d.length];let y;u===d.length-1?y=360-p+g:y=g-p,y>f&&(f=y,h=p,r=g)}return r>h?{minAngle:r,maxAngle:h+360,isFullCircle:!1}:{minAngle:r,maxAngle:h,isFullCircle:!1}}function sr(t,{canvas:e,dpr:s,colors:n}){const i=e.width/s,o=e.height/s;t.resetTransform(),t.scale(s,s),t.fillStyle=n.background,t.fillRect(0,0,i,o)}function nr(t,{allFaces:e,facesVisible:s,isDragConfirmed:n,dragPreviewVertices:i,transformIndicatorData:o,initialDragVertexStates:a,colors:l,initialCoordSystemStates:c},d,f){if(!s||!e||!l||!t)return;const h=r=>{if(n&&i){const u=i.find(p=>p&&p.id===r);if(u)return u}return f(r)};e.forEach(r=>{if(!r||!r.vertexIds||r.vertexIds.length<3)return;const u=r.vertexIds.map(y=>h(y)).filter(y=>y&&y.type==="regular");if(u.length<3)return;const p=u.map(y=>d(y));let g=r;if(n&&r.localCoordSystem&&r.vertexIds.some(y=>i.some(m=>m.id===y))){const y=c.get(r.id),m=Bi(r,{initialSystem:y,dragPreviewVertices:i,initialDragVertexStates:a,findVertexById:f,transformIndicatorData:o});g={...r,localCoordSystem:m}}p.every(y=>y&&typeof y.x=="number"&&typeof y.y=="number")&&Wi(t,p,g,l,d)})}function Bi(t,{initialSystem:e,dragPreviewVertices:s,initialDragVertexStates:n,findVertexById:i,transformIndicatorData:o}){if(!e)return t.localCoordSystem;const a=t.vertexIds.map(r=>s.find(u=>u&&u.id===r)||i(r)).filter(r=>r&&r.type==="regular");if(!e.isCustom){const r=en(a);if(r){const u=o?o.rotation:0,p=o?o.scale:1;return{...e,origin:r.center,scale:e.scale*p,angle:Ce(e.angle+u)}}return e}const l=JSON.parse(JSON.stringify(e));if(o){const{center:r,rotation:u,scale:p,directionalScale:g,startPos:y}=o,m={x:y.x-r.x,y:y.y-r.y};l.origin=Jt(e.origin,r,u,p,g,m),g||(l.angle=Ce(e.angle+u),l.scale=e.scale*p)}const c=new Set(n.map(r=>r.id));let d={...l.origin},f=l.angle,h=l.scale;if(l.attachedToVertex){if(c.has(l.attachedToVertex)){const r=s.find(u=>u.id===l.attachedToVertex);r&&(d={...r})}}else if(l.attachedToEdge&&(c.has(l.attachedToEdge.v1)||c.has(l.attachedToEdge.v2))){const r=s.find(p=>p.id===l.attachedToEdge.v1)||i(l.attachedToEdge.v1),u=s.find(p=>p.id===l.attachedToEdge.v2)||i(l.attachedToEdge.v2);r&&u&&(d={x:r.x+l.attachedToEdge.t*(u.x-r.x),y:r.y+l.attachedToEdge.t*(u.y-r.y)})}if(l.rotationAlignedToEdge&&(c.has(l.rotationAlignedToEdge.v1)||c.has(l.rotationAlignedToEdge.v2))){const r=s.find(p=>p.id===l.rotationAlignedToEdge.v1)||i(l.rotationAlignedToEdge.v1),u=s.find(p=>p.id===l.rotationAlignedToEdge.v2)||i(l.rotationAlignedToEdge.v2);if(r&&u){const p=Math.atan2(u.y-r.y,u.x-r.x),{originalAngle:g,originalSystemAngle:y}=l.rotationAlignedToEdge,m=y-g;f=Ce(p+m)}}if(l.scaleAttachedToEdge&&(c.has(l.scaleAttachedToEdge.v1)||c.has(l.scaleAttachedToEdge.v2))){const r=s.find(p=>p.id===l.scaleAttachedToEdge.v1)||i(l.scaleAttachedToEdge.v1),u=s.find(p=>p.id===l.scaleAttachedToEdge.v2)||i(l.scaleAttachedToEdge.v2);r&&u&&(h=G(r,u)*l.scaleAttachedToEdge.scaleRatio)}return a.length>=3?l.origin=Ds(d,a):l.origin=d,l.angle=f,l.scale=Math.max(.01,h),l}function or(t,{copyCount:e,isDragConfirmed:s,initialDragVertexStates:n,dragPreviewVertices:i,transformIndicatorData:o,allEdges:a,allFaces:l,findVertexById:c,findNeighbors:d,colors:f},h){const r=n.filter(m=>m.type==="regular"),u=new Set(r.map(m=>m.id)),p=a.filter(m=>u.has(m.id1)&&u.has(m.id2)),g=l.filter(m=>m.vertexIds&&m.vertexIds.some(S=>u.has(S))),y=g.every(m=>m.vertexIds.every(S=>u.has(S)));t.save(),t.globalAlpha=1;for(let m=0;m<e;m++){let S;if(m===0)S=n.filter(C=>C.type==="regular");else if(o){const{center:C,rotation:b,scale:v,directionalScale:M,startPos:I}=o,A=b*m,E=Math.pow(v,m),_={x:I.x-C.x,y:I.y-C.y};S=r.map(T=>{const P=Jt(T,C,A,E,M,_);return{...T,id:`preview_${T.id}_${m}`,x:P.x,y:P.y}})}else{const C=i[0].x-n[0].x,b=i[0].y-n[0].y,v=C*m,M=b*m;S=r.map(I=>({...I,id:`preview_${I.id}_${m}`,x:I.x+v,y:I.y+M}))}const x=new Map;S.forEach((C,b)=>{const v=r[b];x.set(v.id,C)}),g.forEach(C=>{const b=C.vertexIds.map(v=>{if(u.has(v))return x.get(v);const M=c(v);return M&&M.type==="regular"?M:null}).filter(Boolean);if(b.length>=3){const v=b.map(M=>h(M));if(v.every(M=>M&&typeof M.x=="number"&&typeof M.y=="number")){let M=C;if(C.localCoordSystem){const I=JSON.parse(JSON.stringify(C.localCoordSystem));if(I.isCustom){if(o&&m>0){const{center:A,rotation:E,scale:_,directionalScale:T,startPos:P}=o,D={x:P.x-A.x,y:P.y-A.y};I.origin=Jt(I.origin,A,E*m,Math.pow(_,m),T,D),I.angle=Ce(I.angle+E*m),T||(I.scale*=Math.pow(_,m))}else if(m>0){const A=i[0].x-n[0].x,E=i[0].y-n[0].y;I.origin.x+=A*m,I.origin.y+=E*m}}else{const A=en(b);A&&(I.origin=A.center,I.scale=A.radius)}M={...C,localCoordSystem:I}}Wi(t,v,M,f,h)}}}),y&&(t.setLineDash([]),p.forEach(C=>{const b=x.get(C.id1),v=x.get(C.id2);if(b&&v){const M=h(b),I=h(v);t.beginPath(),t.moveTo(M.x,M.y),t.lineTo(I.x,I.y),t.strokeStyle=C.color||f.defaultStroke,t.lineWidth=vs,t.stroke()}})),t.setLineDash(y?[]:ks),r.forEach(C=>{const b=x.get(C.id);if(!b)return;d(C.id).forEach(M=>{if(!u.has(M)){const I=c(M);if(I&&I.type==="regular"){const A=h(b),E=h(I);t.beginPath(),t.moveTo(A.x,A.y),t.lineTo(E.x,E.y),t.strokeStyle=f.defaultStroke,t.lineWidth=vs,t.stroke()}}})}),S.forEach(C=>{Vi(t,C,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,currentColor:C.color,colors:f,verticesVisible:!0},h)})}t.restore()}function Co(t,{startVertex:e,snappedData:s,isShiftPressed:n,currentColor:i,nextCreationColor:o,nextEdgeColor:a,colors:l,edgeColormapInfo:c},d){const f=d(e),h=d(s);if(t.save(),t.beginPath(),t.moveTo(f.x,f.y),t.lineTo(h.x,h.y),t.setLineDash(ks),c&&c.colormapItem){const r=t.createLinearGradient(f.x,f.y,h.x,h.y),u=ne(c.colormapItem,c.startT),p=ne(c.colormapItem,c.endT);r.addColorStop(0,u),r.addColorStop(1,p),t.strokeStyle=r}else s.snapped||n?t.strokeStyle=l.feedbackSnapped:t.strokeStyle=a;t.lineWidth=vs,t.stroke(),t.restore(),t.save(),t.beginPath(),t.arc(h.x,h.y,Pt,0,Bt),s.snapped?t.fillStyle=l.feedbackSnapped:t.fillStyle=o,t.fill(),t.restore()}function ir(t,{allVertices:e,dragPreviewVertices:s,viewTransform:n,colors:i,transformIndicatorData:o,copyCount:a,initialDragVertexStates:l},c){if(!s||s.length===0||!l||l.length===0)return;const d=z,f=new Set,h=new Set(l.map(m=>m.id)),r=l.filter(m=>m.type==="regular"),u=e.filter(m=>m.type==="regular"&&!h.has(m.id)),p=a===1?[1]:Array.from({length:a},(m,S)=>S),g=[];if(r.length>0)if(o){const{center:m,rotation:S,scale:x,directionalScale:C,startPos:b}=o,v={x:b.x-m.x,y:b.y-m.y};p.forEach(M=>{const I=S*M,A=Math.pow(x,M),E=r.map(_=>{const T=Jt(_,m,I,A,C,v);return{..._,...T}});g.push(E)})}else{const m=s[0].x-l[0].x,S=s[0].y-l[0].y;p.forEach(x=>{const C=m*x,b=S*x,v=r.map(M=>({...M,x:M.x+C,y:M.y+b}));g.push(v)})}const y=(m,S)=>{if(m.id!==S.id&&G(m,S)<d){const x={x:(m.x+S.x)/2,y:(m.y+S.y)/2},C=c(x),b=`${Math.round(C.x)},${Math.round(C.y)}`;f.has(b)||(t.beginPath(),t.arc(C.x,C.y,Pt,0,2*Math.PI),t.fill(),f.add(b))}};t.fillStyle=i.feedbackSnapped;for(const m of g)for(const S of m)for(const x of u)y(S,x);for(let m=0;m<g.length;m++)for(let S=m+1;S<g.length;S++)for(const x of g[m])for(const C of g[S])y(x,C)}function Fi(t,e,s){const n=[];if(s>360){const o=s-360,a=Math.floor(e/t)*t;for(let l=a;l<360;l+=t)l>=e&&n.push(l);for(let l=0;l<=o+t;l+=t)l<=o&&n.push(l)}else{const o=Math.floor(e/t)*t;for(let a=o;a<=s+t;a+=t)a>=e&&a<=s&&a>=0&&a<360&&n.push(a)}return[...new Set(n)].sort((o,a)=>o-a)}function ar(t,e,s){return t.x>=-20&&t.x<=e+ye&&t.y>=-20&&t.y<=s+ye}function lr(t,e,s,n,i,{canvas:o,dpr:a,viewTransform:l,angleDisplayMode:c,colors:d},f,h){if(typeof f!="function"||typeof s!="function")return;const r=f({x:0,y:0}),u=o.width/a,p=o.height/a,g={x:u/2,y:p/2},y=Math.min(u,p)/4,m=G(r,g),S=y+m;if(S<el||!$i(r.x,r.y,S,u,p))return;t.save(),t.strokeStyle=`rgba(${d.feedbackDefault.join(",")}, 1.0)`,t.lineWidth=rs;const x=Math.min(u,p)*400,C=S>x;let b=null;if(C){const T={x:0,y:0,w:u,h:p},P={x:r.x,y:r.y,r:S},D=bo(P,T);if(D.length>=2){let k=D[0],N=D[1],w=0;for(let O=0;O<D.length;O++)for(let Y=O+1;Y<D.length;Y++){const B=(D[O].x-D[Y].x)**2+(D[O].y-D[Y].y)**2;B>w&&(w=B,k=D[O],N=D[Y])}t.beginPath(),t.moveTo(k.x,k.y),t.lineTo(N.x,N.y),t.stroke();const R=(Math.atan2(r.y-k.y,k.x-r.x)*180/Math.PI+360)%360,L=(Math.atan2(r.y-N.y,N.x-r.x)*180/Math.PI+360)%360;b={minAngle:Math.min(R,L),maxAngle:Math.max(R,L),isFullCircle:!1},Math.abs(R-L)>180&&(b={minAngle:Math.max(R,L),maxAngle:Math.min(R,L)+360,isFullCircle:!1})}}else t.beginPath(),t.arc(r.x,r.y,S,0,2*Math.PI),t.stroke(),b=Oi(r,S,u,p);if(t.restore(),!b)return;const v=S/(l.scale/a),M=new Set,I=new Map;h.forEach(T=>{const P=T.alpha;if(P<.01||S*(T.angle*Math.PI/180)<sl*.5)return;const k=`rgba(${d.feedbackDefault.join(",")}, ${P*.95})`;let N;if(b.isFullCircle){N=[];for(let w=0;w<360;w+=T.angle)N.push(w)}else N=Fi(T.angle,b.minAngle,b.maxAngle);N.forEach(w=>{if(c==="degrees"){if(M.has(w))return}else if(c==="radians"){const B=`${w}-${T.angle}`;if(I.has(B))return}const R=w*Math.PI/180;let L={textAlign:"center",textBaseline:"middle"};c==="radians"&&(L={textAlign:"left",textBaseline:"middle"});let O;if(t.save(),t.strokeStyle=k,t.lineWidth=Ve,w%90===0&&w<360){const B={x:r.x+S*Math.cos(R),y:r.y-S*Math.sin(R)};let F;const j=Lt*1.5;switch(w){case 0:F={x:Math.SQRT1_2,y:-Math.SQRT1_2},L={textAlign:"left",textBaseline:"bottom"};break;case 90:F={x:Math.SQRT1_2,y:-Math.SQRT1_2},L={textAlign:"left",textBaseline:"bottom"};break;case 180:F={x:-Math.SQRT1_2,y:-Math.SQRT1_2},L={textAlign:"right",textBaseline:"bottom"};break;case 270:F={x:Math.SQRT1_2,y:Math.SQRT1_2},L={textAlign:"left",textBaseline:"top"};break}const Z={x:B.x+F.x*j,y:B.y+F.y*j};t.lineWidth=1.5,t.beginPath(),t.moveTo(B.x,B.y),t.lineTo(Z.x,Z.y),t.stroke(),O={x:Z.x,y:Z.y}}else{const B={x:r.x+(S-Pt)*Math.cos(R),y:r.y-(S-Pt)*Math.sin(R)},F={x:r.x+(S+Pt)*Math.cos(R),y:r.y-(S+Pt)*Math.sin(R)};ar(F,u,p)&&(t.beginPath(),t.moveTo(B.x,B.y),t.lineTo(F.x,F.y),t.stroke()),O={x:r.x+(S+In)*Math.cos(R),y:r.y-(S+In)*Math.sin(R)}}t.restore();let Y="";if(c==="degrees"){let B=Math.max(0,(T.angle.toString().split(".")[1]||"").length);T.angle<1&&(B=Math.max(B,Math.ceil(-Math.log10(T.angle))+1)),Y=`${parseFloat(w.toFixed(B))}^{\\circ}`}else if(w===0&&c==="radians")Y="0";else if(w!==0)if(T.angle<=5){const F=w*Math.PI/180;let j;T.angle>=1?j=3:T.angle>=.1?j=4:T.angle>=.01?j=5:T.angle>=.001?j=6:j=7;let Z=F.toFixed(j);parseFloat(Z)!==0&&(Y=Z)}else{const F=w,j=180,Z=Bo(F,j),pt=F/Z,Ut=j/Z;Ut===1?pt===1?Y="\\pi":pt===-1?Y="-\\pi":Y=`${pt}\\pi`:pt===1?Y=`\\frac{\\pi}{${Ut}}`:pt===-1?Y=`-\\frac{\\pi}{${Ut}}`:pt<0?Y=`-\\frac{${Math.abs(pt)}\\pi}{${Ut}}`:Y=`\\frac{${pt}\\pi}{${Ut}}`}if(Y){const B=c==="radians"?`circ-label-${w}-${T.angle}-${v.toExponential(15)}`:`circ-label-${w}-${v.toExponential(15)}`;if(s({id:B,content:Y,x:O.x,y:O.y,color:k,fontSize:mo,options:L}),c==="degrees")M.add(w);else{const F=`${w}-${T.angle}`;I.set(F,{levelAngle:T.angle,alpha:P,labelId:B})}}})});const A=d.feedbackDefault;let E=-1/0;const _={x:r.x+S,y:r.y};if(_.x>-20&&_.x<u+ye&&_.y>-20&&_.y<p+ye)E=0;else{const T={x:0,y:0,w:u,h:p},P={x:r.x,y:r.y,r:S};let k=bo(P,T).map(w=>Math.atan2(r.y-w.y,w.x-r.x));if([{x:0,y:0},{x:T.w,y:0},{x:T.w,y:T.h},{x:0,y:T.h}].forEach(w=>{G(w,P)<P.r&&k.push(Math.atan2(r.y-w.y,w.x-r.x))}),k.length>0){k=k.map(R=>R<0?R+2*Math.PI:R).sort((R,L)=>R-L);let w=[...new Set(k.map(R=>parseFloat(R.toFixed(7))))];if(w.length>0){w.push(w[0]+2*Math.PI);let R=-1/0;for(let L=0;L<w.length-1;L++){const O=w[L],Y=w[L+1],B=(O+Y)/2,F={x:P.x+P.r*Math.cos(B),y:P.y-P.r*Math.sin(B)};F.x>0&&F.x<T.w&&F.y>0&&F.y<T.h&&(R=Y)}R>-1/0&&(E=R%(2*Math.PI))}}}if(E>-1/0){const T=E,P={x:r.x+S*Math.cos(T),y:r.y-S*Math.sin(T)},D={x:-Math.sin(T),y:-Math.cos(T)},k={x:Math.cos(T),y:-Math.sin(T)},N={x:P.x-St*D.x+St/2*k.x,y:P.y-St*D.y+St/2*k.y},w={x:P.x-St*D.x-St/2*k.x,y:P.y-St*D.y-St/2*k.y};t.save(),t.fillStyle=`rgba(${A.join(",")}, 1.0)`,t.beginPath(),t.moveTo(P.x,P.y),t.lineTo(N.x,N.y),t.lineTo(w.x,w.y),t.closePath(),t.fill(),t.restore();let R;if(T===0)R={x:P.x-Qn,y:P.y+to+St};else{const L={x:-Math.cos(T),y:Math.sin(T)};R={x:P.x+L.x*(to+St)+D.x*Qn,y:P.y+L.y*(to+St)+D.y*Qn}}s({id:"theta-label-sticky",content:"\\theta",x:R.x,y:R.y,color:`rgba(${A.join(",")}, 1.0)`,fontSize:je,options:{textAlign:"center",textBaseline:"middle"}})}}function bo(t,e){const{x:s,y:n,r:i}=t,{x:o,y:a,w:l,h:c}=e,d=[],f=(h,r,u,p)=>{const g=u-h,y=p-r,m=g*g+y*y,S=2*(g*(h-s)+y*(r-n)),x=(h-s)*(h-s)+(r-n)*(r-n)-i*i,C=S*S-4*m*x;if(C<0)return;const b=Math.sqrt(C),v=(-S+b)/(2*m),M=(-S-b)/(2*m);[v,M].forEach(I=>{I>=0&&I<=1&&d.push({x:h+I*g,y:r+I*y})})};return f(o,a,o+l,a),f(o+l,a,o+l,a+c),f(o+l,a+c,o,a+c),f(o,a+c,o,a),d}function $i(t,e,s,n,i){return!(t+s<0||t-s>n||e+s<0||e-s>i)}function rr(t,e,s,n,i,o,a){const l=`rgba(${a.axisTickLabel.join(",")}, ${go})`,c=Lt*Ia;t.save(),t.strokeStyle=l,t.lineWidth=Ta,t.setLineDash([]);const d=c,f=d/Math.tan(va),h=e.x-f,r=e.y+d;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(h,r),t.stroke(),t.restore(),o({id:"tick-label-origin",content:La,x:e.x-Lt-ke,y:e.y+Lt+ke,color:l,fontSize:Je,options:{textAlign:"right",textBaseline:"top"}})}function cr(t,e,{canvas:s,dpr:n,coordsDisplayMode:i,viewTransform:o,angleDisplayMode:a,colors:l},c,d,f,h,r){t.save();const u=s.width/n,p=s.height/n,g=c({x:0,y:0}),y=(S,x,C,b)=>{t.beginPath(),t.moveTo(S,x),t.lineTo(C,b),t.stroke();const v=Math.atan2(b-x,C-S);t.beginPath(),t.moveTo(C,b),t.lineTo(C-St*Math.cos(v-Oe),b-St*Math.sin(v-Oe)),t.lineTo(C-St*Math.cos(v+Oe),b-St*Math.sin(v+Oe)),t.closePath(),t.fill()},m=(S,x,C,b,v)=>{const M=new Map,I=new Map,A=(_,T,P)=>{if(!_||T<Sn)return;const D=d({x:0,y:0}),k=d({x:u,y:p}),N=_*z;if(v){const w=Math.hypot(Math.max(Math.abs(D.x),Math.abs(k.x)),Math.max(Math.abs(D.y),Math.abs(k.y)))*ka;for(let R=_;R<=w;R+=_){if(Math.abs(R)<N)continue;const L=M.get(R);L?P?M.set(R,{alpha:Math.max(L.alpha,T),isCoarser:!0}):L.isCoarser||M.set(R,{alpha:Math.max(L.alpha,T),isCoarser:!1}):M.set(R,{alpha:T,isCoarser:P})}}else{const w=Math.floor(D.x/_)*_,R=Math.ceil(k.x/_)*_,L=Math.floor(k.y/_)*_,O=Math.ceil(D.y/_)*_;for(let Y=w;Y<=R;Y+=_){if(Math.abs(Y)<N)continue;const B=M.get(Y);B?P?M.set(Y,{alpha:Math.max(B.alpha,T),isCoarser:!0}):B.isCoarser||M.set(Y,{alpha:Math.max(B.alpha,T),isCoarser:!1}):M.set(Y,{alpha:T,isCoarser:P})}for(let Y=L;Y<=O;Y+=_){if(Math.abs(Y)<N)continue;const B=I.get(Y);B?P?I.set(Y,{alpha:Math.max(B.alpha,T),isCoarser:!0}):B.isCoarser||I.set(Y,{alpha:Math.max(B.alpha,T),isCoarser:!1}):I.set(Y,{alpha:T,isCoarser:P})}}},E=!C||S>=C;A(S,x,E),A(C,b,!E),M.forEach((_,T)=>{const P=_.isCoarser?1:_.alpha,D=`rgba(${l.axisTickLabel.join(",")}, ${go*P})`;t.strokeStyle=D,t.lineWidth=Ve;let k=S;C&&Math.abs(T%C)<Math.abs(T%S)&&(k=C);const N=k*o.scale;let w=0;N>Jo?w=3:N>Zo?w=2:N>Qo?w=1:w=0;const R=k>0?-Math.floor(Math.log10(k)):0;if(R>0&&(w=Math.max(w,R+1)),v){const L=Et(T,w),O=T.toExponential(15),Y=g.y>-20&&g.y<p+ye,B=g.x>-20&&g.x<u+ye,F=c({x:T,y:0});Y&&F.x>-20&&F.x<u+ye&&(t.beginPath(),t.moveTo(F.x,g.y-Lt/2),t.lineTo(F.x,g.y+Lt/2),t.stroke(),r({id:`polartick-r-x-${O}`,content:L,x:F.x,y:g.y+Lt+ke,color:D,fontSize:Je,options:{textAlign:"center",textBaseline:"top"}}));const j=c({x:-T,y:0});Y&&j.x>-20&&j.x<u+ye&&(t.beginPath(),t.moveTo(j.x,g.y-Lt/2),t.lineTo(j.x,g.y+Lt/2),t.stroke(),r({id:`polartick-r-negx-${O}`,content:L,x:j.x,y:g.y+Lt+ke,color:D,fontSize:Je,options:{textAlign:"center",textBaseline:"top"}}));const Z=c({x:0,y:T});B&&Z.y>-20&&Z.y<p+ye&&(t.beginPath(),t.moveTo(g.x-Lt/2,Z.y),t.lineTo(g.x+Lt/2,Z.y),t.stroke(),r({id:`polartick-r-posy-${O}`,content:L,x:g.x-Lt-ke,y:Z.y,color:D,fontSize:Je,options:{textAlign:"right",textBaseline:"middle"}}));const pt=c({x:0,y:-T});B&&pt.y>-20&&pt.y<p+ye&&(t.beginPath(),t.moveTo(g.x-Lt/2,pt.y),t.lineTo(g.x+Lt/2,pt.y),t.stroke(),r({id:`polartick-r-negy-${O}`,content:L,x:g.x-Lt-ke,y:pt.y,color:D,fontSize:Je,options:{textAlign:"right",textBaseline:"middle"}}))}else{const L=c({x:T,y:0}).x;t.beginPath(),t.moveTo(L,g.y),t.lineTo(L,g.y+Lt),t.stroke(),r({id:((Y,B)=>`${Y}-${B.toExponential(15)}`)("tick-label-x",T),content:Et(T,w),x:L,y:g.y+Lt+ke,color:D,fontSize:Je,options:{textAlign:"center",textBaseline:"top"}})}}),v||I.forEach((_,T)=>{const P=_.isCoarser?1:_.alpha,D=`rgba(${l.axisTickLabel.join(",")}, ${go*P})`;t.strokeStyle=D,t.lineWidth=Ve;let k=S;C&&Math.abs(T%C)<Math.abs(T%S)&&(k=C);const N=k*o.scale;let w=0;N>Jo?w=3:N>Zo?w=2:N>Qo?w=1:w=0;const R=k>0?-Math.floor(Math.log10(k)):0;R>0&&(w=Math.max(w,R+1));const L=c({x:0,y:T}).y;let O=Et(T,w);i===Gs&&O!=="0"&&(O==="1"?O=xn:O==="-1"?O=`-${xn}`:O+=xn),t.beginPath(),t.moveTo(g.x,L),t.lineTo(g.x-Lt,L),t.stroke(),r({id:((B,F)=>`${B}-${F.toExponential(15)}`)("tick-label-y",T),content:O,x:g.x-Lt-ke,y:L,color:D,fontSize:Je,options:{textAlign:"right",textBaseline:"middle"}})})};if(t.lineWidth=Ra,t.strokeStyle=l.axis,t.fillStyle=l.axis,i===Fn){const{interval1:S,interval2:x,alpha1:C,alpha2:b}=f;t.lineWidth=Ve;const v=u>g.x,M=0<g.x,I=0<g.y,A=p>g.y;v&&(y(g.x,g.y,u,g.y),r({id:"axis-label-r-posx",content:fn,x:u-St-jn,y:g.y-Kn,color:l.axis,fontSize:je,options:{textAlign:"center",textBaseline:"bottom"}})),M&&(y(g.x,g.y,0,g.y),r({id:"axis-label-r-negx",content:fn,x:St+jn,y:g.y-Kn,color:l.axis,fontSize:je,options:{textAlign:"center",textBaseline:"bottom"}})),I&&(y(g.x,g.y,g.x,0),r({id:"axis-label-r-posy",content:fn,x:g.x+Jn,y:St+Zn,color:l.axis,fontSize:je,options:{textAlign:"left",textBaseline:"middle"}})),A&&(y(g.x,g.y,g.x,p),r({id:"axis-label-r-negy",content:fn,x:g.x+Jn,y:p-St-Zn,color:l.axis,fontSize:je,options:{textAlign:"left",textBaseline:"middle"}})),m(S,C,x,b,!0),lr(t,e,r,0,0,{canvas:s,dpr:n,viewTransform:o,angleDisplayMode:a,colors:l},c,h)}else{g.y>0&&g.y<p&&y(0,g.y,u,g.y),g.x>0&&g.x<u&&y(g.x,p,g.x,0);let S="x",x="y";i===Gs&&(S=Na,x=Oa),r({id:"axis-label-x",content:S,x:u-St-jn,y:g.y-Kn,color:l.axis,fontSize:je,options:{textAlign:"center",textBaseline:"bottom"}}),r({id:"axis-label-y",content:x,x:g.x+Jn,y:St+Zn,color:l.axis,fontSize:je,options:{textAlign:"left",textBaseline:"middle"}}),m(f.interval1,f.alpha1,f.interval2,f.alpha2,!1)}rr(t,g,u,p,i,r,l),t.restore()}function dr(t,{gridDisplayMode:e,canvas:s,dpr:n,viewTransform:i,gridAlpha:o,colors:a},l,c,d,f){if(e===Ns)return;t.save();const h=l({x:0,y:0}),r=s.width/n,u=s.height/n;if(e===Oo){const p=c({x:0,y:0}),g=c({x:r,y:u}),y=Math.hypot(Math.max(Math.abs(p.x),Math.abs(g.x)),Math.max(Math.abs(p.y),Math.abs(g.y))),m=Math.min(r,u)*Ma,S=(v,M)=>{if(!(!v||M<Sn||v*i.scale/n<Cl)){t.strokeStyle=`rgba(${a.grid.join(",")}, ${M*o})`,t.lineWidth=Ve;for(let A=v;A<=y;A+=v){const E=A*i.scale/n;if(E>m){const _={x:h.x,y:h.y,r:E},T=bo(_,{x:0,y:0,w:r,h:u});if(T.length>=2){let P=T[0],D=T[1],k=0;for(let N=0;N<T.length;N++)for(let w=N+1;w<T.length;w++){const R=(T[N].x-T[w].x)**2+(T[N].y-T[w].y)**2;R>k&&(k=R,P=T[N],D=T[w])}t.beginPath(),t.moveTo(P.x,P.y),t.lineTo(D.x,D.y),t.stroke()}}else $i(h.x,h.y,E,r,u)&&(t.beginPath(),t.arc(h.x,h.y,E,0,Bt),t.stroke())}}};S(d.interval1,d.alpha1),S(d.interval2,d.alpha2);const x=y*i.scale/n,C=new Set;let b=null;if(x<r*10?b={ranges:[[0,360]],isFullCircle:!0}:b=Oi(h,x,r,u),!b){t.restore();return}f.forEach(v=>{if(v.alpha<Sn||x*(v.angle*Math.PI/180)<bl&&x>Ml)return;t.strokeStyle=`rgba(${a.grid.join(",")}, ${v.alpha*o})`,t.lineWidth=Ve;let I=[];if(b.isFullCircle)for(let A=0;A<mn;A+=v.angle)I.push(A);else b.ranges.forEach(A=>{const[E,_]=A;I.push(...Fi(v.angle,E,_))}),I=[...new Set(I)];I.forEach(A=>{if(C.has(A))return;const E=A*Math.PI/180,_=h.x+x*Math.cos(E),T=h.y-x*Math.sin(E);t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(_,T),t.stroke(),C.add(A)})})}else{const p=(g,y)=>{if(!g||y<Sn)return;const m=`rgba(${a.grid.join(",")}, ${y*o})`,S=c({x:0,y:u}),x=c({x:r,y:0}),C=Math.floor(S.x/g)*g,b=Math.ceil(x.x/g)*g,v=Math.floor(S.y/g)*g,M=Math.ceil(x.y/g)*g;if(e===Lo){t.strokeStyle=m,t.lineWidth=Ve;for(let I=C;I<=b;I+=g){const A=l({x:I,y:0}).x;t.beginPath(),t.moveTo(A,0),t.lineTo(A,u),t.stroke()}for(let I=v;I<=M;I+=g){const A=l({x:0,y:I}).y;t.beginPath(),t.moveTo(0,A),t.lineTo(r,A),t.stroke()}}else if(e===ko){t.fillStyle=m;const I=ri*n;for(let A=C;A<=b;A+=g)for(let E=v;E<=M;E+=g){const _=l({x:A,y:E});t.beginPath(),t.arc(_.x,_.y,I,0,Bt),t.fill()}}else if(e===No){t.fillStyle=m;const I=ri*n,A=g*Ei,E=Math.floor(S.y/A)*A,_=Math.ceil(x.y/A)*A;for(let T=E;T<=_;T+=A){const D=Math.round(T/A)%2!==0?g/2:0;for(let k=C;k<=b;k+=g){const N=k+D,w=l({x:N,y:T});t.beginPath(),t.arc(w.x,w.y,I,0,Bt),t.fill()}}}};p(d.interval1,d.alpha1),p(d.interval2,d.alpha2)}t.restore()}function $o(t,e,s,n,i,o,a=!1){t.save(),t.strokeStyle=o,t.lineWidth=Ve,t.setLineDash(a?ba:[]);const l=-s,c=-n;let d=_t(n-s);t.beginPath(),t.arc(e.x,e.y,i,l,c,d>0),t.stroke(),t.restore()}function Vi(t,e,{selectedVertexIds:s,selectedCenterIds:n,activeCenterId:i,colors:o,verticesVisible:a=!0,isHovered:l=!1},c,d){let f;if(e.type===Is){if(f=s.includes(e.id),!a&&!f&&!l)return}else f=n.includes(e.id);const h=e.color||o.vertex,r=c(e);switch(e.type){case Is:t.beginPath(),t.arc(r.x,r.y,Pt,0,Bt),t.fillStyle=h,t.fill();break;case be:case ds:case hs:const p=uo*2,g={type:e.type,x:r.x-p/2,y:r.y-p/2,width:p,height:p};Vo(t,g,o);break}if(f||l){t.save(),t.shadowColor=e.id===i?o.activeCenterGlow:o.selectionGlow,t.shadowBlur=ul,t.globalAlpha=wi,t.beginPath();let p;e.type===Is?p=Pt+ai:p=uo+ai,t.arc(r.x,r.y,p,0,Bt),t.strokeStyle=e.id===i?o.activeCenterGlow:o.selectionGlow,t.lineWidth=Di,t.stroke(),t.restore()}}function hr(t,{allEdges:e,selectedEdgeIds:s,isDragConfirmed:n,dragPreviewVertices:i,colors:o,edgesVisible:a},l,c,d){t.lineWidth=vs,e.forEach(f=>{const h=c(f.id1),r=c(f.id2);if(!h||!r||h.type!==Is||r.type!==Is)return;const u=d(f),p=s.includes(u);if(!a&&!p)return;let g={...h},y={...r},m=!1;if(n&&i.length>0){const C=i.find(I=>I.id===h.id),b=i.find(I=>I.id===r.id);m=!!C!==!!b,C&&(g.x=C.x,g.y=C.y),b&&(y.x=b.x,y.y=b.y)}const S=l(g),x=l(y);if(t.beginPath(),t.moveTo(S.x,S.y),t.lineTo(x.x,x.y),f.colormapItem){const C=t.createLinearGradient(S.x,S.y,x.x,x.y),b=ne(f.colormapItem,f.gradientStart),v=ne(f.colormapItem,f.gradientEnd);C.addColorStop(0,b),C.addColorStop(1,v),t.strokeStyle=C}else t.strokeStyle=f.color||o.defaultStroke;t.setLineDash(m?ks:[]),t.lineWidth=vs,t.stroke(),t.setLineDash([]),p&&(t.beginPath(),t.moveTo(S.x,S.y),t.lineTo(x.x,x.y),t.strokeStyle=o.selectionGlow,t.globalAlpha=wi,t.lineWidth=vs+pl,t.stroke(),t.globalAlpha=1)}),t.setLineDash([]),t.strokeStyle=o.defaultStroke}function fr(t,e,{transformIndicatorData:s,angleSigFigs:n,distanceSigFigs:i,colors:o,coordSystemTransformIndicatorData:a},l,c){if(s){const{center:d,startPos:f,currentPos:h,rotation:r,scale:u,isSnapping:p,snappedScaleValue:g,gridToGridInfo:y,transformType:m,directionalScale:S}=s,x=l(d),C=l(f),b=p?o.feedbackSnapped:`rgba(${o.feedbackDefault.join(",")}, 1.0)`;if(t.save(),t.setLineDash(ks),t.strokeStyle=b,t.lineWidth=rs,m===be){const v=l(h),M={x:C.x-x.x,y:C.y-x.y},I=Math.hypot(M.x,M.y),A=Math.atan2(M.y,M.x);if(t.beginPath(),t.moveTo(x.x,x.y),t.lineTo(C.x,C.y),t.stroke(),t.beginPath(),t.moveTo(x.x,x.y),t.lineTo(v.x,v.y),t.stroke(),Math.abs(r)>hn){const E=-r,_=r>0;t.setLineDash([]),t.beginPath(),t.arc(x.x,x.y,I,A,A+E,_),t.stroke()}}else if(m===ds||m===hs){const v={x:d.x+(f.x-d.x)*u,y:d.y+(f.y-d.y)*u},M=l(v);t.beginPath(),t.moveTo(x.x,x.y),t.lineTo(C.x,C.y),t.stroke(),Math.abs(u-1)>hn&&(t.setLineDash([]),t.beginPath(),t.moveTo(x.x,x.y),t.lineTo(M.x,M.y),t.stroke())}if(t.setLineDash([]),t.restore(),m===be&&Math.abs(r)>hn){const v=r*(180/Math.PI),M=`${parseFloat(v.toFixed(4)).toString()}^{\\circ}`,I={x:C.x-x.x,y:C.y-x.y},A=Math.atan2(I.y,I.x)+-r/2,_=Math.hypot(I.x,I.y)+nl,T=x.x+_*Math.cos(A),P=x.y+_*Math.sin(A);c({id:"transform-angle-indicator",content:M,x:T,y:P,color:b,fontSize:fe,options:{textAlign:"center",textBaseline:"middle"}})}else c({id:"transform-angle-indicator",content:"",x:0,y:0,color:b,fontSize:fe,options:{textAlign:"center",textBaseline:"middle"}},e);if((m===ds||m===hs)&&Math.abs(u-1)>hn){let v;const M=p&&g!==null?g:u;if(Math.abs(M-1)<.001)v="\\times 1";else if(p&&y){const{startSquaredSum:k,snapSquaredSum:N}=y,[w,R]=He(k),[L,O]=He(N);if(R===1&&O===1)v=`\\times \\frac{${L}}{${w}}`;else if(R===O)v=`\\times \\frac{${L}}{${w}}`;else{const Y=We(L,O),B=We(w,R);v=`\\times \\frac{${Y}}{${B}}`}}else p&&g!==null?v=`\\times ${Ts(g,wo,ll)}`:v=`\\times ${parseFloat(M.toFixed(4)).toString()}`;const I=(x.x+C.x)/2,A=(x.y+C.y)/2,E=Math.atan2(C.y-x.y,C.x-x.x);let _=E-Math.PI/2;const T=I+Math.cos(_)*ni,P=A+Math.sin(_)*ni;let D=E*(me/Math.PI);(D>Ao||D<-90)&&(D+=me),c({id:"transform-scale-indicator",content:v,x:T,y:P,color:b,fontSize:fe,options:{textAlign:"center",textBaseline:"bottom",rotation:D}},e)}else c({id:"transform-scale-indicator",content:"",x:0,y:0,color:b,fontSize:fe,options:{textAlign:"center",textBaseline:"bottom"}},e)}if(a){const{edgeFraction:d,orthogonalDistanceFraction:f,v1:h,v2:r,snapPosition:u}=a;let p="",g={x:0,y:0};if(f!==void 0){p=Ts(f,.001,8);const y=l(u.origin),m=l(u.closest),S=(y.x+m.x)/2,x=(y.y+m.y)/2,C=Math.atan2(m.y-y.y,m.x-y.x);g.x=S+Math.cos(C+Math.PI/2)*rn,g.y=x+Math.sin(C+Math.PI/2)*rn}else if(d!==void 0){const y=l(h),m=l(r),S=l(u),x=Math.atan2(m.y-y.y,m.x-y.x),C=Math.cos(x+Math.PI/2)*rn,b=Math.sin(x+Math.PI/2)*rn;g.x=S.x+C,g.y=S.y+b,p=Ts(d,.001,8)}p&&c({id:"coord-system-edge-fraction",content:p,x:g.x,y:g.y,color:o.feedbackSnapped,fontSize:Sa,options:{textAlign:"center",textBaseline:"middle"}})}}function ur(t,e,s,n,{showAngles:i,showDistances:o,viewTransform:a,mousePos:l,colors:c}){if(!i&&!o||!e.frozen_Origin_Data_to_display)return;const d=e.frozen_Origin_Data_to_display,f=n(l);if(G(d,f)<z)return;const r=c.frozenReference,u=e.displayAngleA_valueRad_for_A_equals_label,p=e.frozen_A_baseRad_to_display!==null?e.frozen_A_baseRad_to_display:0;if(!d)return;const g=s(d),y=p+u;if(t.save(),t.lineWidth=rs,t.strokeStyle=r,i&&e.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(e.displayAngleA_valueRad_for_A_equals_label)>z){const m=ei+t.lineWidth/2,S={x:d.x+Math.cos(p)*(m/a.scale),y:d.y+Math.sin(p)*(m/a.scale)},x=s(S);t.beginPath(),t.moveTo(g.x,g.y),t.lineTo(x.x,x.y),t.setLineDash(_a),t.stroke(),$o(t,g,p,y,ei,r,!1)}t.restore()}function Mo(t,e,s,n,i,{showDistances:o,showAngles:a,currentShiftPressed:l,distanceSigFigs:c,angleSigFigs:d,angleDisplayMode:f,viewTransform:h,frozenReference_D_du:r,gridDisplayMode:u,frozenReference_A_rad:p,colors:g},y,m,S){if(!a&&!o||i.distance<z)return;const x=y(s),{angle:C,distance:b,lengthSnapFactor:v,angleSnapFactor:M,angleTurn:I,gridToGridSquaredSum:A,gridInterval:E}=i,{offsetAngleRad:_,isFirstSegmentBeingDrawn:T}=m,P=l?g.feedbackSnapped:g.geometryInfoText,D=Math.atan2(n.y-s.y,n.x-s.x);if(b*h.scale/window.devicePixelRatio<Pt)return;const k=a&&b>z&&Math.abs(I)>z;if(o){let N="";if(l&&!T&&r!==null){const w=b;if(A!==null&&E){const R=E*Math.sqrt(A);if(Math.abs(R-r)<z)N=fl;else{let L=!1;for(const O of Tn)if(Math.abs(w/r-O)<z){N=yn(O,"D"),L=!0;break}if(!L){const[O,Y]=He(A),B=E*O,F=parseFloat(B.toFixed(10));N=We(F,Y)}}}else if(r>z){const R=w/r;let L=!1;for(const O of Tn)if(Math.abs(R-O)<z){N=yn(O,"D"),L=!0;break}L||(N=Et(b,c))}else N=Et(b,c)}else if(l&&T&&u!==Ns&&E)if(A!==null&&E){if(A>=0){const[w,R]=He(A),L=E*w,O=parseFloat(L.toFixed(10));N=We(O,R)}}else N=Et(b,c);else N=Et(b,c);if(N){const w=y(s),R=y(n),L=Math.atan2(R.y-w.y,R.x-w.x),O=(w.x+R.x)/2,Y=(w.y+R.y)/2;let B;k?I>z?B=L-Math.PI/2:I<-1e-9?B=L+Math.PI/2:B=L-Math.PI/2:Math.abs(Math.sin(L))<di?B=L-Math.PI/2:Math.abs(Math.cos(L))<di?(B=L,Math.sin(L)<0?B+=Math.PI/2:B-=Math.PI/2):(B=L-Math.PI/2,Math.sin(B)>0&&(B+=Math.PI));const F=O+Math.cos(B)*Be,j=Y+Math.sin(B)*Be;let Z=L*(me/Math.PI);(Z>Ao||Z<-90)&&(Z+=me),S({id:"snap-dist",content:N,x:F,y:j,color:P,fontSize:fe,options:{textAlign:"center",textBaseline:"middle",rotation:Z}},e)}}if(k){const N=T?0:_;$o(t,x,N,D,vn,P),t.save(),t.beginPath();const w=vn+t.lineWidth/2,R={x:s.x+w/h.scale*Math.cos(N),y:s.y+w/h.scale*Math.sin(N)},L=y(R);t.moveTo(x.x,x.y),t.lineTo(L.x,L.y),t.strokeStyle=P,t.setLineDash(Ea),t.lineWidth=rs,t.stroke(),t.restore();let O="";const Y=!T&&p!==null&&Math.abs(p)>z;if(f===fs)if(l&&Y){const B=Math.abs(m.currentSegmentReferenceA_for_display);let F=null;if(typeof M=="number")F=M;else if(I!==null&&Math.abs(B)>z){const j=I/B;for(const Z of cs)if(Math.abs(Math.abs(j)-Z)<z){F=j<0?-Z:Z;break}}if(F!==null&&Math.abs(F)>z)O=yn(F,"A");else{let j=I*(me/Math.PI);Math.abs(j)>z&&(O=`${Et(j,d)}^{\\circ}`)}}else{let B=T?D:I;if(l&&!T){let F=B*(me/Math.PI);Math.abs(F)>z&&(O=`${Et(F,d)}^{\\circ}`)}else{let F=_t(B)*(me/Math.PI);Math.abs(F)>z&&(O=`${Et(F,d)}^{\\circ}`)}}else if(f===tn)if(l&&Y){const B=Math.abs(m.currentSegmentReferenceA_for_display);let F=null;if(typeof M=="number")F=M;else if(I!==null&&Math.abs(B)>z){const j=I/B;for(const Z of cs)if(Math.abs(Math.abs(j)-Z)<z){F=j<0?-Z:Z;break}}if(F!==null&&Math.abs(F)>z){const j=yn(F,null);O=`${j==="0"?"0":j+ae}`,O.startsWith(`1${ae}`)&&(O=ae),O.startsWith(`-1${ae}`)&&(O=`-${ae}`),O===`0${ae}`&&(O="0")}else{let j=I;Math.abs(j)>z&&(O=Et(j,d))}}else{let B=T?D:I;if(l&&!T){let F=B;Math.abs(F)>z&&(O=Et(F,d))}else{let F=_t(B);Math.abs(F)>z&&(O=Et(F,d))}}if(O){const B=-N,F=-D,j=Math.cos(B)+Math.cos(F),Z=Math.sin(B)+Math.sin(F);let pt=Math.atan2(Z,j);const Ut=x.x+Math.cos(pt)*si,Gt=x.y+Math.sin(pt)*si;S({id:"snap-angle",content:O,x:Ut,y:Gt,color:P,fontSize:fe,options:{textAlign:"center",textBaseline:"middle"}},e)}}}function pr(t,e,{showAngles:s,showDistances:n,viewTransform:i,mousePos:o,frozenReference_D_du:a,distanceSigFigs:l,angleSigFigs:c,angleDisplayMode:d,colors:f},h,r,u){const p=Qa/i.scale;let g=-1;if(e.frozen_Origin_Data_to_display){const _=e.frozen_Origin_Data_to_display,T=h(o);g=G(_,T)}if(!s&&!n||!e.frozen_Origin_Data_to_display||g<p)return;const y=f.frozenReference,m=e.frozen_Origin_Data_to_display,S=e.displayAngleA_valueRad_for_A_equals_label,x=e.frozen_A_baseRad_to_display!==null?e.frozen_A_baseRad_to_display:0,C=e.frozen_D_du_to_display,b=e.frozen_D_g2g_to_display?e.frozen_D_g2g_to_display.g2gSquaredSum:null,v=e.frozen_D_g2g_to_display?e.frozen_D_g2g_to_display.interval:null;if(!m)return;const M=x+S,I={x:m.x+C*Math.cos(M),y:m.y+C*Math.sin(M)},A=r(m),E=r(I);if(n&&C!==null&&C>p&&a!==null){let _="";if(b!==null&&b>0&&v){const[L,O]=He(b),Y=v*L,B=parseFloat(Y.toFixed(10));_=`${ii}${We(B,O)}`}else{const L=C/yo;_=`${ii}${Et(L,l)}`}const T=Math.atan2(E.y-A.y,E.x-A.x),P=(A.x+E.x)/2,D=(A.y+E.y)/2;let k=T*(me/Math.PI);(k>Ao||k<-90)&&(k+=me);let N;if(s&&S!==null&&Math.abs(S)>z){const L=-x,O=-(x+S),Y=Math.cos(L)+Math.cos(O),B=Math.sin(L)+Math.sin(O),F=Math.atan2(B,Y),j=T-Math.PI/2,Z=T+Math.PI/2,pt=Math.abs(_t(j-F)),Ut=Math.abs(_t(Z-F));N=pt>Ut?j:Z}else N=T-Math.PI/2,Math.sin(N)>0&&(N+=Math.PI);const w=P+Math.cos(N)*In,R=D+Math.sin(N)*In;u({id:"ref-dist",content:_,x:w,y:R,color:y,fontSize:mo,options:{textAlign:"center",textBaseline:"middle",rotation:k}},t)}if(s&&S!==null&&Math.abs(S)>z){const _=-x,T=-(x+S),P=Math.cos(_)+Math.cos(T),D=Math.sin(_)+Math.sin(T);let k=Math.atan2(D,P);const N=tl,w=A.x+Math.cos(k)*N,R=A.y+Math.sin(k)*N;let L="";if(d===fs){let O=S*(me/Math.PI);L=`${Bs}${Et(O,c)}^{\\circ}`}else d===tn&&(L=`${Bs}${Ts(S/Math.PI,wo,Pi)}${ae}`,L===`${Bs}1${ae}`&&(L=ae),L===`${Bs}-1${ae}`&&(L=`-${ae}`),L===`${Bs}0${ae}`&&(L="0"));u({id:"ref-angle",content:L,x:w,y:R,color:y,fontSize:mo,options:{textAlign:"center",textBaseline:"middle"}},t)}}function gr(t,{coordsDisplayMode:e,isMouseOverCanvas:s,currentShiftPressed:n,ghostVertexPosition:i,gridDisplayMode:o,lastGridState:a,angleDisplayMode:l,canvas:c,dpr:d,mousePos:f,colors:h},r,u){if(e===Bn||!f||!s)return;let p;n&&i?p=i:p=r(f);let g=1;o!==Ns&&a&&a.interval1&&(g=a.alpha2>a.alpha1&&a.interval2?a.interval2:a.interval1);let y=0;g>0&&(y=Math.max(0,-Math.floor(Math.log10(g*rl))),y=Math.min(y+1,cl));const m=Math.min(y+1,dl);let S="";switch(e){case Ro:{let C=p.x,b=p.y,v=C.toFixed(y);C>=0&&(v=`${Cs}${v}`);let M=b.toFixed(y);b>=0&&(M=`${Cs}${M}`),S=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${v} \\\\ ${M} \\end{pmatrix*}`;break}case Gs:{let C=p.x,b=p.y,v=C.toFixed(y);C>=0&&(v=`${Cs}${v}`);let M=Math.abs(b).toFixed(y);const I=b<0?"-":"+";S=`z = ${v} ${I} ${M}${xn}`;break}case Fn:{let C=Math.hypot(p.x,p.y),b=Math.atan2(p.y,p.x),v=C.toFixed(y);C>=0&&(v=`${Cs}${v}`);let M;if(l===fs){let I=Ol(b*180/Math.PI);M=I.toFixed(m),I>=0&&(M=`${Cs}${M}`),M+="^{\\circ}"}else{let I=_t(b);M=I.toFixed(m),I>=0&&(M=`${Cs}${M}`)}S=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${v} \\\\ ${M} \\end{pmatrix*}`;break}}const x=c.width/d;u({id:"mouse-coord-text",content:S,x:x-ti,y:ti,color:h.mouseCoords,fontSize:hl,options:{textAlign:"right",textBaseline:"top"}},t)}function Yi(t,e,s,n){t.save();const i=e.x+e.width/2,o=e.y+e.height/2,a=e.width/2*.6;if(t.strokeStyle=n.uiIcon,t.fillStyle=n.uiIcon,t.lineWidth=2,s==="dark"){t.beginPath(),t.arc(i,o,a*.7,0,2*Math.PI),t.fill();for(let l=0;l<8;l++){const c=l/8*2*Math.PI,d=i+Math.cos(c)*(a*.85),f=o+Math.sin(c)*(a*.85),h=i+Math.cos(c)*(a*1.1),r=o+Math.sin(c)*(a*1.1);t.beginPath(),t.moveTo(d,f),t.lineTo(h,r),t.stroke()}}else t.beginPath(),t.arc(i,o,a,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(i-5,o-3,a,0,2*Math.PI),t.fillStyle=n.background,t.fill();t.restore()}function yr(t,e,s,n,i,o,a){const l=n?a.uiIconSelected:a.uiIconDefault,c={x:e.x+e.width/2,y:e.y+e.height/2};t.save(),t.translate(c.x,c.y);const d=e.width/Qs;t.scale(d,d),t.translate(-16,-16);const f=1;t.strokeStyle=l,t.lineWidth=Ge,t.lineCap="round",t.beginPath(),t.moveTo(2+f,30),t.lineTo(30+f,30),t.moveTo(2+f,30),t.lineTo(2+f,2),t.stroke(),t.fillStyle=l;const h={x:16+f,y:16};let r={x:17+f,y:8},u="";switch(s){case Ro:t.setLineDash(no),t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(h.x,30),t.moveTo(h.x,h.y),t.lineTo(2+f,h.y),t.stroke(),t.setLineDash([]),t.beginPath(),t.arc(h.x,h.y,Ye,0,Bt),t.fill(),u="(x,y)";break;case Gs:t.setLineDash(no),t.beginPath(),t.moveTo(2+f,30),t.lineTo(h.x,h.y),t.stroke(),t.setLineDash([]),t.beginPath(),t.arc(h.x,h.y,Ye,0,Bt),t.fill(),u="x+iy";break;case Fn:t.setLineDash(no),t.beginPath(),t.moveTo(2+f,30),t.lineTo(h.x,h.y),t.stroke(),t.beginPath(),t.arc(2+f,30,8,-Math.atan2(30-h.y,h.x-(2+f)),0),t.stroke(),t.setLineDash([]),t.beginPath(),t.arc(h.x,h.y,Ye,0,Bt),t.fill(),u="(r,\\theta)";break}if(t.restore(),u){const p="icon-label-coords",g=n?a.uiTextSelected:a.uiTextDefault;o({id:p,content:u,x:c.x+(r.x-16)*d,y:c.y+(r.y-16)*d,color:g,fontSize:_i,options:{textAlign:"center",textBaseline:"middle"}},i)}}function Xi(t,e,s,n,i,o,a){const l=n?a.uiIconSelected:a.uiIconDefault,c={x:e.x+e.width/2,y:e.y+e.height/2};let d=0;t.save(),t.translate(c.x,c.y);const f=e.width/Qs;t.scale(f,f),t.translate(-16,-16),t.strokeStyle=l,t.lineWidth=Ge;const h={x:28,y:30},r={x:4,y:30},u={x:16,y:8};t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(r.x,r.y),t.lineTo(u.x,u.y),t.stroke();let p="",g={x:20,y:22};if(s!==Hs){t.beginPath();const y=Math.atan2(u.y-r.y,u.x-r.x);t.arc(r.x,r.y,8,y,0),t.stroke(),s===fs?p="60^\\circ":s===tn&&(p="\\frac{\\pi}{3}",d=2)}if(t.restore(),p){const y="icon-label-angles",m=n?a.uiTextSelected:a.uiTextDefault;o({id:y,content:p,x:c.x+(g.x-16)*f,y:c.y+(g.y-20)*f,color:m,fontSize:_i+d,options:{textAlign:"center",textBaseline:"middle"}},i)}}function Gi(t,e,s,n,i,o,a){const l=n?a.uiIconSelected:a.uiIconDefault,c={x:e.x+e.width/2,y:e.y+e.height/2};t.save(),t.translate(c.x,c.y);const d=e.width/Qs;t.scale(d,d),t.translate(-16,-16),t.strokeStyle=l,t.lineWidth=Ge,t.beginPath(),t.moveTo(2,30),t.lineTo(30,30),t.stroke();let f="",h={x:16,y:22};if(s===Ws&&(f="3.14"),t.restore(),f){const r="icon-label-distances",u=n?a.uiTextSelected:a.uiTextDefault;o({id:r,content:f,x:c.x+(h.x-16)*d,y:c.y+(h.y-16)*d,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function mr(t,e,s,n,i){const o=n?i.uiIconSelected:i.uiIconDefault,a={x:e.x+e.width/2,y:e.y+e.height/2};t.save(),t.translate(a.x,a.y);const l=e.width/Qs;switch(t.scale(l,l),t.translate(-16,-16),t.strokeStyle=o,t.fillStyle=o,t.lineWidth=Ge,s){case Lo:t.strokeRect(2,2,28,28),t.beginPath(),t.moveTo(2,16),t.lineTo(30,16),t.moveTo(16,2),t.lineTo(16,30),t.stroke();break;case ko:t.strokeRect(2,2,28,28),t.beginPath(),[8,16,24].forEach(h=>{[8,16,24].forEach(r=>{t.moveTo(h,r),t.arc(h,r,Ye,0,Bt)})}),t.fill();break;case No:t.strokeRect(2,2,28,28);const c=8,d=16,f=16;t.beginPath(),t.arc(d,f,Ye,0,Bt);for(let h=0;h<6;h++){const r=Math.PI/3*h,u=d+c*Math.cos(r),p=f+c*Math.sin(r);t.moveTo(u,p),t.arc(u,p,Ye,0,Bt)}t.fill();break;case Oo:t.beginPath(),t.arc(16,16,14,0,Bt),t.stroke(),t.beginPath(),t.arc(16,16,7,0,Bt),t.stroke(),t.beginPath(),t.moveTo(2,16),t.lineTo(30,16),t.moveTo(16,2),t.lineTo(16,30),t.stroke();break;case Ns:t.strokeRect(2,2,28,28);break}t.restore()}function Vo(t,e,s){const n={x:e.x+e.width/2,y:e.y+e.height/2},i=e.width/2;switch(t.strokeStyle=s.uiIcon,t.fillStyle=s.uiIcon,t.setLineDash([]),t.lineWidth=Ge,t.lineCap="round",t.lineJoin="round",t.save(),t.translate(n.x,n.y),e.type){case be:{const o=-Math.PI/4;t.beginPath(),t.arc(0,0,i,o,-o),t.stroke(),t.beginPath(),t.arc(0,0,i,Math.PI+o,Math.PI-o),t.stroke();const a=i*.25,l=i*Math.cos(o),c=i*Math.sin(o);t.save(),t.translate(l,c),t.rotate(o-Math.PI/2),t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a*.5),t.moveTo(0,0),t.lineTo(-a,a*.5),t.stroke(),t.restore();const d=i*Math.cos(Math.PI+o),f=i*Math.sin(Math.PI+o);t.save(),t.translate(d,f),t.rotate(o+Math.PI/2),t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a*.5),t.moveTo(0,0),t.lineTo(-a,a*.5),t.stroke(),t.restore();break}case ds:{const o=i*.8,a=i*.25;t.beginPath(),t.moveTo(-o,0),t.lineTo(o,0),t.moveTo(0,-o),t.lineTo(0,o),t.stroke(),[{x:o,y:0,dirX:1,dirY:0},{x:-o,y:0,dirX:-1,dirY:0},{x:0,y:-o,dirX:0,dirY:-1},{x:0,y:o,dirX:0,dirY:1}].forEach(c=>{t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),t.moveTo(c.x,c.y),t.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),t.stroke()});break}case hs:{const o=i*.8,a=i*.25;t.beginPath(),t.moveTo(-o/Math.sqrt(2),-o/Math.sqrt(2)),t.lineTo(o/Math.sqrt(2),o/Math.sqrt(2)),t.moveTo(o/Math.sqrt(2),-o/Math.sqrt(2)),t.lineTo(-o/Math.sqrt(2),o/Math.sqrt(2)),t.stroke(),[{x:o/Math.sqrt(2),y:-o/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-o/Math.sqrt(2),y:o/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),t.moveTo(c.x,c.y),t.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),t.stroke()});break}}t.restore()}function Sr(t,e,s){const n=e.x+e.width/2,i=e.y+e.height/2,o=e.width*.6,a=e.height*.3;t.save(),t.strokeStyle=s.uiIcon,t.fillStyle=s.uiIcon,t.lineWidth=Ge,t.lineCap="round",t.beginPath(),t.ellipse(n,i,o/2,a/2,0,0,2*Math.PI),t.stroke();const l=a*.3;t.beginPath(),t.arc(n,i,l,0,2*Math.PI),t.fill(),t.restore()}function xr(t,e,s,n){const{canvasUI:i,colors:o,allColors:a,namedColors:l,colorAssignments:c,activeColorTargets:d,verticesVisible:f,edgesVisible:h,facesVisible:r,isDraggingColorTarget:u,draggedColorTargetInfo:p,mousePos:g}=s,y="#808080",m="#c0c0c0";function S(M){const I=M.height/3,A=Math.ceil(M.width/I);for(let E=0;E<3;E++)for(let _=0;_<A;_++){t.fillStyle=(E+_)%2===0?y:m;const T=M.x+_*I,P=M.y+E*I,D=Math.min(I,M.x+M.width-T),k=Math.min(I,M.y+M.height-P);D>0&&k>0&&t.fillRect(T,P,D,k)}}const x=i.randomColorButton;if(x){t.fillStyle="#000000",t.fillRect(x.x,x.y,x.width,x.height),t.strokeStyle=o.uiDefault,t.lineWidth=un,t.strokeRect(x.x,x.y,x.width,x.height);const M=x.x+x.width/2,I=x.y+x.height/2,A=x.width*.35,E=8;for(let _=0;_<E;_++){const T=_/E*2*Math.PI,P=(_+1)/E*2*Math.PI,D=_/E*360;t.fillStyle=`hsl(${D}, 70%, 60%)`,t.beginPath(),t.moveTo(M,I),t.arc(M,I,A,T,P),t.closePath(),t.fill()}t.fillStyle=o.background,t.beginPath(),t.arc(M,I,A*.4,0,2*Math.PI),t.fill()}const C=i.removeColorButton;C&&(t.strokeStyle=o.uiDefault,t.lineWidth=un,t.strokeRect(C.x,C.y,C.width,C.height),t.beginPath(),t.moveTo(C.x+xs,C.y+C.height/2),t.lineTo(C.x+C.width-xs,C.y+C.height/2),t.stroke()),i.colorSwatches.forEach(M=>{const I=M.item;let A=!1;if(I&&I.type==="color"){const E=So(I.value);E&&E.a<1&&(A=!0)}else I&&I.type==="colormap"&&I.vertices.some(E=>E.alpha!==void 0&&E.alpha<1)&&(A=!0);if(A&&S(M),I&&I.type==="colormap"){const E=t.createLinearGradient(M.x,M.y,M.x+M.width,M.y);I.vertices.forEach(_=>{let T=_.color;typeof T=="string"&&(T=l[T]||[0,0,0]),E.addColorStop(_.pos,`rgba(${T.join(",")},${_.alpha||1})`)}),t.fillStyle=E}else I&&(t.fillStyle=I.value);t.fillRect(M.x,M.y,M.width,M.height)});const b=i.addColorButton;if(b&&(t.strokeStyle=o.uiDefault,t.lineWidth=un,t.strokeRect(b.x,b.y,b.width,b.height),t.beginPath(),t.moveTo(b.x+b.width/2,b.y+xs),t.lineTo(b.x+b.width/2,b.y+b.height-xs),t.moveTo(b.x+xs,b.y+b.height/2),t.lineTo(b.x+b.width-xs,b.y+b.height/2),t.stroke()),i.colorTargetIcons){const M=A=>{let E=c[A];u&&p&&p.target===A&&p.previewColorIndex!==void 0&&(E=p.previewColorIndex);const _=E===-1?null:a[E],T={};return A===mt?(T.vertexState=f?"filled":"disabled",E===-1?T.vertexColor="rgba(128, 128, 128, 1)":_&&_.type==="color"?T.vertexColor=_.value:_&&_.type==="colormap"&&(T.vertexColormapItem=_)):A===wt?(T.edgeState=h?"solid":"disabled",E===-1?T.edgeColor="rgba(128, 128, 128, 1)":_&&_.type==="color"?T.edgeColor=_.value:_&&_.type==="colormap"&&(T.edgeColormapItem=_)):A===Dt&&(T.faceState=r?"filled":"disabled",E===-1?T.faceColor="rgba(128, 128, 128, 1)":_&&_.type==="color"?T.faceColor=_.value:_&&_.type==="colormap"&&(T.faceColormapItem=_)),T};[Dt,wt,mt].forEach(A=>{const E=i.colorTargetIcons.find(_=>_.target===A);if(E){const _=d.includes(A),T=M(A);if(u&&p&&p.target===Dt&&A===Dt){const P=i.colorSwatches.find(D=>g.x>=D.x&&g.x<=D.x+D.width&&g.y>=D.y&&g.y<=D.y+D.height);if(P&&P.item.type==="colormap"){const D=ki((g.x-P.x)/P.width,0,1);T.faceColor=ne(P.item,D),T.faceState="filled"}}Hi(t,E,T,o,_)}})}const v=new Set;d.forEach(M=>{let I=c[M];if(u&&p&&p.target===M&&p.previewColorIndex!==void 0&&(I=p.previewColorIndex),I===-1||v.has(I))return;const A=i.colorSwatches.find(E=>E.index===I);if(A){const E=Object.keys(c).filter(T=>{let P=c[T];return u&&p&&p.target===T&&p.previewColorIndex!==void 0&&(P=p.previewColorIndex),P===A.index&&d.includes(T)}),_=i.colorTargetIcons.filter(T=>E.includes(T.target));if(_.length>0){const T=Math.min(..._.map(R=>R.y));t.strokeStyle=o.selectionGlow,t.lineWidth=un;const P=2,D=A.x-P,k=T-P,N=A.width+P*2,w=A.y+A.height-k+P;t.strokeRect(D,k,N,w),v.add(I)}}})}function Cr(t,e,{verticesVisible:s,edgesVisible:n,facesVisible:i,colorAssignments:o,allColors:a},l){const c=!s&&!n&&!i,d={vertexState:s||c?"filled":"hidden",edgeState:n||c?"solid":"hidden",faceState:i||c?"filled":"hidden",showAllDisabled:c},f=o[mt];if(f!==-1){const u=a[f];u&&u.type==="colormap"?d.vertexColormapItem=u:u&&u.type==="color"&&(d.vertexColor=u.value)}else d.vertexColor=l.vertex;const h=o[wt];if(h!==-1){const u=a[h];u&&u.type==="colormap"?d.edgeColormapItem=u:u&&u.type==="color"&&(d.edgeColor=u.value)}else d.edgeColor=l.edge;const r=o[Dt];if(r!==-1){const u=a[r];u&&u.type==="color"?d.faceColor=u.value:u&&u.type==="colormap"&&(d.faceColormapItem=u)}else d.faceColor=l.face;Hi(t,e,d,l)}function Hi(t,e,s,n,i=!1){const{vertexState:o="none",edgeState:a="none",faceState:l="none",faceColor:c,edgeColor:d,vertexColor:f,faceColormapItem:h,showAllDisabled:r=!1}=s;t.save();const u={x:e.x+e.width/2,y:e.y+e.height/2};t.translate(u.x,u.y);const p=e.width/Qs;t.scale(p,p),t.translate(-16,-16);const g=26,y=g*Math.sqrt(3)/2,m=[{x:16,y:16-y/1.5},{x:16-g/2,y:16+y/3},{x:16+g/2,y:16+y/3}],S=new Path2D;if(S.moveTo(m[0].x,m[0].y),S.lineTo(m[1].x,m[1].y),S.lineTo(m[2].x,m[2].y),S.closePath(),l==="filled"){if(h&&h.type==="colormap"){const C=t.createLinearGradient(m[1].x,0,m[2].x,0);h.vertices.forEach(b=>{const v=b.color,M=b.alpha!==void 0?b.alpha:1,I=`rgba(${v.join(",")},${M})`;C.addColorStop(b.pos,I)}),t.fillStyle=C}else t.fillStyle=c||n.face;t.fill(S)}else l==="disabled"&&(t.fillStyle="#808080",t.fill(S));if(a==="solid"||a==="disabled"){t.lineWidth=Ge,t.setLineDash([]);const C=[[m[0],m[1]],[m[1],m[2]],[m[2],m[0]]];C.forEach((b,v)=>{const[M,I]=b;if(s.edgeColormapItem&&s.edgeColormapItem.type==="colormap"&&a==="solid"){const A=t.createLinearGradient(M.x,M.y,I.x,I.y),E=C.length>1?v/(C.length-1):.5,_=Math.max(0,Math.min(1,E)),T=Math.max(0,Math.min(1,E+.3)),P=ne(s.edgeColormapItem,_),D=ne(s.edgeColormapItem,T);A.addColorStop(0,P),A.addColorStop(1,D),t.strokeStyle=A}else a==="disabled"?t.strokeStyle="#808080":t.strokeStyle=d||n.edge;t.beginPath(),t.moveTo(M.x,M.y),t.lineTo(I.x,I.y),t.stroke()})}(o==="filled"||o==="disabled")&&(t.lineWidth=Ge,m.forEach((C,b)=>{let v=f||n.vertex;if(s.vertexColormapItem&&s.vertexColormapItem.type==="colormap"&&o==="filled"){const I=m.length>1?b/(m.length-1):.5;v=ne(s.vertexColormapItem,I)}o==="disabled"&&(v="#808080");const M=new Path2D;M.moveTo(C.x+Ye*2,C.y),M.arc(C.x,C.y,Ye*2,0,2*Math.PI),t.fillStyle=v,t.setLineDash([]),t.fill(M)})),r?(t.strokeStyle="#ff0000",t.lineWidth=2,t.setLineDash([]),t.beginPath(),t.moveTo(2,2),t.lineTo(30,30),t.stroke()):(o==="disabled"||a==="disabled"||l==="disabled")&&(t.strokeStyle="#ff0000",t.lineWidth=2,t.setLineDash([]),t.beginPath(),t.moveTo(2,2),t.lineTo(30,30),t.stroke()),t.restore()}function Wi(t,e,s,n,i,o){if(!(!e||e.length<3)){if(t.save(),t.beginPath(),e.forEach((a,l)=>{l===0?t.moveTo(a.x,a.y):t.lineTo(a.x,a.y)}),t.closePath(),s&&s.colormapItem&&s.localCoordSystem)if(s.colormapItem.isCyclic===!0){const l=JSON.stringify(s.colormapItem.vertices);let c=vi.get(l);if(!c){c=document.createElement("canvas"),c.width=256,c.height=1;const S=c.getContext("2d"),x=S.createLinearGradient(0,0,256,0);s.colormapItem.vertices.forEach(C=>{const b=C.color,v=C.alpha!==void 0?C.alpha:1;let M=`rgba(255,255,255,${v})`;typeof b=="string"?M=b:Array.isArray(b)&&(M=`rgba(${b.join(",")},${v})`),x.addColorStop(C.pos,M)}),S.fillStyle=x,S.fillRect(0,0,256,1),vi.set(l,c)}const d=t.createPattern(c,"repeat"),f=i(s.localCoordSystem.origin),h=os({x:1,y:0},s.localCoordSystem),r=i(h),u=r.x-f.x,p=r.y-f.y,g=Math.hypot(u,p),y=g>0?g/256:0,m=new DOMMatrix;m.translateSelf(f.x,f.y),m.rotateSelf(0,0,-s.localCoordSystem.angle*180/Math.PI),m.scaleSelf(y,y),d.setTransform(m),t.fillStyle=d,t.fill()}else{const l={x:0,y:0},c={x:1,y:0},d=os(l,s.localCoordSystem),f=os(c,s.localCoordSystem),h=i(d),r=i(f),u=t.createLinearGradient(h.x,h.y,r.x,r.y);s.colormapItem.vertices.forEach(p=>{let g=p.color;if(typeof g=="string")u.addColorStop(p.pos,g);else{const y=p.alpha!==void 0?p.alpha:1;u.addColorStop(p.pos,`rgba(${g.join(",")},${y})`)}}),t.fillStyle=u,t.fill()}else t.fillStyle=(s==null?void 0:s.color)||n.face,t.fill();t.restore()}}function br(t,e,s,n,i,o){const{angleDisplayMode:a,distanceDisplayMode:l,colors:c}=s,d={x:e.x,y:e.y,width:e.width,height:e.height};switch(e.group){case"angles":Xi(t,d,a,a!==Hs,n,i,c);break;case"distances":Gi(t,d,l,l===Ws,n,i,c);break}}function Mr(t,e,s,n){const{canvasUI:i,colorAssignments:o,allColors:a,colors:l}=s,c=d=>{if(!o||!a)return l.uiIcon;const f=o[d];if(f===-1)return"rgba(128, 128, 128, 1)";const h=a[f];return h&&h.type==="color"?h.value:l.uiIcon};c(mt),c(wt),c(Dt),i.visibilityIcons.forEach(d=>{br(t,d,s,e,n)})}function vr(t,e,s,n){const{canvasUI:i,colors:o,activeThemeName:a,colorAssignments:l,allColors:c,verticesVisible:d,edgesVisible:f,facesVisible:h}=s,r=i.toolbarButton;t.strokeStyle=o.uiDefault,t.lineWidth=Ai,t.beginPath();for(let S=0;S<3;S++){const x=r.y+5+S*10;t.moveTo(r.x+4,x),t.lineTo(r.x+r.width-4,x)}t.stroke();const u=i.colorToolButton;u&&Cr(t,u,{verticesVisible:d,edgesVisible:f,facesVisible:h,colorAssignments:l,allColors:c},o);const p=i.transformToolButton;p&&n({id:"transform-tool-label",content:za,x:p.x+p.width/2,y:p.y+p.height/2,color:o.uiIcon,fontSize:Wa,options:{textAlign:"center",textBaseline:"middle"}},e);const g=i.displayToolButton;if(g){t.strokeStyle=o.uiDefault,t.fillStyle=o.uiDefault,t.lineWidth=Ya;const S=g.width-Ka;for(let x=0;x<3;x++){const C=g.y+ja+x*Ja;t.beginPath(),t.moveTo(g.x+6,C),t.lineTo(g.x+6+S,C),t.stroke(),t.beginPath(),t.arc(g.x+6+S*(x/2),C,Za,0,2*Math.PI),t.fill()}}const y=i.visibilityToolButton;y&&Sr(t,y,o);const m=i.themeToggleButton;m&&Yi(t,m,a,o)}function Ir(t,e){const{canvasUI:s,colors:n}=e;s.transformIcons.forEach(i=>{Vo(t,i,n)})}function Tr(t,e,s,n){const{canvasUI:i,colors:o,coordsDisplayMode:a,gridDisplayMode:l,angleDisplayMode:c,distanceDisplayMode:d,activeThemeName:f}=s;i.displayIcons.forEach(h=>{const r={x:h.x,y:h.y,width:h.width,height:h.height};switch(h.group){case"coords":yr(t,r,a,a!==Bn,e,n,o);break;case"grid":mr(t,r,l,l!==Ns,o);break;case"angles":Xi(t,r,c,c!==Hs,e,n,o);break;case"distances":Gi(t,r,d,d===Ws,e,n,o);break;case"theme":Yi(t,r,f,o);break}})}function Er(t,e,s,n){const{dpr:i,isToolbarExpanded:o,isColorPaletteExpanded:a,isTransformPanelExpanded:l,isDisplayPanelExpanded:c,isVisibilityPanelExpanded:d,isPlacingTransform:f,placingTransformType:h,placingSnapPos:r,mousePos:u,colors:p}=s;if(t.save(),t.resetTransform(),t.scale(i,i),o)vr(t,e,s,n);else{const g=s.canvasUI.toolbarButton;t.strokeStyle=p.uiDefault,t.lineWidth=Ai,t.beginPath();for(let y=0;y<3;y++){const m=g.y+5+y*10;t.moveTo(g.x+4,m),t.lineTo(g.x+g.width-4,m)}t.stroke()}if(a&&xr(t,e,s),l&&Ir(t,s),c&&Tr(t,e,s,n),d&&Mr(t,e,s,n),f){const g=r||u;if(g){const y=oo/2,m={type:h,x:g.x-y,y:g.y-y,width:oo,height:oo};Vo(t,m,p)}}t.restore()}function Ii(t,e,s,n,{showDistances:i,distanceSigFigs:o,colors:a,lastGridState:l,currentShiftPressed:c},d,f,h,r,u=null,p=null,g=null){!i||s.length===0||s.forEach(y=>{const m=n.find(S=>f(S)===y);if(m){let S=d(m.id1),x=d(m.id2);if(u){const C=u.find(v=>v.id===m.id1),b=u.find(v=>v.id===m.id2);C&&(S=C),b&&(x=b)}if(S&&x&&S.type==="regular"&&x.type==="regular"){let C;const b=u&&g;if(m.labelMode==="exact"&&m.exactValue){const[k,N]=He(m.exactValue.g2gSquaredSum);let w=m.exactValue.gridInterval*k;if(b&&g.transformType!==be){const R=g.snappedScaleValue!==null?g.snappedScaleValue:g.scale;w*=R}C=We(parseFloat(w.toFixed(10)),N)}else C=Et(G(S,x),o);const v=h(S),M=h(x),I=(v.x+M.x)/2,A=(v.y+M.y)/2,E=Math.atan2(M.y-v.y,M.x-v.x);let _=E-Math.PI/2;Math.sin(_)>0&&(_+=Math.PI);const T=I+Math.cos(_)*Be,P=A+Math.sin(_)*Be;let D=E*(180/Math.PI);(D>90||D<-90)&&(D+=180),r({id:`selected-edge-dist-${y}`,content:C,x:T,y:P,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:fe,options:{textAlign:"center",textBaseline:"middle",rotation:D}})}}})}function _r(t,e,s,n){t.save(),t.strokeStyle=n.mouseCoords,t.lineWidth=rs,t.setLineDash(ks);const i=Math.min(e.x,s.x),o=Math.min(e.y,s.y),a=Math.abs(e.x-s.x),l=Math.abs(e.y-s.y);t.strokeRect(i,o,a,l),t.restore()}function An(t,e,s,n,{lastGridState:i,showDistances:o,showAngles:a,distanceSigFigs:l,angleDisplayMode:c,angleSigFigs:d,currentShiftPressed:f,viewTransform:h,colors:r},u,p,g,y=!1,m=null,S=null,x=[],C=!1,b=[],v=null){const M=y?r.feedbackSnapped:`rgba(${r.feedbackDefault.join(",")}, 1.0)`,I=new Map(n.map(w=>[w.id,{...w}])),A=w=>I.get(w),E=A(s);if(!E)return;const _=p(E.id).map(A).filter(Boolean),T=u(E),P=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,D=(w,R)=>{if(!w||!R||R<=0)return!1;const L=R*1e-6,O=Math.abs(w.x/R-Math.round(w.x/R))<L,Y=Math.abs(w.y/R-Math.round(w.y/R))<L;return O&&Y},k=_.every(w=>x.includes(w.id)),N=b.find(w=>w.id===s);if(!v&&C&&f&&k&&N&&G(N,E)>z){const w=u(N),R=T,L=Math.atan2(R.y-w.y,R.x-w.x);if(o){let O;const Y=P&&D(N,P),B=P&&D(E,P);if(Y&&B){const ve=E.x-N.x,Kt=E.y-N.y,ms=Math.round(ve/P),pe=Math.round(Kt/P),Le=ms*ms+pe*pe;if(Le===0)O="0";else{const[Gn,nn]=He(Le),on=P*Gn,an=parseFloat(on.toFixed(10));O=We(an,nn)}}else O=Et(G(N,E),l);const F=(w.x+R.x)/2,j=(w.y+R.y)/2;let Z=L-Math.PI/2;Math.sin(Z)>0&&(Z+=Math.PI);const pt=F+Math.cos(Z)*Be,Ut=j+Math.sin(Z)*Be;let Gt=L*(180/Math.PI);(Gt>90||Gt<-90)&&(Gt+=180),S({id:`drag-dist-vector-${E.id}`,content:O,x:pt,y:Ut,color:M,fontSize:fe,options:{textAlign:"center",textBaseline:"middle",rotation:Gt}},e)}if(t.save(),t.setLineDash(ks),t.strokeStyle=M,t.lineWidth=rs,t.beginPath(),t.moveTo(w.x,w.y),t.lineTo(R.x,R.y),t.stroke(),t.restore(),a&&Math.abs(L)>z){const O=Math.atan2(E.y-N.y,E.x-N.x);$o(t,w,0,O,vn,M);let Y;if(c===fs?Y=`${Et(O*(180/Math.PI),d)}^{\\circ}`:Y=Et(O,d),Y){const B=-O/2,F={x:w.x+pn*Math.cos(B),y:w.y+pn*Math.sin(B)};S({id:`drag-angle-vector-${E.id}`,content:Y,x:F.x,y:F.y,color:M,fontSize:fe,options:{textAlign:"center",textBaseline:"middle"}},e)}}}if(o&&_.forEach(w=>{const R=x.includes(w.id);if(!C||!R){const L=E,O=w,Y=g({id1:L.id,id2:O.id});let B;if(P&&D(L,P)&&D(O,P)){const Le=L.x-O.x,Gn=L.y-O.y,nn=Math.round(Le/P),on=Math.round(Gn/P),an=nn*nn+on*on;if(an===0)B="0";else{const[ra,ca]=He(an),da=P*ra,ha=parseFloat(da.toFixed(10));B=We(ha,ca)}}else{const Le=G(L,O);B=Et(Le,l)}const j=u(L),Z=u(O),pt=(j.x+Z.x)/2,Ut=(j.y+Z.y)/2,Gt=Math.atan2(Z.y-j.y,Z.x-j.x);let ve=Gt-Math.PI/2;Math.sin(ve)>0&&(ve+=Math.PI);const Kt=pt+Math.cos(ve)*Be,ms=Ut+Math.sin(ve)*Be;let pe=Gt*(180/Math.PI);(pe>90||pe<-90)&&(pe+=180),S({id:`drag-dist-${Y}`,content:B,x:Kt,y:ms,color:M,fontSize:fe,options:{textAlign:"center",textBaseline:"middle",rotation:pe}})}}),a&&_.length>=2&&(!C||_.some(w=>!x.includes(w.id)))){const w=[..._].sort((R,L)=>{const O=Math.atan2(R.y-E.y,R.x-E.x),Y=Math.atan2(L.y-E.y,L.x-E.x);return O-Y});for(let R=0;R<w.length;R++){const L=w[R],O=w[(R+1)%w.length],Y=x.includes(L.id),B=x.includes(O.id);if(!(!C||!Y||!B))continue;const j={x:L.x-E.x,y:L.y-E.y},Z={x:O.x-E.x,y:O.y-E.y},pt=Math.atan2(j.y,j.x),Ut=Math.atan2(Z.y,Z.x);let Gt=Ut-pt;if(Gt<0&&(Gt+=2*Math.PI),Gt<z)continue;const ve=pt+Gt/2;t.save(),t.strokeStyle=M,t.lineWidth=rs,t.beginPath(),t.arc(T.x,T.y,vn,-pt,-Ut,!1),t.stroke(),t.restore();let Kt;if(c===fs?Kt=`${Et(Gt*(180/Math.PI),d)}^{\\circ}`:c===tn&&(f?(Kt=Ts(Gt/Math.PI,.015,32)+"\\pi",Kt.startsWith("1\\pi")&&(Kt="\\pi"),Kt.startsWith("-1\\pi")&&(Kt="-\\pi"),Kt==="0\\pi"&&(Kt="0")):Kt=Et(Gt,d)),Kt){const ms={x:E.x+pn/h.scale*Math.cos(ve),y:E.y+pn/h.scale*Math.sin(ve)},pe=u(ms),Le=`drag-angle-${E.id}-${L.id}-${O.id}`;S({id:Le,content:Kt,x:pe.x,y:pe.y,color:M,fontSize:fe,options:{textAlign:"center",textBaseline:"middle"}},e)}}}}function Ar(t,e,s,n,{showAngles:i,angleSigFigs:o,angleDisplayMode:a,currentShiftPressed:l,distanceSigFigs:c,viewTransform:d,lastGridState:f,colors:h},r,u,p,g,y){!i||s.length===0||s.forEach(m=>{const S=n.find(x=>u(x)===m);if(S){const x=r(S.id1),C=r(S.id2);if(x&&C&&x.type==="regular"&&C.type==="regular"){const b={lastGridState:f,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:o,currentShiftPressed:l,viewTransform:d,colors:h};An(t,e,x.id,[x,C],b,p,g,u,!1,null,y),An(t,e,C.id,[x,C],b,p,g,u,!1,null,y)}}})}function Pr(t,{allFaces:e,selectedFaceIds:s,colors:n,isDragConfirmed:i,dragPreviewVertices:o,initialDragVertexStates:a,transformIndicatorData:l,highlightedEdgeForSnap:c,draggedFaceId:d,coordSystemSnapAngle:f,coordSystemSnapType:h,coordSystemSnapScale:r,initialCoordSystemStates:u},p,g){if(s.length>ml)return;const y=new Set(s);y.size!==0&&y.forEach(m=>{const S=e.find(C=>C.id===m);if(!S||!S.localCoordSystem)return;let x=S.localCoordSystem;if(i&&S.vertexIds.some(C=>o.some(b=>b.id===C))){const C=u.get(S.id);x=Bi(S,{initialSystem:C,dragPreviewVertices:o,initialDragVertexStates:a,findVertexById:g,transformIndicatorData:l})}if(d===m&&f!==null){const C=v=>{if(i&&o){const M=o.find(I=>I&&I.id===v);if(M)return M}return g(v)},b=p(x.origin);if(h==="edge"&&c!==null){const v=S.vertexIds.map(M=>C(M)).filter(M=>M&&M.type==="regular");if(c<v.length){const M=v[c],I=v[(c+1)%v.length],A=p(M),E=p(I);t.save(),t.strokeStyle=n.feedbackSnapped,t.lineWidth=3,t.beginPath(),t.moveTo(A.x,A.y),t.lineTo(E.x,E.y),t.stroke(),t.restore()}}else if(h==="cardinal"){const M=b.x+Math.cos(-f)*100,I=b.y+Math.sin(-f)*100,A=b.x-Math.cos(-f)*100,E=b.y-Math.sin(-f)*100;t.save(),t.strokeStyle=n.feedbackSnapped,t.lineWidth=2,t.setLineDash([8,4]),t.beginPath(),t.moveTo(A,E),t.lineTo(M,I),t.stroke(),t.restore()}}wr(t,x,n,p,r)})}function wr(t,e,s,n,i=null){const o=n(e.origin),a=os({x:1,y:0},e),l=os({x:0,y:1},e),c=n(a),d=n(l);t.save(),t.lineWidth=Di,t.lineCap="round";const f=(u,p,g,y)=>{t.strokeStyle=g,t.beginPath(),t.moveTo(u.x,u.y),t.lineTo(p.x,p.y),t.stroke(),t.fillStyle=y;const m=Math.atan2(p.y-u.y,p.x-u.x);t.beginPath(),t.moveTo(p.x,p.y),t.lineTo(p.x-St*Math.cos(m-Oe),p.y-St*Math.sin(m-Oe)),t.lineTo(p.x-St*Math.cos(m+Oe),p.y-St*Math.sin(m+Oe)),t.closePath(),t.fill()},h=i!==null?s.feedbackSnapped:"#ff0000",r=i!==null?s.feedbackSnapped:"#00ff00";f(o,c,"#ff0000",h),f(o,d,"#00ff00",r),t.fillStyle="#0000ff",t.beginPath(),t.arc(o.x,o.y,4,0,2*Math.PI),t.fill(),t.restore()}const et=document.getElementById("drawingCanvas"),dt=et.getContext("2d",{willReadFrequently:!0}),Ht=document.getElementById("html-overlay"),At=window.devicePixelRatio||1,Pn=new Map;let _e;const Q={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[]};let zt,$s=null,Vs=null,Pe=null,is=new Map,de=null,as=null,Rs=null,Vn=null,Ls=null,Ne=null,zs=!1,re=null,ft=[],Zt=null,ze=null,Ot=null,Re=null,Us=!1,us=null,Ze=!1,zi=!1,ss="regular",Ft="lines",ie="degrees",Cn="on",wn=!0,Dn=!0,Se=!0,vo=null,Rn=null,Io=null,bn=!1,Qe=!1,q=[],X=[],tt=[],nt=[],at=[],rt=[],$t=null,$={x:0,y:0},Ue=null,Fs=!1,Qt=!1,qs=!1,Es=null,bs=!1,ue=!1,Ks=null,kt=[],ce=0,Ee=!0,ge=!0,Ms=4,Te=3,Dr=.5,vt=null,Xt=!1,xt=!1,ps=!1,Ke=!1,we=-1,he={x:0,y:0},ho={x:0,y:0},ot=[],Ui={x:0,y:0},W=null,K=Po,Yt=!1,Nt=null,Ln=null,it=[],ut=!1,se={vertices:[],edges:[],faces:[],referenceVertex:null},U={targetId:null,type:null,count:0,timestamp:0},qt=[];function Rr(){const t=Array.prototype.pop,e=Array.prototype.push,s=Array.prototype.shift,n=Array.prototype.splice;qt.pop=function(){return t.call(this)},qt.push=function(...i){return e.call(this,...i)},qt.shift=function(){return s.call(this)},qt.splice=function(...i){return n.call(this,...i)}}let To=!1,_s=[],ht=null,Rt=[],le="",xe=null,Xe=[],fo=0,H={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},J={scale:Ba,offsetX:0,offsetY:0},De={angle1:30,angle2:15,alpha1:1,alpha2:0},Yo=new Set,kn="dark",It=[],Fe=!1,jt=null,st={[mt]:0,[wt]:1,[Dt]:2},gs=!1,oe=null,Nn=null,ls=new Set,ts=!1;function ys(){Ul(tt,V)}function Yn(){return Hl(kn,ma)}function Lr(){const t=Math.floor(Math.random()*256),e=Math.floor(Math.random()*256),s=Math.floor(Math.random()*256),n=Math.random()*.8+.2;return`rgba(${t}, ${e}, ${s}, ${n.toFixed(2)})`}function bt(t,e=0,s=1){const n=st[t];if(n===-1)return Lr();const i=K[n];if((i==null?void 0:i.type)==="color")return i.value;if((i==null?void 0:i.type)==="colormap"){const a=s>1?e/(s-1):.5;return ne(i,a)}const o=Yn();return t===mt?o.vertex:t===wt?o.edge:t===Dt?o.face:o.vertex}function Mn(){It.forEach(t=>{const e=st[t];if(!(e===-1&&t!==mt)){if(t===mt){const s=K[e];if(s&&s.type==="colormap"){const n=nt.map(i=>V(i)).filter(i=>i&&i.type==="regular");n.forEach((i,o)=>{const a=n.length>1?o/(n.length-1):.5;i.color=ne(s,a)})}else nt.forEach(n=>{const i=V(n);i&&i.type==="regular"&&(i.color=bt(mt))})}else if(t===wt){const s=K[e];if(s&&s.type==="colormap")at.forEach((n,i)=>{const o=X.find(a=>lt(a)===n);if(o){const a=at.length,l=a>1?i/a:0,c=a>1?(i+1)/a:1;o.gradientStart=l,o.gradientEnd=c,o.colormapItem=s,delete o.color}});else{const n=bt(wt);X.forEach(i=>{at.includes(lt(i))&&(i.color=n,delete i.gradientStart,delete i.gradientEnd,delete i.colormapItem)})}}else if(t===Dt){const s=st[t];if(s===-1){const n=bt(Dt);tt.forEach(i=>{rt.includes(Ct(i))&&(i.color=n,delete i.colormapItem,delete i.colormapDistribution)})}else{const n=K[s];if(n&&n.type==="colormap")tt.forEach(i=>{rt.includes(Ct(i))&&(i.colormapItem=n,i.colormapDistribution="x",delete i.color)});else{const i=bt(Dt);tt.forEach(o=>{rt.includes(Ct(o))&&(o.color=i,delete o.colormapItem,delete o.colormapDistribution)})}}}}})}function kr(){q.forEach(t=>{t.type===Is&&(t.color?t.color=Fo(t.color):t.color=Yn().vertex)})}function te({id:t,content:e,x:s,y:n,color:i,fontSize:o,options:a={}}){Yo.add(t);let l=Pn.get(t);l||(l=document.createElement("div"),l.style.position="absolute",l.style.fontFamily="KaTeX_Main, Times New Roman, serif",l.style.whiteSpace="nowrap",Ht.appendChild(l),Pn.set(t,l));let c="";a.textAlign==="center"?c+=" translateX(-50%)":a.textAlign==="right"&&(c+=" translateX(-100%)"),a.textBaseline==="middle"?c+=" translateY(-50%)":a.textBaseline==="bottom"&&(c+=" translateY(-100%)"),a.rotation!==void 0&&(c+=` rotate(${a.rotation}deg)`),l.style.transform=c.trim(),l.style.left=`${s}px`,l.style.top=`${n}px`,l.style.color=i,l.style.fontSize=`${o}px`,l.katexContent!==e&&(typeof window.katex<"u"?katex.render(e,l,{throwOnError:!1,displayMode:!1}):l.textContent=e.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g,"$1/$2").replace(/[\\{}]/g,""),l.katexContent=e)}function Nr(){for(const[t,e]of Pn.entries())Yo.has(t)||(e.remove(),Pn.delete(t))}function Xo(t,e,s){if(s){const n=Rt.indexOf(t);n>-1?(Rt.splice(n,1),$t===t&&($t=Rt.length>0?Rt[Rt.length-1]:null)):(Rt.push(t),$t=t)}else e?Rt.includes(t)||(Rt.push(t),$t=t):(Rt=[t],$t=t)}function Or(t,e,s){const n=Ri/J.scale,i=Ae(t.id,X).map(h=>V(h)).filter(h=>h&&!s.includes(h.id)),o=[],a=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1,l=[],c=[];if(a&&Ps(e,Ft,a,De,!0).forEach(h=>l.push(h)),q.forEach(h=>{h.id!==t.id&&h.type==="regular"&&!i.some(r=>r.id===h.id)&&l.push(h)}),i.length===2){const h=i[0],r=i[1];c.push({type:"line",data:Jl(h,r),snapType:"isosceles"});const u=Gl(h,t,r),p=Ci(h,r,u,t);p&&c.push({type:"circle",data:p,snapType:"angle_preservation"});const g=new Set;cs.forEach(m=>{for(let S=1;S<=24;S++){const x=Ce(m*Math.PI/2*S);x>z&&x<Bt-z&&g.add(parseFloat(x.toFixed(7)))}}),g.forEach(m=>{const S=Ci(h,r,m,t);S&&c.push({type:"circle",data:S,snapType:"fixed_angle"})});const y=G(h,r);if(c.push({type:"circle",data:{center:h,radius:y},snapType:"equal_distance"}),c.push({type:"circle",data:{center:r,radius:y},snapType:"equal_distance"}),a)for(let m=1;m<=30;m++){const S=m*a*.5;c.push({type:"circle",data:{center:h,radius:S},snapType:"grid_distance"}),c.push({type:"circle",data:{center:r,radius:S},snapType:"grid_distance"})}}if(l.forEach(h=>{o.push({type:"point",pos:h,dist:G(e,h),source:h})}),c.forEach(h=>{let r,u;if(h.type==="line"){const p=xo(e,h.data.p1,h.data.p2);r={x:p.x,y:p.y},u=p.distance}else{const p={x:e.x-h.data.center.x,y:e.y-h.data.center.y},g=Math.hypot(p.x,p.y);g<z?r={x:h.data.center.x+h.data.radius,y:h.data.center.y}:r={x:h.data.center.x+p.x/g*h.data.radius,y:h.data.center.y+p.y/g*h.data.radius},u=G(e,r)}o.push({type:h.type,pos:r,dist:u,source:h.data,snapType:h.snapType})}),o.length===0)return{pos:e,snapped:!1};o.sort((h,r)=>h.dist-r.dist);const d=o[0];if(d.dist>n)return{pos:e,snapped:!1};let f=d.pos;if((d.type==="line"||d.type==="circle")&&i.length===2){const h=d.source,r=[];if(c.forEach(u=>{if(u.data!==h)if(d.type==="line")if(u.type==="line"){const p=Li(h,u.data);p&&r.push(p)}else r.push(...En(h,u.data));else u.type==="line"?r.push(...En(u.data,h)):r.push(...Zl(h,u.data))}),l.forEach(u=>{if(G(u,f)<n*2)if(d.type==="line")r.push(xo(u,h.p1,h.p2));else{const p={x:u.x-h.center.x,y:u.y-h.center.y},g=Math.hypot(p.x,p.y);g>z&&r.push({x:h.center.x+p.x/g*h.radius,y:h.center.y+p.y/g*h.radius})}}),r.length>0){let u=1/0,p=null;r.forEach(g=>{const y=G(f,g);y<u&&(u=y,p=g)}),p&&u<n/2&&(f=p)}}return{pos:f,snapped:!0,snapType:d.snapType||d.type}}function $e(t){const e=Ps(t,Ft,H.interval1,De,!0);if(q.forEach(n=>{n.type==="regular"&&e.push({x:n.x,y:n.y,isGridVertex:!1})}),X.forEach(n=>{const i=V(n.id1),o=V(n.id2);if(i&&o&&i.type==="regular"&&o.type==="regular"){const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2,isGridVertex:!1};e.push(a)}}),e.length===0)return null;const s=(n,i)=>(n.x-i.x)**2+(n.y-i.y)**2;return e.reduce((n,i)=>{const o=s(t,n);return s(t,i)<o?i:n})}function js(t,e,s,n=!1,i=null){const o=yt(e),a=i||On(t.id);if(!s){const r=[],u=Pt*2/J.scale;for(const y of q)y.id!==t.id&&y.type==="regular"&&G(o,y)<u&&r.push({priority:1,dist:G(o,y),pos:{x:y.x,y:y.y},snapType:"vertex",targetVertex:y});const p=po/J.scale;for(const y of X){const m=V(y.id1),S=V(y.id2);if(m&&S&&m.type==="regular"&&S.type==="regular"){const x=Me(o,m,S);x.distance<p&&x.onSegmentStrict&&r.push({priority:2,dist:x.distance,pos:{x:x.x,y:x.y},snapType:"edge",targetEdge:y})}}if(r.length>0){r.sort((S,x)=>S.priority!==x.priority?S.priority-x.priority:S.dist-x.dist);const y=r[0],m=Math.atan2(y.pos.y-t.y,y.pos.x-t.x)||0;return{...y.pos,angle:m*(180/Math.PI),distance:G(t,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:_t(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const g=Math.atan2(o.y-t.y,o.x-t.x)||0;return{x:o.x,y:o.y,angle:g*(180/Math.PI),distance:G(t,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:_t(g-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const l=[],c=Pt*2/J.scale;for(const r of q)r.id!==t.id&&r.type==="regular"&&G(o,r)<c&&l.push({priority:1,dist:G(o,r),pos:{x:r.x,y:r.y},snapType:"vertex",targetVertex:r});const d=po/J.scale;for(const r of X){const u=V(r.id1),p=V(r.id2);if(u&&p&&u.type==="regular"&&p.type==="regular"){const g=Me(o,u,p);g.distance<d&&g.onSegmentStrict&&l.push({priority:2,dist:g.distance,pos:{x:g.x,y:g.y},snapType:"edge",targetEdge:r})}}if(l.length>0){l.sort((p,g)=>p.priority!==g.priority?p.priority-g.priority:p.dist-g.dist);const r=l[0],u=Math.atan2(r.pos.y-t.y,r.pos.x-t.x)||0;return{...r.pos,angle:u*(180/Math.PI),distance:G(t,r.pos),snapped:!0,snapType:r.snapType,targetEdge:r.targetEdge,targetVertex:r.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:_t(u-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const f=Ae(t.id,X).map(r=>V(r)).filter(r=>r&&r.type==="regular"&&!nt.includes(r.id));if(n&&f.length>0){const r=[],u=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1;Ft!=="none"&&u&&Ps(o,Ft,u,De,!0).forEach(x=>r.push({pos:x,type:"grid"})),q.forEach(S=>{S.id!==t.id&&S.type==="regular"&&r.push({pos:S,type:"vertex"})});const p=(S,x)=>{const C={x:(S.x+x.x)/2,y:(S.y+x.y)/2},b={x:-(x.y-S.y),y:x.x-S.x};return{p1:C,p2:{x:C.x+b.x*jo,y:C.y+b.y*jo}}};for(let S=0;S<f.length;S++)for(let x=S+1;x<f.length;x++){const C=f[S],b=f[x],v=p(C,b);if(u){const I=G(t,o)+u*10;for(let A=u*.5;A<I;A+=u*.5)En(v,{center:C,radius:A}).forEach(_=>r.push({pos:_,type:"equidistant_grid_dist"}))}const M=G(C,b);if(M>z){const I={x:(C.x+b.x)/2,y:(C.y+b.y)/2},A=Fl({x:-(b.y-C.y),y:b.x-p1.x});cs.map(_=>_*Math.PI/2).forEach(_=>{if(_>0&&_<Math.PI){const T=M/2/Math.tan(_/2),P={x:I.x+T*A.x,y:I.y+T*A.y},D={x:I.x-T*A.x,y:I.y-T*A.y};r.push({pos:P,type:"equidistant_angle"}),r.push({pos:D,type:"equidistant_angle"})}})}}if(f.length>=3)for(let S=0;S<f.length;S++)for(let x=S+1;x<f.length;x++)for(let C=x+1;C<f.length;C++){const b=f[S],v=f[x],M=f[C],I=p(b,v),A=p(v,M),E=Li(I,A);E&&r.push({pos:E,type:"circumcenter"})}if(r.length===0){const S=Math.atan2(o.y-t.y,o.x-t.x)||0;return{x:o.x,y:o.y,angle:S*(180/Math.PI),distance:G(t,o),snapped:!1}}const g=r.reduce((S,x)=>{const C=G(o,x.pos),b=S.pos?G(o,S.pos):1/0;return C<b?x:S},{pos:null}),y=g.pos,m=Math.atan2(y.y-t.y,y.x-t.x)||0;return{x:y.x,y:y.y,angle:m*(180/Math.PI),distance:G(t,y),snapped:!0,snapType:g.type,gridSnapped:g.type==="grid",lengthSnapFactor:null,angleSnapFactor:null,angleTurn:_t(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const r=[],u=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1;Ft!=="none"&&u&&Ps(o,Ft,u,De,!0).forEach(v=>r.push({pos:v,isGridVertexSnap:!0,type:"grid"}));const p=a.currentSegmentReferenceA_for_display,g=a.currentSegmentReferenceD,y=new Set([0,...cs.flatMap(b=>[b,-b])]),S=Array.from(y).sort((b,v)=>b-v).map(b=>({factor:b,angle:_t(a.offsetAngleRad+b*p),turn:_t(b*p)})),x=[];for(let b=0;b<=Il/hi;b++){const v=b*hi;x.push({factor:v,dist:v*g})}if(S.length>0&&x.length>0)for(const b of S)for(const v of x){const M={x:t.x+v.dist*Math.cos(b.angle),y:t.y+v.dist*Math.sin(b.angle)};r.push({pos:M,isGridVertexSnap:!1,type:"geometric",lengthSnapFactor:v.factor,angleSnapFactor:b.factor,angleTurn:b.turn})}if(r.length>0){const b=r.reduce((_,T)=>{const P=G(o,T.pos),D=_.pos?G(o,_.pos):1/0;return P<D?T:_},{pos:null}),v=Math.atan2(b.pos.y-t.y,b.pos.x-t.x)||0,M=parseFloat(G(t,b.pos).toFixed(10));let I=null,A=null;if(b.isGridVertexSnap&&Ft!=="polar"){const _=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1,T=_*z;if(((D,k)=>Math.abs(D.x/k-Math.round(D.x/k))<T&&Math.abs(D.y/k-Math.round(D.y/k))<T)(t,_)){const D=b.pos.x-t.x,k=b.pos.y-t.y,N=Math.round(D/_),w=Math.round(k/_);I=N*N+w*w,A=_}}let E=b.angleTurn!=null?b.angleTurn:_t(v-a.offsetAngleRad);return{x:parseFloat(b.pos.x.toFixed(10)),y:parseFloat(b.pos.y.toFixed(10)),angle:v*(180/Math.PI),distance:M,snapped:!0,gridSnapped:!!b.isGridVertexSnap,snapType:b.isGridVertexSnap?"grid":"geometric",lengthSnapFactor:b.lengthSnapFactor||null,angleSnapFactor:b.angleSnapFactor||null,angleTurn:E,gridToGridSquaredSum:I,gridInterval:A}}const C=Math.atan2(o.y-t.y,o.x-t.x)||0;return{x:o.x,y:o.y,angle:C*(180/Math.PI),distance:G(t,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:_t(C-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function Br(){K=K.map(t=>t.type==="color"?{...t,value:Fo(t.value)}:t)}function Fr(){Q.toolbarButton={id:"toolbar-button",x:Wt,y:Wt,width:Fa,height:$a,type:"menuButton"}}function $r(){Q.transformIcons=[];const t=es+Wt,e=Q.transformToolButton.y,s=Xa,n=Ga;[be,ds,hs].forEach((o,a)=>{Q.transformIcons.push({id:`transform-icon-${o}`,type:o,x:t+a*(s+n),y:e+Ha,width:s,height:s})})}function Vt(){Q.colorSwatches=[],Q.colorTargetIcons=[];const t=Q.colorToolButton.y;let e=es+Wt;Q.removeColorButton={id:"remove-color-button",type:"button",x:e,y:t+io,width:Ie,height:Ie},e+=Ie+Wt,K.forEach((n,i)=>{const o=n.type==="colormap"?Ie*3+Wt*2:Ie;Q.colorSwatches.push({id:`swatch-${i}`,type:"colorSwatch",x:e,y:t+io,width:o,height:Ie,index:i,item:n}),e+=o+Wt});const s=e;Q.addColorButton={id:"add-color-button",type:"button",x:s,y:t+io,width:Ie,height:Ie},Object.entries(st).forEach(([n,i])=>{const o=Ie*.75;let a;i>=0&&i<K.length?a=Q.colorSwatches.find(l=>l.index===i):a=Q.removeColorButton,a&&Q.colorTargetIcons.push({id:`target-icon-${n}`,target:n,x:a.x+(a.width-o)/2,y:a.y-o-5,width:o,height:o})})}function qi(t){t<0||t>=K.length||K.length<=1||(K.splice(t,1),Object.keys(st).forEach(e=>{st[e]>t?st[e]--:st[e]===t&&(st[e]=Math.min(t,K.length-1))}),Vt())}function Ki(){const t=et.height/At;Q.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:es,height:t,type:"toolbar"},Q.colorToolButton={id:"color-tool-button",type:"toolButton",x:Wt,y:Q.toolbarButton.y+Q.toolbarButton.height+Va,width:es-2*Wt,height:so},Q.transformToolButton={id:"transform-tool-button",type:"toolButton",x:Wt,y:Q.colorToolButton.y+Q.colorToolButton.height+Wt,width:es-2*Wt,height:so},Q.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:Wt,y:Q.transformToolButton.y+Q.transformToolButton.height+Wt,width:es-2*Wt,height:so}}function Vr(t){if(Ze){for(const e of Q.displayIcons)if(t.x>=e.x&&t.x<=e.x+e.width&&t.y>=e.y&&t.y<=e.y+e.height){switch(e.group){case"coords":const s=[Bn,Ro,Gs,Fn];ss=s[(s.indexOf(ss)+1)%s.length];break;case"grid":const n=[Lo,ko,No,Oo,Ns];Ft=n[(n.indexOf(Ft)+1)%n.length];break;case"angles":const i=[fs,tn,Hs];ie=i[(i.indexOf(ie)+1)%i.length],Ee=ie!==Hs;break;case"distances":const o=[Ws,Pl];Cn=o[(o.indexOf(Cn)+1)%o.length],ge=Cn===Ws;break;case"theme":cc();break}return!0}}return!1}function Yr(t,e=!1,s=!1){const n=Q.toolbarButton;if(t.x>=n.x&&t.x<=n.x+n.width&&t.y>=n.y&&t.y<=n.y+n.height)return Fs=!Fs,Fs?Ki():(Qt=!1,bs=!1,Ze=!1,zi=!1,selectedColorIndices=[]),!0;if(Fs){const i=Q.colorToolButton;if(i&&t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height)return rc(),!0;const o=Q.transformToolButton;if(o&&t.x>=o.x&&t.x<=o.x+o.width&&t.y>=o.y&&t.y<=o.y+o.height)return bs=!bs,bs&&$r(),!0;const a=Q.visibilityToolButton;if(a&&t.x>=a.x&&t.x<=a.x+a.width&&t.y>=a.y&&t.y<=a.y+a.height)return Ze=!Ze,Ze&&Xr(),!0}if(Qt&&ec(t))return!0;if(bs){for(const i of Q.transformIcons)if(t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height)return ue=!0,Ks=i.type,et.style.cursor="none",!0}return!!(Ze&&Vr(t))}function Xr(){if(Q.displayIcons=[],!Q.visibilityToolButton)return;const t=es+Wt,e=Q.visibilityToolButton.y,s=Ua,n=qa;["coords","grid","angles","distances","theme"].forEach((o,a)=>{Q.displayIcons.push({id:`display-icon-${o}`,group:o,x:t+a*(s+n),y:e,width:s,height:s})})}function Gr(t){if(!t||!t.type){console.error("Invalid color object passed to addToColors:",t);return}K.some(s=>!s||s.type!==t.type?!1:s.type==="colormap"?JSON.stringify(s.vertices)===JSON.stringify(t.vertices):s.value===t.value)||(K.push(t),Qt&&Vt())}function ji(t,e=[]){const s=V(t);if(!s)return null;for(let n=X.length-1;n>=0;n--){const i=X[n],o=lt(i);if(e.includes(o))continue;let a=null;if(i.id1===t?a=i.id2:i.id2===t&&(a=i.id1),a){const l=V(a);if(l){const c=s.x-l.x,d=s.y-l.y;return{p1:l,p2:s,angleRad:Math.atan2(d,c),length:Math.sqrt(c*c+d*d),edgeId:o}}}}return null}function Tt(){var e;const t=Xn();K.length,(e=K[0])!=null&&e.value,q.length,qt.push(t),qt.length>Do&&qt.shift(),_s=[]}function Ji(t){q=JSON.parse(JSON.stringify(t.vertices)),X=JSON.parse(JSON.stringify(t.edges)),tt=JSON.parse(JSON.stringify(t.faces||[])),nt=JSON.parse(JSON.stringify(t.selectedVertexIds||[])),at=JSON.parse(JSON.stringify(t.selectedEdgeIds||[])),rt=JSON.parse(JSON.stringify(t.selectedFaceIds||[])),Rt=JSON.parse(JSON.stringify(t.selectedCenterIds||[])),It=JSON.parse(JSON.stringify(t.activeColorTargets||[])),K=t.allColors?JSON.parse(JSON.stringify(t.allColors)):Po.map(s=>typeof s=="string"?{type:"color",value:s}:s),st=t.colorAssignments?JSON.parse(JSON.stringify(t.colorAssignments)):{[mt]:0,[wt]:1,[Dt]:2},$t=t.activeCenterId!==void 0?t.activeCenterId:null,Yt=t.isDrawingMode!==void 0?t.isDrawingMode:!1,Nt=t.previewLineStartVertexId!==void 0?t.previewLineStartVertexId:null,Zt=t.frozenReference_A_rad!==void 0?t.frozenReference_A_rad:null,ze=t.frozenReference_A_baseRad!==void 0?t.frozenReference_A_baseRad:null,Ot=t.frozenReference_D_du!==void 0?t.frozenReference_D_du:null,Re=t.frozenReference_Origin_Data!==void 0?t.frozenReference_Origin_Data:null,Ue=t.frozenReference_D_g2g!==void 0?t.frozenReference_D_g2g:null,ls=t.deletedFaceIds!==void 0?new Set(t.deletedFaceIds):new Set,Xt=!1,xt=!1,Ke=!1,ps=!1,it=[],Ln=null,we=-1,U={targetId:null,type:null,count:0,timestamp:0},et.style.cursor="crosshair",Qt&&Vt();const e=Xn();qt.length===0&&qt.push(e)}function Xn(){return{vertices:JSON.parse(JSON.stringify(q)),edges:JSON.parse(JSON.stringify(X)),faces:JSON.parse(JSON.stringify(tt)),selectedVertexIds:JSON.parse(JSON.stringify(nt)),selectedEdgeIds:JSON.parse(JSON.stringify(at)),selectedFaceIds:JSON.parse(JSON.stringify(rt)),selectedCenterIds:JSON.parse(JSON.stringify(Rt)),activeColorTargets:JSON.parse(JSON.stringify(It)),colorAssignments:JSON.parse(JSON.stringify(st)),allColors:JSON.parse(JSON.stringify(K)),activeCenterId:$t,isDrawingMode:Yt,previewLineStartVertexId:Nt,frozenReference_A_rad:Zt,frozenReference_A_baseRad:ze,frozenReference_D_du:Ot,frozenReference_Origin_Data:Re,frozenReference_D_g2g:Ue,deletedFaceIds:new Set(ls)}}function Hr(){var s,n;if(qt.length===0)return;const t=Xn();K.length,(s=K[0])!=null&&s.value,q.length,_s.push(t),_s.length>Do&&_s.shift();const e=qt.pop();Ji(e),K.length,(n=K[0])!=null&&n.value,q.length}function Wr(){if(_s.length===0)return;const t=Xn();qt.push(t),qt.length>Do&&qt.shift();const e=_s.pop();Ji(e)}function yt(t){const e=t.x*At,s=t.y*At,n=et.height;return{x:(e-J.offsetX)/J.scale,y:(n-s-J.offsetY)/J.scale}}function gt(t){const e=et.height,s=t.x*J.scale+J.offsetX,n=e-(t.y*J.scale+J.offsetY);return{x:s/At,y:n/At}}function Zi(){const t=document.querySelector(".canvas-container"),e=document.querySelector(".canvas-wrapper-relative");if(!t||!e)return;const s=e.offsetWidth,n=e.offsetHeight;et.width=s*At,et.height=n*At,et.style.width=`${s}px`,et.style.height=`${n}px`,Ht&&(Ht.style.width=`${s}px`,Ht.style.height=`${n}px`)}function V(t){return q.find(e=>e.id===t)}function Ys(t){const e=yt(t),s=Pt*2/J.scale,n=(uo+Pt)/J.scale;for(let i=q.length-1;i>=0;i--){const o=q[i];if(o.type!=="regular"&&G(e,o)<n)return o}for(let i=q.length-1;i>=0;i--){const o=q[i];if(o.type==="regular"&&G(e,o)<s)return o}return null}function Xs(t){const e=yt(t),s=po/J.scale;for(let n=X.length-1;n>=0;n--){const i=X[n],o=V(i.id1),a=V(i.id2);if(o&&a&&o.type==="regular"&&a.type==="regular"){const l=Me(e,o,a);if(l.distance<s&&l.onSegmentStrict)return i}}return null}function Js(t){const e=yt(t);for(let s=tt.length-1;s>=0;s--){const n=tt[s],i=n.vertexIds.map(o=>V(o)).filter(o=>o&&o.type==="regular");if(!(i.length<3)&&ws(e,i))return n}return null}function Eo(t){return X.filter(e=>e.id1===t||e.id2===t)}function Qi(t){if(!V(t))return[];const e=new Set,s=[t],n=[];for(e.add(t);s.length>0;){const i=s.shift();n.push(i),Ae(i,X).forEach(o=>{e.has(o)||(e.add(o),s.push(o))})}return n}function zr(){nt.length===0&&at.length===0&&Rt.length===0||(Tt(),ta(),sn())}function ta(){const t=new Set(nt);$t&&t.add($t);const e=[];rt.length>0&&rt.forEach(s=>{const n=tt.find(i=>Ct(i)===s);n&&(e.push(n),n.vertexIds.forEach(i=>t.add(i)))}),at.forEach(s=>{const[n,i]=s.split(As);t.add(n),t.add(i)}),se.vertices=Array.from(t).map(s=>{const n=V(s);return n?{...n}:null}).filter(s=>s),se.edges=[],X.forEach(s=>{t.has(s.id1)&&t.has(s.id2)&&se.edges.push({...s})}),se.faces=e.map(s=>JSON.parse(JSON.stringify(s))),se.referenceVertex=yt($)}function Ur(){if(se.vertices.length===0||!se.referenceVertex)return;Tt();const t=yt($),e=t.x-se.referenceVertex.x,s=t.y-se.referenceVertex.y,n=new Map,i=[];let o=null;qe(),se.vertices.forEach(l=>{const c=ns(),d={...l,id:c,x:l.x+e,y:l.y+s};q.push(d),n.set(l.id,c),d.type==="regular"?i.push(c):o=c}),se.edges.forEach(l=>{const c=n.get(l.id1),d=n.get(l.id2);c&&d&&X.push({...l,id1:c,id2:d})});const a=[];se.faces.forEach(l=>{const c=l.vertexIds.map(d=>n.get(d)).filter(Boolean);if(c.length===l.vertexIds.length){const d={...l,id:Ct({vertexIds:c}),vertexIds:c};d.localCoordSystem&&(d.localCoordSystem.origin.x+=e,d.localCoordSystem.origin.y+=s,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=n.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=n.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=n.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=n.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=n.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=n.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=n.get(d.localCoordSystem.scaleAttachedToEdge.v2))),tt.push(d),a.push(d.id)}}),ys(),nt=i,at=se.edges.map(l=>lt({id1:n.get(l.id1),id2:n.get(l.id2)})),rt=a,$t=o}function sn(){const t=new Set(nt),e=new Set(Rt),s=new Set(at),n=new Set(rt);if(t.size===0&&e.size===0&&s.size===0&&n.size===0)return;Tt(),n.size>0&&(n.forEach(o=>{ls.add(o)}),tt=tt.filter(o=>{const a=o.id||Ct(o);return!n.has(a)}));const i=[...X];s.size>0&&(X=X.filter(o=>!s.has(lt(o)))),t.size>0&&(q=q.filter(o=>!t.has(o.id)),X=X.filter(o=>!t.has(o.id1)&&!t.has(o.id2))),Zs(i,X),e.size>0&&(q=q.filter(o=>!e.has(o.id))),qe()}function _o(t,e){let s=J.scale*e;s<qo&&(s=qo);const n=t.x*At,i=t.y*At;J.offsetX=n*(1-e)+J.offsetX*e,J.offsetY=(et.height-i)*(1-e)+J.offsetY*e,J.scale=s}function On(t){let e=0,s,n=Math.PI/2,i=!0;const o=V(t);if(!o)return i=!0,Ft!=="none"&&H.interval1?s=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1:s=yo,Ot!==null&&(s=Ot),{offsetAngleRad:e,currentSegmentReferenceD:s,currentSegmentReferenceA_for_display:n,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=ji(o.id);return a?(i=!1,e=a.angleRad,s=Ot!==null?Ot:a.length,Zt!==null?Math.abs(Zt)<z?n=eo:n=Math.abs(Zt):n=eo):(i=!0,Ft!=="none"&&H.interval1?s=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1:s=yo,Ot!==null&&(s=Ot),e=0,n=eo),{offsetAngleRad:e,currentSegmentReferenceD:s,currentSegmentReferenceA_for_display:n,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:Zt,displayAngleA_originVertexData_for_A_equals_label:Re,frozen_A_baseRad_to_display:ze,frozen_D_du_to_display:Ot,frozen_D_g2g_to_display:Ue}}function Ti(t,e,s){var c,d;if(!t||!e)return null;const n=Math.atan2(e.y-t.y,e.x-t.x),i=G(t,e);let o=0,a=!0;for(let f=s.length-1;f>=0;f--){const h=s[f];let r=null;if(h.id1===t.id&&((c=V(h.id2))==null?void 0:c.type)==="regular"?r=h.id2:h.id2===t.id&&((d=V(h.id1))==null?void 0:d.type)==="regular"&&(r=h.id1),r&&r!==e.id){const u=V(r);if(u){o=Math.atan2(t.y-u.y,t.x-u.x),a=!1;break}}}const l=_t(n-o);return{startVertex:t,endVertex:e,absoluteAngleRad:n,length:i,precedingSegmentAbsoluteAngleRad:o,turnAngleRad:l,isFirstSegmentOfLine:a}}function qr(){const t=nt.filter(i=>{const o=V(i);return o&&o.type==="regular"});if(t.length<2)return;Tt();const e=JSON.parse(JSON.stringify(X));let s=!1;const n=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1;for(let i=0;i<t.length;i++)for(let o=i+1;o<t.length;o++){const a=t[i],l=t[o];if(!X.some(d=>d.id1===a&&d.id2===l||d.id1===l&&d.id2===a)){const d=V(a),f=V(l);if(d&&f){const h=_n(d,f,n,bt);X.push(h),s=!0}}}s&&Se&&(Zs(e,X),tt.forEach(i=>{i.color||(i.color=bt(Dt))}),ys())}function ee(t=[],e=[],s=[],n,i,o=!1){o?Xo(t[0],n,i):n?(nt=[...new Set([...nt,...t])],at=[...new Set([...at,...e])],rt=[...new Set([...rt,...s])]):i?(t.forEach(a=>{const l=nt.indexOf(a);l>-1?nt.splice(l,1):nt.push(a)}),e.forEach(a=>{const l=at.indexOf(a);l>-1?at.splice(l,1):at.push(a)}),s.forEach(a=>{const l=rt.indexOf(a);l>-1?rt.splice(l,1):rt.push(a)})):(nt=[...t],at=[...e],rt=[...s])}function Kr(){Rr(),K=Po.map(e=>typeof e=="string"?{type:"color",value:e}:e),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),Fr(),Ki(),Zi(),_e=new ya,_e.initialize(),document.body.appendChild(_e.getElement());const t=_e.getElement();t.addEventListener("mouseenter",()=>{To=!0}),t.addEventListener("mouseleave",()=>{To=!1}),_e.getElement().addEventListener("select",e=>{const s=e.detail,n=jl(s);if(n){if(qs&&Es!==null)K[Es]=n;else{Gr(n);const i=K.length-1;It.forEach(o=>{st[o]=i})}Mn(),qs=!1,Es=null,Vt()}}),J.scale=70,J.offsetX=et.width/2,J.offsetY=et.height/2,ss="regular",zt=document.getElementById("context-menu"),et.addEventListener("contextmenu",Mc),window.addEventListener("click",()=>{zt&&(zt.style.display="none")}),zt.addEventListener("mouseleave",()=>{zt.style.display="none"}),Tt(),aa()}function jr(t,e,s,n,i=0){const o={x:s.x-t.x,y:s.y-t.y},a={x:e.x-t.x,y:e.y-t.y},l=Math.hypot(o.x,o.y),c=Math.hypot(a.x,a.y),d=Math.atan2(o.y,o.x),f=Math.atan2(a.y,a.x);let h=0,r=1,u=!1;if(n===be)r=1,h=Nl(d,f,i);else if(n===ds)h=0,l>z&&(r=c/l);else if(n===hs&&(u=!0,h=0,l>z)){const p={x:o.x/l,y:o.y/l};r=(a.x*p.x+a.y*p.y)/l}return{rotation:h,scale:r,directionalScale:u}}function Zs(t,e){if(!Se){tt=[],ls.clear();return}const s=new Set(t.map(m=>lt(m))),n=new Set(e.map(m=>lt(m))),i=e.filter(m=>!s.has(lt(m))),o=t.filter(m=>!n.has(lt(m)));if(i.length===0&&o.length===0)return;const a=new Set;i.forEach(m=>{a.add(m.id1),a.add(m.id2)}),o.forEach(m=>{a.add(m.id1),a.add(m.id2)});const l=new Set,c=new Set;for(const m of a)c.has(m)||Qi(m).forEach(x=>{l.add(x),c.add(x)});const d=X.filter(m=>l.has(m.id1)&&l.has(m.id2)),f=tt.filter(m=>m.vertexIds.every(S=>l.has(S))),h=new Set(f.map(m=>m.id)),r=$n(d,V),u=new Set(r.map(m=>m.id)),p=f.filter(m=>!u.has(m.id));if(p.length>0){const m=new Set(p.map(S=>S.id));tt=tt.filter(S=>!m.has(S.id))}const g=r.filter(m=>!h.has(m.id)),y=new Set(i.map(m=>lt(m)));g.forEach(m=>{let S=!1;if(i.length>0)for(let C=0;C<m.vertexIds.length;C++){const b=m.vertexIds[C],v=m.vertexIds[(C+1)%m.vertexIds.length],M=lt({id1:b,id2:v});if(y.has(M)){S=!0;break}}if(ls.has(m.id))if(S)ls.delete(m.id);else return;const x=st[Dt];if(x!==-1){const C=K[x];C&&C.type==="colormap"?(m.colormapItem=C,m.colormapDistribution="x",delete m.color):(m.color=bt(Dt),delete m.colormapItem,delete m.colormapDistribution)}else m.color=bt(Dt),delete m.colormapItem,delete m.colormapDistribution;tt.push(m)}),ys()}function ea(t,e,s,n){const i=V(t.id1),o=V(t.id2);if(!i||!o)return null;const a=[...X],l={id:ns(),x:e.x,y:e.y,type:"regular",color:n(mt)};return q.push(l),X=X.filter(c=>lt(c)!==lt(t)),X.push(_n(i,l,s,n)),X.push(_n(l,o,s,n)),Se&&Zs(a,X),l}function sa(t,e,s){const n=2*Pt/J.scale;if(t.length===0)return{delta:e,snapped:!1};const i=t[0],o={x:i.x+e.x,y:i.y+e.y},a=[],l=t.filter(r=>r.type==="regular"),c=q.filter(r=>r.type==="regular"&&!t.some(u=>u.id===r.id)),d=s===1?[1]:Array.from({length:s},(r,u)=>u);if(l.length>0&&(d.forEach(r=>{r!==0&&l.forEach(u=>{c.forEach(p=>{const g={x:(p.x-u.x)/r,y:(p.y-u.y)/r};a.push({delta:g})})})}),s>1&&d.forEach(r=>{d.forEach(u=>{r>=u||l.forEach(p=>{l.forEach(g=>{const y=r-u;if(Math.abs(y)>0){const m={x:(g.x-p.x)/y,y:(g.y-p.y)/y};a.push({delta:m})}})})})})),a.length===0)return{delta:e,snapped:!1};let f=null,h=1/0;return a.forEach(r=>{const u={x:i.x+r.delta.x,y:i.y+r.delta.y},p=G(o,u);p<h&&(h=p,f=r)}),f&&h<n?{delta:f.delta,snapped:!0,snapType:"merge"}:{delta:e,snapped:!1}}function Jr(t,e,s,n){const i=parseInt(le||"1",10);let o=[];const a=Pt*2/J.scale;if(i>1){const c=q.filter(f=>f.type==="regular"&&!e.some(h=>h.id===f.id)),d=e.filter(f=>f.type==="regular");for(let f=0;f<d.length;f++)for(let h=0;h<d.length;h++){const r=d[f],u=d[h],p={x:r.x-t.x,y:r.y-t.y},g={x:u.x-t.x,y:u.y-t.y},y=Math.hypot(p.x,p.y),m=Math.hypot(g.x,g.y);if(Math.abs(y-m)<a){const S=Math.atan2(p.y,p.x),x=Math.atan2(g.y,g.x);for(let C=0;C<i;C++)for(let b=0;b<i;b++){if(r.id===u.id&&C===b||C===b)continue;const v=C-b;if(v===0)continue;let M=x-S;const I=n*v,A=Math.round((I-M)/(2*Math.PI));M+=A*(2*Math.PI);const E=M/v;o.push({rotation:E,priority:Math.abs(E-n)})}}}d.forEach(f=>{c.forEach(h=>{const r={x:f.x-t.x,y:f.y-t.y},u={x:h.x-t.x,y:h.y-t.y},p=Math.hypot(r.x,r.y),g=Math.hypot(u.x,u.y);if(Math.abs(p-g)<a){const y=Math.atan2(r.y,r.x),m=Math.atan2(u.y,u.y);for(let S=0;S<i;S++){if(S===0){Math.abs(_t(m-y))<z&&o.push({rotation:0,priority:Math.abs(n)});continue}let x=m-y;const C=n*S,b=Math.round((C-x)/(2*Math.PI));x+=b*(2*Math.PI);const v=x/S;o.push({rotation:v,priority:Math.abs(v-n)})}}})})}if(Math.abs(n)<dn&&o.push({rotation:0,priority:Math.abs(n)}),ut)for(const c of cs){const d=c*Math.PI/2;Math.abs(n-d)<dn&&o.push({rotation:d,priority:Math.abs(n-d)}),d!==0&&Math.abs(n- -d)<dn&&o.push({rotation:-d,priority:Math.abs(n- -d)})}if(o.length>0){o.sort((d,f)=>d.priority-f.priority);const c=o[0];if(c.priority<dn){const d=Jt(s,t,c.rotation,1,!1,null);return{rotation:c.rotation,pos:d,snapped:!0,snapType:"merge"}}}const l=Jt(s,t,n,1,!1,null);return{rotation:n,pos:l,snapped:!1,snapType:null}}function Zr(t,e,s,n){const i=parseInt(le||"1",10);let o=[];const a=Pt*2/J.scale,l=a/100;if(i>1){const d=q.filter(h=>h.type==="regular"&&!e.some(r=>r.id===h.id)),f=e.filter(h=>h.type==="regular");for(let h=0;h<f.length;h++)for(let r=0;r<f.length;r++){const u=f[h],p=f[r],g={x:u.x-t.x,y:u.y-t.y},y={x:p.x-t.x,y:p.y-t.y},m=Math.hypot(g.x,g.y),S=Math.hypot(y.x,y.y);if(m<z||S<z)continue;const x=Math.atan2(g.y,g.x),C=Math.atan2(y.y,y.x);if(Math.abs(_t(x-C))<l)for(let b=0;b<i;b++)for(let v=0;v<i;v++){if(u.id===p.id&&b===v||b===v)continue;const M=b-v;if(M===0)continue;const I=S/m;if(I<=0)continue;const A=Math.pow(I,1/M);o.push({scale:A,priority:Math.abs(A-n)})}}f.forEach(h=>{d.forEach(r=>{const u={x:h.x-t.x,y:h.y-t.y},p={x:r.x-t.x,y:r.y-t.y},g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<z||y<z)return;const m=Math.atan2(u.y,u.x),S=Math.atan2(p.y,p.y);if(Math.abs(_t(m-S))<l)for(let x=0;x<i;x++){if(x===0){Math.abs(y-g)<a&&o.push({scale:1,priority:Math.abs(n-1)});continue}const C=y/g;if(C<=0)continue;const b=Math.pow(C,1/x);o.push({scale:b,priority:Math.abs(b-n)})}})})}if(Math.abs(n-1)<Pa&&o.push({scale:1,priority:Math.abs(n-1)}),ut)for(const d of Tn)d!==0&&Math.abs(n-d)<.1&&o.push({scale:d,priority:Math.abs(n-d)});if(o.length>0){o.sort((f,h)=>f.priority-h.priority);const d=o[0];if(d.priority<.1){const f=Jt(s,t,0,d.scale,!1,null);return{scale:d.scale,pos:f,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}}const c=Jt(s,t,0,n,!1,null);return{scale:n,pos:c,snapped:!1,snapType:null}}function Qr(t,e,s,n,i){const o=parseInt(le||"1",10);let a=[];const l=Pt*2/J.scale,c=Math.hypot(i.x,i.y);if(c<z){const r=Jt(s,t,0,n,!0,i);return{scale:n,pos:r,snapped:!1,snapType:null}}const d={x:i.x/c,y:i.y/c},f=r=>{const u={x:r.x-t.x,y:r.y-t.y},p=u.x*d.x+u.y*d.y,g={x:u.x-p*d.x,y:u.y-p*d.y};return{parallel_dist:p,perp_vec:g}};if(o>1){const r=q.filter(g=>g.type==="regular"&&!e.some(y=>y.id===g.id)),u=e.filter(g=>g.type==="regular");for(let g=0;g<u.length;g++)for(let y=0;y<u.length;y++){const m=u[g],S=u[y],x=f(m),C=f(S);if(G(x.perp_vec,C.perp_vec)<l)for(let b=0;b<o;b++)for(let v=0;v<o;v++){if(m.id===S.id&&b===v||b===v)continue;const M=b-v;if(M===0||Math.abs(x.parallel_dist)<z)continue;const I=C.parallel_dist/x.parallel_dist;if(I>=0){const A=Math.pow(I,1/M);if(a.push({scale:A,priority:Math.abs(A-n)}),M%2===0){const E=-A;a.push({scale:E,priority:Math.abs(E-n)})}}else if(M%2!==0){const A=-Math.pow(Math.abs(I),1/M);a.push({scale:A,priority:Math.abs(A-n)})}}}u.forEach(g=>{const y=f(g);r.forEach(m=>{const S=f(m);if(G(y.perp_vec,S.perp_vec)<l){if(Math.abs(y.parallel_dist)<z)return;for(let x=0;x<o;x++){if(x===0){Math.abs(S.parallel_dist-y.parallel_dist)<l&&a.push({scale:1,priority:Math.abs(n-1)});continue}const C=S.parallel_dist/y.parallel_dist;let b;if(C>=0)b=Math.pow(C,1/x);else if(x%2!==0)b=-Math.pow(Math.abs(C),1/x);else continue;a.push({scale:b,priority:Math.abs(b-n)})}}})});const p=u.map(g=>({p:g,collapsed:{x:t.x+f(g).perp_vec.x,y:t.y+f(g).perp_vec.y}}));for(const g of p)r.some(y=>G(g.collapsed,y)<l)&&a.push({scale:0,priority:Math.abs(n)});for(let g=0;g<p.length;g++)for(let y=g+1;y<p.length;y++)G(p[g].collapsed,p[y].collapsed)<l&&a.push({scale:0,priority:Math.abs(n)})}if(Math.abs(n-1)<.1&&a.push({scale:1,priority:Math.abs(n-1)}),Math.abs(n)<.1&&a.push({scale:0,priority:Math.abs(n)}),ut){const r=Tn.filter(u=>u!==0);for(const u of r)Math.abs(n-u)<.1&&a.push({scale:u,priority:Math.abs(n-u)}),Math.abs(n- -u)<.1&&a.push({scale:-u,priority:Math.abs(n- -u)})}if(a.length>0){a.sort((u,p)=>u.priority-p.priority);const r=a[0];if(r.priority<.1){const u=Jt(s,t,0,r.scale,!0,i);return{scale:r.scale,pos:u,snapped:!0,snapType:"merge",snappedScaleValue:r.scale}}}const h=Jt(s,t,0,n,!0,i);return{scale:n,pos:h,snapped:!1,snapType:null}}function na(){Yo.clear();const t=Yn();sr(dt,{canvas:et,dpr:At,colors:t});const e=et.width/At,s=et.height/At,{grid1Interval:n,grid2Interval:i,alpha1:o,alpha2:a}=Ql(J.scale);H={interval1:n,interval2:i,alpha1:o,alpha2:a,scale:J.scale},De=tr(J,e,s,gt),dr(dt,{gridDisplayMode:Ft,canvas:et,dpr:At,viewTransform:J,gridAlpha:Dr,colors:t},gt,yt,H,De),ss!==Bn&&cr(dt,Ht,{canvas:et,dpr:At,coordsDisplayMode:ss,viewTransform:J,angleDisplayMode:ie,colors:t},gt,yt,H,De,te),Se&&q.length>0&&nr(dt,{allFaces:tt,facesVisible:Se,isDragConfirmed:xt,dragPreviewVertices:it,transformIndicatorData:vt,initialDragVertexStates:ot,colors:t,initialCoordSystemStates:is},gt,V);const l=parseInt(le||"1",10),c=l>1&&xt&&ot.length>0&&ot.some(p=>p.type==="regular"),d=Rn?[...at,Rn]:at;hr(dt,{allEdges:X,selectedEdgeIds:d,isDragConfirmed:xt,dragPreviewVertices:it,colors:t,edgesVisible:Dn},gt,V,lt);const h=c?new Set(ot.map(p=>p.id)):new Set;if(q.forEach(p=>{if(c&&h.has(p.id))return;let g={...p};if(xt&&it.length>0){const y=it.find(m=>m.id===p.id);y&&(g={...y})}Vi(dt,g,{selectedVertexIds:nt,selectedCenterIds:Rt,activeCenterId:$t,colors:t,verticesVisible:wn,isHovered:vo===p.id},gt)}),c&&or(dt,{copyCount:l,isDragConfirmed:xt,initialDragVertexStates:ot,dragPreviewVertices:it,transformIndicatorData:vt,allEdges:X,allFaces:tt,findVertexById:V,findNeighbors:p=>Ae(p,X),colors:t},gt),Se&&q.length>0&&(er(dt,{allFaces:tt,hoveredFaceId:Io,selectedFaceIds:rt,colors:t,isDragConfirmed:xt,dragPreviewVertices:it},gt,V,Ct),ys(),rt.length>0&&Pr(dt,{allFaces:tt,selectedFaceIds:rt,colors:t,isDragConfirmed:xt,dragPreviewVertices:it,initialDragVertexStates:ot,transformIndicatorData:vt,highlightedEdgeForSnap:as,draggedFaceId:Vn,coordSystemSnapAngle:Rs,coordSystemSnapType:Ls,coordSystemSnapScale:Ne,initialCoordSystemStates:is},gt,V)),Yt&&ut&&Re){const p={frozen_Origin_Data_to_display:Re,displayAngleA_valueRad_for_A_equals_label:Zt,frozen_A_baseRad_to_display:ze,frozen_D_du_to_display:Ot,frozen_D_g2g_to_display:Ue};ur(dt,p,gt,yt,{showAngles:Ee,showDistances:ge,viewTransform:J,mousePos:$,colors:t}),pr(Ht,p,{showAngles:Ee,showDistances:ge,viewTransform:J,mousePos:$,frozenReference_D_du:Ot,distanceSigFigs:Te,angleDisplayMode:ie,colors:t},yt,gt,te)}const r={lastGridState:H,showDistances:ge,showAngles:Ee,distanceSigFigs:Te,angleDisplayMode:ie,angleSigFigs:Ms,currentShiftPressed:ut,viewTransform:J,colors:t};if(xt)if(W&&W.dragSnap){const{dragOrigin:p,snappedData:g}=W.dragSnap,y={x:g.x,y:g.y},m=ft?ft.length-1:0,S=ft?Math.max(ft.length,2):2,x=bt(wt,m,S);let C=null;const b=st[wt];if(b!==-1){const M=K[b];M&&M.type==="colormap"&&(C={colormapItem:M,startT:0,endT:1})}Co(dt,{startVertex:p,snappedData:g,isShiftPressed:!0,currentColor:bt(mt),nextCreationColor:bt(mt),nextEdgeColor:x,colors:t,edgeColormapInfo:C},gt),Mo(dt,Ht,p,y,g,{showDistances:ge,showAngles:Ee,currentShiftPressed:ut,distanceSigFigs:Te,angleSigFigs:Ms,angleDisplayMode:ie,viewTransform:J,frozenReference_D_du:Ot,gridDisplayMode:Ft,frozenReference_A_rad:Zt,colors:t},gt,On(p.id),te)}else{const p=q.map(g=>it.find(m=>m.id===g.id)||g);W&&W.targetVertex?An(dt,Ht,W.targetVertex.id,p,r,gt,g=>Ae(g,X),lt,ut,null,te,nt,!0,ot,$t):W&&W.targetEdge&&Ii(dt,Ht,at,X,{showDistances:ge,distanceSigFigs:Te,colors:t,lastGridState:H,currentShiftPressed:ut},V,lt,gt,te,it,ot,vt)}else(ge||Ee)&&!Yt&&!c&&!ue&&(nt.length>0&&nt.length<=gl&&nt.forEach(p=>{An(dt,Ht,p,q,{...r,currentShiftPressed:!1},gt,g=>Ae(g,X),lt,!1,null,te,nt,!1,[],$t)}),at.length>0&&at.length<=yl&&(Ii(dt,Ht,at,X,{showDistances:ge,distanceSigFigs:Te,colors:t,lastGridState:H},V,lt,gt,te,it,ot,vt),Ar(dt,Ht,at,X,{showAngles:Ee,angleSigFigs:Ms,angleDisplayMode:ie,currentShiftPressed:ut,distanceSigFigs:Te,viewTransform:J,lastGridState:H,colors:t},V,lt,gt,p=>Ae(p,X),te)));if(Yt&&Nt){const p=V(Nt);if(p){const g=On(p.id),y=js(p,$,ut);let m=bt(wt),S=null;const x=st[wt];if(x!==-1){const v=K[x];if(v&&v.type==="colormap"){const M=ft?Math.max(ft.length,1):1,I=ft?ft.length-1:0,A=M>1?I/M:0,E=M>1?(I+1)/M:1;S={colormapItem:v,startT:A,endT:E}}}Co(dt,{startVertex:p,snappedData:y,isShiftPressed:ut,currentColor:bt(mt),nextCreationColor:bt(mt),nextEdgeColor:m,colors:t,edgeColormapInfo:S},gt);const C={x:y.x,y:y.y};Mo(dt,Ht,p,C,y,{showDistances:ge,showAngles:Ee,currentShiftPressed:ut,distanceSigFigs:Te,angleSigFigs:Ms,angleDisplayMode:ie,viewTransform:J,frozenReference_D_du:Ot,gridDisplayMode:Ft,frozenReference_A_rad:Zt,colors:t},gt,g,te)}}if(Ke&&xt&&_r(dt,Ui,$,t),xt&&ir(dt,{allVertices:q,dragPreviewVertices:it,viewTransform:J,colors:t,transformIndicatorData:vt,copyCount:parseInt(le||"1",10),initialDragVertexStates:ot},gt),ht){const p=gt(ht);dt.beginPath(),dt.arc(p.x,p.y,Pt,0,2*Math.PI),dt.fillStyle=t.feedbackSnapped,dt.fill()}Xe.forEach(p=>{const g=gt(p);dt.beginPath(),dt.arc(g.x,g.y,Pt,0,2*Math.PI),dt.fillStyle=t.feedbackSnapped,dt.fill()}),(vt||de)&&fr(dt,Ht,{transformIndicatorData:vt,angleSigFigs:Ms,distanceSigFigs:Te,colors:t,coordSystemTransformIndicatorData:de},gt,te),gr(Ht,{coordsDisplayMode:ss,isMouseOverCanvas:Us,currentShiftPressed:ut,ghostVertexPosition:ht,gridDisplayMode:Ft,lastGridState:H,angleDisplayMode:ie,canvas:et,dpr:At,mousePos:$,colors:t},yt,te);const u={dpr:At,canvasUI:Q,isToolbarExpanded:Fs,isColorPaletteExpanded:Qt,isTransformPanelExpanded:bs,isDisplayPanelExpanded:Ze,isVisibilityPanelExpanded:zi,isPlacingTransform:ue,placingTransformType:Ks,placingSnapPos:us,mousePos:$,allColors:K,activeThemeName:kn,colors:t,verticesVisible:wn,edgesVisible:Dn,facesVisible:Se,coordsDisplayMode:ss,gridDisplayMode:Ft,angleDisplayMode:ie,distanceDisplayMode:Cn,namedColors:_e.namedColors,colorAssignments:st,activeColorTargets:It,isDraggingColorTarget:zs,draggedColorTargetInfo:re};Er(dt,Ht,u,te),Nr()}function tc(t,e,s){const n=sa(t,e,s);if(n.snapped)return n;const i=t[0],o={x:i.x+e.x,y:i.y+e.y},a=Math.hypot(e.x,e.y),l=Math.atan2(e.y,e.x);let c=[];const d=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1;if(d){const u=d*.5,p=Math.floor(a/u)*u,g=p+u,y=cs.flatMap(C=>{const b=C*Math.PI/2;return b===0?[0]:[b,-b]}).sort((C,b)=>C-b);let m=-1/0,S=1/0;for(const C of y)C<=l&&(m=C),C>=l&&S===1/0&&(S=C);S===1/0&&(S=y[0]+2*Math.PI),m===-1/0&&(m=y[y.length-1]-2*Math.PI),c.push({x:p*Math.cos(m),y:p*Math.sin(m)}),c.push({x:p*Math.cos(S),y:p*Math.sin(S)}),c.push({x:g*Math.cos(m),y:g*Math.sin(m)}),c.push({x:g*Math.cos(S),y:g*Math.sin(S)}),Ps(o,Ft,d,De,!0).forEach(C=>{c.push({x:C.x-i.x,y:C.y-i.y})})}if(c.length===0)return{delta:e,snapped:!1};let f=e,h=1/0;c.forEach(u=>{const p=(u.x-e.x)**2+(u.y-e.y)**2;p<h&&(h=p,f=u)});const r=Ri/J.scale;return Math.sqrt(h)<r?{delta:f,snapped:!0,snapType:"geometric_grid"}:{delta:e,snapped:!1}}function oa(){if(!ft||ft.length<2)return;const t=st[mt];if(t===-1)return;const e=K[t];if(!e||e.type!=="colormap")return;const s=ft.length;ft.forEach((n,i)=>{const o=V(n);if(o&&o.type==="regular"){const a=s>1?i/(s-1):.5;o.color=ne(e,a)}})}function ia(){if(!ft||ft.length<2)return;const t=st[wt];if(t===-1)return;const e=K[t];if(!e||e.type!=="colormap")return;const n=ft.length-1;for(let i=0;i<n;i++){const o=ft[i],a=ft[i+1],l=X.find(c=>c.id1===o&&c.id2===a||c.id1===a&&c.id2===o);if(l){const c=i/n,d=(i+1)/n;l.gradientStart=c,l.gradientEnd=d,l.colormapItem=e,delete l.colormapOffset,delete l.color}}}function ec(t,e,s){if(!Qt)return!1;const n=Q.removeColorButton;if(n&&t.x>=n.x&&t.x<=n.x+n.width&&t.y>=n.y&&t.y<=n.y+n.height){if(K.length>1&&It.length>0){const o=It[It.length-1],a=st[o];a>=0&&(Tt(),qi(a))}return!0}const i=Q.addColorButton;return i&&t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height?(qs=!1,Es=null,_e.show(),!0):!1}function qe(){if(xe&&clearTimeout(xe),le="",xe=null,Fe&&(K=jt.originalAllColors,st=jt.originalAssignments,Vt(),qt.length>0&&qt.pop(),Fe=!1,jt=null,ts=!1),Yt){Yt=!1,Nt=null,Zt=null,ze=null,Ot=null,Ue=null,Re=null,kt=[],ce=0,ft=[];return}ue&&(ue=!1,Ks=null,us=null),nt=[],at=[],rt=[],Rt=[],$t=null,It=[],Qt&&Vt(),de=null,Xt=!1,xt=!1,Ke=!1,bn=!1,Qe=!1,ps=!1,it=[],ot=[],Ln=null,we=-1,U={targetId:null,type:null,count:0,timestamp:0},et.style.cursor="crosshair",vt=null,Xe=[],ht=null,as=null,Rs=null,Vn=null,Ls=null,de=null}function sc(){if(!Yt||!Nt||kt.length===0)return;Tt();const t=V(Nt);if(!t){qe();return}const e=ji(t.id);if(!e){qe();return}const s=e.angleRad;if(kt.length===1)return;const n=kt.length-1,i=(ce-1)%n+1,o=kt[i],a=o.length;let l;if(i===kt.length-1){const m=kt.length>2?1:0;l=kt[m].turn}else l=o.turn;let c,d;if(i===kt.length-1){const m=[kt[0].endVertexColor,kt[1].endVertexColor],S=(ce-1)%m.length;d=m[S];const x=ce%m.length;c=m[x],t.color=d}else c=o.endVertexColor;const f=Ce(s+l),h=t.x+a*Math.cos(f),r=t.y+a*Math.sin(f);let u=null,p=!1;const g=Pt*2/J.scale;for(const m of q)if(m.type==="regular"&&G({x:h,y:r},m)<g){u=m,p=!0;break}p||(u={id:ns(),x:h,y:r,type:"regular",color:c},q.push(u)),X.some(m=>m.id1===t.id&&m.id2===u.id||m.id2===t.id&&m.id1===u.id)||X.push({id1:t.id,id2:u.id,color:bt(wt)}),Se&&(tt=$n(X,V),ys()),ft.push(u.id),window.currentDrawingPath=ft,oa(),ia(),Nt=u.id,ce++,ce>=kt.length&&(ce=1),Ot=null,Ue=null,Zt=null,ze=null,Re=null}function aa(){na(),requestAnimationFrame(aa)}function nc(t){if(rt.length===0)return!1;const e=Os(t,et);for(const s of rt){const n=tt.find(o=>o.id===s);if(!n||!n.localCoordSystem)continue;const i=Bl(e,n,gt);if(i)return gs=!0,oe=i,Vn=n.id,Nn=oc(n),i.type==="center"&&(n.localCoordSystem.isCustom=!0),t.preventDefault(),!0}return!1}function oc(t){const e=[],s=[],n=[],i=[],o=[];t.vertexIds.forEach(a=>{const l=V(a);l&&l.type==="regular"&&e.push({...l,id:a})});for(let a=0;a<e.length;a++){const l=e[a],c=e[(a+1)%e.length];s.push({x:(l.x+c.x)/2,y:(l.y+c.y)/2}),n.push(l.id,c.id),o.push(Math.atan2(c.y-l.y,c.x-l.x))}return tt.forEach(a=>{a.id!==t.id&&a.localCoordSystem&&i.push(a.localCoordSystem.origin)}),{vertices:e,edgeMidvertices:s,edgeVertexIds:n,faceCenters:i,edgeAngles:o}}function ic(t){if(!gs||!oe)return!1;const e=Os(t,et),s=yt(e),n=oe,i=n.face,o=i.localCoordSystem,a=i.vertexIds.map(l=>V(l)).filter(l=>l&&l.type==="regular"&&l.x!==void 0&&l.y!==void 0);if(n.type==="center"){let l,c={snapped:!1};if(t.shiftKey){if(c=Yl(s,Nn,Ft,H,De),c.snapped){if(l=c.snapPoint,c.snapType==="edge"){const d=c.edgeInfo,f=V(d.v1),h=V(d.v2);f&&h&&(l=c.snapPoint,de=null)}}else{const d=en(a);l=d?d.center:a[0]}n.type==="center"&&(ht=l)}else l=s,ht=null,de=null;a.length>0&&a.every(d=>d&&d.x!==void 0&&d.y!==void 0)&&(l=Ds(l,a),ht&&(ht=Ds(ht,a))),o.origin.x=l.x,o.origin.y=l.y,o.isCustom=!0,c.snapped?(o.attachedToVertex=c.vertexId||null,o.attachedToEdge=c.edgeInfo||null):(o.attachedToVertex=null,o.attachedToEdge=null)}else if(n.type==="x_axis"||n.type==="y_axis"){const l={x:s.x-o.origin.x,y:s.y-o.origin.y};let c=Math.atan2(l.y,l.x),d=Math.hypot(l.x,l.y);if(as=null,Rs=null,Ls=null,Xe=[],ht=null,de=null,Ne=null,t.shiftKey){const f=$l(s,o.origin,!0,Nn);if(f.snapped){c=f.angle,Rs=c,Ls=f.snapType;const h={x:Math.cos(c),y:Math.sin(c)},r={x:s.x-o.origin.x,y:s.y-o.origin.y},u=r.x*h.x+r.y*h.y;if(f.snapType==="vertex_direction"){const p=V(f.targetVertexId);p&&(d=G(o.origin,p),Ne=d)}else if(f.edgeIndex!==null){as=f.edgeIndex;const p=la(i,f.edgeIndex),g=Math.abs(_t(c-p.edgeAngle))>Math.PI/4&&Math.abs(_t(c-p.edgeAngle))<3*Math.PI/4;if(n.type==="x_axis"&&g){const y=V(p.v1Id),m=V(p.v2Id);if(y&&m){const S=xo(o.origin,y,m),x=S.distance,C=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};C.forEach(M=>{const I=x*M,A=Math.abs(u-I);A<b.dist&&(b={scale:I,dist:A,fraction:M})});const v=15/J.scale;b.dist<v?(d=b.scale,Ne=d,de={orthogonalDistanceFraction:b.fraction,v1:y,v2:m,snapPosition:{origin:o.origin,closest:S}}):(d=u>0?u:0,Ne=d)}}else{const y=Vl(o.origin,n.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:p},i,V,u,J,n.type);if(y.snapped){if(d=y.scale,Ne=d,y.edgeFraction!==null){const m={x:o.origin.x+d*Math.cos((n.type==="y_axis",c)),y:o.origin.y+d*Math.sin((n.type==="y_axis",c))};de={edgeFraction:y.edgeFraction,v1:V(p.v1Id),v2:V(p.v2Id),snapPosition:m}}}else d=u>0?u:0}}}else d=Math.hypot(l.x,l.y)}n.type==="y_axis"?o.angle=c-Math.PI/2:o.angle=c,d>.01&&(o.scale=d),o.isCustom=!0}return!0}function ac(){if(gs){const t=oe,e=t.face,s=e.localCoordSystem;if(t.type==="center"&&s){let i=null,o=null;if(e.vertexIds.forEach(a=>{const l=V(a);l&&G(s.origin,l)<.01&&(i=a)}),!i)for(let a=0;a<e.vertexIds.length;a++){const l=V(e.vertexIds[a]),c=V(e.vertexIds[(a+1)%e.vertexIds.length]);if(l&&c){const d=Me(s.origin,l,c);if(d.distance<.01&&d.onSegmentStrict){const f=G(l,c);o={v1:l.id,v2:c.id,t:d.t,originalAngle:Math.atan2(c.y-l.y,c.x-l.x),originalLength:f,scaleRatio:s.scale/f};break}}}s.attachedToVertex=i,s.attachedToEdge=o}if(t.type==="x_axis"||t.type==="y_axis"){let n=!1,i=!1;if(Ls==="edge"&&as!==null){const o=la(e,as);if(o&&(Rs!==null&&(s.rotationAlignedToEdge={v1:o.v1Id,v2:o.v2Id,originalAngle:o.edgeAngle,originalSystemAngle:s.angle},n=!0),Ne!==null)){const a=V(o.v1Id),l=V(o.v2Id);if(a&&l){const c=G(a,l);c>z&&(s.scaleAttachedToEdge={v1:o.v1Id,v2:o.v2Id,scaleRatio:s.scale/c},i=!0)}}}n||(s.rotationAlignedToEdge=null),i||(s.scaleAttachedToEdge=null)}return Ne=null,de=null,gs=!1,oe=null,Nn=null,as=null,Rs=null,Ls=null,Vn=null,ht=null,Xe=[],de=null,!0}return!1}function lc(t){const e=t.ctrlKey||t.metaKey,s=Yn();if(t.key==="Shift"&&!ut){ut=!0;const i=yt($);if(ue){const o=$e(i);o&&(us=gt(o),ht=o)}else if(Yt&&Nt){const o=V(Nt);if(o){const a=On(o.id),l=js(o,$,ut);let c=bt(wt),d=null;const f=st[wt];if(f!==-1){const r=K[f];if(r&&r.type==="colormap"&&ft&&ft.length>=1){const u=ft.length,p=ft.length-1,g=u>1?p/(u-1):0,y=u>1?(p+1)/u:1;d={colormapItem:r,startT:g,endT:y}}}Co(dt,{startVertex:o,snappedData:l,isShiftPressed:ut,currentColor:bt(mt),nextCreationColor:bt(mt),nextEdgeColor:c,colors:s,edgeColormapInfo:d},gt),Mo(dt,Ht,o,l,l,{showDistances:ge,showAngles:Ee,currentShiftPressed:ut,distanceSigFigs:Te,angleSigFigs:Ms,angleDisplayMode:ie,viewTransform:J,frozenReference_D_du:Ot,gridDisplayMode:Ft,frozenReference_A_rad:Zt,colors:s},gt,a,te)}}else if(!Xt)if(gs&&oe&&oe.type==="center"){const o=$e(i);if(o){ht=o;const a=oe.face,l=a.localCoordSystem,c=a.vertexIds.map(f=>V(f)).filter(f=>f&&f.type==="regular"),d=Ds(o,c);l.origin.x=d.x,l.origin.y=d.y,l.isCustom=!0}}else Js($)?ht=null:ht=$e(i)}if(Xt&&we===0&&(W!=null&&W.targetVertex||W!=null&&W.targetEdge)&&t.key>="0"&&t.key<="9"){if(t.repeat)return;t.preventDefault(),clearTimeout(xe),xe===null||le.length>=2?le=t.key:le+=t.key,xe=setTimeout(()=>{xe=null},500);return}if(e&&t.key.toLowerCase()===kl){t.preventDefault(),Yt&&Nt&&sc();return}if(!(Xt&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(t.key)&&!(e&&[gi,mi,yi,lo,Si,xi,pi,fi,ui].includes(t.key.toLowerCase())))){if(Us&&e&&(t.key===fi||t.key===ui)){t.preventDefault();const i={x:et.width/At/2,y:et.height/At/2};_o(i,Ko);return}if(Us&&e&&t.key===pi){t.preventDefault();const i={x:et.width/At/2,y:et.height/At/2};_o(i,1/Ko);return}if(t.key===wl)t.preventDefault(),qr();else if(t.key===Dl)qe();else if(t.key===Rl||t.key===Ll)sn();else if(e&&t.key.toLowerCase()===gi)t.preventDefault(),ta();else if(e&&t.key.toLowerCase()===mi)t.preventDefault(),zr();else if(e&&t.key.toLowerCase()===yi)t.preventDefault(),Ur();else if(e&&t.key.toLowerCase()===lo&&!t.shiftKey)t.preventDefault(),Hr();else if(e&&(t.key.toLowerCase()===Si||t.shiftKey&&t.key.toLowerCase()===lo))t.preventDefault(),Wr();else if(e&&t.key.toLowerCase()===xi&&!To){t.preventDefault(),Tt(),nt=q.filter(o=>o.type==="regular").map(o=>o.id),at=X.map(o=>lt(o)),rt=tt.map(o=>o.id),Rt=q.filter(o=>o.type!=="regular").map(o=>o.id),$t=null;const i=[];rt.length>0&&i.push(Dt),at.length>0&&i.push(wt),nt.length>0&&i.push(mt),i.length>0&&(It=i,Qt&&Vt())}}}function rc(){Qt=!Qt,Qt&&Vt()}function cc(){Tt(),kn=kn==="dark"?"light":"dark",kr(),Br(),Qt&&Vt()}function la(t,e){const s=t.vertexIds[e],n=t.vertexIds[(e+1)%t.vertexIds.length],i=V(s),o=V(n);return i&&o?{v1Id:s,v2Id:n,edgeAngle:Math.atan2(o.y-i.y,o.x-i.x)}:null}function dc(t){if($=Os(t,et),ut=t.shiftKey,zs&&re){const e=Q.colorTargetIcons.find(s=>s.target===re.target);if(e){const s=[...Q.colorSwatches,Q.randomColorButton],n=Ni($,s);if(n){e.x=n.x+(n.width-e.width)/2;const i=n.id==="random-color-button"?-1:n.index;re.previewColorIndex=i}else e.x=$.x-re.offsetX,re.previewColorIndex=re.originalColorIndex}return}if(Fe){const e=Q.removeColorButton,s=e&&$.x>=e.x&&$.x<=e.x+e.width&&$.y>=e.y&&$.y<=e.y+e.height;if(s&&K.length>1&&!ts){ts=!0;const o=K.indexOf(jt.item);o>=0&&(K.splice(o,1),Object.keys(st).forEach(a=>{st[a]>o?st[a]--:st[a]===o&&(st[a]=Math.min(o,K.length-1))}),Vt());return}else if(!s&&ts){ts=!1,K.unshift(jt.item),Object.keys(st).forEach(o=>{st[o]++}),Object.keys(jt.originalAssignments).forEach(o=>{jt.originalAssignments[o]===jt.originalIndex&&(st[o]=0)}),Vt();return}if(ts)return;const n=K.indexOf(jt.item);let i=n;for(let o=0;o<Q.colorSwatches.length;o++){const a=Q.colorSwatches[o],l=a.x,c=a.x+a.width;if($.x>=l&&$.x<=c){i=K.indexOf(a.item);break}}if(i!==n){const o=K[n];K[n]=K[i],K[i]=o,Object.keys(st).forEach(a=>{st[a]===n?st[a]=i:st[a]===i&&(st[a]=n)}),jt.item=K[i],Vt()}return}if(!ic(t)){if(vo=null,Rn=null,Io=null,!Xt){const e=Ys($),s=Xs($),n=Js($);e?vo=e.id:s?Rn=lt(s):n&&(Io=n.id)}if(ut&&!Xt){const e=yt($);if(ue){const s=$e(e);s&&(us=gt(s),ht=s)}else if(Yt&&Nt){const s=V(Nt);if(s){const n=js(s,$,ut);ht={x:n.x,y:n.y}}}else gs&&oe&&oe.type==="center"?ht=$e(e):Js($)?ht=null:ht=$e(e)}else if(!ut&&Yt&&Nt){const e=V(Nt);if(e){const s=js(e,$,!1);s.snapped&&(s.snapType==="vertex"||s.snapType==="edge")?ht={x:s.x,y:s.y}:ht=null}else ht=null}else ut||(ht=null,us=null);if(Xt){if(!xt&&G($,he)>Aa)if(xt=!0,Ln=W.dragHandle,bn=!!W.isTransformDrag,W.target==="ui_icon_click")zs=!0,re={target:W.element.target,offsetX:$.x-W.element.x,offsetY:$.y-W.element.y,originalColorIndex:st[W.element.target],previewColorIndex:st[W.element.target]},W.target="ui_icon_drag",It=[W.element.target];else if(W.target==="ui_swatch")Tt(),Fe=!0,jt={index:W.element.index,item:W.element.item,offsetX:$.x-W.element.x,originalIndex:W.element.index,originalAllColors:JSON.parse(JSON.stringify(K)),originalAssignments:JSON.parse(JSON.stringify(st))};else if(we===2){Ke=!0;return}else if(W.target==="canvas")ps=!0,ho={x:J.offsetX,y:J.offsetY},et.style.cursor="move";else{et.style.cursor="grabbing",Qe=W.targetVertex&&W.targetVertex.type!=="regular";let e;if(Qe)e=[W.targetVertex];else{let s=new Set(nt);at.forEach(n=>{const[i,o]=n.split(As);s.add(i),s.add(o)}),rt.forEach(n=>{const i=tt.find(o=>Ct(o)===n);i&&i.vertexIds.forEach(o=>s.add(o))}),e=Array.from(s).map(n=>V(n)).filter(n=>n&&n.type==="regular")}if(Qe&&W.targetVertex.type===be){const s=W.targetVertex,n=yt(he),i={x:n.x-s.x,y:n.y-s.y};W.initialRotationStartAngle=Math.atan2(i.y,i.x),fo=0}if(e.length>0){ot=JSON.parse(JSON.stringify(e)),it=JSON.parse(JSON.stringify(e)),is.clear();const s=new Set(ot.map(n=>n.id));tt.forEach(n=>{n.vertexIds.some(i=>s.has(i))&&n.localCoordSystem&&is.set(n.id,JSON.parse(JSON.stringify(n.localCoordSystem)))})}}if(xt){const e=$t&&(nt.length>0||at.length>0||rt.length>0)&&!bn;if(W.dragSnap=null,ht=null,Xe=[],ps){const s=$.x-he.x,n=$.y-he.y;J.offsetX=ho.x+s*At,J.offsetY=ho.y-n*At}else if((e||bn)&&!Qe){const s=V($t);let n=Ln;if(!n&&ot.length>0&&(n=ot.find(r=>G(r,s)>1e-6)||ot[0]),!s||!n)return;const i=s.type,o=yt($),a=jr(s,o,n,i,fo);let l={},c={};if(i===be)l=Jr(s,ot,n,a.rotation),c={rotation:l.rotation,scale:1,directionalScale:!1},fo=l.rotation;else if(i===ds)l=Zr(s,ot,n,a.scale),c={rotation:0,scale:l.scale||a.scale,directionalScale:!1};else if(i===hs){const r={x:n.x-s.x,y:n.y-s.y};l=Qr(s,ot,n,a.scale,r),c={rotation:0,scale:l.scale||a.scale,directionalScale:!0}}vt={center:s,startPos:n,currentPos:l.pos||o,rotation:c.rotation,scale:c.scale,isSnapping:l.snapped||!1,transformType:i,directionalScale:c.directionalScale,snappedScaleValue:l.snappedScaleValue||null,gridToGridInfo:l.gridToGridInfo||null};const d={x:n.x-s.x,y:n.y-s.y};if(it=ot.map(r=>{const u=Jt(r,s,c.rotation,c.scale,c.directionalScale,d);return{...r,x:u.x,y:u.y}}),l.snapped&&l.snapType==="merge"&&l.mergingVertex&&l.mergeTarget){const r=ot.find(u=>u.id===l.mergingVertex.id);if(r){const u=it.find(p=>p.id===r.id);if(u){const p={x:l.mergeTarget.x-u.x,y:l.mergeTarget.y-u.y};it.forEach(g=>{g.x+=p.x,g.y+=p.y}),vt.currentPos&&(vt.currentPos.x+=p.x,vt.currentPos.y+=p.y)}}}const f=Pt*2/J.scale,h=q.filter(r=>r.type==="regular"&&!ot.some(u=>u.id===r.id));it.forEach(r=>{r.type==="regular"&&h.forEach(u=>{G(r,u)<f&&Xe.push({x:u.x,y:u.y})})});for(let r=0;r<it.length;r++)for(let u=r+1;u<it.length;u++){const p=it[r],g=it[u];p.type==="regular"&&g.type==="regular"&&G(p,g)<f&&Xe.push({x:(p.x+g.x)/2,y:(p.y+g.y)/2})}}else if(Qe&&it.length>0){const s=yt($);let n=s;if(ut){const o=$e(s);o&&(n=o,ht=o)}else ht=null;const i=it.find(o=>o&&o.id===ot[0].id);i&&(i.x=n.x,i.y=n.y)}else if(it.length>0){const s=yt($),n=yt(he),i={x:s.x-n.x,y:s.y-n.y};let o={snapped:!1};const a=parseInt(le||"1",10);if(ut&&ot.length===1&&ot[0].type==="regular"&&Ae(ot[0].id,X).some(c=>!nt.includes(c))){const c=ot[0];o=Or(c,s,nt);const d=it.find(f=>f&&f.id===c.id);d&&(d.x=o.pos.x,d.y=o.pos.y)}else{let c;ut?(o=tc(ot,i,a),c=o.delta):(o=sa(ot,i,a),c=o.delta),ot.forEach(d=>{const f=it.find(h=>h&&h.id===d.id);f&&(f.x=d.x+c.x,f.y=d.y+c.y)})}W.finalSnapResult=o,o.snapped&&o.mergeTarget&&(ht=o.mergeTarget)}}}}}function hc(t){if(ue){Tt();const d=yt($),f=ut?$e(d):d,h={id:ns(),x:f.x,y:f.y,type:Ks};q.push(h),Rt=[h.id],$t=h.id,nt=[],at=[],rt=[],ue=!1,Ks=null,us=null,et.style.cursor="crosshair",t.preventDefault();return}if(Xt=!0,xt=!1,ps=!1,Qt){const d=(Q.colorTargetIcons||[]).filter(f=>$.x>=f.x&&$.x<=f.x+f.width&&$.y>=f.y&&$.y<=f.y+f.height);if(d.length>0){const f=d[d.length-1],{element:h,shiftKey:r,ctrlKey:u}={element:f,shiftKey:t.shiftKey,ctrlKey:t.ctrlKey||t.metaKey};r?It.includes(h.target)||It.push(h.target):u?It.includes(h.target)?It=It.filter(p=>p!==h.target):It.push(h.target):It=[h.target],Vt(),W={target:"ui_icon_click",element:{...f,type:"colorTargetIcon"}};return}for(const f of Q.colorSwatches)if($.x>=f.x&&$.x<=f.x+f.width&&$.y>=f.y&&$.y<=f.y+f.height){W={target:"ui_swatch",element:{...f}};return}}if(Yr($,t.shiftKey,t.ctrlKey||t.metaKey)){W={target:"ui"};return}if(nc(t))return;if(t.altKey&&!Yt&&(Ys($)||Xs($))){const d=Ys($),f=Xs($);if(Tt(),qe(),d&&d.type==="regular")Yt=!0,Nt=d.id,kt=[],ce=0,ft=[d.id],window.currentDrawingPath=ft;else if(f){const h=V(f.id1),r=V(f.id2);if(h&&r){const u=Me(yt($),h,r),p=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1,g=ea(f,u,p,bt);g&&(Yt=!0,Nt=g.id,kt=[],ce=0,ft=[g.id],window.currentDrawingPath=ft)}}Xt=!1,t.preventDefault();return}let e=Ys($),s=e?null:Xs($),n=!e&&!s?Js($):null;const i=t.shiftKey||t.ctrlKey||t.metaKey,o=e||s||n;let a=!1;e?a=nt.includes(e.id)||Rt.includes(e.id):s?a=at.includes(lt(s)):n&&(a=rt.includes(Ct(n))),!Yt&&!i&&o&&!a&&(e?ee([e.id],[],[],!1,!1,e.type!=="regular"):s?ee([],[lt(s)],[],!1,!1):n&&ee([],[],[Ct(n)],!1,!1));let l=null;if(e)l=e;else if(s){const d=V(s.id1),f=V(s.id2);l=Me(yt($),d,f)}else n&&(l=yt($));const c=$t&&(nt.length>0||at.length>0||rt.length>0);ot=[],it=[],W={targetVertex:e,dragHandle:l,targetEdge:s,targetFace:n,target:o||"canvas",shiftKey:t.shiftKey,ctrlKey:t.ctrlKey||t.metaKey,isTransformDrag:c},e&&e.type!=="regular"&&(Qe=!0,Xo(e.id,t.shiftKey,t.ctrlKey||t.metaKey))}function fc(t){if(zs){if(Q.colorTargetIcons.find(c=>c.target===re.target)){const c=[...Q.colorSwatches,Q.randomColorButton],d=Ni($,c);if(d){const f=d.id==="random-color-button"?-1:d.index;st[re.target]=f,Mn()}}zs=!1,re=null,Vt(),Xt=!1,xt=!1,W=null;return}if(Fe){const l=Q.removeColorButton;if(l&&$.x>=l.x&&$.x<=l.x+l.width&&$.y>=l.y&&$.y<=l.y+l.height&&K.length>1){const d=K.indexOf(jt.item);d!==-1&&qi(d)}Fe=!1,jt=null,ts=!1,Vt(),Xt=!1,xt=!1,W=null;return}if(!xt&&W&&W.target==="ui_icon_click"&&W.element.type==="colorTargetIcon"){const{element:l}=W,c=Date.now(),d=`icon-${l.target}`;if(U.targetId===d&&c-U.timestamp<cn){switch(Tt(),l.target){case mt:wn=!wn;break;case wt:Dn=!Dn;break;case Dt:Se=!Se;break}Vt(),U.count=0}U.targetId=d,U.timestamp=c,Xt=!1,W=null;return}if(!xt&&W&&W.target==="ui_swatch"){const{element:l}=W,c=Date.now(),d=`swatch-${l.index}`;if(U.targetId===d&&c-U.timestamp<cn){qs=!0,Es=l.index;const f=K[l.index];let h;if(f.type==="color"){const r=So(f.value);h={type:"colormap",points:[{pos:.5,alpha:r.a,color:[r.r,r.g,r.b],order:1}]}}else f.type==="colormap"&&(h={type:"colormap",points:f.vertices.map(r=>({pos:r.pos,alpha:r.alpha!==void 0?r.alpha:1,color:Array.isArray(r.color)?[...r.color]:[r.color.r||0,r.color.g||0,r.color.b||0],order:r.order||1})),isCyclic:f.isCyclic===!0});_e.show(void 0,void 0,h),U.count=0}else It.length>0&&(Tt(),It.forEach(f=>st[f]=l.index),Mn(),Vt());U.targetId=d,U.timestamp=c,Xt=!1,W=null;return}if(!xt&&Fe){const l=K.indexOf(jt.item),c=`swatch-${l}`,d=Date.now();if(U.targetId===c&&d-U.timestamp<cn){qs=!0,Es=l;const f=K[l];let h;if(f.type==="color"){const r=So(f.value);h={type:"colormap",points:[{pos:.5,alpha:r.a,color:[r.r,r.g,r.b],order:1}]}}else f.type==="colormap"&&(h={type:"colormap",points:f.vertices.map(r=>({pos:r.pos,alpha:r.alpha!==void 0?r.alpha:1,color:Array.isArray(r.color)?[...r.color]:[r.color.r||0,r.color.g||0,r.color.b||0],order:r.order||1}))});_e.show(void 0,void 0,h),U.count=0}else It.forEach(f=>st[f]=l),Mn(),Vt();U.targetId=c,U.timestamp=d,Fe=!1,jt=null,Tt();return}if(ac())return;xe&&clearTimeout(xe);const e=parseInt(le,10)||1;if(le="",xe=null,!Xt)return;const{shiftKey:s,ctrlKey:n,targetVertex:i,targetEdge:o,targetFace:a}=W;if(xt){Tt();let l=null;if(e>1){const p=ot.filter(b=>b.type==="regular"),g=new Set(p.map(b=>b.id)),y=X.filter(b=>g.has(b.id1)&&g.has(b.id2)),m=tt.filter(b=>b.vertexIds.every(v=>g.has(v))),S=[],x=[],C=[];l={vertices:[],edges:[],faces:[]};for(let b=1;b<e;b++){const v=new Map,M=[],I=[],A=[];p.forEach(E=>{let _;if(vt){const{center:P,rotation:D,scale:k,directionalScale:N,startPos:w}=vt,R={x:w.x-P.x,y:w.y-P.y};_=Jt(E,P,D*b,Math.pow(k,b),N,R)}else{const P={x:it[0].x-ot[0].x,y:it[0].y-ot[0].y};_={x:E.x+P.x*b,y:E.y+P.y*b}}const T={...E,..._,id:ns()};S.push(T),v.set(E.id,T.id),M.push(T.id)}),y.forEach(E=>{const _=v.get(E.id1),T=v.get(E.id2);if(_&&T){const P={...E,id1:_,id2:T};x.push(P),I.push(lt(P))}}),m.forEach(E=>{const _=is.get(E.id),T=E.vertexIds.map(P=>v.get(P));if(T.every(Boolean)){const P=JSON.parse(JSON.stringify(E));if(P.id=Ct({vertexIds:T}),P.vertexIds=T,P.localCoordSystem&&_){if(vt){const{center:D,rotation:k,scale:N,directionalScale:w,startPos:R}=vt,L={x:R.x-D.x,y:R.y-D.y};P.localCoordSystem.origin=Jt(_.origin,D,k*b,Math.pow(N,b),w,L),P.localCoordSystem.angle=Ce(_.angle+k*b),w||(P.localCoordSystem.scale=_.scale*Math.pow(N,b))}else{const D={x:it[0].x-ot[0].x,y:it[0].y-ot[0].y};P.localCoordSystem.origin.x=_.origin.x+D.x*b,P.localCoordSystem.origin.y=_.origin.y+D.y*b}P.localCoordSystem.attachedToVertex&&(P.localCoordSystem.attachedToVertex=v.get(P.localCoordSystem.attachedToVertex)),P.localCoordSystem.attachedToEdge&&(P.localCoordSystem.attachedToEdge.v1=v.get(P.localCoordSystem.attachedToEdge.v1),P.localCoordSystem.attachedToEdge.v2=v.get(P.localCoordSystem.attachedToEdge.v2)),P.localCoordSystem.rotationAlignedToEdge&&(P.localCoordSystem.rotationAlignedToEdge.v1=v.get(P.localCoordSystem.rotationAlignedToEdge.v1),P.localCoordSystem.rotationAlignedToEdge.v2=v.get(P.localCoordSystem.rotationAlignedToEdge.v2)),P.localCoordSystem.scaleAttachedToEdge&&(P.localCoordSystem.scaleAttachedToEdge.v1=v.get(P.localCoordSystem.scaleAttachedToEdge.v1),P.localCoordSystem.scaleAttachedToEdge.v2=v.get(P.localCoordSystem.scaleAttachedToEdge.v2)),P.localCoordSystem.isCustom=!0}C.push(P),A.push(P.id)}}),b===e-1&&(l={vertices:M,edges:I,faces:A})}q.push(...S),X.push(...x),tt.push(...C),nt=l.vertices,at=l.edges,rt=l.faces}else if(it.length>0){it.forEach(y=>{const m=q.find(S=>S.id===y.id);m&&(m.x=y.x,m.y=y.y)});const p=new Set(ot.map(y=>y.id)),g=new Set;tt.forEach(y=>{y.vertexIds.some(m=>p.has(m))&&g.add(y)}),g.size>0&&g.forEach(y=>{const m=is.get(y.id);if(y.localCoordSystem&&m)if(vt&&!vt.directionalScale){const{center:S,rotation:x,scale:C,startPos:b}=vt,v={x:b.x-S.x,y:b.y-S.y},M=Jt(m.origin,S,x,C,!1,v);y.localCoordSystem.origin=M,y.localCoordSystem.angle=Ce(m.angle+x),y.localCoordSystem.scale=m.scale*C}else xc(y,m,ot,it,V)})}const c=_l/J.scale,d=new Map;q.forEach(p=>d.set(p.id,p.id));const f=new Set(ot.map(p=>p.id)),h=p=>{if(!d.has(p)||d.get(p)===p)return p;const g=h(d.get(p));return d.set(p,g),g};for(let p=0;p<q.length;p++)for(let g=p+1;g<q.length;g++){const y=q[p],m=q[g];if(y.type==="regular"&&m.type==="regular"&&G(y,m)<c){const S=h(y.id),x=h(m.id);if(S!==x){const C=f.has(S),b=f.has(x);C&&!b?d.set(S,x):d.set(x,S)}}}const r=new Set;if(q.forEach(p=>{const g=h(p.id);p.id!==g&&r.add(p.id)}),r.size>0){const p=JSON.parse(JSON.stringify(X)),g=Cc(tt,h);X.forEach(y=>{y.id1=h(y.id1),y.id2=h(y.id2)}),tt.forEach(y=>{const S=y.vertexIds.map(x=>h(x)).filter((x,C,b)=>b.indexOf(x)===C);S.length<3?y.vertexIds=[]:(y.vertexIds=S,y.id=Ct({vertexIds:S}))}),q=q.filter(y=>!r.has(y.id)),X=X.filter((y,m,S)=>y.id1!==y.id2&&m===S.findIndex(x=>lt(x)===lt(y))),tt=tt.filter(y=>y.vertexIds.length>=3),nt=Array.from(new Set(nt.map(y=>h(y)).filter(y=>!r.has(y)))),at=Array.from(new Set(at.map(y=>{const[m,S]=y.split(As),x=h(m),C=h(S);return x===C?null:lt({id1:x,id2:C})}).filter(Boolean))),rt=Array.from(new Set(rt.map(y=>{const m=tt.find(S=>S.id===y);return m?m.id:null}).filter(Boolean))),Zs(p,X),tt.forEach(y=>{const m=g.get(y.id);if(m){if(y.localCoordSystem=m,y.localCoordSystem.attachedToVertex){const S=h(y.localCoordSystem.attachedToVertex);y.localCoordSystem.attachedToVertex=S;const x=q.find(C=>C.id===S);x&&(y.localCoordSystem.origin.x=x.x,y.localCoordSystem.origin.y=x.y)}if(y.localCoordSystem.attachedToEdge){y.localCoordSystem.attachedToEdge.v1=h(y.localCoordSystem.attachedToEdge.v1),y.localCoordSystem.attachedToEdge.v2=h(y.localCoordSystem.attachedToEdge.v2);const S=q.find(C=>C.id===y.localCoordSystem.attachedToEdge.v1),x=q.find(C=>C.id===y.localCoordSystem.attachedToEdge.v2);if(S&&x){const C=y.localCoordSystem.attachedToEdge.t;y.localCoordSystem.origin.x=S.x+C*(x.x-S.x),y.localCoordSystem.origin.y=S.y+C*(x.y-S.y)}}y.localCoordSystem.rotationAlignedToEdge&&(y.localCoordSystem.rotationAlignedToEdge.v1=h(y.localCoordSystem.rotationAlignedToEdge.v1),y.localCoordSystem.rotationAlignedToEdge.v2=h(y.localCoordSystem.rotationAlignedToEdge.v2)),y.localCoordSystem.scaleAttachedToEdge&&(y.localCoordSystem.scaleAttachedToEdge.v1=h(y.localCoordSystem.scaleAttachedToEdge.v1),y.localCoordSystem.scaleAttachedToEdge.v2=h(y.localCoordSystem.scaleAttachedToEdge.v2))}}),ys()}const u=new Set;e>1&&l?l.vertices.forEach(p=>u.add(p)):it.length>0&&it.forEach(p=>u.add(p.id)),r.size>0&&nt.forEach(p=>u.add(p)),u.size>0&&uc(Array.from(u),vt),is.clear()}else if(W.target!=="ui-icon"){const l=V(Nt);if(Yt&&l){Tt();const c=JSON.parse(JSON.stringify(X)),d=js(l,$,s);let f=null;if(d.snapType==="vertex"&&d.targetVertex)f=d.targetVertex;else if(d.snapType==="edge"&&d.targetEdge)f=ea(d.targetEdge,{x:d.x,y:d.y});else{let h=bt(mt);const r=st[mt];if(r!==-1){const u=K[r];u&&u.type==="colormap"&&(h=ne(u,.5))}f={id:ns(),x:d.x,y:d.y,type:"regular",color:h},q.push(f)}if(f){if(!X.some(u=>u.id1===l.id&&u.id2===f.id||u.id2===l.id&&u.id1===f.id)){const u=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1,p=_n(l,f,u,bt);X.push(p),Zs(c,X),tt.forEach(g=>{g.color||(g.color=bt(Dt))})}const r=Ti(l,f,X);r&&(kt.length>0&&(kt[kt.length-1].turn=r.turnAngleRad),kt.push({length:r.length,turn:0,endVertexColor:f.color}),ce=kt.length-1),ft.push(f.id),window.currentDrawingPath=ft,oa(),ia(),Nt=f.id}if(s&&f&&d){const h=Ti(l,f,X);h&&(Re=h.startVertex,d.gridToGridSquaredSum>0&&d.gridInterval?Ot=d.gridInterval*Math.sqrt(d.gridToGridSquaredSum):Ot=h.length,Ue=d.gridToGridSquaredSum>0?{g2gSquaredSum:d.gridToGridSquaredSum,interval:d.gridInterval}:null,Zt=h.turnAngleRad,ze=h.precedingSegmentAbsoluteAngleRad)}else Ot=null,Ue=null,Zt=null,ze=null,Re=null;U.count=0}else if(W.target==="canvas"){Tt();const c=ht||yt($);let d=bt(mt);const f=st[mt];if(f!==-1){const r=K[f];r&&r.type==="colormap"&&(d=ne(r,0))}const h={id:ns(),...c,type:"regular",color:d};q.push(h),Yt=!0,Nt=h.id,kt=[],ce=0,ft=[h.id],window.currentDrawingPath=ft}else if(i||o||a){Tt();const c=a?Ct(a):o?lt(o):i.id;let d;switch(a?d="face":i&&i.type!=="regular"?d="center":i?d="vertex":o&&(d="edge"),c&&U.targetId===c&&Date.now()-U.timestamp<cn?U.count++:U.count=1,U.targetId=c,U.type=d,U.timestamp=Date.now(),U.count){case 1:U.type==="face"?ee([],[],[U.targetId],s,n):U.type==="edge"?ee([],[U.targetId],[],s,n):U.type==="vertex"?ee([U.targetId],[],[],s,n):U.type==="center"&&Xo(U.targetId,s,n);break;case 2:if(U.type==="vertex"){const h=Ae(U.targetId,X);ee([U.targetId,...h],[],[],s,n)}else if(U.type==="edge"){const h=X.find(r=>lt(r)===U.targetId);if(h){const r=[...Eo(h.id1),...Eo(h.id2)];ee([],Array.from(new Set(r.map(u=>lt(u)))),[],s,n)}}else if(U.type==="face"){const h=tt.find(r=>Ct(r)===U.targetId);if(h){const r=[],u=new Set;for(let p=0;p<h.vertexIds.length;p++){const g=h.vertexIds[p],y=h.vertexIds[(p+1)%h.vertexIds.length];u.add(lt({id1:g,id2:y}))}tt.forEach(p=>{if(Ct(p)!==Ct(h))for(let g=0;g<p.vertexIds.length;g++){const y=p.vertexIds[g],m=p.vertexIds[(g+1)%p.vertexIds.length];if(u.has(lt({id1:y,id2:m}))){r.push(Ct(p));break}}}),ee([],[],[Ct(h),...r],s,n)}}break;case 3:if(U.type==="vertex"||U.type==="edge"||U.type==="face"){let h;if(U.type==="vertex")h=U.targetId;else if(U.type==="edge")h=U.targetId.split(As)[0];else if(U.type==="face"){const r=tt.find(u=>Ct(u)===U.targetId);r&&(h=r.vertexIds[0])}if(h){const r=new Set(Qi(h));if(U.type==="vertex")ee(Array.from(r),[],[],s,n);else if(U.type==="edge"){const u=X.filter(p=>r.has(p.id1)&&r.has(p.id2)).map(p=>lt(p));ee([],u,[],s,n)}else if(U.type==="face"){const u=tt.filter(p=>p.vertexIds.every(g=>r.has(g))).map(p=>Ct(p));ee([],[],u,s,n)}}}U.count=0;break}const f=[];rt.length>0&&f.push(Dt),at.length>0&&f.push(wt),nt.length>0&&f.push(mt),f.length>0&&(It=f)}}Xt=!1,xt=!1,ps=!1,Ke=!1,W=null,vt=null,et.style.cursor="crosshair",ut||(ht=null)}function uc(t,e){if(t.length===0||e&&e.transformType===be||!e)return;const i=new Set;t.forEach(a=>{Eo(a).forEach(l=>i.add(l))});const o=H.alpha2>H.alpha1&&H.interval2?H.interval2:H.interval1;i.forEach(a=>{const l=V(a.id1),c=V(a.id2);if(!l||!c)return;const d=l.x-c.x,f=l.y-c.y,h=d/o,r=f/o,u=1e-5;if(o&&Math.abs(h-Math.round(h))<u&&Math.abs(r-Math.round(r))<u){a.labelMode="exact";const g=Math.round(h),y=Math.round(r);a.exactValue={g2gSquaredSum:g*g+y*y,gridInterval:o}}else a.labelMode="decimal",delete a.exactValue})}function pc(t){Xt=!0,Ke=!1,Ui=he,W={target:"canvas"}}function gc(t){if(xt&&Ke){const e=yt({x:Math.min(he.x,$.x),y:Math.min(he.y,$.y)}),s=yt({x:Math.max(he.x,$.x),y:Math.max(he.y,$.y)}),n=Math.min(e.x,s.x),i=Math.max(e.x,s.x),o=Math.min(e.y,s.y),a=Math.max(e.y,s.y),l=q.filter(r=>r.type==="regular"&&r.x>=n&&r.x<=i&&r.y>=o&&r.y<=a).map(r=>r.id),c=X.filter(r=>l.includes(r.id1)&&l.includes(r.id2)).map(r=>lt(r)),d=new Set(l),f=tt.filter(r=>r.vertexIds.every(u=>d.has(u))).map(r=>Ct(r));ee(l,c,f,W.shiftKey,W.ctrlKey);const h=[];f.length>0&&h.push(Dt),c.length>0&&h.push(wt),l.length>0&&h.push(mt),h.length>0&&(It=h,Qt&&Vt())}else qe(),et.style.cursor="crosshair"}function yc(t){zt.style.display==="block"&&(zt.style.display="none");const e=t.target;if(e&&e.closest(".katex")){t.stopPropagation();return}if((Yt||ue)&&t.button===2){qe(),t.preventDefault();return}$=Os(t,et),he={...$},we=t.button,we===0?hc(t):we===2&&pc()}function mc(t){we===0?fc():we===2&&gc(),Xt=!1,xt=!1,ps=!1,Ke=!1,W=null,vt=null,ue||(et.style.cursor="crosshair"),ut||(ht=null)}function Sc(){if(Pe){const e=$n(X,V).find(s=>s.id===Pe);e&&(Tt(),tt.some(s=>s.id===e.id)||(e.color=bt(Dt),tt.push(e),ls.delete(e.id),ys())),Pe=null}zt.style.display="none"}function xc(t,e,s,n,i){if(!e.isCustom){const d=t.vertexIds.map(f=>n.find(h=>h.id===f)||i(f)).filter(f=>f&&f.type==="regular");if(d.length>=3){const f=en(d);f&&(t.localCoordSystem.origin=f.center,t.localCoordSystem.scale=f.radius)}return}let o={...e.origin},a=e.angle,l=e.scale;if(t.localCoordSystem.attachedToVertex){const d=n.find(f=>f.id===t.localCoordSystem.attachedToVertex);d&&(o={x:d.x,y:d.y})}else if(t.localCoordSystem.attachedToEdge){const d=n.find(h=>h.id===t.localCoordSystem.attachedToEdge.v1)||i(t.localCoordSystem.attachedToEdge.v1),f=n.find(h=>h.id===t.localCoordSystem.attachedToEdge.v2)||i(t.localCoordSystem.attachedToEdge.v2);d&&f&&(o={x:d.x+t.localCoordSystem.attachedToEdge.t*(f.x-d.x),y:d.y+t.localCoordSystem.attachedToEdge.t*(f.y-d.y)})}if(t.localCoordSystem.rotationAlignedToEdge){const d=n.find(h=>h.id===t.localCoordSystem.rotationAlignedToEdge.v1)||i(t.localCoordSystem.rotationAlignedToEdge.v1),f=n.find(h=>h.id===t.localCoordSystem.rotationAlignedToEdge.v2)||i(t.localCoordSystem.rotationAlignedToEdge.v2);if(d&&f){const h=Math.atan2(f.y-d.y,f.x-d.x),r=t.localCoordSystem.rotationAlignedToEdge.originalAngle,p=t.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-r;a=Ce(h+p),t.localCoordSystem.rotationAlignedToEdge.originalAngle=h,t.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(t.localCoordSystem.scaleAttachedToEdge){const d=n.find(h=>h.id===t.localCoordSystem.scaleAttachedToEdge.v1)||i(t.localCoordSystem.scaleAttachedToEdge.v1),f=n.find(h=>h.id===t.localCoordSystem.scaleAttachedToEdge.v2)||i(t.localCoordSystem.scaleAttachedToEdge.v2);if(d&&f){const h=G(d,f);l=h*t.localCoordSystem.scaleAttachedToEdge.scaleRatio,t.localCoordSystem.scaleAttachedToEdge.originalLength=h}}const c=t.vertexIds.map(d=>n.find(f=>f.id===d)||i(d)).filter(d=>d&&d.type==="regular");c.length>=3&&(t.localCoordSystem.origin=Ds(o,c),t.localCoordSystem.angle=a,t.localCoordSystem.scale=Math.max(.01,l),t.localCoordSystem.isCustom=!0)}function Cc(t,e){const s=new Map;return t.forEach(n=>{const i=[...new Set(n.vertexIds.map(o=>e(o)))];if(i.length>=3){const o=Ct({vertexIds:i});if(n.localCoordSystem&&n.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(n.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=e(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=e(a.attachedToEdge.v1),a.attachedToEdge.v2=e(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=e(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=e(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=e(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=e(a.scaleAttachedToEdge.v2)),s.set(o,a)}}}),s}function bc(t){if(t.key==="Shift"&&(ut=!1,ht=null,us=null,Xe=[],gs&&oe&&oe.type==="center")){const e=yt($),s=oe.face,n=s.localCoordSystem,i=s.vertexIds.map(a=>V(a)).filter(a=>a&&a.type==="regular"),o=Ds(e,i);n.origin.x=o.x,n.origin.y=o.y,n.isCustom=!0}}function Mc(t){t.preventDefault(),zt.innerHTML="",zt.style.display="none",$=Os(t,et);const e=yt($);let s=[];Pe=null,Vs=null,$s=null;const n=Ys($),i=n?null:Xs($),o=!n&&!i?Js($):null;if(n&&n.type==="regular")$s=n.id,s.push({text:"Remove Vertex",handler:vc});else if(i)Vs=lt(i),s.push({text:"Remove Edge",handler:Ic});else if(o)Pe=Ct(o),s.push({text:"Remove Face",handler:Tc});else{const a=$n(X,V),l=new Set(tt.map(h=>h.id)),c=a.filter(h=>!l.has(h.id));let d=null,f=1/0;c.forEach(h=>{const r=h.vertexIds.map(u=>V(u));if(r.every(Boolean)&&ws(e,r)){const u=Math.abs(Xl(r));u<f&&(f=u,d=h)}}),d&&(Pe=d.id,s.push({text:"Add Face",handler:Sc}))}if(s.length>0){const a=document.createElement("ul");s.forEach(l=>{const c=document.createElement("li");c.textContent=l.text,c.addEventListener("click",l.handler),a.appendChild(c)}),zt.appendChild(a),zt.style.left=`${t.clientX-Uo}px`,zt.style.top=`${t.clientY-Uo}px`,zt.style.display="block"}}function vc(){$s&&(Tt(),at=[],rt=[],Rt=[],nt=[$s],sn(),$s=null),zt.style.display="none"}function Ic(){Vs&&(Tt(),nt=[],rt=[],Rt=[],at=[Vs],sn(),Vs=null),zt.style.display="none"}function Tc(){Pe&&(Tt(),nt=[],at=[],Rt=[],rt=[Pe],sn(),Pe=null),zt.style.display="none"}et.addEventListener("wheel",t=>{t.preventDefault();const e=Os(t,et),s=t.deltaY>0?1/1.15:1.15;_o(e,s)},{passive:!1});et.addEventListener("mouseenter",()=>{Us=!0});et.addEventListener("mouseleave",()=>{Us=!1,na()});et.addEventListener("contextmenu",t=>t.preventDefault());et.addEventListener("mousemove",dc);et.addEventListener("mouseup",mc);et.addEventListener("mousedown",yc);window.addEventListener("keyup",bc);window.addEventListener("keydown",lc);window.addEventListener("resize",Zi);window.addEventListener("load",()=>{Kr()});

(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const aa="#3b82f6",ra="#4a5568",la="#718096",Bc=300,ca="#242c3a",Gs=2,Or=3,Me=9,da=12,$c=5,Nr=8,je=8,Fr=.9,Br=5,Zo=[4,4],Vc={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},Xc={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class Yc{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=Vc,this.namedColormaps=Xc,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,s=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,o=1;if(s&&s.type==="colormap"&&(s.points||s.controlPoints)){this.state.isCyclic=s.isCyclic===!0;let a=JSON.parse(JSON.stringify(s.controlPoints||s.points));if(a.length===1){a[0].pos=.5;const r=a[0].color,c=r[0]/255,l=r[1]/255,d=r[2]/255;i=(c+l+d)/3,o=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(r=>{const c=r.color,l=r.alpha!==void 0?r.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,l,r.pos,r.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=o,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async s=>{const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch preset file at ${s}: Status ${i.status}`);return await i.json()},n=s=>{try{const i=localStorage.getItem(s);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:s}=t.dataset;if(s==="named_colors"||s==="custom_colors"){let i;if(s==="named_colors"?i=this.namedColors[n]:i=this.customColors[n]?.rgb,!i){console.error(`RGB undefined for ${n} in ${s}`);return}this.applyColorToSelection(i)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const i=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(i==="Cancel"||i==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,s)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,s=t[1]/255,i=t[2]/255;if(this.state.selectedPointIds.size===0){const o=this.state.points.length;o>0&&this.state.points.forEach(c=>{c.pos=c.pos*(o/(o+1))});const a=o===0?.5:1,r=this.createPointFromRgb(n,s,i,1,a,1);this.state.points.push(r),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const r=this.convertRgbToCurrentColorspace(n,s,i);a.hsPos=r.hsPos,a.originalHsPos={...r.hsPos},a.lightness=r.lightness}});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}loadColormap(t,n,s=!1){s||this.saveState();const i=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!i||!i.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const o=i.points.map(a=>{let r=[0,0,0];typeof a.color=="string"?r=this.namedColors[a.color]||this.customColors[a.color]?.rgb||r:Array.isArray(a.color)&&(r=a.color);const c=r[0]/255,l=r[1]/255,d=r[2]/255,h=a.alpha??1;return this.createPointFromRgb(c,l,d,h,a.pos,a.order)});this.state.points=o,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=($,D={})=>{const k=document.createElement($);if(D.id){k.id=D.id;const V=D.id.replace(/-(\w)/g,(G,X)=>X.toUpperCase());this.elements[V]=k}return D.className&&(k.className=D.className),D.text&&(k.textContent=D.text),D.type&&(k.type=D.type),D.placeholder&&(k.placeholder=D.placeholder),k};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),s=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const o=t("div",{id:"selected-color-section",className:"control-section"}),a=t("div",{id:"current-colormap-section",className:"control-section"}),r=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),r.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(r,c);const d=t("h2",{className:"panel-header",text:"Lightness"}),h=t("div",{id:"lightness-slider-container",className:"canvas-container"}),f=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});h.append(t("canvas",{id:"lightness-bg-canvas"}),f),s.append(d,h);const u=t("h2",{className:"panel-header",text:"Alpha"}),p=t("div",{id:"alpha-slider-container",className:"canvas-container"}),g=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});p.append(t("canvas",{id:"alpha-bg-canvas"}),g),i.append(u,p);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const m=t("div",{className:"preset-category-header"});m.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(m,t("div",{className:"preset-items-container"}));const x=t("h3",{className:"section-title",text:"Selected Color"}),S=t("div",{className:"preview-container"});S.append(t("canvas",{id:"selected-color-preview-canvas"}));const I=t("div",{className:"space-y-2"}),b=t("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const v=t("div");v.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const E=t("div");E.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const C=t("div");C.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),b.append(v,E,C),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const _=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),P=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),M=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(_,P,M),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const w=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),O=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(w,O);const T=t("h3",{className:"input-label",text:"Interpolation"});T.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const A=t("div",{className:"interpolation-grid"});A.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),A.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),I.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,T,A),o.append(x,S,I);const L=t("h3",{className:"section-title text-center",text:"Current Colormap"}),B=t("div",{className:"preview-container"});B.append(t("canvas",{id:"colormap-preview-canvas"}));const F=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const R=t("div",{className:"button-row"});R.append(this.elements.reverseButton,this.elements.cycleButton),F.append(R,this.elements.closeButton,this.elements.selectButton),a.append(L,B,F),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const N=t("div",{id:"modal-dialog",className:"modal-dialog"});N.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),N.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(N),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,s,this.elements.colorsPresetsWrapper,o,i,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(f,"lightness"),this.createInteractiveCanvas(g,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const s=i=>{const o=i.target.closest(".preset-item");o&&(i.type==="click"?this.handlePresetClick(o):i.type==="contextmenu"&&o.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,o.dataset.name,o.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",s),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",s),this.elements.colormapsPresetsWrapper.addEventListener("click",s),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",s),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const o=this.state.points,a=o.length,r=(u,p)=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(g);return{pos:parseFloat((p!==void 0?p:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let p=0;p<u;p++){const g=o[p],y=o[(p+1)%a];i.push(r(g));const m=Math.max(g.order,y.order);if(m===0){let x=g.pos,S=y.pos;this.state.isCyclic&&S<x&&(S+=1);const I=x+(S-x)*.5;i.push(r(g,this.wrapPositionCyclic(I-1e-6))),i.push(r(y,this.wrapPositionCyclic(I)))}else if(m===3){const S=g.pos;let I=y.pos;this.state.isCyclic&&I<S&&(I+=1);const b=I-S;for(let v=1;v<16;v++){const E=v/16,C=S+E*b,_=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(C));if(_){const P=this.abstractToRgb(_.u,_.v,_.lightness),M=this.clampColor(P);i.push({pos:parseFloat(this.wrapPositionCyclic(C).toFixed(6)),alpha:parseFloat(_.alpha.toFixed(4)),color:[M.r,M.g,M.b],order:_.order})}}}}this.state.isCyclic||i.push(r(o[a-1]))}const c=new Map;i.forEach(u=>c.set(u.pos,u));let l=Array.from(c.values()).sort((u,p)=>u.pos-p.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const d=this.state.points.map(u=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),g=this.clampColor(p);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[g.r,g.g,g.b],order:u.order}}),h={points:l,controlPoints:d,isCyclic:this.state.isCyclic},f=new CustomEvent("select",{detail:h,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(f)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,s){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const o={Rename:()=>this.handlePresetAction("rename",n,s),Delete:()=>this.handlePresetAction("delete",n,s)};for(const[a,r]of Object.entries(o)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=r,i.appendChild(c)}i.style.left=`${t.clientX}px`,i.style.top=`${t.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,s){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(s==="custom_colors"&&delete this.customColors[n],s==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(s),this.populatePresets());else if(t==="rename"){const i=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(i&&i!==n){const o=s==="custom_colors"?this.customColors:this.customColormaps;if(o[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}o[i]=o[n],delete o[n],this.saveCustomPresets(s),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const s=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!s)return!1;if(t==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const o=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),a=this.clampColor(o);this.customColors[s]={rgb:[a.r,a.g,a.b],alpha:i.alpha}}else{const i=this.state.points.map(o=>{const a=this.abstractToRgb(o.hsPos.u,o.hsPos.v,o.lightness),r=this.clampColor(a);return{pos:o.pos,alpha:o.alpha,color:[r.r,r.g,r.b],order:o.order}});this.customColormaps[s]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=s,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(o,a)=>{const r=document.createElement("div");r.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=o;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=a,r.appendChild(c),r.appendChild(l),r},n=(o,a,r,c)=>{Object.keys(a).sort().forEach(l=>{const d=document.createElement("div");d.className="preset-item",d.dataset.name=l,d.dataset.type=r,d.dataset.custom=c;const h=document.createElement("canvas");h.className="preset-icon",r.includes("colormap")?(h.width=64,h.height=16):(h.width=16,h.height=16);const f=document.createElement("span");if(f.textContent=l,d.appendChild(h),d.appendChild(f),o.appendChild(d),r==="named_colors"||r==="custom_colors"){const u=a[l],p=c?u.rgb:u;this.drawColorIcon(h,p)}else this.drawColormapIcon(h,a[l].points,this.namedColors,this.customColors)})},s=document.createElement("div");s.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(s),n(s,this.namedColors,"named_colors",!1),n(s,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),n(i,this.namedColormaps,"named_colormaps",!1),n(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,s,i){const o=n.map(d=>{let h=[0,0,0];typeof d.color=="string"?h=s[d.color]||(i[d.color]?i[d.color].rgb:[0,0,0]):Array.isArray(d.color)&&(h=d.color);const{hsPos:f,lightness:u}=this.convertRgbToCurrentColorspace(h[0]/255,h[1]/255,h[2]/255);return{id:Math.random(),hsPos:f,originalHsPos:{...f},lightness:u,alpha:d.alpha??1,pos:d.pos,order:1}}).sort((d,h)=>d.pos-h.pos),a=this.state.points;this.state.points=o;const r=t.getContext("2d"),{width:c,height:l}=t;if(this.drawCheckerboard(r),this.state.points.length>0)for(let d=0;d<c;d++){const h=d/(c-1),f=this.getInterpolatedPropertiesAt(h);if(!f)continue;const u=this.clampAbstractPoint(f.u,f.v,f.lightness),p=this.abstractToRgb(u.u,u.v,f.lightness),{r:g,g:y,b:m}=this.clampColor(p);r.fillStyle=`rgba(${g}, ${y}, ${m}, ${f.alpha})`,r.fillRect(d,0,1,l)}this.state.points=a}showPrompt(t,n,s=null){return new Promise(i=>{const{modalOverlay:o,modalTitle:a,modalInputContainer:r,modalInput:c,modalButtons:l}=this.elements,d=document.querySelectorAll("[data-tick-canvas]");d.forEach(h=>h.style.display="none"),a.textContent=t,l.innerHTML="",s?(c.value=s.value||"",c.placeholder=s.placeholder||"",r.classList.remove("hidden")):r.classList.add("hidden"),n.forEach(h=>{const f=document.createElement("button");f.className=`modal-button ${h==="Save"||h==="Delete"||h==="Rename"?"modal-button-primary":"modal-button-secondary"}`,f.textContent=h,f.onclick=()=>{o.classList.add("hidden"),d.forEach(u=>u.style.display=""),i(s?c.value:h)},l.appendChild(f)}),o.classList.remove("hidden"),s&&c.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(s=>s.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(s=>Math.abs(s.pos)<1e-6),n=this.state.points.some(s=>Math.abs(s.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(o=>({id:o.id,pos:o.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(o=>{o.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const s=t.getContext("2d");s.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,s.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,s,i,o,a){const{hsPos:r,lightness:c}=this.convertRgbToCurrentColorspace(t,n,s);return{id:Date.now()+Math.random(),hsPos:r,originalHsPos:{...r},lightness:c,alpha:i,pos:o,order:a}}convertRgbToCurrentColorspace(t,n,s){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),lightness:(t+n+s)/3};{const i=this.rgbToHsl(t,n,s);return{hsPos:this.rgbToHslDiConeAbstract(t,n,s),lightness:i.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:d,clientHeight:h}=l.container;(l.c.width!==d||l.c.height!==h)&&(l.c.width=d,l.c.height=h)});const i=this.elements.hsBgCanvas,o=this.elements.interactiveCanvases.hs,a=i.parentElement,r=a.clientWidth,c=a.clientHeight;[i,o].forEach(l=>{l&&(l.width=r,l.height=c,l.style.width=`${r}px`,l.style.height=`${c}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(i=>{let o;n==="RGB_CUBE"?o=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):o=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let a,r;if(t==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(o),r=(o.r+o.g+o.b)/3;else{const c=this.rgbToHsl(o.r,o.g,o.b);a=this.rgbToHslDiConeAbstract(o.r,o.g,o.b),r=c.l}i.hsPos=a,i.originalHsPos={...a},i.lightness=r});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const s=Date.now(),i=this.elements.interactiveCanvases[n];if(!i)return;const o=i.getBoundingClientRect(),a=i.width/o.width,r=i.height/o.height,c=(t.clientX-o.left)*a,l=(t.clientY-o.top)*r,d={x:c,y:l};let h=!1,f=null,u=!1;if(n==="hs")f=this.findHitPointHS(c,l);else{const m=this.findHitPointSlider(c,l,n);f=m.hitPoint,u=m.hitLine}if(s-this.lastClickTime<Bc&&f&&f.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=s,this.lastClickTarget=f?f.id:null,f){this.state.viewLightness=f.lightness,this.state.viewAlpha=f.alpha;const m=t.ctrlKey||t.metaKey,x=t.shiftKey;!this.state.selectedPointIds.has(f.id)&&!m&&!x&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(f.id),this.state.lastSelectedPointId=f.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=i,this.state.activeDrag.pointId=f?f.id:null,f){const m=new Map;if(n==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:x,offsetX:S,offsetY:I}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const v=b.hsPos.u*x+S,E=b.hsPos.v*x+I;this.state.activeDrag.initialPointPositions.set(b.id,{x:v,y:E})}})}else this.state.points.forEach(x=>{this.state.selectedPointIds.has(x.id)&&m.set(x.id,{lightness:x.lightness-f.lightness,alpha:x.alpha-f.alpha,pos:x.pos-f.pos})}),this.state.activeDrag.offsets=m}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const g=m=>{const x=(m.clientX-o.left)*a,S=(m.clientY-o.top)*r,I=Math.sqrt((x-d.x)**2+(S-d.y)**2);!h&&I>$c&&(h=!0,f&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(m)},y=m=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y),h||this.handleClick(c,l,n,f,m),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",g),document.addEventListener("mouseup",y)}handleClick(t,n,s,i,o){const{shiftKey:a,ctrlKey:r,metaKey:c}=o,l=r||c;if(i){const{selectedPointIds:d}=this.state,h=i.id;if(this.clickCount===3)this.state.points.forEach(f=>d.add(f.id)),this.state.lastSelectedPointId=h;else if(this.clickCount===2){const f=this.state.points.findIndex(p=>p.id===h);d.clear(),[f-1,f,f+1].forEach(p=>{p>=0&&p<this.state.points.length&&d.add(this.state.points[p].id)}),this.state.lastSelectedPointId=h}else l?d.has(h)?(d.delete(h),this.state.lastSelectedPointId===h&&(this.state.lastSelectedPointId=d.size>0?Array.from(d)[0]:null)):(d.add(h),this.state.lastSelectedPointId=h):a?(d.add(h),this.state.lastSelectedPointId=h):(d.clear(),d.add(h),this.state.lastSelectedPointId=h)}else if(s==="hs")this.createNewPointHS(t,n);else if(s==="lightness"||s==="alpha"){const d=this.elements.interactiveCanvases[s],h=Math.ceil(Me*2.2),f=d.height-2*h,p=(d.height-h-n)/f,g=Math.max(0,Math.min(1,p));s==="lightness"?this.state.viewLightness=g:this.state.viewAlpha=g}this.drawAll()}findHitPointHS(t,n){const s=Math.ceil(Me*2.2),i=Math.ceil(je/2),o=s+i,a=o,r=o,c=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;for(const d of this.state.points){const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-Me&&h<=a+c+Me&&f>=r-Me&&f<=r+l+Me&&Math.sqrt((t-h)**2+(n-f)**2)<=da)return d}return null}handleInputChange(t,n){const s=t.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(n==="lightness"||n==="alpha"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[n]=o,n==="lightness"&&this.constrainPointToValidArea(a))}),i=!0)}else if(n==="position"){const o=parseFloat(s);!isNaN(o)&&o>=0&&o<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=o)}),this.sortPoints(),i=!0)}if(i){const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,s,i,o,a,r=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),s=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(s))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,s=Math.max(0,Math.min(255,s))/255;const c=this.rgbCubeRgbToAbstract({r:t,g:n,b:s}),l=(t+n+s)/3;this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...c},d.originalHsPos={...c},d.lightness=l)}),r=!0}else{if(i=parseFloat(this.elements.hslHInput.value),o=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(i)||isNaN(o))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),o=Math.max(0,Math.min(1,o));const c=this.hslToRgb(i,o,a),l=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...l},d.originalHsPos={...l})}),r=!0}if(r){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const s=document.createElement("canvas");s.className=`interactive-canvas ${n}-interactive`,s.dataset.type=n,t.appendChild(s),this.elements.interactiveCanvases[n]=s}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:s,pointId:i}=this.state.activeDrag,o=s,a=o.getBoundingClientRect(),r=o.width/a.width,c=o.height/a.height,l=(t.clientX-a.left)*r,d=(t.clientY-a.top)*c;n.endsWith("-line")?this.handleLineDrag(d,o.height,n):i&&this.handlePointDrag(l,d,o,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),s=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:s}}rgbToHslDiConeAbstract(t,n,s){const i=this.rgbToHsl(t,n,s),o=1-Math.abs(2*i.l-1),a=i.s*o,r=i.h*2*Math.PI,c=a*Math.cos(r),l=a*Math.sin(r);return{u:c,v:l}}hslDiConeAbstractToRgb(t,n,s){const i=(Math.atan2(n,t)/(2*Math.PI)+1)%1,o=Math.sqrt(t*t+n*n),a=s,r=1-Math.abs(2*a-1);if(r<1e-9)return{r:a,g:a,b:a};const c=o/r;return this.hslToRgb(i,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,s=n&&n.tagName==="INPUT",i=t.ctrlKey||t.metaKey;if(i&&t.key==="z"){t.preventDefault(),this.undo();return}if(i&&t.key==="y"){t.preventDefault(),this.redo();return}if(s){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(i&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(o=>this.state.selectedPointIds.add(o.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(o=>!this.state.selectedPointIds.has(o.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,s,i=null){let o=t,a=Br+1;const r=Math.ceil(Me*2.2),c=Math.ceil(je/2),l=r+c,d=n-l-r,h=n-r;return this.state.points.forEach(f=>{if(f.id===i)return;const u=h-f[s]*d,p=Math.abs(t-u);p<Br&&p<a&&(o=u,a=p)}),o}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:s}=this.state,i=this.elements.hsBgCanvas.width,o=this.elements.hsBgCanvas.height;if(i===0||o===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=ca,a.fillRect(0,0,i,o);const r=Math.ceil(Me*2.2),c=Math.ceil(je/2),l=r+c,d=i-l-r,h=o-l-r;if(d<=0||h<=0)return;const f=s==="RGB_CUBE"?Math.min(d,h)/(Math.sqrt(2/3)*2)*Fr:Math.min(d,h)/2*Fr;this.state.transform.scale=f,this.state.transform.offsetX=i/2,this.state.transform.offsetY=o/2;const u=l,p=l,g=d,y=h,m=je,x=Math.round(g/m),S=Math.round(y/m),I=g/x,b=y/S;for(let P=0;P<S;P++)for(let M=0;M<x;M++){const w=u+M*I,O=p+P*b;(P+M)%2===0?a.fillStyle=la:a.fillStyle=ra,a.fillRect(w,O,I,b)}if(s==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const M=i/2,w=o/2,O=t<.5?0:255;a.fillStyle=`rgba(${O}, ${O}, ${O}, ${n})`,a.fillRect(Math.floor(M),Math.floor(w),1,1);return}const v=a.createImageData(g,y),E=v.data;for(let P=0;P<y;P++)for(let M=0;M<g;M++){const w=u+M,O=p+P,T=(w-this.state.transform.offsetX)/this.state.transform.scale,A=(O-this.state.transform.offsetY)/this.state.transform.scale,{r:L,g:B,b:F}=this.abstractToRgb(T,A,t),R=(P*g+M)*4;this.isValidColor(L,B,F)&&(E[R]=Math.round(L*255),E[R+1]=Math.round(B*255),E[R+2]=Math.round(F*255),E[R+3]=255)}const C=document.createElement("canvas");C.width=g,C.height=y,C.getContext("2d").putImageData(v,0,0),a.globalAlpha=n,a.drawImage(C,u,p),a.globalAlpha=1}evaluateCubicSpline(t,n){const s=this.state.points,i=s.length;if(t<0||t>=i)return null;let o,a,r,c;if(this.state.isCyclic){const u=p=>{const g=(p%i+i)%i;return s[g]};t===i-1?(o=u(t-1),a=u(t),r=u(0),c=u(1)):(o=u(t-1),a=u(t),r=u(t+1),c=u(t+2))}else a=s[t],r=s[t+1],o=t>0?s[t-1]:s[t],c=t+2<i?s[t+2]:s[t+1];const l=n,d=l*l,h=d*l,f=(u,p,g,y)=>.5*(2*p+(-u+g)*l+(2*u-5*p+4*g-y)*d+(-u+3*p-3*g+y)*h);return{u:f(o.hsPos.u,a.hsPos.u,r.hsPos.u,c.hsPos.u),v:f(o.hsPos.v,a.hsPos.v,r.hsPos.v,c.hsPos.v),lightness:f(o.lightness,a.lightness,r.lightness,c.lightness),alpha:f(o.alpha,a.alpha,r.alpha,c.alpha),order:2}}isValidColor(t,n,s){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&s>=-.001&&s<=1.001}drawSliderBackgrounds(){const t=Math.ceil(Me*2.2),n=Math.ceil(je/2),s=t+n,i=this.elements.lightnessBgCanvas.getContext("2d"),o=this.elements.lightnessBgCanvas;i.fillStyle=ca,i.fillRect(0,0,o.width,o.height);const a=s,r=o.width-t,c=s,l=o.height-t,d=r-a,h=l-c;if(h>0&&d>0){const I=i.createLinearGradient(0,c,0,l);I.addColorStop(0,"white"),I.addColorStop(1,"black"),i.fillStyle=I,i.fillRect(a,c,d,h)}const f=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;f.fillStyle=ca,f.fillRect(0,0,u.width,u.height);const p=s,g=u.width-t,y=s,m=u.height-t,x=g-p,S=m-y;if(S>0&&x>0){const I=je,b=Math.round(x/I),v=Math.ceil(S/I),E=x/b,C=I,_=m-v*C;for(let M=0;M<v;M++)for(let w=0;w<b;w++){const O=p+w*E,T=_+M*C;if(T<m&&T+C>y){(M+w)%2===0?f.fillStyle=la:f.fillStyle=ra;const A=Math.max(T,y),L=Math.min(T+C,m)-A;L>0&&f.fillRect(O,A,E,L)}}const P=f.createLinearGradient(0,y,0,m);P.addColorStop(0,"white"),P.addColorStop(1,"rgba(255,255,255,0)"),f.fillStyle=P,f.fillRect(p,y,x,S)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=aa,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Me*2.2),i=Math.ceil(je/2),o=s+i,a=o,r=o,c=t.width-o-s,l=t.height-o-s;if(this.state.points.length>1){const d=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let h=0;h<d;h++){const f=this.state.points[h],u=this.state.points[(h+1)%this.state.points.length];if(Math.max(f.order,u.order)===0)continue;let g=f.pos,y=u.pos;this.state.isCyclic&&y<g&&(y+=1);const m=y-g;if(m<1e-9)continue;const x=Math.max(10,Math.ceil(m*100)),S=[];for(let b=0;b<=x;b++){const v=g+b/x*m,E=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(v));if(!E)continue;const C=this.clampAbstractPoint(E.u,E.v,E.lightness),_=C.u*this.state.transform.scale+this.state.transform.offsetX,P=C.v*this.state.transform.scale+this.state.transform.offsetY;S.push({x:_,y:P,isOnPlane:Math.abs(E.lightness-this.state.viewLightness)<1e-10})}if(S.length<2)continue;const I=S.every(b=>b.isOnPlane);n.strokeStyle="black",n.lineWidth=Gs,n.globalAlpha=I?.7:.4,n.setLineDash(I?[]:Zo),n.beginPath(),n.moveTo(S[0].x,S[0].y);for(let b=1;b<S.length;b++)n.lineTo(S[b].x,S[b].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(a,r,c,l),n.clip(),this.state.points.forEach(d=>{const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-Me&&h<=a+c+Me&&f>=r-Me&&f<=r+l+Me){const u=this.abstractToRgb(d.hsPos.u,d.hsPos.v,d.lightness),{r:p,g,b:y}=this.clampColor(u),m=this.state.selectedPointIds.has(d.id),x=d.id===this.state.lastSelectedPointId,S=Math.abs(d.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),d.order){case 0:this._drawCircle(n,h,f,Me);break;case 1:this._drawDroplet(n,h,f,Me);break;case 3:this._drawTriangle(n,h,f,Me);break;default:this._drawCircle(n,h,f,Me)}n.globalAlpha=d.alpha,n.fillStyle=`rgb(${p}, ${g}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=m?aa:"black",n.lineWidth=x?Or:Gs,n.setLineDash(S?[]:Zo),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Me*2.2),i=Math.ceil(je/2),o=s+i,a=o,r=t.width-s,c=o,l=t.height-s,d=r-a,h=l-c;let f=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(f=p.lightness)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.lightness*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:I}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),v=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,I,b,v,p.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=Gs;const s=this.state.points,i=s.length;if(n==="hs"){t.restore();return}const o=Math.ceil(Me*2.2),a=Math.ceil(je/2),r=o+a,c=r,l=t.canvas.height-o,d=t.canvas.width-r-o,h=l-r,f=c+d;if(d<=0){t.restore();return}const u=this.state.isCyclic?i:i-1;for(let p=0;p<u;p++){const g=s[p],y=s[(p+1)%i],m=Math.max(g.order,y.order),x=this.state.isCyclic&&p===i-1;if(m===0){const S=l-g[n]*h,I=l-y[n]*h,b=c+g.pos*d,v=c+y.pos*d;if(x&&g.pos>y.pos){let E=g.pos,C=y.pos+1;const _=E+(C-E)*.5,P=c+(_-Math.floor(_))*d,M=this.getInterpolatedPropertiesAt(g.pos),w=this.getInterpolatedPropertiesAt(y.pos);if(M){const O=this.abstractToRgb(M.u,M.v,M.lightness),T=this.clampColor(O);t.strokeStyle=`rgba(${T.r},${T.g},${T.b},${M.alpha})`,t.setLineDash([]),_>1?(t.beginPath(),t.moveTo(b,S),t.lineTo(f,S),t.stroke(),t.beginPath(),t.moveTo(c,S),t.lineTo(P,S),t.stroke()):(t.beginPath(),t.moveTo(b,S),t.lineTo(P,S),t.stroke())}if(w){const O=this.abstractToRgb(w.u,w.v,w.lightness),T=this.clampColor(O);t.strokeStyle=`rgba(${T.r},${T.g},${T.b},${w.alpha})`,t.setLineDash([]),_>1?(t.beginPath(),t.moveTo(P,I),t.lineTo(v,I),t.stroke()):(t.beginPath(),t.moveTo(P,I),t.lineTo(f,I),t.stroke(),t.beginPath(),t.moveTo(c,I),t.lineTo(v,I),t.stroke())}t.beginPath(),t.setLineDash(Zo),t.strokeStyle="black",t.moveTo(P,S),t.lineTo(P,I),t.stroke()}else if(!x){let E=g.pos,C=y.pos;const _=E+(C-E)*.5,P=c+_*d,M=this.getInterpolatedPropertiesAt(g.pos),w=this.getInterpolatedPropertiesAt(y.pos);if(M){const O=this.abstractToRgb(M.u,M.v,M.lightness),T=this.clampColor(O);t.strokeStyle=`rgba(${T.r},${T.g},${T.b},${M.alpha})`,t.setLineDash([]);const A=p===0&&!this.state.isCyclic?c:b;t.beginPath(),t.moveTo(A,S),t.lineTo(P,S),t.stroke()}if(w){const O=this.abstractToRgb(w.u,w.v,w.lightness),T=this.clampColor(O);t.strokeStyle=`rgba(${T.r},${T.g},${T.b},${w.alpha})`,t.setLineDash([]);const A=p===u-1&&!this.state.isCyclic?f:v;t.beginPath(),t.moveTo(P,I),t.lineTo(A,I),t.stroke()}t.beginPath(),t.setLineDash(Zo),t.strokeStyle="black",t.moveTo(P,S),t.lineTo(P,I),t.stroke()}}else if(t.setLineDash([]),x&&g.pos>y.pos){const S=l-g[n]*h,I=l-y[n]*h,b=c+g.pos*d,v=c+y.pos*d,E=1-g.pos;if(E>1e-6){const C=t.createLinearGradient(b,0,f,0),_=Math.max(2,Math.ceil(E*20));for(let w=0;w<=_;w++){const O=g.pos+w/_*E,T=this.getInterpolatedPropertiesAt(O);if(T){const A=this.abstractToRgb(T.u,T.v,T.lightness),{r:L,g:B,b:F}=this.clampColor(A);C.addColorStop(w/_,`rgba(${L}, ${B}, ${F}, ${T.alpha})`)}}const P=this.getInterpolatedPropertiesAt(1),M=P?l-P[n]*h:S;t.beginPath(),t.moveTo(b,S),t.lineTo(f,M),t.strokeStyle=C,t.stroke()}if(y.pos>1e-6){const C=t.createLinearGradient(c,0,v,0),_=Math.max(2,Math.ceil(y.pos*20));for(let w=0;w<=_;w++){const O=w/_*y.pos,T=this.getInterpolatedPropertiesAt(O);if(T){const A=this.abstractToRgb(T.u,T.v,T.lightness),{r:L,g:B,b:F}=this.clampColor(A);C.addColorStop(w/_,`rgba(${L}, ${B}, ${F}, ${T.alpha})`)}}const P=this.getInterpolatedPropertiesAt(0),M=P?l-P[n]*h:I;t.beginPath(),t.moveTo(c,M),t.lineTo(v,I),t.strokeStyle=C,t.stroke()}}else if(!x){const S=c+g.pos*d,I=c+y.pos*d,b=(v,E,C,_)=>{const P=E-v;if(Math.abs(P)<1e-9)return;const M=t.createLinearGradient(C,0,_,0),w=Math.ceil(Math.abs(_-C)/2);for(let O=0;O<=w;O++){const T=v+O/w*P,A=this.getInterpolatedPropertiesAt(T);if(!A)continue;const L=this.abstractToRgb(A.u,A.v,A.lightness),{r:B,g:F,b:R}=this.clampColor(L);M.addColorStop(O/w,`rgba(${B}, ${F}, ${R}, ${A.alpha})`)}t.beginPath();for(let O=0;O<=w;O++){const T=v+O/w*P,A=this.getInterpolatedPropertiesAt(T);if(!A)continue;const L=Math.max(0,Math.min(1,T)),B=c+L*d,F=l-A[n]*h;O===0?t.moveTo(B,F):t.lineTo(B,F)}t.strokeStyle=M,t.stroke()};if(p===0&&!this.state.isCyclic&&Math.abs(g.pos)>=1e-6){const v=this.getInterpolatedPropertiesAt(g.pos);if(v){const E=this.abstractToRgb(v.u,v.v,v.lightness),{r:C,g:_,b:P}=this.clampColor(E);t.strokeStyle=`rgba(${C}, ${_}, ${P}, ${v.alpha})`;const M=l-v[n]*h;t.beginPath(),t.moveTo(c,M),t.lineTo(S,M),t.stroke()}}if(b(g.pos,y.pos,S,I),p===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const v=this.getInterpolatedPropertiesAt(y.pos);if(v){const E=this.abstractToRgb(v.u,v.v,v.lightness),{r:C,g:_,b:P}=this.clampColor(E);t.strokeStyle=`rgba(${C}, ${_}, ${P}, ${v.alpha})`;const M=l-v[n]*h;t.beginPath(),t.moveTo(I,M),t.lineTo(f,M),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const s=t.lightness<.05||t.lightness>.95,i=n.lightness<.05||n.lightness>.95;if(s&&i)return!0;const o=10;for(let a=0;a<=o;a++){const r=a/o,c=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*r,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*r,d=t.lightness+(n.lightness-t.lightness)*r,h=this.abstractToRgb(c,l,d);if(!this.isValidColor(h.r,h.g,h.b))return!1}return!0}drawInterpolatedPath(t,n,s,i){const o=s.pos-n.pos;if(o<1e-6)return;const a=Math.max(2,Math.ceil(o*t.canvas.width/4));let r=!1;for(let c=0;c<=a;c++){const l=n.pos+c/a*o,d=this.getInterpolatedPropertiesAt(l);if(!d)continue;const h=this.clampAbstractPoint(d.u,d.v,d.lightness),f=h.u*this.state.transform.scale+this.state.transform.offsetX,u=h.v*this.state.transform.scale+this.state.transform.offsetY;!r||c===0?(t.moveTo(f,u),r=!0):t.lineTo(f,u)}}drawHSSegment(t,n,s,i,o){let a=n.pos,r=s.pos;this.state.isCyclic&&r<a&&(r+=1);const c=r-a;if(c<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(c*t.canvas.width/8)),d=[];for(let f=0;f<=l;f++){const u=a+f/l*c,p=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!p)continue;const g=this.clampAbstractPoint(p.u,p.v,p.lightness),y=g.u*this.state.transform.scale+this.state.transform.offsetX,m=g.v*this.state.transform.scale+this.state.transform.offsetY,x=Math.abs(p.lightness-this.state.viewLightness)<1e-10;d.push({x:y,y:m,isOnPlane:x,u:g.u,v:g.v})}if(d.length<2)return;if(d.every(f=>f.isOnPlane)){t.strokeStyle="black",t.lineWidth=Gs,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let f=1;f<d.length;f++)t.lineTo(d[f].x,d[f].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=Gs,t.globalAlpha=.4;const f=Math.sqrt((s.hsPos.u-n.hsPos.u)**2+(s.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+f*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let p=1;p<d.length;p++)t.lineTo(d[p].x,d[p].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const s=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<s;i++){const o=this.state.points[i],a=this.state.points[(i+1)%this.state.points.length];if(Math.max(o.order,a.order)===0)continue;const c=Math.abs(o.lightness-this.state.viewLightness)<1e-10,l=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&l)continue;const d=o.lightness,h=a.lightness,f=this.state.viewLightness;if(d<f&&h>f||d>f&&h<f){const u=this.findLightnessIntersection(o,a,f);if(u!==null){let p=a.pos-o.pos;this.state.isCyclic&&a.pos<o.pos&&(p+=1);const g=o.pos+u*p,y=this.getInterpolatedPropertiesAt(g);if(!y)continue;const m=this.clampAbstractPoint(y.u,y.v,y.lightness),x=m.u*this.state.transform.scale+this.state.transform.offsetX,S=m.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(x,S,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,s){const i=t.lightness,o=n.lightness;if(Math.abs(o-i)<1e-10)return null;if(Math.max(t.order,n.order)===1){const h=(s-i)/(o-i);return h>0&&h<1?h:null}let r=0,c=1;const l=25;for(let h=0;h<l;h++){const f=(r+c)/2,u=t.pos+(n.pos-t.pos)*f,p=this.getInterpolatedPropertiesAt(u);if(!p)break;if(Math.abs(p.lightness-s)<1e-10)return f;p.lightness<s?o>i?r=f:c=f:o>i?c=f:r=f}const d=(r+c)/2;return d>.01&&d<.99?d:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const s=t.canvas,i=Math.ceil(Me*2.2),o=Math.ceil(je/2),a=i+o;t.save(),t.strokeStyle="white",t.lineWidth=1;const r=a,c=s.width-i,l=a,d=s.height-i,h=c-r,f=d-l;this.clearTickLabels(s);const u=[0,.2,.4,.6,.8,1],p=["0","0.2","0.4","0.6","0.8","1"],g=s.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,m=window.pageYOffset||document.documentElement.scrollTop;for(let x=0;x<u.length;x++){const S=u[x],I=Math.floor(r+S*h)+.5;S===0?(t.beginPath(),t.moveTo(I,l),t.lineTo(I,d+5),t.stroke()):(t.beginPath(),t.moveTo(I,d),t.lineTo(I,d+5),t.stroke());const b=g.left+y+I,v=g.top+m+d+8;this.createKaTeXLabel(p[x],b,v,"bottom",s)}for(let x=0;x<u.length;x++){const S=u[x],I=Math.floor(d-S*f)+.5;S===0?(t.beginPath(),t.moveTo(r-5,I),t.lineTo(c,I),t.stroke()):(t.beginPath(),t.moveTo(r-5,I),t.lineTo(r,I),t.stroke());const b=g.left+y+r-8,v=g.top+m+I;this.createKaTeXLabel(p[x],b,v,"left",s)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(s=>s.remove())}createKaTeXLabel(t,n,s,i,o){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${s}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=o.dataset.type,katex.render(t,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,s,i,o)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const s=Math.ceil(Me*2.2),i=Math.ceil(je/2),o=s+i,a=o,r=t.width-s,c=o,l=t.height-s,d=r-a,h=l-c;let f=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const p=this.getPointById(this.state.activeDrag.pointId);p&&(f=p.alpha)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(p=>{const g=a+p.pos*d,y=l-p.alpha*h,m=this.abstractToRgb(p.hsPos.u,p.hsPos.v,p.lightness),{r:x,g:S,b:I}=this.clampColor(m),b=this.state.selectedPointIds.has(p.id),v=p.id===this.state.lastSelectedPointId;this.drawPoint(n,g,y,x,S,I,b,v,p.order)})}_drawCircle(t,n,s,i){t.arc(n,s,i,0,2*Math.PI)}_drawJoukowsky(t,n,s,i,o){const r=[];let c=1/0,l=-1/0,d=1/0,h=-1/0;for(let m=0;m<=50;m++){const x=m/50*2*Math.PI,S=Math.cos(x),I=Math.sin(x),b=1-o+o*S,v=o*I,E=b*b+v*v;if(Math.abs(E)<1e-9)continue;const C=o*I-o*I/E,_=o*S+b/E;r.push({x:C,y:_}),C<c&&(c=C),C>l&&(l=C),_<d&&(d=_),_>h&&(h=_)}const f=h-d,u=i*2.5/f,p=(l+c)/2,g=(h+d)/2;t.beginPath();const y=r[0];t.moveTo(n+(y.x-p)*u,s-(y.y-g)*u);for(let m=1;m<r.length;m++){const x=r[m];t.lineTo(n+(x.x-p)*u,s-(x.y-g)*u)}t.closePath()}_drawDroplet(t,n,s,i){this._drawJoukowsky(t,n,s,i,.6666666666666666)}_drawTriangle(t,n,s,i){const o=i*1.4;t.moveTo(n,s-o),t.lineTo(n+o*Math.sqrt(3)/2,s+o/2),t.lineTo(n-o*Math.sqrt(3)/2,s+o/2),t.closePath()}drawPoint(t,n,s,i,o,a,r,c,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,s,Me);break;case 1:this._drawDroplet(t,n,s,Me);break;case 3:this._drawTriangle(t,n,s,Me);break;default:this._drawCircle(t,n,s,Me)}t.fillStyle=`rgb(${i}, ${o}, ${a})`,t.fill(),t.strokeStyle=r?aa:"black",t.lineWidth=c?Or:Gs,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,s=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){s||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!s){const{lightness:o,hsPos:a}=t,r=this.abstractToRgb(a.u,a.v,o);if(i){const{r:c,g:l,b:d}=this.clampColor(r);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=d}else{const c=this.rgbToHsl(r.r,r.g,r.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:s}=t.parentElement;(t.width!==n||t.height!==s)&&(t.width=n,t.height=s);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),this.drawCheckerboard(i);const o=this.getLastSelectedPoint();if(o){const{hsPos:a,lightness:r,alpha:c}=o,l=this.abstractToRgb(a.u,a.v,r),{r:d,g:h,b:f}=this.clampColor(l);i.fillStyle=`rgba(${d}, ${h}, ${f}, ${c})`,i.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,s=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let i=0;i<n;i++){const o=i/(n-1),a=this.getInterpolatedPropertiesAt(o);if(!a)continue;const r=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(r.u,r.v,a.lightness),{r:l,g:d,b:h}=this.clampColor(c);t.fillStyle=`rgba(${l}, ${d}, ${h}, ${a.alpha})`,t.fillRect(i,0,1,s)}}getInterpolatedPropertiesAt(t){const n=this.state.points,s=n.length;if(s===0)return null;if(s===1){const f=n[0];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}const i=this.state.isCyclic,o=i?(t%1+1)%1:t;let a,r,c=-1;for(let f=0;f<s-1;f++)if(o>=n[f].pos&&o<=n[f+1].pos){c=f,a=n[f],r=n[f+1];break}if(c===-1)if(i)c=s-1,a=n[s-1],r=n[0];else{const f=o<n[0].pos?n[0]:n[s-1];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(!a||!r)return null;let l=r.pos-a.pos;if(i&&c===s-1&&(l+=1),Math.abs(l)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let d;i&&c===s-1?d=o>=a.pos?(o-a.pos)/l:(o+1-a.pos)/l:d=(o-a.pos)/l;const h=Math.max(a.order,r.order);if(h===0){const f=d<.5?a:r;return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(h===3){const f=this.evaluateCubicSpline(c,d);if(f){const u=Math.max(0,Math.min(1,f.lightness)),p=Math.max(0,Math.min(1,f.alpha)),g=this.clampAbstractPoint(f.u,f.v,u);return{u:g.u,v:g.v,lightness:u,alpha:p,order:2}}}return{u:a.hsPos.u+(r.hsPos.u-a.hsPos.u)*d,v:a.hsPos.v+(r.hsPos.v-a.hsPos.v)*d,lightness:a.lightness+(r.lightness-a.lightness)*d,alpha:a.alpha+(r.alpha-a.alpha)*d,order:1}}abstractToRgb(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,s);const i=this.rgbCubeAbstractToRgb(t,n,s);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,s){if(this.state.colorSpace==="HSL_DI_CONE"){const f=Math.sqrt(t*t+n*n),u=1-Math.abs(2*s-1);return f>u&&u>1e-6?{u:t/f*u,v:n/f*u}:{u:t,v:n}}if(s<=.01||s>=.99)return{u:0,v:0};let{r:i,g:o,b:a}=this.abstractToRgb(t,n,s);if(this.isValidColor(i,o,a))return{u:t,v:n};let r=0,c=0,l=1/0;const d=Math.max(Math.abs(t),Math.abs(n),.5),h=50;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const p=t+(f/h-.5)*2*d,g=n+(u/h-.5)*2*d,y=this.abstractToRgb(p,g,s);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((p-t)**2+(g-n)**2);m<l&&(l=m,r=p,c=g)}}return l<1/0?{u:r,v:c}:{u:0,v:0}}hslToRgb(t,n,s){if(n===0)return{r:s,g:s,b:s};const i=s<.5?s*(1+n):s+n-s*n,o=2*s-i,a=(d,h,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<1/6?d+(h-d)*6*f:f<1/2?h:f<2/3?d+(h-d)*(2/3-f)*6:d),r=a(o,i,t+1/3),c=a(o,i,t),l=a(o,i,t-1/3);return{r,g:c,b:l}}rgbToHsl(t,n,s){const i=Math.max(t,n,s),o=Math.min(t,n,s);let a=0,r=0,c=(i+o)/2;if(i!==o){const l=i-o;switch(r=c>.5?l/(2-i-o):l/(i+o),i){case t:a=(n-s)/l+(n<s?6:0);break;case n:a=(s-t)/l+2;break;case s:a=(t-n)/l+4;break}a/=6}return{h:a,s:r,l:c}}drawCheckerboard(t){const n=t.canvas.width,s=t.canvas.height,i=n/je,o=s/je;t.fillStyle=ra,t.fillRect(0,0,n,s),t.fillStyle=la;for(let a=0;a<o;a++)for(let r=0;r<i;r++)(a+r)%2===0&&t.fillRect(r*je,a*je,je,je)}findClosestValidPoint(t,n,s){const i=Math.ceil(Me*2.2),o=Math.ceil(je/2),a=i+o,r=a,c=a,l=this.elements.hsBgCanvas.width-a-i,d=this.elements.hsBgCanvas.height-a-i,h=Math.max(r,Math.min(r+l,t)),f=Math.max(c,Math.min(c+d,n)),{scale:u,offsetX:p,offsetY:g}=this.state.transform,y=(h-p)/u,m=(f-g)/u,x=this.abstractToRgb(y,m,s);if(this.isValidColor(x.r,x.g,x.b))return{x:h,y:f};if(this.state.colorSpace==="HSL_DI_CONE"){const S=Math.sqrt(y*y+m*m),I=1-Math.abs(2*s-1);if(S>I&&I>1e-6){const b=y/S*I,v=m/S*I;return{x:b*u+p,y:v*u+g}}return{x:h,y:f}}return this.findClosestPointOnRgbGamut(y,m,s,u,p,g,r,c,l,d)}getGamutVerticesRgb(t){const n=[],s=r=>r>=-1e-6&&r<=1.000001,i=(r,c)=>Math.abs(r.r-c.r)<1e-6&&Math.abs(r.g-c.g)<1e-6&&Math.abs(r.b-c.b)<1e-6,o=(r,c,l)=>{if(s(r)&&s(c)&&s(l)){const d={r,g:c,b:l};n.some(h=>i(h,d))||n.push(d)}},a=3*t;return o(a,0,0),o(0,a,0),o(0,0,a),o(1,a-1,0),o(1,0,a-1),o(a-1,1,0),o(0,1,a-1),o(a-1,0,1),o(0,a-1,1),o(1,1,a-2),o(1,a-2,1),o(a-2,1,1),n}rgbCubeAbstractToRgb(t,n,s){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},o={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=s+t*i.x+n*o.x,r=s+t*i.y+n*o.y,c=s+t*i.z+n*o.z;return{r:a,g:r,b:c}}findClosestPointOnRgbGamut(t,n,s,i,o,a,r,c,l,d){let h=t,f=n,u=1/0;const p=.5,g=50;for(let x=0;x<=g;x++)for(let S=0;S<=g;S++){const I=t+(x/g-.5)*2*p,b=n+(S/g-.5)*2*p,v=this.abstractToRgb(I,b,s);if(this.isValidColor(v.r,v.g,v.b)){const E=Math.sqrt((I-t)**2+(b-n)**2);E<u&&(u=E,h=I,f=b)}}if(u<1/0){const x=this.refineClosestPoint(t,n,h,f,s);h=x.u,f=x.v}const y=h*i+o,m=f*i+a;return{x:Math.max(r,Math.min(r+l,y)),y:Math.max(c,Math.min(c+d,m))}}refineClosestPoint(t,n,s,i,o){let a=s,r=i,c=.02;for(let l=0;l<5;l++){let d=!1;const h=20;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const p=a+(f/h-.5)*2*c,g=r+(u/h-.5)*2*c,y=this.abstractToRgb(p,g,o);if(this.isValidColor(y.r,y.g,y.b)){const m=Math.sqrt((a-t)**2+(r-n)**2);Math.sqrt((p-t)**2+(g-n)**2)<m&&(a=p,r=g,d=!0)}}if(c*=.5,!d)break}return{u:a,v:r}}findClosestPointOnPolygon(t,n){let s=null,i=1/0;for(let o=0;o<n.length;o++){const a=n[o],r=n[(o+1)%n.length],c=r.x-a.x,l=r.y-a.y;let d;if(c===0&&l===0)d=a;else{const f=((t.x-a.x)*c+(t.y-a.y)*l)/(c*c+l*l);f<0?d=a:f>1?d=r:d={x:a.x+f*c,y:a.y+f*l}}const h=(t.x-d.x)**2+(t.y-d.y)**2;h<i&&(i=h,s=d)}return s}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const s=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=s.u,t.hsPos.v=s.v}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(Me*2.2),a=Math.ceil(je/2),r=o+a,c=i.height-r-o,l=i.height-o,d=s==="lightness"?l-this.state.viewLightness*c:l-this.state.viewAlpha*c;let h=Math.abs(n-d)<=Nr,f=null;for(let u=0;u<this.state.points.length;u++){const p=this.state.points[u],g=i.width-r-o,y=r+p.pos*g,m=s==="lightness"?l-p.lightness*c:l-p.alpha*c;if(Math.sqrt((t-y)**2+(n-m)**2)<=da){f=p;break}}return{hitPoint:f,hitLine:h}}findHitPointSlider(t,n,s){const i=this.elements.interactiveCanvases[s],o=Math.ceil(Me*2.2),a=i.height-2*o,r=i.height-o,c=s==="lightness"?r-this.state.viewLightness*a:r-this.state.viewAlpha*a;let l=Math.abs(n-c)<=Nr,d=null;for(let h=0;h<this.state.points.length;h++){const f=this.state.points[h],u=i.width-2*o,p=o+f.pos*u,g=s==="lightness"?r-f.lightness*a:r-f.alpha*a;if(Math.sqrt((t-p)**2+(n-g)**2)<=da){d=f;break}}return{hitPoint:d,hitLine:l}}createNewPointHS(t,n){const s=Math.ceil(Me*2.2),i=Math.ceil(je/2),o=s+i,a=o,r=o,c=this.elements.hsBgCanvas.width-o-s,l=this.elements.hsBgCanvas.height-o-s;if(t<a||t>a+c||n<r||n>r+l)return;const d=(t-this.state.transform.offsetX)/this.state.transform.scale,h=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:f,viewAlpha:u}=this.state,{r:p,g,b:y}=this.abstractToRgb(d,h,f);if(this.isValidColor(p,g,y)){this.markAsDirty();const m=this.state.points.length;m>0&&this.state.points.forEach(S=>{S.pos=S.pos-S.pos/m});const x={id:Date.now(),hsPos:{u:d,v:h},originalHsPos:{u:d,v:h},lightness:f,alpha:u,pos:m===0?.5:1,order:1};this.state.points.push(x),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(x.id),this.state.lastSelectedPointId=x.id,this.drawAll()}}handleLineDrag(t,n,s){const i=s.startsWith("lightness")?"lightness":"alpha",o=s.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(Me*2.2),r=Math.ceil(je/2),c=a+r,l=n-c-a,h=(this.findSnapPosition(t,n,i)-c)/l,f=Math.max(0,Math.min(1,1-h));this.state[o]=f,this.drawAll()}handlePointDrag(t,n,s,i){const o=this.getPointById(this.state.activeDrag.pointId);o&&(i==="hs"?this.handleHSPointDrag(t,n):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(o,t,n,s,i),this.drawAll())}handleHSPointDrag(t,n){const{startX:s,startY:i,initialPointPositions:o}=this.state.activeDrag,{scale:a,offsetX:r,offsetY:c}=this.state.transform,l=Math.ceil(Me*2.2),d=Math.ceil(je/2),h=l+d,f=h,u=h,p=this.elements.hsBgCanvas.width-h-l,g=this.elements.hsBgCanvas.height-h-l,y=t-s,m=n-i;this.state.points.forEach(x=>{if(o.has(x.id)){const S=o.get(x.id),I=S.x+y,b=S.y+m,v=Math.max(f,Math.min(f+p,I)),E=Math.max(u,Math.min(u+g,b)),C=this.findClosestValidPoint(v,E,x.lightness),_=(C.x-r)/a,P=(C.y-c)/a;x.hsPos={u:_,v:P};const M=this.abstractToRgb(_,P,x.lightness);this.isValidColor(M.r,M.g,M.b)&&(x.originalHsPos={u:_,v:P})}})}adjustPointForNewLightness(t,n){const s=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(s.r,s.g,s.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}handleSliderPointDrag(t,n,s,i,o){const{offsets:a}=this.state.activeDrag,r=Math.ceil(Me*2.2),c=Math.ceil(je/2),l=r+c;i.width-r,i.height-r;const d=this.findSnapPosition(s,i.height,o,t.id),h=l,f=i.width-r,u=l,p=i.height-r,g=f-h,y=p-u,m=(d-u)/y,x=Math.max(0,Math.min(1,1-m));let S=(n-h)/g,I=S;this.state.isCyclic?(S<0?I=1+S:S>1&&(I=S-1),I=this.wrapPositionCyclic(I)):I=Math.max(0,Math.min(1,S));for(const b of this.state.points)if(a.has(b.id)){const v=a.get(b.id),E=x+v[o];let C=I+v.pos;if(this.state.isCyclic?C=this.wrapPositionCyclic(C):C=Math.max(0,Math.min(1,C)),b.pos=C,o==="lightness"){const _=Math.max(0,Math.min(1,E));b.lightness=_;const P=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,_);if(this.isValidColor(P.r,P.g,P.b))b.hsPos={...b.originalHsPos};else{const M=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,_);b.hsPos.u=M.u,b.hsPos.v=M.v}this.state.viewLightness=_}else b.alpha=Math.max(0,Math.min(1,E)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const Gc=[5,4],Za=16,Hc=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],$r=e=>{const t=[{power:3,value:e[0]},{power:2,value:e[1]},{power:1,value:e[2]},{power:0,value:e[3]}],n=s=>Number(s.toFixed(6));return t.filter(s=>Math.abs(s.value)>1e-10).map((s,i)=>{const o=s.value<0?"-":"+",a=Math.abs(s.value),r=n(a),c=s.power===0?"":`t^${s.power}`,l=s.power===0?`${r}`:`${r}${c}`;return i===0?s.value<0?`-${l}`:`${l}`:`${o} ${l}`}).join(" ").replace(/t\^1\b/g,"t")},zc=(e,t,n,s,i)=>{const o=[t.x,n.x,s.x,i.x],a=[t.y,n.y,s.y,i.y],r=e.map(l=>l.reduce((d,h,f)=>d+h*o[f],0)),c=e.map(l=>l.reduce((d,h,f)=>d+h*a[f],0));return{x:r,y:c}},Wc=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c};function Kc(e,t=!1,n=Za){if(e.length<2)return e;const s=[],i=e.length,o=t?i:i-1;for(let a=0;a<o;a++){const r=e[a],c=e[(a+1)%i],l=a===0?0:1;for(let d=l;d<=n;d++){const h=d/n;s.push({x:r.x+(c.x-r.x)*h,y:r.y+(c.y-r.y)*h})}}return s}const en=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},xi=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),qc=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},gs=(e,t,n,s,i,o,a,r=null)=>{const c=i*.5;if(c<=1e-6)return;const l={x:c,y:c},d=Math.PI,h=-Math.PI/2,f=qc(d,h),u=Math.max(2,o);for(let p=a?0:1;p<=u;p++){const g=p/u,y=d+f*g,m={x:l.x+Math.cos(y)*c,y:l.y+Math.sin(y)*c},x={x:t.x+n.x*m.x+s.x*m.y,y:t.y+n.y*m.x+s.y*m.y};r?r(x):e.push(x)}};function Vr(e,t=!1,n="relative",s=0,i=Za,o=!1,a=!1,r=!1,c=!1){if(e.length<2)return e;if(s<=1e-6)return t?[...e,e[0]]:[...e];const l=e.length,d=[],h=[],f=n==="fixed"?"absolute":n,u=f==="absolute"?"relative":f,p=I=>{const b=e[(I-1+l)%l],v=e[I],E=e[(I+1)%l],C=xi(b,v),_=xi(E,v),P=Math.hypot(C.x,C.y),M=Math.hypot(_.x,_.y);if(P<=1e-6||M<=1e-6)return null;let w,O,T;const A=Math.min(P,M)*.5;if(u==="absolute"?(w=Math.max(0,Math.min(1,s)),O=en(_),T=en(C)):(f==="absolute"?w=Math.max(0,Math.min(s,A))*2:w=Math.max(0,Math.min(1,s)),O=f==="absolute"?en(_):_,T=f==="absolute"?en(C):C),w<=1e-6)return null;const L=w*.5,B=r?-L:f==="absolute"?P*.5:.5,F=r?-L:f==="absolute"?M*.5:.5,R={x:v.x+T.x*B,y:v.y+T.y*B},N={x:v.x+O.x*F,y:v.y+O.y*F},$=en(T),D=en(O),k={x:$.x+D.x,y:$.y+D.y},V=Math.hypot(k.x,k.y),G=V>1e-6?{x:k.x/V,y:k.y/V}:{x:0,y:0},X=f==="absolute"?L:L*Math.min(P,M),H={x:v.x-G.x*(X/Math.sqrt(2)),y:v.y-G.y*(X/Math.sqrt(2))},Y={x:-$.y,y:$.x},W={x:-D.y,y:D.x},J=Y.x*G.x+Y.y*G.y<0?{x:-Y.x,y:-Y.y}:Y,ee=W.x*G.x+W.y*G.y<0?{x:-W.x,y:-W.y}:W,oe=(f==="absolute"?L:L*P)/Math.sqrt(2),ye=(f==="absolute"?L:L*M)/Math.sqrt(2),qe={x:v.x+$.x*(P*.5)+J.x*oe,y:v.y+$.y*(P*.5)+J.y*oe},ke={x:v.x+D.x*(M*.5)+ee.x*ye,y:v.y+D.y*(M*.5)+ee.y*ye},et={x:v.x+T.x*L,y:v.y+T.y*L},at={x:v.x+O.x*L,y:v.y+O.y*L};return{index:I,origin:v,axisX:O,axisY:T,baseScale:w,radius:L,edgeInIndex:(I-1+l)%l,edgeOutIndex:I,midIn:R,midOut:N,arcStart:et,arcEnd:at,bisectorOuter:H,midInOrtho:qe,midOutOrtho:ke}},g=(I,b=null,v=null)=>{if(!c){d.push({x:I.x,y:I.y});return}d.push({x:I.x,y:I.y,tag:b||void 0,edgeIndex:v??void 0})},y=I=>g(I,"arc"),m=(I,b)=>{!r||I.radius<=1e-6||(b?(g(I.midInOrtho,"line",I.edgeInIndex),g(I.bisectorOuter,"corner")):(g(I.bisectorOuter,"corner"),g(I.midOutOrtho,"line",I.edgeOutIndex)))};if(t){for(let b=0;b<l;b++){const v=p(b);v&&h.push(v)}if(!h.length)return[...e,e[0]];if(r){const b=h[0];g(b.arcStart,"line",b.edgeInIndex),gs(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!1,y);for(let v=1;v<h.length;v++){const E=h[v];g(E.arcStart,"line",E.edgeInIndex),gs(d,E.origin,E.axisX,E.axisY,E.baseScale,i,!1,y)}return g({...b.arcStart},"line",b.edgeInIndex),d}const I=h[0];return g(I.midIn,"line",I.edgeInIndex),m(I,!0),h.forEach((b,v)=>{v>0&&(g(b.midIn,"line",b.edgeInIndex),m(b,!0)),gs(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!0,y),m(b,!1),g(b.midOut,"line",b.edgeOutIndex),g(b.origin,"corner")}),g({...I.midIn},"line",I.edgeInIndex),d}if(u==="absolute"){for(let v=1;v<l-1;v++){const E=p(v);E&&h.push(E)}if(!h.length)return[...e];const I=h[0];g(e[0],"line",0),I&&g(I.midIn,"line",I.edgeInIndex),m(I,!0),h.forEach((v,E)=>{E>0&&(g(v.midIn,"line",v.edgeInIndex),m(v,!0)),gs(d,v.origin,v.axisX,v.axisY,v.baseScale,i,!0,y),m(v,!1),g(v.midOut,"line",v.edgeOutIndex)});const b=h[h.length-1];return b&&g(b.midOut,"line",b.edgeOutIndex),g(e[l-1],"line",l-2),d}if(r){for(let b=1;b<l-1;b++){const v=p(b);v&&h.push(v)}if(!h.length)return[...e];g(e[0],"line",0);const I=h[0];g(I.arcStart,"line",I.edgeInIndex),gs(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!1,y);for(let b=1;b<h.length;b++){const v=h[b];g(v.arcStart,"line",v.edgeInIndex),gs(d,v.origin,v.axisX,v.axisY,v.baseScale,i,!1,y)}return g(e[l-1],"line",l-2),d}for(let I=1;I<l-1;I++){const b=p(I);b&&h.push(b)}if(!h.length)return[...e];const x=h[0],S=h[h.length-1];return g(e[0],"line",0),g(x.midIn,"line",x.edgeInIndex),h.forEach((I,b)=>{b>0&&g(I.midIn,"line",I.edgeInIndex),m(I,!0),gs(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!0,y),m(I,!1),g(I.midOut,"line",I.edgeOutIndex)}),g(S.midOut,"line",S.edgeOutIndex),g(e[l-1],"line",l-2),d}function jc(e,t=!1,n="relative",s=0){if(e.length<3)return[];if(s<=1e-6)return[];const i=e.length,o=[],a=n==="fixed"?"absolute":n,r=a==="absolute"?"relative":a,c=t?i:i-1;for(let l=1;l<c;l++){const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=xi(d,h),p=xi(f,h),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)continue;const m=Math.min(g,y)*.5;let x,S,I;if(r==="absolute"){const G=Math.min(g,y);x=Math.max(0,Math.min(s,G*.5))*2,S=en(p),I=en(u)}else x=a==="absolute"?Math.max(0,Math.min(s,m))*2:Math.max(0,Math.min(1,s)),S=a==="absolute"?en(p):p,I=a==="absolute"?en(u):u;if(x<=1e-6)continue;const b=x*.5,v=en(I),E=en(S),C={x:v.x+E.x,y:v.y+E.y},_=Math.hypot(C.x,C.y),P=_>1e-6?{x:C.x/_,y:C.y/_}:{x:0,y:0},M=a==="absolute"?b:b*Math.min(g,y),w=t?(()=>{let G=0;for(let X=0;X<i;X++){const H=e[X],Y=e[(X+1)%i];G+=H.x*Y.y-Y.x*H.y}return G})():1,O=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),A=(w>=0?O>=0:O<=0)?-1:1,L={x:h.x+P.x*M*A,y:h.y+P.y*M*A},B={x:-v.y,y:v.x},F={x:-E.y,y:E.x},R=B.x*P.x+B.y*P.y<0?{x:-B.x,y:-B.y}:B,N=F.x*P.x+F.y*P.y<0?{x:-F.x,y:-F.y}:F,$=(a==="absolute"?b:b*g)/Math.sqrt(2),D=(a==="absolute"?b:b*y)/Math.sqrt(2),k={x:h.x+v.x*(g*.5)+R.x*$,y:h.y+v.y*(g*.5)+R.y*$},V={x:h.x+E.x*(y*.5)+N.x*D,y:h.y+E.y*(y*.5)+N.y*D};o.push(L,k,V)}return o}function Xr(e,t=.5,n=!1,s=Za,i={}){if(e.length<2)return e;const o=[],a=Math.max(0,Math.min(1,t)),r=(1-a)*.5,c=Hc(r),l=i?.logSegments??!1,d=i?.label??"Catmull-Rom",h=(u,p,g,y,m)=>{const x=m*m,S=x*m,I=2*S-3*x+1,b=S-2*x+m,v=-2*S+3*x,E=S-x;return{x:I*u.x+b*g.x+v*p.x+E*y.x,y:I*u.y+b*g.y+v*p.y+E*y.y}};return Wc(e,n).forEach(({index:u,p0:p,p1:g,p2:y,p3:m})=>{if(l){const b=zc(c,p,g,y,m);console.groupCollapsed(`${d} segment ${u}`),console.log("Matrix M (rows t^3,t^2,t,1; cols P0..P3):",c),console.log("P0..P3:",p,g,y,m),console.log(`tension: ${a}, tau: ${r}`),console.log("P(t) = [t^3 t^2 t 1] * M * [P0 P1 P2 P3]"),console.log(`x(t) = ${$r(b.x)}`),console.log(`y(t) = ${$r(b.y)}`),console.groupEnd()}const x=u===0?0:1,S={x:(y.x-p.x)*r,y:(y.y-p.y)*r},I={x:(m.x-g.x)*r,y:(m.y-g.y)*r};for(let b=x;b<=s;b++){const v=b/s;o.push(h(g,y,S,I,v))}}),o}const Uc={id:null,preset:"closed",type:"spline",mode:"piecewise",order:3,tension:.5,radiusMode:"absolute",radiusValue:.5,relRadiusValue:.5,absRadiusValue:.5,linearStyle:"lines",nurbsDegree:3,pointHandling:"anchor"},Wi=500,Ws=e=>Math.max(0,Math.min(1,e)),wl=e=>Math.max(0,Math.min(Wi,e)),Qo=e=>{const t=Ws(Number(e)||0);return t*t*Wi},Yr=e=>{const t=wl(Number(e)||0);return Math.sqrt(t/Wi)},Gr=[{id:"closed",label:"Closed"},{id:"open",label:"Open"},{id:"figure8",label:"Figure 8"},{id:"branching",label:"Branching"},{id:"branching4",label:"Branching (4)"},{id:"branching5",label:"Branching (5)"}],Jc=[{id:"linear",label:"Linear"},{id:"spline",label:"Spline"},{id:"radius",label:"Radius"}];class Zc{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:this._createStyle(),previewPoints:this._createDefaultPresetPoints()},this.wrapper=null,this.elements={},this.previewCards=new Map,this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this._renderAllPreviews())}show(t=null){this.state.style=this._normalizeStyle(t),this._updateUIFromState(),this.wrapper.style.display="block",requestAnimationFrame(()=>{this._renderAllPreviews()})}hide(){this.wrapper&&(this.wrapper.style.display="none")}_createStyle(){return{...Uc,id:`style_${Date.now()}`}}_normalizeStyle(t){const n=this._createStyle();if(!t)return n;const i=Number(t.order)===3?3:1;let o=t.type==="px_radius"?"abs_radius":t.type,a=t.radiusMode==="fixed"?"absolute":t.radiusMode,r=t.pointHandling;o==="cubic_spline"?(o="spline",r="anchor"):o==="circular_arc"?o="radius":o==="linear"&&(o="linear"),o==="catmull"?(o="spline",r="anchor"):o==="nurbs"?(o="spline",r="control"):o==="linear"?(o="spline",r="anchor"):o==="rel_radius"?(o="radius",a="relative"):o==="abs_radius"&&(o="radius",a="absolute");const c=t.relRadiusValue??(a==="relative"?Ws(t.radiusValue):n.relRadiusValue),l=t.absRadiusValue??(a==="absolute"?Yr(t.radiusValue):n.absRadiusValue),d=a==="relative"?c:Qo(l);return o||(t.mode==="radius"?o="radius":i===3&&t.tension!==void 0?(o="spline",r="anchor"):i===3?o="spline":(o="spline",r="anchor")),{...n,...t,id:t.id||n.id,preset:t.preset||n.preset,order:i,type:o||n.type,radiusMode:a||n.radiusMode,radiusValue:d,relRadiusValue:c,absRadiusValue:l,linearStyle:t.linearStyle||n.linearStyle,nurbsDegree:t.nurbsDegree||n.nurbsDegree,pointHandling:o==="spline"?"anchor":r??t.pointHandling??n.pointHandling}}_createDefaultPresetPoints(){const t={x:.6,y:.25},n={x:.55,y:.45},s={x:.55,y:.5},i=[{x:.2,y:.2},{x:.8,y:.25},{x:.7,y:.6},{x:.5,y:.45},{x:.3,y:.75}],o=[{x:.05,y:.8},{x:.25,y:.4},{x:.45,y:.7},{x:.65,y:.2},{x:.85,y:.55}],a=[{x:.72,y:.5},{x:.61,y:.31},{x:.39,y:.31},{x:.28,y:.5},{x:.39,y:.69},{x:.61,y:.69},{x:.5,y:.5}];return{closed:{vertices:i,edges:i.map((r,c)=>[c,(c+1)%i.length])},open:{vertices:o,edges:o.slice(0,-1).map((r,c)=>[c,c+1])},figure8:{vertices:a,edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0],[0,6],[6,3]],faces:[[0,1,2,3,4,5]]},branching:[[{x:.1,y:.85},{x:.3,y:.6},{x:.5,y:.4},t],[t,{x:.75,y:.15},{x:.9,y:.1}],[t,{x:.75,y:.35},{x:.9,y:.45}]],branching4:{in:[[{x:.12,y:.15},{x:.32,y:.3},n],[{x:.18,y:.75},{x:.35,y:.58},n]],out:[[n,{x:.75,y:.25},{x:.92,y:.2}],[n,{x:.75,y:.6},{x:.9,y:.72}]]},branching5:{in:[[{x:.1,y:.25},{x:.32,y:.38},s],[{x:.18,y:.8},{x:.35,y:.64},s]],out:[[s,{x:.78,y:.25},{x:.92,y:.2}],[s,{x:.78,y:.5},{x:.92,y:.52}],[s,{x:.78,y:.78},{x:.9,y:.85}]]}}}_initializeDOM(){const t=(E,C={})=>{const _=document.createElement(E);if(C.id){_.id=C.id;const P=C.id.replace(/-(\w)/g,(M,w)=>w.toUpperCase());this.elements[P]=_}return C.className&&(_.className=C.className),C.text&&(_.textContent=C.text),C.type&&(_.type=C.type),C.value!==void 0&&(_.value=C.value),C.attrs&&Object.entries(C.attrs).forEach(([P,M])=>_.setAttribute(P,M)),_};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"interpolation-editor-layout"}),s=t("div",{className:"editor-panel preview-panel"});s.append(t("div",{className:"panel-header",text:"Preview Presets"}));const i=t("div",{className:"preview-list"});Gr.forEach(E=>{const C=t("button",{className:"preview-card",attrs:{"data-preset":E.id,type:"button"}}),_=t("div",{className:"preview-card-label",text:E.label}),P=t("canvas",{className:"preview-card-canvas"});C.append(P,_),i.append(C),this.previewCards.set(E.id,{card:C,canvas:P})}),s.append(i);const o=t("div",{className:"editor-panel type-panel"});o.append(t("div",{className:"panel-header",text:"Interpolation Type"}));const a=t("div",{className:"toggle-stack",id:"type-list"});Jc.forEach(E=>{const C=t("button",{className:"toggle-row",text:E.label,attrs:{"data-type":E.id,type:"button"}});a.append(C)}),o.append(a);const r=t("div",{className:"editor-panel params-panel"});r.append(t("div",{className:"panel-header",text:"Parameters"}));const c=t("div",{className:"param-section",id:"tension-section"});c.append(t("div",{className:"section-caption",text:"Catmull-Rom tension."}));const l=t("div",{className:"param-row"});this.elements.tensionSlider=t("input",{id:"tension-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.tensionInput=t("input",{id:"tension-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),l.append(this.elements.tensionSlider,this.elements.tensionInput),c.append(l);const d=t("div",{className:"param-section",id:"linear-section"});d.append(t("div",{className:"section-caption",text:"Linear marker style."}));const h=t("div",{className:"param-row"}),f=t("div",{className:"toggle-group",id:"linear-style-toggle"});f.append(t("button",{className:"toggle-button",text:"Lines",attrs:{"data-linear-style":"lines",type:"button"}}),t("button",{className:"toggle-button",text:"Arrows",attrs:{"data-linear-style":"arrows",type:"button"}})),h.append(f),d.append(h);const u=t("div",{className:"param-section",id:"handling-section"});u.append(t("div",{className:"section-caption",text:"Point handling."}));const p=t("div",{className:"param-row"}),g=t("div",{className:"toggle-group",id:"point-handling-toggle"});g.append(t("button",{className:"toggle-button",text:"Control",attrs:{"data-point-handling":"control",type:"button"}}),t("button",{className:"toggle-button",text:"Anchor",attrs:{"data-point-handling":"anchor",type:"button"}}),t("button",{className:"toggle-button",text:"Mixed",attrs:{"data-point-handling":"mixed",type:"button"}})),p.append(g),u.append(p);const y=t("div",{className:"param-section",id:"radius-section"});y.append(t("div",{className:"section-caption",text:"Clamped to half each adjacent edge."}));const m=t("div",{className:"param-row"});this.elements.radiusSlider=t("input",{id:"radius-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.radiusInput=t("input",{id:"radius-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),m.append(this.elements.radiusSlider,this.elements.radiusInput),y.append(m);const x=t("div",{className:"toggle-group",id:"radius-mode-toggle"});x.append(t("button",{className:"toggle-button",text:"Relative",attrs:{"data-radius-mode":"relative",type:"button"}}),t("button",{className:"toggle-button",text:"Absolute",attrs:{"data-radius-mode":"absolute",type:"button"}})),y.append(x);const S=t("div",{className:"param-section",id:"nurbs-section"});S.append(t("div",{className:"section-caption",text:"NURBS degree."}));const I=t("div",{className:"param-row"});this.elements.nurbsDegreeSlider=t("input",{id:"nurbs-degree-slider",type:"range",attrs:{min:"2",max:"5",step:"1"}}),this.elements.nurbsDegreeInput=t("input",{id:"nurbs-degree-input",type:"number",attrs:{min:"2",max:"5",step:"1"}}),I.append(this.elements.nurbsDegreeSlider,this.elements.nurbsDegreeInput),S.append(I),r.append(d,u,c,y,S);const b=t("div",{className:"editor-panel actions-panel"});b.append(t("div",{className:"panel-header",text:"Actions"}));const v=t("div",{className:"button-row"});this.elements.closeButton=t("button",{id:"close-button",className:"editor-button secondary",text:"Close",attrs:{type:"button"}}),this.elements.selectButton=t("button",{id:"select-button",className:"editor-button primary",text:"Select",attrs:{type:"button"}}),v.append(this.elements.closeButton,this.elements.selectButton),b.append(v),n.append(s,o,r,b),this.wrapper.append(n),this.container.appendChild(this.wrapper)}_setupEventListeners(){window.addEventListener("resize",()=>{this.wrapper&&this.wrapper.style.display!=="none"&&this._renderAllPreviews()}),this.previewCards.forEach((o,a)=>{o.card.addEventListener("click",()=>{this._setStyle({preset:a})}),o.canvas.addEventListener("mousedown",r=>{this._handlePreviewMouseDown(r,a)})}),this.wrapper.querySelector("#type-list").querySelectorAll(".toggle-row").forEach(o=>{o.addEventListener("click",()=>{this._applyTypeSelection(o.dataset.type)})}),this.wrapper.querySelector("#linear-style-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({linearStyle:o.dataset.linearStyle})})}),this.wrapper.querySelector("#point-handling-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._setStyle({pointHandling:o.dataset.pointHandling})})}),this.elements.radiusSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyRadiusValue(a,!0)}),this.elements.radiusInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyRadiusValue(a,!1)}),this.wrapper.querySelector("#radius-mode-toggle").querySelectorAll(".toggle-button").forEach(o=>{o.addEventListener("click",()=>{this._applyRadiusMode(o.dataset.radiusMode)})}),this.elements.tensionSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyTensionValue(a,!0)}),this.elements.tensionInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyTensionValue(a,!1)}),this.elements.nurbsDegreeSlider.addEventListener("input",o=>{const a=Number(o.target.value);this._applyNurbsDegreeValue(a,!0)}),this.elements.nurbsDegreeInput.addEventListener("change",o=>{const a=Number(o.target.value);this._applyNurbsDegreeValue(a,!1)}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{this.onSelect(this._exportStyleForHost()),this.hide()}),window.addEventListener("mousemove",o=>{this._handlePreviewMouseMove(o)}),window.addEventListener("mouseup",()=>{this._handlePreviewMouseUp()})}_setStyle(t){this.state.style={...this.state.style,...t},this._updateUIFromState(),this._renderAllPreviews()}_exportStyleForHost(){const{id:t,name:n,type:s,tension:i,radiusMode:o,radiusValue:a,pointHandling:r,order:c,preset:l,mode:d,linearStyle:h}=this.state.style,f={id:t,name:n,order:c,preset:l,mode:d,linearStyle:h};return s==="spline"?{...f,type:"cubic_spline",cornerHandling:"pass_through",tension:Number(i??.5)}:s==="radius"?{...f,type:"circular_arc",cornerHandling:r==="mixed"?"mixed":"cut_all",radiusMode:o,radiusValue:a}:{...f,type:"linear",cornerHandling:"pass_through"}}_applyRadiusValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};if(s.radiusMode==="relative"){const i=Ws(t);s.radiusValue=i,s.relRadiusValue=i}else{const i=n?Ws(t):Yr(t);s.absRadiusValue=i,s.radiusValue=Qo(i)}this.state.style=s,n?this.elements.radiusInput.value=s.radiusValue.toFixed(s.radiusMode==="absolute"?0:2):this.elements.radiusSlider.value=s.radiusMode==="absolute"?s.absRadiusValue:s.radiusValue,this._updateUIFromState(),this._renderAllPreviews()}_applyTensionValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.tension=Math.max(0,Math.min(1,t)),this.state.style=s,n?this.elements.tensionInput.value=s.tension.toFixed(2):this.elements.tensionSlider.value=s.tension,this._updateUIFromState(),this._renderAllPreviews()}_applyRadiusMode(t){if(t!=="relative"&&t!=="absolute")return;const n={...this.state.style};n.radiusMode=t,t==="relative"?n.radiusValue=n.relRadiusValue??n.radiusValue:n.radiusValue=Qo(n.absRadiusValue??n.radiusValue),this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_applyNurbsDegreeValue(t,n){if(Number.isNaN(t))return;const s={...this.state.style};s.nurbsDegree=Math.max(2,Math.min(5,Math.round(t))),this.state.style=s,n?this.elements.nurbsDegreeInput.value=s.nurbsDegree:this.elements.nurbsDegreeSlider.value=s.nurbsDegree,this._updateUIFromState()}_applyTypeSelection(t){const n={...this.state.style,type:t};switch(t){case"linear":n.mode="piecewise",n.order=1,n.pointHandling="anchor";break;case"spline":n.mode="piecewise",n.order=3,n.pointHandling="anchor";break;case"radius":n.mode="radius",n.radiusMode=n.radiusMode||"relative",n.radiusValue=n.radiusMode==="relative"?n.relRadiusValue??n.radiusValue:Qo(n.absRadiusValue??n.radiusValue),n.pointHandling=n.pointHandling==="mixed"?"mixed":"control";break}this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_updateUIFromState(){const{preset:t,mode:n,order:s,radiusMode:i,radiusValue:o,tension:a,type:r,linearStyle:c,nurbsDegree:l,pointHandling:d}=this.state.style;this.previewCards.forEach((y,m)=>{y.card.classList.toggle("is-active",m===t)}),this.wrapper.querySelectorAll("#type-list .toggle-row").forEach(y=>{y.classList.toggle("is-active",y.dataset.type===r)}),this.wrapper.querySelectorAll("#linear-style-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.linearStyle===c)}),this.wrapper.querySelectorAll("#point-handling-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.pointHandling===d)});const h=this.wrapper.querySelector("#linear-section"),f=this.wrapper.querySelector("#handling-section"),u=this.wrapper.querySelector("#tension-section"),p=this.wrapper.querySelector("#radius-section"),g=this.wrapper.querySelector("#nurbs-section");h.classList.toggle("is-hidden",r!=="linear"),f.classList.toggle("is-hidden",!0),u.classList.toggle("is-hidden",r!=="spline"),p.classList.toggle("is-hidden",r!=="radius"),g.classList.toggle("is-hidden",!0),this.wrapper.querySelectorAll("#radius-mode-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.radiusMode===i)}),i==="absolute"?(this.elements.radiusSlider.value=Ws(this.state.style.absRadiusValue),this.elements.radiusInput.value=wl(o).toFixed(0),this.elements.radiusInput.min="0",this.elements.radiusInput.max=String(Wi),this.elements.radiusInput.step="1"):(this.elements.radiusSlider.value=Ws(o),this.elements.radiusInput.value=Number(this.elements.radiusSlider.value).toFixed(2),this.elements.radiusInput.min="0",this.elements.radiusInput.max="1",this.elements.radiusInput.step="0.01"),this.elements.tensionSlider.value=Math.max(0,Math.min(1,a)),this.elements.tensionInput.value=Number(a).toFixed(2),this.elements.nurbsDegreeSlider.value=l,this.elements.nurbsDegreeInput.value=l}_renderAllPreviews(){Gr.forEach(t=>{const n=this.previewCards.get(t.id);n&&this._renderPreviewCard(n.canvas,t.id,t.id===this.state.style.preset)})}_renderPreviewCard(t,n,s){const i=t.getBoundingClientRect(),o=window.devicePixelRatio||1,a=Math.max(1,Math.floor(i.width*o)),r=Math.max(1,Math.floor(i.height*o));(t.width!==a||t.height!==r)&&(t.width=a,t.height=r);const c=t.getContext("2d");c.save(),c.scale(o,o),c.clearRect(0,0,i.width,i.height),c.fillStyle="#1f2937",c.fillRect(0,0,i.width,i.height),this._drawPreset(c,i.width,i.height,n,s),c.restore()}_drawPreset(t,n,s,i,o){const r=n-32,c=s-32,l=M=>({x:16+M.x*r,y:16+M.y*c}),d=this._getPresetPoints(i),h=o?"#3b82f6":"#6b7280",f=o?"#60a5fa":"#94a3b8";t.lineWidth=this._getStrokeWidth(),t.lineJoin=this.state.style.mode==="radius"?"round":"miter",t.lineCap="round",t.strokeStyle=h;const u=[],p=new Set,g=new Set,y=M=>{p.has(M)||(p.add(M),u.push(M))},m=this.state.style.mode==="radius"&&i==="branching",x=(M,w,O)=>{const T=O.x-w.x,A=O.y-w.y,L=M.x-w.x,B=M.y-w.y,F=T*T+A*A;return F<1e-6?0:(L*T+B*A)/F},S=M=>{if(!M)return 0;const w=Math.hypot(M.b.x-M.a.x,M.b.y-M.a.y);return w<=1e-6?0:this.state.style.radiusMode==="relative"?Math.max(0,Math.min(.5,this.state.style.radiusValue*.5)):Math.max(0,Math.min(.5,this.state.style.radiusValue/w))},I=(M,w,O,T,A)=>{if(M.length<3||!T)return M;const L=S(T),B=O?A?0:.5:L,F=O?1-L:A?1:.5,R=M.filter(N=>{if(N.tag==="line"&&N.edgeIndex!==void 0){if(N.edgeIndex!==w)return!0;const $=x(N,T.a,T.b);return $>=B&&$<=F}return N.tag!=="line"});return R.length>=2,R},b=d.faces&&d.vertices?d.vertices:null,v=d.faces||null,E=!!(b&&v&&v.length);let C=null,_=null;const P=Math.hypot(r,c);if(d.paths.forEach((M,w)=>{const O=M.points,T=O.map(l);if(O.forEach(y),w===0&&i==="closed"&&(console.groupCollapsed("anchor-control-debug"),console.log("mode",this.state.style.mode),console.log("type",this.state.style.type),console.log("pointHandling",this.state.style.pointHandling),console.log("radiusMode",this.state.style.radiusMode),console.log("radiusValue",this.state.style.radiusValue)),T.length>=2){t.save(),t.lineWidth=Math.max(1,this._getStrokeWidth()*.6),t.strokeStyle="#94a3b8",t.lineCap="round",t.lineJoin="round",t.setLineDash(Gc);const L=[];for(let B=0;B<T.length-1;B++)m&&i==="branching"&&w===0&&B===T.length-2||L.push([T[B],T[B+1]]);M.closed&&L.push([T[T.length-1],T[0]]),L.forEach(([B,F])=>{const R=Math.round(B.x),N=Math.round(B.y),$=Math.round(F.x),D=Math.round(F.y),k=`${R}:${N}`,V=`${$}:${D}`,G=k<V?`${k}|${V}`:`${V}|${k}`;g.has(G)||(g.add(G),t.beginPath(),t.moveTo(B.x,B.y),t.lineTo(F.x,F.y),t.stroke())}),t.restore()}let A=this._getInterpolatedPoints(T,M.closed,P);if(A.length<2){w===0&&i==="closed"&&(console.log("drawPoints empty"),console.groupEnd());return}if(w===0&&i==="closed"){const L=A.reduce((F,R)=>({x:Math.min(F.x,R.x),y:Math.min(F.y,R.y)}),{x:1/0,y:1/0}),B=A.reduce((F,R)=>({x:Math.max(F.x,R.x),y:Math.max(F.y,R.y)}),{x:-1/0,y:-1/0});console.log("drawPoints bounds",{min:L,max:B}),console.groupEnd()}if(m){const L=6+this.state.style.order*4,B=this.state.style.pointHandling==="control";A=Vr(T,M.closed,this.state.style.radiusMode,this.state.style.radiusValue,L,!1,!1,B,!0);const F=M.trueEndpointStart===!0,R=M.trueEndpointEnd===!0;if(w===0){const N=T.length>=2?{a:T[0],b:T[1]}:null;A=I(A,0,!0,N,F);const $=T.length>=2?{a:T[T.length-2],b:T[T.length-1]}:null;A=I(A,T.length-2,!1,$,R)}else{const N=T.length>=2?{a:T[0],b:T[1]}:null,$=T.length>=2?{a:T[T.length-2],b:T[T.length-1]}:null;A=I(A,0,!0,N,F),A=I(A,T.length-2,!1,$,R)}if(A.length<2)return;A=A.map(N=>({x:N.x,y:N.y}))}if(this.state.style.mode!=="radius"&&(this.state.style.type!=="spline"||M.forceTrim)){if(M.trimFromPoint){const L=l(M.trimFromPoint);let B=0,F=1/0;A.forEach((R,N)=>{const $=Math.hypot(R.x-L.x,R.y-L.y);$<F&&(F=$,B=N)}),A=A.slice(B),!A.length||Math.hypot(A[0].x-L.x,A[0].y-L.y)>1e-6?A.unshift(L):A[0]=L}if(M.trimToPoint){const L=l(M.trimToPoint);let B=0,F=1/0;A.forEach((R,N)=>{const $=Math.hypot(R.x-L.x,R.y-L.y);$<F&&(F=$,B=N)}),A=A.slice(0,B+1),!A.length||Math.hypot(A[A.length-1].x-L.x,A[A.length-1].y-L.y)>1e-6?A.push(L):A[A.length-1]=L}}if(!(A.length<2)){if(t.beginPath(),t.moveTo(A[0].x,A[0].y),A.slice(1).forEach(L=>t.lineTo(L.x,L.y)),M.closed&&(this.state.style.mode!=="radius"||this.state.style.radiusValue<=1e-6)&&t.closePath(),t.stroke(),M.isBoundary&&M.closed?(C=A,_=new Set(O)):!E&&i==="closed"&&M.closed&&!Object.prototype.hasOwnProperty.call(M,"isBoundary")&&(C=A),this.state.style.mode==="radius"&&this.state.style.pointHandling==="anchor"){const L=jc(T,M.closed,this.state.style.radiusMode,this.state.style.radiusValue);L.length&&(t.save(),t.fillStyle="#f87171",L.forEach(B=>{t.beginPath(),t.arc(B.x,B.y,3,0,Math.PI*2),t.fill()}),t.restore())}this.state.style.type==="linear"&&this.state.style.linearStyle==="arrows"&&this._drawEdgeArrows(t,T,M.closed)}}),C&&C.length>=2&&(t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)",t.beginPath(),t.moveTo(C[0].x,C[0].y),C.slice(1).forEach(M=>t.lineTo(M.x,M.y)),t.closePath(),t.fill(),t.restore()),E){t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)";let M=!1;v.forEach(w=>{if(!Array.isArray(w)||w.length<3)return;const O=w.map(B=>b[B]).filter(Boolean);if(O.length<3)return;const T=_?O.every(B=>_.has(B)):!1;if(T&&C&&!M){t.beginPath(),t.moveTo(C[0].x,C[0].y),C.slice(1).forEach(B=>t.lineTo(B.x,B.y)),t.closePath(),t.fill(),M=!0;return}if(T&&C)return;const A=O.map(l),L=this._getInterpolatedPoints(A,!0,P);!L||L.length<2||(t.beginPath(),t.moveTo(L[0].x,L[0].y),L.slice(1).forEach(B=>t.lineTo(B.x,B.y)),t.closePath(),t.fill())}),t.restore()}t.fillStyle=f,u.map(l).forEach(M=>{t.beginPath(),t.arc(M.x,M.y,3.5,0,Math.PI*2),t.fill()})}_getStrokeWidth(){return 2}_drawEdgeArrows(t,n,s){if(n.length<2)return;const i=10,o=6,a=n.length,r=s?a:a-1;t.save(),t.fillStyle=t.strokeStyle;for(let c=0;c<r;c++){const l=n[c],d=n[(c+1)%a],h=d.x-l.x,f=d.y-l.y,u=Math.hypot(h,f);if(u<.001)continue;const p=h/u,g=f/u,y=d,m={x:y.x-p*i,y:y.y-g*i},x={x:m.x+-g*(o/2),y:m.y+p*(o/2)},S={x:m.x+g*(o/2),y:m.y-p*(o/2)};t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(x.x,x.y),t.lineTo(S.x,S.y),t.closePath(),t.fill()}t.restore()}_getInterpolatedPoints(t,n,s=1){const{mode:i,order:o,type:a,pointHandling:r,nurbsDegree:c,radiusMode:l,radiusValue:d}=this.state.style;if(i==="radius"||t.length<2){if(i==="radius"){const u=6+o*4,p=d;return p<=1e-6?t:Vr(t,n,l,p,u,!1,!1,r==="control")}return t}const h=4+o*4;if(a==="linear"||o===1)return Kc(t,n,h);if(t.length<3)return t;const f=this.state.style.tension??.5;return Xr(t,f,n,h)}_buildControlCatmullTargets(t,n){if(t.length<2)return t;const s=[],i=t.length,o=n?i:i-1;n||s.push(t[0]);for(let a=0;a<o;a++){const r=t[a],c=t[(a+1)%i];s.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5})}return n||s.push(t[i-1]),s}_buildMixedCatmullTargets(t,n){if(t.length<2)return t;const s=this._getPathOrientation(t,n),i=[],o=t.length;for(let a=0;a<o;a++){if(!n&&(a===0||a===o-1)){i.push(t[a]);continue}const r=t[(a-1+o)%o],c=t[a],l=t[(a+1)%o],d=(c.x-r.x)*(l.y-c.y)-(c.y-r.y)*(l.x-c.x);(s>=0?d>=0:d<=0)?i.push(c):(i.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5}),i.push({x:(c.x+l.x)*.5,y:(c.y+l.y)*.5}))}return i}_buildMixedControlPoints(t,n,s){if(t.length<3)return t;const i=this._getPathOrientation(t,n),o=Math.max(0,s-1),a=[];n?t.length:t.length-1;for(let r=0;r<t.length;r++){const c=(r-1+t.length)%t.length,l=(r+1)%t.length,d=t[c],h=t[r],f=t[l],u=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),g=!n&&(r===0||r===t.length-1)||(i>=0?u>=0:u<=0);if(a.push(h),g)for(let y=0;y<o;y++)a.push({x:h.x,y:h.y})}return a}_getPathOrientation(t,n){if(!n)return 1;let s=0;for(let i=0;i<t.length;i++){const o=t[(i+1)%t.length];s+=t[i].x*o.y-o.x*t[i].y}return s}_getPresetPoints(t){const n=this.state.previewPoints[t];if(n&&n.vertices&&n.edges)return this._buildPathsFromGraph(n);if(t==="open")return{paths:this.state.previewPoints.open.map(s=>({closed:!1,points:s}))};if(t==="branching"){const s=this.state.previewPoints.branching[0]||[],i=s.length>=1?s[s.length-1]:null,o=s.length>=2?s[s.length-2]:null,a=this.state.style.type==="spline",r=a?s.slice(Math.max(0,s.length-3)):s.slice(Math.max(0,s.length-2));return{paths:this.state.previewPoints.branching.map((c,l)=>{if(l===0)return{closed:!1,points:c,trimToPoint:a?o:null,forceTrim:a,trueEndpointStart:!0,trueEndpointEnd:!1};const d=[...r],h=c[0],u=i&&h&&Math.abs(h.x-i.x)<1e-6&&Math.abs(h.y-i.y)<1e-6?c.slice(1):c;return d.push(...u),{closed:!1,points:d,trimFromPoint:a?o:i,forceTrim:a,trueEndpointStart:!1,trueEndpointEnd:!0}})}}if(t==="branching4"){const s=this.state.previewPoints.branching4;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[],a=d=>{const h=Math.hypot(d.x,d.y);return h>1e-6?{x:d.x/h,y:d.y/h}:{x:0,y:0}},r=i.map(d=>{if(d.length<2)return null;const h=d[d.length-1],f=d[d.length-2];return a({x:h.x-f.x,y:h.y-f.y})}),c=o.map(d=>{if(d.length<2)return null;const h=d[0],f=d[1];return a({x:f.x-h.x,y:f.y-h.y})});if(i.length!==1&&o.length!==1){const d=[];if(i.length===2&&o.length===2){const f=this.dragState?.presetId==="branching4"&&this.dragState.pointIndex!==null,u=P=>f?(this.branching4Pairing||(this.branching4Pairing=P),this.branching4Pairing):(this.branching4Pairing=null,P),p=r.map(P=>P?{x:-P.x,y:-P.y}:null),g=P=>Math.atan2(P.y,P.x),y=(P,M)=>{const w=p[P],O=c[M];return!w||!O?-1/0:w.x*O.x+w.y*O.y},m=(P,M)=>P.x*M.y-P.y*M.x,S=[{type:"in",idx:0,dir:p[0]},{type:"in",idx:1,dir:p[1]},{type:"out",idx:0,dir:c[0]},{type:"out",idx:1,dir:c[1]}].filter(P=>P.dir).slice().sort((P,M)=>g(P.dir)-g(M.dir)),I=S.map((P,M)=>P.type==="in"?M:null).filter(P=>P!==null),b=I.length===2&&(Math.abs(I[0]-I[1])===1||Math.abs(I[0]-I[1])===3),v=P=>y(0,P[0])+y(1,P[1]),E=[0,1],C=[1,0];let _=E;if(b){const P=(T,A)=>{const L=Math.abs(T-A);return Math.min(L,4-L)},M=T=>S.findIndex(A=>A.type==="out"&&A.idx===T),w=T=>S.findIndex(A=>A.type==="in"&&A.idx===T),O=T=>{const A=P(w(0),M(T[0])),L=P(w(1),M(T[1]));return A+L};_=O(C)>O(E)?C:E}else{const P=v(E),M=v(C);if(M===P&&this.state.style.type==="spline"){const w=O=>{const T=p[0]&&c[O[0]]?Math.sign(m(p[0],c[O[0]])):0,A=p[1]&&c[O[1]]?Math.sign(m(p[1],c[O[1]])):0;return(T<0?1:0)+(A<0?1:0)};_=w(C)>w(E)?C:E}else _=M>P?C:E}return _=u(_),i.forEach((P,M)=>{const w=_[M],O=o[w],T=O[0]===P[P.length-1]?O.slice(1):O;d.push({closed:!1,points:[...P,...T]})}),{paths:d}}const h=new Set;return i.forEach((f,u)=>{let p=-1,g=-1/0;const y=r[u];if(o.forEach((m,x)=>{if(h.has(x))return;const S=c[x];if(!y||!S)return;const I=y.x*S.x+y.y*S.y;I>g&&(g=I,p=x)}),p>=0){h.add(p);const m=o[p],x=m[0]===f[f.length-1]?m.slice(1):m;d.push({closed:!1,points:[...f,...x]})}else d.push({closed:!1,points:f})}),o.forEach((f,u)=>{h.has(u)||d.push({closed:!1,points:f})}),{paths:d}}const l=[];return i.length===1?o.forEach(d=>{const h=i[0],f=d[0]===h[h.length-1]?d.slice(1):d;l.push({closed:!1,points:[...h,...f]})}):i.forEach(d=>{const h=o[0],f=h[0]===d[d.length-1]?h.slice(1):h;l.push({closed:!1,points:[...d,...f]})}),{paths:l}}if(t==="branching5"){const s=this.state.previewPoints.branching5;if(!s)return{paths:[]};const i=s.in||[],o=s.out||[];return{paths:[...i.map(r=>({closed:!1,points:r})),...o.map(r=>({closed:!1,points:r}))]}}return{paths:[{closed:!0,points:this.state.previewPoints.closed[0]}]}}_buildPathsFromGraph(t){const n=t.vertices||[],s=t.edges||[];if(!n.length||!s.length)return{paths:[]};const i=new Map,o=new Map,a=new Map;s.forEach(([D,k])=>{i.has(D)||i.set(D,[]),i.get(D).push(k),o.has(k)||o.set(k,[]),o.get(k).push(D),a.set(D,(a.get(D)||0)+1),a.set(k,(a.get(k)||0)+1)});const r=new Map,c=new Map,l=(D,k)=>D<k?`${D}-${k}`:`${k}-${D}`;s.forEach(([D,k])=>{const V=l(D,k);c.has(V)||c.set(V,[D,k]),r.has(D)||r.set(D,new Set),r.has(k)||r.set(k,new Set),r.get(D).add(k),r.get(k).add(D)});const d=(D,k)=>Math.atan2(n[k].y-n[D].y,n[k].x-n[D].x),h=new Map;n.forEach((D,k)=>{const V=[...r.get(k)||[]];V.sort((G,X)=>d(k,G)-d(k,X)),h.set(k,V)});const f=(D,k)=>{const V=h.get(k)||[];if(!V.length)return null;const G=V.indexOf(D);return G<0?V[0]:V[(G-1+V.length)%V.length]},p=(()=>{const D=[],k=new Set,V=(G,X)=>`${G}->${X}`;return c.forEach(([G,X])=>{[[G,X],[X,G]].forEach(([H,Y])=>{const W=V(H,Y);if(k.has(W))return;const J=[];let ee=H,oe=Y,ye=0;for(;ye++<s.length*4;){k.add(V(ee,oe)),J.push(ee);const qe=f(ee,oe);if(qe==null)break;const ke=oe,et=qe;if(ee=ke,oe=et,ee===H&&oe===Y)break}J.length>=3&&D.push(J)})}),D})(),g=D=>[...D].sort((k,V)=>k-V).join("_"),y=[],m=new Set;p.forEach(D=>{const k=g(D);m.has(k)||(m.add(k),y.push(D))});const x=D=>{let k=0;for(let V=0;V<D.length;V++){const G=n[D[V]],X=n[D[(V+1)%D.length]];k+=G.x*X.y-X.x*G.y}return k*.5};let S=null;if(y.length){let D=null,k=-1/0;y.forEach(V=>{const G=Math.abs(x(V));G>k&&(k=G,D=V)}),S=D}const I=new Set(S||[]),b=new Set;if(S&&S.length>=2)for(let D=0;D<S.length;D++){const k=S[D],V=S[(D+1)%S.length];b.add(l(k,V))}const v=new Map,E=D=>Math.atan2(D.y,D.x),C=(D,k)=>D.x*k.y-D.y*k.x,_=(D,k)=>D.x*k.x+D.y*k.y,P=(D,k)=>({x:k.x-D.x,y:k.y-D.y}),M=D=>{const k=Math.hypot(D.x,D.y);return k>1e-6?{x:D.x/k,y:D.y/k}:{x:0,y:0}};n.forEach((D,k)=>{if(I.has(k))return;const V=o.get(k)||[],G=i.get(k)||[];if(V.length===2&&G.length===2){const X=V.map(be=>M(P(n[be],n[k]))),H=G.map(be=>M(P(n[k],n[be]))),Y=X.map(be=>({x:-be.x,y:-be.y})),W=(be,nt)=>_(Y[be],H[nt]),J=[0,1],ee=[1,0],oe=W(0,0)+W(1,1),ye=W(0,1)+W(1,0),ke=[{type:"in",idx:0,dir:Y[0]},{type:"in",idx:1,dir:Y[1]},{type:"out",idx:0,dir:H[0]},{type:"out",idx:1,dir:H[1]}].filter(be=>be.dir).slice().sort((be,nt)=>E(be.dir)-E(nt.dir)),et=ke.map((be,nt)=>be.type==="in"?nt:null).filter(be=>be!==null),at=et.length===2&&(Math.abs(et[0]-et[1])===1||Math.abs(et[0]-et[1])===3);let tt=J;if(at){const be=(Cn,gn)=>{const Jo=Math.abs(Cn-gn);return Math.min(Jo,4-Jo)},nt=Cn=>ke.findIndex(gn=>gn.type==="out"&&gn.idx===Cn),kt=Cn=>ke.findIndex(gn=>gn.type==="in"&&gn.idx===Cn),Ys=Cn=>{const gn=be(kt(0),nt(Cn[0])),Jo=be(kt(1),nt(Cn[1]));return gn+Jo};tt=Ys(ee)>Ys(J)?ee:J}else if(ye===oe&&this.state.style.type==="spline"){const be=nt=>{const kt=Math.sign(C(Y[0],H[nt[0]])),Ys=Math.sign(C(Y[1],H[nt[1]]));return(kt<0?1:0)+(Ys<0?1:0)};tt=be(ee)>be(J)?ee:J}else tt=ye>oe?ee:J;V.forEach((be,nt)=>{const kt=G[tt[nt]];v.set(`${be}->${k}`,kt)})}});const w=n.map((D,k)=>k).filter(D=>(o.get(D)||[]).length===0),O=[],T=new Set,A=(D,k)=>`${D}->${k}`,L=(D,k)=>b.has(l(D,k)),B=(D,k,V,G=!1)=>{const X=A(D,k);if(T.has(X)){O.push([...V,k]);return}T.add(X);const H=[...V,k];if(!G&&I.has(k)&&H.length>1){O.push(H);return}const Y=i.get(k)||[],W=o.get(k)||[],J=v.get(`${D}->${k}`);if(J!==void 0){if(H.includes(J)){O.push(H);return}B(k,J,H);return}if(Y.length===0){O.push(H);return}if(W.length===2&&Y.length>2){O.push(H);return}if(W.length===1&&Y.length>1){Y.forEach(ee=>{!G&&L(k,ee)||B(k,ee,H,G)});return}if(W.length<=1&&Y.length===1){if(!G&&L(k,Y[0])){O.push(H);return}B(k,Y[0],H,G);return}Y.forEach(ee=>{!G&&L(k,ee)||B(k,ee,H,G)})};let F=null;if(S&&S.length>=3)F=[...S,S[0]],O.push(F),s.forEach(([D,k])=>{L(D,k)&&T.add(A(D,k))}),s.forEach(([D,k])=>{const V=A(D,k);T.has(V)||B(D,k,[D],!1)});else if(w.length)w.forEach(D=>{(i.get(D)||[]).forEach(V=>B(D,V,[D]))});else{const D=s[0]?.[0];D!==void 0&&(i.get(D)||[]).forEach(V=>B(D,V,[D]))}const R=O.map(D=>{const k=D.length>2&&D[0]===D[D.length-1],V=k?D.slice(0,-1):D,G=V.map(ee=>n[ee]),X=V[0],H=V[V.length-1],Y=a.get(X)||0,W=a.get(H)||0,J=D===F;return{closed:k,points:G,isBoundary:J,trueEndpointStart:Y===1,trueEndpointEnd:W===1,trimFromPoint:!J&&this.state.style.type==="spline"&&Y>2?n[X]:null,trimToPoint:!J&&this.state.style.type==="spline"&&W>2?n[H]:null,forceTrim:!J&&this.state.style.type==="spline"}}),N=S?g(S):null,$=y.filter(D=>g(D)!==N);return{paths:R,vertices:n,faces:$}}_handlePreviewMouseDown(t,n){const s=this._findHitPoint(t,n);s&&(this.dragState=s,t.preventDefault())}_handlePreviewMouseMove(t){const{presetId:n,pathIndex:s,pointIndex:i,vertexIndex:o,ioType:a,ioIndex:r}=this.dragState;if(n===null)return;const c=this.previewCards.get(n);if(!c)return;const{x:l,y:d}=this._getNormalizedPoint(t,c.canvas),h={x:Math.max(0,Math.min(1,l)),y:Math.max(0,Math.min(1,d))},f=this.state.previewPoints[n];if(f&&f.in&&f.out&&a&&Number.isInteger(r)){const x=f[a]?.[r]?.[i];x&&(x.x=h.x,x.y=h.y,this._renderAllPreviews());return}if(f&&f.vertices&&f.edges){Number.isInteger(o)&&f.vertices[o]&&(f.vertices[o].x=h.x,f.vertices[o].y=h.y,f.pathOverrides&&delete f.pathOverrides,this._renderAllPreviews());return}const p=(f&&f.vertices&&f.edges?f.pathOverrides?.map(y=>y.points):this.state.previewPoints[n])?.[s];if(!p)return;const g=p[i];g?(g.x=h.x,g.y=h.y):p[i]=h,this._renderAllPreviews()}_handlePreviewMouseUp(){this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}_findHitPoint(t,n){const s=this.previewCards.get(n);if(!s)return null;const o=s.canvas.getBoundingClientRect(),a=t.clientX-o.left,r=t.clientY-o.top,c=16,l=o.width-c*2,d=o.height-c*2,h=8,f=this.state.previewPoints[n];if(f&&f.in&&f.out){const p=[...f.in.map((g,y)=>({points:g,ioType:"in",ioIndex:y})),...f.out.map((g,y)=>({points:g,ioType:"out",ioIndex:y}))];for(let g=0;g<p.length;g++){const{points:y,ioType:m,ioIndex:x}=p[g];for(let S=0;S<y.length;S++){const I=c+y[S].x*l,b=c+y[S].y*d;if(Math.hypot(a-I,r-b)<=h)return{presetId:n,pathIndex:g,pointIndex:S,vertexIndex:null,ioType:m,ioIndex:x}}}return null}const u=f&&f.vertices&&f.edges?this._getPresetPoints(n).paths.map(p=>p.points):this.state.previewPoints[n];for(let p=0;p<u.length;p++){const g=u[p];for(let y=0;y<g.length;y++){const m=c+g[y].x*l,x=c+g[y].y*d;if(Math.hypot(a-m,r-x)<=h){let S=null;return f&&f.vertices&&f.edges&&(S=f.vertices.indexOf(g[y]),S<0&&(S=null)),{presetId:n,pathIndex:p,pointIndex:y,vertexIndex:S,ioType:null,ioIndex:null}}}}return null}_getNormalizedPoint(t,n){const s=n.getBoundingClientRect(),i=16,o=s.width-i*2,a=s.height-i*2,r=(t.clientX-s.left-i)/o,c=(t.clientY-s.top-i)/a;return{x:r,y:c}}}function Eo(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Qc(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,s=[];let i=0,o;for(;(o=n.exec(t))!==null;){const c=o[0],l=o.index;l>i&&s.push({type:"text",content:t.substring(i,l)}),c==="\\$"?s.push({type:"text",content:"$"}):s.push({type:"math",content:c}),i=l+c.length}i<t.length&&s.push({type:"text",content:t.substring(i)});const a=[];let r=null;for(const c of s)c.type==="text"?r===null?r={type:"text",content:c.content}:r.content+=c.content:(r!==null&&(a.push(r),r=null),a.push(c));return r!==null&&a.push(r),a.length===0&&s.length===1&&s[0].type==="text"?s:a}function ed(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let s=null,i=!1;if(t&&t[1]?.trim()?(s=t[1].trim(),i=!0):n&&n[1]?.trim()&&(s=n[1].trim(),i=!1),s===null)return`<span class="text-segment">${Eo(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(s,{throwOnError:!1,displayMode:i,output:"html",strict:"warn"})}catch(o){return console.error("KaTeX renderToString unexpected error:",o),`<span class="katex-error" title="${Eo(o.message||"Unknown KaTeX error")}">${Eo(e)}</span>`}}function wa(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const s=t==null?"":String(t);let i="";try{i=Qc(s).map(a=>a.type==="text"?`<span class="text-segment">${Eo(a.content)}</span>`:a.type==="math"?ed(a.content):"").join("")}catch(o){console.error("Error processing string segments for rendering:",o,s),i=`<span class="katex-error" title="${Eo(String(o.message||"Unknown error"))}">Error</span>`}e.innerHTML=i}function Pa(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const s=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let i;const o=[];for(s.lastIndex=0;(i=s.exec(e))!==null;){const[,f,u,p,g,y,m,x,S,I,b,v]=i;let E={};if(f){const C=f.split("_"),_=C[0].slice(1),P=C[1].slice(1);E={type:"backslashSubscript",value:`\\mathrm{${_}}_\\mathrm{${P}}`}}else if(u)E={type:"doubleBackslash",value:"\\\\"};else if(p)E={type:"command",value:p};else if(g)E={type:"backslashLetter",value:g.slice(1)};else if(y){E={type:"word",value:y};const C=o[o.length-1],_=o[o.length-2],P=C?.type==="other"&&C.value==="{"&&_?.type==="command";E.isArgument=P}else m?E={type:"number",value:m}:x?E={type:"dollar",value:"\\$"}:S?E={type:"ampersand",value:"&"}:I?E={type:"space",value:" "}:b?E={type:"newline",value:"\\\\"}:v&&(E={type:"other",value:v});E.type&&o.push(E)}const a=["a","I"],r=["+","-","=","*","/","<",">"],c=(f,u)=>{let p=f+u;for(;p>=0&&p<o.length;){if(o[p].type!=="space")return o[p];p+=u}return null},l=f=>f?f.type==="other"&&r.includes(f.value):!1,d=f=>f?f.type==="backslashLetter"||f.type==="word"&&f.value.length===1&&!a.includes(f.value):!1;let h="";for(let f=0;f<o.length;f++){const u=o[f];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":h+=u.value;break;case"other":["#","%"].includes(u.value)?h+="\\"+u.value:h+=u.value;break;case"backslashLetter":h+=u.value;break;case"word":if(u.isArgument)h+=u.value;else if(u.value.length>1)h+=`\\mathrm{${u.value}}`;else{const x=o[f-1],S=o[f-2],I=x?.type==="other"&&x.value==="(",b=I&&S?.type==="space",v=I&&S?.type!=="space",E=c(f,-1),C=c(f,1),_=l(E)||l(C);b?h+=`\\mathrm{${u.value}}`:a.includes(u.value)?_||v?h+=u.value:h+=`\\mathrm{${u.value}}`:h+=u.value}break;case"space":let g=!0;const y=c(f,-1),m=c(f,1);if(!y||!m)g=!0;else{const x=d(y),S=d(m),I=l(y),b=l(m);(I||b)&&(g=!1),x&&S&&(g=!1)}h+=g?"\\ ":" ";break;default:h+=u.value;break}}if(h.endsWith("\\ ")){const f=h.match(/(\\ )+$/);if(f){const u=f[0].length/2,p="\\,".repeat(u);h=h.replace(/(\\ )+$/,p)}}return h===""?"":`$$${h}$$`}const td={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},nd={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},Hr=5,vo=25,Aa=20,sd=20,od=.1,Pl=[1/4,1/3,1/2,2/3,3/4],_a=4,$s=30,Ve=5,Ki=$s/2,Qa=10,ys=2,Gn=1,Vn=[6,6],Al=[3,3],ha=360,Co=180,_l=90,Ye=2*Math.PI,qi=.01,er=Math.sqrt(3)/2,id=400,ad=Math.PI/3,rd=1.5,rn=Math.PI/6,ld=1.5,cd=[2,3],dd=[1,3],hd=.01,fd=8,ud=5,gd=Math.PI/24,pd=15,ao="_EDGE_",Si=300,yd=3,tr=7,zr=1e-15,Wr=1e13,Kr=1.15,md=1e-5,xd=1-1e-5,nr=.001,Dl=.01,Sd=.95,Id=100,bd=1.5,vd=.5,Md=1.5,rt=4,Ii=.9,ms=24,xs=10,es=8,Pt=20,Re=12,Da=5,ka=20,Ra=10,La=5,fa=20,ua=12,Ed="\\phantom{-}0",ri="i",ei="r",Cd="\\mathrm{Re}",Td="\\mathrm{Im}",wd=80,Oa=1,ga=Math.PI/2,Pd="#808080",Ks="rgba(128, 128, 128, 1)",Ad=4,_d=.25,Ze=10,Ne=56,Vo=35,qr=10,Dd=36,kd=30,Mt=40,Rd=20,mo=32,sr=2,_n=1.5,pa=[2,4],Xn=1.5,or=10,kl=3,xo=15,Ld=4,Na=1,jr=12,Od=6,Nd=2,Fd=24,Bd="T",$d=12,Vd=10,Xd=10,Yd=3,Rn=2,To=2,tn=7,ya=30,ji=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],ma=4,xn=12,ro=30,ts=18,dn=1,Rl=1.5,Fa=11,bi=18,vi=60,Ll=20,Ol=8,Gd=20,Ur=18,Ba=1e6,$a=1e-6,Mi=1e-5,Ss=.015,qs=32,Hd=10,Jr=16,zd=12,Wd=14,Hs="\\hphantom{-}",Lt="\\pi",Zr="\\delta = ",bo="\\theta = ",ir=15,Cs=.8,Ei=3,ls=2,Kd=1,qd=3,jd=1,Ud=140,Qr=.4,Jd=.9,ti=.05,Zd=10,el=1.5,xa=[15,5,1],tl=80,Qd=.01,le=1e-9,ar=50,eh=6,th=10,rr=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let s=1;s<=n*4;s++)e.add(s/n);return Array.from(e).sort((n,s)=>n-s)})();function nh(e,t){const n=new Set;n.add(0);for(let s=1;s<=e;s++)for(let i=1;i<=s*t;i++)n.add(i/s);return Array.from(n).sort((s,i)=>s-i)}const ss=nh(eh,th),Hn="regular",un=" transformation_rotation",Un=" transformation_scale",In="transformation_rotate_scale",us="transformation_directional_scale",Ui="none",lr="regular",ko="complex",Ji="polar",Xo="none",cr="lines",dr="points",hr="triangular",fr="polar",Ts="degrees",Yo="radians",Ro="none",Lo="on",sh="none",oh=" ",ih="Escape",ah="Delete",rh="Backspace",lh="r",nl="=",sl="+",ol="-",il="c",al="v",rl="x",Sa="z",ll="y",cl="a",Ge="vertex",Ue="edge",ot="face",Ft="text",ch=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],dh=(e,t)=>{if(e.length<2)return[];const n=e.length,s=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),o=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[s(l)]:l<0?i():l>=n?o():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c},dl=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},hl=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),hh=(e,t)=>{const n=Math.PI*2;let s=(t-e)%n;return s<0&&(s+=n),s>Math.PI&&(s-=n),s},wo=(e,t=!1)=>{const n=[],s=e.length,i=t?s:s-1;for(let o=0;o<i;o++)n.push({type:"line",a:e[o],b:e[(o+1)%s]});return n},fh=(e,t=!1,n=.5)=>{const i=(1-Math.max(0,Math.min(1,n)))*.5,o=ch(i),a=[];return dh(e,t).forEach(({p0:c,p1:l,p2:d,p3:h})=>{const f=[c.x,l.x,d.x,h.x],u=[c.y,l.y,d.y,h.y],p=o.map(y=>y.reduce((m,x,S)=>m+x*f[S],0)),g=o.map(y=>y.reduce((m,x,S)=>m+x*u[S],0));a.push({type:"cubic",coeffX:p,coeffY:g})}),a},uh=(e,t,n,s)=>{if(e.length<2||s<=1e-6)return wo(e,t);const i=e.length,o=n==="fixed"?"absolute":n,a=[],r=l=>{const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=hl(d,h),p=hl(f,h),g=Math.hypot(u.x,u.y),y=Math.hypot(p.x,p.y);if(g<=1e-6||y<=1e-6)return null;const m=Math.min(g,y)*.5;let x,S,I;if(o==="absolute"?(x=Math.max(0,Math.min(s,m))*2,S=dl(p),I=dl(u)):(x=Math.max(0,Math.min(1,s)),S=p,I=u),x<=1e-6)return null;const b=x*.5,v=o==="absolute"?g*.5:.5,E=o==="absolute"?y*.5:.5,C={x:h.x+I.x*v,y:h.y+I.y*v},_={x:h.x+S.x*E,y:h.y+S.y*E},P={x:h.x+I.x*b,y:h.y+I.y*b},M={x:h.x+S.x*b,y:h.y+S.y*b},w=Math.PI,O=-Math.PI/2,T=hh(w,O);return{origin:h,axisX:S,axisY:I,baseScale:x,midIn:C,midOut:_,arcStart:P,arcEnd:M,startAngle:w,sweep:T}};if(t){const l=[];for(let d=0;d<i;d++){const h=r(d);h&&l.push(h)}return l.length?(a.push({type:"line",a:l[0].midIn,b:l[0].arcStart}),l.forEach(d=>{a.push({type:"affineArc",origin:d.origin,axisX:d.axisX,axisY:d.axisY,baseScale:d.baseScale,startAngle:d.startAngle,sweep:d.sweep}),a.push({type:"line",a:d.arcEnd,b:d.midOut})}),a.push({type:"line",a:l[l.length-1].midOut,b:l[0].midIn}),a):wo(e,!0)}const c=[];for(let l=1;l<i-1;l++){const d=r(l);d&&c.push(d)}return c.length?(a.push({type:"line",a:e[0],b:c[0].midIn}),c.forEach(l=>{a.push({type:"line",a:l.midIn,b:l.arcStart}),a.push({type:"affineArc",origin:l.origin,axisX:l.axisX,axisY:l.axisY,baseScale:l.baseScale,startAngle:l.startAngle,sweep:l.sweep}),a.push({type:"line",a:l.arcEnd,b:l.midOut})}),a.push({type:"line",a:c[c.length-1].midOut,b:e[i-1]}),a):wo(e,!1)};function gh(e,t,n=!1){return!t||e.length<2?[]:t.type==="linear"?wo(e,n):t.type==="cubic_spline"?fh(e,n,t.tension??.5):t.type==="circular_arc"?uh(e,n,t.radiusMode??"relative",t.radiusValue??0):wo(e,n)}function ph(e,t){const n=[];return e.forEach((s,i)=>{const o=(a,r=!1)=>{i>0,n.push(a)};if(s.type==="line"){const a=s.a,r=s.b,c=t?t(a):a,l=t?t(r):r,d=Math.hypot(l.x-c.x,l.y-c.y),h=Math.max(2,Math.ceil(d/8));for(let f=0;f<=h;f++){const u=f/h;o({x:a.x+(r.x-a.x)*u,y:a.y+(r.y-a.y)*u},f===0)}return}if(s.type==="cubic"){const a=s.coeffX,r=s.coeffY,c=g=>({x:((a[0]*g+a[1])*g+a[2])*g+a[3],y:((r[0]*g+r[1])*g+r[2])*g+r[3]}),l=c(0),d=c(1),h=t?t(l):l,f=t?t(d):d,u=Math.hypot(f.x-h.x,f.y-h.y),p=Math.max(4,Math.ceil(u/6));for(let g=0;g<=p;g++){const y=g/p;o(c(y),g===0)}return}if(s.type==="affineArc"){const{origin:a,axisX:r,axisY:c,baseScale:l,startAngle:d,sweep:h}=s,f=l*.5,u={x:f,y:f},p=24;for(let g=0;g<=p;g++){const y=g/p,m=d+h*y,x={x:u.x+Math.cos(m)*f,y:u.y+Math.sin(m)*f};o({x:a.x+r.x*x.x+c.x*x.y,y:a.y+r.y*x.x+c.y*x.y},g===0)}}}),n}function lo(e,t,n=!1,s=null){const i=gh(e,t,n);return i.length?ph(i,s):e}function ft(e,t,n=!1){if(e===0)return"0";const s=Math.abs(e),i=e<0?"-":"";let o;if(n||s>=Ba||s!==0&&s<$a){if(e===0)return"0";const r=s.toExponential(Math.max(0,t-1)).split("e");let c=parseFloat(r[0]).toString(),l=parseInt(r[1],10);o=`${c} \\cdot 10^{${l}}`}else{const a=s<1?0:Math.floor(Math.log10(s))+1;let r;if(s===0)r=t-1;else if(s<1){let d=0,h=s;for(;h<1&&d<t+5;)h*=10,d++;r=Math.max(0,d-1+t)}else r=Math.max(0,t-a);let c=s.toFixed(r),l=parseFloat(c);if(Math.abs(l)===0&&e!==0)return"0";o=Math.abs(l).toString()}return i+o}function ur(e,t){return t===0?e:ur(t,e%t)}function ne(e){return e.id1<e.id2?`${e.id1}${ao}${e.id2}`:`${e.id2}${ao}${e.id1}`}function ni(e,t,n,s,i,o){const a=i-n,r=o-s,c=a*a+r*r;if(c===0){const p=e-n,g=t-s;return Math.sqrt(p*p+g*g)}let l=-((n-e)*a+(s-t)*r)/c;l<0&&(l=0),l>1&&(l=1);const d=n+l*a,h=s+l*r,f=e-d,u=t-h;return Math.sqrt(f*f+u*u)}function ce(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function cs(e,t,n,s,i=!1){const o=[];if(t==="none"||!n||n<=0)return o;if(t==="polar"){const a=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,r=Math.hypot(e.x,e.y),c=Math.round(r/n)*n;s.forEach(l=>{if(l.alpha>.01&&l.angle>0){const d=l.angle,f=Math.round(a/d)*d*Math.PI/180;o.push({x:c*Math.cos(f),y:c*Math.sin(f),isGridPoint:!0})}})}else if(t==="triangular"){const a=n*er,r=e.x/n-e.y/(n*Math.sqrt(3)),c=e.y/a;let l=Math.round(r),d=Math.round(c),h=Math.round(-r-c);const f=Math.abs(l-r),u=Math.abs(d-c),p=Math.abs(h-(-r-c));f>u&&f>p?l=-d-h:u>p&&(d=-l-h);const g=l*n+d*n/2,y=d*a;o.push({x:g,y,isGridPoint:!0})}else if(i){const a=Math.floor(e.x/n)*n,r=Math.floor(e.y/n)*n;o.push({x:a,y:r,isGridPoint:!0},{x:a+n,y:r,isGridPoint:!0},{x:a,y:r+n,isGridPoint:!0},{x:a+n,y:r+n,isGridPoint:!0})}else o.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return o}function zt(){return crypto.randomUUID()}function On(e){for(;e<0;)e+=Ye;for(;e>=Ye;)e-=Ye;return e}function fl(e,t,n=0){let s=t-e,i=Math.round((n-s)/(2*Math.PI));return s+i*(2*Math.PI)}function ct(e){return e=On(e),e>Math.PI&&(e-=Ye),e}function yh(e){for(;e<0;)e+=ha;for(;e>=ha;)e-=ha;return e}function gr(e,t){const{p1:n,p2:s}=e,{center:i,radius:o}=t,a={x:s.x-n.x,y:s.y-n.y},r={x:n.x-i.x,y:n.y-i.y},c=a.x*a.x+a.y*a.y,l=2*(r.x*a.x+r.y*a.y),d=r.x*r.x+r.y*r.y-o*o;let h=l*l-4*c*d;if(h<0)return[];h=Math.sqrt(h);const f=(-l-h)/(2*c),u=(-l+h)/(2*c);return[{x:n.x+f*a.x,y:n.y+f*a.y},{x:n.x+u*a.x,y:n.y+u*a.y}]}function Is(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let s=2;s*s<=n;s++)for(;n%(s*s)===0;)n/=s*s,t*=s;return[t,n]}function bs(e,t,n=""){const s=n?`\\${n}`:"";return t===1?e===1&&n?s:`${e}${s}`:e===1?`\\sqrt{${t}}${s}`:`${e}\\sqrt{${t}}${s}`}function Q(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function ln(e,t=Ss,n=qs){if(Math.abs(e)<Mi)return"0";const s=e<0?"-":"",i=Math.abs(e);if(Math.abs(i-Math.round(i))<t){const r=Math.round(i);return s+r.toString()}const o=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[r,c]of o)if(c<=n&&Math.abs(i-r/c)<t)return s+`${r}/${c}`;for(let r=1;r<=n;r++){const c=Math.round(i*r);if(!(c===0&&i>Mi)&&Math.abs(i-c/r)<t/r){const l=ur(c,r),d=c/l,h=r/l;return h===1?s+`${d}`:s+`${d}/${h}`}}let a=2;return i<.01?a=3:i<.1?a=2:i<10?a=1:a=0,s+i.toFixed(a)}function ws(e,t){if(t.length<3)return!1;const n=e.x,s=e.y;let i=!1;for(let o=0,a=t.length-1;o<t.length;a=o++){const r=t[o].x,c=t[o].y,l=t[a].x,d=t[a].y;if(r===n&&c===s||c===d&&c===s&&n>=Math.min(r,l)&&n<=Math.max(r,l)||r===l&&r===n&&s>=Math.min(c,d)&&s<=Math.max(c,d))return!0;c>s!=d>s&&n<(l-r)*(s-c)/(d-c)+r&&(i=!i)}return i}function Ps(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function mh(e,t,n){const s=t.localCoordSystem;if(!s)return null;const i=n(s.origin),o=fd;if(Q(e,i)<o)return{face:t,type:"center"};const a=ud,r=zn({x:1,y:0},s),c=n(r);if(Tt(e,i,c).distance<a)return{face:t,type:"x_axis"};const d=zn({x:0,y:1},s),h=n(d);return Tt(e,i,h).distance<a?{face:t,type:"y_axis"}:null}function co(e,t){if(ws(e,t))return e;let n=e,s=1/0;for(let i=0;i<t.length;i++){const o=t[i],a=t[(i+1)%t.length],r=Tt(e,o,a);r.distance<s&&(s=r.distance,n={x:r.x,y:r.y})}return n}function Nl(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:s,isColorModePanelExpanded:i,isInterpolationPanelExpanded:o,isTransformPanelExpanded:a,isDisplayPanelExpanded:r,isVisibilityPanelExpanded:c,isSessionsPanelExpanded:l}){const d=(h,f)=>f?h.x>=f.x&&h.x<=f.x+f.width&&h.y>=f.y&&h.y<=f.y+f.height:!1;if(s){for(const h of t.colorTargetIcons||[])if(d(e,h))return{...h,type:"colorTargetIcon"};for(const h of t.colorSwatches||[])if(d(e,h))return{...h,type:"colorSwatch"};if(d(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(d(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(d(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(d(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(i){for(const h of t.colorModeIcons||[])if(d(e,h))return{...h,type:"colorModeIcon"}}if(a){for(const h of t.transformIcons||[])if(d(e,h))return{...h,type:"transformIcon"}}if(o){for(const h of t.interpolationIcons||[])if(d(e,h))return{...h,type:"interpolationIcon"}}if(r){for(const h of t.displayIcons||[])if(d(e,h))return{...h,type:"displayIcon"}}if(c){for(const h of t.visibilityIcons||[])if(d(e,h))return{...h,type:"visibilityIcon"}}if(l){for(const h of t.sessionIcons||[])if(d(e,h))return{...h,type:"sessionIcon"};if(d(e,t.removeSessionButton))return{...t.removeSessionButton,type:"button"};if(d(e,t.addSessionButton))return{...t.addSessionButton,type:"button"}}if(n){if(d(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(d(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(d(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(d(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(d(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(d(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"};if(d(e,t.sessionsToolButton))return{...t.sessionsToolButton,type:"toolButton"};if(d(e,t.colorModeToolButton))return{...t.colorModeToolButton,type:"toolButton"}}return d(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function xh(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function Tt(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y,distance:Q(e,t),onSegmentStrict:!0,t:0};let c=(o*s+a*i)/r;const l=c>md&&c<xd,d=Math.max(0,Math.min(1,c)),h=t.x+d*s,f=t.y+d*i,u=Q(e,{x:h,y:f});return{x:h,y:f,distance:u,onSegmentStrict:l,t:d}}function Fl(e,t,n){const s=n.x-t.x,i=n.y-t.y,o=e.x-t.x,a=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y,distance:Q(e,t)};let c=(o*s+a*i)/r;const l=t.x+c*s,d=t.y+c*i,h=Q(e,{x:l,y:d});return{x:l,y:d,distance:h}}function Qs(e,t={},n=0){if(!e||typeof e!="string")return n;const s=e.trim();if(!s)return n;try{const i={...t},o=Object.keys(i),a=o.map(l=>i[l]),c=new Function(...o,`'use strict'; return (${s});`)(...a);return Number.isFinite(c)?c:n}catch{return n}}function So(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function Ia(e,t,n){e/=255,t/=255,n/=255;const s=Math.max(e,t,n),i=Math.min(e,t,n);let o,a,r=(s+i)/2;if(s===i)o=a=0;else{const c=s-i;switch(a=r>.5?c/(2-s-i):c/(s+i),s){case e:o=(t-n)/c+(t<n?6:0);break;case t:o=(n-e)/c+2;break;case n:o=(e-t)/c+4;break}o/=6}return[o,a,r]}function Sh(e,t,n,s,i=null){const o=Math.atan2(e.y-t.y,e.x-t.x);if(!s)return{angle:o,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=gd;let r={angle:o,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},l=(h,f,u=null,p=null)=>{const g=ct(h),y=Math.abs(ct(o-g));if(y<a){const m=c[f],x=r.snapType?c[r.snapType]:1/0;m<x?r={angle:g,difference:y,edgeIndex:u,snapType:f,targetVertexId:p}:m===x&&y<r.difference&&(r={angle:g,difference:y,edgeIndex:u,snapType:f,targetVertexId:p})}};return s.edgeAngles&&s.edgeAngles.forEach((h,f)=>{[h,h+Math.PI/2,h-Math.PI/2,h+Math.PI].forEach(u=>{l(u,"edge",f)})}),s.vertices&&s.vertices.forEach(h=>{if(Q(t,h)>le){const f=Math.atan2(h.y-t.y,h.x-t.x);l(f,"vertex_direction",null,h.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(h=>l(h,"cardinal")),{angle:r.angle,edgeIndex:r.edgeIndex,snapType:r.snapType,snapped:r.difference<1/0,targetVertexId:r.targetVertexId}}function Ih(e,t,n,s,i,o=null,a=null,r="x_axis"){if(!o||!a||!n.alignedEdgeInfo)return{snapped:!1};const c=pd/a.scale;let l=[];const{v1Id:d,v2Id:h}=n.alignedEdgeInfo,f=i(d),u=i(h);if(f&&u&&f.type==="regular"&&u.type==="regular"){const g=Q(f,u);[.25,1/3,.5,2/3,.75,1].forEach(m=>{const x=g*m,S=Math.abs(o-x);l.push({scale:x,distance:S,type:"edge_fraction",priority:m===.5?1:m===1?2:3,fraction:m})})}if(l.length===0)return{snapped:!1};l.sort((g,y)=>g.priority!==y.priority?g.priority-y.priority:g.distance-y.distance);const p=l.find(g=>g.distance<c);return p?{snapped:!0,scale:p.scale,snapType:"edge_fraction",edgeFraction:p.fraction}:{snapped:!1}}function bh(e,t,n,s,i){let o=null,a=1/0;if(t&&(t.vertices&&t.vertices.forEach(r=>{const c=Q(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:r,snapType:"vertex",vertexId:r.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(r=>{const c=Q(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:{x:r.x,y:r.y},snapType:"edge",edgeInfo:{v1:r.v1,v2:r.v2}})}),t.faceCenters&&t.faceCenters.forEach(r=>{const c=Q(e,r);c<a&&(a=c,o={snapped:!0,snapPoint:r,snapType:"faceCenter"})})),n&&n!=="none"&&s&&s.interval1){const r=s.alpha2>s.alpha1&&s.interval2?s.interval2:s.interval1;cs(e,n,r,i,!0).forEach(l=>{const d=Q(e,l);d<a&&(a=d,o={snapped:!0,snapPoint:l,snapType:"grid"})})}return o||{snapped:!1}}function vh(e){if(Array.isArray(e)){const[t,n,s]=Ia(e[0],e[1],e[2]),i=1-s,[o,a,r]=ba(t,n,i);return[o,a,r]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,s,i,o]=t,a=parseInt(n),r=parseInt(s),c=parseInt(i),[l,d,h]=Ia(a,r,c),f=1-h,[u,p,g]=ba(l,d,f);return`rgba(${u}, ${p}, ${g}, ${o})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16),[i,o,a]=Ia(t,n,s),r=1-a,[c,l,d]=ba(i,o,r);return`#${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function Zi(e){let t=0;const n=e.length;for(let s=0;s<n;s++){const i=(s+1)%n;t+=e[s].x*e[i].y,t-=e[i].x*e[s].y}return t/2}function Mh(e,t,n){return Math.max(t,Math.min(n,e))}function Eh(e,t){return e==="light"?nd:t}function ba(e,t,n){let s,i,o;if(t===0)s=i=o=n;else{const a=(l,d,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?l+(d-l)*6*h:h<.5?d:h<.6666666666666666?l+(d-l)*(6*(.6666666666666666-h)):l),r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;s=a(c,r,e+1/3),i=a(c,r,e),o=a(c,r,e-1/3)}return[Math.round(s*255),Math.round(i*255),Math.round(o*255)]}function zs(e,t){const n=ln(e,.001),s=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${s}`;if(n==="1")return s;if(n==="-1")return`-${s}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${s}`;if(n.includes("/")){let i="",o=n;o.startsWith("-")&&(i="-",o=o.substring(1));const a=o.split("/"),r=a[0],c=a[1];return r==="1"?`${i}\\frac{1}{${c}}${s}`:`${i}\\frac{${r}}{${c}}${s}`}return`${n}${s}`}function We(e,t,n,s,i,o){const a={x:e.x-t.x,y:e.y-t.y};if(i){const r=Math.hypot(o.x,o.y);if(r>le){const c={x:o.x/r,y:o.y/r},l=a.x*c.x+a.y*c.y,d={x:a.x-l*c.x,y:a.y-l*c.y},h=l*s,f={x:h*c.x+d.x,y:h*c.y+d.y};return{x:t.x+f.x,y:t.y+f.y}}return{x:e.x,y:e.y}}else{let r={...a};r.x*=s,r.y*=s;const c=r.x,l=r.y;return r.x=c*Math.cos(n)-l*Math.sin(n),r.y=c*Math.sin(n)+l*Math.cos(n),{x:t.x+r.x,y:t.y+r.y}}}function Qi(e){if(e.length<3)return null;if(e.length===3){const[t,n,s]=e,i=Q(n,s),o=Q(t,s),a=Q(t,n),r=i+o+a;if(r<le)return null;const c=(i*t.x+o*n.x+a*s.x)/r,l=(i*t.y+o*n.y+a*s.y)/r,h=2*(Math.abs((n.x-t.x)*(s.y-t.y)-(s.x-t.x)*(n.y-t.y))/2)/r;return{center:{x:c,y:l},radius:h}}return Th(e)}function Ch(e,t,n){const s=Pl.reduce((o,a)=>Math.abs(a-e.t)<Math.abs(o-e.t)?a:o),i={x:t.x+s*(n.x-t.x),y:t.y+s*(n.y-t.y)};return{fraction:s,point:i}}function Th(e){if(e.length<3)return null;let t={x:e.reduce((i,o)=>i+o.x,0)/e.length,y:e.reduce((i,o)=>i+o.y,0)/e.length};ws(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,s=ul(t,e);for(let i=0;i<sd;i++){let o=!1;const a=s*od,r=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of r){const l={x:n.x+c.x,y:n.y+c.y};if(ws(l,e)){const d=ul(l,e);d>s&&(n=l,s=d,o=!0)}}if(!o)break}return{center:n,radius:Math.max(s,le)}}function ul(e,t){let n=1/0;for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length],a=Bl(e,i,o);n=Math.min(n,a)}return n}function Bl(e,t,n){return Tt(e,t,n).distance}function wh(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=gl(n,t);else if(!n.localCoordSystem.isCustom){const s=gl(n,t);s&&(n.localCoordSystem.origin=s.origin,n.localCoordSystem.scale=s.scale)}})}function Ph(e,t,n){const s=[e];let i=e,o=t;const a=n.size+2;for(let r=0;r<a;r++){if(s.push(o),o===e)return s.pop(),s;const c=n.get(o);if(!c||c.length<1)return null;const l=c.indexOf(i);if(l===-1)return null;const d=(l+1)%c.length,h=c[d];i=o,o=h}return null}function Ah(e,t,n){if(e.length<=1)return e;const s=new Set(t.map(i=>[i.id1,i.id2].sort().join("_")));return e.filter(i=>{const o=i.vertexIds;if(o.length<3)return!1;for(let a=0;a<o.length;a++)for(let r=a+2;r<o.length;r++){if(a===0&&r===o.length-1)continue;const c=o[a],l=o[r],d=[c,l].sort().join("_");if(s.has(d))return!1}return!0})}function ea(e,t){const n=new Map,s=new Map;e.forEach(l=>{const d=t(l.id1),h=t(l.id2);!d||!h||d.type!=="regular"||h.type!=="regular"||(s.has(d.id)||s.set(d.id,d),s.has(h.id)||s.set(h.id,h),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,d]of n.entries()){const h=s.get(l);h&&d.sort((f,u)=>{const p=s.get(f),g=s.get(u);if(!p||!g)return 0;const y=Math.atan2(p.y-h.y,p.x-h.x),m=Math.atan2(g.y-h.y,g.x-h.x);return y-m})}const i=[],o=new Set;for(const[l,d]of n.entries())for(const h of d){const f=`${l}->${h}`;if(o.has(f))continue;const u=Ph(l,h,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const m=u[y],x=u[(y+1)%u.length];o.add(`${m}->${x}`)}const g={vertexIds:u};g.id=ce(g),i.push(g)}}const a=Ah(i,e),r=[],c=new Set;return a.forEach(l=>{const d=[...l.vertexIds].sort().join("_");c.has(d)||(r.push(l),c.add(d))}),r}function As(e,t,n,s){const i={id1:e.id,id2:t.id},o=e.x-t.x,a=e.y-t.y,r=o/n,c=a/n,l=1e-5;if(n&&Math.abs(r-Math.round(r))<l&&Math.abs(c-Math.round(c))<l){i.labelMode="exact";const h=Math.round(r),f=Math.round(c);i.exactValue={g2gSquaredSum:h*h+f*f,gridInterval:n}}else i.labelMode="decimal";return i.color=s(Ue),i}function $l(e,t){let n=null,s=1/0;return t.forEach(i=>{if(!i)return;const o=Math.abs(e.x-(i.x+i.width/2));o<s&&o<i.width/2+Ze&&(s=o,n=i)}),n}function _h(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function De(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],p=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${p})`}t=Math.max(0,Math.min(1,t));let s=n[0],i=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){s=n[u],i=n[u+1];break}const o=i.pos-s.pos,a=o>0?(t-s.pos)/o:0,r=Math.round(s.color[0]+(i.color[0]-s.color[0])*a),c=Math.round(s.color[1]+(i.color[1]-s.color[1])*a),l=Math.round(s.color[2]+(i.color[2]-s.color[2])*a),d=s.alpha!==void 0?s.alpha:1,h=i.alpha!==void 0?i.alpha:1,f=d+(h-d)*a;return`rgba(${r},${c},${l},${f})`}function gl(e,t){const n=e.vertexIds.map(i=>t(i)).filter(i=>i&&i.type==="regular");if(n.length<3)return null;const s=Qi(n);return s?{origin:{...s.center},angle:0,scale:s.radius,isCustom:!1,showCoordSystem:!1}:null}function va(e,t){if(!t)return e;const n={x:e.x-t.origin.x,y:e.y-t.origin.y},s=Math.cos(-t.angle),i=Math.sin(-t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return t.scale===0?{x:0,y:0}:{x:o.x/t.scale,y:o.y/t.scale}}function yn(e,t){const n=new Set;return t.forEach(s=>{s.id1===e?n.add(s.id2):s.id2===e&&n.add(s.id1)}),Array.from(n)}function zn(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},s=Math.cos(t.angle),i=Math.sin(t.angle),o={x:n.x*s-n.y*i,y:n.x*i+n.y*s};return{x:o.x+t.origin.x,y:o.y+t.origin.y}}function Dh(e,t,n,s){const i=(e.x-t.x)*(n.y-s.y)-(e.y-t.y)*(n.x-s.x);if(Math.abs(i)<le)return null;const o=((e.x-n.x)*(n.y-s.y)-(e.y-n.y)*(n.x-s.x))/i,a=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/i;return o>le&&o<1-le&&a>le&&a<1-le?{x:e.x+o*(t.x-e.x),y:e.y+o*(t.y-e.y)}:null}function kh(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let s=0;s<t.length;s++){const i=t[s],o=t[(s+1)%t.length];if(Bl(n,i,o)<le)return!1}if(!ws(n,t))return!1}return!0}function Rh(e,t,n){const s=[];for(let i=0;i<t.length;i++)s.push({p1:t[i],p2:t[(i+1)%t.length]});for(const i of e){const o=n(i.id1),a=n(i.id2);if(!(!o||!a)){for(const r of s)if(Dh(o,a,r.p1,r.p2))return!0}}return!1}function pl(e,t,n){const s=[];for(const i of e)for(const o of t){if(i.originalId===o.originalId&&i.transformIndex===o.transformIndex)continue;const a=Q(i,o);a<n&&s.push({dist:a,sourceVertex:i,targetVertex:o,correctionVector:{x:o.x-i.x,y:o.y-i.y},type:"vertex-vertex"})}return s}function si(e,t,n){const s=[];for(const i of e)for(const o of t){if(!o||!o.originalEdge||!o.p1||!o.p2)continue;const a=i.transformIndex===o.transformIndex,r=i.originalId===o.originalEdge.id1||i.originalId===o.originalEdge.id2;if(a&&r)continue;const c=Tt(i,o.p1,o.p2);c.distance<n&&c.onSegmentStrict&&s.push({dist:c.distance,sourceVertex:i,targetEdge:o,snapPoint:{x:c.x,y:c.y},correctionVector:{x:c.x-i.x,y:c.y-i.y},type:"vertex-to-edge"})}return s}function Vl(e,t,n,s,i,o,a,r){const c=Ve*2/o.scale,l=Ve/o.scale,d=String(Hn).trim(),h=e.filter(X=>(X&&X.type?String(X.type).trim():"undefined")===d);if(h.length===0||i<=0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const f=new Set(e.map(X=>X.id)),u=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const H=X,Y=X;h.forEach(W=>{u.push({...r(W,H,a),originalId:W.id,transformIndex:Y,type:"regular"})})}const p=t.filter(X=>X.type==="regular"&&!f.has(X.id)).map(X=>({...X,originalId:X.id,transformIndex:void 0})),g=n.filter(X=>f.has(X.id1)&&f.has(X.id2)),y=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const H=X,Y=u.filter(W=>W.transformIndex===H);Y.length>0&&g.forEach(W=>{const J=Y.find(oe=>oe.originalId===W.id1),ee=Y.find(oe=>oe.originalId===W.id2);J&&ee&&y.push({p1:J,p2:ee,originalEdge:W,transformIndex:H,originalEdgeId:ne(W)})})}const m=n.filter(X=>!f.has(X.id1)||!f.has(X.id2)).map(X=>({p1:s(X.id1),p2:s(X.id2),originalEdge:X,transformIndex:void 0,originalEdgeId:ne(X)})).filter(X=>X.p1&&X.p2),x=[...p,...u],S=[...m,...y],I=pl(u,x,c),b=si(u,S,l),E=si(p,y,l).map(X=>({dist:X.dist,sourceEdge:X.targetEdge,targetVertex:X.sourceVertex,correctionVector:{x:X.sourceVertex.x-X.snapPoint.x,y:X.sourceVertex.y-X.snapPoint.y},type:"edge-to-vertex"})),C=[...I,...b,...E];if(C.length===0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const _={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};C.sort((X,H)=>{const Y=_[X.type]??99,W=_[H.type]??99;return Y!==W?Y-W:X.dist-H.dist});const P=C[0];let M={...P.correctionVector};const w=P.sourceVertex?P.sourceVertex.transformIndex:P.sourceEdge.transformIndex,O=P.targetVertex?P.targetVertex.transformIndex:P.targetEdge?P.targetEdge.transformIndex:void 0;let T;O===void 0?T=w:T=w-O;let A={x:0,y:0};Math.abs(T)>1e-9?(A.x=M.x/T,A.y=M.y/T):A={x:0,y:0};const L={...a,delta:{x:a.delta.x+A.x,y:a.delta.y+A.y}},B=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const H=X,Y=X;h.forEach(W=>{B.push({...r(W,H,L),id:`final_${W.id}_${X}`,originalId:W.id,transformIndex:Y,type:"regular"})})}const F=p.map(X=>({...X})),R=[...F,...B],N=pl(B,R,le),$=m.map(X=>({...X})),D=[];for(let X=0;X<i&&(X+=i==1,!(X>=i));X++){const H=X,Y=B.filter(W=>W.transformIndex===H);Y.length>0&&g.forEach(W=>{const J=Y.find(oe=>oe.originalId===W.id1),ee=Y.find(oe=>oe.originalId===W.id2);J&&ee&&D.push({p1:J,p2:ee,originalEdge:W,transformIndex:H,originalEdgeId:ne(W)})})}const k=[...$,...D],V=si(B,k,le),G=si(F,D,le);return{snapped:!0,finalTransform:L,bestSnap:P,mergePairs:N.map(X=>({source:{originalId:X.sourceVertex.originalId,transformIndex:X.sourceVertex.transformIndex},target:{originalId:X.targetVertex.originalId,transformIndex:X.targetVertex.transformIndex}})),edgeSnaps:[...V,...G].map(X=>({sourceVertex:{originalId:X.sourceVertex.originalId,transformIndex:X.sourceVertex.transformIndex},targetEdge:{originalEdgeId:X.targetEdge.originalEdgeId,transformIndex:X.targetEdge.transformIndex}}))}}function Lh(e,t,n,s,i,o,a){const r={delta:i},l=Vl(e,t,n,s,o,a,r,(d,h,f=r)=>({x:d.x+f.delta.x*h,y:d.y+f.delta.y*h}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const eo=e=>Math.max(0,Math.min(1,e)),gt=(e,t)=>{const n=Ps(e);return n||t},Dt=(e,t,n)=>e+(t-e)*n,yl=(e,t)=>{let n=0,s=0,i=0,o=0,a=0;return e.forEach((r,c)=>{const l=t[c]||0;a+=l,n+=r.r*l,s+=r.g*l,i+=r.b*l,o+=r.a*l}),a<=0?{r:0,g:0,b:0,a:1}:{r:n/a,g:s/a,b:i/a,a:o/a}};function Oh(e){const t=Ud/e;let n=Math.pow(10,Math.floor(Math.log10(t))),s=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-s)<le||n===0)&&(s=n===0?.001:n*10,n===0&&(n=1e-4));const i=n,o=s;let a=0;o>i&&i>0&&(a=(Math.log10(t)-Math.log10(i))/(Math.log10(o)-Math.log10(i)));let r=(a-Qr)/(Jd-Qr);r=Math.max(0,Math.min(1,r)),r=r*r*(3-2*r);let c=1-r,l=r;c<ti?c=0:c>1-ti&&(c=1),l<ti?l=0:l>1-ti&&(l=1);const d=c+l;return d>0&&d!==2&&(c/=d,l/=d),{grid1Interval:i,grid2Interval:o,alpha1:c,alpha2:l}}function Nh(e,t,n,s){const i=s({x:0,y:0}),o={x:t/2,y:n/2},a=Q(i,o);let r;a<1e-6?r=tl:r=tl/a*(180/Math.PI),(isNaN(r)||r<=le)&&(r=le);const c=[];let l=[...xa],d=l[l.length-1];const h=1e-15;for(;d>h;)d/=10,l.includes(d)||l.push(d);l.sort((y,m)=>m-y);let f=null,u=null;for(let y=l.length-1;y>=0;y--){const m=l[y];if(r<m){f={angle:m,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!f&&l.length>0?(f={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!f&&l.length===0&&(f={angle:xa[0],alpha:1}),c.push(f),u){const y=Math.log10(f.angle),m=Math.log10(u.angle),x=Math.log10(r);let S;m===y?S=0:S=(x-y)/(m-y),S=Math.max(0,Math.min(1,S));const I=S*S*(3-2*S);I>Qd&&(u.alpha=I,c.push(u))}const p=[],g=new Set;c.sort((y,m)=>m.angle-y.angle);for(const y of c)g.has(y.angle)||(p.push(y),g.add(y.angle));return p.length===0&&p.push({angle:xa[0],alpha:1}),p}function Xl(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:s,colors:i,isDragConfirmed:o,dragPreviewVertices:a,currentAltPressed:r},c,l,d){if(!n&&s.length===0)return;const h=new Map;o&&a&&a.forEach(u=>{if(u&&u.id){const p=u.originalId||u.id;h.set(p,u)}});const f=u=>o&&h.has(u)?h.get(u):l(u);t.forEach(u=>{const p=d(u),g=s.includes(p),y=!r&&p===n;if(o&&u.vertexIds.some(m=>h.has(m)),(g||y)&&u.color!=="transparent"){e.save(),e.fillStyle=i.selectionGlow,e.globalAlpha=_d,e.beginPath();const m=u.vertexIds.map(S=>f(S)).filter(S=>S&&S.type==="regular");if(m.length<3){e.restore();return}m.map(S=>c(S)).forEach((S,I)=>{I===0?e.moveTo(S.x,S.y):e.lineTo(S.x,S.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(S=>{const I=t.find(b=>b.id===S);if(I){const b=I.vertexIds.map(v=>f(v)).filter(v=>v&&v.type==="regular");if(b.length>=3){const v=b.map(E=>c(E));e.moveTo(v[0].x,v[0].y),v.slice(1).forEach(E=>e.lineTo(E.x,E.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function pr(e,t,{colors:n,verticesVisible:s=!0,isSnapped:i=!1},o){if(t.type===Hn&&!s&&!i)return;const a=o(t);switch(t.type){case Hn:e.beginPath(),e.arc(a.x,a.y,Ve,0,Ye),e.fillStyle=i?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case un:case Un:case In:case us:const r=Ki*2,c={type:t.type,x:a.x-r/2,y:a.y-r/2,width:r,height:r};ta(e,c,n);break}}function Yl(e,t,n,s){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=s)return{ranges:[[0,360]],isFullCircle:!0};const i={left:0,right:n,top:0,bottom:s};if(e.x+t<i.left||e.x-t>i.right||e.y+t<i.top||e.y-t>i.bottom)return null;const o=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(o.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const r=[];if(o.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const g=u.x-e.x,y=u.y-e.y,m=Math.atan2(-y,g),x=m<0?m+2*Math.PI:m;r.push(x*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{gr({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(g=>{const y=g.x-e.x,m=g.y-e.y,x=Math.atan2(-m,y),S=x<0?x+2*Math.PI:x;r.push(S*180/Math.PI)})}),r.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(r.map(u=>Math.round(u*1e6)/1e6))].sort((u,p)=>u-p);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let d=0,h=0,f=0;for(let u=0;u<l.length;u++){const p=l[u],g=l[(u+1)%l.length];let y;u===l.length-1?y=360-p+g:y=g-p,y>d&&(d=y,h=p,f=g)}return f>h?{ranges:[[f,h+360]],isFullCircle:!1}:{ranges:[[f,h]],isFullCircle:!1}}function Fh(e,{canvas:t,dpr:n,colors:s}){const i=t.width/n,o=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=s.background,e.fillRect(0,0,i,o)}function os(e,t){return e?.colorMode||t}function Oo(e,t){return e?.colorMode||t}function Bh(e,{allFaces:t,allEdges:n,facesVisible:s,isDragConfirmed:i,dragPreviewVertices:o,transformIndicatorData:a,initialDragVertexStates:r,colors:c,initialCoordSystemStates:l,interpolationStyle:d,getInterpolationStyleById:h,faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x"},m,x){if(!s||!t||!c||!e)return;const S=v=>x(v);t.filter(v=>!v.parentFaceId).forEach(v=>{if(!v||!v.vertexIds||v.vertexIds.length<3)return;const E=v.vertexIds.map(w=>S(w)).filter(w=>w&&w.type==="regular");if(E.length<3)return;const C=v.interpolationStyleId&&h?h(v.interpolationStyleId):d,P=(C?lo(E,C,!0,m):E).map(w=>m(w));let M=v;v.localCoordSystem,P.every(w=>w&&typeof w.x=="number"&&typeof w.y=="number")&&wi(e,P,M,c,m,x,n,t,S,!0,d,{faceColorMode:Oo(v,f),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y})}),t.filter(v=>v.parentFaceId&&v.color!=="transparent").forEach(v=>{if(!v||!v.vertexIds||v.vertexIds.length<3)return;const E=v.vertexIds.map(w=>S(w)).filter(w=>w&&w.type==="regular");if(E.length<3)return;const C=v.interpolationStyleId&&h?h(v.interpolationStyleId):d,P=(C?lo(E,C,!0,m):E).map(w=>m(w));let M=v;v.localCoordSystem,P.every(w=>w&&typeof w.x=="number"&&typeof w.y=="number")&&wi(e,P,M,c,m,x,n,t,S,!1,d,{faceColorMode:Oo(v,f),edgeColorMode:u,faceColorExpression:p,faceColorPolarExpression:g,edgeColorExpression:y})})}function $h(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:s,findVertexById:i,transformIndicatorData:o}){if(!t)return e.localCoordSystem;const a=new Set(e.vertexIds),r=new Set(s.map(p=>p.id));if([...a].every(p=>r.has(p))){const p=JSON.parse(JSON.stringify(t));if(o){const{center:g,rotation:y,scale:m,directionalScale:x,startPos:S}=o,I={x:S.x-g.x,y:S.y-g.y};if(p.origin=We(t.origin,g,y,m,x,I),x){const b=zn({x:1,y:0},t),v=We(b,g,y,m,x,I);p.scale=Q(p.origin,v)}else p.angle=On(t.angle+y),p.scale=t.scale*m}else if(s.length>0&&n.length>0){const g=s.find(m=>a.has(m.id)),y=g?n.find(m=>m.id===g.id):null;if(y){const m=y.x-g.x,x=y.y-g.y;p.origin.x+=m,p.origin.y+=x}}return p}const l=e.vertexIds.map(p=>n.find(g=>g&&g.id===p)||i(p)).filter(p=>p&&p.type==="regular");if(!t.isCustom){const p=Qi(l);if(p){const g=o?o.rotation:0;return{...t,origin:p.center,scale:p.radius,angle:On(t.angle+g)}}return t}const d=JSON.parse(JSON.stringify(t));if(o){const{center:p,rotation:g,scale:y,directionalScale:m,startPos:x}=o,S={x:x.x-p.x,y:x.y-p.y};if(d.origin=We(t.origin,p,g,y,m,S),m){const I=zn({x:1,y:0},t),b=We(I,p,g,y,m,S);d.scale=Q(d.origin,b)}else d.angle=On(t.angle+g),d.scale=t.scale*y}let h={...d.origin},f=d.angle,u=d.scale;if(d.attachedToVertex){if(r.has(d.attachedToVertex)){const p=n.find(g=>g.id===d.attachedToVertex);p&&(h={...p})}}else if(d.attachedToEdge&&(r.has(d.attachedToEdge.v1)||r.has(d.attachedToEdge.v2))){const p=n.find(y=>y.id===d.attachedToEdge.v1)||i(d.attachedToEdge.v1),g=n.find(y=>y.id===d.attachedToEdge.v2)||i(d.attachedToEdge.v2);p&&g&&(h={x:p.x+d.attachedToEdge.t*(g.x-p.x),y:p.y+d.attachedToEdge.t*(g.y-p.y)})}if(d.rotationAlignedToEdge&&(r.has(d.rotationAlignedToEdge.v1)||r.has(d.rotationAlignedToEdge.v2))){const p=n.find(y=>y.id===d.rotationAlignedToEdge.v1)||i(d.rotationAlignedToEdge.v1),g=n.find(y=>y.id===d.rotationAlignedToEdge.v2)||i(d.rotationAlignedToEdge.v2);if(p&&g){const y=Math.atan2(g.y-p.y,g.x-p.x),{originalAngle:m,originalSystemAngle:x}=d.rotationAlignedToEdge,S=x-m;f=On(y+S)}}if(d.scaleAttachedToEdge&&(r.has(d.scaleAttachedToEdge.v1)||r.has(d.scaleAttachedToEdge.v2))){const p=n.find(y=>y.id===d.scaleAttachedToEdge.v1)||i(d.scaleAttachedToEdge.v1),g=n.find(y=>y.id===d.scaleAttachedToEdge.v2)||i(d.scaleAttachedToEdge.v2);p&&g&&(u=Q(p,g)*d.scaleAttachedToEdge.scaleRatio)}return l.length>=3?d.origin=co(h,l):d.origin=h,d.angle=f,d.scale=Math.max(.01,u),d}function Vh(e,t,n){const{copyCount:s,isDragConfirmed:i,initialDragVertexStates:o,dragPreviewVertices:a,transformIndicatorData:r,allEdges:c,allFaces:l,findVertexById:d,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:p="fixed",faceColorMode:g="fixed",edgeColorExpression:y="x",faceColorExpression:m="x",faceColorPolarExpression:x="r"}=t,S=o.length===1&&!r&&o[0].type==="regular";if(!i||!o.length||s<=0||S)return;const I=o.filter(_=>_.type==="regular");if(I.length===0)return;const b=new Set(I.map(_=>_.id)),v=c.filter(_=>b.has(_.id1)&&b.has(_.id2)),E=c.filter(_=>b.has(_.id1)&&!b.has(_.id2)||b.has(_.id2)&&!b.has(_.id1)),C=l.filter(_=>_.vertexIds.every(P=>b.has(P)));e.save(),e.globalAlpha=1;for(let _=0;_<s;_++){_+=s==1;const P=_,M=_;let w;const O=new Map;if(r){const{center:F,rotation:R,scale:N,directionalScale:$,startPos:D}=r,k={x:D.x-F.x,y:D.y-F.y};w=I.map(V=>{const G=We(V,F,R*M,Math.pow(N,M),$,k);return{...V,...G,id:`preview_${V.id}_${P}`,originalId:V.id,transformIndex:P}})}else{const F=a.length>0?a[0].x-o[0].x:0,R=a.length>0?a[0].y-o[0].y:0;w=I.map(N=>({...N,x:N.x+F*M,y:N.y+R*M,id:`preview_${N.id}_${P}`,originalId:N.id,transformIndex:P}))}if(!w||w.length===0)continue;w.forEach(F=>O.set(F.originalId,F)),C.forEach(F=>{const R=F.vertexIds.map(N=>O.get(N)).filter(Boolean);if(R.length===F.vertexIds.length){const N=R.map($=>n($));wi(e,N,F,h,n,d,c,[],$=>O.get($),!1,null,{faceColorMode:Oo(F,g),edgeColorMode:p,faceColorExpression:m,faceColorPolarExpression:x,edgeColorExpression:y})}}),e.setLineDash([]),e.lineWidth=ys;const T=gt(h.edge,{r:255,g:255,b:255,a:1}),A=F=>gt(F?.color||h.vertex||h.edge,T),L=F=>`rgba(${Math.round(F.r)},${Math.round(F.g)},${Math.round(F.b)},${F.a})`,B=(F,R,N,$)=>{const D=os(F,p);if(D==="inherit_vertices"&&N&&$){const k=A(N),V=A($);return{r:Dt(k.r,V.r,R),g:Dt(k.g,V.g,R),b:Dt(k.b,V.b,R),a:Dt(k.a,V.a,R)}}if(D==="colormap"&&F.colormapItem){const k=Qs(y,{x:R},R),V=eo(k),G=De(F.colormapItem,V);return gt(G,T)}return gt(F.color||h.edge,T)};v.forEach(F=>{const R=O.get(F.id1),N=O.get(F.id2);if(R&&N){const $=n(R),D=n(N),k=os(F,p);if(k==="inherit_vertices"){const X=A(R),H=A(N),Y=e.createLinearGradient($.x,$.y,D.x,D.y);Y.addColorStop(0,L(X)),Y.addColorStop(1,L(H)),e.beginPath(),e.moveTo($.x,$.y),e.lineTo(D.x,D.y),e.strokeStyle=Y,e.stroke()}else if(k==="colormap"){const X=B(F,.5,R,N);e.beginPath(),e.moveTo($.x,$.y),e.lineTo(D.x,D.y),e.strokeStyle=L(X),e.stroke()}else if(F.colormapItem){const X=e.createLinearGradient($.x,$.y,D.x,D.y),H=De(F.colormapItem,F.gradientStart),Y=De(F.colormapItem,F.gradientEnd);X.addColorStop(0,H),X.addColorStop(1,Y),e.strokeStyle=X,e.stroke()}else e.strokeStyle=F.color||h.edge,e.stroke();const V=ne(F);if((f?.get(V)||[]).some(X=>X.copyIndex===P)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Cs,e.lineWidth=ls,e.lineCap="round",e.lineJoin="round";const X=D.x-$.x,H=D.y-$.y,Y=Math.hypot(X,H),W=_a;if(Y>le){const J=-H/Y,ee=X/Y,oe=J*W,ye=ee*W;e.beginPath(),e.arc($.x,$.y,W,Math.atan2(ye,oe),Math.atan2(-ye,-oe)),e.lineTo(D.x-oe,D.y-ye),e.arc(D.x,D.y,W,Math.atan2(-ye,-oe),Math.atan2(ye,oe)),e.closePath(),e.stroke()}else e.beginPath(),e.arc($.x,$.y,W,0,Ye),e.stroke();e.restore()}}}),E.forEach(F=>{const R=b.has(F.id1)?F.id2:F.id1,N=b.has(F.id1)?F.id1:F.id2,$=O.get(N),D=d(R);if($&&D){const k=n($),V=n(D),G=os(F,p);if(G==="inherit_vertices"){const Y=A($),W=A(D),J=e.createLinearGradient(k.x,k.y,V.x,V.y);J.addColorStop(0,L(Y)),J.addColorStop(1,L(W)),e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(V.x,V.y),e.strokeStyle=J,e.stroke()}else if(G==="colormap"){const Y=B(F,.5,$,D);e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(V.x,V.y),e.strokeStyle=L(Y),e.stroke()}else if(F.colormapItem){const Y=e.createLinearGradient(k.x,k.y,V.x,V.y),W=De(F.colormapItem,F.gradientStart),J=De(F.colormapItem,F.gradientEnd);Y.addColorStop(0,W),Y.addColorStop(1,J),e.strokeStyle=Y,e.stroke()}else e.strokeStyle=F.color||h.edge,e.stroke();const X=ne(F);if((f?.get(X)||[]).some(Y=>Y.copyIndex===P)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=Cs,e.lineWidth=ls,e.lineCap="round",e.lineJoin="round";const Y=V.x-k.x,W=V.y-k.y,J=Math.hypot(Y,W),ee=_a;if(J>le){const oe=-W/J,ye=Y/J,qe=oe*ee,ke=ye*ee;e.beginPath(),e.arc(k.x,k.y,ee,Math.atan2(ke,qe),Math.atan2(-ke,-qe)),e.lineTo(V.x-qe,V.y-ke),e.arc(V.x,V.y,ee,Math.atan2(-ke,-qe),Math.atan2(ke,qe)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(k.x,k.y,ee,0,Ye),e.stroke();e.restore()}}}),w.forEach(F=>{const R=F.originalId,N=u.get(R)||[],$=N.some(V=>V.copyIndex===P),D=N.find(V=>V.copyIndex===P),k=D?D.type:null;pr(e,F,{colors:h,verticesVisible:!0,isSnapped:!1},n),$&&yr(e,F,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:k,currentAltPressed:!1},n)})}e.restore()}function yr(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,isSnapped:h=!1,snapType:f=null,currentAltPressed:u}=n;if(u&&d)return;let p;if(t.type===Hn){if(p=o.includes(t.id),!l&&!p&&!d&&!h)return}else p=a.includes(t.id);if(p||d||h){const y=s(t);e.save();let m=c.selectionGlow;t.id===r&&t.type!=="regular"?m=c.activeCenterGlow:h?m=c.feedbackSnapped:d&&(m=c.selectionGlow),e.shadowColor=m,e.shadowBlur=ir,e.globalAlpha=Cs,e.strokeStyle=m,e.lineWidth=ls,e.beginPath();let x;t.type===Hn?x=Ve+Ei:x=Ki+Ei,e.arc(y.x,y.y,x,0,Ye),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function Xh(e,t,n){const{copyCount:s=1,initialDragVertexStates:i,dragPreviewVertices:o,allEdges:a,allFaces:r,findVertexById:c,findAllVerticesInSubgraph:l,colors:d,snappedEdgesInfo:h,snappedVertexIds:f,edgeColorMode:u="fixed",faceColorMode:p="fixed",edgeColorExpression:g="x",faceColorExpression:y="x",faceColorPolarExpression:m="r"}=t;if(!i||i.length!==1||!o||o.length===0)return;const x=i[0];for(let S=0;S<s;S++){S+=s==1;const I=S,b=S;let v;const E=o.length>0?o[0].x-i[0].x:0,C=o.length>0?o[0].y-i[0].y:0;v={x:x.x+E*b,y:x.y+C*b};const _={...x,...v,originalId:x.id,transformIndex:I},P=new Set(l(x.id)),M=a.filter(B=>P.has(B.id1)&&P.has(B.id2)),w=r.filter(B=>B.vertexIds.every(F=>P.has(F))),O=B=>B===x.id?_:P.has(B)?c(B):null;w.forEach(B=>{const F=B.vertexIds.map(O).filter(Boolean);if(F.length>=3){const R=F.map(N=>n(N));wi(e,R,B,d,n,c,a,r,O,!0,null,{faceColorMode:Oo(B,p),edgeColorMode:u,faceColorExpression:y,faceColorPolarExpression:m,edgeColorExpression:g})}}),e.save(),e.lineWidth=ys,e.setLineDash([]);const T=gt(d.edge,{r:255,g:255,b:255,a:1}),A=B=>gt(B?.color||d.vertex||d.edge,T),L=(B,F,R,N)=>{const $=os(B,u);if($==="inherit_vertices"&&R&&N){const D=A(R),k=A(N);return{r:Dt(D.r,k.r,F),g:Dt(D.g,k.g,F),b:Dt(D.b,k.b,F),a:Dt(D.a,k.a,F)}}if($==="colormap"&&B.colormapItem){const D=Qs(g,{x:F},F),k=eo(D),V=De(B.colormapItem,k);return gt(V,T)}return gt(B.color||d.edge,T)};M.forEach(B=>{const F=O(B.id1),R=O(B.id2);if(F&&R){const N=n(F),$=n(R);e.beginPath(),e.moveTo(N.x,N.y),e.lineTo($.x,$.y);const D=os(B,u);if(D==="inherit_vertices"){const G=A(F),X=A(R),H=e.createLinearGradient(N.x,N.y,$.x,$.y);H.addColorStop(0,toRgbaString(G)),H.addColorStop(1,toRgbaString(X)),e.strokeStyle=H,e.stroke()}else if(D==="colormap"){const G=L(B,.5,F,R);e.strokeStyle=toRgbaString(G),e.stroke()}else if(B.colormapItem){const G=e.createLinearGradient(N.x,N.y,$.x,$.y),X=De(B.colormapItem,B.gradientStart),H=De(B.colormapItem,B.gradientEnd);G.addColorStop(0,X),G.addColorStop(1,H),e.strokeStyle=G,e.stroke()}else e.strokeStyle=B.color||d.edge,e.stroke();const k=ne(B);if((h?.get(k)||[]).some(G=>G.copyIndex===I)){e.save(),e.strokeStyle=d.feedbackSnapped,e.globalAlpha=Cs,e.lineWidth=ls,e.lineCap="round",e.lineJoin="round";const G=$.x-N.x,X=$.y-N.y,H=Math.hypot(G,X),Y=_a;if(H>le){const W=-X/H,J=G/H,ee=W*Y,oe=J*Y;e.beginPath(),e.arc(N.x,N.y,Y,Math.atan2(oe,ee),Math.atan2(-oe,-ee)),e.lineTo($.x-ee,$.y-oe),e.arc($.x,$.y,Y,Math.atan2(-oe,-ee),Math.atan2(oe,ee)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(N.x,N.y,Y,0,Ye),e.stroke();e.restore()}}}),e.restore(),P.forEach(B=>{const F=O(B);if(!F)return;const R=B===x.id,N=f.get(x.id)||[],$=R&&N.some(G=>G.copyIndex===I),D=R?N.find(G=>G.copyIndex===I):null,k=D?D.type:null,V={...F,id:`preview_${F.originalId||F.id}_${I}`,originalId:F.originalId||F.id,transformIndex:I};pr(e,V,{colors:d,verticesVisible:!0,isSnapped:!1},n),$&&yr(e,V,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:d,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:k,currentAltPressed:!1},n)})}}function Gl(e,{startVertex:t,snappedData:n,isShiftPressed:s,currentColor:i,nextCreationColor:o,nextEdgeColor:a,colors:r,edgeColormapInfo:c,interpolationStyle:l},d){const h=d(t),f=d(n);e.save();let u=[{x:t.x,y:t.y},{x:n.x,y:n.y}];if(l&&l.type&&l.type!=="linear"?(u=lo(u,l,!1,null),e.setLineDash([])):e.setLineDash(Vn),c&&c.colormapItem){const m=e.createLinearGradient(h.x,h.y,f.x,f.y),x=De(c.colormapItem,c.startT),S=De(c.colormapItem,c.endT);m.addColorStop(0,x),m.addColorStop(1,S),e.strokeStyle=m}else n.snapped||s?e.strokeStyle=r.feedbackSnapped:e.strokeStyle=a;e.lineWidth=ys;const g=u.map(m=>d(m));e.beginPath(),e.moveTo(g[0].x,g[0].y);for(let m=1;m<g.length;m++)e.lineTo(g[m].x,g[m].y);if(e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(f.x,f.y,Ve,0,Ye),n.snapped?e.fillStyle=r.feedbackSnapped:e.fillStyle=o,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=r.feedbackSnapped,e.shadowBlur=ir,e.globalAlpha=Cs,e.strokeStyle=r.feedbackSnapped,e.lineWidth=ls;const m=Ve+Ei;e.beginPath(),e.arc(f.x,f.y,m,0,Ye),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function Ci(e,t,n){const s=[];if(n>360){const o=n-360,a=Math.floor(t/e)*e;for(let r=a;r<360;r+=e)r>=t&&s.push(r);for(let r=0;r<=o+e;r+=e)r<=o&&s.push(r)}else{const o=Math.floor(t/e)*e;for(let a=o;a<=n+e;a+=e)a>=t&&a<=n&&a>=0&&a<360&&s.push(a)}return[...new Set(s)].sort((o,a)=>o-a)}function Yh(e,t,n){return e.x>=-20&&e.x<=t+Pt&&e.y>=-20&&e.y<=n+Pt}function Gh(e,t,n,s,i,{canvas:o,dpr:a,viewTransform:r,angleDisplayMode:c,colors:l},d,h){if(typeof d!="function"||typeof n!="function")return;const f=d({x:0,y:0}),u=o.width/a,p=o.height/a,g={x:u/2,y:p/2},y=Math.min(u,p)/4,m=Q(f,g),x=y+m;if(x<Ll||!Hl(f.x,f.y,x,u,p))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=dn;const S=Math.min(u,p)*400,I=x>S;let b=null;if(I){const w={x:0,y:0,w:u,h:p},O={x:f.x,y:f.y,r:x},T=Va(O,w);if(T.length>=2){let A=T[0],L=T[1],B=0;for(let N=0;N<T.length;N++)for(let $=N+1;$<T.length;$++){const D=(T[N].x-T[$].x)**2+(T[N].y-T[$].y)**2;D>B&&(B=D,A=T[N],L=T[$])}e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(L.x,L.y),e.stroke();const F=(Math.atan2(f.y-A.y,A.x-f.x)*180/Math.PI+360)%360,R=(Math.atan2(f.y-L.y,L.x-f.x)*180/Math.PI+360)%360;b={minAngle:Math.min(F,R),maxAngle:Math.max(F,R),isFullCircle:!1},Math.abs(F-R)>180&&(b={minAngle:Math.max(F,R),maxAngle:Math.min(F,R)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(f.x,f.y,x,0,2*Math.PI),e.stroke(),b=Yl(f,x,u,p);if(e.restore(),!b)return;const v=x/(r.scale/a),E=new Set,C=new Map;h.forEach(w=>{const O=w.alpha;if(O<Dl||x*(w.angle*Math.PI/180)<Ol*.5)return;const A=`rgba(${l.feedbackDefault.join(",")}, ${O*Sd})`;let L;if(b.isFullCircle){L=[];for(let B=0;B<360;B+=w.angle)L.push(B)}else L=[],b.ranges&&Array.isArray(b.ranges)?b.ranges.forEach(B=>{const[F,R]=B,N=Ci(w.angle,F,R);L.push(...N)}):b.minAngle!==void 0&&b.maxAngle!==void 0&&(L=Ci(w.angle,b.minAngle,b.maxAngle)),L=[...new Set(L)];L.forEach(B=>{if(B=Math.round(B*1e10)/1e10,c==="degrees"){if(E.has(B))return}else if(c==="radians"){const V=`${B}-${w.angle}`;if(C.has(V))return}const F=B*Math.PI/180,R={x:f.x+(x+bi)*Math.cos(F),y:f.y-(x+bi)*Math.sin(F)},N=Id;if(!(R.x>-N&&R.x<u+N&&R.y>-N&&R.y<p+N))return;let D={textAlign:"center",textBaseline:"middle"};if(c==="radians"&&(D={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=A,e.lineWidth=Gn,B%90===0&&B<360){const V={x:f.x+x*Math.cos(F),y:f.y-x*Math.sin(F)};let G;const X=rt*1.5;switch(B){case 0:G={x:Math.SQRT1_2,y:-Math.SQRT1_2},D={textAlign:"left",textBaseline:"bottom"};break;case 90:G={x:Math.SQRT1_2,y:-Math.SQRT1_2},D={textAlign:"left",textBaseline:"bottom"};break;case 180:G={x:-Math.SQRT1_2,y:-Math.SQRT1_2},D={textAlign:"right",textBaseline:"bottom"};break;case 270:G={x:Math.SQRT1_2,y:Math.SQRT1_2},D={textAlign:"left",textBaseline:"top"};break}const H={x:V.x+G.x*X,y:V.y+G.y*X};e.lineWidth=bd,e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(H.x,H.y),e.stroke(),R.x=H.x,R.y=H.y}else{const V={x:f.x+(x-Ve)*Math.cos(F),y:f.y-(x-Ve)*Math.sin(F)},G={x:f.x+(x+Ve)*Math.cos(F),y:f.y-(x+Ve)*Math.sin(F)};Yh(G,u,p)&&(e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(G.x,G.y),e.stroke())}e.restore();let k="";if(c==="degrees"){let V=Math.max(0,(w.angle.toString().split(".")[1]||"").length);w.angle<1&&(V=Math.max(V,Math.ceil(-Math.log10(w.angle))+1));const G=Math.round(B*Math.pow(10,V))/Math.pow(10,V),X=parseFloat(G.toFixed(V));k=`${Math.round(X*1e10)/1e10}^{\\circ}`}else if(B===0&&c==="radians")k="0";else if(B!==0)if(w.angle<=5){const G=B*Math.PI/180,X=Math.max(0,(w.angle.toString().split(".")[1]||"").length),H=Math.max(3,X+2);let Y=G.toFixed(H);Y=parseFloat(Y).toString(),parseFloat(Y)!==0&&(k=Y)}else{const G=B,X=180,H=ur(G,X),Y=G/H,W=X/H;W===1?Y===1?k="\\pi":Y===-1?k="-\\pi":k=`${Y}\\pi`:Y===1?k=`\\frac{\\pi}{${W}}`:Y===-1?k=`-\\frac{\\pi}{${W}}`:Y<0?k=`-\\frac{${Math.abs(Y)}\\pi}{${W}}`:k=`\\frac{${Y}\\pi}{${W}}`}if(k){const V=c==="radians"?`circ-label-${B}-${w.angle}-${v.toExponential(15)}`:`circ-label-${B}-${v.toExponential(15)}`;if(n({id:V,content:k,x:R.x,y:R.y,color:A,fontSize:Fa,options:D}),c==="degrees")E.add(B);else{const G=`${B}-${w.angle}`;C.set(G,{levelAngle:w.angle,alpha:O,labelId:V})}}})});const _=l.feedbackDefault;let P=-1/0;const M={x:f.x+x,y:f.y};if(M.x>-20&&M.x<u+Pt&&M.y>-20&&M.y<p+Pt)P=0;else{const w={x:0,y:0,w:u,h:p},O={x:f.x,y:f.y,r:x},T=Va(O,w);if(T.length>0){let A=-1/0;T.forEach(B=>{const F=Math.atan2(f.y-B.y,B.x-f.x),R=F>=0?F:F+2*Math.PI,N={x:f.x+x*Math.cos(R),y:f.y-x*Math.sin(R)},$=Pt;N.x>-$&&N.x<u+$&&N.y>-$&&N.y<p+$&&R>A&&(A=R)}),[{x:0,y:0},{x:w.w,y:0},{x:w.w,y:w.h},{x:0,y:w.h}].forEach(B=>{if(Q(B,f)<O.r){const F=Math.atan2(f.y-B.y,B.x-f.x),R=F>=0?F:F+2*Math.PI,N={x:f.x+x*Math.cos(R),y:f.y-x*Math.sin(R)},$=Pt;N.x>-$&&N.x<u+$&&N.y>-$&&N.y<p+$&&R>A&&(A=R)}}),A>-1/0&&(P=A)}}if(P>-1/0){const w=P,O={x:f.x+x*Math.cos(w),y:f.y-x*Math.sin(w)},T={x:-Math.sin(w),y:-Math.cos(w)},A={x:Math.cos(w),y:-Math.sin(w)},L={x:O.x-Re*T.x+Re/2*A.x,y:O.y-Re*T.y+Re/2*A.y},B={x:O.x-Re*T.x-Re/2*A.x,y:O.y-Re*T.y-Re/2*A.y};e.save(),e.fillStyle=`rgba(${_.join(",")}, 1.0)`,e.beginPath(),e.moveTo(O.x,O.y),e.lineTo(L.x,L.y),e.lineTo(B.x,B.y),e.closePath(),e.fill(),e.restore();let F;if(w===0)F={x:O.x-fa,y:O.y+ua+Re};else{const R={x:-Math.cos(w),y:Math.sin(w)};F={x:O.x+R.x*(ua+Re)+T.x*fa,y:O.y+R.y*(ua+Re)+T.y*fa}}n({id:"theta-label-sticky",content:"\\theta",x:F.x,y:F.y,color:`rgba(${_.join(",")}, 1.0)`,fontSize:ms,options:{textAlign:"center",textBaseline:"middle"}})}}function Va(e,t){const{x:n,y:s,r:i}=e,{x:o,y:a,w:r,h:c}=t,l=[],d={center:{x:n,y:s},radius:i},h=(f,u,p,g)=>{gr({p1:{x:f,y:u},p2:{x:p,y:g}},d).forEach(x=>{const S=p-f,I=g-u;let b;Math.abs(S)>Math.abs(I)?b=(x.x-f)/S:b=(x.y-u)/I,b>=0&&b<=1&&l.push({x:x.x,y:x.y})})};return h(o,a,o+r,a),h(o+r,a,o+r,a+c),h(o+r,a+c,o,a+c),h(o,a+c,o,a),l}function Hl(e,t,n,s,i){return!(e+n<0||e-n>s||t+n<0||t-n>i)}function Hh(e,t,n,s,i,o,a){const r=`rgba(${a.axisTickLabel.join(",")}, ${Ii})`,c=rt*rd;e.save(),e.strokeStyle=r,e.lineWidth=ld,e.setLineDash([]);const l=c,d=l/Math.tan(ad),h=t.x-d,f=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(h,f),e.stroke(),e.restore(),o({id:"tick-label-origin",content:Ed,x:t.x-rt-es,y:t.y+rt+es,color:r,fontSize:xs,options:{textAlign:"right",textBaseline:"top"}})}function zh(e,t,{canvas:n,dpr:s,coordsDisplayMode:i,viewTransform:o,angleDisplayMode:a,colors:r},c,l,d,h,f){e.save();const u=n.width/s,p=n.height/s,g=c({x:0,y:0}),y=(S,I,b,v)=>{e.beginPath(),e.moveTo(S,I),e.lineTo(b,v),e.stroke();const E=Math.atan2(v-I,b-S);e.beginPath(),e.moveTo(b,v),e.lineTo(b-Re*Math.cos(E-rn),v-Re*Math.sin(E-rn)),e.lineTo(b-Re*Math.cos(E+rn),v-Re*Math.sin(E+rn)),e.closePath(),e.fill()},m=(S,I,b,v,E)=>{const C=new Map,_=new Map,P=(F,R,N)=>{if(!F||R<qi)return;const $=l({x:0,y:0}),D=l({x:u,y:p}),k=F*le;{const V=Math.floor($.x/F),G=Math.ceil(D.x/F),X=Math.floor(D.y/F),H=Math.ceil($.y/F);for(let Y=V;Y<=G;Y++){const W=Y*F;if(Math.abs(W)<k)continue;const J=C.get(W);J?N?C.set(W,{alpha:Math.max(J.alpha,R),isCoarser:!0}):J.isCoarser||C.set(W,{alpha:Math.max(J.alpha,R),isCoarser:!1}):C.set(W,{alpha:R,isCoarser:N})}for(let Y=X;Y<=H;Y++){const W=Y*F;if(Math.abs(W)<k)continue;const J=_.get(W);J?N?_.set(W,{alpha:Math.max(J.alpha,R),isCoarser:!0}):J.isCoarser||_.set(W,{alpha:Math.max(J.alpha,R),isCoarser:!1}):_.set(W,{alpha:R,isCoarser:N})}}},M=!b||S>=b;P(S,I,M),P(b,v,!M);let w=!1;const O=F=>{const R=Math.abs(F);(R>=Ba||R>0&&R<$a)&&(w=!0)};C.forEach((F,R)=>O(R)),_.forEach((F,R)=>O(R));const T=l({x:0,y:0}),A=l({x:u,y:p});O(T.x),O(T.y),O(A.x),O(A.y);const L=S||b||1,B=L>0?Math.max(0,-Math.floor(Math.log10(L))):0;return C.forEach((F,R)=>{const N=F.isCoarser?1:F.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${Ii*N})`;e.strokeStyle=$,e.lineWidth=Gn;{const D=c({x:R,y:0}).x;e.beginPath(),e.moveTo(D,g.y),e.lineTo(D,g.y+rt),e.stroke();let k;if(w){const G=Math.log10(Math.abs(R)),X=Math.floor(G),H=L/Math.pow(10,X),Y=Math.max(0,-Math.floor(Math.log10(H))+1),J=Math.abs(R).toExponential(Y).split("e");let ee=J[0];ee=ee.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let oe=parseInt(J[1],10);k=`${R<0?"-":""}${ee} \\cdot 10^{${oe}}`}else k=R.toFixed(B).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");f({id:((G,X)=>`${G}-${X.toExponential(15)}`)("tick-label-x",R),content:k,x:D,y:g.y+rt+es,color:$,fontSize:xs,options:{textAlign:"center",textBaseline:"top"}})}}),_.forEach((F,R)=>{const N=F.isCoarser?1:F.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${Ii*N})`;e.strokeStyle=$,e.lineWidth=Gn;const D=c({x:0,y:R}).y;let k;if(w){const G=Math.log10(Math.abs(R)),X=Math.floor(G),H=L/Math.pow(10,X),Y=Math.max(0,-Math.floor(Math.log10(H))+1),J=Math.abs(R).toExponential(Y).split("e");let ee=J[0];ee=ee.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let oe=parseInt(J[1],10);k=`${R<0?"-":""}${ee} \\cdot 10^{${oe}}`}else k=R.toFixed(B).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");i===ko&&Math.abs(R)>le&&(k==="1"?k=ri:k==="-1"?k=`-${ri}`:k+=ri),e.beginPath(),e.moveTo(g.x,D),e.lineTo(g.x-rt,D),e.stroke(),f({id:((G,X)=>`${G}-${X.toExponential(15)}`)("tick-label-y",R),content:k,x:g.x-rt-es,y:D,color:$,fontSize:xs,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:w}};e.lineWidth=Md,e.strokeStyle=r.axis,e.fillStyle=r.axis;let x={useScientific:!1};if(i===Ji){const{interval1:S,interval2:I,alpha1:b,alpha2:v}=d;Kh(e,t,{canvas:n,dpr:s,colors:r},c,f);let E=!1;const C=M=>{const w=Math.abs(M);(w>=Ba||w>0&&w<$a)&&(E=!0)},_=l({x:0,y:0}),P=l({x:u,y:p});C(_.x),C(_.y),C(P.x),C(P.y),Wh(e,t,{canvas:n,dpr:s,colors:r},c,l,d,f,E),Gh(e,t,f,0,0,{canvas:n,dpr:s,viewTransform:o,angleDisplayMode:a,colors:r},c,h),x={useScientific:E}}else{g.y>0&&g.y<p&&y(0,g.y,u,g.y),g.x>0&&g.x<u&&y(g.x,p,g.x,0);let S="x",I="y";i===ko&&(S=Cd,I=Td),f({id:"axis-label-x",content:S,x:u-Re-ka,y:g.y-Da,color:r.axis,fontSize:ms,options:{textAlign:"center",textBaseline:"bottom"}}),f({id:"axis-label-y",content:I,x:g.x+Ra,y:Re+La,color:r.axis,fontSize:ms,options:{textAlign:"left",textBaseline:"middle"}}),x=m(d.interval1,d.alpha1,d.interval2,d.alpha2)}return Hh(e,g,u,p,i,f,r),e.restore(),x}function Wh(e,t,{canvas:n,dpr:s,colors:i},o,a,r,c,l){const d=n.width/s,h=n.height/s,f=o({x:0,y:0}),u=f.y>-20&&f.y<h+Pt,p=f.x>-20&&f.x<d+Pt;if(!u&&!p)return;const{interval1:g,interval2:y,alpha1:m,alpha2:x}=r,S=new Map,I=g||y||1,b=I>0?Math.max(0,-Math.floor(Math.log10(I))):0,v=(C,_,P)=>{if(!C||_<qi)return;let M=0;if(u){const L=a({x:0,y:f.y}),B=a({x:d,y:f.y});M=Math.max(M,Math.abs(L.x),Math.abs(B.x))}if(p){const L=a({x:f.x,y:0}),B=a({x:f.x,y:h});M=Math.max(M,Math.abs(L.y),Math.abs(B.y))}M*=1.1;const w=1,O=Math.ceil(M/C),A=Math.min(O,w+1e3);for(let L=w;L<=A;L++){const B=L*C;let F=!1;if(u){const R=o({x:B,y:0}).x,N=o({x:-B,y:0}).x;(R>=-20&&R<=d+Pt||N>=-20&&N<=d+Pt)&&(F=!0)}if(!F&&p){const R=o({x:0,y:B}).y,N=o({x:0,y:-B}).y;(R>=-20&&R<=h+Pt||N>=-20&&N<=h+Pt)&&(F=!0)}if(F){const R=S.get(B);R?P?S.set(B,{alpha:Math.max(R.alpha,_),isCoarser:!0}):R.isCoarser||S.set(B,{alpha:Math.max(R.alpha,_),isCoarser:!1}):S.set(B,{alpha:_,isCoarser:P})}}},E=!y||g>=y;v(g,m,E),v(y,x,!E),S.forEach((C,_)=>{const P=C.isCoarser?1:C.alpha,M=`rgba(${i.axisTickLabel.join(",")}, ${Ii*P})`;e.strokeStyle=M,e.lineWidth=Gn;let w;if(l){const T=Math.log10(Math.abs(_)),A=Math.floor(T),L=I/Math.pow(10,A),B=Math.max(0,-Math.floor(Math.log10(L))+1),R=Math.abs(_).toExponential(B).split("e");let N=R[0];N=N.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let $=parseInt(R[1],10);w=`${_<0?"-":""}${N} \\cdot 10^{${$}}`}else w=_.toFixed(b).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const O=_.toExponential(15);if(u){const T=o({x:_,y:0});T.x>-20&&T.x<d+Pt&&(e.beginPath(),e.moveTo(T.x,f.y-rt/2),e.lineTo(T.x,f.y+rt/2),e.stroke(),c({id:`polartick-r-x-${O}`,content:w,x:T.x,y:f.y+rt+es,color:M,fontSize:xs,options:{textAlign:"center",textBaseline:"top"}}));const A=o({x:-_,y:0});A.x>-20&&A.x<d+Pt&&(e.beginPath(),e.moveTo(A.x,f.y-rt/2),e.lineTo(A.x,f.y+rt/2),e.stroke(),c({id:`polartick-r-negx-${O}`,content:w,x:A.x,y:f.y+rt+es,color:M,fontSize:xs,options:{textAlign:"center",textBaseline:"top"}}))}if(p){const T=o({x:0,y:_});T.y>-20&&T.y<h+Pt&&(e.beginPath(),e.moveTo(f.x-rt/2,T.y),e.lineTo(f.x+rt/2,T.y),e.stroke(),c({id:`polartick-r-posy-${O}`,content:w,x:f.x-rt-es,y:T.y,color:M,fontSize:xs,options:{textAlign:"right",textBaseline:"middle"}}));const A=o({x:0,y:-_});A.y>-20&&A.y<h+Pt&&(e.beginPath(),e.moveTo(f.x-rt/2,A.y),e.lineTo(f.x+rt/2,A.y),e.stroke(),c({id:`polartick-r-negy-${O}`,content:w,x:f.x-rt-es,y:A.y,color:M,fontSize:xs,options:{textAlign:"right",textBaseline:"middle"}}))}})}function Kh(e,t,{canvas:n,dpr:s,colors:i},o,a){const r=n.width/s,c=n.height/s,l=o({x:0,y:0}),d=(g,y,m,x)=>{e.beginPath(),e.moveTo(g,y),e.lineTo(m,x),e.stroke();const S=Math.atan2(x-y,m-g);e.beginPath(),e.moveTo(m,x),e.lineTo(m-Re*Math.cos(S-rn),x-Re*Math.sin(S-rn)),e.lineTo(m-Re*Math.cos(S+rn),x-Re*Math.sin(S+rn)),e.closePath(),e.fill()};e.lineWidth=Gn;const h=r>l.x,f=0<l.x,u=0<l.y,p=c>l.y;h&&(d(l.x,l.y,r,l.y),a({id:"axis-label-r-posx",content:ei,x:r-Re-ka,y:l.y-Da,color:i.axis,fontSize:ms,options:{textAlign:"center",textBaseline:"bottom"}})),f&&(d(l.x,l.y,0,l.y),a({id:"axis-label-r-negx",content:ei,x:Re+ka,y:l.y-Da,color:i.axis,fontSize:ms,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(d(l.x,l.y,l.x,0),a({id:"axis-label-r-posy",content:ei,x:l.x+Ra,y:Re+La,color:i.axis,fontSize:ms,options:{textAlign:"left",textBaseline:"middle"}})),p&&(d(l.x,l.y,l.x,c),a({id:"axis-label-r-negy",content:ei,x:l.x+Ra,y:c-Re-La,color:i.axis,fontSize:ms,options:{textAlign:"left",textBaseline:"middle"}}))}function qh(e,{canvas:t,dpr:n,colors:s,gridAlpha:i},o,a,r,c,l){const d=t.width/n,h=t.height/n,f=Math.min(d,h)*id;let u,p;if(o.x>=0&&o.x<=d&&o.y>=0&&o.y<=h)u=0;else{const M=[ni(o.x,o.y,0,0,d,0),ni(o.x,o.y,d,0,d,h),ni(o.x,o.y,d,h,0,h),ni(o.x,o.y,0,h,0,0)];u=Math.min(...M)}const y=[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(M=>Math.sqrt((M.x-o.x)**2+(M.y-o.y)**2));p=Math.max(...y);const m=u*n/r.scale,x=p*n/r.scale,S=(M,w)=>{if(!M||w<qi||M*r.scale/n<Zd)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${w*i})`,e.lineWidth=Gn;const T=m===0?1:Math.ceil(m/M),A=Math.floor(x/M);for(let L=T;L<=A;L++){const F=L*M*r.scale/n;if(F>f){const R=[],N={center:{x:o.x,y:o.y},radius:F};if([{p1:{x:0,y:0},p2:{x:d,y:0}},{p1:{x:d,y:0},p2:{x:d,y:h}},{p1:{x:d,y:h},p2:{x:0,y:h}},{p1:{x:0,y:h},p2:{x:0,y:0}}].forEach(D=>{gr(D,N).forEach(V=>{V.x>=0&&V.x<=d&&V.y>=0&&V.y<=h&&R.push(V)})}),R.length>=2){let D=R[0],k=R[1],V=0;for(let G=0;G<R.length;G++)for(let X=G+1;X<R.length;X++){const H=(R[G].x-R[X].x)**2+(R[G].y-R[X].y)**2;H>V&&(V=H,D=R[G],k=R[X])}e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(k.x,k.y),e.stroke()}}else e.beginPath(),e.arc(o.x,o.y,F,0,Ye),e.stroke()}};if(S(c.interval1,c.alpha1),S(c.interval2,c.alpha2),!l||!Array.isArray(l))return;const I={x:d/2,y:h/2},b=Math.min(d,h)/4,v=Math.sqrt((o.x-I.x)**2+(o.y-I.y)**2),E=b+v;if(E<Ll||!Hl(o.x,o.y,E,d,h))return;const C=E>f;let _=null;if(C){const M={x:0,y:0,w:d,h},w={x:o.x,y:o.y,r:E},O=Va(w,M);if(O.length>=2){let T=O[0],A=O[1],L=0;for(let R=0;R<O.length;R++)for(let N=R+1;N<O.length;N++){const $=(O[R].x-O[N].x)**2+(O[R].y-O[N].y)**2;$>L&&(L=$,T=O[R],A=O[N])}const B=(Math.atan2(o.y-T.y,T.x-o.x)*180/Math.PI+360)%360,F=(Math.atan2(o.y-A.y,A.x-o.x)*180/Math.PI+360)%360;_={minAngle:Math.min(B,F),maxAngle:Math.max(B,F),isFullCircle:!1},Math.abs(B-F)>180&&(_={minAngle:Math.max(B,F),maxAngle:Math.min(B,F)+360,isFullCircle:!1})}}else _=Yl(o,E,d,h);if(!_)return;const P=new Set;l.forEach(M=>{const w=M.alpha;if(w<Dl||E*(M.angle*Math.PI/180)<Ol*.5)return;e.strokeStyle=`rgba(${s.grid.join(",")}, ${w*i})`,e.lineWidth=Gn*vd;let T;if(_.isFullCircle){T=[];for(let A=0;A<360;A+=M.angle)T.push(A)}else{if(T=[],_.ranges&&Array.isArray(_.ranges))_.ranges.forEach(A=>{let[L,B]=A;if(C){const $=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(V=>(Math.atan2(o.y-V.y,V.x-o.x)*180/Math.PI+360)%360),L,B].sort((V,G)=>V-G),D=Math.min(...$)-M.angle*2,k=Math.max(...$)+M.angle*2;L=D,B=k}const F=Ci(M.angle,L,B);T.push(...F)});else if(_.minAngle!==void 0&&_.maxAngle!==void 0){let A=_.minAngle,L=_.maxAngle;if(C){const R=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(D=>(Math.atan2(o.y-D.y,D.x-o.x)*180/Math.PI+360)%360),A,L].sort((D,k)=>D-k),N=Math.min(...R)-M.angle*2,$=Math.max(...R)+M.angle*2;A=N,L=$}T=Ci(M.angle,A,L)}T=[...new Set(T)]}T.forEach(A=>{if(A=Math.round(A*1e10)/1e10,P.has(A))return;const L=A*Math.PI/180,B={x:o.x+m*r.scale/n*Math.cos(L),y:o.y-m*r.scale/n*Math.sin(L)},F={x:o.x+x*r.scale/n*Math.cos(L),y:o.y-x*r.scale/n*Math.sin(L)};e.beginPath(),e.moveTo(B.x,B.y),e.lineTo(F.x,F.y),e.stroke(),P.add(A)})})}function jh(e,{gridDisplayMode:t,canvas:n,dpr:s,viewTransform:i,gridAlpha:o,colors:a},r,c,l,d){if(t===Xo)return;e.save();const h=r({x:0,y:0}),f=n.width/s,u=n.height/s;if(t===fr){const p=c({x:0,y:0}),g=c({x:f,y:u}),y=Math.hypot(Math.max(Math.abs(p.x),Math.abs(g.x)),Math.max(Math.abs(p.y),Math.abs(g.y)));qh(e,{canvas:n,dpr:s,colors:a,gridAlpha:o},h,y,i,l,d)}else{const p=(g,y)=>{if(!g||y<qi)return;const m=`rgba(${a.grid.join(",")}, ${y*o})`,x=c({x:0,y:u}),S=c({x:f,y:0}),I=Math.floor(x.x/g),b=Math.ceil(S.x/g),v=Math.floor(x.y/g),E=Math.ceil(S.y/g);if(t===cr){e.strokeStyle=m,e.lineWidth=Gn;for(let C=I;C<=b;C++){const _=C*g,P=r({x:_,y:0}).x;e.beginPath(),e.moveTo(P,0),e.lineTo(P,u),e.stroke()}for(let C=v;C<=E;C++){const _=C*g,P=r({x:0,y:_}).y;e.beginPath(),e.moveTo(0,P),e.lineTo(f,P),e.stroke()}}else if(t===dr){e.fillStyle=m;const C=el*s;for(let _=I;_<=b;_++){const P=_*g;for(let M=v;M<=E;M++){const w=M*g,O=r({x:P,y:w});e.beginPath(),e.arc(O.x,O.y,C,0,Ye),e.fill()}}}else if(t===hr){e.fillStyle=m;const C=el*s,_=g*er,P=Math.floor(x.y/_),M=Math.ceil(S.y/_);for(let w=P;w<=M;w++){const O=w*_,A=w%2!==0?g/2:0;for(let L=I;L<=b;L++){const F=L*g+A,R=r({x:F,y:O});e.beginPath(),e.arc(R.x,R.y,C,0,Ye),e.fill()}}}};p(l.interval1,l.alpha1),p(l.interval2,l.alpha2)}e.restore()}function mr(e,t,n,s,i,o,a=!1){e.save(),e.strokeStyle=o,e.lineWidth=Gn,e.setLineDash(a?Al:[]);const r=-n,c=-s;let l=ct(s-n);e.beginPath(),e.arc(t.x,t.y,i,r,c,l>0),e.stroke(),e.restore()}function zl(e,{info:t,colors:n,idPrefix:s,startVertexScreen:i},o,a,r){if(!t||!t.edge)return;const{edge:c,fraction:l,snapPoint:d}=t,h=a(c.id1),f=a(c.id2);if(!h||!f)return;const u=o(h),p=o(f),g=o(d),y=n.feedbackSnapped,m=xh({x:-(p.y-u.y),y:p.x-u.x});let x=1;i&&(x=(p.x-u.x)*(i.y-u.y)-(p.y-u.y)*(i.x-u.x)>0?-1:1);const S=vo,I={x:(u.x+g.x)/2,y:(u.y+g.y)/2},b={x:I.x+x*m.x*S,y:I.y+x*m.y*S},v=ln(l,.001,8);r({id:`${s}-1`,content:v,x:b.x,y:b.y,color:y,fontSize:Aa,options:{textAlign:"center",textBaseline:"middle"}});const E={x:(g.x+p.x)/2,y:(g.y+p.y)/2},C={x:E.x+x*m.x*S,y:E.y+x*m.y*S},_=ln(1-l,.001,8);r({id:`${s}-2`,content:_,x:C.x,y:C.y,color:y,fontSize:Aa,options:{textAlign:"center",textBaseline:"middle"}})}function Uh(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:s,isDragConfirmed:i,dragPreviewVertices:o,colors:a,edgesVisible:r,snappedEdgeIds:c,currentAltPressed:l,interpolationStyle:d,getInterpolationStyleById:h,edgeColorMode:f="fixed",edgeColorExpression:u="x"},p,g,y){e.lineWidth=ys;const m=gt(a.defaultStroke,{r:255,g:255,b:255,a:1}),x=I=>{const b=I?.color||a.vertex||a.defaultStroke;return gt(b,m)},S=(I,b,v,E)=>{const C=os(I,f);if(C==="inherit_vertices"&&v&&E){const _=x(v),P=x(E);return{r:Dt(_.r,P.r,b),g:Dt(_.g,P.g,b),b:Dt(_.b,P.b,b),a:Dt(_.a,P.a,b)}}if(C==="colormap"&&I.colormapItem){const _=Qs(u,{x:b},b),P=eo(_),M=De(I.colormapItem,P);return gt(M,m)}return gt(I.color||a.defaultStroke,m)};t.forEach(I=>{const b=g(I.id1),v=g(I.id2);if(!b||!v||b.type!==Hn||v.type!==Hn)return;const E=y(I),C=n.includes(E),_=c&&c.has(E)&&c.get(E).some(R=>R.copyIndex===void 0||R.copyIndex===0),P=!l&&E===s;if(!r&&!C&&!_&&!P)return;let M=b,w=v;const O=I.interpolationStyleId&&h?h(I.interpolationStyleId):d,A=(O?lo([M,w],O,!1,p):[M,w]).map(R=>p(R));if(A.length<2)return;const L=A[0],B=A[A.length-1];e.beginPath(),e.moveTo(A[0].x,A[0].y);for(let R=1;R<A.length;R++)e.lineTo(A[R].x,A[R].y);const F=os(I,f);if(F==="colormap"||F==="inherit_vertices"){let R=0;for(let $=1;$<A.length;$++)R+=Math.hypot(A[$].x-A[$-1].x,A[$].y-A[$-1].y);let N=0;for(let $=1;$<A.length;$++){const D=A[$-1],k=A[$],V=Math.hypot(k.x-D.x,k.y-D.y),G=R>0?N/R:0,X=R>0?(N+V)/R:1,H=(G+X)/2,Y=S(I,H,M,w);e.strokeStyle=`rgba(${Math.round(Y.r)},${Math.round(Y.g)},${Math.round(Y.b)},${Y.a})`,e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(k.x,k.y),e.setLineDash([]),e.lineWidth=ys,e.stroke(),N+=V}}else if(I.colormapItem){const R=e.createLinearGradient(L.x,L.y,B.x,B.y),N=De(I.colormapItem,I.gradientStart),$=De(I.colormapItem,I.gradientEnd);R.addColorStop(0,N),R.addColorStop(1,$),e.strokeStyle=R,e.setLineDash([]),e.lineWidth=ys,e.stroke()}else e.strokeStyle=I.color||a.defaultStroke,e.setLineDash([]),e.lineWidth=ys,e.stroke();if(C||_||P){e.save(),e.strokeStyle=_?a.feedbackSnapped:a.selectionGlow,e.globalAlpha=Cs,e.lineWidth=ls,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(A[0].x,A[0].y);for(let R=1;R<A.length;R++)e.lineTo(A[R].x,A[R].y);e.stroke(),e.restore()}}),e.setLineDash([]),e.strokeStyle=a.defaultStroke,e.globalAlpha=1}function Ti(e,t,n,s,i){const{selectedVertexIds:o,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,snappedVertexIds:h,isDragConfirmed:f,dragPreviewVertices:u,currentAltPressed:p}=n;let g=t,y=!1,m=null,x;if(f&&u){const v=u.find(E=>E&&(E.id===t.id||E.originalId===t.id));v&&(g=v,x=v.transformIndex)}if(h&&g.originalId&&h.has(g.originalId)){const E=h.get(g.originalId).find(C=>C.copyIndex===x);E&&(y=!0,m=E.type)}else if(h&&!g.originalId&&h.has(g.id)){const E=h.get(g.id).find(C=>C.copyIndex===x);E&&(y=!0,m=E.type)}let S;if(g.type===Hn){if(S=o.includes(g.id),!l&&!S&&!d&&!y&&!(p&&d))return}else S=a.includes(g.id);const I=s(g);switch(g.type){case Hn:e.beginPath(),e.arc(I.x,I.y,Ve,0,Ye),e.fillStyle=g.color||c.vertex,e.fill();break;case un:case Un:case In:case us:const v=Ki*2,E={type:g.type,x:I.x-v/2,y:I.y-v/2,width:v,height:v};ta(e,E,c);break}const b={...n,isSnapped:y,snapType:m};yr(e,g,b,s)}function Jh(e,{altHoverInfo:t,colors:n},s,i,o){if(!t)return;const{point:a,element:r,shiftKey:c,fraction:l}=t,d=s(a),h=n.feedbackSnapped,f=n.feedbackSnapped;e.save(),e.shadowColor=f,e.shadowBlur=ir,e.globalAlpha=Cs,e.beginPath();const u=Ve+Ei;e.arc(d.x,d.y,u,0,Ye),e.strokeStyle=f,e.lineWidth=ls,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(d.x,d.y,Ve,0,Ye),e.fillStyle=h,e.fill(),e.restore(),r.type==="edge"&&c&&Zh(e,{info:{edge:r.edge,fraction:l,snapPoint:a},colors:n},s,i,o)}function Zh(e,{info:t,colors:n},s,i,o){zl(e,{info:t,colors:n,idPrefix:"alt-snap-label"},s,i,o)}function Qh(e,{info:t,colors:n},s,i,o){if(!t||!t.startVertex)return;const a=s(t.startVertex);zl(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:a},s,i,o)}function ef(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,currentPos:r,rotation:c,isSnapping:l,snapType:d}=t,h=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(o),u=i(a),p=i(r);if(e.save(),e.lineWidth=dn,e.strokeStyle=h,e.setLineDash(Vn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!s||s&&d==="projection"){const y=We(a,o,c,1),m=i(y);e.beginPath(),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.stroke()}if(Math.abs(c)>nr){e.setLineDash([]);const y=Q(f,u),m=Math.atan2(u.y-f.y,u.x-f.x),x=-c,S=c>0;e.beginPath(),e.arc(f.x,f.y,y,m,m+x,S),e.stroke()}e.restore()}function tf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,scale:r,isSnapping:c,snapType:l,currentPos:d}=t,h=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(o),u=i(a),p=i(d);if(e.save(),e.lineWidth=dn,e.strokeStyle=h,e.setLineDash(Vn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!s){const x=Q(f,p),S=Math.atan2(u.y-f.y,u.x-f.x),I=Math.atan2(p.y-f.y,p.x-f.x);let b=I-S;b>Math.PI?b-=2*Math.PI:b<-Math.PI&&(b+=2*Math.PI);const v=b<0;e.beginPath(),e.arc(f.x,f.y,x,S,I,v),e.stroke()}const y={x:o.x+(a.x-o.x)*r,y:o.y+(a.y-o.y)*r},m=i(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(m.x,m.y),e.stroke(),e.restore()}function nf(e,{transformIndicatorData:t,colors:n,currentShiftPressed:s},i){const{center:o,startPos:a,currentPos:r,scale:c,startVector:l,isSnapping:d,snapType:h,projectionSource:f}=t,u=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,p=i(o),g=i(a),y=i(r);e.save(),e.lineWidth=dn,e.strokeStyle=u,e.setLineDash(Vn),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(g.x,g.y),e.stroke();const m=We(a,o,0,c,!0,l),x=i(m);if((!s||s&&h==="projection")&&(e.setLineDash(Vn),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(x.x,x.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(x.x,x.y),e.stroke(),d&&h==="projection"&&f){const I=i(f),b=o,v={x:o.x+l.x,y:o.y+l.y},E=Fl(f,b,v),C=i(E);e.setLineDash(Vn),e.beginPath(),e.moveTo(I.x,I.y),e.lineTo(C.x,C.y),e.stroke()}e.restore()}function sf(e,{transformIndicatorData:t,colors:n},s){const{center:i,startPos:o,rotation:a,scale:r,isSnapping:c}=t,l=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,d=s(i),h=s(o);e.save(),e.lineWidth=dn,e.strokeStyle=l,e.setLineDash(Vn),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(h.x,h.y),e.stroke();const f={x:i.x+(o.x-i.x)*r,y:i.y+(o.y-i.y)*r},u=s(f);if(e.setLineDash([]),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(a)>nr){const p=Q(d,u),g=Math.atan2(h.y-d.y,h.x-d.x),y=-a,m=a>0;e.beginPath(),e.arc(d.x,d.y,p,g,g+y,m),e.stroke()}e.restore()}function of(e,t,{transformIndicatorData:n,colors:s,coordSystemTransformIndicatorData:i,currentShiftPressed:o},a,r){if(n){const{isSnapping:c,snapType:l,transformType:d}=n;switch(e.save(),e.lineWidth=dn,d){case In:sf(e,{transformIndicatorData:n,colors:s},a);break;case un:ef(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break;case Un:tf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break;case us:nf(e,{transformIndicatorData:n,colors:s,currentShiftPressed:o},a);break}c&&l==="projection"&&o&&af(e,{transformIndicatorData:n,colors:s},a),e.restore(),rf(t,{transformIndicatorData:n,colors:s},a,r)}i&&lf(t,{coordSystemTransformIndicatorData:i,colors:s},a,r)}function af(e,{transformIndicatorData:t,colors:n},s){const{transformType:i,projectionSource:o,projectionCenter:a,projectionPoint:r,currentPos:c}=t;if(i!==In){if(e.setLineDash(Vn),e.strokeStyle=n.feedbackSnapped,i===un&&r){const l=s(c),d=s(r),h=s(o);e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(d.x,d.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(d.x,d.y),e.stroke()}else if(i===Un&&a){const l=s(a),d=s(o),h=s(c),f=Q(l,d);let u=Math.atan2(d.y-l.y,d.x-l.x),p=Math.atan2(h.y-l.y,h.x-l.x);const g=2*Math.PI;u=(u+g)%g,p=(p+g)%g;const y=(p-u+g)%g,x=(u-p+g)%g<y;e.beginPath(),e.arc(l.x,l.y,f,u,p,x),e.stroke()}}}function rf(e,{transformIndicatorData:t,colors:n},s,i){const{center:o,startPos:a,rotation:r,scale:c,isSnapping:l,snapType:d,snappedScaleValue:h,transformType:f}=t,u=s(o),p=s(a),g=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(f===Un||f===In||f===us){let y;const m=h!==null?h:c;d==="projection"||d==="merge"&&f===In?y=`\\times ${parseFloat(m.toFixed(ma)).toString()}`:l&&h!==null?y=`\\times ${ln(h,Ss,Hd)}`:y=`\\times ${parseFloat(m.toFixed(ma)).toString()}`;const S=(u.x+p.x)/2,I=(u.y+p.y)/2,b=Math.atan2(p.y-u.y,p.x-u.x),v=b-Math.PI/2,E=S+Math.cos(v)*Ur,C=I+Math.sin(v)*Ur;let _=b*(180/Math.PI);(_>90||_<-90)&&(_+=180),i({id:"transform-scale-indicator",content:y,x:E,y:C,color:g,fontSize:xn,options:{textAlign:"center",textBaseline:"bottom",rotation:_}})}else i({id:"transform-scale-indicator",content:"",x:0,y:0,color:g,fontSize:xn,options:{}});if((f===un||f===In)&&Math.abs(r)>nr){const y=r*(180/Math.PI),m=`${parseFloat(y.toFixed(ma)).toString()}^{\\circ}`,x={x:p.x-u.x,y:p.y-u.y},S=Math.atan2(x.y,x.x)+-r/2,b=Math.hypot(x.x,x.y)+Gd,v=u.x+b*Math.cos(S),E=u.y+b*Math.sin(S);let C=S*(180/Math.PI);(C>90||C<-90)&&(C+=180),i({id:"transform-angle-indicator",content:m,x:v,y:E,color:g,fontSize:xn,options:{rotation:C}})}else i({id:"transform-angle-indicator",content:"",x:0,y:0,color:g,fontSize:xn,options:{}})}function lf(e,{coordSystemTransformIndicatorData:t,colors:n},s,i){const{edgeFraction:o,orthogonalDistanceFraction:a,v1:r,v2:c,snapPosition:l}=t;let d="",h={x:0,y:0};if(a!==void 0){d=ln(a,.001,8);const f=s(l.origin),u=s(l.closest),p=(f.x+u.x)/2,g=(f.y+u.y)/2,y=Math.atan2(u.y-f.y,u.x-f.x);h.x=p+Math.cos(y+Math.PI/2)*vo,h.y=g+Math.sin(y+Math.PI/2)*vo}else if(o!==void 0){const f=s(r),u=s(c),p=s(l),g=Math.atan2(u.y-f.y,u.x-f.x),y=Math.cos(g+Math.PI/2)*vo,m=Math.sin(g+Math.PI/2)*vo;h.x=p.x+y,h.y=p.y+m,d=ln(o,.001,8)}d&&i({id:"coord-system-edge-fraction",content:d,x:h.x,y:h.y,color:n.feedbackSnapped,fontSize:Aa,options:{textAlign:"center",textBaseline:"middle"}})}function cf(e,t,n,s,{showAngles:i,showDistances:o,viewTransform:a,mousePos:r,colors:c}){if(!i&&!o||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,d=s(r);if(Q(l,d)<le)return;const f=c.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,p=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const g=n(l),y=p+u;if(e.save(),e.lineWidth=dn,e.strokeStyle=f,i&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>le){const m=ro+e.lineWidth/2,x={x:l.x+Math.cos(p)*(m/a.scale),y:l.y+Math.sin(p)*(m/a.scale)},S=n(x);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(S.x,S.y),e.setLineDash(dd),e.stroke(),mr(e,g,p,y,ro,f,!1)}e.restore()}function Wl(e,t,n,s,i,{showDistances:o,showAngles:a,currentShiftPressed:r,distanceSigFigs:c,angleSigFigs:l,angleDisplayMode:d,viewTransform:h,frozenReference_D_du:f,gridDisplayMode:u,frozenReference_A_rad:p,colors:g,lastGridState:y},m,x,S){if(!a&&!o||i.distance<le){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const I=m(n),{angle:b,distance:v,lengthSnapFactor:E,angleSnapFactor:C,angleTurn:_,gridToGridSquaredSum:P,gridInterval:M,snapType:w}=i,{offsetAngleRad:O,isFirstSegmentBeingDrawn:T,currentSegmentReferenceD:A}=x,L=i.snapped||r?g.feedbackSnapped:g.geometryInfoText,B=Math.atan2(s.y-n.y,s.x-n.x);if(v*h.scale/window.devicePixelRatio<Rl){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const F=a&&v>le&&(T||Math.abs(_)>le);if(o){let R="",N=i.gridInterval||null;if(!N&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&(N=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),r&&i.snapped)if(T)if(w==="grid"&&P!==null&&N)if(P===0)R="0";else{const[$,D]=Is(P),k=N*$,V=parseFloat(k.toFixed(10));R=bs(V,D)}else if(w==="geometric"&&E!==null){const $=E*A;R=ln($,Ss,qs),(R===$.toFixed(2)||R===String(Math.round($)))&&(R=ft($,c))}else if(w==="vertex"||w==="edge_fraction"||w==="edge"){let $=!1;if(N){const D=i.x-n.x,k=i.y-n.y,V=D/N,G=k/N;if(Math.abs(V-Math.round(V))<1e-5&&Math.abs(G-Math.round(G))<1e-5){const X=Math.round(V),H=Math.round(G),Y=X*X+H*H;if(Y===0)R="0";else{const[W,J]=Is(Y),ee=N*W,oe=parseFloat(ee.toFixed(10));R=bs(oe,J)}$=!0}}$||(R=ft(v,c))}else R=ft(v,c);else if(w==="geometric"&&E!==null)R=zs(E,"D");else if(w==="grid"&&P!==null&&N&&f!==null&&f>le){const D=N*Math.sqrt(P)/f;let k=!1;for(const V of ss)if(Math.abs(D-V)<le){R=zs(V,"D"),k=!0;break}if(!k)if(P===0)R="0";else{const[V,G]=Is(P),X=N*V,H=parseFloat(X.toFixed(10));R=bs(H,G)}}else if(w==="vertex"||w==="edge_fraction"||w==="edge")if(f!==null&&f>le){const $=v/f;let D=!1;for(const k of ss)if(Math.abs($-k)<le){R=zs(k,"D"),D=!0;break}D||(R=ft(v,c))}else R=ft(v,c);else R=ft(v,c);else if(!T&&f!==null&&f>le){const $=v/f;let D=!1;for(const k of ss)if(Math.abs($-k)<le){R=zs(k,"D"),D=!0;break}D||(R=ft(v,c))}else R=ft(v,c);if(R){const $=m(n),D=m(s),k=Math.atan2(D.y-$.y,D.x-$.x),V=($.x+D.x)/2,G=($.y+D.y)/2;let X;if(F){const J=T?-B:-_;J<0&&J>-Math.PI||J>Math.PI?X=k-Math.PI/2:X=k+Math.PI/2}else X=k-Math.PI/2,Math.sin(X)>0&&(X+=Math.PI);const H=V+Math.cos(X)*ts,Y=G+Math.sin(X)*ts;let W=k*(Co/Math.PI);(W>_l||W<-90)&&(W+=Co),S({id:"snap-dist",content:R,x:H,y:Y,color:L,fontSize:xn,options:{rotation:W}},t)}else S({id:"snap-dist",content:"",x:0,y:0})}else S({id:"snap-dist",content:"",x:0,y:0});if(F){const R=T?0:O;mr(e,I,R,B,ro,L),e.save(),e.beginPath();const N=ro+e.lineWidth/2,$={x:n.x+N/h.scale*Math.cos(R),y:n.y+N/h.scale*Math.sin(R)},D=m($);e.moveTo(I.x,I.y),e.lineTo(D.x,D.y),e.strokeStyle=L,e.setLineDash(cd),e.lineWidth=dn,e.stroke(),e.restore();let k="";const V=!T&&p!==null&&Math.abs(p)>le,G=x.currentSegmentReferenceA_for_display,X=T?B:_;if(d===Ts){let H=ct(X)*(180/Math.PI);r&&!T&&i.snapped&&w==="geometric"&&C!==null||r&&V&&C!==null&&i.snapped&&w!=="geometric"?k=zs(C,"A"):Math.abs(H)>Mi&&(k=`${ft(H,l)}^{\\circ}`)}else if(d===Yo){let H=ct(X);if(r&&!T&&i.snapped&&w==="geometric"&&C!==null&&G){const Y=ln(C*(G/Math.PI),Ss,qs);Y==="0"?k="0":Y==="1"?k=Lt:Y==="-1"?k=`-${Lt}`:k=`${Y}${Lt}`}else if(r&&V&&C!==null&&i.snapped&&w!=="geometric"&&G){const Y=ln(C*(G/Math.PI),Ss,qs);Y==="0"?k="0":Y==="1"?k=Lt:Y==="-1"?k=`-${Lt}`:k=`${Y}${Lt}`}else if(Math.abs(H)>Mi){const Y=ln(H/Math.PI,Ss,qs);Y!==H.toFixed(2)?Y==="0"?k="0":Y==="1"?k=Lt:Y==="-1"?k=`-${Lt}`:k=`${Y}${Lt}`:k=ft(H,l)}}if(k){const H=-R,Y=-B,W=Math.cos(H)+Math.cos(Y),J=Math.sin(H)+Math.sin(Y),ee=Math.atan2(J,W),oe=vi;let ye=ee*(180/Math.PI);const qe={x:oe*Math.cos(ee),y:oe*Math.sin(ee)},ke={x:I.x+qe.x,y:I.y+qe.y};(ye>90||ye<-90)&&(ye+=180),S({id:"snap-angle",content:k,x:ke.x,y:ke.y,color:L,fontSize:xn,options:{rotation:ye}},t)}else S({id:"snap-angle",content:"",x:0,y:0})}else S({id:"snap-angle",content:"",x:0,y:0})}function df(e,t,{showAngles:n,showDistances:s,viewTransform:i,mousePos:o,frozenReference_D_du:a,distanceSigFigs:r,angleSigFigs:c,angleDisplayMode:l,colors:d},h,f,u){const p=Rl/i.scale;let g=-1;if(t.frozen_Origin_Data_to_display){const M=t.frozen_Origin_Data_to_display,w=h(o);g=Q(M,w)}if(!n&&!s||!t.frozen_Origin_Data_to_display||g<p)return;const y=d.frozenReference,m=t.frozen_Origin_Data_to_display,x=t.displayAngleA_valueRad_for_A_equals_label,S=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,I=t.frozen_D_du_to_display,b=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,v=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!m)return;const E=S+x,C={x:m.x+I*Math.cos(E),y:m.y+I*Math.sin(E)},_=f(m),P=f(C);if(s&&I!==null&&I>p){let M="";if(b!==null&&b>0&&v){const[R,N]=Is(b),$=v*R,D=parseFloat($.toFixed(10));M=`${Zr}${bs(D,N)}`}else{const R=I/Oa;M=`${Zr}${ft(R,r)}`}const w=Math.atan2(P.y-_.y,P.x-_.x),O=(_.x+P.x)/2,T=(_.y+P.y)/2;let A=w*(Co/Math.PI);(A>_l||A<-90)&&(A+=Co);let L;x!==null&&Math.abs(x)>le?-x<0?L=w-Math.PI/2:L=w+Math.PI/2:(L=w-Math.PI/2,Math.sin(L)>0&&(L+=Math.PI));const B=O+Math.cos(L)*bi,F=T+Math.sin(L)*bi;u({id:"ref-dist",content:M,x:B,y:F,color:y,fontSize:Fa,options:{rotation:A}},e)}if(n&&x!==null&&Math.abs(x)>le){const M=-S,w=-(S+x),O=Math.cos(M)+Math.cos(w),T=Math.sin(M)+Math.sin(w),A=Math.atan2(T,O),L=vi,B=_.x+Math.cos(A)*L,F=_.y+Math.sin(A)*L;let R=A*(180/Math.PI);(R>90||R<-90)&&(R+=180);let N="";if(l===Ts){let $=x*(Co/Math.PI);N=`${bo}${ft($,c)}^{\\circ}`}else l===Yo&&(N=`${bo}${ln(x/Math.PI,Ss,qs)}${Lt}`,N===`${bo}1${Lt}`&&(N=Lt),N===`${bo}-1${Lt}`&&(N=`-${Lt}`),N===`${bo}0${Lt}`&&(N="0"));u({id:"ref-angle",content:N,x:B,y:F,color:y,fontSize:Fa,options:{rotation:R}},e)}}function hf(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:s,ghostVertexPosition:i,gridDisplayMode:o,lastGridState:a,angleDisplayMode:r,canvas:c,dpr:l,mousePos:d,colors:h,useScientific:f},u,p){if(t===Ui||!d||!n)return;let g;s&&i?g=i:g=u(d);let y=1;o!==Xo&&a&&a.interval1&&(y=a.interval1);let m=y;a&&a.interval2&&a.interval2<m&&(m=a.interval2);let x,S=1;m>=1e4?(S=100,x=0):m>=1e3?(S=10,x=0):m>=100?(S=1,x=0):m>=10?x=1:x=Math.max(0,-Math.floor(Math.log10(m)))+2;const v=(M=>1)(m)+2,E=M=>{if(f){const w=v-1,T=Math.abs(M).toExponential(w).split("e");let A=T[0],L=parseInt(T[1],10);return`${M<0?"-":""}${A} \\cdot 10^{${L}}`}else return S>1?(Math.round(M/S)*S).toFixed(x):M.toFixed(x)},C=Math.min(x,zd);let _="";switch(t){case lr:{let M=E(g.x);g.x>=0&&!M.includes("cdot")&&(M=`${Hs}${M}`);let w=E(g.y);g.y>=0&&!w.includes("cdot")&&(w=`${Hs}${w}`),_=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${M} \\\\ ${w} \\end{pmatrix*}`;break}case ko:{let M=E(g.x);g.x>=0&&!M.includes("cdot")&&(M=`${Hs}${M}`);const w=Math.abs(g.y);let O=E(w);const T=g.y<0?"-":"+";_=`z = ${M} ${T} ${O}${ri}`;break}case Ji:{const M=Math.hypot(g.x,g.y),w=Math.atan2(g.y,g.x);let O=E(M);M>=0&&!O.includes("cdot")&&(O=`${Hs}${O}`);let T;if(r===Ts){let A=yh(w*180/Math.PI);T=A.toFixed(C),A>=0&&(T=`${Hs}${T}`),T+="^{\\circ}"}else{let A=ct(w);T=A.toFixed(C),A>=0&&(T=`${Hs}${T}`)}_=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${O} \\\\ ${T} \\end{pmatrix*}`;break}}const P=c.width/l;p({id:"mouse-coord-text",content:_,x:P-qr,y:qr,color:h.mouseCoords,fontSize:Wd,options:{textAlign:"right",textBaseline:"top"}})}function Kl(e,t,n,s){e.save();const i=t.x+t.width/2,o=t.y+t.height/2,a=t.width/2*.6;if(e.strokeStyle=s.uiIcon,e.fillStyle=s.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(i,o,a*.7,0,2*Math.PI),e.fill();for(let r=0;r<8;r++){const c=r/8*2*Math.PI,l=i+Math.cos(c)*(a*.85),d=o+Math.sin(c)*(a*.85),h=i+Math.cos(c)*(a*1.1),f=o+Math.sin(c)*(a*1.1);e.beginPath(),e.moveTo(l,d),e.lineTo(h,f),e.stroke()}}else e.beginPath(),e.arc(i,o,a,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i-5,o-3,a,0,2*Math.PI),e.fillStyle=s.background,e.fill();e.restore()}function ff(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/mo;e.scale(l,l),e.translate(-16,-16);const d=0;e.strokeStyle=r,e.lineWidth=_n,e.lineCap="round",e.beginPath(),e.moveTo(0+d,32),e.lineTo(32+d,32),e.moveTo(0+d,32),e.lineTo(0+d,0),e.stroke(),e.fillStyle=r;const h={x:16+d,y:16};let f={x:16+d,y:8},u="";switch(n){case lr:e.setLineDash(pa),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(h.x,32),e.moveTo(h.x,h.y),e.lineTo(0+d,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Xn,0,Ye),e.fill(),u="(x,y)";break;case ko:e.setLineDash(pa),e.beginPath(),e.moveTo(0+d,32),e.lineTo(h.x,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Xn,0,Ye),e.fill(),u="x+iy";break;case Ji:e.setLineDash(pa),e.beginPath(),e.moveTo(0+d,32),e.lineTo(h.x,h.y),e.stroke(),e.beginPath(),e.arc(0+d,32,8,-Math.atan2(32-h.y,h.x-(0+d)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Xn,0,Ye),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const p="icon-label-coords",g=s?a.uiTextSelected:a.uiTextDefault;o({id:p,content:u,x:c.x+(f.x-16)*l,y:c.y+(f.y-16)*l,color:g,fontSize:or,options:{textAlign:"center",textBaseline:"middle"}},i)}}function ql(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(c.x,c.y);const d=t.width/mo;e.scale(d,d),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=_n;const h={x:32,y:32},f={x:0,y:32},u={x:16,y:0};e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke();let p="",g={x:20,y:22};if(n!==Ro){e.beginPath();const y=Math.atan2(u.y-f.y,u.x-f.x);e.arc(f.x,f.y,8,y,0),e.stroke(),n===Ts?p="60^\\circ":n===Yo&&(p="\\frac{\\pi}{3}",l=2)}if(e.restore(),p){const y="icon-label-angles",m=s?a.uiTextSelected:a.uiTextDefault;o({id:y,content:p,x:c.x+(g.x-16)*d,y:c.y+(g.y-20)*d,color:m,fontSize:or+l,options:{textAlign:"center",textBaseline:"middle"}},i)}}function jl(e,t,n,s,i,o,a){const r=s?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/mo;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=_n,e.beginPath(),e.moveTo(0,32),e.lineTo(32,32),e.stroke();let d="",h={x:16,y:22};if(n===Lo&&(d="3.14"),e.restore(),d){const f="icon-label-distances",u=s?a.uiTextSelected:a.uiTextDefault;o({id:f,content:d,x:c.x+(h.x-16)*l,y:c.y+(h.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function uf(e,t,n,s,i){const o=s?i.uiIconSelected:i.uiIconDefault,a={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(a.x,a.y);const r=t.width/mo;switch(e.scale(r,r),e.translate(-16,-16),e.strokeStyle=o,e.fillStyle=o,e.lineWidth=_n,n){case cr:e.strokeRect(0,0,32,32),e.beginPath(),e.moveTo(0,16),e.lineTo(32,16),e.moveTo(16,0),e.lineTo(16,32),e.stroke();break;case dr:e.strokeRect(0,0,32,32),e.beginPath(),[8,16,24].forEach(h=>{[8,16,24].forEach(f=>{e.moveTo(h,f),e.arc(h,f,Xn,0,Ye)})}),e.fill();break;case hr:e.strokeRect(0,0,32,32);const c=8,l=16,d=16;e.beginPath(),e.arc(l,d,Xn,0,Ye);for(let h=0;h<6;h++){const f=Math.PI/3*h,u=l+c*Math.cos(f),p=d+c*Math.sin(f);e.moveTo(u,p),e.arc(u,p,Xn,0,Ye)}e.fill();break;case fr:e.beginPath(),e.arc(16,16,14,0,Ye),e.stroke(),e.beginPath(),e.arc(16,16,7,0,Ye),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Xo:e.strokeRect(2,2,28,28);break}e.restore()}function ta(e,t,n){const s={x:t.x+t.width/2,y:t.y+t.height/2},i=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=_n,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(s.x,s.y),t.type){case un:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();const a=i*.25,r=i*Math.cos(o),c=i*Math.sin(o);e.save(),e.translate(r,c),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),d=i*Math.sin(Math.PI+o);e.save(),e.translate(l,d),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();break}case Un:{const o=i*.8,a=i*.25;e.beginPath(),e.moveTo(-o,0),e.lineTo(o,0),e.moveTo(0,-o),e.lineTo(0,o),e.stroke(),[{x:o,y:0,dirX:1,dirY:0},{x:-o,y:0,dirX:-1,dirY:0},{x:0,y:-o,dirX:0,dirY:-1},{x:0,y:o,dirX:0,dirY:1}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}case In:{const o=-Math.PI/4;e.beginPath(),e.arc(0,0,i,o,-o),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+o,Math.PI-o),e.stroke();let a=i*.25;const r=i*Math.cos(o),c=i*Math.sin(o);e.save(),e.translate(r,c),e.rotate(o-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+o),d=i*Math.sin(Math.PI+o);e.save(),e.translate(l,d),e.rotate(o+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const h=i*.8;a=i*.25,e.beginPath(),e.moveTo(-h,0),e.lineTo(h,0),e.moveTo(0,-h),e.lineTo(0,h),e.stroke(),[{x:h,y:0,dirX:1,dirY:0},{x:-h,y:0,dirX:-1,dirY:0},{x:0,y:-h,dirX:0,dirY:-1},{x:0,y:h,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a+u.dirY*a*.5,u.y-u.dirY*a-u.dirX*a*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a-u.dirY*a*.5,u.y-u.dirY*a+u.dirX*a*.5),e.stroke()});break}case us:{const o=i*.8,a=i*.25;e.beginPath(),e.moveTo(-o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(o/Math.sqrt(2),o/Math.sqrt(2)),e.moveTo(o/Math.sqrt(2),-o/Math.sqrt(2)),e.lineTo(-o/Math.sqrt(2),o/Math.sqrt(2)),e.stroke(),[{x:o/Math.sqrt(2),y:-o/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-o/Math.sqrt(2),y:o/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}}e.restore()}function gf(e,t,n){const s=t.x+t.width/2,i=t.y+t.height/2,o=t.width*.6,a=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=_n,e.lineCap="round",e.beginPath(),e.ellipse(s,i,o/2,a/2,0,0,2*Math.PI),e.stroke();const r=a*.3;e.beginPath(),e.arc(s,i,r,0,2*Math.PI),e.fill(),e.restore()}function pf(e,t,n,s){const{canvasUI:i,colors:o,allColors:a,namedColors:r,colorAssignments:c,activeColorTargets:l,lastSelectedSwatchIndex:d,verticesVisible:h,edgesVisible:f,facesVisible:u,isDraggingColorTarget:p,draggedColorTargetInfo:g,mousePos:y}=n,m=o.checkerboardColor1,x=o.checkerboardColor2;function S(C){const _=C.height/3,P=Math.ceil(C.width/_);for(let M=0;M<3;M++)for(let w=0;w<P;w++){e.fillStyle=(M+w)%2===0?m:x;const O=C.x+w*_,T=C.y+M*_,A=Math.min(_,C.x+C.width-O),L=Math.min(_,C.y+C.height-T);A>0&&L>0&&e.fillRect(O,T,A,L)}}const I=i.randomColorButton;if(I){e.fillStyle="#000000",e.fillRect(I.x,I.y,I.width,I.height),e.strokeStyle=o.uiDefault,e.lineWidth=Rn,e.strokeRect(I.x,I.y,I.width,I.height);const C=I.x+I.width/2,_=I.y+I.height/2,P=I.width*.35,M=8;for(let w=0;w<M;w++){const O=w/M*2*Math.PI,T=(w+1)/M*2*Math.PI,A=w/M*360;e.fillStyle=`hsl(${A}, 70%, 60%)`,e.beginPath(),e.moveTo(C,_),e.arc(C,_,P,O,T),e.closePath(),e.fill()}e.fillStyle=o.background,e.beginPath(),e.arc(C,_,P*.4,0,2*Math.PI),e.fill()}const b=i.removeColorButton;b&&(e.strokeStyle=o.uiDefault,e.lineWidth=Rn,e.strokeRect(b.x,b.y,b.width,b.height),e.beginPath(),e.moveTo(b.x+tn,b.y+b.height/2),e.lineTo(b.x+b.width-tn,b.y+b.height/2),e.stroke()),i.colorSwatches.forEach(C=>{const _=C.item;let P=!1;if(_&&_.type==="color"){const M=Ps(_.value);M&&M.a<1&&(P=!0)}else _&&_.type==="colormap"&&_.vertices.some(M=>M.alpha!==void 0&&M.alpha<1)&&(P=!0);if(P&&S(C),_&&_.type==="colormap"){const M=e.createLinearGradient(C.x,C.y,C.x+C.width,C.y);_.vertices.forEach(w=>{let O=w.color;typeof O=="string"&&(O=r[O]||[0,0,0]),M.addColorStop(w.pos,`rgba(${O.join(",")},${w.alpha||1})`)}),e.fillStyle=M}else _&&(e.fillStyle=_.value);e.fillRect(C.x,C.y,C.width,C.height)});const v=i.addColorButton;if(v&&(e.strokeStyle=o.uiDefault,e.lineWidth=Rn,e.strokeRect(v.x,v.y,v.width,v.height),e.beginPath(),e.moveTo(v.x+v.width/2,v.y+tn),e.lineTo(v.x+v.width/2,v.y+v.height-tn),e.moveTo(v.x+tn,v.y+v.height/2),e.lineTo(v.x+v.width-tn,v.y+v.height/2),e.stroke()),i.colorTargetIcons){const C=M=>{let w=c[M];return p&&g&&g.target===M&&g.previewColorIndex!==void 0&&(w=g.previewColorIndex),w},_=M=>{let w=C(M);const O=w===-1?null:a[w],T={};if(M===Ge)T.vertexState=h?"filled":"disabled",w===-1?T.vertexColor=Ks:O&&O.type==="color"?T.vertexColor=O.value:O&&O.type==="colormap"&&(T.vertexColormapItem=O);else if(M===Ue)T.edgeState=f?"solid":"disabled",w===-1?T.edgeColor=Ks:O&&O.type==="color"?T.edgeColor=O.value:O&&O.type==="colormap"&&(T.edgeColormapItem=O);else if(M===ot)T.faceState=u?"filled":"disabled",w===-1?T.faceColor=Ks:O&&O.type==="color"?T.faceColor=O.value:O&&O.type==="colormap"&&(T.faceColormapItem=O);else if(M===Ft){w===-1?T.textColor=Ks:O&&O.type==="color"?T.textColor=O.value:O&&O.type==="colormap"&&(T.textColor=De(O,.5));const A=C(ot);if(A===w){const L=A===-1?null:a[A];L?L.type==="color"?T.faceColorForContrast=L.value:L.type==="colormap"&&(T.faceColorForContrast=De(L,.5)):T.faceColorForContrast=Ks}}return T};[ot,Ue,Ge,Ft].forEach(M=>{const w=i.colorTargetIcons.find(O=>O.target===M);if(w){const O=l.includes(M),T=_(M);if(p&&g&&g.target===ot&&M===ot){const A=i.colorSwatches.find(L=>y.x>=L.x&&y.x<=L.x+L.width&&y.y>=L.y&&y.y<=L.y+L.height);if(A&&A.item.type==="colormap"){const L=Mh((y.x-A.x)/A.width,0,1);T.faceColor=De(A.item,L),T.faceState="filled"}}M===Ft?If(e,w,T,o,O):No(e,w,T,o,O)}})}const E=new Set;if(d!=null){const C=i.colorSwatches.find(_=>_.index===d);if(C){const P=i.colorTargetIcons.find(w=>w.x+w.width/2>=C.x&&w.x+w.width/2<=C.x+C.width),M=P?Math.min(P.y,C.y):C.y;e.strokeStyle=o.selectionGlow,e.lineWidth=Rn,e.strokeRect(C.x-2,M-2,C.width+4,C.y+C.height-M+4),E.add(d)}}l.forEach(C=>{let _=c[C];if(p&&g&&g.target===C&&g.previewColorIndex!==void 0&&(_=g.previewColorIndex),_===-1||E.has(_))return;const P=i.colorSwatches.find(M=>M.index===_);if(P){const M=Object.keys(c).filter(O=>{let T=c[O];return p&&g&&g.target===O&&g.previewColorIndex!==void 0&&(T=g.previewColorIndex),T===P.index&&l.includes(O)}),w=i.colorTargetIcons.filter(O=>M.includes(O.target));if(w.length>0){const O=Math.min(...w.map(R=>R.y));e.strokeStyle=o.selectionGlow,e.lineWidth=Rn;const T=2,A=P.x-T,L=O-T,B=P.width+T*2,F=P.y+P.height-L+T;e.strokeRect(A,L,B,F),E.add(_)}}})}function yf(e,t,n,s){const{canvasUI:i,colors:o,allColors:a,activeThemeName:r,edgeColorMode:c,faceColorMode:l,selectedEdgeModes:d,selectedFaceModes:h}=n,f=i.colorModeIcons||[];if(!f.length)return;const u=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"],p=d&&d.length>0?d:[c],g=h&&h.length>0?h:[l],y=()=>a&&a.find(m=>m&&m.type==="colormap")||null;f.forEach(m=>{e.save(),e.strokeStyle=o.uiIcon,e.fillStyle=o.uiIcon,e.lineWidth=_n;const x={vertexState:"none",edgeState:"none",faceState:"none",faceColor:o.uiIcon,edgeColor:o.uiIcon,vertexColor:o.uiIcon};if(m.group==="edge"){const S={...x,edgeState:"solid"};m.mode==="inherit_vertices"&&(S.vertexState="filled",S.vertexColors=u,S.edgeVertexColors=u),m.mode==="colormap"&&(S.edgeColormapItem=y());const I=p.includes(m.mode);No(e,m,S,o,I)}else if(m.group==="face"){const S={...x,faceState:"filled"};m.mode==="inherit_vertices"&&(S.vertexState="solid",S.faceVertexColors=u,S.vertexColors=u),m.mode==="inherit_edges"&&(S.edgeState="solid",S.edgeColors=u,S.faceEdgeColors=u),(m.mode==="colormap_xy"||m.mode==="colormap_polar")&&(S.faceColormapItem=y());const I=g.includes(m.mode);No(e,m,S,o,I)}e.restore()})}function mf(e,t,n,s){const i=(n?.vertices||[]).filter(E=>E&&E.type==="regular");if(!i.length){e.save(),e.fillStyle=s.uiIconDefault,e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width*.08,0,2*Math.PI),e.fill(),e.restore();return}let o=1/0,a=1/0,r=-1/0,c=-1/0;i.forEach(E=>{E.x<o&&(o=E.x),E.y<a&&(a=E.y),E.x>r&&(r=E.x),E.y>c&&(c=E.y)});const l=3,d=Math.max(t.width-l*2,1),h=Math.max(t.height-l*2,1),f=Math.max(r-o,1e-6),u=Math.max(c-a,1e-6),p=Math.min(d/f,h/u),g=(o+r)/2,y=(a+c)/2,m=t.x+t.width/2,x=t.y+t.height/2,S=E=>({x:m+(E.x-g)*p,y:x+(E.y-y)*p}),I=n?.edges||[],b=n?.faces||[],v=new Map(i.map(E=>[E.id,E]));e.save(),e.lineWidth=1,b.length>0&&(e.fillStyle=s.uiIconDefault,e.globalAlpha=.2,b.forEach(E=>{const C=(E.vertexIds||[]).map(P=>v.get(P)).filter(Boolean);if(C.length<3)return;e.beginPath();const _=S(C[0]);e.moveTo(_.x,_.y);for(let P=1;P<C.length;P++){const M=S(C[P]);e.lineTo(M.x,M.y)}e.closePath(),e.fill()}),e.globalAlpha=1),e.strokeStyle=s.uiIconDefault,I.forEach(E=>{const C=v.get(E.id1),_=v.get(E.id2);if(!C||!_)return;const P=S(C),M=S(_);e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(M.x,M.y),e.stroke()}),e.fillStyle=s.uiIconDefault,i.forEach(E=>{const C=S(E);e.beginPath(),e.arc(C.x,C.y,1.2,0,2*Math.PI),e.fill()}),e.restore()}function xf(e,t){const{canvasUI:n,colors:s,sessions:i,activeSessionIndex:o,selectedSessionIndex:a}=t,r=n.removeSessionButton;r&&(e.strokeStyle=s.uiDefault,e.lineWidth=Rn,e.strokeRect(r.x,r.y,r.width,r.height),e.beginPath(),e.moveTo(r.x+tn,r.y+r.height/2),e.lineTo(r.x+r.width-tn,r.y+r.height/2),e.stroke()),(n.sessionIcons||[]).forEach(l=>{const d=l.index===a,h=l.index===o;e.save(),e.strokeStyle=d?s.selectionGlow:s.uiDefault,e.lineWidth=To,e.strokeRect(l.x,l.y,l.width,l.height),h&&!d&&(e.strokeStyle=s.selectionGlow,e.lineWidth=To,e.strokeRect(l.x+2,l.y+2,l.width-4,l.height-4)),mf(e,l,l.session?.state,s),e.restore()});const c=n.addSessionButton;c&&(e.strokeStyle=s.uiDefault,e.lineWidth=Rn,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width/2,c.y+tn),e.lineTo(c.x+c.width/2,c.y+c.height-tn),e.moveTo(c.x+tn,c.y+c.height/2),e.lineTo(c.x+c.width-tn,c.y+c.height/2),e.stroke())}function Sf(e,t,{verticesVisible:n,edgesVisible:s,facesVisible:i,colorAssignments:o,allColors:a},r){const c=!n&&!s&&!i,l={vertexState:n||c?"filled":"hidden",edgeState:s||c?"solid":"hidden",faceState:i||c?"filled":"hidden",showAllDisabled:c},d=o[Ge];if(d!==-1){const u=a[d];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=r.vertex;const h=o[Ue];if(h!==-1){const u=a[h];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=r.edge;const f=o[ot];if(f!==-1){const u=a[f];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=r.face;No(e,t,l,r)}function li(e){const t={x:e.x+e.width/2,y:e.y+e.height/2},s=26*(e.width/mo),i=s*Math.sqrt(3)/2,o=[{x:t.x,y:t.y-i/1.5},{x:t.x-s/2,y:t.y+i/3},{x:t.x+s/2,y:t.y+i/3}],a=new Path2D;a.moveTo(o[0].x,o[0].y),a.lineTo(o[1].x,o[1].y),a.lineTo(o[2].x,o[2].y),a.closePath();const r=Math.min(o[0].x,o[1].x,o[2].x),c=Math.max(o[0].x,o[1].x,o[2].x),l=Math.min(o[0].y,o[1].y,o[2].y),d=Math.max(o[0].y,o[1].y,o[2].y);return{vertices:o,facePath:a,bounds:{x:r,y:l,w:c-r,h:d-l}}}function No(e,t,n,s,i=!1){const{vertexState:o="none",edgeState:a="none",faceState:r="none",faceColor:c,edgeColor:l,vertexColor:d,vertexColors:h,edgeVertexColors:f,edgeColors:u,faceColormapItem:p,faceVertexColors:g,faceEdgeColors:y,showAllDisabled:m=!1}=n;e.save();const{vertices:x,facePath:S}=li(t),I=E=>E?Array.isArray(E)?{r:E[0],g:E[1],b:E[2],a:1}:Ps(E):{r:0,g:0,b:0,a:1},b=(E,C,_,P)=>{const M=Math.max(1,Math.ceil(C.w)),w=Math.max(1,Math.ceil(C.h)),O=document.createElement("canvas");O.width=M,O.height=w;const T=O.getContext("2d"),A=T.createImageData(M,w),L=A.data,B=E[0],F=E[1],R=E[2],N=(F.y-R.y)*(B.x-R.x)+(R.x-F.x)*(B.y-R.y),$=P.map(I),D=[[B,F],[F,R],[R,B]];for(let k=0;k<w;k++)for(let V=0;V<M;V++){const G=C.x+V+.5,X=C.y+k+.5,H=((F.y-R.y)*(G-R.x)+(R.x-F.x)*(X-R.y))/N,Y=((R.y-B.y)*(G-R.x)+(B.x-R.x)*(X-R.y))/N,W=1-H-Y,J=(k*M+V)*4;if(H>=-.001&&Y>=-.001&&W>=-.001){let ee=0,oe=0,ye=0,qe=1;if(_==="vertices")ee=H*$[0].r+Y*$[1].r+W*$[2].r,oe=H*$[0].g+Y*$[1].g+W*$[2].g,ye=H*$[0].b+Y*$[1].b+W*$[2].b;else{const ke=D.map((at,tt)=>{const be=Tt({x:G,y:X},at[0],at[1]);return{weight:1/Math.max(be.distance,1e-4),edgeIndex:tt}}),et=ke.reduce((at,tt)=>at+tt.weight,0)||1;ke.forEach(at=>{const tt=$[at.edgeIndex],be=at.weight/et;ee+=be*tt.r,oe+=be*tt.g,ye+=be*tt.b})}L[J]=Math.round(ee),L[J+1]=Math.round(oe),L[J+2]=Math.round(ye),L[J+3]=Math.round(qe*255)}else L[J+3]=0}T.putImageData(A,0,0),e.drawImage(O,C.x,C.y)};if(r==="filled"){if(p&&p.type==="colormap"){const E=e.createLinearGradient(x[1].x,0,x[2].x,0);p.vertices.forEach(C=>{const _=C.color,P=C.alpha!==void 0?C.alpha:1,M=`rgba(${_.join(",")},${P})`;E.addColorStop(C.pos,M)}),e.fillStyle=E}else if(g&&g.length>=3){const{bounds:E}=li(t);b(x,E,"vertices",g)}else if(y&&y.length>=3){const{bounds:E}=li(t);b(x,E,"edges",y)}else e.fillStyle=c||s.face;!g&&!y&&e.fill(S)}else r==="disabled"&&(e.fillStyle=Pd,e.fill(S));if(a==="solid"||a==="disabled"){e.lineWidth=_n,e.setLineDash([]);const E=[[0,1],[1,2],[2,0]];E.forEach((C,_)=>{const[P,M]=C,w=x[P],O=x[M];if(u&&u.length>=3)e.strokeStyle=u[_];else if(n.edgeColormapItem&&n.edgeColormapItem.type==="colormap"&&a==="solid"){const T=e.createLinearGradient(w.x,w.y,O.x,O.y),A=E.length>1?_/(E.length-1):.5,L=Math.max(0,Math.min(1,A)),B=Math.max(0,Math.min(1,A+.3)),F=De(n.edgeColormapItem,L),R=De(n.edgeColormapItem,B);T.addColorStop(0,F),T.addColorStop(1,R),e.strokeStyle=T}else if(f&&f.length>=3){const T=e.createLinearGradient(w.x,w.y,O.x,O.y);T.addColorStop(0,f[P]),T.addColorStop(1,f[M]),e.strokeStyle=T}else a==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||s.edge;e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(O.x,O.y),e.stroke()})}(o==="filled"||o==="disabled")&&(e.lineWidth=_n,x.forEach((E,C)=>{let _=h&&h[C]||d||s.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&o==="filled"){const M=x.length>1?C/(x.length-1):.5;_=De(n.vertexColormapItem,M)}o==="disabled"&&(_="#808080");const P=new Path2D;P.moveTo(E.x+Xn*2,E.y),P.arc(E.x,E.y,Xn*2,0,2*Math.PI),e.fillStyle=_,e.setLineDash([]),e.fill(P)})),m?(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(o==="disabled"||a==="disabled"||r==="disabled")&&(e.strokeStyle=s.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),i&&(e.strokeStyle=s.selectionGlow,e.lineWidth=Rn,e.setLineDash([]),e.strokeRect(t.x-2,t.y-2,t.width+4,t.height+4)),e.restore()}function If(e,t,n,s,i=!1){e.save();const o={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(o.x,o.y);const a=t.width/mo;e.scale(a,a),e.translate(-16,-16);let r=n.textColor||s.uiTextDefault;if(n.faceColorForContrast){const c=Ps(n.faceColorForContrast);r=(.2126*c.r+.7152*c.g+.0722*c.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=r,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function wi(e,t,n,s,i,o,a,r,c,l,d,h={}){if(!t||t.length<3)return;e.save(),e.beginPath(),t.forEach((E,C)=>{C===0?e.moveTo(E.x,E.y):e.lineTo(E.x,E.y)}),e.closePath(),l&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(E=>{const C=r.find(_=>_.id===E);if(C){const _=C.vertexIds.map(P=>c(P)).filter(P=>P&&P.type==="regular");if(_.length>=3){const M=(d?lo(_,d,!0,i):_).map(w=>i(w));e.moveTo(M[0].x,M[0].y),M.slice(1).forEach(w=>{e.lineTo(w.x,w.y)}),e.closePath()}}});const{faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:p="x",faceColorPolarExpression:g="r",edgeColorExpression:y="x"}=h,m=Oo(n,f),x=n?.vertexIds?n.vertexIds.map(E=>c(E)).filter(Boolean):[],S=E=>E?.color||s.face,I=gt(s.face,{r:255,g:255,b:255,a:1}),b=(E,C)=>{const _=e.createPattern(E,"no-repeat"),P=i(C.origin),M=zn({x:1,y:0},C),w=zn({x:0,y:1},C),O=i(M),T=i(w),A=O.x-P.x,L=O.y-P.y,B=T.x-P.x,F=T.y-P.y,R=E.width,N=R/2,$=A/N,D=L/N,k=B/N,V=F/N,G=P.x-(A+B)*(R/2)/N,X=P.y-(L+F)*(R/2)/N,H=new DOMMatrix([$,D,k,V,G,X]);return _.setTransform(H),_},v=(E,C)=>{const P=document.createElement("canvas");P.width=64,P.height=64;const M=P.getContext("2d"),w=M.createImageData(64,64),O=w.data,T=1/63,A=x.filter(N=>N.type==="regular"),L=A.map(N=>va(N,C)),B=A.map(N=>gt(S(N),I)),F=[];if(n?.vertexIds&&n.vertexIds.length>1)for(let N=0;N<n.vertexIds.length;N++){const $=n.vertexIds[N],D=n.vertexIds[(N+1)%n.vertexIds.length],k=a?.find(X=>X.id1===$&&X.id2===D||X.id1===D&&X.id2===$)||{id1:$,id2:D},V=c(k.id1),G=c(k.id2);V&&G&&F.push({edge:k,mode:os(k,u),v1:V,v2:G,v1Local:va(V,C),v2Local:va(G,C)})}const R=(N,$)=>{const{edge:D,v1:k,v2:V,mode:G}=N;if(G==="inherit_vertices"&&k&&V){const X=gt(S(k),I),H=gt(S(V),I);return{r:Dt(X.r,H.r,$),g:Dt(X.g,H.g,$),b:Dt(X.b,H.b,$),a:Dt(X.a,H.a,$)}}if(G==="colormap"&&D.colormapItem){const X=Qs(y,{x:$},$),H=eo(X),Y=De(D.colormapItem,H);return gt(Y,I)}return gt(D.color||s.edge,I)};for(let N=0;N<64;N++)for(let $=0;$<64;$++){const D=$*T*2-1,k=N*T*2-1;let V=I;if(E==="colormap_xy"||E==="colormap_polar")if(n?.colormapItem){let X=.5;if(E==="colormap_xy")X=Qs(p,{x:D,y:k},D);else{const W=Math.hypot(D,k),J=Math.atan2(k,D);X=Qs(g,{r:W,phi:J},W)}const H=eo(X),Y=De(n.colormapItem,H);V=gt(Y,I)}else V=I;else if(E==="inherit_vertices"&&L.length>0){const X=L.map(H=>{const Y=D-H.x,W=k-H.y,J=Math.hypot(Y,W);return 1/Math.max(J,1e-4)});V=yl(B,X)}else if(E==="inherit_edges"&&F.length>0){const X=F.map(Y=>{const W=Tt({x:D,y:k},Y.v1Local,Y.v2Local);return 1/Math.max(W.distance,1e-4)}),H=F.map((Y,W)=>{const J=Tt({x:D,y:k},Y.v1Local,Y.v2Local);return R(Y,J.t)});V=yl(H,X)}const G=(N*64+$)*4;O[G]=Math.round(V.r),O[G+1]=Math.round(V.g),O[G+2]=Math.round(V.b),O[G+3]=Math.round(eo(V.a)*255)}return M.putImageData(w,0,0),P};if(m==="fixed")e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");else if(n.localCoordSystem){const E=v(m,n.localCoordSystem),C=b(E,n.localCoordSystem);e.fillStyle=C||n?.color||s.face,e.fill(l?"evenodd":"nonzero")}else n?.colormapItem&&n.localCoordSystem,e.fillStyle=n?.color||s.face,e.fill(l?"evenodd":"nonzero");e.restore()}function bf(e,t,n,s,i,o){const{angleDisplayMode:a,distanceDisplayMode:r,colors:c}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":ql(e,l,a,a!==Ro,s,i,c);break;case"distances":jl(e,l,r,r===Lo,s,i,c);break}}function vf(e,t,n,s){const{canvasUI:i,colorAssignments:o,allColors:a,colors:r}=n,c=l=>{if(!o||!a)return r.uiIcon;const d=o[l];if(d===-1)return Ks;const h=a[d];return h&&h.type==="color"?h.value:r.uiIcon};c(Ge),c(Ue),c(ot),i.visibilityIcons.forEach(l=>{bf(e,l,n,t,s)})}function Ul(e,t,n,s){const i={x:t.x+t.width*.22,y:t.y+t.height*.78},o={x:t.x+t.width*.22,y:t.y+t.height*.22},a={x:t.x+t.width*.78,y:t.y+t.height*.22},r=[i,o,a],l=!s||s.type==="linear"?r:lo(r,s,!1,null),d=(h,f)=>{const u=Math.atan2(f.y-h.y,f.x-h.x),p=t.width*.08,g={x:f.x-Math.cos(u)*p+Math.cos(u+Math.PI/2)*p*.6,y:f.y-Math.sin(u)*p+Math.sin(u+Math.PI/2)*p*.6},y={x:f.x-Math.cos(u)*p+Math.cos(u-Math.PI/2)*p*.6,y:f.y-Math.sin(u)*p+Math.sin(u-Math.PI/2)*p*.6};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(g.x,g.y),e.lineTo(y.x,y.y),e.closePath(),e.fill()};e.save(),e.strokeStyle=n.uiIcon,e.lineWidth=sr,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let h=1;h<l.length;h++)e.lineTo(l[h].x,l[h].y);e.stroke(),e.fillStyle=n.uiIcon,r.forEach(h=>{e.beginPath(),e.arc(h.x,h.y,Xn+.5,0,Math.PI*2),e.fill()}),s?.linearStyle==="arrows"&&(d(i,o),d(o,a)),e.restore()}function Mf(e,t,n,s){const{canvasUI:i,colors:o,activeInterpolationStyleId:a,selectedInterpolationStyleId:r,interpolationStyles:c}=n;i.interpolationIcons.forEach(l=>{const d={x:l.x,y:l.y,width:l.width,height:l.height};if(l.type==="interpolationStyle"){const h=l.styleId===(r||a);e.strokeStyle=o.uiDefault,e.lineWidth=To,e.strokeRect(d.x,d.y,d.width,d.height),h&&(e.strokeStyle=o.selectionGlow,e.lineWidth=Rn,e.strokeRect(d.x-2,d.y-2,d.width+4,d.height+4));const f=c.find(p=>p.id===l.styleId);Ul(e,d,o,f);const u=f?.name||"";u&&u.toLowerCase()!=="linear"&&s({id:`interpolation-label-${l.styleId}`,content:u.length>6?`${u.slice(0,6)}...`:u,x:d.x+d.width/2,y:d.y+d.height+10,color:o.uiTextDefault,fontSize:or,options:{textAlign:"center",textBaseline:"top"}},t)}else l.type==="interpolationRemove"?(e.strokeStyle=o.uiDefault,e.lineWidth=To,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.strokeStyle=o.uiIcon,e.lineWidth=sr,e.stroke()):l.type==="interpolationAdd"&&(e.strokeStyle=o.uiDefault,e.lineWidth=To,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width/2,d.y+d.height*.25),e.lineTo(d.x+d.width/2,d.y+d.height*.75),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.stroke())})}function Ef(e,t,n,s){const{canvasUI:i,colors:o,activeThemeName:a,colorAssignments:r,allColors:c,verticesVisible:l,edgesVisible:d,facesVisible:h}=n,f=i.toolbarButton;e.strokeStyle=o.uiDefault,e.lineWidth=kl,e.beginPath();for(let b=0;b<3;b++){const v=f.y+5+b*10;e.moveTo(f.x+4,v),e.lineTo(f.x+f.width-4,v)}e.stroke();const u=i.colorToolButton;u&&Sf(e,u,{verticesVisible:l,edgesVisible:d,facesVisible:h,colorAssignments:r,allColors:c},o);const p=i.colorModeToolButton;if(p){const b=p,v={x:b.x,y:b.y,width:b.width,height:b.height};(C=>{const{vertices:_}=li(C),P=[[_[0],_[1]],[_[1],_[2]],[_[2],_[0]]],M=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"];P.forEach((w,O)=>{e.strokeStyle=M[O],e.lineWidth=2,e.beginPath(),e.moveTo(w[0].x,w[0].y),e.lineTo(w[1].x,w[1].y),e.stroke()})})(v),e.fillStyle="#ffffff",No(e,v,{edgeState:"none",faceState:"filled",vertexState:"none",faceColor:"#ffffff"},o)}const g=i.transformToolButton;g&&s({id:"transform-tool-label",content:Bd,x:g.x+g.width/2,y:g.y+g.height/2,color:o.uiIcon,fontSize:Fd,options:{textAlign:"center",textBaseline:"middle"}},t);const y=i.interpolationToolButton;y&&Ul(e,y,o);const m=i.displayToolButton;if(m){e.strokeStyle=o.uiDefault,e.fillStyle=o.uiDefault,e.lineWidth=sr;const b=m.width-$d;for(let v=0;v<3;v++){const E=m.y+Vd+v*Xd;e.beginPath(),e.moveTo(m.x+6,E),e.lineTo(m.x+6+b,E),e.stroke(),e.beginPath(),e.arc(m.x+6+b*(v/2),E,Yd,0,2*Math.PI),e.fill()}}const x=i.visibilityToolButton;x&&gf(e,x,o);const S=i.sessionsToolButton;if(S){e.save(),e.strokeStyle=o.uiDefault,e.lineWidth=_n;const b=6,v=Math.min(S.width,S.height)-b*2,E=S.x+b,C=S.y+b;e.strokeRect(E+4,C+2,v,v),e.strokeRect(E,C+6,v,v),e.restore()}const I=i.themeToggleButton;I&&Kl(e,I,a,o)}function Cf(e,t){const{canvasUI:n,colors:s}=t;n.transformIcons.forEach(i=>{ta(e,i,s)})}function Tf(e,t,n,s){const{canvasUI:i,colors:o,coordsDisplayMode:a,gridDisplayMode:r,angleDisplayMode:c,distanceDisplayMode:l,activeThemeName:d}=n;i.displayIcons.forEach(h=>{const f={x:h.x,y:h.y,width:h.width,height:h.height};switch(h.group){case"coords":ff(e,f,a,a!==Ui,t,s,o);break;case"grid":uf(e,f,r,r!==Xo,o);break;case"angles":ql(e,f,c,c!==Ro,t,s,o);break;case"distances":jl(e,f,l,l===Lo,t,s,o);break;case"theme":Kl(e,f,d,o);break}})}function wf(e,t,n,s){const{dpr:i,isToolbarExpanded:o,isColorPaletteExpanded:a,isColorModePanelExpanded:r,isInterpolationPanelExpanded:c,isTransformPanelExpanded:l,isDisplayPanelExpanded:d,isVisibilityPanelExpanded:h,isSessionsPanelExpanded:f,isPlacingTransform:u,placingTransformType:p,placingSnapPos:g,mousePos:y,colors:m}=n;if(e.save(),e.resetTransform(),e.scale(i,i),o)Ef(e,t,n,s);else{const x=n.canvasUI.toolbarButton;e.strokeStyle=m.uiDefault,e.lineWidth=kl,e.beginPath();for(let S=0;S<3;S++){const I=x.y+5+S*10;e.moveTo(x.x+4,I),e.lineTo(x.x+x.width-4,I)}e.stroke()}if(a&&pf(e,t,n),r&&yf(e,t,n),c&&Mf(e,t,n,s),l&&Cf(e,n),d&&Tf(e,t,n,s),h&&vf(e,t,n,s),f&&xf(e,n),u){const x=g||y;if(x){const S=ya/2,I={type:p,x:x.x-S,y:x.y-S,width:ya,height:ya};ta(e,I,m)}}e.restore()}function ml(e,t,n,s,{showDistances:i,distanceSigFigs:o,colors:a,lastGridState:r,currentShiftPressed:c},l,d,h,f,u=null,p=null,g=null){!i||n.length===0||n.forEach(y=>{const m=s.find(x=>d(x)===y);if(m){let x=l(m.id1),S=l(m.id2);if(u){const I=u.find(v=>v.id===m.id1),b=u.find(v=>v.id===m.id2);I&&(x=I),b&&(S=b)}if(x&&S&&x.type==="regular"&&S.type==="regular"){let I;const b=u&&g;if(m.labelMode==="exact"&&m.exactValue){const[A,L]=Is(m.exactValue.g2gSquaredSum);let B=m.exactValue.gridInterval*A;if(b&&g.transformType!==un){const F=g.snappedScaleValue!==null?g.snappedScaleValue:g.scale;B*=F}I=bs(parseFloat(B.toFixed(10)),L)}else I=ft(Q(x,S),o);const v=h(x),E=h(S),C=(v.x+E.x)/2,_=(v.y+E.y)/2,P=Math.atan2(E.y-v.y,E.x-v.x);let M=P-Math.PI/2;Math.sin(M)>0&&(M+=Math.PI);const w=C+Math.cos(M)*ts,O=_+Math.sin(M)*ts;let T=P*(180/Math.PI);(T>90||T<-90)&&(T+=180),f({id:`selected-edge-dist-${y}`,content:I,x:w,y:O,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:xn,options:{rotation:T}})}}})}function Pf(e,t,n,s){e.save(),e.strokeStyle=s.mouseCoords,e.lineWidth=dn,e.setLineDash(Vn);const i=Math.min(t.x,n.x),o=Math.min(t.y,n.y),a=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);e.strokeRect(i,o,a,r),e.restore()}function Po(e,t,n,s,{lastGridState:i,showDistances:o,showAngles:a,distanceSigFigs:r,angleDisplayMode:c,angleSigFigs:l,currentShiftPressed:d,viewTransform:h,colors:f},u,p,g,y=!1,m=null,x=null,S=[],I=!1,b=[],v=null,E=new Map){const C=y?f.feedbackSnapped:`rgba(${f.feedbackDefault.join(",")}, 1.0)`,_=new Map(s.map(N=>[N.id,{...N}])),P=N=>_.get(N),M=P(n);if(!M)return;const w=p(M.id).map(P).filter(Boolean),O=u(M),T=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,L=(E.get(n)||[]).find(N=>N.type==="projection"&&N.projectionLine);if(L){const[N,$]=L.projectionLine,D=u(N),k=u($),V={x:k.x-D.x,y:k.y-D.y},G=Math.hypot(V.x,V.y);if(G>0){const X={x:V.x/G,y:V.y/G},H=1e4,Y={x:D.x-X.x*H,y:D.y-X.y*H},W={x:D.x+X.x*H,y:D.y+X.y*H};e.save(),e.strokeStyle=C,e.lineWidth=dn,e.setLineDash(Al),e.beginPath(),e.moveTo(Y.x,Y.y),e.lineTo(W.x,W.y),e.stroke(),e.restore()}}const B=(N,$)=>{if(!N||!$||$<=0)return!1;const D=$*1e-6,k=Math.abs(N.x/$-Math.round(N.x/$))<D,V=Math.abs(N.y/$-Math.round(N.y/$))<D;return k&&V},F=w.every(N=>S.includes(N.id)),R=b.find(N=>N.id===n);if(!v&&I&&d&&F&&R&&Q(R,M)>le){const N=u(R),$=O,D=Math.atan2($.y-N.y,$.x-N.x),k=Math.atan2(M.y-R.y,M.x-R.x);if(o){let V;const G=T&&B(R,T),X=T&&B(M,T);if(G&&X){const ye=M.x-R.x,qe=M.y-R.y,ke=Math.round(ye/T),et=Math.round(qe/T),at=ke*ke+et*et;if(at===0)V="0";else{const[tt,be]=Is(at),nt=T*tt,kt=parseFloat(nt.toFixed(10));V=bs(kt,be)}}else{const ye=r+2;V=ft(Q(R,M),ye)}const H=(N.x+$.x)/2,Y=(N.y+$.y)/2;let W;a&&Math.abs(k)>le?-k<0?W=D-Math.PI/2:W=D+Math.PI/2:(W=D-Math.PI/2,Math.sin(W)>0&&(W+=Math.PI));const J=H+Math.cos(W)*ts,ee=Y+Math.sin(W)*ts;let oe=D*(180/Math.PI);(oe>90||oe<-90)&&(oe+=180),x({id:`drag-dist-vector-${M.id}`,content:V,x:J,y:ee,color:C,fontSize:xn,options:{rotation:oe}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=C,e.lineWidth=dn,e.beginPath(),e.moveTo(N.x,N.y),e.lineTo($.x,$.y),e.stroke(),e.restore(),a&&Math.abs(D)>le){mr(e,N,0,k,ro,C);let V;if(c===Ts?V=`${ft(k*(180/Math.PI),l)}^{\\circ}`:V=ft(k,l),V){const G=-k/2,X=vi,H={x:X*Math.cos(G),y:X*Math.sin(G)},Y={x:N.x+H.x,y:N.y+H.y};let W=G*(180/Math.PI);(W>90||W<-90)&&(W+=180),x({id:`drag-angle-vector-${M.id}`,content:V,x:Y.x,y:Y.y,color:C,fontSize:xn,options:{rotation:W}},t)}}}if(o&&w.forEach(N=>{const $=S.includes(N.id);if(!I||!$){const D=M,k=N,V=g({id1:D.id,id2:k.id});let G;if(T&&B(D,T)&&B(k,T)){const et=D.x-k.x,at=D.y-k.y,tt=Math.round(et/T),be=Math.round(at/T),nt=tt*tt+be*be;if(nt===0)G="0";else{const[kt,Ys]=Is(nt),Cn=T*kt,gn=parseFloat(Cn.toFixed(10));G=bs(gn,Ys)}}else{const et=Q(D,k);G=ft(et,r)}const H=u(D),Y=u(k),W=(H.x+Y.x)/2,J=(H.y+Y.y)/2,ee=Math.atan2(Y.y-H.y,Y.x-H.x);let oe=ee-Math.PI/2;Math.sin(oe)>0&&(oe+=Math.PI);const ye=W+Math.cos(oe)*ts,qe=J+Math.sin(oe)*ts;let ke=ee*(180/Math.PI);(ke>90||ke<-90)&&(ke+=180),x({id:`drag-dist-${V}`,content:G,x:ye,y:qe,color:C,fontSize:xn,options:{rotation:ke}})}}),a&&w.length>=2&&(!I||w.some(N=>!S.includes(N.id)))){const N=[...w].sort(($,D)=>{const k=Math.atan2($.y-M.y,$.x-M.x),V=Math.atan2(D.y-M.y,D.x-M.x);return k-V});for(let $=0;$<N.length;$++){const D=N[$],k=N[($+1)%N.length],V=S.includes(D.id),G=S.includes(k.id);if(!(!I||!V||!G))continue;const H={x:D.x-M.x,y:D.y-M.y},Y={x:k.x-M.x,y:k.y-M.y},W=Math.atan2(H.y,H.x),J=Math.atan2(Y.y,Y.x);let ee=J-W;if(ee<0&&(ee+=2*Math.PI),ee<le)continue;const oe=W+ee/2;e.save(),e.strokeStyle=C,e.lineWidth=dn,e.beginPath(),e.arc(O.x,O.y,ro,-W,-J,!1),e.stroke(),e.restore();let ye;if(c===Ts?ye=`${ft(ee*(180/Math.PI),l)}^{\\circ}`:c===Yo&&(d?(ye=ln(ee/Math.PI,.015,32)+"\\pi",ye.startsWith("1\\pi")&&(ye="\\pi"),ye.startsWith("-1\\pi")&&(ye="-\\pi"),ye==="0\\pi"&&(ye="0")):ye=ft(ee,l)),ye){const qe=`drag-angle-${M.id}-${D.id}-${k.id}`,ke={x:M.x+Math.cos(oe),y:M.y+Math.sin(oe)},et=u(ke),at=Math.atan2(et.y-O.y,et.x-O.x),tt=vi,be={x:tt*Math.cos(at),y:tt*Math.sin(at)},nt={x:O.x+be.x,y:O.y+be.y};let kt=at*(180/Math.PI);(kt>90||kt<-90)&&(kt+=180),x({id:qe,content:ye,x:nt.x,y:nt.y,color:C,fontSize:xn,options:{rotation:kt}},t)}}}}function Af(e,t,n,s,{showAngles:i,angleSigFigs:o,angleDisplayMode:a,currentShiftPressed:r,distanceSigFigs:c,viewTransform:l,lastGridState:d,colors:h},f,u,p,g,y){!i||n.length===0||n.forEach(m=>{const x=s.find(S=>u(S)===m);if(x){const S=f(x.id1),I=f(x.id2);if(S&&I&&S.type==="regular"&&I.type==="regular"){const b={lastGridState:d,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:o,currentShiftPressed:r,viewTransform:l,colors:h};Po(e,t,S.id,[S,I],b,p,g,u,!1,null,y),Po(e,t,I.id,[S,I],b,p,g,u,!1,null,y)}}})}function Jl(e,{allFaces:t,selectedFaceIds:n,colors:s,isDragConfirmed:i,dragPreviewVertices:o,initialDragVertexStates:a,transformIndicatorData:r,highlightedEdgeForSnap:c,draggedFaceId:l,coordSystemSnapAngle:d,coordSystemSnapType:h,coordSystemSnapScale:f,initialCoordSystemStates:u},p,g){if(n.length>jd)return;const y=new Set(n);y.size!==0&&y.forEach(m=>{const x=t.find(I=>I.id===m);if(!x||!x.localCoordSystem)return;let S=x.localCoordSystem;if(i&&x.vertexIds.some(I=>o.some(b=>b.id===I))){const I=u.get(x.id);S=$h(x,{initialSystem:I,dragPreviewVertices:o,initialDragVertexStates:a,findVertexById:g,transformIndicatorData:r})}if(l===m&&d!==null){const I=v=>{if(i&&o){const E=o.find(C=>C&&C.id===v);if(E)return E}return g(v)},b=p(S.origin);if(h==="edge"&&c!==null){const v=x.vertexIds.map(E=>I(E)).filter(E=>E&&E.type==="regular");if(c<v.length){const E=v[c],C=v[(c+1)%v.length],_=p(E),P=p(C);e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(P.x,P.y),e.stroke(),e.restore()}}else if(h==="cardinal"){const E=b.x+Math.cos(-d)*100,C=b.y+Math.sin(-d)*100,_=b.x-Math.cos(-d)*100,P=b.y-Math.sin(-d)*100;e.save(),e.strokeStyle=s.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(_,P),e.lineTo(E,C),e.stroke(),e.restore()}}_f(e,S,s,p,f)})}function _f(e,t,n,s,i=null){const o=s(t.origin),a=zn({x:1,y:0},t),r=zn({x:0,y:1},t),c=s(a),l=s(r);e.save(),e.lineWidth=ls,e.lineCap="round";const d=(u,p,g,y)=>{e.strokeStyle=g,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(p.x,p.y),e.stroke(),e.fillStyle=y;const m=Math.atan2(p.y-u.y,p.x-u.x);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(p.x-Re*Math.cos(m-rn),p.y-Re*Math.sin(m-rn)),e.lineTo(p.x-Re*Math.cos(m+rn),p.y-Re*Math.sin(m+rn)),e.closePath(),e.fill()},h=i!==null?n.feedbackSnapped:n.coordSysX,f=i!==null?n.feedbackSnapped:n.coordSysY;d(o,c,h,h),d(o,l,f,f),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(o.x,o.y,Ad,0,2*Math.PI),e.fill(),e.restore()}const Df=6,kf=500,Rf=300,xl=8;function Ma(e,t){return{x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}}function Sl(e,t){const n=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.hypot(n,s)}function Tn(e,t,n,s,i){const{shiftKey:o,ctrlKey:a,altKey:r,metaKey:c}=i||{};return{button:n,clientX:t.clientX,clientY:t.clientY,shiftKey:!!o,ctrlKey:!!a,metaKey:!!c,altKey:!!r,target:e,preventDefault:()=>s.preventDefault(),stopPropagation:()=>s.stopPropagation()}}function Lf({canvas:e,onMouseDown:t,onMouseMove:n,onMouseUp:s,onPinchZoom:i,onPan:o,getModifiers:a,isHoverMode:r,getHoverTarget:c,getUiTargetAt:l}){let d=null,h=null,f=null,u=!1,p=!1,g=0,y=null,m=null,x=!1,S=!1,I=null,b=0;const v=()=>typeof a=="function"?a():{},E=()=>typeof r=="function"?r():!1,C=()=>typeof c=="function"?c():null,_=A=>typeof l=="function"?l(A):null,P=()=>{f&&(clearTimeout(f),f=null),u=!1},M=(A,L)=>{P(),f=setTimeout(()=>{u=!0;const B=Tn(e,A,2,L,v());t(B)},kf)},w=A=>{if(!(!A.touches||A.touches.length===0)){if(A.preventDefault(),A.touches.length===1){const L=A.touches[0];if(d=L.identifier,h={x:L.clientX,y:L.clientY},m={x:L.clientX,y:L.clientY},p=!1,g=0,y=null,x=!1,S=!1,I=null,E()){const B=Tn(e,L,0,A,v());n(B);const F=_({x:L.clientX,y:L.clientY}),R=C();if(F||R&&R.type&&R.type!=="canvas"){const N=Tn(e,L,0,A,v());t(N)}else x=!0}else{M(L,A);const B=Tn(e,L,0,A,v());t(B)}return}if(A.touches.length===2){if(P(),S=E()&&x&&!!m,b=Date.now(),I=Ma(A.touches[0],A.touches[1]),d!==null&&h){const F=A.touches[0],R=Tn(e,F,0,A,v());s(R)}p=!0,d=null;const[L,B]=A.touches;g=Sl(L,B),y=Ma(L,B)}}},O=A=>{if(!(!A.touches||A.touches.length===0)){if(A.preventDefault(),p&&A.touches.length>=2){const[L,B]=A.touches,F=Sl(L,B),R=Ma(L,B);if(S&&I){const N=Math.hypot(R.x-I.x,R.y-I.y),$=Math.abs(F-g);(N>xl||$>xl)&&(S=!1)}if(!S){if(g>0){const N=F/g;Number.isFinite(N)&&N!==1&&i(N,R)}if(y){const N=R.x-y.x,$=R.y-y.y;(N!==0||$!==0)&&o({x:N,y:$})}}g=F,y=R;return}if(A.touches.length===1&&d!==null){const L=A.touches[0],B=L.clientX-(h?.x??L.clientX),F=L.clientY-(h?.y??L.clientY);Math.hypot(B,F)>Df&&P(),h={x:L.clientX,y:L.clientY},m={x:L.clientX,y:L.clientY};const R=Tn(e,L,0,A,v());n(R)}}},T=A=>{if(A.preventDefault(),p&&A.touches.length<2&&(p=!1,g=0,y=null),S&&m){if(Date.now()-b<=Rf){const B={clientX:m.x,clientY:m.y},F=Tn(e,B,0,A,v()),R=Tn(e,B,0,A,v());t(F),s(R)}}else if(d!==null&&!E()){const L=Array.from(A.changedTouches).find(B=>B.identifier===d)||A.changedTouches[0];if(L)if(u){const B=Tn(e,L,2,A,v());s(B)}else{const B=Tn(e,L,0,A,v());s(B)}}P(),S=!1,I=null,d=A.touches.length===1?A.touches[0].identifier:null,A.touches.length===0&&(h=null,m=null)};return e.style.touchAction="none",e.addEventListener("touchstart",w,{passive:!1}),e.addEventListener("touchmove",O,{passive:!1}),e.addEventListener("touchend",T,{passive:!1}),e.addEventListener("touchcancel",T,{passive:!1}),()=>{P(),e.removeEventListener("touchstart",w),e.removeEventListener("touchmove",O),e.removeEventListener("touchend",T),e.removeEventListener("touchcancel",T)}}class Of{constructor(){this.appMode="static",this.mode="idle",this.dragAction=null,this.selection={transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set},this.hoverTarget={type:"canvas",id:null},this.modifiers={shift:!1,ctrl:!1,alt:!1},this.marqueeRect={active:!1,startX:0,startY:0,endX:0,endY:0},this.lastClickTime=0,this.lastClickTarget={type:null,id:null},this.clickCount=0,this.selectionBeforeClick=null,this.zoomLevel=1,this.activeTransformationObjectId=null,this.lastMouseX=0,this.lastMouseY=0,this.textInput={active:!1,x:0,y:0,value:""},this.touchTimerId=null,this.initialTouchData=null}clearGeometricSelection(){this.selection.vertices.clear(),this.selection.edges.clear(),this.selection.faces.clear(),this.selection.text.clear()}clearTransformationObjectSelection(){this.selection.transformationObjects.clear(),this.activeTransformationObjectId=null}clearSelection(){this.clearGeometricSelection(),this.clearTransformationObjectSelection(),this.selection.ui.clear()}}const Nf=300,Ff=500,Il=1.1,bl=.2,vl=5,ve={IDLE:"idle",DRAWING:"drawing",DRAGGING:"dragging",SELECTING:"selecting",TYPING:"typing"},ie={VERTEX:"vertex",EDGE:"edge",FACE:"face",TEXT:"text",TRANSFORMATION_OBJECT:"transformationObject",MANIFOLD:"manifold",UI:"ui",CANVAS:"canvas"},kn={[ie.VERTEX]:"vertices",[ie.EDGE]:"edges",[ie.FACE]:"faces",[ie.TEXT]:"text",[ie.TRANSFORMATION_OBJECT]:"transformationObjects",[ie.MANIFOLD]:"manifolds",[ie.UI]:"ui"},Nn={PANNING:"panning",MARQUEE_SELECT:"marqueeSelect",RIGID_DRAG:"rigidDrag"};function Jn(e,t,n){if(t===ie.UI)return;const s=kn[t];if(!s){console.warn(`No selection key for type: ${t}`);return}const i=e.selection[s];if(!i){console.warn(`No selection set for type: ${t} (key: ${s})`);return}const o=e.modifiers.ctrl&&!e.modifiers.shift;n.forEach(a=>{o&&i.has(a)?i.delete(a):i.add(a)})}function Bf(e,t,n){const{originalSelection:s}=e.dragAction;if(!s)return;const i=n&&n.ctrlKey,o=n&&n.shiftKey,{startX:a,startY:r,endX:c,endY:l}=e.marqueeRect,d={minX:Math.min(a,c),maxX:Math.max(a,c),minY:Math.min(r,l),maxY:Math.max(r,l)},h=t.getEntitiesInRect(d),f=new Set(s.vertices),u=new Set(s.edges),p=new Set(s.faces),g=new Set(s.text),y=new Set(s.transformationObjects),m={[kn[ie.VERTEX]]:f,[kn[ie.EDGE]]:u,[kn[ie.FACE]]:p,[kn[ie.TEXT]]:g,[kn[ie.TRANSFORMATION_OBJECT]]:y},x=i&&!o;!i&&!o?e.clearGeometricSelection():(e.selection.vertices=new Set(s.vertices),e.selection.edges=new Set(s.edges),e.selection.faces=new Set(s.faces),e.selection.text=new Set(s.text),e.selection.transformationObjects=new Set(s.transformationObjects)),h.length>0&&h.forEach(I=>{const b=kn[I.type];if(!b||!e.selection[b])return;const v=e.selection[b],C=m[b]?.has(I.id);x&&C?v.delete(I.id):v.add(I.id)})}function $f(e,t,n,s){if(e.mode===ve.TYPING){s.preventDefault(),s.key==="Enter"||s.key==="Escape"?(n.stopTyping(e),e.mode=ve.IDLE):s.key==="Backspace"?n.backspace(e):s.key.length===1&&n.updateText(e,s.key);return}if(s.key==="Shift"&&(e.modifiers.shift=!0),s.key==="Control"&&(e.modifiers.ctrl=!0),s.key==="Alt"&&(e.modifiers.alt=!0),e.modifiers.ctrl&&(s.key==="a"||s.key==="A")){s.preventDefault(),e.clearGeometricSelection(),document.querySelectorAll(".proxy-entity").forEach(i=>{const o=i.dataset.type,a=i.dataset.id,r=kn[o];if(r&&o!==ie.TRANSFORMATION_OBJECT&&o!==ie.UI){const c=e.selection[r];c&&c.add(a)}}),e.clickCount=0,e.selectionBeforeClick=null;return}(s.key==="Escape"||s.key==="Esc")&&(e.mode=ve.IDLE,e.dragAction=null,e.clearSelection(),e.activeTransformationObjectId=null,e.marqueeRect.active=!1,e.clickCount=0,e.selectionBeforeClick=null),s.key.length===1&&!s.ctrlKey&&!s.metaKey&&(e.mode===ve.IDLE||e.mode===ve.DRAWING)&&(s.preventDefault(),e.mode=ve.TYPING,n.startTyping(e),n.updateText(e,s.key))}function Vf(e,t,n,s){s.key==="Shift"&&(e.modifiers.shift=!1),s.key==="Control"&&(e.modifiers.ctrl=!1),s.key==="Alt"&&(e.modifiers.alt=!1)}function Zl(e,t,n,s){let i=e.zoomLevel;s.deltaY<0?i*=Il:s.deltaY>0&&(i/=Il),i<bl&&(i=bl),i>vl&&(i=vl),e.zoomLevel=i}function Ql(e,t,n,s){e.hoverTarget={type:s.type,id:s.id}}function ec(e,t,n,s){e.hoverTarget.id===s.id&&(e.hoverTarget={type:ie.CANVAS,id:null})}function Xf(e,t,n,s){e.appMode=s.mode}function Yf(e,t,n,s){e.mode===ve.TYPING&&(n.stopTyping(e),e.mode=ve.IDLE),s.button===0&&e.hoverTarget.type===ie.CANVAS&&(e.clickCount=0,e.selectionBeforeClick=null,e.dragAction={hasMoved:!1,button:0})}function Pi(e){return e?{transformationObjects:new Set(e.transformationObjects),vertices:new Set(e.vertices),edges:new Set(e.edges),faces:new Set(e.faces),text:new Set(e.text),ui:new Set(e.ui)}:{transformationObjects:new Set,vertices:new Set,edges:new Set,faces:new Set,text:new Set,ui:new Set}}function tc(e,t,n,s){if(e.mode===ve.TYPING&&(n.stopTyping(e),e.mode=ve.IDLE),s.button===0){if(e.modifiers.alt){e.mode=ve.DRAWING,e.clickCount=0,e.selectionBeforeClick=null;return}const i=Date.now(),{type:o,id:a}=s,r=kn[o];if(!r){console.warn(`Unknown entity type for selection: ${o}`);return}const c=e.selection[r],l=c&&c.has(a),d=o===ie.VERTEX||o===ie.EDGE||o===ie.FACE||o===ie.TEXT,h=o===ie.TRANSFORMATION_OBJECT;if(e.lastClickTarget.id===a&&i-e.lastClickTime<Nf?e.clickCount++:(e.clickCount=1,e.selectionBeforeClick=Pi(e.selection)),e.lastClickTime=i,e.lastClickTarget={type:o,id:a},o===ie.UI){e.clickCount=0,e.selectionBeforeClick=null;return}if(e.clickCount===1)e.modifiers.ctrl||e.modifiers.shift?Jn(e,o,[a]):l||(d?e.clearGeometricSelection():h&&e.clearTransformationObjectSelection(),Jn(e,o,[a]));else if(e.selection=Pi(e.selectionBeforeClick),d)if(e.clickCount===2){const f=t.getNeighbors(a),u={};f.forEach(p=>{const g=t.getEntityType(p);!g||g===ie.UI||(u[g]||(u[g]=[]),u[g].push(p))});for(const p in u)Jn(e,p,u[p]);Jn(e,o,[a])}else{const f=t.getAllConnected(a),u=[];f.forEach(p=>{t.getEntityType(p)===o&&u.push(p)}),Jn(e,o,u)}else h&&Jn(e,o,[a]);if(h){const f=e.selection.transformationObjects;f.has(a)?e.activeTransformationObjectId=a:e.activeTransformationObjectId===a&&(e.activeTransformationObjectId=f.size>0?Array.from(f)[f.size-1]:null)}e.clickCount>=3&&(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction={hasMoved:!1,button:0,draggedEntityType:o,draggedEntityId:a,wasAlreadySelected:l}}}function nc(e,t,n,s){if(e.lastMouseX=s.clientX,e.lastMouseY=s.clientY,e.mode===ve.TYPING&&(e.textInput.x=s.clientX,e.textInput.y=s.clientY),!!e.dragAction){if(!e.dragAction.hasMoved)if(e.dragAction.hasMoved=!0,e.clickCount>0&&e.selectionBeforeClick&&(e.selection=Pi(e.selectionBeforeClick)),e.clickCount=0,e.selectionBeforeClick=null,e.dragAction.button===0)if(e.dragAction.draggedEntityType){const i=t.getDragType(e);i?(e.dragAction.type=i,e.mode=ve.DRAGGING):e.dragAction.type=Nn.PANNING}else e.dragAction.type=Nn.PANNING,!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection();else e.dragAction.button===2&&(e.dragAction.type=Nn.MARQUEE_SELECT,e.mode=ve.SELECTING,e.marqueeRect.active=!0,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY);e.dragAction&&e.dragAction.type===Nn.MARQUEE_SELECT&&(e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY,Bf(e,t,s))}}function sc(e,t,n,s){if(s.button===0){if(e.dragAction&&e.dragAction.button===0)if(e.dragAction.hasMoved)e.mode=ve.IDLE;else{const i=e.dragAction.draggedEntityType;if(i){const o=i===ie.VERTEX||i===ie.EDGE||i===ie.FACE||i===ie.TEXT,a=i===ie.TRANSFORMATION_OBJECT;e.clickCount===1&&e.dragAction.wasAlreadySelected&&!s.shiftKey&&!s.ctrlKey&&(o?(e.clearGeometricSelection(),Jn(e,i,[e.dragAction.draggedEntityId])):a&&(e.clearTransformationObjectSelection(),Jn(e,i,[e.dragAction.draggedEntityId]),e.activeTransformationObjectId=e.dragAction.draggedEntityId))}else!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==ve.DRAWING&&(e.mode=ve.DRAWING)}else e.dragAction||e.hoverTarget.type===ie.CANVAS&&(!s.shiftKey&&!s.ctrlKey&&e.clearGeometricSelection(),e.mode!==ve.DRAWING&&(e.mode=ve.DRAWING));e.clickCount>0&&(!e.dragAction||!e.dragAction.hasMoved)||(e.clickCount=0,e.selectionBeforeClick=null),e.dragAction=null}}function Gf(e,t,n,s){e.mode===ve.TYPING&&(n.stopTyping(e),e.mode=ve.IDLE),e.clickCount=0,e.selectionBeforeClick=null,(e.mode===ve.IDLE||e.mode===ve.DRAWING)&&(e.dragAction={hasMoved:!1,button:2,originalMode:e.mode,originalSelection:Pi(e.selection)},e.marqueeRect.startX=s.clientX,e.marqueeRect.startY=s.clientY,e.marqueeRect.endX=s.clientX,e.marqueeRect.endY=s.clientY)}function Xa(e,t,n,s){e.dragAction&&e.dragAction.button===2?e.dragAction.hasMoved?e.mode=e.dragAction.originalMode:(!s.shiftKey&&!s.ctrlKey&&(e.clearSelection(),e.activeTransformationObjectId=null),e.mode=ve.IDLE):e.dragAction||(e.mode=ve.IDLE),e.dragAction=null,e.marqueeRect.active=!1}function Hf(e,t,n,s){if(e.mode===ve.TYPING){n.stopTyping(e),e.mode=ve.IDLE;return}const i=s.event;i.touches.length===1?(e.lastMouseX=i.touches[0].clientX,e.lastMouseY=i.touches[0].clientY,clearTimeout(e.touchTimerId),e.initialTouchData={clientX:i.touches[0].clientX,clientY:i.touches[0].clientY,targetType:s.type,targetId:s.id},e.touchTimerId=setTimeout(()=>{e.touchTimerId=null;const o=e.initialTouchData.targetType,a=e.initialTouchData.targetId;o===ie.CANVAS?e.dragAction={hasMoved:!1,button:0}:tc(e,t,n,{type:o,id:a,button:0}),e.hoverTarget={type:ie.CANVAS,id:null}},Ff),s.type!==ie.CANVAS&&Ql(e,t,n,{type:s.type,id:s.id})):i.touches.length===2&&(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,e.dragAction={hasMoved:!1,button:0,type:Nn.PANNING,startDistance:Math.hypot(i.touches[0].clientX-i.touches[1].clientX,i.touches[0].clientY-i.touches[1].clientY),startCenter:{x:(i.touches[0].clientX+i.touches[1].clientX)/2,y:(i.touches[0].clientY+i.touches[1].clientY)/2},originalMode:e.mode},e.mode=ve.DRAGGING,e.clearGeometricSelection())}function zf(e,t,n,s){const i=s.touches;if(i.length===1){const o=i[0].clientX,a=i[0].clientY;if(e.lastMouseX=o,e.lastMouseY=a,e.touchTimerId&&(clearTimeout(e.touchTimerId),e.touchTimerId=null),e.dragAction&&e.dragAction.button===0){nc(e,t,n,{clientX:o,clientY:a,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl});return}}else if(i.length===2&&e.dragAction&&e.dragAction.type===Nn.PANNING){e.dragAction.hasMoved=!0;const o=Math.hypot(i[0].clientX-i[1].clientX,i[0].clientY-i[1].clientY),a={x:(i[0].clientX+i[1].clientX)/2,y:(i[0].clientY+i[1].clientY)/2},r=o/e.dragAction.startDistance,c=Math.log(r)*100;a.x-e.dragAction.startCenter.x,a.y-e.dragAction.startCenter.y,c!==0&&Zl(e,t,n,{deltaY:-c}),e.lastMouseX=a.x,e.lastMouseY=a.y}}function Wf(e,t,n,s){e.touchTimerId?(clearTimeout(e.touchTimerId),e.touchTimerId=null,e.initialTouchData=null,Xa(e,t,n,{shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}),e.mode===ve.IDLE&&!e.modifiers.shift&&!e.modifiers.ctrl&&e.clearSelection()):e.dragAction&&e.dragAction.button===0?sc(e,t,n,{button:0,shiftKey:e.modifiers.shift,ctrlKey:e.modifiers.ctrl}):e.hoverTarget={type:ie.CANVAS,id:null},e.dragAction&&e.dragAction.button===2&&Xa(e,t,n,{}),e.dragAction=null,e.marqueeRect.active=!1,ec(e,t,n,{id:e.hoverTarget.id})}const Kf={keyDown:$f,keyUp:Vf,wheel:Zl,hoverStart:Ql,hoverEnd:ec,appModeChange:Xf,mouseDown:Yf,entityMouseDown:tc,mouseMove:nc,mouseUp:sc,rightMouseDown:Gf,rightMouseUp:Xa,touchStart:Hf,touchMove:zf,touchEnd:Wf};function qf(e,t,n,s,i){const o=Kf[s];o&&o(e,t,n,i)}const ge=document.getElementById("drawingCanvas"),Ce=ge.getContext("2d",{willReadFrequently:!0}),lt=document.getElementById("html-overlay"),Fe=window.devicePixelRatio||1,Fo=new Map,xr=18,oi=8,Ea={x:12,y:-12},jf={x:8,y:-8};let Et={activeId:null,inputEl:null};const bn={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0,radiusMode:"relative",radiusValue:.25},Sr="platonic-play",Ai=1,Ca=`${Sr}.user-id`;let pn=null,ii=null,oc=!1,Qn,js,hn=[JSON.parse(JSON.stringify(bn))],_s=bn.id;const z={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,colorModeToolButton:null,colorModeIcons:[],colorModeExprFields:[],colorModePanelBounds:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[],sessionsToolButton:null,sessionIcons:[],addSessionButton:null,removeSessionButton:null,sessionsPanelBounds:null};let xt,Us=null,Js=null,$t=null,Ya=[],_i=null,Ds=new Map,Pn=null,Fn=null,ho=null,Go=null,ks=null,Ln=null,to=!1,Ot=null,we=[],Vt=null,ds=null,mt=null,Wn=null,Bo=!1,Ho=null,mn=!1,na=!1,on=!1,St=!1,an=!1,Rs="regular",dt="lines",Sn="degrees",ci="on",Di=!0,ki=!0,Kn=!0,fn=null,Jt=null,Gt=null,Ri=null,Li=!1,vs=!1,re=[],K=[],Z=[],$e=[],Ls=new Map,Ct=new Map,ue=[],he=[],ae=[],Ie=[],Je=null,j={x:0,y:0},hs=null,ns=!1,it=!1,Oi=!1,Ao=null,An=!1,Qt=!1,fo=null,st=[],nn=0,Zn=!0,Dn=!0,Qe=null,di=4,ps=3,Uf=.5,ze=null,Xt=!1,Oe=!1,Yn=!1,vn=!1,jt=-1,sn={x:0,y:0},Ta={x:0,y:0},de=[],Ni={x:0,y:0},te=null,pe=ji,Ke=!1,ht=null,Fi=null,Se=[],Zs=[],Ga=[],Te=!1,Nt={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},fe={targetId:null,type:null,count:0,timestamp:0},ai={id:null,timestamp:0},It=[],Ae=[],Zt=0,wt=0,_o=null,Bi=[],Wt="fixed",Ht="fixed",is="x",Ms="x",Es="r",pt=null,yt=null,hi=null,fi=null,Bn=null,$n=null,bt=!1,Io=!1,wn=null,ui=!1,_t=null;function Jf(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,s=Array.prototype.splice;It.pop=function(){return e.call(this)},It.push=function(...i){return t.call(this,...i)},It.shift=function(){return n.call(this)},It.splice=function(...i){return s.call(this,...i)}}let Ha=!1,as=[],Be=null,_e=[],Yt="",Ut=null,Os=[],gi=0,U={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},se={scale:wd,offsetX:0,offsetY:0},Mn={angle1:30,angle2:15,alpha1:1,alpha2:0},Ir=new Set,$o="dark",Xe=[],rs=!1,ut=null,Do=!1,pi=null,Ee={[Ge]:0,[Ue]:1,[ot]:2,[Ft]:0},qn=!1,En=null,$i=null,no=new Set;const me=new Of,ic={getEntitiesInRect:e=>{const t=[],n=s=>s.x>=e.minX&&s.x<=e.maxX&&s.y>=e.minY&&s.y<=e.maxY;return re.forEach(s=>{const i=xe(s);n(i)&&t.push({type:s.type==="regular"?ie.VERTEX:ie.TRANSFORMATION_OBJECT,id:s.id})}),K.forEach(s=>{const i=q(s.id1),o=q(s.id2);if(!i||!o)return;const a=xe({x:(i.x+o.x)/2,y:(i.y+o.y)/2});n(a)&&t.push({type:ie.EDGE,id:ne(s)})}),Z.forEach(s=>{const i=s.vertexIds.map(r=>q(r)).filter(Boolean);if(i.length<3)return;const o=i.reduce((r,c)=>({x:r.x+c.x,y:r.y+c.y}),{x:0,y:0}),a=xe({x:o.x/i.length,y:o.y/i.length});n(a)&&t.push({type:ie.FACE,id:ce(s)})}),$e.forEach(s=>{const i=s.screenBounds;if(!i)return;const o={x:(i.left+i.right)/2,y:(i.top+i.bottom)/2};n(o)&&t.push({type:ie.TEXT,id:s.id})}),t},getNeighbors:e=>{if(q(e))return yn(e,K);const n=K.find(o=>ne(o)===e);if(n)return[n.id1,n.id2];const s=Z.find(o=>ce(o)===e);if(s)return[...s.vertexIds];const i=$e.find(o=>o.id===e);return i&&i.anchorId?[i.anchorId]:[]},getAllConnected:e=>{const t=ic.getEntityType(e);if(t===ie.VERTEX||t===ie.TRANSFORMATION_OBJECT)return Fs(e);if(t===ie.EDGE){const n=K.find(i=>ne(i)===e);if(!n)return[];const s=new Set(Fs(n.id1));return K.filter(i=>s.has(i.id1)&&s.has(i.id2)).map(i=>ne(i))}if(t===ie.FACE){const n=Z.find(o=>ce(o)===e);if(!n)return[];const s=new Set([ce(n)]),i=[n];for(;i.length>0;){const o=i.shift();Z.forEach(a=>{const r=ce(a);s.has(r)||a.vertexIds.some(c=>o.vertexIds.includes(c))&&(s.add(r),i.push(a))})}return Array.from(s)}return[e]},getEntityType:e=>{const t=q(e);return t?t.type==="regular"?ie.VERTEX:ie.TRANSFORMATION_OBJECT:K.some(n=>ne(n)===e)?ie.EDGE:Z.some(n=>ce(n)===e)?ie.FACE:$e.some(n=>n.id===e)?ie.TEXT:null},getDragType:e=>e.selection.vertices.size>0||e.selection.edges.size>0||e.selection.faces.size>0||e.selection.text.size>0||e.selection.transformationObjects.size>0?Nn.RIGID_DRAG:null},Zf={startTyping:()=>{Et.activeId||qa("")},updateText:(e,t)=>{if(!Et.activeId){qa(t);return}const n=Et.inputEl;if(n)n.value+=t;else{const s=uo(Et.activeId);s&&(s.content=`${s.content||""}${t}`)}e.textInput.value=Et.inputEl?Et.inputEl.value:""},backspace:e=>{const t=Et.inputEl;t&&(t.value=t.value.slice(0,-1),e.textInput.value=t.value)},stopTyping:()=>{Mo(!0)}};function cn(e,t){qf(me,ic,Zf,e,t)}function Bt(){Et.activeId?me.mode=ve.TYPING:vn?me.mode=ve.SELECTING:Oe||Yn||vs||qn?me.mode=ve.DRAGGING:Ke?me.mode=ve.DRAWING:me.mode=ve.IDLE,me.modifiers.shift=Te,me.modifiers.ctrl=Io,me.modifiers.alt=bt,me.selection.vertices=new Set(ue),me.selection.edges=new Set(he),me.selection.faces=new Set(ae),me.selection.text=new Set(Ie),me.selection.transformationObjects=new Set(_e),me.activeTransformationObjectId=Je,Ri?me.hoverTarget={type:ie.TEXT,id:Ri}:fn?me.hoverTarget={type:ie.VERTEX,id:fn}:Jt?me.hoverTarget={type:ie.EDGE,id:Jt}:Gt?me.hoverTarget={type:ie.FACE,id:Gt}:me.hoverTarget={type:ie.CANVAS,id:null},me.marqueeRect={active:vn,startX:Ni.x,startY:Ni.y,endX:j.x,endY:j.y},me.zoomLevel=se.scale,me.lastMouseX=j.x,me.lastMouseY=j.y;const e=Et.inputEl;me.textInput.active=!!Et.activeId,me.textInput.x=j.x,me.textInput.y=j.y,me.textInput.value=e?e.value:"",Xt?me.dragAction={hasMoved:Oe,button:jt,type:vn?Nn.MARQUEE_SELECT:Yn?Nn.PANNING:null}:me.dragAction=null}function Ml(e,t){e&&(e.classList.toggle("active",t),e.setAttribute("aria-pressed",t?"true":"false"))}function Qf(e,t){const n={key:e,shiftKey:e==="Shift",ctrlKey:e==="Control",metaKey:!1,altKey:e==="Alt",repeat:!1,target:document.body,preventDefault:()=>{},stopPropagation:()=>{}};t?Oc(n):Nc(n)}function eu(){const e=document.getElementById("mobile-controls");if(!e)return;const t=e.querySelector('[data-mod="hover"]'),n=e.querySelector('[data-mod="shift"]'),s=e.querySelector('[data-mod="ctrl"]'),i=e.querySelector('[data-mod="alt"]'),o=()=>{ui=!ui,Ml(t,ui),Bt()},a=(r,c,l)=>{const d=!l;Ml(r,d),Qf(c,d)};t&&t.addEventListener("click",o),n&&n.addEventListener("click",()=>a(n,"Shift",Te)),s&&s.addEventListener("click",()=>a(s,"Control",Io)),i&&i.addEventListener("click",()=>a(i,"Alt",bt))}function tu(e){return Nl(e,z,{isToolbarExpanded:ns,isColorPaletteExpanded:it,isColorModePanelExpanded:an,isInterpolationPanelExpanded:on,isTransformPanelExpanded:An,isDisplayPanelExpanded:mn,isVisibilityPanelExpanded:na,isSessionsPanelExpanded:St})}function Vs(){wh(Z,q)}function br(){return Eh($o,td)}function Le(e,t=0,n=1){let s=Ee[e];(s<0||s>=pe.length)&&(s=0);const i=pe[s];if(i?.type==="color")return i.value;if(i?.type==="colormap"){const a=n>1?t/(n-1):.5;return De(i,a)}const o=br();return e===Ge?o.vertex:e===Ue?o.edge:e===ot?o.face:e===Ft?o.uiTextDefault||o.geometryInfoText:o.vertex}function Vi(e){return[]}function sa(){const e=new Set(he);return Array.from(me.selection.edges||[]).forEach(n=>e.add(n)),Array.from(e)}function oa(){const e=new Set(ae);return Array.from(me.selection.faces||[]).forEach(n=>e.add(n)),Array.from(e)}function so(){const e=sa();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=K.find(i=>ne(i)===n);s&&t.add(vr(s))}),Array.from(t)}function oo(){const e=oa();if(e.length===0)return[];const t=new Set;return e.forEach(n=>{const s=Z.find(i=>ce(i)===n);s&&t.add(Mr(s))}),Array.from(t)}function ac(){const e=sa();if(e.length>0){const n=Jt?K.find(s=>ne(s)===Jt):null;if(n&&e.includes(ne(n))){const s=vr(n);so().includes(s)&&(Bn=s)}so().includes(Bn)||(Bn=so()[0]||Bn)}const t=oa();if(t.length>0){const n=Gt?Z.find(s=>ce(s)===Gt):null;if(n&&t.includes(ce(n))){const s=Mr(n);oo().includes(s)&&($n=s)}oo().includes($n)||($n=oo()[0]||$n)}}function vr(e){return e?.colorMode||Wt}function Mr(e){return e?.colorMode||Ht}function jn(e,t){if(e.colorMode=t,t==="fixed"){const n=Le(Ue);e.color=e.color||n,delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd;return}if(t==="colormap"){const n=pe[Ee[Ue]];if(n&&n.type==="colormap"){e.colormapItem=e.colormapItem||n,e.gradientStart=e.gradientStart??0,e.gradientEnd=e.gradientEnd??1,delete e.color;return}e.color=Le(Ue),delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd;return}delete e.colormapItem,delete e.gradientStart,delete e.gradientEnd}function zo(e,t){if(e.colorMode=t,t==="fixed"){const n=Le(ot);e.color=e.color||n,delete e.colormapItem,delete e.colormapDistribution;return}if(t==="colormap_xy"||t==="colormap_polar"){const n=pe[Ee[ot]];if(n&&n.type==="colormap"){e.colormapItem=e.colormapItem||n,e.colormapDistribution=e.colormapDistribution||"x",delete e.color;return}e.color=Le(ot),delete e.colormapItem,delete e.colormapDistribution;return}delete e.colormapItem,delete e.colormapDistribution}function nu(e,t=null){(t||sa()).forEach(s=>{const i=K.find(o=>ne(o)===s);i&&jn(i,e)})}function su(e,t=null){(t||oa()).forEach(s=>{const i=Z.find(o=>ce(o)===s);i&&zo(i,e)})}function za(){K.forEach(e=>{const t=e.colorMode||Wt;jn(e,t)}),Z.forEach(e=>{const t=e.colorMode||Ht;zo(e,t)})}function Er(){Xe.forEach(e=>{const t=Ee[e];if(e===Ge){const n=pe[t];if(n&&n.type==="colormap"){const s=ue.map(i=>q(i)).filter(i=>i&&i.type==="regular");s.forEach((i,o)=>{const a=s.length>1?o/(s.length-1):.5;i.color=De(n,a)})}else ue.forEach(s=>{const i=q(s);i&&i.type==="regular"&&(i.color=Le(Ge))})}else if(e===Ue){const n=pe[t];he.forEach((s,i)=>{const o=K.find(c=>ne(c)===s);if(!o)return;const a=vr(o);if(a==="inherit_vertices")return;if(a==="colormap"&&n&&n.type==="colormap"){const c=he.length,l=c>1?i/c:0,d=c>1?(i+1)/c:1;o.gradientStart=l,o.gradientEnd=d,o.colormapItem=n,delete o.color;return}const r=n&&n.type==="colormap"?De(n,.5):Le(Ue);o.color=r,delete o.gradientStart,delete o.gradientEnd,delete o.colormapItem})}else if(e===ot){const n=Ee[e],s=pe[n];ae.forEach(i=>{const o=Z.find(c=>ce(c)===i);if(!o)return;const a=Mr(o);if(a==="inherit_vertices"||a==="inherit_edges")return;if((a==="colormap_xy"||a==="colormap_polar")&&s&&s.type==="colormap"){o.colormapItem=s,o.colormapDistribution="x",delete o.color;return}const r=s&&s.type==="colormap"?De(s,.5):Le(ot);o.color=r,delete o.colormapItem,delete o.colormapDistribution})}else if(e===Ft){const n=pe[t];if(n&&n.type==="colormap")Ie.forEach((s,i)=>{const o=uo(s);if(!o)return;const a=Ie.length>1?i/(Ie.length-1):.5;o.color=De(n,a)});else{const s=Le(Ft);Ie.forEach(i=>{const o=uo(i);o&&(o.color=s)})}}})}function At({id:e,content:t,x:n,y:s,color:i,fontSize:o,options:a={}}){Ir.add(e);let r=Fo.get(e);if(r){if(!r.contentEl||!r.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.textContent="",r.appendChild(u),r.contentEl=u,r.katexEl=p,r.katexContent=null,r.style.pointerEvents="none"}}else{r=document.createElement("div"),r.style.position="absolute",r.style.fontFamily="KaTeX_Main, Times New Roman, serif",r.style.whiteSpace="nowrap",r.style.lineHeight="1",r.style.display="inline-block",r.style.padding="0",r.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const p=document.createElement("div");p.style.display="inline-block",p.style.whiteSpace="nowrap",p.style.lineHeight="1",u.appendChild(p),r.appendChild(u),r.contentEl=u,r.katexEl=p,lt.appendChild(r),Fo.set(e,r)}let c="-50%",l="-50%",d="center";switch(a.textAlign){case"left":c="0%";break;case"right":c="-100%";break}switch(a.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}a.textAlign==="left"&&a.textBaseline==="top"?d="top left":a.textAlign==="right"&&a.textBaseline==="top"?d="top right":a.textAlign==="left"&&a.textBaseline==="bottom"?d="bottom left":a.textAlign==="right"&&a.textBaseline==="bottom"&&(d="bottom right"),r.style.left=`${n}px`,r.style.top=`${s}px`,r.style.transformOrigin=d,r.style.transform=`translate(${c}, ${l}) rotate(${a.rotation||0}deg)`,r.style.display="inline-block",r.style.background="transparent",r.style.border="none",r.style.borderRadius="0",r.style.padding="0",r.style.minHeight="0",r.style.alignItems="",r.style.justifyContent="",r.style.color=i,r.style.fontSize=`${o}px`;const h=t==null?"":String(t),f=Pa(h);if(r.katexContent!==f){const u=r.katexEl||r.contentEl||r;wa(u,f),r.katexContent=f}}function El(e,{placeholder:t,onChange:n}){if(e)return e;const s=document.createElement("div");s.style.position="absolute",s.style.display="none",s.style.boxSizing="border-box",s.style.pointerEvents="auto",s.style.fontFamily='Consolas, Monaco, "Courier New", monospace',s.style.fontSize=`${jr}px`,s.style.padding=`${Nd}px ${Od}px`,s.style.borderRadius=`${Ld}px`,s.style.border=`${Na}px solid rgba(0,0,0,0.3)`,s.style.background="transparent",s.style.alignItems="center",s.style.gap="4px";const i=document.createElement("div");i.style.display="inline-flex",i.style.alignItems="center",i.style.whiteSpace="nowrap",i.style.lineHeight="1";const o=document.createElement("input");return o.type="text",o.placeholder=t,o.style.flex="1",o.style.minWidth="0",o.style.border="none",o.style.outline="none",o.style.background="transparent",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize=`${jr}px`,o.style.color="#111111",o.style.height="100%",o.style.lineHeight="1",o.style.pointerEvents="auto",o.addEventListener("input",()=>{n&&n(o.value)}),s.appendChild(i),s.appendChild(o),lt.appendChild(s),{container:s,label:i,input:o,labelText:""}}function ou(e){const t=e.match(/[A-Za-z_][A-Za-z0-9_]*/g);return t||[]}function Cl(e,t){const n=(e||"").trim();return n?ou(n).every(i=>t.includes(i)):!0}function iu(){const e=so(),t=oo(),n=e.length>0?e.includes(Bn)?Bn:e[0]:null,s=t.length>0?t.includes($n)?$n:t[0]:null;n!=="colormap"&&(hi=null),s!=="colormap_xy"&&s!=="colormap_polar"&&(fi=null),pt=El(pt,{placeholder:"x",onChange:r=>{const c=r.trim();if(!Cl(c,["x"])){pt.input.value=is||"x";return}is=c||"x",qt()}}),yt=El(yt,{placeholder:"x",onChange:r=>{const c=r.trim();if(!Cl(c,Ht==="colormap_polar"?["r","phi"]:["x","y"])){const d=Ht==="colormap_polar"?Es||"r":Ms||"x";yt.input.value=d;return}Ht==="colormap_polar"?Es=c||"r":Ms=c||"x",qt()}});const i=$o==="light",o=i?"#000000":"#ffffff",a=i?"#000000":"#ffffff";if(pt.container.style.display="none",yt.container.style.display="none",!(!an||!z.colorModeIcons.length)){if(n==="colormap"){const r=z.colorModeExprFields.find(c=>c.group==="edge");if(r){const c="c(x)=";pt.labelText!==c&&(wa(pt.label,Pa(c)),pt.labelText=c),pt.input.value=is||"x",pt.container.style.left=`${r.x}px`,pt.container.style.top=`${r.y}px`,pt.container.style.width=`${r.width}px`,pt.container.style.height=`${r.height}px`,pt.container.style.border=`${Na}px solid ${a}`,pt.container.style.color=o,pt.input.style.color=o,pt.container.style.display="flex";const l=r.baseWidth||r.width,d=r.expandedWidth||r.width,h=pt.label.getBoundingClientRect().width,f=pt.input.scrollWidth,p=h+f+8>l?d:l;if(hi!==p){hi=p,Gi();return}}}if(s==="colormap_xy"||s==="colormap_polar"){const r=z.colorModeExprFields.find(c=>c.group==="face");if(r){const c=s==="colormap_polar"?"c(r,\\phi)=":"c(x,y)=";yt.labelText!==c&&(wa(yt.label,Pa(c)),yt.labelText=c);const l=s==="colormap_polar"?Es:Ms;yt.input.value=l||(s==="colormap_polar"?"r":"x"),yt.container.style.left=`${r.x}px`,yt.container.style.top=`${r.y}px`,yt.container.style.width=`${r.width}px`,yt.container.style.height=`${r.height}px`,yt.container.style.border=`${Na}px solid ${a}`,yt.container.style.color=o,yt.input.style.color=o,yt.container.style.display="flex";const d=r.baseWidth||r.width,h=r.expandedWidth||r.width,f=yt.label.getBoundingClientRect().width,u=yt.input.scrollWidth,g=f+u+8>d?h:d;if(fi!==g){fi=g,Gi();return}}}}}function au(e,t,n){const s=Ps(e),i=Ps(t),o=Math.max(0,Math.min(1,n)),a=Math.round(s.r*(1-o)+i.r*o),r=Math.round(s.g*(1-o)+i.g*o),c=Math.round(s.b*(1-o)+i.b*o),l=s.a;return`rgba(${a}, ${r}, ${c}, ${l})`}function ru(){for(const[e,t]of Fo.entries())Ir.has(e)||(t.remove(),Fo.delete(e))}function io(e){return{x:e.x*Fe/se.scale,y:-e.y*Fe/se.scale}}function uo(e){return $e.find(t=>t.id===e)}function Cr(e,t,n,s=null){if(!e||!t||!n)return null;const i={x:n.x-t.x,y:n.y-t.y},o=Math.hypot(i.x,i.y);if(o<1e-6)return null;let a={x:-i.y/o,y:i.x/o};if(s&&s.length>=3){const r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},c=s.reduce((h,f)=>({x:h.x+f.x,y:h.y+f.y}),{x:0,y:0});c.x/=s.length,c.y/=s.length;const l={x:c.x-r.x,y:c.y-r.y};a.x*l.x+a.y*l.y>0&&(a={x:-a.x,y:-a.y})}return{normalData:a,edgeLen:o}}function rc(e){const t=K.find(l=>ne(l)===e);if(!t)return io(oi);const n=q(t.id1),s=q(t.id2);if(!n||!s)return io(oi);const i=Z.filter(l=>{const d=l.vertexIds||[];for(let h=0;h<d.length;h++){const f=d[h],u=d[(h+1)%d.length];if(f===t.id1&&u===t.id2||f===t.id2&&u===t.id1)return!0}return!1});let o=null;i.length===1&&(o=(i[0].vertexIds||[]).map(d=>q(d)).filter(Boolean));const a=Cr(t,n,s,o);if(!a)return io(oi);const r=a.normalData,c=oi*Fe/se.scale;return{x:r.x*c,y:r.y*c}}function Wa(e,t){const n=K.find(l=>ne(l)===e);if(!n||!t)return null;const s=q(n.id1),i=q(n.id2);if(!s||!i)return null;const o=Cr(n,s,i);if(!o)return null;const{normalData:a,edgeLen:r}=o;return r<1e-6?null:(t.x*a.x+t.y*a.y)/r}function Ka(e){const t=q(e);if(!t)return{offset:io(Ea),align:"left",baseline:"middle"};const s=yn(e,K).map(f=>q(f)).filter(Boolean);let i={x:1,y:0};if(s.length===2){const f={x:s[0].x-t.x,y:s[0].y-t.y},u={x:s[1].x-t.x,y:s[1].y-t.y},p=Math.hypot(f.x,f.y),g=Math.hypot(u.x,u.y);if(p>1e-6&&g>1e-6){const y={x:f.x/p,y:f.y/p},m={x:u.x/g,y:u.y/g},x={x:y.x+m.x,y:y.y+m.y},S=Math.hypot(x.x,x.y);S>1e-6?i={x:-x.x/S,y:-x.y/S}:i={x:-y.y,y:y.x}}}const o=xe(t),a=xe({x:t.x+i.x,y:t.y+i.y});let r={x:a.x-o.x,y:a.y-o.y};const c=Math.hypot(r.x,r.y);c>1e-6?(r.x/=c,r.y/=c):r={x:1,y:0};const l=Math.hypot(Ea.x,Ea.y),d={x:r.x*l,y:r.y*l},h=r.x>=0?"left":"right";return{offset:io(d),align:h,baseline:"middle"}}function Xi(e){return hn.find(t=>t.id===e)||null}function Yi(){return Xi(_s)||hn[0]||bn}function yi(e){e&&(_s=e,qt())}function lc(){const e=new Set(he),t=new Set(ae),n=new Set(ue),s=new Set,i=o=>{const a=o||bn.id;s.add(a)};return e.size>0&&K.forEach(o=>{const a=ne(o);e.has(a)&&i(o.interpolationStyleId)}),t.size>0&&Z.forEach(o=>{const a=ce(o);a&&t.has(a)&&i(o.interpolationStyleId)}),e.size===0&&t.size===0&&n.size>0&&(K.forEach(o=>{(n.has(o.id1)||n.has(o.id2))&&i(o.interpolationStyleId)}),Z.forEach(o=>{o.vertexIds&&o.vertexIds.some(a=>n.has(a))&&i(o.interpolationStyleId)})),s.size===1?[...s][0]:null}function lu(e){if(!e)return;const t=new Set(he),n=new Set(ae),s=new Set(ue);let i=!1;t.size>0&&K.forEach(o=>{const a=ne(o);t.has(a)&&(o.interpolationStyleId=e,i=!0)}),n.size>0&&Z.forEach(o=>{const a=ce(o);a&&n.has(a)&&(o.interpolationStyleId=e,i=!0)}),t.size===0&&n.size===0&&s.size>0&&(K.forEach(o=>{(s.has(o.id1)||s.has(o.id2))&&(o.interpolationStyleId=e,i=!0)}),Z.forEach(o=>{o.vertexIds&&o.vertexIds.some(a=>s.has(a))&&(o.interpolationStyleId=e,i=!0)})),i&&qt()}function cu(){const e=new Set(he),t=new Set(ae),n=new Set(ue);let s=!1;e.size>0&&K.forEach(i=>{const o=ne(i);e.has(o)&&(delete i.interpolationStyleId,s=!0)}),t.size>0&&Z.forEach(i=>{const o=ce(i);o&&t.has(o)&&(delete i.interpolationStyleId,s=!0)}),e.size===0&&t.size===0&&n.size>0&&(K.forEach(i=>{(n.has(i.id1)||n.has(i.id2))&&(delete i.interpolationStyleId,s=!0)}),Z.forEach(i=>{i.vertexIds&&i.vertexIds.some(o=>n.has(o))&&(delete i.interpolationStyleId,s=!0)})),s&&qt()}function Ns(e){const t=Yi();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function cc(e){if(!e)return null;const t=new Map;Oe&&Array.isArray(Se)&&Se.length>0&&Se.forEach(s=>{if(!s||!s.id)return;const i=s.originalId||s.id;t.set(i,s)});const n=s=>t.has(s)?t.get(s):q(s);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const s=n(e.anchorId);return s?{anchor:{x:s.x,y:s.y}}:null}if(e.anchorType==="edge"){const s=K.find(g=>ne(g)===e.anchorId);if(!s)return null;const i=n(s.id1),o=n(s.id2);if(!i||!o)return null;const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2},r=Math.atan2(o.y-i.y,o.x-i.x),c=xe(i),l=xe(o),d=Math.atan2(l.y-c.y,l.x-c.x),h=Z.filter(g=>{const y=g.vertexIds||[];for(let m=0;m<y.length;m++){const x=y[m],S=y[(m+1)%y.length];if(x===s.id1&&S===s.id2||x===s.id2&&S===s.id1)return!0}return!1});let f=null;h.length===1&&(f=(h[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=Cr(s,i,o,f),p=u?u.normalData:null;return{anchor:a,edgeAngleRad:r,edgeAngleRadScreen:d,edgeNormalData:p,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const s=Z.find(a=>ce(a)===e.anchorId);if(!s)return null;const i=s.vertexIds.map(a=>n(a)).filter(a=>a&&a.type==="regular");return i.length<3?null:{anchor:{x:i.reduce((a,r)=>a+r.x,0)/i.length,y:i.reduce((a,r)=>a+r.y,0)/i.length}}}return null}function dc(){return te?.finalSnapResult?.finalDelta?te.finalSnapResult.finalDelta:te?.textFinalDelta?te.textFinalDelta:Se.length>0&&de.length>0?{x:Se[0].x-de[0].x,y:Se[0].y-de[0].y}:null}function hc(e){const t=cc(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=rc(e.anchorId);const l=Wa(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let s={x:t.anchor.x+n.x,y:t.anchor.y+n.y},i=e.rotationDeg||0,o=e.scale||1,a="center",r="middle";if(e.anchorType==="vertex"){const l=Ka(e.anchorId);a=e.vertexAlign||l.align||"left",r=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(a="center",r="middle",typeof t.edgeAngleRadScreen=="number"?i+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(i+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(a="left",r="top");e.anchorType==="edge"&&(i>90||i<-90)&&(i+=180,i>180&&(i-=360),r="top");const c=Ie.includes(e.id);if(Oe&&c)if(ze){const{center:l,rotation:d,scale:h,directionalScale:f,startVector:u}=ze;s=We(s,l,d,h,f,u),i-=d*(180/Math.PI),o*=h}else{const l=dc();l&&(s={x:s.x+l.x,y:s.y+l.y})}return{id:e.id,content:e.content||"",position:s,rotationDeg:i,scale:o,textAlign:a,textBaseline:r}}function du(e){const t=lt.getBoundingClientRect(),n=[];$e.forEach(s=>{const i=hc(s);if(!i){n.push(s.id);return}const o=xe(i.position),a=`text-${i.id}`,r=Ie.includes(s.id),c=s.color||Le(Ft)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",d=au(c,l,.35);At({id:a,content:i.content,x:o.x,y:o.y,color:r?d:c,fontSize:(s.fontSize||xr)*i.scale,options:{textAlign:i.textAlign,textBaseline:i.textBaseline,rotation:i.rotationDeg}});const h=Fo.get(a);if(h){const f=h.contentEl||h;f.style.outline="none",f.style.textShadow="none",f.style.color=r?d:c;const p=(h.katexEl||f).getBoundingClientRect();s.screenBounds={left:p.left-t.left,top:p.top-t.top,right:p.right-t.left,bottom:p.bottom-t.top}}}),n.length>0&&($e=$e.filter(s=>!n.includes(s.id)),Ie=Ie.filter(s=>!n.includes(s)))}function fc(e){for(let t=$e.length-1;t>=0;t--){const n=$e[t],s=n.screenBounds;if(s&&e.x>=s.left&&e.x<=s.right&&e.y>=s.top&&e.y<=s.bottom)return n}return null}function uc(e,t=""){if(!Et.inputEl){const o=document.createElement("input");o.type="text",o.style.position="absolute",o.style.zIndex="5",o.style.pointerEvents="auto",o.style.fontFamily="KaTeX_Main, Times New Roman, serif",o.style.fontSize=`${e.fontSize||xr}px`,o.style.border="1px solid rgba(255, 255, 255, 0.4)",o.style.borderRadius="4px",o.style.padding="2px 4px",o.style.background="rgba(0, 0, 0, 0.6)",o.style.color="#ffffff",o.style.outline="none",o.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),Mo(!0)):a.key==="Escape"&&(a.preventDefault(),Mo(!1))}),o.addEventListener("mouseleave",()=>Mo(!0)),o.addEventListener("blur",()=>Mo(!0)),lt.appendChild(o),Et.inputEl=o}const n=hc(e);if(!n)return;const s=xe(n.position),i=Et.inputEl;i.value=t||e.content||"",i.style.left=`${s.x}px`,i.style.top=`${s.y}px`,i.style.transform="translate(-10%, -10%)",i.style.display="block",Et.activeId=e.id,i.focus(),i.setSelectionRange(i.value.length,i.value.length)}function Mo(e){const t=Et.inputEl;if(!t)return;const n=Et.activeId;if(n&&e){const s=uo(n);if(s){He();const i=t.value.trim();!i&&s.isDraft?($e=$e.filter(o=>o.id!==s.id),Ie=Ie.filter(o=>o!==s.id)):(s.content=i||s.content||"",delete s.isDraft)}}t.style.display="none",Et.activeId=null}function qa(e=""){let t="canvas",n=null,s={x:0,y:0},i=Pe(j);if(fn)t="vertex",n=fn,s=Ka(n).offset;else if(Jt)t="edge",n=Jt,s=rc(n);else if(Gt)t="face",n=Gt;else{const a=io(jf);i={x:i.x+a.x,y:i.y+a.y}}const o={id:zt(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?i:null,offset:t==="canvas"?{x:0,y:0}:s,rotationDeg:0,scale:1,fontSize:xr,color:Le(Ft),isDraft:!0};if(t==="vertex"){const a=Ka(n);o.vertexAlign=a.align,o.vertexBaseline=a.baseline}$e.push(o),Ie=[o.id],uc(o,e)}function Tr(e,t,n){const s=new Set(me.selection.transformationObjects);let i=me.activeTransformationObjectId;if(n)if(s.has(e)){if(s.delete(e),i===e){const o=Array.from(s);i=o.length>0?o[o.length-1]:null}}else s.add(e),i=e;else s.has(e)||s.add(e),i=e;me.selection.transformationObjects=s,me.activeTransformationObjectId=i,_e=Array.from(s),Je=i}function mi(e){const t=cs(e,dt,U.interval1,Mn,!0);if(re.forEach(s=>{s.type==="regular"&&t.push({x:s.x,y:s.y,isGridVertex:!1})}),K.forEach(s=>{const i=q(s.id1),o=q(s.id2);if(i&&o&&i.type==="regular"&&o.type==="regular"){const a={x:(i.x+o.x)/2,y:(i.y+o.y)/2,isGridVertex:!1};t.push(a)}}),t.length===0)return null;const n=(s,i)=>(s.x-i.x)**2+(s.y-i.y)**2;return t.reduce((s,i)=>{const o=n(e,s);return n(e,i)<o?i:s})}function Kt(){const e=new Set(re.map(a=>a.id)),t=new Set,n=[];for(const a of e)if(!t.has(a)){const r=Fs(a),c=new Set(r);n.push(c),r.forEach(l=>t.add(l))}const s=a=>[...a].sort().join(","),i=[],o=new Set;Ya.forEach(a=>{const r=s(a);for(let c=0;c<n.length;c++){if(o.has(c))continue;const l=n[c];if(r===s(l)){i.push(l),o.add(c);break}}});for(let a=0;a<n.length;a++)o.has(a)||i.push(n[a]);Ya=i}function hu(e,t,n=!1,s=[],i=1){if(n&&s.length>0&&[...e].some(l=>s.some(d=>d.id===l)))return;const o=Z.filter(c=>c.vertexIds.every(l=>e.has(l)));Bh(Ce,{allFaces:o,allEdges:K,facesVisible:Kn,isDragConfirmed:!1,dragPreviewVertices:[],transformIndicatorData:null,initialDragVertexStates:[],colors:t,initialCoordSystemStates:new Map,interpolationStyle:Yi(),getInterpolationStyleById:Xi,faceColorMode:Ht,edgeColorMode:Wt,faceColorExpression:Ms,faceColorPolarExpression:Es,edgeColorExpression:is},xe,q);const a=K.filter(c=>e.has(c.id1)&&e.has(c.id2));Uh(Ce,{allEdges:a,selectedEdgeIds:he,hoveredEdgeId:Jt,isDragConfirmed:!1,dragPreviewVertices:[],colors:t,edgesVisible:ki,snappedEdgeIds:Ls,currentAltPressed:bt,interpolationStyle:Yi(),getInterpolationStyleById:Xi,edgeColorMode:Wt,edgeColorExpression:is},xe,q,ne),re.filter(c=>e.has(c.id)).forEach(c=>{let l=!1;Ct.has(c.id)&&Ct.get(c.id).some(h=>h.copyIndex===void 0)&&(l=!0),Ti(Ce,c,{selectedVertexIds:ue,selectedCenterIds:_e,activeCenterId:Je,colors:t,verticesVisible:Di,isHovered:fn===c.id,isSnapped:l,snappedVertexIds:Ct,isDragConfirmed:!1,dragPreviewVertices:[],currentAltPressed:bt},xe)})}function Wo(e,t,n,s=!1,i=null){const o=Pe(t),a=i||Dr(e.id),r=Qa/se.scale,c=tr/se.scale,l=U?.alpha2>=U?.alpha1&&U?.interval2?U.interval2:U?.interval1,d=Ve*2/se.scale,h=Ve/se.scale,f=Ve*2/se.scale,u=Ve*2/se.scale,p=Ke&&we.length>=1;if(n){const g=[];let y=!1;for(const S of re)if(S.id!==e.id&&S.type==="regular"&&Q(o,S)<r){y=!0;break}if(!y)for(const S of K){const I=q(S.id1),b=q(S.id2);if(I&&b&&I.type==="regular"&&b.type==="regular"&&Tt(o,I,b).distance<c){y=!0;break}}if(p){if(re.forEach(M=>{if(M.id!==e.id&&M.type==="regular"){const w=Q(o,M);g.push({priority:1,dist:w,pos:M,snapType:"vertex",targetVertex:M})}}),K.forEach(M=>{const w=q(M.id1),O=q(M.id2);w&&O&&w.type==="regular"&&O.type==="regular"&&w.id!==e.id&&O.id!==e.id&&Tt(o,w,O).distance<h*1.5&&Pl.forEach(A=>{const L={x:w.x+A*(O.x-w.x),y:w.y+A*(O.y-w.y)},B=Q(o,L);g.push({priority:2,dist:B,pos:L,snapType:"edge_fraction",targetEdge:M,fraction:A})})}),dt!=="none"&&l){const M=U?.alpha2>=U?.alpha1&&U?.interval2?U.interval2:U.interval1;M&&cs(o,dt,M,Mn,!0).forEach(O=>{const T=Q(o,O);g.push({priority:3,dist:T,pos:O,snapType:"grid"})})}const S=a.currentSegmentReferenceA_for_display,I=a.currentSegmentReferenceD,b=new Set([0,...rr.flatMap(M=>[M,-M])]),E=Array.from(b).sort((M,w)=>M-w).map(M=>({factor:M,angle:On(a.offsetAngleRad+M*S),turn:ct(M*S)})),C=Q(e,o),_=[];if([0,...ss].forEach(M=>_.push({factor:M,dist:M*I})),I>le){const M=C/I,w=Math.round(M),O=Math.round(M*2)/2;[w,O].forEach(T=>{T>=0&&!_.some(A=>Math.abs(A.factor-T)<le)&&_.push({factor:T,dist:T*I})})}if(_.sort((M,w)=>M.dist-w.dist),E.length>0&&_.length>0)for(const M of E)for(const w of _){if(w.dist<le&&(M.factor!==0||_.length>1))continue;const O={x:e.x+w.dist*Math.cos(M.angle),y:e.y+w.dist*Math.sin(M.angle)},T=Q(o,O);g.push({priority:4,dist:T,pos:O,snapType:"geometric",lengthSnapFactor:w.factor,angleSnapFactor:M.factor,angleTurn:M.turn})}}else if(!y&&dt!=="none"&&l){const S=U?.alpha2>=U?.alpha1&&U?.interval2?U.interval2:U.interval1;if(S){const I=cs(o,dt,S,Mn,!0);if(I.length>0){const b=I.sort((v,E)=>Q(o,v)-Q(o,E))[0];g.push({priority:3,dist:Q(o,b),pos:b,snapType:"grid"})}}}let m=null;if(g.length>0)if(!p)m=g[0];else{let S=!1;for(let I=1;I<=3;I++){let b;I===1?b=d:I===2?b=h:b=f;const v=g.filter(E=>E.priority===I&&E.dist<b);if(v.length>0){m=v.sort((E,C)=>E.dist-C.dist)[0],S=!0;break}}if(!S){const I=g.filter(b=>b.priority===4);if(I.length>0){const b=I.sort((v,E)=>v.dist-E.dist)[0];b.dist<u&&(m=b)}}m||(m=g.sort((I,b)=>I.dist-b.dist)[0])}if(m){const S=Math.atan2(m.pos.y-e.y,m.pos.x-e.x)||0,I=parseFloat(Q(e,m.pos).toFixed(10));let b=null,v=null;if(m.snapType==="grid"&&l){const C=U?.alpha2>=U?.alpha1&&U?.interval2?U.interval2:U.interval1;if(C){const _=m.pos.x-e.x,P=m.pos.y-e.y,M=C*1e-5;if(dt==="triangular"){const w=C*er,O=P/w,T=Math.round(O),A=T%2!==0?C/2:0,L=(_-A)/C;if(Math.abs(O-T)<M/w&&Math.abs(L-Math.round(L))<M/C){const B=T,F=Math.round(L);b=F*F+F*B+B*B,v=C}}else{const w=_/C,O=P/C;if(Math.abs(w-Math.round(w))<M/C&&Math.abs(O-Math.round(O))<M/C){const T=Math.round(w),A=Math.round(O);b=T*T+A*A,v=C}}}}let E=m.angleTurn!=null?m.angleTurn:ct(S-a.offsetAngleRad);return{x:parseFloat(m.pos.x.toFixed(Jr)),y:parseFloat(m.pos.y.toFixed(Jr)),angle:S*(180/Math.PI),distance:I,snapped:!0,snapType:m.snapType,targetEdge:m.targetEdge,fraction:m.fraction,targetVertex:m.targetVertex,gridSnapped:m.snapType==="grid",lengthSnapFactor:m.lengthSnapFactor||null,angleSnapFactor:m.angleSnapFactor||null,angleTurn:E,gridToGridSquaredSum:b,gridInterval:v}}const x=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:x*(180/Math.PI),distance:Q(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:ct(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const g=[];for(const x of re)if(x.id!==e.id&&x.type==="regular"){const S=Q(o,x);S<r&&g.push({priority:1,dist:S,pos:x,snapType:"vertex",targetVertex:x})}for(const x of K){const S=q(x.id1),I=q(x.id2);if(S&&I&&S.type==="regular"&&I.type==="regular"){const b=Tt(o,S,I);b.distance<c&&b.onSegmentStrict&&g.push({priority:2,dist:b.distance,pos:{x:b.x,y:b.y},snapType:"edge",targetEdge:x})}}let y=null;if(g.length>0){y=g.sort((S,I)=>S.priority!==I.priority?S.priority-I.priority:S.dist-I.dist)[0];const x=y.priority===1?d:h;y.dist>x&&(y=null)}if(y){const x=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:x*(180/Math.PI),distance:Q(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:ct(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const m=Math.atan2(o.y-e.y,o.x-e.x)||0;return{x:o.x,y:o.y,angle:m*(180/Math.PI),distance:Q(e,o),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:ct(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function fu(e,t,n){const s=[],i=Qa/se.scale,o=tr/se.scale;if(re.forEach(a=>{if(a.id!==e.id&&a.type==="regular"){const r=Q(t,a);r<i&&s.push({priority:1,dist:r,pos:a,snapType:"vertex",targetVertex:a})}}),K.forEach(a=>{if(a.id1===e.id||a.id2===e.id)return;const r=q(a.id1),c=q(a.id2);if(r&&c&&r.type==="regular"&&c.type==="regular"){const l=Tt(t,r,c);l.distance<o&&l.onSegmentStrict&&s.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:a})}}),s.length>0){const a=s.sort((r,c)=>r.priority!==c.priority?r.priority-c.priority:r.dist-c.dist)[0];return{pos:a.pos,snapped:!0,snapType:a.snapType,targetEdge:a.targetEdge,targetVertex:a.targetVertex}}return{pos:t,snapped:!1}}function uu(){pe=pe.map(e=>e.type==="color"?{...e,value:vh(e.value)}:e)}function gu(){z.toolbarButton={id:"toolbar-button",x:Ze,y:Ze,width:Dd,height:kd,type:"menuButton"}}function gc(){const e=ge.height/Fe;z.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:Ne,height:e,type:"toolbar"};const t=Ze;let n=z.toolbarButton.y+z.toolbarButton.height+Rd;z.colorToolButton={id:"color-tool-button",type:"toolButton",x:Ze,y:n,width:Ne-2*Ze,height:Mt},n+=Mt+t,z.colorModeToolButton={id:"color-mode-tool-button",type:"toolButton",x:Ze,y:n,width:Ne-2*Ze,height:Mt},n+=Mt+t,z.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:Ze,y:n,width:Ne-2*Ze,height:Mt},n+=Mt+t,z.transformToolButton={id:"transform-tool-button",type:"toolButton",x:Ze,y:n,width:Ne-2*Ze,height:Mt},n+=Mt+t,z.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:Ze,y:n,width:Ne-2*Ze,height:Mt},n+=Mt+t,z.sessionsToolButton={id:"sessions-tool-button",type:"toolButton",x:Ze,y:n,width:Ne-2*Ze,height:Mt}}function vt(){z.colorSwatches=[],z.colorTargetIcons=[];const e=rs&&ut,t=(()=>{if(!e)return pe.map((x,S)=>S);const u=pe.length,p=Math.max(0,Math.min(u-1,ut.originalIndex)),g=Math.max(0,Math.min(u-1,ut.previewIndex??p)),y=pe.map((x,S)=>S),[m]=y.splice(p,1);return y.splice(g,0,m),y})(),n=Vo,s=$s+xo,i=s-n,o=n*2+i,a=Ne+Ze,l=z.colorToolButton.y+Mt/2-n/2+-2;let d=a;z.removeColorButton={id:"remove-color-button",type:"button",x:d+(s-n)/2,y:l,width:n,height:n},d+=s;const h=u=>!u||u.type!=="colormap"?!1:Array.isArray(u.vertices)&&u.vertices.length>1;t.forEach((u,p)=>{const g=pe[u],y=h(g),m=y?o:n;z.colorSwatches.push({id:`swatch-${u}`,type:"colorSwatch",x:d+(s-n)/2,y:l,width:m,height:n,index:u,positionIndex:p,item:g}),d+=y?s*2:s}),z.addColorButton={id:"add-color-button",type:"button",x:d+(s-n)/2,y:l,width:n,height:n},Object.entries(Ee).forEach(([u,p])=>{const g=n*.75,y=z.colorSwatches.find(m=>m.index===p);y&&z.colorTargetIcons.push({id:`target-icon-${u}`,type:"colorTargetIcon",target:u,x:y.x+(y.width-g)/2,y:y.y-g-5,width:g,height:g})});const f=[...z.colorSwatches,z.removeColorButton,z.addColorButton,...z.colorTargetIcons].filter(Boolean);if(f.length>0){const u=Math.min(...f.map(m=>m.y)),p=Math.max(...f.map(m=>m.x+m.width)),g=Math.max(...f.map(m=>m.y+m.height)),y=5;z.colorPaletteBounds={x:Ne,y:u-y,width:p-Ne+y,height:g-u+y*2}}else z.colorPaletteBounds=null}function Gi(){if(z.colorModeIcons=[],!z.colorModeToolButton)return;const e=Ne+Ze,t=z.colorModeToolButton.y+Mt/2,n=Vo,i=t-n/2+-2,o=$s+xo,a=o-n,r=n*3+a*2,c=r+n+a,l=(o-n)/2,d=["fixed","inherit_vertices","colormap"],h=["fixed","inherit_vertices","inherit_edges","colormap_xy","colormap_polar"],f=so(),u=oo(),p=f.length>0,g=u.length>0,y=p?f.includes(Bn)?Bn:f[0]:null,m=g?u.includes($n)?$n:u[0]:null;z.colorModeExprFields=[];let x=e;const S=(v,E)=>{z.colorModeIcons.push({id:`${v}-color-mode-${E}`,type:"colorModeIcon",group:v,mode:E,x:x+l,y:i,width:n,height:n})},I=(v,E)=>{z.colorModeExprFields.push({id:`${v}-color-expr`,type:"colorModeExprField",group:v,x:x+o+l,y:i,width:E,height:n,baseWidth:r,expandedWidth:c}),x=x+o+l+E+l};d.forEach(v=>{S("edge",v),p&&y===v&&v==="colormap"?I("edge",hi||r):x+=o}),h.forEach(v=>{S("face",v),g&&m===v&&(v==="colormap_xy"||v==="colormap_polar")?I("face",fi||r):x+=o});const b=[...z.colorModeIcons,...z.colorModeExprFields].filter(Boolean);if(b.length>0){const v=Math.min(...b.map(P=>P.y)),E=Math.max(...b.map(P=>P.x+P.width)),C=Math.max(...b.map(P=>P.y+P.height)),_=5;z.colorModePanelBounds={x:Ne,y:v-_,width:E-Ne+_,height:C-v+_*2}}else z.colorModePanelBounds=null}function wr(){if(z.interpolationIcons=[],!z.interpolationToolButton)return;const e=Ne+Ze,t=z.interpolationToolButton.y+Mt/2,n=Vo,i=t-n/2+-2,o=$s+xo;let a=e;z.interpolationIcons.push({id:"interpolation-remove",type:"interpolationRemove",x:a+(o-n)/2,y:i,width:n,height:n}),a+=o,hn.forEach(c=>{z.interpolationIcons.push({id:`interpolation-${c.id}`,type:"interpolationStyle",styleId:c.id,x:a+(o-n)/2,y:i,width:n,height:n}),a+=o}),z.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:a+(o-n)/2,y:i,width:n,height:n});const r=z.interpolationIcons.filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;z.interpolationPanelBounds={x:Ne,y:c-h,width:l-Ne+h,height:d-c+h*2}}else z.interpolationPanelBounds=null}function pu(){if(z.displayIcons=[],!z.visibilityToolButton)return;const e=$s+xo,t=Ne+Ze,n=z.visibilityToolButton.y+Mt/2,s=Vo,o=n-s/2+-2;let a=t;if(["coords","grid","angles","distances","theme"].forEach(c=>{z.displayIcons.push({id:`display-icon-${c}`,group:c,x:a+(e-s)/2,y:o,width:s,height:s}),a+=e}),z.displayIcons.length>0){const c=z.displayIcons[0],l=z.displayIcons[z.displayIcons.length-1],d=5;z.displayPanelBounds={x:Ne,y:c.y-d,width:l.x+l.width-Ne+d,height:c.height+d*2}}else z.displayPanelBounds=null}function ia(){if(z.sessionIcons=[],!z.sessionsToolButton)return;const e=Ne+Ze,t=z.sessionsToolButton.y+Mt/2,n=Vo,i=t-n/2+-2,o=$s+xo;let a=e;z.removeSessionButton={id:"remove-session-button",type:"button",x:a+(o-n)/2,y:i,width:n,height:n},a+=o,Ae.forEach((c,l)=>{z.sessionIcons.push({id:`session-${c.id}`,type:"sessionIcon",x:a+(o-n)/2,y:i,width:n,height:n,index:l,session:c}),a+=o}),z.addSessionButton={id:"add-session-button",type:"button",x:a+(o-n)/2,y:i,width:n,height:n};const r=[...z.sessionIcons,z.removeSessionButton,z.addSessionButton].filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;z.sessionsPanelBounds={x:Ne,y:c-h,width:l-Ne+h,height:d-c+h*2}}else z.sessionsPanelBounds=null}function yu(){z.transformIcons=[];const e=$s,t=e+xo,n=Ne+Ze,i=z.transformToolButton.y+Mt/2-e/2,o=[un,Un,In,us];let a=n;if(o.forEach(r=>{z.transformIcons.push({id:`transform-icon-${r}`,type:r,x:a+(t-e)/2,y:i,width:e,height:e}),a+=t}),z.transformIcons.length>0){const r=z.transformIcons[0],c=z.transformIcons[z.transformIcons.length-1],l=5;z.transformPanelBounds={x:Ne,y:r.y-l,width:c.x+c.width-Ne+l,height:r.height+l*2}}else z.transformPanelBounds=null}function ja(e){e<0||e>=pe.length||pe.length<=1||(pe.splice(e,1),_t!==null&&(_t===e?_t=Math.min(e,pe.length-1):_t>e&&(_t-=1)),Object.keys(Ee).forEach(t=>{Ee[t]>e?Ee[t]--:Ee[t]===e&&(Ee[t]=Math.min(e,pe.length-1))}),vt())}function mu(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}pe.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(pe.push(e),it&&vt())}function pc(e,t=[]){const n=q(e);if(!n)return null;for(let s=K.length-1;s>=0;s--){const i=K[s],o=ne(i);if(t.includes(o))continue;let a=null;if(i.id1===e?a=i.id2:i.id2===e&&(a=i.id1),a){const r=q(a);if(r){const c=n.x-r.x,l=n.y-r.y;return{p1:r,p2:n,angleRad:Math.atan2(l,c),length:Math.sqrt(c*c+l*l),edgeId:o}}}}return null}function He(){const e=qo();pe.length,pe[0]?.value,re.length,It.push(e),It.length>ar&&It.shift(),as=[],qt()}function Pr(e){const t=z.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!ns)return!1;const n=[];z.mainToolbar&&n.push(z.mainToolbar),it&&z.colorPaletteBounds&&n.push(z.colorPaletteBounds),on&&z.interpolationPanelBounds&&n.push(z.interpolationPanelBounds),An&&z.transformPanelBounds&&n.push(z.transformPanelBounds),mn&&z.displayPanelBounds&&n.push(z.displayPanelBounds),St&&z.sessionsPanelBounds&&n.push(z.sessionsPanelBounds),an&&z.colorModePanelBounds&&n.push(z.colorModePanelBounds);for(const i of n)if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;const s=[];it&&z.colorPaletteBounds&&s.push(z.colorPaletteBounds),on&&z.interpolationPanelBounds&&s.push(z.interpolationPanelBounds),An&&z.transformPanelBounds&&s.push(z.transformPanelBounds),mn&&z.displayPanelBounds&&s.push(z.displayPanelBounds),St&&z.sessionsPanelBounds&&s.push(z.sessionsPanelBounds),an&&z.colorModePanelBounds&&s.push(z.colorModePanelBounds),s.sort((i,o)=>i.y-o.y);for(let i=0;i<s.length-1;i++){const o=s[i],a=s[i+1],r=o.y+o.height,c=a.y;if(e.y>r&&e.y<c){const l=Ne,d=o.x+o.width-l,h=a.x+a.width-l,f=Math.min(d,h),u=l+f;if(e.x<Ne||e.x>=l&&e.x<=u)return!0}}return!1}function Ko(e){re=JSON.parse(JSON.stringify(e.vertices)),K=JSON.parse(JSON.stringify(e.edges)),Z=JSON.parse(JSON.stringify(e.faces||[])),$e=JSON.parse(JSON.stringify(e.textElements||[])),ue=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),he=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),ae=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),Ie=JSON.parse(JSON.stringify(e.selectedTextIds||[])),_e=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),Xe=JSON.parse(JSON.stringify(e.activeColorTargets||[])),hn=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(bn))],_s=e.activeInterpolationStyleId||hn[0]?.id||bn.id,pe=e.allColors?JSON.parse(JSON.stringify(e.allColors)):ji.map(n=>typeof n=="string"?{type:"color",value:n}:n),Ee=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[Ge]:0,[Ue]:1,[ot]:2,[Ft]:0},Wt=e.edgeColorMode||"fixed",Ht=e.faceColorMode||"fixed",is=e.edgeColorExpression||"x",Ms=e.faceColorExpression||"x",Es=e.faceColorPolarExpression||"r",Ee[Ft]===void 0&&(Ee[Ft]=0),za(),Je=e.activeCenterId!==void 0?e.activeCenterId:null,Ke=e.isDrawingMode!==void 0?e.isDrawingMode:!1,ht=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,Vt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,ds=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,mt=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,Wn=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,hs=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,no=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,Xt=!1,Oe=!1,vn=!1,Yn=!1,Se=[],Fi=null,jt=-1,fe={targetId:null,type:null,count:0,timestamp:0},ge.style.cursor="crosshair",it&&vt();const t=qo();It.length===0&&It.push(t),qt()}function qo(){return{vertices:JSON.parse(JSON.stringify(re)),edges:JSON.parse(JSON.stringify(K)),faces:JSON.parse(JSON.stringify(Z)),textElements:JSON.parse(JSON.stringify($e)),selectedVertexIds:JSON.parse(JSON.stringify(ue)),selectedEdgeIds:JSON.parse(JSON.stringify(he)),selectedFaceIds:JSON.parse(JSON.stringify(ae)),selectedTextIds:JSON.parse(JSON.stringify(Ie)),selectedCenterIds:JSON.parse(JSON.stringify(_e)),activeColorTargets:JSON.parse(JSON.stringify(Xe)),interpolationStyles:JSON.parse(JSON.stringify(hn)),activeInterpolationStyleId:_s,colorAssignments:JSON.parse(JSON.stringify(Ee)),edgeColorMode:Wt,faceColorMode:Ht,edgeColorExpression:is,faceColorExpression:Ms,faceColorPolarExpression:Es,allColors:JSON.parse(JSON.stringify(pe)),activeCenterId:Je,isDrawingMode:Ke,previewLineStartVertexId:ht,frozenReference_A_rad:Vt,frozenReference_A_baseRad:ds,frozenReference_D_du:mt,frozenReference_Origin_Data:Wn,frozenReference_D_g2g:hs,deletedFaceIds:new Set(no)}}function yc(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function xu(){try{const e=new URLSearchParams(window.location.search);return yc(e.get("user"))}catch{return""}}function mc(){if(pn)return pn;const e=xu();if(e){pn=e;try{localStorage.setItem(Ca,pn)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return pn}try{pn=localStorage.getItem(Ca)}catch{pn=null}if(!pn){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}pn=yc(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(Ca,pn)}catch(s){console.warn("Could not persist user id to localStorage.",s)}}return pn}function xc(){const e=mc();return`${Sr}.state.v${Ai}.${e}`}function Sc(){const e=mc();return`${Sr}.sessions.v${Ai}.${e}`}function Ic(){return{vertices:[],edges:[],faces:[],textElements:[],selectedVertexIds:[],selectedEdgeIds:[],selectedFaceIds:[],selectedTextIds:[],selectedCenterIds:[],activeColorTargets:[],interpolationStyles:[JSON.parse(JSON.stringify(bn))],activeInterpolationStyleId:bn.id,colorAssignments:{[Ge]:0,[Ue]:1,[ot]:2,[Ft]:0},edgeColorMode:"fixed",faceColorMode:"fixed",edgeColorExpression:"x",faceColorExpression:"x",faceColorPolarExpression:"r",allColors:ji.map(e=>typeof e=="string"?{type:"color",value:e}:e),activeCenterId:null,isDrawingMode:!1,previewLineStartVertexId:null,frozenReference_A_rad:null,frozenReference_A_baseRad:null,frozenReference_D_du:null,frozenReference_Origin_Data:null,frozenReference_D_g2g:null,deletedFaceIds:[]}}function jo(){if(!Ae.length)return;const e=Ae[Zt];e&&(e.state=_r())}function Ar(e,t=""){return{id:zt(),name:t,state:JSON.parse(JSON.stringify(e))}}function _r(){const e=qo();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function bc(){if(!window.localStorage)return;const e=xc(),t={version:Ai,savedAt:Date.now(),state:_r()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}if(Ae.length>0){jo();const n=Sc(),s={version:Ai,savedAt:Date.now(),activeSessionIndex:Zt,sessions:Ae.map(i=>({...i,state:JSON.parse(JSON.stringify(i.state))}))};try{localStorage.setItem(n,JSON.stringify(s))}catch(i){console.warn("Could not persist sessions to localStorage.",i)}}}function qt(){window.localStorage&&(ii&&clearTimeout(ii),ii=setTimeout(()=>{ii=null,bc()},300))}function Su(){if(!window.localStorage)return!1;const e=xc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(Ko(n.state),Kt(),oc=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function Iu(){if(!window.localStorage)return!1;const e=Sc();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!Array.isArray(n.sessions)||n.sessions.length===0?!1:(Ae=n.sessions.map(s=>({id:s.id||zt(),name:s.name||"",state:s.state||Ic()})),Zt=Math.min(Math.max(n.activeSessionIndex||0,0),Ae.length-1),wt=Zt,It=[],as=[],Ko(Ae[Zt].state),Kt(),oc=!0,!0)}catch(t){return console.warn("Could not load sessions from localStorage.",t),!1}}function bu(){const e=_r();Ae=[Ar(e,"World 1")],Zt=0,wt=0}function Xs(e){e<0||e>=Ae.length||(jo(),Zt=e,wt=e,It=[],as=[],Ko(Ae[Zt].state),Kt(),St&&ia(),qt())}function vu(){jo();const e=Ar(Ic(),`World ${Ae.length+1}`),t=wt!==null?wt+1:Ae.length;Ae.splice(t,0,e),Xs(t)}function Mu(){if(!_o||!_o.state)return;jo();const e=Ar(_o.state,`World ${Ae.length+1}`),t=wt!==null?wt+1:Ae.length;Ae.splice(t,0,e),Xs(t)}function vc(e){if(e<0||e>=Ae.length||(jo(),Ae.length===1))return;const t=e<Ae.length-1?e:e-1,[n]=Ae.splice(e,1);Bi.push({session:n,index:e}),Zt===e?Xs(Math.max(0,Math.min(t,Ae.length-1))):(Zt>e&&(Zt-=1),wt>e&&(wt-=1),St&&ia(),qt())}function Eu(){if(!Bi.length)return!1;const{session:e,index:t}=Bi.pop(),n=Math.max(0,Math.min(t,Ae.length));return Ae.splice(n,0,e),Xs(n),!0}function Cu(){if(!Ae.length)return;const e=(wt+1)%Ae.length;Xs(e)}function Tu(){if(!Ae.length)return;const e=(wt-1+Ae.length)%Ae.length;Xs(e)}function Hi(){Z.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=Z.map(t=>{const n=t.vertexIds.map(s=>q(s));return n.some(s=>!s)?null:{face:t,vertices:n,area:Math.abs(Zi(n))}}).filter(Boolean);e.forEach(t=>{let n=null,s=1/0;e.forEach(i=>{if(t.face.id===i.face.id||i.area<=t.area)return;const o=t.face.vertexIds,a=o.map(c=>q(c));if(a.some(c=>!c))return;if(kh(a,i.vertices)){const c=new Set(o),l=K.filter(h=>c.has(h.id1)&&c.has(h.id2));!Rh(l,i.vertices,q)&&i.area<s&&(s=i.area,n=i.face)}}),n&&(t.face.parentFaceId=n.id)}),Z.forEach(t=>{if(t.parentFaceId){const n=Z.find(s=>s.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function Pe(e){const t=e.x*Fe,n=e.y*Fe,s=ge.height;return{x:(t-se.offsetX)/se.scale,y:(s-n-se.offsetY)/se.scale}}function xe(e){const t=ge.height,n=e.x*se.scale+se.offsetX,s=t-(e.y*se.scale+se.offsetY);return{x:n/Fe,y:s/Fe}}function q(e){return re.find(t=>t.id===e)}function Fs(e){if(!q(e))return[];const t=new Set,n=[e],s=[];for(t.add(e);n.length>0;){const i=n.shift();s.push(i),yn(i,K).forEach(o=>{t.has(o)||(t.add(o),n.push(o))})}return s}function go(e){const t=Pe(e),n=Ve*2/se.scale,s=(Ki+Ve)/se.scale;for(let i=re.length-1;i>=0;i--){const o=re[i];if(o.type!=="regular"&&Q(t,o)<s)return o}for(let i=re.length-1;i>=0;i--){const o=re[i];if(o.type==="regular"&&Q(t,o)<n)return o}return null}function po(e){const t=Pe(e),n=tr/se.scale;for(let s=K.length-1;s>=0;s--){const i=K[s],o=q(i.id1),a=q(i.id2);if(o&&a&&o.type==="regular"&&a.type==="regular"){const r=Tt(t,o,a);if(r.distance<n&&r.onSegmentStrict)return i}}return null}function yo(e){const t=Pe(e),n=[];for(const o of Z){if(o.color==="transparent")continue;const a=o.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular");a.length<3||ws(t,a)&&n.push(o)}if(n.length===0)return null;let s=null,i=1/0;for(const o of n){let a=!1;if(o.childFaceIds&&o.childFaceIds.length>0)for(const r of o.childFaceIds){const c=Z.find(l=>l.id===r);if(c&&c.color==="transparent"){const l=c.vertexIds.map(d=>q(d)).filter(Boolean);if(l.length>=3&&ws(t,l)){a=!0;break}}}if(!a){const r=o.vertexIds.map(c=>q(c));if(r.every(Boolean)){const c=Math.abs(Zi(r));c<i&&(i=c,s=o)}}}return s}function Ua(e){return K.filter(t=>t.id1===e||t.id2===e)}function wu(){ue.length===0&&he.length===0&&_e.length===0||(He(),Mc(),Uo())}function Mc(){const e=new Set(ue);Je&&e.add(Je);const t=[];ae.length>0&&ae.forEach(o=>{const a=Z.find(r=>ce(r)===o);a&&(t.push(a),a.vertexIds.forEach(r=>e.add(r)))}),he.forEach(o=>{const[a,r]=o.split(ao);e.add(a),e.add(r)}),Nt.vertices=Array.from(e).map(o=>{const a=q(o);return a?{...a}:null}).filter(o=>o),Nt.edges=[],K.forEach(o=>{e.has(o.id1)&&e.has(o.id2)&&Nt.edges.push({...o})}),Nt.faces=t.map(o=>JSON.parse(JSON.stringify(o)));const n=new Set(Ie),s=new Set(ae),i=new Set(he);Nt.texts=$e.filter(o=>{if(n.has(o.id))return!0;if(o.anchorType==="vertex")return e.has(o.anchorId);if(o.anchorType==="edge"){if(i.has(o.anchorId))return!0;const a=K.find(r=>ne(r)===o.anchorId);return a?e.has(a.id1)&&e.has(a.id2):!1}if(o.anchorType==="face"){if(s.has(o.anchorId))return!0;const a=Z.find(r=>ce(r)===o.anchorId);return a?a.vertexIds.every(r=>e.has(r)):!1}return!1}).map(o=>JSON.parse(JSON.stringify(o))),Nt.referenceVertex=Pe(j)}function Pu(){if(Nt.vertices.length===0||!Nt.referenceVertex)return;He();const e=Pe(j),t=e.x-Nt.referenceVertex.x,n=e.y-Nt.referenceVertex.y,s=new Map,i=[];let o=null;fs(),Nt.vertices.forEach(c=>{const l=zt(),d={...c,id:l,x:c.x+t,y:c.y+n};re.push(d),s.set(c.id,l),d.type==="regular"?i.push(l):o=l}),Nt.edges.forEach(c=>{const l=s.get(c.id1),d=s.get(c.id2);l&&d&&K.push({...c,id1:l,id2:d})});const a=[];Nt.faces.forEach(c=>{const l=c.vertexIds.map(d=>s.get(d)).filter(Boolean);if(l.length===c.vertexIds.length){const d={...c,id:ce({vertexIds:l}),vertexIds:l};d.localCoordSystem&&(d.localCoordSystem.origin.x+=t,d.localCoordSystem.origin.y+=n,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=s.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=s.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=s.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=s.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=s.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=s.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=s.get(d.localCoordSystem.scaleAttachedToEdge.v2))),d.parentFaceId=null,d.childFaceIds=[],Z.push(d),a.push(d.id)}}),Vs();const r=[];Nt.texts.forEach(c=>{const l=JSON.parse(JSON.stringify(c));if(l.id=zt(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const d=s.get(l.anchorId);if(!d)return;l.anchorId=d}else if(l.anchorType==="edge"){const d=K.find(u=>ne(u)===l.anchorId);if(!d)return;const h=s.get(d.id1),f=s.get(d.id2);if(!h||!f)return;l.anchorId=ne({id1:h,id2:f})}else if(l.anchorType==="face"){const d=Z.find(f=>ce(f)===l.anchorId);if(!d)return;const h=d.vertexIds.map(f=>s.get(f));if(!h.every(Boolean))return;l.anchorId=ce({vertexIds:h})}$e.push(l),r.push(l.id)}),ue=i,he=Nt.edges.map(c=>ne({id1:s.get(c.id1),id2:s.get(c.id2)})),ae=a,Ie=r,Je=o,Kt()}function Uo(){const e=new Set(ue),t=new Set(_e),n=new Set(he),s=new Set(ae),i=new Set(Ie);if(e.size===0&&t.size===0&&n.size===0&&s.size===0&&i.size===0)return;if(He(),s.size>0){const l=new Set;Z.forEach(d=>{const h=d.id||ce(d);s.has(h)&&(no.add(h),d.childFaceIds&&d.childFaceIds.length>0&&d.childFaceIds.forEach(f=>{const u=Z.find(p=>p.id===f);u&&(u.parentFaceId=null)}),d.parentFaceId?d.color="transparent":l.add(h))}),l.size>0&&(Z=Z.filter(d=>!l.has(d.id||ce(d))))}const o=[...K];if(n.size>0&&(K=K.filter(l=>!n.has(ne(l)))),e.size>0){const l=JSON.parse(JSON.stringify(K)),d=[],h=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1,f=new Set(e);for(;f.size>0;){const u=f.values().next().value,p=new Set,g=[u];for(;g.length>0;){const S=g.shift();f.has(S)&&(p.add(S),f.delete(S),yn(S,K).forEach(b=>{f.has(b)&&g.push(b)}))}const y=K.filter(S=>p.has(S.id1)&&!p.has(S.id2)||p.has(S.id2)&&!p.has(S.id1)),m=new Set;y.forEach(S=>{p.has(S.id1)||m.add(S.id1),p.has(S.id2)||m.add(S.id2)});const x=Array.from(m);if(x.length===2){const[S,I]=x,b=q(S),v=q(I),E=K.some(C=>C.id1===S&&C.id2===I||C.id1===I&&C.id2===S);if(b&&v&&!E){const C=As(b,v,h,Le);jn(C,Wt),Ns(C),d.push(C)}}}re=re.filter(u=>!e.has(u.id)),K=K.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),d.length>0&&(K.push(...d),Bs(l,K),Vs())}Bs(o,K),t.size>0&&(re=re.filter(l=>!t.has(l.id))),i.size>0&&($e=$e.filter(l=>!i.has(l.id)));const a=new Set(re.map(l=>l.id)),r=new Set(K.map(l=>ne(l))),c=new Set(Z.map(l=>ce(l)));$e=$e.filter(l=>l.anchorType==="vertex"?a.has(l.anchorId):l.anchorType==="edge"?r.has(l.anchorId):l.anchorType==="face"?c.has(l.anchorId):!0),Ie=Ie.filter(l=>$e.some(d=>d.id===l)),fs(),Kt()}function zi(e,t){let n=se.scale*t;n<zr&&(n=zr),n>Wr&&(n=Wr);const s=n/se.scale,i=e.x*Fe,o=e.y*Fe;se.offsetX=i*(1-s)+se.offsetX*s,se.offsetY=(ge.height-o)*(1-s)+se.offsetY*s,se.scale=n}function Au(e){se.offsetX+=e.x*Fe,se.offsetY-=e.y*Fe}function Dr(e){let t=0,n,s=Math.PI/2,i=!0;const o=q(e);if(!o)return i=!0,dt!=="none"&&U.interval1?n=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1:n=Oa,mt!==null&&(n=mt),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=pc(o.id);return a?(i=!1,t=a.angleRad,n=mt!==null?mt:a.length,Vt!==null?Math.abs(Vt)<le?s=ga:s=Math.abs(Vt):s=ga):(i=!0,dt!=="none"&&U.interval1?n=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1:n=Oa,mt!==null&&(n=mt),t=0,s=ga),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:s,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:Vt,displayAngleA_originVertexData_for_A_equals_label:Wn,frozen_A_baseRad_to_display:ds,frozen_D_du_to_display:mt,frozen_D_g2g_to_display:hs}}function Tl(e,t,n){if(!e||!t)return null;const s=Math.atan2(t.y-e.y,t.x-e.x),i=Q(e,t);let o=0,a=!0;for(let c=n.length-1;c>=0;c--){const l=n[c];let d=null;if(l.id1===e.id&&q(l.id2)?.type==="regular"?d=l.id2:l.id2===e.id&&q(l.id1)?.type==="regular"&&(d=l.id1),d&&d!==t.id){const h=q(d);if(h){o=Math.atan2(e.y-h.y,e.x-h.x),a=!1;break}}}const r=ct(s-o);return{startVertex:e,endVertex:t,absoluteAngleRad:s,length:i,precedingSegmentAbsoluteAngleRad:o,turnAngleRad:r,isFirstSegmentOfLine:a}}function Ec(e,t){const n=new Set,s=[e],i=new Set([e]);for(;s.length>0;){const o=s.shift(),a=t.find(r=>r.id===o);a&&(a.vertexIds.forEach(r=>n.add(r)),a.childFaceIds&&a.childFaceIds.forEach(r=>{i.has(r)||(i.add(r),s.push(r))}))}return Array.from(n)}function _u(){const e=ue.filter(i=>{const o=q(i);return o&&o.type==="regular"});if(e.length<2)return;He();const t=JSON.parse(JSON.stringify(K));let n=!1;const s=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;for(let i=0;i<e.length;i++)for(let o=i+1;o<e.length;o++){const a=e[i],r=e[o];if(!K.some(l=>l.id1===a&&l.id2===r||l.id1===r&&l.id2===a)){const l=q(a),d=q(r);if(l&&d){const h=As(l,d,s,Le);jn(h,Wt),Ns(h),K.push(h),n=!0}}}n&&Kn&&(Bs(t,K),Z.forEach(i=>{i.colorMode=i.colorMode||Ht,zo(i,i.colorMode)}),Vs()),Kt()}function Rt(e=[],t=[],n=[],s,i,o=!1,a=[]){if(o)Tr(e[0],s,i);else{let r=new Set(me.selection.vertices),c=new Set(me.selection.edges),l=new Set(me.selection.faces),d=new Set(me.selection.text);s?(e.forEach(h=>r.add(h)),t.forEach(h=>c.add(h)),n.forEach(h=>l.add(h)),a.forEach(h=>d.add(h))):i?(e.forEach(h=>{r.has(h)?r.delete(h):r.add(h)}),t.forEach(h=>{c.has(h)?c.delete(h):c.add(h)}),n.forEach(h=>{l.has(h)?l.delete(h):l.add(h)}),a.forEach(h=>{d.has(h)?d.delete(h):d.add(h)})):(r=new Set(e),c=new Set(t),l=new Set(n),d=new Set(a)),me.selection.vertices=r,me.selection.edges=c,me.selection.faces=l,me.selection.text=d,ue=Array.from(r),he=Array.from(c),ae=Array.from(l),Ie=Array.from(d)}kr(),ac()}function Du(e,t,n,s,i=0){const o={x:n.x-e.x,y:n.y-e.y},a={x:t.x-e.x,y:t.y-e.y},r=Math.hypot(o.x,o.y),c=Math.hypot(a.x,a.y),l=Math.atan2(o.y,o.x),d=Math.atan2(a.y,a.x);let h=0,f=1,u=!1;if(s===un)f=1,h=fl(l,d,i);else if(s===Un)h=0,r>le&&(f=c/r);else if(s===In)h=fl(l,d,i),r>le&&(f=c/r);else if(s===us&&(u=!0,h=0,r>le)){const p={x:o.x/r,y:o.y/r};f=(a.x*p.x+a.y*p.y)/r}return{rotation:h,scale:f,directionalScale:u}}function Bs(e,t){if(!Kn){Z=[],no.clear();return}const n=new Set(e.map(g=>ne(g))),s=new Set(t.map(g=>ne(g))),i=t.filter(g=>!n.has(ne(g))),o=e.filter(g=>!s.has(ne(g)));if(i.length===0&&o.length===0)return;const a=new Set;i.forEach(g=>{a.add(g.id1),a.add(g.id2)}),o.forEach(g=>{a.add(g.id1),a.add(g.id2)});const r=new Set,c=new Set;for(const g of a)c.has(g)||Fs(g).forEach(m=>{r.add(m),c.add(m)});const l=K.filter(g=>r.has(g.id1)&&r.has(g.id2)),d=Z.filter(g=>g.vertexIds.every(y=>r.has(y))),h=ea(l,q),f=new Set(d.map(g=>g.id));Z=Z.filter(g=>!f.has(g.id));let u=h;if(h.length>1){const g=h.map(y=>{const m=y.vertexIds.map(x=>q(x));return m.some(x=>!x)?null:{face:y,area:Math.abs(Zi(m))}}).filter(Boolean);if(g.length>1){g.sort((x,S)=>S.area-x.area);const y=g[0],m=g.slice(1).reduce((x,S)=>x+S.area,0);Math.abs(y.area-m)<le&&(u=g.slice(1).map(x=>x.face))}}const p=new Set(i.map(g=>ne(g)));u.forEach(g=>{let y=!1;if(i.length>0)for(let m=0;m<g.vertexIds.length;m++){const x=g.vertexIds[m],S=g.vertexIds[(m+1)%g.vertexIds.length],I=ne({id1:x,id2:S});if(p.has(I)){y=!0;break}}if(no.has(g.id))if(y)no.delete(g.id);else return;g.colorMode=g.colorMode||Ht,zo(g,g.colorMode),g.parentFaceId=null,g.childFaceIds=[],Z.push(g)}),Vs()}function Cc(e,t,n,s){const i=q(e.id1),o=q(e.id2);if(!i||!o)return null;const a=[...K],r={id:zt(),x:t.x,y:t.y,type:"regular",color:s(Ge)};re.push(r),K=K.filter(h=>ne(h)!==ne(e));const c=As(i,r,n,s),l=As(r,o,n,s),d=e?.colorMode||Wt;return jn(c,d),jn(l,d),Ns(c),Ns(l),K.push(c),K.push(l),Kn&&Bs(a,K),r}function ku(e,t,n,s,i){const o=We(n,e,s,i,!1,null),a={x:n.x-e.x,y:n.y-e.y},r=2*Ve/se.scale,c=t.filter(d=>d.type==="regular"),l=[];if(c.length>0){const d=re.filter(f=>f.type==="regular"&&!t.some(u=>u.id===f.id)),h=parseInt(Yt||"1",10)||1;for(let f=1;f<=h;f++)c.forEach(u=>{d.forEach(p=>{const g={x:u.x-e.x,y:u.y-e.y},y={x:p.x-e.x,y:p.y-e.y},m=Math.hypot(g.x,g.y),x=Math.hypot(y.x,y.y);if(m>le){const S=Math.pow(x/m,1/f);let I=Math.atan2(y.y,y.x)-Math.atan2(g.y,g.x);const v=(I+Math.round((s*f-I)/(2*Math.PI))*(2*Math.PI))/f,E=We(n,e,v,S,!1,a),C=Q(o,E);l.push({dist:C,rotation:v,scale:S,pos:E})}})})}if(l.length>0){const d=l.sort((h,f)=>h.dist-f.dist)[0];if(d.dist<r)return{...d,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}if(Te){const d=[],h=[],f=rr.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).sort((x,S)=>Math.abs(ct(s-x))-Math.abs(ct(s-S))),u=ss.filter(x=>x>0).sort((x,S)=>Math.abs(i-x)-Math.abs(i-S)),p=f.slice(0,2),g=u.slice(0,2);p.forEach(x=>{g.forEach(S=>{const I=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI),b=We(n,e,I,S,!1,a);d.push({dist:Q(o,b),rotation:I,scale:S,pos:b})})});const y=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;if(y){const x=cs(o,dt,y,Mn,!0),S=Math.hypot(a.x,a.y);x.forEach(I=>{if(S>le){const b={x:I.x-e.x,y:I.y-e.y},v=Math.hypot(b.x,b.y)/S,E=Math.atan2(b.y,b.x)-Math.atan2(a.y,a.x),C=E+Math.round((s-E)/(2*Math.PI))*(2*Math.PI);h.push({dist:Q(o,I),rotation:C,scale:v,pos:I})}})}const m=[...d,...h].sort((x,S)=>x.dist-S.dist)[0];return{...m,snapped:!0,snapType:"geometric",snappedScaleValue:m.scale}}return{rotation:s,scale:i,pos:o,snapped:!1}}function Ru(e,t,n,s,i){const o=parseInt(Yt||"1",10);let a=[];const r=Math.hypot(n.x-e.x,n.y-e.y),c=2*Ve/se.scale,l=t.filter(g=>g.type==="regular"),d=re.filter(g=>g.type==="regular"&&!t.some(y=>y.id===g.id));if(Array.from({length:o},(g,y)=>y+1).forEach(g=>{l.forEach(y=>{d.forEach(m=>{const x={x:y.x-e.x,y:y.y-e.y},S={x:m.x-e.x,y:m.y-e.y};if(Math.abs(Math.hypot(x.x,x.y)-Math.hypot(S.x,S.y))<le){let I=Math.atan2(S.y,S.x)-Math.atan2(x.y,x.x);const b=I+Math.round((s*g-I)/(2*Math.PI))*(2*Math.PI);a.push({rotation:b/g,priority:Math.abs(ct(b/g-s)),snapType:"merge"})}})})}),Te){rr.flatMap(x=>{const S=x*Math.PI/2;return S===0?[0]:[S,-S]}).forEach(x=>{const S=Math.abs(ct(s-x)),I=x+Math.round((s-x)/(2*Math.PI))*(2*Math.PI);a.push({rotation:I,priority:S,snapType:"geometric"})});const y=new Set(t.map(x=>x.id));let m=re.filter(x=>x.type==="regular"&&!y.has(x.id));if(U){const x=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;x&&m.push(...cs(i,dt,x,Mn,!0))}m.forEach(x=>{const S=Q(i,x);if(S<Qa/se.scale){const I=Math.atan2(n.y-e.y,n.x-e.x),b=Math.atan2(x.y-e.y,x.x-e.x),v=ct(b-I),E=v+Math.round((s-v)/(2*Math.PI))*(2*Math.PI);a.push({rotation:E,priority:S/1e3,snapType:"projection",projectionSource:x})}})}if(a.length===0)return{rotation:s,snapped:!1,snapType:null};a.sort((g,y)=>g.priority-y.priority);const f=a[0];if(f.snapType==="merge"){const g=We(n,e,f.rotation,1,!1,null);if(Q(i,g)>c)return{rotation:s,snapped:!1,snapType:null}}const u=We(n,e,f.rotation,1,!1,null);let p=null;return f.snapType==="projection"&&(p={x:e.x+r*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation),y:e.y+r*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation)}),{rotation:f.rotation,pos:u,snapped:!0,snapType:f.snapType,projectionSource:f.projectionSource||null,projectionPoint:p}}function Lu(e,t,n,s){const i=Pe(j),o=2*Ve/se.scale,a=t.filter(c=>c.type==="regular"),r=[];if(a.length>0){const c=re.filter(h=>h.type==="regular"&&!t.some(f=>f.id===h.id)),l=o/100,d=parseInt(Yt||"1",10);for(let h=1;h<=d;h++)a.forEach(f=>{c.forEach(u=>{const p={x:f.x-e.x,y:f.y-e.y},g={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(p.x,p.y),m=Math.hypot(g.x,g.y);if(y>le){const x=Math.atan2(p.y,p.x),S=Math.atan2(g.y,g.y);if(Math.abs(ct(x-S))<l){const I=Math.pow(m/y,1/h),b=We(n,e,0,I,!1,null);r.push({scale:I,dist:Q(i,b)})}}})})}if(r.length>0){const c=r.sort((l,d)=>l.dist-d.dist)[0];if(c.dist<o){const l=We(n,e,0,c.scale,!1,null);return{...c,pos:l,snapped:!0,snapType:"merge"}}}if(Te){let c,l,d=1,h=1/0;ss.forEach(g=>{const y=Math.abs(s-g);y<h&&(h=y,d=g)});const f=We(n,e,0,d,!1,null);c={scale:d,pos:f,dist:Q(i,f),snapType:"geometric",snappedScaleValue:d};const u=new Set(t.map(g=>g.id)),p=re.filter(g=>g.type==="regular"&&!u.has(g.id));if(U){const g=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;g&&p.push(...cs(i,dt,g,Mn,!0))}if(p.length>0){const g=p.reduce((x,S)=>Q(i,x)<Q(i,S)?x:S),y=Math.hypot(n.x-e.x,n.y-e.y),m=Q(e,g);if(y>le){const x=m/y,S=Math.atan2(n.y-e.y,n.x-e.x),I={x:e.x+m*Math.cos(S),y:e.y+m*Math.sin(S)};l={scale:x,pos:I,dist:Q(i,I),snapType:"projection",snappedScaleValue:x,projectionSource:g}}}return l&&Q(i,l.projectionSource)<o?{...l,snapped:!0}:{...c,snapped:!0}}return{scale:s,snapped:!1,snapType:null}}function Ou(e,t,n,s,i,o){let a=[];const r=2*Ve/se.scale;if(t.filter(l=>l.type==="regular"),Te){let l=null,d=null,h=1,f=1/0;[...ss,...ss.map(m=>-m)].forEach(m=>{const x=Math.abs(s-m);x<f&&(f=x,h=m)});const p=We(n,e,0,h,!0,i);l={scale:h,pos:p,dist:Q(o,p),snapType:"geometric",snappedScaleValue:h};const g=new Set(t.map(m=>m.id)),y=re.filter(m=>m.type==="regular"&&!g.has(m.id));if(U){const m=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;m&&y.push(...cs(o,dt,m,Mn,!0))}if(y.length>0){const m=y.reduce((S,I)=>Q(o,I)<Q(o,S)?I:S),x=Math.hypot(i.x,i.y);if(x>le){const S={x:i.x/x,y:i.y/x},I=v=>(v.x-e.x)*S.x+(v.y-e.y)*S.y,b=I(n);if(Math.abs(b)>le){const E=I(m)/b,C=We(n,e,0,E,!0,i);d={scale:E,pos:C,dist:Q(o,C),snapType:"projection",snappedScaleValue:E,projectionSource:m}}}}d&&Q(o,d.projectionSource)<r?a.push({...d,priority:0}):a.push({...l,priority:1})}return a.length===0?{scale:s,snapped:!1,snapType:null}:{...a.sort((l,d)=>l.priority-d.priority)[0],snapped:!0}}function Nu(e){const t=ge.width/Fe,n=ge.height/Fe,{grid1Interval:s,grid2Interval:i,alpha1:o,alpha2:a}=Oh(se.scale);U={interval1:s,interval2:i,alpha1:o,alpha2:a,scale:se.scale},Mn=Nh(se,t,n,xe),jh(Ce,{gridDisplayMode:dt,canvas:ge,dpr:Fe,viewTransform:se,gridAlpha:Uf,colors:e},xe,Pe,U,Mn);let r={useScientific:!1};return Rs!==Ui&&(r=zh(Ce,lt,{canvas:ge,dpr:Fe,coordsDisplayMode:Rs,viewTransform:se,angleDisplayMode:Sn,colors:e},xe,Pe,U,Mn,At)),r}function Fu(e){const t=Oe&&de.length===1&&!ze&&de[0].type==="regular";if(Ya.forEach(n=>{Oe&&de.length>0&&[...n].some(i=>de.some(o=>o.id===i))||hu(n,e,!1,[],0)}),re.forEach(n=>{if(n.type!=="regular"){const s=Oe&&de.some(c=>c.id===n.id);let i=n,o=!1,a=s?0:void 0;if(s&&!t&&Se.length>0){const c=Se.find(l=>l&&l.originalId===n.id&&l.transformIndex===0);c&&(i=c)}if(Ct){const c=n.originalId||n.id;Ct.has(c)&&Ct.get(c).find(h=>h.copyIndex===a)&&(o=!0)}const r={selectedVertexIds:[],selectedCenterIds:_e,activeCenterId:Je,colors:e,verticesVisible:!0,isHovered:fn===n.id&&!bt,isSnapped:o,snappedVertexIds:Ct,isDragConfirmed:Oe,dragPreviewVertices:Se,currentAltPressed:bt};Ti(Ce,i,r,xe)}}),Oe){const s={copyCount:parseInt(Yt||"1",10),isDragConfirmed:Oe,initialDragVertexStates:de,dragPreviewVertices:Se,transformIndicatorData:ze,allEdges:K,allFaces:Z,findVertexById:q,findAllVerticesInSubgraph:i=>Fs(i),colors:e,edgeColorMode:Wt,faceColorMode:Ht,edgeColorExpression:is,faceColorExpression:Ms,faceColorPolarExpression:Es,snappedEdgesInfo:Ls,snappedVertexIds:Ct};t?Xh(Ce,s,xe):Vh(Ce,s,xe)}}function Bu(e,t){hf(lt,{coordsDisplayMode:Rs,isMouseOverCanvas:Bo,currentShiftPressed:Te,ghostVertexPosition:Be,gridDisplayMode:dt,lastGridState:U,angleDisplayMode:Sn,canvas:ge,dpr:Fe,mousePos:j,colors:e,useScientific:t.useScientific},Pe,At),iu();const n={dpr:Fe,canvasUI:z,isToolbarExpanded:ns,isColorPaletteExpanded:it,isColorModePanelExpanded:an,isInterpolationPanelExpanded:on,isTransformPanelExpanded:An,isDisplayPanelExpanded:mn,isVisibilityPanelExpanded:na,isSessionsPanelExpanded:St,isPlacingTransform:Qt,placingTransformType:fo,placingSnapPos:Ho,mousePos:j,allColors:pe,activeThemeName:$o,colors:e,verticesVisible:Di,edgesVisible:ki,facesVisible:Kn,coordsDisplayMode:Rs,gridDisplayMode:dt,angleDisplayMode:Sn,distanceDisplayMode:ci,namedColors:Qn.namedColors,colorAssignments:Ee,activeColorTargets:Xe,lastSelectedSwatchIndex:_t,interpolationStyles:hn,activeInterpolationStyleId:_s,sessions:Ae,activeSessionIndex:Zt,selectedSessionIndex:wt,edgeColorMode:Wt,faceColorMode:Ht,selectedEdgeModes:so(),selectedFaceModes:oo(),isDraggingColorTarget:to,draggedColorTargetInfo:Ot};n.selectedInterpolationStyleId=lc(),wf(Ce,lt,n,At)}function Tc(){Ir.clear();const e=br();Fh(Ce,{canvas:ge,dpr:Fe,colors:e});const t=Nu(e);Fu(e),Xl(Ce,{allFaces:Z,hoveredFaceId:Gt,selectedFaceIds:ae,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,currentAltPressed:bt},xe,q,ce),ae.length>0&&Jl(Ce,{allFaces:Z,selectedFaceIds:ae,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,initialDragVertexStates:de,transformIndicatorData:ze,highlightedEdgeForSnap:Fn,draggedFaceId:Go,coordSystemSnapAngle:ho,coordSystemSnapType:ks,coordSystemSnapScale:Ln,initialCoordSystemStates:Ds},xe,q),bg(e),du(e),Jh(Ce,{altHoverInfo:Qe,colors:e},xe,q,At),Bu(e,t),ru()}function wc(){if(!we||we.length<2)return;const e=Ee[Ge];if(e===-1)return;const t=pe[e];if(!t||t.type!=="colormap")return;const n=we.length;we.forEach((s,i)=>{const o=q(s);if(o&&o.type==="regular"){const a=n>1?i/(n-1):.5;o.color=De(t,a)}})}function Pc(){if(!we||we.length<2)return;const e=Ee[Ue];if(e===-1)return;const t=pe[e];if(!t||t.type!=="colormap")return;const s=we.length-1;for(let i=0;i<s;i++){const o=we[i],a=we[i+1],r=K.find(c=>c.id1===o&&c.id2===a||c.id1===a&&c.id2===o);if(r){const c=i/s,l=(i+1)/s;r.gradientStart=c,r.gradientEnd=l,r.colormapItem=t,delete r.colormapOffset,delete r.color}}}function $u(e,t,n){if(!it)return!1;const s=z.removeColorButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height){if(pe.length>1&&Xe.length>0){const o=Xe[Xe.length-1],a=Ee[o];a>=0&&(He(),ja(a))}else pe.length>1&&_t!==null&&_t>=0&&_t<pe.length&&(He(),ja(_t));return!0}const i=z.addColorButton;return i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height?(Oi=!1,Ao=null,Qn.show(),!0):!1}function kr(){const e=[];return ae.length>0&&e.push(ot),he.length>0&&e.push(Ue),ue.length>0&&e.push(Ge),Ie.length>0&&e.push(Ft),e.length>0?(Xe=e,_t=null,it&&vt(),!0):!1}function fs(){if(Ut&&clearTimeout(Ut),Yt="",Ut=null,rs&&(pe=ut.originalAllColors,Ee=ut.originalAssignments,vt(),It.length>0&&It.pop(),rs=!1,ut=null),Ke){Ke=!1,ht=null,Vt=null,ds=null,mt=null,hs=null,Wn=null,st=[],nn=0,we=[],_i=null;return}Qt&&(Qt=!1,fo=null,Ho=null),ue=[],he=[],ae=[],_e=[],Ie=[],Je=null,Xe=[],it&&vt(),Pn=null,Xt=!1,Oe=!1,vn=!1,Li=!1,vs=!1,Yn=!1,Se=[],de=[],Fi=null,jt=-1,fe={targetId:null,type:null,count:0,timestamp:0},ge.style.cursor="crosshair",ze=null,Os=[],Be=null,Fn=null,ho=null,Go=null,ks=null,Pn=null,Qe=null}function Vu(){if(!Ke||!ht||st.length===0)return;He();const e=q(ht);if(!e){fs();return}const t=pc(e.id);if(!t){fs();return}const n=t.angleRad;if(st.length===1)return;const s=st.length-1,i=(nn-1)%s+1,o=st[i],a=o.length;let r;if(i===st.length-1){const m=st.length>2?1:0;r=st[m].turn}else r=o.turn;let c,l;if(i===st.length-1){const m=[st[0].endVertexColor,st[1].endVertexColor],x=(nn-1)%m.length;l=m[x];const S=nn%m.length;c=m[S],e.color=l}else c=o.endVertexColor;const d=On(n+r),h=e.x+a*Math.cos(d),f=e.y+a*Math.sin(d);let u=null,p=!1;const g=Ve*2/se.scale;for(const m of re)if(m.type==="regular"&&Q({x:h,y:f},m)<g){u=m,p=!0;break}p||(u={id:zt(),x:h,y:f,type:"regular",color:c},re.push(u)),K.some(m=>m.id1===e.id&&m.id2===u.id||m.id2===e.id&&m.id1===u.id)||K.push({id1:e.id,id2:u.id,color:Le(Ue)}),Kn&&(Z=ea(K,q),Vs()),we.push(u.id),window.currentDrawingPath=we,wc(),Pc(),ht=u.id,nn++,nn>=st.length&&(nn=1),mt=null,hs=null,Vt=null,ds=null,Wn=null}function Ac(){Tc(),requestAnimationFrame(Ac)}function Xu(e){if(ae.length===0)return!1;const t=So(e,ge);for(const n of ae){const s=Z.find(o=>o.id===n);if(!s||!s.localCoordSystem)continue;const i=mh(t,s,xe);if(i)return qn=!0,En=i,Go=s.id,$i=Yu(s),i.type==="center"&&(s.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function Yu(e){const t=[],n=[],s=[],i=[],o=[];e.vertexIds.forEach(a=>{const r=q(a);r&&r.type==="regular"&&t.push({...r,id:a})});for(let a=0;a<t.length;a++){const r=t[a],c=t[(a+1)%t.length];n.push({x:(r.x+c.x)/2,y:(r.y+c.y)/2,v1:r.id,v2:c.id}),s.push(r.id,c.id),o.push(Math.atan2(c.y-r.y,c.x-r.x))}return Z.forEach(a=>{a.id!==e.id&&a.localCoordSystem&&i.push(a.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:s,faceCenters:i,edgeAngles:o}}function Ja(e,t){const n=e.vertexIds[t],s=e.vertexIds[(t+1)%e.vertexIds.length],i=q(n),o=q(s);return i&&o?{v1Id:n,v2Id:s,edgeAngle:Math.atan2(o.y-i.y,o.x-i.x)}:null}function Gu(e,t){if(e.length===0||t&&t.transformType===un||!t)return;const i=new Set;e.forEach(a=>{Ua(a).forEach(r=>i.add(r))});const o=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;i.forEach(a=>{const r=q(a.id1),c=q(a.id2);if(!r||!c)return;const l=r.x-c.x,d=r.y-c.y,h=l/o,f=d/o,u=1e-5;if(o&&Math.abs(h-Math.round(h))<u&&Math.abs(f-Math.round(f))<u){a.labelMode="exact";const g=Math.round(h),y=Math.round(f);a.exactValue={g2gSquaredSum:g*g+y*y,gridInterval:o}}else a.labelMode="decimal",delete a.exactValue})}function Hu(){if($t){He();let e=Z.find(t=>t.id===$t);if(e)e.color=Le(ot),Hi();else{const n=ea(K,q).find(s=>s.id===$t);n&&(n.color=Le(ot),Z.push(n),Hi(),Vs())}$t=null}xt.style.display="none"}function zu(e,t){const n=[],s=t.find(a=>a.id===e);if(!s)return[];const i=[...s.childFaceIds||[]],o=new Set(s.childFaceIds);for(;i.length>0;){const a=i.shift(),r=t.find(c=>c.id===a);r&&(n.push(r),r.childFaceIds&&r.childFaceIds.forEach(c=>{o.has(c)||(o.add(c),i.push(c))}))}return n}function Wu(e,t,n,s,i){if(!t.isCustom){const l=e.vertexIds.map(d=>s.find(h=>h.id===d)||i(d)).filter(d=>d&&d.type==="regular");if(l.length>=3){const d=Qi(l);d&&(e.localCoordSystem.origin=d.center,e.localCoordSystem.scale=d.radius)}return}let o={...t.origin},a=t.angle,r=t.scale;if(e.localCoordSystem.attachedToVertex){const l=s.find(d=>d.id===e.localCoordSystem.attachedToVertex);l&&(o={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.attachedToEdge.v1)||i(e.localCoordSystem.attachedToEdge.v1),d=s.find(h=>h.id===e.localCoordSystem.attachedToEdge.v2)||i(e.localCoordSystem.attachedToEdge.v2);l&&d&&(o={x:l.x+e.localCoordSystem.attachedToEdge.t*(d.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(d.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v1)||i(e.localCoordSystem.rotationAlignedToEdge.v1),d=s.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v2)||i(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&d){const h=Math.atan2(d.y-l.y,d.x-l.x),f=e.localCoordSystem.rotationAlignedToEdge.originalAngle,p=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-f;a=On(h+p),e.localCoordSystem.rotationAlignedToEdge.originalAngle=h,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(e.localCoordSystem.scaleAttachedToEdge){const l=s.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v1)||i(e.localCoordSystem.scaleAttachedToEdge.v1),d=s.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v2)||i(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&d){const h=Q(l,d);r=h*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=h}}const c=e.vertexIds.map(l=>s.find(d=>d.id===l)||i(l)).filter(l=>l&&l.type==="regular");c.length>=3&&(e.localCoordSystem.origin=co(o,c),e.localCoordSystem.angle=a,e.localCoordSystem.scale=Math.max(.01,r),e.localCoordSystem.isCustom=!0)}function Ku(e,t){const n=new Map;return e.forEach(s=>{const i=[...new Set(s.vertexIds.map(o=>t(o)))];if(i.length>=3){const o=ce({vertexIds:i});if(s.localCoordSystem&&s.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(s.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=t(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=t(a.attachedToEdge.v1),a.attachedToEdge.v2=t(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=t(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=t(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=t(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=t(a.scaleAttachedToEdge.v2)),n.set(o,a)}}}),n}function qu(e){xt.innerHTML="",xt.style.display="none",j=So(e,ge);const t=go(j),n=t?null:po(j),s=!t&&!n?yo(j):null;if(t||n||s){let d=!1;t?d=ue.includes(t.id):n?d=he.includes(ne(n)):s&&(d=ae.includes(ce(s))),d||(ue=[],he=[],ae=[],_e=[],Ie=[],t?ue=[t.id]:n?he=[ne(n)]:s&&(ae=[ce(s)]))}else fs();const o=Pe(j);let a=[];$t=null,Js=null,Us=null;const r=(ue.length>0?1:0)+(he.length>0?1:0)+(ae.length>0?1:0),c=go(j),l=c?null:po(j);if(c&&c.type==="regular"){Us=c.id;const d=r>1?"Remove Geometry":"Remove Vertex";a.push({text:d,handler:ag})}else if(l){Js=ne(l);const d=r>1?"Remove Geometry":"Remove Edge";a.push({text:d,handler:rg})}else{const d=yo(j);if(d){$t=ce(d);const h=r>1?"Remove Geometry":"Remove Face";a.push({text:h,handler:lg}),d.childFaceIds&&d.childFaceIds.length>0&&a.push({text:"Remove Face and Children",handler:ig})}else{const h=ea(K,q);let f=null,u=1/0;h.forEach(p=>{const g=p.vertexIds.map(y=>q(y));if(g.every(Boolean)&&ws(o,g)){const y=Math.abs(Zi(g));y<u&&(u=y,f=p)}}),f&&($t=f.id||ce(f),a.push({text:"Add Face",handler:Hu}))}}if(a.length>0){const d=document.createElement("ul");a.forEach(h=>{const f=document.createElement("li");f.textContent=h.text,f.addEventListener("click",h.handler),d.appendChild(f)}),xt.appendChild(d),xt.style.left=`${e.clientX-Hr}px`,xt.style.top=`${e.clientY-Hr}px`,xt.style.display="block"}}function ju(e){if(mn){for(const t of z.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[Ui,lr,ko,Ji];Rs=n[(n.indexOf(Rs)+1)%n.length];break;case"grid":const s=[cr,dr,hr,fr,Xo];dt=s[(s.indexOf(dt)+1)%s.length];break;case"angles":const i=[Ts,Yo,Ro];Sn=i[(i.indexOf(Sn)+1)%i.length],Zn=Sn!==Ro;break;case"distances":const o=[Lo,sh];ci=o[(o.indexOf(ci)+1)%o.length],Dn=ci===Lo;break;case"theme":tg();break}return!0}}return!1}function Uu(e){if(!on)return!1;for(const t of z.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationRemove"){const n=he.length>0||ae.length>0||ue.length>0;n&&cu();const s=lc()||_s;return s&&s!==bn.id?(hn=hn.filter(i=>i.id!==s),_s===s&&yi(bn.id),wr(),qt()):n||yi(bn.id),!0}if(t.type==="interpolationAdd")return js?.initialize?.(),js?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(ai.id===t.styleId&&n-ai.timestamp<Si){const i=Xi(t.styleId);return i&&(js?.initialize?.(),js?.show(i)),ai={id:null,timestamp:0},!0}return ai={id:t.styleId,timestamp:n},(he.length>0||ae.length>0||ue.length>0)&&lu(t.styleId),yi(t.styleId),!0}}return!1}function Ju(e){if(!an)return!1;for(const t of z.colorModeIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.group==="edge"){const n=sa();n.length>0?(nu(t.mode,n),Bn=t.mode):(Wt=t.mode,za())}else if(t.group==="face"){const n=oa();n.length>0?(su(t.mode,n),$n=t.mode):(Ht=t.mode,za())}return vt(),Gi(),qt(),!0}return!1}function Zu(e,t=!1,n=!1){const s=z.toolbarButton;if(e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return ns=!ns,ns?gc():(it=!1,an=!1,on=!1,An=!1,mn=!1,na=!1,St=!1,Xe=[]),!0;if(ns){const i=z.colorToolButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return og(),!0;const o=z.colorModeToolButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return an=!an,an&&Gi(),!0;const a=z.interpolationToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return on=!on,on&&wr(),!0;const r=z.transformToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return An=!An,An&&yu(),!0;const c=z.visibilityToolButton;if(c&&e.x>=c.x&&e.x<=c.x+c.width&&e.y>=c.y&&e.y<=c.y+c.height)return mn=!mn,mn&&pu(),!0;const l=z.sessionsToolButton;if(l&&e.x>=l.x&&e.x<=l.x+l.width&&e.y>=l.y&&e.y<=l.y+l.height)return St=!St,St&&(wt=Zt,ia()),!0}if(it&&$u(e)||an&&Ju(e)||on&&Uu(e))return!0;if(An){for(const i of z.transformIcons)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return Qt?fo=i.type:(Qt=!0,fo=i.type,ge.style.cursor="none"),!0}if(mn&&ju(e))return!0;if(St&&z.sessionsPanelBounds){const i=z.sessionsPanelBounds;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return Cu(),!0}return!!Pr(e)}function Qu(){if(It.length===0)return;const e=qo();pe.length,pe[0]?.value,re.length,as.push(e),as.length>ar&&as.shift();const t=It.pop();Ko(t),pe.length,pe[0]?.value,re.length,Kt()}function eg(){if(as.length===0)return;const e=qo();It.push(e),It.length>ar&&It.shift();const t=as.pop();Ko(t),Kt()}function Rr(e,t){const n=Pe(e),s=go(e),i=s?null:po(e),o=!s&&!i?yo(e):null;if(s)Qe={point:{x:s.x,y:s.y},element:{type:"vertex",id:s.id},shiftKey:t};else if(i){const a=q(i.id1),r=q(i.id2);if(a&&r){let c,l;const d=Tt(n,a,r);if(t){const h=Ch(d,a,r);c=h.point,l=h.fraction}else c={x:d.x,y:d.y},l=d.t;Qe={point:c,element:{type:"edge",edge:i},shiftKey:t,fraction:l}}}else o?Qe={point:n,element:{type:"face",id:ce(o)},shiftKey:t}:Qe=null;fn=null,Jt=null,Gt=null}function tg(){He(),$o=$o==="dark"?"light":"dark",uu(),it&&vt()}function ng(e){if(!qn||!En)return!1;const t=So(e,ge),n=Pe(t),s=En,i=s.face,o=i.localCoordSystem,a=i.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular"&&r.x!==void 0&&r.y!==void 0);if(s.type==="center"){let r,c={snapped:!1};if(e.shiftKey){if(c=bh(n,$i,dt,U,Mn),c.snapped){if(r=c.snapPoint,c.snapType==="edge"){const l=c.edgeInfo,d=q(l.v1),h=q(l.v2);d&&h&&(r=c.snapPoint,Pn=null)}}else{const l=Qi(a);r=l?l.center:a[0]}s.type==="center"&&(Be=r)}else r=n,Be=null,Pn=null;a.length>0&&a.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(r=co(r,a),Be&&(Be=co(Be,a))),o.origin.x=r.x,o.origin.y=r.y,o.isCustom=!0,c.snapped?(o.attachedToVertex=c.vertexId||null,o.attachedToEdge=c.edgeInfo||null):(o.attachedToVertex=null,o.attachedToEdge=null)}else if(s.type==="x_axis"||s.type==="y_axis"){const r={x:n.x-o.origin.x,y:n.y-o.origin.y};let c=Math.atan2(r.y,r.x),l=Math.hypot(r.x,r.y);if(Fn=null,ho=null,ks=null,Os=[],Be=null,Pn=null,Ln=null,e.shiftKey){const d=Sh(n,o.origin,!0,$i);if(d.snapped){c=d.angle,ho=c,ks=d.snapType;const h={x:Math.cos(c),y:Math.sin(c)},f={x:n.x-o.origin.x,y:n.y-o.origin.y},u=f.x*h.x+f.y*h.y;if(d.snapType==="vertex_direction"){const p=q(d.targetVertexId);p&&(l=Q(o.origin,p),Ln=l)}else if(d.edgeIndex!==null){Fn=d.edgeIndex;const p=Ja(i,d.edgeIndex);if(p){const g=Math.abs(ct(c-p.edgeAngle))>Math.PI/4&&Math.abs(ct(c-p.edgeAngle))<3*Math.PI/4;if(s.type==="x_axis"&&g){const y=q(p.v1Id),m=q(p.v2Id);if(y&&m){const x=Fl(o.origin,y,m),S=x.distance,I=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};I.forEach(E=>{const C=S*E,_=Math.abs(u-C);_<b.dist&&(b={scale:C,dist:_,fraction:E})});const v=15/se.scale;b.dist<v?(l=b.scale,Ln=l,Pn={orthogonalDistanceFraction:b.fraction,v1:y,v2:m,snapPosition:{origin:o.origin,closest:x}}):(l=u>0?u:0,Ln=l)}}else{const y=Ih(o.origin,s.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:p},i,q,u,se,s.type);if(y.snapped){if(l=y.scale,Ln=l,y.edgeFraction!==null){const m={x:o.origin.x+l*Math.cos((s.type==="y_axis",c)),y:o.origin.y+l*Math.sin((s.type==="y_axis",c))};Pn={edgeFraction:y.edgeFraction,v1:q(p.v1Id),v2:q(p.v2Id),snapPosition:m}}}else l=u>0?u:0}}}}else l=Math.hypot(r.x,r.y)}s.type==="y_axis"?o.angle=c-Math.PI/2:o.angle=c,l>.01&&(o.scale=l),o.isCustom=!0}return!0}function sg(){if(qn){const e=En,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const s=hd;let i=null,o=null,a=1/0,r={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(c=>{const l=q(c);if(l&&l.type==="regular"){const d=Q(n.origin,l);d<a&&(a=d,d<s&&(i=c))}}),!i){for(let c=0;c<t.vertexIds.length;c++){const l=q(t.vertexIds[c]),d=q(t.vertexIds[(c+1)%t.vertexIds.length]);if(l&&d&&l.type==="regular"&&d.type==="regular"){const h=Tt(n.origin,l,d);h.distance<r.dist&&(r={dist:h.distance,t:h.t,v1:l.id,v2:d.id})}}if(r.dist<s){const c=Q(q(r.v1),q(r.v2));c>le&&(o={v1:r.v1,v2:r.v2,t:r.t,originalLength:c,scaleRatio:n.scale/c})}}n.attachedToVertex=i,n.attachedToEdge=o}if(e.type==="x_axis"||e.type==="y_axis"){let s=!1,i=!1;if(ks==="edge"&&Fn!==null){const o=Ja(t,Fn);o&&(n.rotationAlignedToEdge={v1:o.v1Id,v2:o.v2Id,originalAngle:o.edgeAngle,originalSystemAngle:n.angle},s=!0)}if(Ln!==null&&n.rotationAlignedToEdge){const o=Ja(t,Fn);if(o){const a=q(o.v1Id),r=q(o.v2Id);if(a&&r){const c=Q(a,r);c>le&&(n.scaleAttachedToEdge={v1:o.v1Id,v2:o.v2Id,scaleRatio:n.scale/c,originalLength:c},i=!0)}}}s||(n.rotationAlignedToEdge=null),i||(n.scaleAttachedToEdge=null)}return Ln=null,Pn=null,qn=!1,En=null,$i=null,Fn=null,ho=null,ks=null,Go=null,Be=null,Os=[],!0}return!1}function og(){it=!it,it&&vt()}function ig(){if($t){He();const e=Z.find(t=>t.id===$t);if(e){const t=zu(e.id,Z),n=new Set(t.map(o=>o.id)),s=new Set;t.forEach(o=>{o.vertexIds.forEach(a=>s.add(a))}),re=re.filter(o=>!s.has(o.id)),K=K.filter(o=>!s.has(o.id1)&&!s.has(o.id2));const i=new Set([e.id,...n]);Z=Z.filter(o=>!i.has(o.id)),fs()}$t=null}xt.style.display="none"}function ag(){Us&&(He(),ue.includes(Us)||(he=[],ae=[],_e=[],Ie=[],ue=[Us]),Uo(),Us=null),xt.style.display="none"}function rg(){Js&&(He(),he.includes(Js)||(ue=[],ae=[],_e=[],Ie=[],he=[Js]),Uo(),Js=null),xt.style.display="none"}function lg(){$t&&(He(),ae.includes($t)||(ue=[],he=[],_e=[],Ie=[],ae=[$t]),Uo(),$t=null),xt.style.display="none"}function cg(e){const t=Nl(j,z,{isToolbarExpanded:ns,isColorPaletteExpanded:it,isColorModePanelExpanded:an,isInterpolationPanelExpanded:on,isTransformPanelExpanded:An,isDisplayPanelExpanded:mn,isVisibilityPanelExpanded:na,isSessionsPanelExpanded:St});if(Qt&&(!t||t.type!=="transformIcon")){He();const h=Pe(j),f=Te?mi(h):h,u={id:zt(),x:f.x,y:f.y,type:fo};re.push(u),_e=[u.id],Je=u.id,ue=[],he=[],ae=[],Ie=[],Qt=!1,fo=null,Ho=null,ge.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!Ke){Rr(j,e.shiftKey);const h=Qe&&Qe.element.type==="vertex"?q(Qe.element.id):null,f=Qe&&Qe.element.type==="edge"?Qe.element.edge:null,u=Qe&&Qe.element.type==="face"?Z.find(p=>ce(p)===Qe.element.id):null;if(h||f||u){He(),ue=[],he=[],ae=[],_e=[],Ie=[],Je=null,Xe=[],it&&vt();const p=U?.alpha2>=U?.alpha1&&U?.interval2?U.interval2:U?.interval1;if(h&&h.type==="regular")Ke=!0,ht=h.id,st=[],nn=0,we=[h.id],window.currentDrawingPath=we;else if(f&&Qe){const g=Qe.point,y=Cc(f,g,p,Le);y&&(Ke=!0,ht=y.id,st=[],nn=0,we=[y.id],window.currentDrawingPath=we,Kt())}else if(u&&Qe){const g=Qe.point;let y=Le(Ge);const m=Ee[Ge];if(m!==-1){const S=pe[m];S&&S.type==="colormap"&&(y=De(S,0))}const x={id:zt(),...g,type:"regular",color:y};re.push(x),Ke=!0,ht=x.id,st=[],nn=0,we=[x.id],window.currentDrawingPath=we,Kt()}Xt=!1,e.preventDefault();return}}if(Xt=!0,Oe=!1,Yn=!1,it){const h=(z.colorTargetIcons||[]).filter(f=>j.x>=f.x&&j.x<=f.x+f.width&&j.y>=f.y&&j.y<=f.y+f.height);if(h.length>0){const f=h[h.length-1],{element:u,shiftKey:p,ctrlKey:g}={element:f,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};p?Xe.includes(u.target)||Xe.push(u.target):g?Xe.includes(u.target)?Xe=Xe.filter(y=>y!==u.target):Xe.push(u.target):Xe=[u.target],vt(),te={target:"ui_icon_click",element:{...f,type:"colorTargetIcon"}},ge.style.cursor="default";return}for(const f of z.colorSwatches)if(j.x>=f.x&&j.x<=f.x+f.width&&j.y>=f.y&&j.y<=f.y+f.height){te={target:"ui_swatch",element:{...f}},ge.style.cursor="default";return}}if(St){const h=z.removeSessionButton;if(h&&j.x>=h.x&&j.x<=h.x+h.width&&j.y>=h.y&&j.y<=h.y+h.height){te={target:"ui_session_remove"},ge.style.cursor="default";return}const f=z.addSessionButton;if(f&&j.x>=f.x&&j.x<=f.x+f.width&&j.y>=f.y&&j.y<=f.y+f.height){te={target:"ui_session_add"},ge.style.cursor="default";return}for(const u of z.sessionIcons)if(j.x>=u.x&&j.x<=u.x+u.width&&j.y>=u.y&&j.y<=u.y+u.height){te={target:"ui_session",element:{...u}},ge.style.cursor="default";return}}if(Zu(j,e.shiftKey,e.ctrlKey||e.metaKey)){te={target:"ui"},ge.style.cursor="default";return}if(Xu(e)){te={target:"coord_system"};return}const n=fc(j);let s=n?null:go(j),i=!n&&!s?po(j):null,o=!n&&!s&&!i?yo(j):null;if(n)cn("entityMouseDown",{type:ie.TEXT,id:n.id,button:e.button});else if(s){const h=s.type==="regular"?ie.VERTEX:ie.TRANSFORMATION_OBJECT;cn("entityMouseDown",{type:h,id:s.id,button:e.button})}else i?cn("entityMouseDown",{type:ie.EDGE,id:ne(i),button:e.button}):o&&cn("entityMouseDown",{type:ie.FACE,id:ce(o),button:e.button});const a=e.shiftKey||e.ctrlKey||e.metaKey,r=n||s||i||o;let c=!1;n?c=Ie.includes(n.id):s?c=ue.includes(s.id)||_e.includes(s.id):i?c=he.includes(ne(i)):o&&(c=ae.includes(ce(o))),!Ke&&!a&&r&&!c&&(n?Rt([],[],[],!1,!1,!1,[n.id]):s?Rt([s.id],[],[],!1,!1,s.type!=="regular"):i?Rt([],[ne(i)],[],!1,!1):o&&Rt([],[],[ce(o)],!1,!1));let l=null;if(n)l=Pe(j);else if(s)l=s;else if(i){const h=q(i.id1),f=q(i.id2);l=Tt(Pe(j),h,f)}else o&&(l=Pe(j));const d=Je&&(ue.length>0||he.length>0||ae.length>0||Ie.length>0);de=[],Se=[],te={targetVertex:s,dragHandle:l,targetEdge:i,targetFace:o,targetText:n,target:r||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:d},s&&s.type!=="regular"&&(vs=!0,Tr(s.id,e.shiftKey,e.ctrlKey||e.metaKey))}function dg(){He();const e=[...ue],t=[...he],n=[...ae],s=[..._e],i=Je;ue=[],he=[],ae=[],_e=[],Ie=[],Je=null;const o=parseInt(Yt,10)||1;let a=null;const r=Oe&&de.length===1&&te?.finalSnapResult?.snapType==="edge",c=new Set(Zs.map(y=>y.id));if(c.size>0){const y=new Map(Zs.map(_=>[_.id,_])),m=new Set(e);t.forEach(_=>{const[P,M]=_.split(ao);P&&m.add(P),M&&m.add(M)}),n.forEach(_=>{const P=Z.find(M=>ce(M)===_);P&&Ec(P.id,Z).forEach(w=>m.add(w))});const x=ze?null:dc(),{center:S,rotation:I=0,scale:b=1,directionalScale:v=!1,startVector:E}=ze||{},C=-I*(180/Math.PI);$e.forEach(_=>{if(!c.has(_.id))return;const P=y.get(_.id)||_,M=cc(P);if(P.anchorType!=="canvas"&&!M)return;const w=P.anchorType==="canvas"?P.position||_.position:M.anchor,O=P.anchorType==="canvas"?{x:0,y:0}:P.offset||{x:0,y:0},T=P.anchorType==="canvas"?P.position||_.position||{x:0,y:0}:{x:w.x+O.x,y:w.y+O.y},A=(()=>{if(P.anchorType==="vertex")return m.has(P.anchorId);if(P.anchorType==="edge"){if(t.includes(P.anchorId))return!0;const L=K.find(B=>ne(B)===P.anchorId);return L?m.has(L.id1)&&m.has(L.id2):!1}if(P.anchorType==="face"){if(n.includes(P.anchorId))return!0;const L=Z.find(B=>ce(B)===P.anchorId);return L?L.vertexIds.every(B=>m.has(B)):!1}return!1})();if(ze){const L=We(T,S,I,b,v,E);if(_.rotationDeg=(P.rotationDeg||0)+C,_.scale=(P.scale||1)*b,P.anchorType==="canvas")_.position=L;else{const B=A?We(w,S,I,b,v,E):w,F={x:L.x-B.x,y:L.y-B.y};if(_.offset=F,_.anchorType==="edge"){const R=Wa(_.anchorId,F);typeof R=="number"&&(_.edgeOffsetFactor=R)}}}else if(x){if(P.anchorType==="canvas"){const L=P.position||_.position||{x:0,y:0};_.position={x:L.x+x.x,y:L.y+x.y}}else if(!A){const L=P.offset||{x:0,y:0},B={x:L.x+x.x,y:L.y+x.y};if(_.offset=B,_.anchorType==="edge"){const F=Wa(_.anchorId,B);typeof F=="number"&&(_.edgeOffsetFactor=F)}}}})}if(r){const y=te.finalSnapResult,m=de[0].id,x=y.targetEdge,S=q(m);if(S&&x){const I=JSON.parse(JSON.stringify(K)),b=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;S.x=y.pos.x,S.y=y.pos.y,K=K.filter(M=>ne(M)!==ne(x));const v=q(x.id1),E=q(x.id2),C=As(v,S,b,Le),_=As(E,S,b,Le),P=x?.colorMode||Wt;jn(C,P),jn(_,P),Ns(C),Ns(_),K.push(C),K.push(_),Bs(I,K)}}else if(ze){const{center:y,rotation:m,scale:x,directionalScale:S,startPos:I}=ze,b={x:I.x-y.x,y:I.y-y.y};de.forEach(v=>{const E=q(v.id);if(E){const C=We(v,y,m,x,S,b);E.x=C.x,E.y=C.y}})}else if(Se.length>0){const y=te.finalSnapResult&&te.finalSnapResult.snapped?te.finalSnapResult.finalDelta:{x:Se[0].x-de[0].x,y:Se[0].y-de[0].y},m=de.filter(x=>x.type==="regular");if(o>1&&m.length>0){const x=new Set(m.map(T=>T.id)),S=new Set(ae),I=new Set(he);ae.forEach(T=>{const A=Z.find(L=>ce(L)===T);A&&A.vertexIds.forEach(L=>x.add(L))});const b=new Set;ae.forEach(T=>{const A=Z.find(L=>ce(L)===T);if(A)for(let L=0;L<A.vertexIds.length;L++){const B=A.vertexIds[L],F=A.vertexIds[(L+1)%A.vertexIds.length];b.add(ne({id1:B,id2:F}))}});const v=K.filter(T=>{const A=ne(T);return I.has(A)||b.has(A)?!0:x.has(T.id1)&&x.has(T.id2)}),E=ae.length>0?Z.filter(T=>S.has(ce(T))):Z.filter(T=>T.vertexIds.every(A=>x.has(A))),C=K.filter(T=>x.has(T.id1)&&!x.has(T.id2)||x.has(T.id2)&&!x.has(T.id1)),_=[],P=[],M=[];a={vertices:[],edges:[],faces:[],texts:[]};const w=new Set(Ie),O=$e.filter(T=>{if(w.has(T.id))return!0;if(T.anchorType==="vertex")return x.has(T.anchorId);if(T.anchorType==="edge"){const A=K.find(L=>ne(L)===T.anchorId);return A?x.has(A.id1)&&x.has(A.id2):!1}if(T.anchorType==="face"){if(S.has(T.anchorId))return!0;const A=Z.find(L=>ce(L)===T.anchorId);return A?A.vertexIds.every(L=>x.has(L)):!1}return!1});for(let T=1;T<o;T++){const A=new Map,L=[],B=[],F=[],R=[];m.forEach(N=>{const $={x:N.x+y.x*T,y:N.y+y.y*T},D={...N,...$,id:zt()};_.push(D),A.set(N.id,D.id),L.push(D.id)}),v.forEach(N=>{const $=A.get(N.id1),D=A.get(N.id2);if($&&D){const k={...N,id1:$,id2:D};P.push(k),B.push(ne(k))}}),C.forEach(N=>{const $=x.has(N.id1)?N.id2:N.id1,D=x.has(N.id1)?N.id1:N.id2,k=A.get(D);if(k){const V={...N,id1:k,id2:$};P.push(V)}}),E.forEach(N=>{const $=Ds.get(N.id),D=N.vertexIds.map(k=>A.get(k));if(D.every(Boolean)){const k=JSON.parse(JSON.stringify(N));if(k.id=ce({vertexIds:D}),k.vertexIds=D,k.localCoordSystem&&$){const V={x:y.x*T,y:y.y*T};k.localCoordSystem.origin.x=$.origin.x+V.x,k.localCoordSystem.origin.y=$.origin.y+V.y}M.push(k),F.push(k.id)}}),O.forEach(N=>{const $=JSON.parse(JSON.stringify(N));if($.id=zt(),N.anchorType==="canvas"){if(!$.position)return;$.position={x:$.position.x+y.x*T,y:$.position.y+y.y*T}}else if(N.anchorType==="vertex"){const D=A.get(N.anchorId);if(!D)return;$.anchorId=D}else if(N.anchorType==="edge"){const D=K.find(G=>ne(G)===N.anchorId);if(!D)return;const k=A.get(D.id1),V=A.get(D.id2);if(!k||!V)return;$.anchorId=ne({id1:k,id2:V})}else if(N.anchorType==="face"){const D=Z.find(V=>ce(V)===N.anchorId);if(!D)return;const k=D.vertexIds.map(V=>A.get(V));if(!k.every(Boolean))return;$.anchorId=ce({vertexIds:k})}$e.push($),w.has(N.id)&&R.push($.id)}),T===1&&(a={vertices:L,edges:B,faces:F,texts:R})}re.push(..._),K.push(...P),Z.push(...M)}else o===1&&de.forEach(x=>{const S=q(x.id);S&&(S.x=x.x+y.x,S.y=x.y+y.y)})}const l=new Set(de.map(y=>y.id)),d=Z.filter(y=>y.vertexIds.some(m=>l.has(m)));d.length>0&&d.forEach(y=>{const m=Ds.get(y.id);if(y.localCoordSystem&&m){const x=new Set(y.vertexIds),S=new Set(de.map(b=>b.id));if([...x].every(b=>S.has(b))){if(ze){const{center:b,rotation:v,scale:E,directionalScale:C,startPos:_}=ze,P={x:_.x-b.x,y:_.y-b.y},M=We(m.origin,b,v,E,C,P);if(y.localCoordSystem.origin=M,C){const w=zn({x:1,y:0},m),O=We(w,b,v,E,C,P);y.localCoordSystem.scale=Q(M,O)}else y.localCoordSystem.angle=On(m.angle+v),y.localCoordSystem.scale=m.scale*E}else if(o===1){const b=te.finalSnapResult&&te.finalSnapResult.snapped?te.finalSnapResult.finalDelta:{x:Se[0].x-de[0].x,y:Se[0].y-de[0].y};y.localCoordSystem.origin.x=m.origin.x+b.x,y.localCoordSystem.origin.y=m.origin.y+b.y}}else{const b=y.vertexIds.map(v=>q(v)).filter(Boolean);Wu(y,m,de,b,q)}}}),Gu(Array.from(l),ze);const{vertexMerges:h,edgeSplits:f}=Tg(re,K,se),u=new Map;re.forEach(y=>u.set(y.id,y.id));const p=y=>{if(!u.has(y)||u.get(y)===y)return y;const m=p(u.get(y));return u.set(y,m),m};h.forEach((y,m)=>{const x=p(m),S=p(y);x!==S&&u.set(S,x)});const g=new Set;if(re.forEach(y=>{const m=p(y.id);y.id!==m&&g.add(y.id)}),g.size>0||f.size>0){const y=JSON.parse(JSON.stringify(K)),m=Ku(Z,p);K.forEach(x=>{x.id1=p(x.id1),x.id2=p(x.id2)}),re=re.filter(x=>!g.has(x.id)),K=K.filter((x,S,I)=>x.id1!==x.id2&&S===I.findIndex(b=>ne(b)===ne(x))),Bs(y,K),Z.forEach(x=>{const S=m.get(x.id);S&&(x.localCoordSystem=S)}),Vs()}o>1&&a?(ue=e.length>0?a.vertices.map(y=>p(y)):[],he=t.length>0?a.edges:[],ae=n.length>0?a.faces:[],Ie=Zs.length>0?a.texts:[]):o===1&&(ue=e.map(y=>p(y)),he=t,ae=n,Ie=Zs.map(y=>y.id).filter(y=>$e.some(m=>m.id===y))),_e=s,Je=i,Hi(),Kt()}function hg(e){const{shiftKey:t,ctrlKey:n,targetVertex:s,targetEdge:i,targetFace:o,targetText:a}=e,r=q(ht);if(Ke&&r){He();const c=JSON.parse(JSON.stringify(K)),l=Wo(r,j,t);let d=null;const h=U.alpha2>U.alpha1&&U.interval2?U.interval2:U.interval1;if(l.snapType==="vertex"&&l.targetVertex)d=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)d=Cc(l.targetEdge,{x:l.x,y:l.y},h,Le);else{let f=Le(Ge);const u=Ee[Ge];if(u!==-1){const p=pe[u];p&&p.type==="colormap"&&(f=De(p,.5))}d={id:zt(),x:l.x,y:l.y,type:"regular",color:f},re.push(d)}if(d){if(!K.some(p=>p.id1===r.id&&p.id2===d.id||p.id2===r.id&&p.id1===d.id)){const p=As(r,d,h,Le);jn(p,Wt),Ns(p),K.push(p),Bs(c,K),Hi(),Z.forEach(g=>{g.colorMode=g.colorMode||Ht,zo(g,g.colorMode)})}const u=Tl(r,d,K);u&&(st.length>0&&(st[st.length-1].turn=u.turnAngleRad),st.push({length:u.length,turn:0,endVertexColor:d.color}),nn=st.length-1,Wn=u.startVertex,mt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,hs=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Vt=u.turnAngleRad,ds=u.precedingSegmentAbsoluteAngleRad),we.push(d.id),window.currentDrawingPath=we,wc(),Pc(),Kt(),ht=d.id}if(t&&d&&l){const f=Tl(r,d,K);f&&(Wn=f.startVertex,mt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):f.length,hs=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,Vt=f.turnAngleRad,ds=f.precedingSegmentAbsoluteAngleRad)}fe.count=0}else if(e.target==="canvas"){He();const c=Be||Pe(j);let l=Le(Ge);const d=Ee[Ge];if(d!==-1){const f=pe[d];f&&f.type==="colormap"&&(l=De(f,0))}const h={id:zt(),...c,type:"regular",color:l};re.push(h),Ke=!0,ht=h.id,st=[],nn=0,we=[h.id],window.currentDrawingPath=we,Kt()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(a||s||i||o)){He();const l=a?a.id:o?ce(o):i?ne(i):s.id;let d;switch(a?d="text":o?d="face":s&&s.type!=="regular"?d="center":s?d="vertex":i&&(d="edge"),l&&fe.targetId===l&&Date.now()-fe.timestamp<Si?fe.count++:fe.count=1,fe.targetId=l,fe.type=d,fe.timestamp=Date.now(),fe.count){case 1:fe.type==="text"?Rt([],[],[],t,n,!1,[fe.targetId]):fe.type==="face"?Rt([],[],[fe.targetId],t,n):fe.type==="edge"?Rt([],[fe.targetId],[],t,n):fe.type==="vertex"?Rt([fe.targetId],[],[],t,n):fe.type==="center"&&Tr(fe.targetId,t,n);break;case 2:if(fe.type==="text"){const h=uo(fe.targetId);h&&uc(h,h.content||"")}else if(fe.type==="vertex"){const h=yn(fe.targetId,K);Rt([fe.targetId,...h],[],[],t,n)}else if(fe.type==="edge"){const h=K.find(f=>ne(f)===fe.targetId);if(h){const f=[...Ua(h.id1),...Ua(h.id2)];Rt([],Array.from(new Set(f.map(u=>ne(u)))),[],t,n)}}else if(fe.type==="face"){const h=Z.find(f=>ce(f)===fe.targetId);if(h){const f=[],u=new Set;for(let p=0;p<h.vertexIds.length;p++){const g=h.vertexIds[p],y=h.vertexIds[(p+1)%h.vertexIds.length];u.add(ne({id1:g,id2:y}))}Z.forEach(p=>{if(ce(p)!==ce(h))for(let g=0;g<p.vertexIds.length;g++){const y=p.vertexIds[g],m=p.vertexIds[(g+1)%p.vertexIds.length];if(u.has(ne({id1:y,id2:m}))){f.push(ce(p));break}}}),Rt([],[],[ce(h),...f],t,n)}}break;case 3:if(fe.type==="vertex"||fe.type==="edge"||fe.type==="face"){let h;if(fe.type==="vertex")h=fe.targetId;else if(fe.type==="edge")h=fe.targetId.split(ao)[0];else if(fe.type==="face"){const f=Z.find(u=>ce(u)===fe.targetId);f&&(h=f.vertexIds[0])}if(h){const f=new Set(Fs(h));if(fe.type==="vertex")Rt(Array.from(f),[],[],t,n);else if(fe.type==="edge"){const u=K.filter(p=>f.has(p.id1)&&f.has(p.id2)).map(p=>ne(p));Rt([],u,[],t,n)}else if(fe.type==="face"){const u=Z.filter(p=>p.vertexIds.every(g=>f.has(g))).map(p=>ce(p));Rt([],[],u,t,n)}}}fe.count=0;break}kr()}}}function fg(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),s=`icon-${t.target}`;if(fe.targetId===s&&n-fe.timestamp<Si){switch(He(),t.target){case Ge:Di=!Di;break;case Ue:ki=!ki;break;case ot:Kn=!Kn;break}vt(),fe.count=0}fe.targetId=s,fe.timestamp=n,_t=null;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),s=`swatch-${t.index}`;if(!(ue.length>0||he.length>0||ae.length>0||Ie.length>0)&&Xe.length===0?_t=t.index:_t=null,fe.targetId===s&&n-fe.timestamp<Si){Oi=!0,Ao=t.index;const o=pe[t.index];let a;if(o.type==="color"){const r=Ps(o.value);a={type:"colormap",points:[{pos:.5,alpha:r.a,color:[r.r,r.g,r.b],order:1}]}}else o.type==="colormap"&&(a={type:"colormap",points:o.vertices.map(r=>({pos:r.pos,alpha:r.alpha!==void 0?r.alpha:1,color:Array.isArray(r.color)?[...r.color]:[r.color.r||0,r.color.g||0,r.color.b||0],order:r.order||1})),isCyclic:o.isCyclic===!0});Qn.show(void 0,void 0,a),fe.count=0}else Xe.length>0&&(He(),Xe.forEach(o=>Ee[o]=t.index),Er(),vt(),_t=null);fe.targetId=s,fe.timestamp=n;return}if(e.target==="ui_session"){const{element:t}=e;t&&t.index!==void 0&&Xs(t.index);return}if(e.target==="ui_session_add"){vu();return}if(e.target==="ui_session_remove"){wt!==null&&vc(wt);return}}function ug(e){if(to||rs||Do){if(to){if(z.colorTargetIcons.find(n=>n.target===Ot.target)){const n=z.colorSwatches,s=$l(j,n);s&&(Ee[Ot.target]=s.index,Vi(Ot.target).forEach(i=>{Ee[i]=s.index}),Er())}}else if(rs){const t=z.removeColorButton;if(t&&j.x>=t.x&&j.x<=t.x+t.width&&j.y>=t.y&&j.y<=t.y+t.height&&pe.length>1){const s=pe.indexOf(ut.item);s!==-1&&ja(s)}else if(ut&&ut.previewIndex!==null&&ut.previewIndex!==void 0){const s=ut.originalIndex,i=ut.previewIndex;if(s!==i&&s>=0&&i>=0){const o=[...ut.originalAllColors],[a]=o.splice(s,1);o.splice(i,0,a),pe=o;const r={...ut.originalAssignments};Object.keys(r).forEach(c=>{const l=r[c];l===s?r[c]=i:s<i&&l>s&&l<=i?r[c]=l-1:s>i&&l>=i&&l<s&&(r[c]=l+1)}),Ee=r}}}else if(Do){const t=z.removeSessionButton;t&&j.x>=t.x&&j.x<=t.x+t.width&&j.y>=t.y&&j.y<=t.y+t.height&&pi&&vc(pi.index)}to=!1,Ot=null,rs=!1,ut=null,Do=!1,pi=null,it&&vt(),St&&ia()}else Oe?dg():te&&(typeof te.target=="string"&&te.target.startsWith("ui")?fg(te):hg(te));Rc()}function gg(e){Xt=!0,vn=!1,Ni=sn,te={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function pg(e){if(Oe&&vn){const t=Pe({x:Math.min(sn.x,j.x),y:Math.min(sn.y,j.y)}),n=Pe({x:Math.max(sn.x,j.x),y:Math.max(sn.y,j.y)}),s=Math.min(t.x,n.x),i=Math.max(t.x,n.x),o=Math.min(t.y,n.y),a=Math.max(t.y,n.y),r=re.filter(f=>f.type==="regular"&&f.x>=s&&f.x<=i&&f.y>=o&&f.y<=a).map(f=>f.id),c=re.filter(f=>f.type!=="regular"&&f.x>=s&&f.x<=i&&f.y>=o&&f.y<=a).map(f=>f.id),l=new Set(r),d=K.filter(f=>l.has(f.id1)&&l.has(f.id2)).map(f=>ne(f)),h=Z.filter(f=>f.vertexIds.every(u=>l.has(u))).map(f=>ce(f));te.shiftKey?(ue=[...new Set([...ue,...r])],he=[...new Set([...he,...d])],ae=[...new Set([...ae,...h])],_e=[...new Set([..._e,...c])]):te.ctrlKey?(r.forEach(f=>{const u=ue.indexOf(f);u>-1?ue.splice(u,1):ue.push(f)}),d.forEach(f=>{const u=he.indexOf(f);u>-1?he.splice(u,1):he.push(f)}),h.forEach(f=>{const u=ae.indexOf(f);u>-1?ae.splice(u,1):ae.push(f)}),c.forEach(f=>{const u=_e.indexOf(f);u>-1?_e.splice(u,1):_e.push(f)})):(ue=r,he=d,ae=h,_e=c),kr(),ac()}else{if(St&&z.sessionsPanelBounds){const n=z.sessionsPanelBounds;if(j.x>=n.x&&j.x<=n.x+n.width&&j.y>=n.y&&j.y<=n.y+n.height){Tu();return}}qu(e);const t=ue.length>0||he.length>0||ae.length>0||Ie.length>0;_t=null,t||(Xe=[]),it&&vt()}}function yg(e){e.preventDefault();const t=So(e,ge),n=e.deltaY>0?1/1.15:1.15;zi(t,n),cn("wheel",e),Bt()}function mg(){Bo=!0,Bt()}function xg(){Bo=!1,Tc(),Bt()}function Sg(e){e.preventDefault(),Bt()}function Ig(e,t){const n=parseInt(Yt||"1",10)||1,s=Lh(de,re,K,q,e,n,se),i=s.finalDelta;de.forEach(o=>{const a=Se.find(r=>r&&r.id===o.id);a&&(a.x=o.x+i.x,a.y=o.y+i.y)}),Dc(i,s),te.finalSnapResult=s}function bg(e){if(Kn&&re.length>0&&(Xl(Ce,{allFaces:Z,hoveredFaceId:Gt,selectedFaceIds:ae,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,currentAltPressed:bt},xe,q,ce),ae.length>0&&Jl(Ce,{allFaces:Z,selectedFaceIds:ae,colors:e,isDragConfirmed:Oe,dragPreviewVertices:Se,initialDragVertexStates:de,transformIndicatorData:ze,highlightedEdgeForSnap:Fn,draggedFaceId:Go,coordSystemSnapAngle:ho,coordSystemSnapType:ks,coordSystemSnapScale:Ln,initialCoordSystemStates:Ds},xe,q)),Ke&&Te&&(mt!==null||Vt!==null)&&we.length>=1&&Wn){const s=q(Wn.id);if(s){const i={frozen_Origin_Data_to_display:s,displayAngleA_valueRad_for_A_equals_label:Vt,frozen_A_baseRad_to_display:ds,frozen_D_du_to_display:mt,frozen_D_g2g_to_display:hs};cf(Ce,i,xe,Pe,{showAngles:Zn,showDistances:Dn,viewTransform:se,mousePos:j,colors:e}),df(lt,i,{showAngles:Zn,showDistances:Dn,viewTransform:se,mousePos:j,frozenReference_D_du:mt,distanceSigFigs:ps,angleDisplayMode:Sn,colors:e},Pe,xe,At)}}const t={lastGridState:U,showDistances:Dn,showAngles:Zn,distanceSigFigs:ps,angleDisplayMode:Sn,angleSigFigs:di,currentShiftPressed:Te,viewTransform:se,colors:e};if(Oe){const s=new Set(de.map(a=>a.id));let i=!1;if(de.length>0){const a=new Set(Fs(de[0].id));i=!(s.size===a.size&&[...s].every(r=>a.has(r)))}const o=re.map(a=>Se.find(c=>c.id===a.id)||a);if(i&&Te)de.forEach(a=>{yn(a.id,K).some(c=>!s.has(c))&&Po(Ce,lt,a.id,o,t,xe,c=>yn(c,K),ne,Te,null,At,ue,!0,de,Je,Ct)});else if(te&&(te.targetVertex||te.targetEdge)){const a=te.targetVertex?te.targetVertex.id:de[0]?.id;a&&Po(Ce,lt,a,o,t,xe,r=>yn(r,K),ne,Te,null,At,ue,!0,de,Je,Ct),te.targetEdge&&ml(Ce,lt,he,K,{showDistances:Dn,distanceSigFigs:ps,colors:e,lastGridState:U,currentShiftPressed:Te},q,ne,xe,At,Se,de,ze)}}else(Dn||Zn)&&!Ke&&!(parseInt(Yt||"1",10)>1&&Oe)&&!Qt&&(ue.length>0&&ue.length<=Kd&&ue.forEach(s=>{Po(Ce,lt,s,re,{...t,currentShiftPressed:!1},xe,i=>yn(i,K),ne,!1,null,At,ue,!1,[],Je)}),he.length>0&&he.length<=qd&&(ml(Ce,lt,he,K,{showDistances:Dn,distanceSigFigs:ps,colors:e,lastGridState:U},q,ne,xe,At,Se,de,ze),Af(Ce,lt,he,K,{showAngles:Zn,angleSigFigs:di,angleDisplayMode:Sn,currentShiftPressed:Te,distanceSigFigs:ps,viewTransform:se,lastGridState:U,colors:e},q,ne,xe,s=>yn(s,K),At)));const n=!bt&&(fn||Jt||Gt);if(Ke&&ht&&!n){const s=q(ht);if(s){const i=Dr(s.id),o=Wo(s,j,Te);let a=Le(Ue),r=null;const c=Ee[Ue];if(c!==-1){const h=pe[c];if(h&&h.type==="colormap"&&we&&we.length>=1){const f=we.length,u=we.length-1,p=f>1?u/(f-1):0,g=f>1?(u+1)/f:1;r={colormapItem:h,startT:p,endT:g}}}Gl(Ce,{startVertex:s,snappedData:o,isShiftPressed:Te,currentColor:Le(Ge),nextCreationColor:Le(Ge),nextEdgeColor:a,colors:e,edgeColormapInfo:r,interpolationStyle:Yi()},xe);const l={x:o.x,y:o.y};Wl(Ce,lt,s,l,o,{showDistances:Dn,showAngles:Zn,currentShiftPressed:Te,distanceSigFigs:ps,angleSigFigs:di,angleDisplayMode:Sn,viewTransform:se,frozenReference_D_du:mt,gridDisplayMode:dt,frozenReference_A_rad:Vt,colors:e},xe,i,At)}}if(Be&&!n){const s={...Be,id:"ghost",type:"regular"};Ti(Ce,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:wn==="vertex"||wn==="edge_fraction"||wn==="edge"?wn:null,currentAltPressed:bt},xe)}if(vn&&Oe&&Pf(Ce,Ni,j,e),Qh(Ce,{info:{..._i,startVertex:q(ht)},colors:e},xe,q,At),(ze||Pn)&&of(Ce,lt,{transformIndicatorData:ze,colors:e,coordSystemTransformIndicatorData:Pn,currentShiftPressed:Te},xe,At),Be&&!n){const s={...Be,id:"ghost",type:"regular"},i=wn==="vertex"||wn==="edge_fraction"||wn==="edge";i?Ti(Ce,s,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:i?wn:null,currentAltPressed:bt},xe):pr(Ce,s,{colors:e,verticesVisible:!0,isSnapped:!0},xe)}}function vg(e){if(fn=null,Jt=null,Gt=null,Ri=null,Be=null,wn=null,!Xt){if(!bt){const o=fc(e);if(o){Ri=o.id;return}}const t=go(e),n=t?null:po(e),s=!t&&!n?yo(e):null,i=t||n||s;if(bt)i?Rr(e,Te):Qe=null,fn=null,Jt=null,Gt=null;else if(t?fn=t.id:n?Jt=ne(n):s&&(Gt=s.id),Te&&!i){Pe(e);const o=Wo({id:"dummy_start",x:0,y:0},e,!0);o.snapped&&(Be={x:o.x,y:o.y},wn=o.snapType)}}}function Mg(e){if(ht){const t=q(ht);if(t)if(Te){const n=Wo(t,e,Te);_i=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else _i=null}Be=null}function Eg(e,t,n,s){const i=Du(n,e,t,s,gi);let o={},a={};if(s===un)o=Ru(n,de,t,i.rotation,e),a={rotation:o.rotation,scale:1,directionalScale:!1},gi=i.rotation;else if(s===Un)o=Lu(n,de,t,i.scale),a={rotation:0,scale:o.scale||i.scale,directionalScale:!1};else if(s===In)o=ku(n,de,t,i.rotation,i.scale),a={rotation:o.rotation,scale:o.scale,directionalScale:!1},gi=i.rotation;else if(s===us){const h={x:t.x-n.x,y:t.y-n.y};o=Ou(n,de,t,i.scale,h,e),a={rotation:0,scale:o.scale||i.scale,directionalScale:!0}}o.snapped&&o.snapType==="projection"&&o.projectionSource&&(Be=o.projectionSource);const r={x:t.x-n.x,y:t.y-n.y};ze={center:n,startPos:t,currentPos:o.pos||e,rotation:a.rotation,scale:a.scale,isSnapping:o.snapped||!1,transformType:s,directionalScale:a.directionalScale,snappedScaleValue:o.snappedScaleValue||null,gridToGridInfo:o.gridToGridInfo||null,gridPoint:o.gridPoint||null,nearbyVertex:o.nearbyVertex||null,projectionPoint:o.projectionPoint||null,projectionSource:o.projectionSource||null,snapType:o.snapType||null,projectionCenter:o.snapType==="projection"?n:null,projectionHandleInitial:o.projectionHandleInitial||null,startVector:r};const c={x:t.x-n.x,y:t.y-n.y};if(Se=de.map(h=>{const f=We(h,n,a.rotation,a.scale,a.directionalScale,c);return{...h,x:f.x,y:f.y}}),o.snapped&&o.snapType==="merge"&&o.mergingVertex&&o.mergeTarget){const h=de.find(f=>f.id===o.mergingVertex.id);if(h){const f=Se.find(u=>u.id===h.id);if(f){const u={x:o.mergeTarget.x-f.x,y:o.mergeTarget.y-f.y};Se.forEach(p=>{p.x+=u.x,p.y+=u.y}),ze.currentPos&&(ze.currentPos.x+=u.x,ze.currentPos.y+=u.y)}}}const l=Ve*2/se.scale,d=re.filter(h=>h.type==="regular"&&!de.some(f=>f.id===h.id));Se.forEach(h=>{h.type==="regular"&&d.forEach(f=>{Q(h,f)<l&&Os.push({x:f.x,y:f.y})})});for(let h=0;h<Se.length;h++)for(let f=h+1;f<Se.length;f++){const u=Se[h],p=Se[f];u.type==="regular"&&p.type==="regular"&&Q(u,p)<l&&Os.push({x:(u.x+p.x)/2,y:(u.y+p.y)/2})}}function Cg(e){if(to&&Ot){const t=z.colorTargetIcons.find(n=>n.target===Ot.target);if(t){const n=[...z.colorSwatches],s=$l(e,n);s?(t.x=s.x+(s.width-t.width)/2,t.y=s.y-t.height-5,Ot.previewColorIndex=s.index,Vi(Ot.target).forEach(i=>{const o=z.colorTargetIcons.find(a=>a.target===i);o&&(o.x=t.x,o.y=t.y)})):(t.x=e.x-Ot.offsetX,t.y=e.y-Ot.offsetY,Ot.previewColorIndex=Ot.originalColorIndex,Vi(Ot.target).forEach(i=>{const o=z.colorTargetIcons.find(a=>a.target===i);o&&(o.x=t.x,o.y=t.y)}))}return!0}if(rs){const t=ut.originalIndex,n=z.colorSwatches.filter(i=>i.index!==t);let s=n.length;for(let i=0;i<n.length;i++){const o=n[i],a=o.x+o.width/2;if(e.x<a){s=i;break}}return ut.previewIndex!==s&&(ut.previewIndex=s,vt()),!0}return!!Do}function Lr(){if(Xt||Ke){Qe=null,Be=null,fn=null,Jt=null,Gt=null;return}bt?Rr(j,Te):(Qe=null,vg(j))}function _c(e){if(j=So(e,ge),Te=e.shiftKey,bt=e.altKey,Io=e.ctrlKey||e.metaKey,Pr(j)?ge.style.cursor="default":Qt?ge.style.cursor="none":Yn||Oe?ge.style.cursor="grabbing":ge.style.cursor="crosshair",Xt){if(!Oe&&Q(j,sn)>yd&&!Ke){if(Oe=!0,te&&te.target==="coord_system")return;if(Fi=te.dragHandle,Li=te.target==="edge",te.target==="ui_icon_click"){to=!0;const t=te.element.target;Ot={target:t,offsetX:j.x-te.element.x,offsetY:j.y-te.element.y,originalColorIndex:Ee[t],previewColorIndex:Ee[t]},te.target="ui_icon_drag",Xe=[t,...Vi()]}else if(te.target==="ui_swatch")He(),rs=!0,ut={index:te.element.index,item:te.element.item,offsetX:j.x-te.element.x,originalIndex:te.element.index,originalAllColors:JSON.parse(JSON.stringify(pe)),originalAssignments:JSON.parse(JSON.stringify(Ee)),previewIndex:te.element.index};else if(te.target==="ui_session")Do=!0,pi={index:te.element.index,session:te.element.session,offsetX:j.x-te.element.x,offsetY:j.y-te.element.y},te.target="ui_session_drag";else if(jt===2){vn=!0;return}else if(te.target==="canvas")Yn=!0,Ta={x:se.offsetX,y:se.offsetY},ge.style.cursor="move";else{ge.style.cursor="grabbing",vs=te.targetVertex&&te.targetVertex.type!=="regular"&&!te.isTransformDrag;let n;if(vs)n=[te.targetVertex];else{let i=new Set(ue);he.forEach(o=>{const[a,r]=o.split(ao);i.add(a),i.add(r)}),ae.forEach(o=>{const a=Z.find(r=>ce(r)===o);a&&Ec(a.id,Z).forEach(c=>i.add(c))}),n=Array.from(i).map(o=>q(o)).filter(o=>o&&o.type==="regular")}if(vs&&te.targetVertex.type===un){const i=te.targetVertex,o=Pe(sn),a={x:o.x-i.x,y:o.y-i.y};te.initialRotationStartAngle=Math.atan2(a.y,a.x),gi=0}const s=Ie.map(i=>uo(i)).filter(Boolean);if(n.length>0||s.length>0){de=JSON.parse(JSON.stringify(n)),Se=JSON.parse(JSON.stringify(n)),Zs=JSON.parse(JSON.stringify(s)),Ga=JSON.parse(JSON.stringify(s)),Ds.clear();const i=new Set(de.map(o=>o.id));Z.forEach(o=>{o.vertexIds.some(a=>i.has(a))&&o.localCoordSystem&&Ds.set(o.id,JSON.parse(JSON.stringify(o.localCoordSystem)))})}}}if(Oe){if(Yn){const t=j.x-sn.x,n=j.y-sn.y;se.offsetX=Ta.x+t*Fe,se.offsetY=Ta.y-n*Fe}else if(!vn){if(Cg(j)||ng(e))return;if(Je&&(ue.length>0||he.length>0||ae.length>0||Ie.length>0)&&!Li){const n=q(Je);let s=Fi;!s&&de.length>0&&(s=de.find(i=>i.type==="regular"&&Q(i,n)>1e-6)||de.find(i=>i.type==="regular")),n&&s&&Eg(Pe(j),s,n,n.type)}else if(Se.length>0){const n=de.length===1&&de[0].type==="regular",s=Pe(j);if(n){const i=de[0];yn(i.id,K).filter(a=>!de.some(r=>r.id===a)).map(a=>q(a));const o=fu(i,s);if(Se[0].x=o.pos.x,Se[0].y=o.pos.y,Ct.clear(),Ls.clear(),o.snapped){const a={copyIndex:0,type:o.snapType,projectionLine:o.projectionLine};Ct.set(i.id,[a]),o.targetEdge&&Ls.set(ne(o.targetEdge),[{copyIndex:0,type:"external_to_static"}])}te.finalSnapResult={...o,finalDelta:{x:o.pos.x-i.x,y:o.pos.y-i.y}}}else{const i=Pe(sn),o={x:s.x-i.x,y:s.y-i.y};Ig(o)}}else if(Ga.length>0){const n=Pe(sn),s=Pe(j),i={x:s.x-n.x,y:s.y-n.y};te.textFinalDelta=i}}}}else Ke?Mg(j):Lr();cn("mouseMove",{clientX:e.clientX,clientY:e.clientY,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey}),Bt()}function Dc(e,t){if(Ct.clear(),Ls.clear(),!t||!t.snapped)return;const n=(s,i,o,a)=>{if(i===void 0)return;let r;if(o===void 0)r=void 0;else if(o===-1)r=0;else if(o>=0)r=o;else return;(r===void 0||r>=0)&&(s.has(i)||s.set(i,[]),s.get(i).some(c=>c.copyIndex===r&&c.type===a)||s.get(i).push({copyIndex:r,type:a}))};t.mergePairs.forEach(s=>{n(Ct,s.source.originalId,s.source.transformIndex,"vertex"),n(Ct,s.target.originalId,s.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:s,targetEdge:i})=>{n(Ct,s.originalId,s.transformIndex,"edge"),n(Ls,i.originalEdgeId,i.transformIndex,"vertex_on_edge")})}function Tg(e,t,n){const s=2*Ve/n.scale,i=new Map,o=new Map,a=new Map;e.forEach(d=>a.set(d.id,d.id));const r=d=>{if(!a.has(d)||a.get(d)===d)return d;const h=r(a.get(d));return a.set(d,h),h};for(let d=0;d<e.length;d++)for(let h=d+1;h<e.length;h++){const f=e[d],u=e[h];if(f.type==="regular"&&u.type==="regular"&&Q(f,u)<s){const p=r(f.id),g=r(u.id);p!==g&&a.set(g,p)}}e.forEach(d=>{const h=r(d.id);d.id!==h&&i.set(d.id,h)});const c=new Set(i.keys()),l=new Map(e.map(d=>[d.id,d]));return t.forEach(d=>{const h=r(d.id1),f=r(d.id2);if(h===f)return;const u=l.get(h),p=l.get(f);!u||!p||e.forEach(g=>{if(g.type!=="regular"||c.has(g.id)||g.id===h||g.id===f)return;const y=Tt(g,u,p);if(y.distance<s&&y.onSegmentStrict){const m=ne({id1:h,id2:f});o.has(m)||o.set(m,{edge:{id1:h,id2:f},pointsToInsert:[]}),o.get(m).pointsToInsert.push(g)}})}),{vertexMerges:i,edgeSplits:o}}function kc(e){qn?sg():jt===0?ug():jt===2&&pg(e),qn||Rc(),Pr(j)?ge.style.cursor="default":Qt||(ge.style.cursor="crosshair"),qt(),jt===2?cn("rightMouseUp",e):jt===0&&cn("mouseUp",e),Bt()}function Rc(){Ut&&clearTimeout(Ut),Yt="",Ut=null,Xt=!1,Oe=!1,vn=!1,Li=!1,vs=!1,Yn=!1,Se=[],de=[],Ga=[],Zs=[],te=null,ze=null,Os=[],Be=null,Ls.clear(),Ct.clear(),Ds.clear(),jt=-1}function Lc(e){Ut&&clearTimeout(Ut),Yt="",Ut=null,xt.style.display==="block"&&(xt.style.display="none");const t=e.target;if(t&&(t.tagName==="INPUT"||t.closest(".katex"))){e.stopPropagation(),Bt();return}if((Ke||Qt)&&e.button===2){fs(),e.preventDefault(),Bt();return}j=So(e,ge),sn={...j},jt=e.button,jt===0?(cg(e),cn("mouseDown",e)):jt===2&&(gg(e),cn("rightMouseDown",e)),Bt()}function Oc(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;const t=()=>{cn("keyDown",e),Bt()};if((e.key==="Control"||e.key==="Meta")&&(Io=!0),e.key==="Alt"&&!e.repeat&&(e.preventDefault(),bt=!0,Lr()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!Ke&&!Qt&&!Xt){e.preventDefault(),qa(e.key),t();return}const s=e.ctrlKey||e.metaKey;if(s&&(e.key==="a"||e.key==="A")){e.preventDefault();const o=re.filter(l=>l.type==="regular").map(l=>l.id),a=K.map(l=>ne(l)),r=Z.map(l=>ce(l)),c=$e.map(l=>l.id);Rt(o,a,r,!1,!1,!1,c),_e=re.filter(l=>l.type!=="regular").map(l=>l.id),Je=_e.length>0?_e[_e.length-1]:null,t();return}if(e.key==="Shift"&&!Te){Te=!0;const o=Pe(j);if(Qt){const a=mi(o);a&&(Ho=xe(a),Be=a)}else if(Ke&&ht){const a=q(ht);if(a){const r=br(),c=Dr(a.id),l=Wo(a,j,Te);let d=Le(Ue),h=null;const f=Ee[Ue];if(f!==-1){const p=pe[f];if(p&&p.type==="colormap"&&we&&we.length>=1){const g=we.length,y=we.length-1,m=g>1?y/(g-1):0,x=g>1?(y+1)/g:1;h={colormapItem:p,startT:m,endT:x}}}Gl(Ce,{startVertex:a,snappedData:l,isShiftPressed:Te,currentColor:Le(Ge),nextCreationColor:Le(Ge),nextEdgeColor:d,colors:r,edgeColormapInfo:h},xe),Wl(Ce,lt,a,l,l,{showDistances:Dn,showAngles:Zn,currentShiftPressed:Te,distanceSigFigs:ps,angleSigFigs:di,angleDisplayMode:Sn,viewTransform:se,frozenReference_D_du:mt,gridDisplayMode:dt,frozenReference_A_rad:Vt,colors:r},xe,c,At)}}else if(!Xt)if(qn&&En&&En.type==="center"){const a=mi(o);if(a){Be=a;const r=En.face,c=r.localCoordSystem,l=r.vertexIds.map(h=>q(h)).filter(h=>h&&h.type==="regular"),d=co(a,l);c.origin.x=d.x,c.origin.y=d.y,c.isCustom=!0}}else{const a=go(j),r=a?null:po(j),c=!a&&!r?yo(j):null;!a&&!r&&!c?Be=mi(o):Be=null}}if(Xt&&jt===0&&(te?.targetVertex||te?.targetEdge||te?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(Ut),Ut===null||Yt.length>=2?Yt=e.key:Yt+=e.key;const o=parseInt(Yt,10)||1;if(te?.finalSnapResult?.finalDelta){const a=te.finalSnapResult.finalDelta,r={delta:a},l=Vl(de,re,K,q,o,se,r,(d,h,f=r)=>({x:d.x+f.delta.x*h,y:d.y+f.delta.y*h}));Dc(a,l),te.finalSnapResult={...l,finalDelta:a}}Ut=setTimeout(()=>{Ut=null},500)}if(s&&e.key.toLowerCase()===lh){e.preventDefault(),Ke&&ht&&Vu(),t();return}if(!(Xt&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(s&&[il,rl,al,Sa,ll,cl,ol,nl,sl].includes(e.key.toLowerCase())))){if(Bo&&s&&(e.key===nl||e.key===sl)){e.preventDefault();const o={x:ge.width/Fe/2,y:ge.height/Fe/2};zi(o,Kr),t();return}if(Bo&&s&&e.key===ol){e.preventDefault();const o={x:ge.width/Fe/2,y:ge.height/Fe/2};zi(o,1/Kr),t();return}if(e.key===oh)e.preventDefault(),_u();else if(e.key===ih)fs();else if(e.key===ah||e.key===rh)e.preventDefault(),Uo();else if(s&&e.key.toLowerCase()===il){if(St&&Ae[wt]){e.preventDefault(),_o=JSON.parse(JSON.stringify(Ae[wt])),t();return}e.preventDefault(),Mc()}else if(s&&e.key.toLowerCase()===rl)e.preventDefault(),wu();else if(s&&e.key.toLowerCase()===al){if(St&&_o){e.preventDefault(),Mu(),t();return}e.preventDefault(),Pu()}else if(s&&e.key.toLowerCase()===Sa&&!e.shiftKey){if(St&&Bi.length>0){e.preventDefault(),Eu(),t();return}e.preventDefault(),Qu()}else if(s&&(e.key.toLowerCase()===ll||e.shiftKey&&e.key.toLowerCase()===Sa))e.preventDefault(),eg();else if(s&&e.key.toLowerCase()===cl&&!Ha){e.preventDefault(),He(),ue=re.filter(a=>a.type==="regular").map(a=>a.id),he=K.map(a=>ne(a)),ae=Z.map(a=>a.id),_e=re.filter(a=>a.type!=="regular").map(a=>a.id),Je=null;const o=[];ae.length>0&&o.push(ot),he.length>0&&o.push(Ue),ue.length>0&&o.push(Ge),Ie.length>0&&o.push(Ft),o.length>0&&(Xe=o,it&&vt())}t()}}function Nc(e){const t=()=>{cn("keyUp",e),Bt()};if(e.key==="Shift"&&(Te=!1,Be=null,Ho=null,Os=[],qn&&En&&En.type==="center")){const n=Pe(j),s=En.face,i=s.localCoordSystem,o=s.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular"),a=co(n,o);i.origin.x=a.x,i.origin.y=a.y,i.isCustom=!0}e.key==="Alt"&&(bt=!1,Lr()),(e.key==="Control"||e.key==="Meta")&&(Io=!1),qt(),t()}function Fc(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,s=t.offsetHeight;ge.width=n*Fe,ge.height=s*Fe,ge.style.width=`${n}px`,ge.style.height=`${s}px`,lt&&(lt.style.width=`${n}px`,lt.style.height=`${s}px`)}function wg(){Jf(),pe=ji.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),gu(),gc(),Fc(),eu(),Lf({canvas:ge,onMouseDown:Lc,onMouseMove:_c,onMouseUp:kc,onPinchZoom:(n,s)=>{zi(s,n),Bt()},onPan:n=>{Au(n),Bt()},getModifiers:()=>({shiftKey:Te,ctrlKey:Io,altKey:bt}),isHoverMode:()=>ui,getHoverTarget:()=>me.hoverTarget,getUiTargetAt:tu}),Qn=new Yc,Qn.initialize(),document.body.appendChild(Qn.getElement());const e=Qn.getElement();e.addEventListener("mouseenter",()=>{Ha=!0}),e.addEventListener("mouseleave",()=>{Ha=!1}),Qn.getElement().addEventListener("select",n=>{const s=n.detail,i=_h(s);if(i){if(Oi&&Ao!==null)pe[Ao]=i;else{mu(i);const o=pe.length-1;Xe.forEach(a=>{Ee[a]=o})}Er(),Oi=!1,Ao=null,vt()}}),js=new Zc({container:document.body,onSelect:n=>{if(!n)return;const s={...n};s.id||(s.id=zt());const i=hn.findIndex(o=>o.id===s.id);i>=0?hn[i]=s:hn.push(s),yi(s.id),on&&wr(),qt()}}),js.initialize(),se.scale=70,se.offsetX=ge.width/2,se.offsetY=ge.height/2,Rs="regular",xt=document.getElementById("context-menu"),window.addEventListener("click",()=>{xt&&(xt.style.display="none")}),xt.addEventListener("mouseleave",()=>{xt.style.display="none"}),Iu()||(Su()||He(),bu()),Ac(),Kt(),Bt()}ge.addEventListener("wheel",yg,{passive:!1});ge.addEventListener("mouseenter",mg);ge.addEventListener("mouseleave",xg);window.addEventListener("contextmenu",Sg);ge.addEventListener("mousemove",_c);ge.addEventListener("mouseup",kc);ge.addEventListener("mousedown",Lc);window.addEventListener("keyup",Nc);window.addEventListener("keydown",Oc);window.addEventListener("resize",Fc);window.addEventListener("beforeunload",()=>{bc()});window.addEventListener("load",wg);

(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const Ai="#3b82f6",Di="#4a5568",ki="#718096",Bl=300,Ri="#242c3a",ws=2,Ja=3,be=9,Li=12,Fl=5,Za=8,We=8,Qa=.9,er=5,ko=[4,4],$l={black:[0,0,0],white:[255,255,255],gray:[128,128,128],red:[255,0,0],green:[0,255,0],blue:[0,0,255],yellow:[255,255,0],magenta:[255,0,255],cyan:[0,255,255],orange:[255,165,0],purple:[128,0,128],brown:[165,42,42],pink:[255,192,203],navy:[0,0,128],maroon:[128,0,0],olive:[128,128,0],teal:[0,128,128],silver:[192,192,192],gold:[255,215,0],indigo:[75,0,130],violet:[238,130,238],crimson:[220,20,60],coral:[255,127,80],turquoise:[64,224,208],khaki:[240,230,140],salmon:[250,128,114],lime:[0,255,0],aqua:[0,255,255],fuchsia:[255,0,255],beige:[245,245,220],tan:[210,180,140],lavender:[230,230,250],chocolate:[210,105,30],forestgreen:[34,139,34],darkblue:[0,0,139],lightgray:[211,211,211],darkred:[139,0,0],lightblue:[173,216,230],lightgreen:[144,238,144]},Vl={rgb:{points:[{pos:0,color:"red",order:1},{pos:.5,color:"green",order:1},{pos:1,color:"blue",order:1}]},jet:{points:[{pos:0,color:[0,0,131],order:1},{pos:.125,color:[0,60,255],order:1},{pos:.375,color:"cyan",order:1},{pos:.625,color:"yellow",order:1},{pos:.875,color:"red",order:1},{pos:1,color:[128,0,0],order:1}]},viridis:{points:[{pos:0,color:[68,1,84],order:1},{pos:.5,color:[33,145,140],order:1},{pos:1,color:[253,231,37],order:1}]},plasma:{points:[{pos:0,color:[13,8,135],order:1},{pos:.25,color:[126,3,168],order:1},{pos:.5,color:[203,70,121],order:1},{pos:.75,color:[248,149,64],order:1},{pos:1,color:[240,249,33],order:1}]},grayscale:{points:[{pos:0,color:[0,0,0],order:1},{pos:1,color:[255,255,255],order:1}]},hot:{points:[{pos:0,color:[0,0,0],order:1},{pos:.33,color:[255,0,0],order:1},{pos:.67,color:[255,255,0],order:1},{pos:1,color:[255,255,255],order:1}]}};class Yl{constructor(t={},n={}){this.state={points:[],selectedPointIds:new Set,lastSelectedPointId:null,activeDrag:{type:null,element:null,pointId:null},transform:{scale:1,offsetX:0,offsetY:0},viewLightness:.5,viewAlpha:1,colorSpace:"RGB_CUBE",undoStack:[],redoStack:[],isMouseInCanvas:!1,isDirty:!1,loadedColormapName:null,loadedColormapType:null,isCyclic:!1,cyclicStateWhenEnabled:null},this.namedColors={},this.customColors={...t},this.namedColormaps={},this.customColormaps={...n},this.clickCount=0,this.lastClickTime=0,this.lastClickTarget=null,this.wrapper=null,this.elements={}}initialize(){try{this.namedColors=$l,this.namedColormaps=Vl,this.initializeDOM(),this.populatePresets(),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.viewLightness=.5,this.state.viewAlpha=1,this.state.loadedColormapName=null,this.state.loadedColormapType=null,this.state.isCyclic=!1,this.state.originalPositions=null,this.setDirty(!1),this.updateTabs(),this.setupCanvases(),this.setupEventListeners(),this.drawAll()}catch(t){console.error("FATAL: Could not initialize ColorEditor.",t),this.wrapper&&(this.wrapper.innerHTML='<div style="padding: 1em; color: #d8000c; background-color: #ffbaba; border: 1px solid; border-radius: 0.5rem; font-family: sans-serif;"><strong>Error:</strong> Could not load critical data files.</div>',this.show())}}hide(){if(!this.wrapper)return;document.querySelectorAll("[data-tick-canvas]").forEach(n=>n.remove()),this.wrapper.style.display="none"}getElement(){return this.wrapper}show(t,n,o=null){if(!this.wrapper)return;t!==void 0&&n!==void 0?(this.wrapper.style.left=`${t}px`,this.wrapper.style.top=`${n}px`,this.wrapper.style.bottom=null,this.wrapper.style.right=null):(this.wrapper.style.left=null,this.wrapper.style.top=null),this.state.points=[],this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.state.undoStack=[],this.state.redoStack=[],this.state.isCyclic=!1,this.state.loadedColormapName=null,this.state.loadedColormapType=null;let i=.5,s=1;if(o&&o.type==="colormap"&&(o.points||o.controlPoints)){this.state.isCyclic=o.isCyclic===!0;let a=JSON.parse(JSON.stringify(o.controlPoints||o.points));if(a.length===1){a[0].pos=.5;const r=a[0].color,c=r[0]/255,l=r[1]/255,d=r[2]/255;i=(c+l+d)/3,s=a[0].alpha!==void 0?a[0].alpha:1}this.state.points=a.map(r=>{const c=r.color,l=r.alpha!==void 0?r.alpha:1;return this.createPointFromRgb(c[0]/255,c[1]/255,c[2]/255,l,r.pos,r.order??1)})}else this.state.points=[];this.state.viewLightness=i,this.state.viewAlpha=s,this.sortPoints(),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[0].id,this.state.selectedPointIds.add(this.state.points[0].id)),this.wrapper.style.display="grid",this.setDirty(!1),requestAnimationFrame(()=>{this.setupCanvases(),this.drawAll()})}createSnapshot(){return{points:JSON.parse(JSON.stringify(this.state.points)),selectedPointIds:Array.from(this.state.selectedPointIds),lastSelectedPointId:this.state.lastSelectedPointId,viewLightness:this.state.viewLightness,viewAlpha:this.state.viewAlpha,colorSpace:this.state.colorSpace,isDirty:this.state.isDirty,loadedColormapName:this.state.loadedColormapName,loadedColormapType:this.state.loadedColormapType,isCyclic:this.state.isCyclic,originalPositions:this.state.originalPositions}}saveState(){this.state.redoStack=[],this.state.undoStack.push(this.createSnapshot())}setDirty(t){this.state.isDirty!==t&&(this.state.isDirty=t)}restoreState(t){Object.assign(this.state,t),this.state.selectedPointIds=new Set(t.selectedPointIds),this.sortPoints(),this.updateTabs(),this.drawAll()}undo(){this.state.undoStack.length!==0&&(this.state.redoStack.push(this.createSnapshot()),this.restoreState(this.state.undoStack.pop()))}redo(){this.state.redoStack.length!==0&&(this.state.undoStack.push(this.createSnapshot()),this.restoreState(this.state.redoStack.pop()))}async loadAllPresets(){const t=async o=>{const i=await fetch(o);if(!i.ok)throw new Error(`Failed to fetch preset file at ${o}: Status ${i.status}`);return await i.json()},n=o=>{try{const i=localStorage.getItem(o);return i?JSON.parse(i):{}}catch{return{}}};[this.namedColors,this.customColors,this.namedColormaps,this.customColormaps]=await Promise.all([t("named_colors.json"),n("custom_colors"),t("named_colormaps.json"),n("custom_colormaps")])}saveCustomPresets(t){const n=new CustomEvent("dataChanged",{detail:{customColors:{...this.customColors},customColormaps:{...this.customColormaps}},bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(n)}async handlePresetClick(t){const{name:n,type:o}=t.dataset;if(o==="named_colors"||o==="custom_colors"){let i;if(o==="named_colors"?i=this.namedColors[n]:i=this.customColors[n]?.rgb,!i){console.error(`RGB undefined for ${n} in ${o}`);return}this.applyColorToSelection(i)}else{if(this.state.isDirty&&n!==this.state.loadedColormapName){const i=await this.showPrompt("You have unsaved changes. Save the current colormap?",["Save","Don't Save","Cancel"]);if(i==="Cancel"||i==="Save"&&!await this.promptAndSaveNewPreset("custom_colormaps",this.state.loadedColormapName||"My Colormap"))return}this.loadColormap(n,o)}}applyColorToSelection(t){this.markAsDirty();const n=t[0]/255,o=t[1]/255,i=t[2]/255;if(this.state.selectedPointIds.size===0){const s=this.state.points.length;s>0&&this.state.points.forEach(c=>{c.pos=c.pos*(s/(s+1))});const a=s===0?.5:1,r=this.createPointFromRgb(n,o,i,1,a,1);this.state.points.push(r),this.sortPoints()}else{this.state.points.forEach(a=>{if(this.state.selectedPointIds.has(a.id)){const r=this.convertRgbToCurrentColorspace(n,o,i);a.hsPos=r.hsPos,a.originalHsPos={...r.hsPos},a.lightness=r.lightness}});const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha)}this.drawAll()}loadColormap(t,n,o=!1){o||this.saveState();const i=n==="named_colormaps"?this.namedColormaps[t]:this.customColormaps[t];if(!i||!i.points){console.error(`Colormap '${t}' not found or is invalid.`);return}const s=i.points.map(a=>{let r=[0,0,0];typeof a.color=="string"?r=this.namedColors[a.color]||this.customColors[a.color]?.rgb||r:Array.isArray(a.color)&&(r=a.color);const c=r[0]/255,l=r[1]/255,d=r[2]/255,h=a.alpha??1;return this.createPointFromRgb(c,l,d,h,a.pos,a.order)});this.state.points=s,this.sortPoints(),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,n==="named_colormaps"?this.state.isCyclic=!1:this.state.isCyclic=i.isCyclic||!1,this.state.loadedColormapName=t,this.state.loadedColormapType=n,this.state.originalPositions=null,this.setDirty(!1),this.state.undoStack=[],this.state.redoStack=[],this.drawAll()}createConstantButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L15,15 L15,8 L25,8 L25,12 L35,12" 
              stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createLinearButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 L20,10 L35,5" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}createCubicButtonIcon(){return`<svg width="100%" height="100%" viewBox="0 0 40 20" style="pointer-events: none;">
        <path d="M5,15 Q15,5 25,10 T35,8" stroke="white" stroke-width="2" fill="none"/>
    </svg>`}initializeDOM(){this.elements={interactiveCanvases:{}};const t=($,A={})=>{const k=document.createElement($);if(A.id){k.id=A.id;const V=A.id.replace(/-(\w)/g,(X,Y)=>Y.toUpperCase());this.elements[V]=k}return A.className&&(k.className=A.className),A.text&&(k.textContent=A.text),A.type&&(k.type=A.type),A.placeholder&&(k.placeholder=A.placeholder),k};this.wrapper=t("div",{id:"colormap-selector-wrapper",className:"color-editor-layout"}),this.wrapper.style.cssText=`
            position: fixed; display: none; z-index: 1000; background-color: #1a202c; 
            padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            bottom: 0.5rem; right: 0.5rem; height: 50vh; max-width: 90vw; min-height: 400px; min-width: 600px;
        `;const n=t("div",{id:"hs-pane-wrapper",className:"preset-wrapper"}),o=t("div",{id:"lightness-wrapper",className:"preset-wrapper"}),i=t("div",{id:"alpha-wrapper",className:"preset-wrapper"});this.elements.colorsPresetsWrapper=t("div",{id:"colors-presets-wrapper",className:"preset-wrapper"}),this.elements.colormapsPresetsWrapper=t("div",{id:"colormaps-presets-wrapper",className:"preset-wrapper"});const s=t("div",{id:"selected-color-section",className:"control-section"}),a=t("div",{id:"current-colormap-section",className:"control-section"}),r=t("div",{className:"panel-header"});this.elements.tabRgbCube=t("button",{id:"tab-rgb-cube",className:"tab-button",text:"RGB Cube"}),this.elements.tabHslCone=t("button",{id:"tab-hsl-cone",className:"tab-button",text:"HSL Di-Cone"}),r.append(this.elements.tabRgbCube,this.elements.tabHslCone);const c=t("div",{id:"hs-canvas-container",className:"canvas-container"}),l=t("div",{id:"hs-nodes-container",className:"absolute top-0 left-0 w-full h-full"});c.append(t("canvas",{id:"hs-bg-canvas"}),l),n.append(r,c);const d=t("h2",{className:"panel-header",text:"Lightness"}),h=t("div",{id:"lightness-slider-container",className:"canvas-container"}),f=t("div",{id:"lightness-nodes-container",className:"absolute top-0 left-0 w-full h-full"});h.append(t("canvas",{id:"lightness-bg-canvas"}),f),o.append(d,h);const u=t("h2",{className:"panel-header",text:"Alpha"}),g=t("div",{id:"alpha-slider-container",className:"canvas-container"}),p=t("div",{id:"alpha-nodes-container",className:"absolute top-0 left-0 w-full h-full"});g.append(t("canvas",{id:"alpha-bg-canvas"}),p),i.append(u,g);const y=t("div",{className:"preset-category-header"});y.append(t("span",{className:"preset-category-title",text:"Colors"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colorsPresetsWrapper.append(y,t("div",{className:"preset-items-container"}));const x=t("div",{className:"preset-category-header"});x.append(t("span",{className:"preset-category-title",text:"Colormaps"}),t("button",{className:"add-preset-btn",text:"+"})),this.elements.colormapsPresetsWrapper.append(x,t("div",{className:"preset-items-container"}));const m=t("h3",{className:"section-title",text:"Selected Color"}),S=t("div",{className:"preview-container"});S.append(t("canvas",{id:"selected-color-preview-canvas"}));const I=t("div",{className:"space-y-2"}),b=t("div",{className:"values-grid"});b.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;";const M=t("div");M.append(t("h3",{className:"input-label",text:"Lightness"}),t("input",{type:"text",id:"lightness-input",className:"value-input"}));const C=t("div");C.append(t("h3",{className:"input-label",text:"Alpha"}),t("input",{type:"text",id:"alpha-input",className:"value-input"}));const w=t("div");w.append(t("h3",{className:"input-label",text:"Position"}),t("input",{type:"text",id:"position-input",className:"value-input"})),b.append(M,C,w),this.elements.rgbInputsContainer=t("div",{id:"rgb-inputs-container"}),this.elements.rgbInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const _=t("input",{type:"text",id:"rgb-r-input",placeholder:"R",className:"value-input"}),T=t("input",{type:"text",id:"rgb-g-input",placeholder:"G",className:"value-input"}),v=t("input",{type:"text",id:"rgb-b-input",placeholder:"B",className:"value-input"});this.elements.rgbInputsContainer.append(_,T,v),this.elements.hslInputsContainer=t("div",{id:"hsl-inputs-container",className:"hidden"}),this.elements.hslInputsContainer.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; margin-top: 0.25rem;";const E=t("input",{type:"text",id:"hsl-h-input",placeholder:"H",className:"value-input"}),O=t("input",{type:"text",id:"hsl-s-input",placeholder:"S",className:"value-input"});this.elements.hslInputsContainer.append(E,O);const P=t("h3",{className:"input-label",text:"Interpolation"});P.style.cssText="margin-top: 0.25rem; margin-bottom: 0.125rem;";const D=t("div",{className:"interpolation-grid"});D.style.cssText="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;",this.elements.constantButton=t("button",{id:"constant-button",className:"interpolation-button active"}),this.elements.linearButton=t("button",{id:"linear-button",className:"interpolation-button"}),this.elements.cubicButton=t("button",{id:"cubic-button",className:"interpolation-button"}),this.elements.constantButton.innerHTML=this.createConstantButtonIcon(),this.elements.linearButton.innerHTML=this.createLinearButtonIcon(),this.elements.cubicButton.innerHTML=this.createCubicButtonIcon(),D.append(this.elements.constantButton,this.elements.linearButton,this.elements.cubicButton),I.append(b,this.elements.rgbInputsContainer,this.elements.hslInputsContainer,P,D),s.append(m,S,I);const F=t("h3",{className:"section-title text-center",text:"Current Colormap"}),R=t("div",{className:"preview-container"});R.append(t("canvas",{id:"colormap-preview-canvas"}));const B=t("div",{className:"button-container"});this.elements.reverseButton=t("button",{id:"reverse-button",className:"reverse-button",text:"Reverse"}),this.elements.cycleButton=t("button",{id:"cycle-button",className:"cycle-button",text:"Cycle"}),this.elements.closeButton=t("button",{id:"close-button",className:"close-button",text:"Close"}),this.elements.selectButton=t("button",{id:"select-button",className:"select-button",text:"Select"});const L=t("div",{className:"button-row"});L.append(this.elements.reverseButton,this.elements.cycleButton),B.append(L,this.elements.closeButton,this.elements.selectButton),a.append(F,R,B),this.elements.modalOverlay=t("div",{id:"modal-overlay",className:"modal-overlay hidden"});const N=t("div",{id:"modal-dialog",className:"modal-dialog"});N.append(t("h3",{id:"modal-title",className:"modal-title"}),t("div",{id:"modal-input-container",className:"hidden"}),t("div",{id:"modal-buttons",className:"modal-buttons"})),N.querySelector("#modal-input-container").append(t("input",{type:"text",id:"modal-input",className:"modal-input"})),this.elements.modalOverlay.append(N),this.elements.contextMenu=t("div",{id:"context-menu",className:"context-menu hidden"}),this.wrapper.append(n,o,this.elements.colorsPresetsWrapper,s,i,this.elements.colormapsPresetsWrapper,a,this.elements.modalOverlay,this.elements.contextMenu),this.createInteractiveCanvas(l,"hs"),this.createInteractiveCanvas(f,"lightness"),this.createInteractiveCanvas(p,"alpha")}reverseColormap(){this.state.points.length!==0&&(this.markAsDirty(),this.state.points.forEach(t=>{t.pos=1-t.pos}),this.sortPoints(),this.drawAll())}setupEventListeners(){this.elements.tabRgbCube.addEventListener("click",()=>this.setColorSpace("RGB_CUBE")),this.elements.tabHslCone.addEventListener("click",()=>this.setColorSpace("HSL_DI_CONE")),this.wrapper.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),i.target.closest(".interactive-canvas")&&this.deselectAll()}),document.addEventListener("click",()=>this.hideContextMenu()),new ResizeObserver(()=>this.setupCanvases()).observe(this.wrapper),Object.values(this.elements.interactiveCanvases).forEach(i=>{i.addEventListener("mouseenter",()=>{this.state.isMouseInCanvas=!0}),i.addEventListener("mouseleave",()=>{this.state.isMouseInCanvas=!1})}),this.elements.hsNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"hs")),this.elements.lightnessNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"lightness")),this.elements.alphaNodesContainer.addEventListener("mousedown",i=>this.handleMouseDown(i,"alpha")),document.addEventListener("keydown",i=>this.handleKeyDown(i)),this.elements.lightnessInput.addEventListener("change",i=>this.handleInputChange(i,"lightness")),this.elements.alphaInput.addEventListener("change",i=>this.handleInputChange(i,"alpha")),this.elements.positionInput.addEventListener("change",i=>this.handleInputChange(i,"position")),this.elements.constantButton.addEventListener("click",()=>this.setInterpolationMode(0)),this.elements.linearButton.addEventListener("click",()=>this.setInterpolationMode(1)),this.elements.cubicButton.addEventListener("click",()=>this.setInterpolationMode(3));const n=()=>this.handleColorInputChange();this.elements.rgbRInput.addEventListener("change",n),this.elements.rgbGInput.addEventListener("change",n),this.elements.rgbBInput.addEventListener("change",n),this.elements.hslHInput.addEventListener("change",n),this.elements.hslSInput.addEventListener("change",n);const o=i=>{const s=i.target.closest(".preset-item");s&&(i.type==="click"?this.handlePresetClick(s):i.type==="contextmenu"&&s.dataset.custom==="true"&&(i.preventDefault(),i.stopPropagation(),this.showContextMenu(i,s.dataset.name,s.dataset.type)))};this.elements.colorsPresetsWrapper.addEventListener("click",o),this.elements.colorsPresetsWrapper.addEventListener("contextmenu",o),this.elements.colormapsPresetsWrapper.addEventListener("click",o),this.elements.colormapsPresetsWrapper.addEventListener("contextmenu",o),this.elements.reverseButton.addEventListener("click",()=>{this.reverseColormap()}),this.elements.cycleButton.addEventListener("click",()=>{this.toggleCycle()}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{let i=[];const s=this.state.points,a=s.length,r=(u,g)=>{const p=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),y=this.clampColor(p);return{pos:parseFloat((g!==void 0?g:u.pos).toFixed(6)),alpha:parseFloat(u.alpha.toFixed(4)),color:[y.r,y.g,y.b],order:u.order}};if(a>0){const u=this.state.isCyclic?a:a-1;for(let g=0;g<u;g++){const p=s[g],y=s[(g+1)%a];i.push(r(p));const x=Math.max(p.order,y.order);if(x===0){let m=p.pos,S=y.pos;this.state.isCyclic&&S<m&&(S+=1);const I=m+(S-m)*.5;i.push(r(p,this.wrapPositionCyclic(I-1e-6))),i.push(r(y,this.wrapPositionCyclic(I)))}else if(x===3){const S=p.pos;let I=y.pos;this.state.isCyclic&&I<S&&(I+=1);const b=I-S;for(let M=1;M<16;M++){const C=M/16,w=S+C*b,_=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(w));if(_){const T=this.abstractToRgb(_.u,_.v,_.lightness),v=this.clampColor(T);i.push({pos:parseFloat(this.wrapPositionCyclic(w).toFixed(6)),alpha:parseFloat(_.alpha.toFixed(4)),color:[v.r,v.g,v.b],order:_.order})}}}}this.state.isCyclic||i.push(r(s[a-1]))}const c=new Map;i.forEach(u=>c.set(u.pos,u));let l=Array.from(c.values()).sort((u,g)=>u.pos-g.pos);if(this.state.isCyclic&&l.length>0){const u=l[0];l[l.length-1].pos<1-1e-6&&l.push({...u,pos:1})}const d=this.state.points.map(u=>{const g=this.abstractToRgb(u.hsPos.u,u.hsPos.v,u.lightness),p=this.clampColor(g);return{pos:parseFloat(u.pos.toFixed(4)),alpha:parseFloat(u.alpha.toFixed(4)),color:[p.r,p.g,p.b],order:u.order}}),h={points:l,controlPoints:d,isCyclic:this.state.isCyclic},f=new CustomEvent("select",{detail:h,bubbles:!0,cancelable:!0});this.wrapper.dispatchEvent(f)})}setInterpolationMode(t){this.state.selectedPointIds.size!==0&&(this.markAsDirty(),this.state.points.forEach(n=>{this.state.selectedPointIds.has(n.id)&&(n.order=t)}),this.elements.constantButton.classList.toggle("active",t===0),this.elements.linearButton.classList.toggle("active",t===1),this.elements.cubicButton.classList.toggle("active",t===3),this.drawAll())}showContextMenu(t,n,o){this.hideContextMenu();const i=this.elements.contextMenu;i.innerHTML="";const s={Rename:()=>this.handlePresetAction("rename",n,o),Delete:()=>this.handlePresetAction("delete",n,o)};for(const[a,r]of Object.entries(s)){const c=document.createElement("button");c.className="context-menu-item",c.textContent=a,c.onclick=r,i.appendChild(c)}i.style.left=`${t.clientX}px`,i.style.top=`${t.clientY}px`,i.classList.remove("hidden")}hideContextMenu(){this.elements.contextMenu.classList.add("hidden")}async handlePresetAction(t,n,o){if(this.hideContextMenu(),t==="delete")await this.showPrompt(`Delete "${n}"?`,["Delete","Cancel"])==="Delete"&&(o==="custom_colors"&&delete this.customColors[n],o==="custom_colormaps"&&delete this.customColormaps[n],this.saveCustomPresets(o),this.populatePresets());else if(t==="rename"){const i=await this.showPrompt(`Rename "${n}"`,["Rename","Cancel"],{value:n});if(i&&i!==n){const s=o==="custom_colors"?this.customColors:this.customColormaps;if(s[i]){this.showPrompt(`"${i}" already exists.`,["OK"]);return}s[i]=s[n],delete s[n],this.saveCustomPresets(o),this.populatePresets()}}}async promptAndSaveNewPreset(t,n=""){const o=await this.showPrompt("Save as:",["Save","Cancel"],{placeholder:"Enter a name",value:n});if(!o)return!1;if(t==="custom_colors"){const i=this.getLastSelectedPoint();if(!i)return!1;const s=this.abstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness),a=this.clampColor(s);this.customColors[o]={rgb:[a.r,a.g,a.b],alpha:i.alpha}}else{const i=this.state.points.map(s=>{const a=this.abstractToRgb(s.hsPos.u,s.hsPos.v,s.lightness),r=this.clampColor(a);return{pos:s.pos,alpha:s.alpha,color:[r.r,r.g,r.b],order:s.order}});this.customColormaps[o]={points:i,isCyclic:this.state.isCyclic},this.state.loadedColormapName=o,this.state.loadedColormapType=t,this.setDirty(!1)}return this.saveCustomPresets(t),this.populatePresets(),!0}markAsDirty(){this.setDirty(!0),this.saveState()}populatePresets(){this.elements.colorsPresetsWrapper.innerHTML="",this.elements.colormapsPresetsWrapper.innerHTML="";const t=(s,a)=>{const r=document.createElement("div");r.className="preset-category-header";const c=document.createElement("div");c.className="preset-category-title",c.textContent=s;const l=document.createElement("button");return l.className="add-preset-btn",l.textContent="+",l.onclick=a,r.appendChild(c),r.appendChild(l),r},n=(s,a,r,c)=>{Object.keys(a).sort().forEach(l=>{const d=document.createElement("div");d.className="preset-item",d.dataset.name=l,d.dataset.type=r,d.dataset.custom=c;const h=document.createElement("canvas");h.className="preset-icon",r.includes("colormap")?(h.width=64,h.height=16):(h.width=16,h.height=16);const f=document.createElement("span");if(f.textContent=l,d.appendChild(h),d.appendChild(f),s.appendChild(d),r==="named_colors"||r==="custom_colors"){const u=a[l],g=c?u.rgb:u;this.drawColorIcon(h,g)}else this.drawColormapIcon(h,a[l].points,this.namedColors,this.customColors)})},o=document.createElement("div");o.className="preset-items-container",this.elements.colorsPresetsWrapper.appendChild(t("Colors",()=>this.promptAndSaveNewPreset("custom_colors"))),this.elements.colorsPresetsWrapper.appendChild(o),n(o,this.namedColors,"named_colors",!1),n(o,this.customColors,"custom_colors",!0);const i=document.createElement("div");i.className="preset-items-container",this.elements.colormapsPresetsWrapper.appendChild(t("Colormaps",()=>this.promptAndSaveNewPreset("custom_colormaps"))),this.elements.colormapsPresetsWrapper.appendChild(i),n(i,this.namedColormaps,"named_colormaps",!1),n(i,this.customColormaps,"custom_colormaps",!0)}drawColormapIcon(t,n,o,i){const s=n.map(d=>{let h=[0,0,0];typeof d.color=="string"?h=o[d.color]||(i[d.color]?i[d.color].rgb:[0,0,0]):Array.isArray(d.color)&&(h=d.color);const{hsPos:f,lightness:u}=this.convertRgbToCurrentColorspace(h[0]/255,h[1]/255,h[2]/255);return{id:Math.random(),hsPos:f,originalHsPos:{...f},lightness:u,alpha:d.alpha??1,pos:d.pos,order:1}}).sort((d,h)=>d.pos-h.pos),a=this.state.points;this.state.points=s;const r=t.getContext("2d"),{width:c,height:l}=t;if(this.drawCheckerboard(r),this.state.points.length>0)for(let d=0;d<c;d++){const h=d/(c-1),f=this.getInterpolatedPropertiesAt(h);if(!f)continue;const u=this.clampAbstractPoint(f.u,f.v,f.lightness),g=this.abstractToRgb(u.u,u.v,f.lightness),{r:p,g:y,b:x}=this.clampColor(g);r.fillStyle=`rgba(${p}, ${y}, ${x}, ${f.alpha})`,r.fillRect(d,0,1,l)}this.state.points=a}showPrompt(t,n,o=null){return new Promise(i=>{const{modalOverlay:s,modalTitle:a,modalInputContainer:r,modalInput:c,modalButtons:l}=this.elements,d=document.querySelectorAll("[data-tick-canvas]");d.forEach(h=>h.style.display="none"),a.textContent=t,l.innerHTML="",o?(c.value=o.value||"",c.placeholder=o.placeholder||"",r.classList.remove("hidden")):r.classList.add("hidden"),n.forEach(h=>{const f=document.createElement("button");f.className=`modal-button ${h==="Save"||h==="Delete"||h==="Rename"?"modal-button-primary":"modal-button-secondary"}`,f.textContent=h,f.onclick=()=>{s.classList.add("hidden"),d.forEach(u=>u.style.display=""),i(o?c.value:h)},l.appendChild(f)}),s.classList.remove("hidden"),o&&c.focus()})}restoreOriginalPositions(){for(const t of this.state.originalPositions){const n=this.state.points.find(o=>o.id===t.id);n&&(n.pos=t.pos)}}toggleCycle(){if(this.state.points.length!==0){if(this.state.isCyclic)this.state.originalPositions&&!this.state.isDirty?(this.restoreOriginalPositions(),this.state.originalPositions=null,this.state.isCyclic=!1):(this.state.originalPositions=null,this.state.isCyclic=!1),this.state.cyclicStateWhenEnabled=null;else{const t=this.state.points.some(o=>Math.abs(o.pos)<1e-6),n=this.state.points.some(o=>Math.abs(o.pos-1)<1e-6);if(t&&n){this.state.originalPositions=this.state.points.map(s=>({id:s.id,pos:s.pos}));const i=1-1/this.state.points.length;this.state.points.forEach(s=>{s.pos*=i})}else this.state.originalPositions=null;this.state.isCyclic=!0,this.state.cyclicStateWhenEnabled=this.createSnapshot()}this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.drawAll()}}drawColorIcon(t,n){const o=t.getContext("2d");o.fillStyle=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,o.fillRect(0,0,t.width,t.height)}createPointFromRgb(t,n,o,i,s,a){const{hsPos:r,lightness:c}=this.convertRgbToCurrentColorspace(t,n,o);return{id:Date.now()+Math.random(),hsPos:r,originalHsPos:{...r},lightness:c,alpha:i,pos:s,order:a}}convertRgbToCurrentColorspace(t,n,o){if(this.state.colorSpace==="RGB_CUBE")return{hsPos:this.rgbCubeRgbToAbstract({r:t,g:n,b:o}),lightness:(t+n+o)/3};{const i=this.rgbToHsl(t,n,o);return{hsPos:this.rgbToHslDiConeAbstract(t,n,o),lightness:i.l}}}sortPoints(){this.state.points.sort((t,n)=>t.pos-n.pos||t.id-n.id)}deselectAll(){this.state.selectedPointIds.size>0&&(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}setupCanvases(){const t=this.elements.interactiveCanvases.lightness,n=this.elements.interactiveCanvases.alpha;[{c:this.elements.lightnessBgCanvas,container:this.elements.lightnessBgCanvas.parentElement},{c:t,container:t.parentElement},{c:this.elements.alphaBgCanvas,container:this.elements.alphaBgCanvas.parentElement},{c:n,container:n.parentElement},{c:this.elements.colormapPreviewCanvas,container:this.elements.colormapPreviewCanvas.parentElement},{c:this.elements.selectedColorPreviewCanvas,container:this.elements.selectedColorPreviewCanvas.parentElement}].forEach(l=>{if(!l.c||!l.container)return;const{clientWidth:d,clientHeight:h}=l.container;(l.c.width!==d||l.c.height!==h)&&(l.c.width=d,l.c.height=h)});const i=this.elements.hsBgCanvas,s=this.elements.interactiveCanvases.hs,a=i.parentElement,r=a.clientWidth,c=a.clientHeight;[i,s].forEach(l=>{l&&(l.width=r,l.height=c,l.style.width=`${r}px`,l.style.height=`${c}px`,l.style.left="0px",l.style.top="0px")}),this.drawAll()}setColorSpace(t){const n=this.state.colorSpace;if(t===n)return;this.markAsDirty(),this.state.points.forEach(i=>{let s;n==="RGB_CUBE"?s=this.rgbCubeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness):s=this.hslDiConeAbstractToRgb(i.hsPos.u,i.hsPos.v,i.lightness);let a,r;if(t==="RGB_CUBE")a=this.rgbCubeRgbToAbstract(s),r=(s.r+s.g+s.b)/3;else{const c=this.rgbToHsl(s.r,s.g,s.b);a=this.rgbToHslDiConeAbstract(s.r,s.g,s.b),r=c.l}i.hsPos=a,i.originalHsPos={...a},i.lightness=r});const o=this.getLastSelectedPoint();o&&(this.state.viewLightness=o.lightness,this.state.viewAlpha=o.alpha),this.state.colorSpace=t,this.updateTabs(),this.drawAll()}handleMouseDown(t,n){if(t.button===2)return;t.preventDefault(),t.stopPropagation();const o=Date.now(),i=this.elements.interactiveCanvases[n];if(!i)return;const s=i.getBoundingClientRect(),a=i.width/s.width,r=i.height/s.height,c=(t.clientX-s.left)*a,l=(t.clientY-s.top)*r,d={x:c,y:l};let h=!1,f=null,u=!1;if(n==="hs")f=this.findHitPointHS(c,l);else{const x=this.findHitPointSlider(c,l,n);f=x.hitPoint,u=x.hitLine}if(o-this.lastClickTime<Bl&&f&&f.id===this.lastClickTarget?this.clickCount++:this.clickCount=1,this.lastClickTime=o,this.lastClickTarget=f?f.id:null,f){this.state.viewLightness=f.lightness,this.state.viewAlpha=f.alpha;const x=t.ctrlKey||t.metaKey,m=t.shiftKey;!this.state.selectedPointIds.has(f.id)&&!x&&!m&&(this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(f.id),this.state.lastSelectedPointId=f.id)}if(this.state.activeDrag.type=n,this.state.activeDrag.element=i,this.state.activeDrag.pointId=f?f.id:null,f){const x=new Map;if(n==="hs"){this.state.activeDrag.startX=c,this.state.activeDrag.startY=l,this.state.activeDrag.initialPointPositions=new Map;const{scale:m,offsetX:S,offsetY:I}=this.state.transform;this.state.points.forEach(b=>{if(this.state.selectedPointIds.has(b.id)){const M=b.hsPos.u*m+S,C=b.hsPos.v*m+I;this.state.activeDrag.initialPointPositions.set(b.id,{x:M,y:C})}})}else this.state.points.forEach(m=>{this.state.selectedPointIds.has(m.id)&&x.set(m.id,{lightness:m.lightness-f.lightness,alpha:m.alpha-f.alpha,pos:m.pos-f.pos})}),this.state.activeDrag.offsets=x}else u?this.state.activeDrag.type=n+"-line":(this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null);this.drawAll();const p=x=>{const m=(x.clientX-s.left)*a,S=(x.clientY-s.top)*r,I=Math.sqrt((m-d.x)**2+(S-d.y)**2);!h&&I>Fl&&(h=!0,f&&this.markAsDirty()),this.state.activeDrag.type&&this.handleMouseMove(x)},y=x=>{document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",y),h||this.handleClick(c,l,n,f,x),this.state.activeDrag={type:null,element:null,pointId:null,offsets:null}};document.addEventListener("mousemove",p),document.addEventListener("mouseup",y)}handleClick(t,n,o,i,s){const{shiftKey:a,ctrlKey:r,metaKey:c}=s,l=r||c;if(i){const{selectedPointIds:d}=this.state,h=i.id;if(this.clickCount===3)this.state.points.forEach(f=>d.add(f.id)),this.state.lastSelectedPointId=h;else if(this.clickCount===2){const f=this.state.points.findIndex(g=>g.id===h);d.clear(),[f-1,f,f+1].forEach(g=>{g>=0&&g<this.state.points.length&&d.add(this.state.points[g].id)}),this.state.lastSelectedPointId=h}else l?d.has(h)?(d.delete(h),this.state.lastSelectedPointId===h&&(this.state.lastSelectedPointId=d.size>0?Array.from(d)[0]:null)):(d.add(h),this.state.lastSelectedPointId=h):a?(d.add(h),this.state.lastSelectedPointId=h):(d.clear(),d.add(h),this.state.lastSelectedPointId=h)}else if(o==="hs")this.createNewPointHS(t,n);else if(o==="lightness"||o==="alpha"){const d=this.elements.interactiveCanvases[o],h=Math.ceil(be*2.2),f=d.height-2*h,g=(d.height-h-n)/f,p=Math.max(0,Math.min(1,g));o==="lightness"?this.state.viewLightness=p:this.state.viewAlpha=p}this.drawAll()}findHitPointHS(t,n){const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=s,c=this.elements.hsBgCanvas.width-s-o,l=this.elements.hsBgCanvas.height-s-o;for(const d of this.state.points){const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-be&&h<=a+c+be&&f>=r-be&&f<=r+l+be&&Math.sqrt((t-h)**2+(n-f)**2)<=Li)return d}return null}handleInputChange(t,n){const o=t.target.value;if(this.state.selectedPointIds.size===0)return;let i=!1;if(n==="lightness"||n==="alpha"){const s=parseFloat(o);!isNaN(s)&&s>=0&&s<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a[n]=s,n==="lightness"&&this.constrainPointToValidArea(a))}),i=!0)}else if(n==="position"){const s=parseFloat(o);!isNaN(s)&&s>=0&&s<=1&&(this.markAsDirty(),this.state.points.forEach(a=>{this.state.selectedPointIds.has(a.id)&&(a.pos=s)}),this.sortPoints(),i=!0)}if(i){const s=this.getLastSelectedPoint();s&&(this.state.viewLightness=s.lightness,this.state.viewAlpha=s.alpha)}this.drawAll()}handleColorInputChange(){if(this.state.selectedPointIds.size===0)return;let t,n,o,i,s,a,r=!1;if(this.state.colorSpace==="RGB_CUBE"){if(t=parseInt(this.elements.rgbRInput.value,10),n=parseInt(this.elements.rgbGInput.value,10),o=parseInt(this.elements.rgbBInput.value,10),isNaN(t)||isNaN(n)||isNaN(o))return;this.markAsDirty(),t=Math.max(0,Math.min(255,t))/255,n=Math.max(0,Math.min(255,n))/255,o=Math.max(0,Math.min(255,o))/255;const c=this.rgbCubeRgbToAbstract({r:t,g:n,b:o}),l=(t+n+o)/3;this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...c},d.originalHsPos={...c},d.lightness=l)}),r=!0}else{if(i=parseFloat(this.elements.hslHInput.value),s=parseFloat(this.elements.hslSInput.value),a=this.state.viewLightness,isNaN(i)||isNaN(s))return;this.markAsDirty(),i=Math.max(0,Math.min(1,i)),s=Math.max(0,Math.min(1,s));const c=this.hslToRgb(i,s,a),l=this.rgbToHslDiConeAbstract(c.r,c.g,c.b);this.state.points.forEach(d=>{this.state.selectedPointIds.has(d.id)&&(d.hsPos={...l},d.originalHsPos={...l})}),r=!0}if(r){const c=this.getLastSelectedPoint();c&&(this.state.viewLightness=c.lightness,this.state.viewAlpha=c.alpha)}this.drawAll()}createInteractiveCanvas(t,n){const o=document.createElement("canvas");o.className=`interactive-canvas ${n}-interactive`,o.dataset.type=n,t.appendChild(o),this.elements.interactiveCanvases[n]=o}handleMouseMove(t){if(!this.state.activeDrag.type)return;t.preventDefault();const{type:n,element:o,pointId:i}=this.state.activeDrag,s=o,a=s.getBoundingClientRect(),r=s.width/a.width,c=s.height/a.height,l=(t.clientX-a.left)*r,d=(t.clientY-a.top)*c;n.endsWith("-line")?this.handleLineDrag(d,s.height,n):i&&this.handlePointDrag(l,d,s,n),this.drawAll()}rgbCubeRgbToAbstract(t){const n=(t.r-t.g)/Math.sqrt(2),o=(t.r+t.g-2*t.b)/Math.sqrt(6);return{u:n,v:o}}rgbToHslDiConeAbstract(t,n,o){const i=this.rgbToHsl(t,n,o),s=1-Math.abs(2*i.l-1),a=i.s*s,r=i.h*2*Math.PI,c=a*Math.cos(r),l=a*Math.sin(r);return{u:c,v:l}}hslDiConeAbstractToRgb(t,n,o){const i=(Math.atan2(n,t)/(2*Math.PI)+1)%1,s=Math.sqrt(t*t+n*n),a=o,r=1-Math.abs(2*a-1);if(r<1e-9)return{r:a,g:a,b:a};const c=s/r;return this.hslToRgb(i,c,a)}updateTabs(){this.elements.tabRgbCube.classList.toggle("active",this.state.colorSpace==="RGB_CUBE"),this.elements.tabHslCone.classList.toggle("active",this.state.colorSpace==="HSL_DI_CONE")}handleKeyDown(t){const n=document.activeElement,o=n&&n.tagName==="INPUT",i=t.ctrlKey||t.metaKey;if(i&&t.key==="z"){t.preventDefault(),this.undo();return}if(i&&t.key==="y"){t.preventDefault(),this.redo();return}if(o){t.key==="Escape"&&(t.preventDefault(),n.blur());return}if(i&&t.key==="a"){t.preventDefault(),this.state.isMouseInCanvas&&(this.state.selectedPointIds.clear(),this.state.points.forEach(s=>this.state.selectedPointIds.add(s.id)),this.state.points.length>0&&(this.state.lastSelectedPointId=this.state.points[this.state.points.length-1].id),this.drawAll());return}if(t.key==="Escape"){t.preventDefault(),this.deselectAll();return}(t.key==="Delete"||t.key==="Backspace")&&this.state.selectedPointIds.size>0&&(this.markAsDirty(),this.state.points=this.state.points.filter(s=>!this.state.selectedPointIds.has(s.id)),this.state.selectedPointIds.clear(),this.state.lastSelectedPointId=null,this.drawAll())}findSnapPosition(t,n,o,i=null){let s=t,a=er+1;const r=Math.ceil(be*2.2),c=Math.ceil(We/2),l=r+c,d=n-l-r,h=n-r;return this.state.points.forEach(f=>{if(f.id===i)return;const u=h-f[o]*d,g=Math.abs(t-u);g<er&&g<a&&(s=u,a=g)}),s}getLastSelectedPoint(){return!this.state.lastSelectedPointId||!this.state.selectedPointIds.has(this.state.lastSelectedPointId)?null:this.state.points.find(t=>t.id===this.state.lastSelectedPointId)}getPointById(t){return this.state.points.find(n=>n.id===t)}drawAll(){this.drawHSSlice(),this.drawSliderBackgrounds(),this.renderNodes(),this.updateUIReadouts()}drawHSSlice(){const{viewLightness:t,viewAlpha:n,colorSpace:o}=this.state,i=this.elements.hsBgCanvas.width,s=this.elements.hsBgCanvas.height;if(i===0||s===0)return;const a=this.elements.hsBgCanvas.getContext("2d");a.fillStyle=Ri,a.fillRect(0,0,i,s);const r=Math.ceil(be*2.2),c=Math.ceil(We/2),l=r+c,d=i-l-r,h=s-l-r;if(d<=0||h<=0)return;const f=o==="RGB_CUBE"?Math.min(d,h)/(Math.sqrt(2/3)*2)*Qa:Math.min(d,h)/2*Qa;this.state.transform.scale=f,this.state.transform.offsetX=i/2,this.state.transform.offsetY=s/2;const u=l,g=l,p=d,y=h,x=We,m=Math.round(p/x),S=Math.round(y/x),I=p/m,b=y/S;for(let T=0;T<S;T++)for(let v=0;v<m;v++){const E=u+v*I,O=g+T*b;(T+v)%2===0?a.fillStyle=ki:a.fillStyle=Di,a.fillRect(E,O,I,b)}if(o==="HSL_DI_CONE"&&1-Math.abs(2*t-1)<.01){const v=i/2,E=s/2,O=t<.5?0:255;a.fillStyle=`rgba(${O}, ${O}, ${O}, ${n})`,a.fillRect(Math.floor(v),Math.floor(E),1,1);return}const M=a.createImageData(p,y),C=M.data;for(let T=0;T<y;T++)for(let v=0;v<p;v++){const E=u+v,O=g+T,P=(E-this.state.transform.offsetX)/this.state.transform.scale,D=(O-this.state.transform.offsetY)/this.state.transform.scale,{r:F,g:R,b:B}=this.abstractToRgb(P,D,t),L=(T*p+v)*4;this.isValidColor(F,R,B)&&(C[L]=Math.round(F*255),C[L+1]=Math.round(R*255),C[L+2]=Math.round(B*255),C[L+3]=255)}const w=document.createElement("canvas");w.width=p,w.height=y,w.getContext("2d").putImageData(M,0,0),a.globalAlpha=n,a.drawImage(w,u,g),a.globalAlpha=1}evaluateCubicSpline(t,n){const o=this.state.points,i=o.length;if(t<0||t>=i)return null;let s,a,r,c;if(this.state.isCyclic){const u=g=>{const p=(g%i+i)%i;return o[p]};t===i-1?(s=u(t-1),a=u(t),r=u(0),c=u(1)):(s=u(t-1),a=u(t),r=u(t+1),c=u(t+2))}else a=o[t],r=o[t+1],s=t>0?o[t-1]:o[t],c=t+2<i?o[t+2]:o[t+1];const l=n,d=l*l,h=d*l,f=(u,g,p,y)=>.5*(2*g+(-u+p)*l+(2*u-5*g+4*p-y)*d+(-u+3*g-3*p+y)*h);return{u:f(s.hsPos.u,a.hsPos.u,r.hsPos.u,c.hsPos.u),v:f(s.hsPos.v,a.hsPos.v,r.hsPos.v,c.hsPos.v),lightness:f(s.lightness,a.lightness,r.lightness,c.lightness),alpha:f(s.alpha,a.alpha,r.alpha,c.alpha),order:2}}isValidColor(t,n,o){return t>=-.001&&t<=1.001&&n>=-.001&&n<=1.001&&o>=-.001&&o<=1.001}drawSliderBackgrounds(){const t=Math.ceil(be*2.2),n=Math.ceil(We/2),o=t+n,i=this.elements.lightnessBgCanvas.getContext("2d"),s=this.elements.lightnessBgCanvas;i.fillStyle=Ri,i.fillRect(0,0,s.width,s.height);const a=o,r=s.width-t,c=o,l=s.height-t,d=r-a,h=l-c;if(h>0&&d>0){const I=i.createLinearGradient(0,c,0,l);I.addColorStop(0,"white"),I.addColorStop(1,"black"),i.fillStyle=I,i.fillRect(a,c,d,h)}const f=this.elements.alphaBgCanvas.getContext("2d"),u=this.elements.alphaBgCanvas;f.fillStyle=Ri,f.fillRect(0,0,u.width,u.height);const g=o,p=u.width-t,y=o,x=u.height-t,m=p-g,S=x-y;if(S>0&&m>0){const I=We,b=Math.round(m/I),M=Math.ceil(S/I),C=m/b,w=I,_=x-M*w;for(let v=0;v<M;v++)for(let E=0;E<b;E++){const O=g+E*C,P=_+v*w;if(P<x&&P+w>y){(v+E)%2===0?f.fillStyle=ki:f.fillStyle=Di;const D=Math.max(P,y),F=Math.min(P+w,x)-D;F>0&&f.fillRect(O,D,C,F)}}const T=f.createLinearGradient(0,y,0,x);T.addColorStop(0,"white"),T.addColorStop(1,"rgba(255,255,255,0)"),f.fillStyle=T,f.fillRect(g,y,m,S)}}renderNodes(){this.drawHSElements(),this.drawLightnessElements(),this.drawAlphaElements()}drawHorizontalLine(t,n){t.strokeStyle=Ai,t.lineWidth=1.5,t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=8,t.beginPath(),t.moveTo(0,n),t.lineTo(t.canvas.width,n),t.stroke(),t.shadowBlur=0}drawHSElements(){const t=this.elements.interactiveCanvases.hs;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=s,c=t.width-s-o,l=t.height-s-o;if(this.state.points.length>1){const d=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let h=0;h<d;h++){const f=this.state.points[h],u=this.state.points[(h+1)%this.state.points.length];if(Math.max(f.order,u.order)===0)continue;let p=f.pos,y=u.pos;this.state.isCyclic&&y<p&&(y+=1);const x=y-p;if(x<1e-9)continue;const m=Math.max(10,Math.ceil(x*100)),S=[];for(let b=0;b<=m;b++){const M=p+b/m*x,C=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(M));if(!C)continue;const w=this.clampAbstractPoint(C.u,C.v,C.lightness),_=w.u*this.state.transform.scale+this.state.transform.offsetX,T=w.v*this.state.transform.scale+this.state.transform.offsetY;S.push({x:_,y:T,isOnPlane:Math.abs(C.lightness-this.state.viewLightness)<1e-10})}if(S.length<2)continue;const I=S.every(b=>b.isOnPlane);n.strokeStyle="black",n.lineWidth=ws,n.globalAlpha=I?.7:.4,n.setLineDash(I?[]:ko),n.beginPath(),n.moveTo(S[0].x,S[0].y);for(let b=1;b<S.length;b++)n.lineTo(S[b].x,S[b].y);n.stroke(),n.setLineDash([])}this.drawLightnessIntersectionDots(n)}n.save(),n.beginPath(),n.rect(a,r,c,l),n.clip(),this.state.points.forEach(d=>{const h=d.hsPos.u*this.state.transform.scale+this.state.transform.offsetX,f=d.hsPos.v*this.state.transform.scale+this.state.transform.offsetY;if(h>=a-be&&h<=a+c+be&&f>=r-be&&f<=r+l+be){const u=this.abstractToRgb(d.hsPos.u,d.hsPos.v,d.lightness),{r:g,g:p,b:y}=this.clampColor(u),x=this.state.selectedPointIds.has(d.id),m=d.id===this.state.lastSelectedPointId,S=Math.abs(d.lightness-this.state.viewLightness)<.01;switch(n.save(),n.beginPath(),d.order){case 0:this._drawCircle(n,h,f,be);break;case 1:this._drawDroplet(n,h,f,be);break;case 3:this._drawTriangle(n,h,f,be);break;default:this._drawCircle(n,h,f,be)}n.globalAlpha=d.alpha,n.fillStyle=`rgb(${g}, ${p}, ${y})`,n.fill(),n.globalAlpha=1,n.strokeStyle=x?Ai:"black",n.lineWidth=m?Ja:ws,n.setLineDash(S?[]:ko),n.stroke(),n.restore()}}),n.restore()}drawLightnessElements(){const t=this.elements.interactiveCanvases.lightness;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=t.width-o,c=s,l=t.height-o,d=r-a,h=l-c;let f=this.state.viewLightness;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="lightness"){const g=this.getPointById(this.state.activeDrag.pointId);g&&(f=g.lightness)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"lightness"),this.drawTicks(n,"lightness"),this.state.points.forEach(g=>{const p=a+g.pos*d,y=l-g.lightness*h,x=this.abstractToRgb(g.hsPos.u,g.hsPos.v,g.lightness),{r:m,g:S,b:I}=this.clampColor(x),b=this.state.selectedPointIds.has(g.id),M=g.id===this.state.lastSelectedPointId;this.drawPoint(n,p,y,m,S,I,b,M,g.order)})}drawConnectingLine(t,n){if(this.state.points.length<2)return;t.save(),t.lineWidth=ws;const o=this.state.points,i=o.length;if(n==="hs"){t.restore();return}const s=Math.ceil(be*2.2),a=Math.ceil(We/2),r=s+a,c=r,l=t.canvas.height-s,d=t.canvas.width-r-s,h=l-r,f=c+d;if(d<=0){t.restore();return}const u=this.state.isCyclic?i:i-1;for(let g=0;g<u;g++){const p=o[g],y=o[(g+1)%i],x=Math.max(p.order,y.order),m=this.state.isCyclic&&g===i-1;if(x===0){const S=l-p[n]*h,I=l-y[n]*h,b=c+p.pos*d,M=c+y.pos*d;if(m&&p.pos>y.pos){let C=p.pos,w=y.pos+1;const _=C+(w-C)*.5,T=c+(_-Math.floor(_))*d,v=this.getInterpolatedPropertiesAt(p.pos),E=this.getInterpolatedPropertiesAt(y.pos);if(v){const O=this.abstractToRgb(v.u,v.v,v.lightness),P=this.clampColor(O);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${v.alpha})`,t.setLineDash([]),_>1?(t.beginPath(),t.moveTo(b,S),t.lineTo(f,S),t.stroke(),t.beginPath(),t.moveTo(c,S),t.lineTo(T,S),t.stroke()):(t.beginPath(),t.moveTo(b,S),t.lineTo(T,S),t.stroke())}if(E){const O=this.abstractToRgb(E.u,E.v,E.lightness),P=this.clampColor(O);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${E.alpha})`,t.setLineDash([]),_>1?(t.beginPath(),t.moveTo(T,I),t.lineTo(M,I),t.stroke()):(t.beginPath(),t.moveTo(T,I),t.lineTo(f,I),t.stroke(),t.beginPath(),t.moveTo(c,I),t.lineTo(M,I),t.stroke())}t.beginPath(),t.setLineDash(ko),t.strokeStyle="black",t.moveTo(T,S),t.lineTo(T,I),t.stroke()}else if(!m){let C=p.pos,w=y.pos;const _=C+(w-C)*.5,T=c+_*d,v=this.getInterpolatedPropertiesAt(p.pos),E=this.getInterpolatedPropertiesAt(y.pos);if(v){const O=this.abstractToRgb(v.u,v.v,v.lightness),P=this.clampColor(O);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${v.alpha})`,t.setLineDash([]);const D=g===0&&!this.state.isCyclic?c:b;t.beginPath(),t.moveTo(D,S),t.lineTo(T,S),t.stroke()}if(E){const O=this.abstractToRgb(E.u,E.v,E.lightness),P=this.clampColor(O);t.strokeStyle=`rgba(${P.r},${P.g},${P.b},${E.alpha})`,t.setLineDash([]);const D=g===u-1&&!this.state.isCyclic?f:M;t.beginPath(),t.moveTo(T,I),t.lineTo(D,I),t.stroke()}t.beginPath(),t.setLineDash(ko),t.strokeStyle="black",t.moveTo(T,S),t.lineTo(T,I),t.stroke()}}else if(t.setLineDash([]),m&&p.pos>y.pos){const S=l-p[n]*h,I=l-y[n]*h,b=c+p.pos*d,M=c+y.pos*d,C=1-p.pos;if(C>1e-6){const w=t.createLinearGradient(b,0,f,0),_=Math.max(2,Math.ceil(C*20));for(let E=0;E<=_;E++){const O=p.pos+E/_*C,P=this.getInterpolatedPropertiesAt(O);if(P){const D=this.abstractToRgb(P.u,P.v,P.lightness),{r:F,g:R,b:B}=this.clampColor(D);w.addColorStop(E/_,`rgba(${F}, ${R}, ${B}, ${P.alpha})`)}}const T=this.getInterpolatedPropertiesAt(1),v=T?l-T[n]*h:S;t.beginPath(),t.moveTo(b,S),t.lineTo(f,v),t.strokeStyle=w,t.stroke()}if(y.pos>1e-6){const w=t.createLinearGradient(c,0,M,0),_=Math.max(2,Math.ceil(y.pos*20));for(let E=0;E<=_;E++){const O=E/_*y.pos,P=this.getInterpolatedPropertiesAt(O);if(P){const D=this.abstractToRgb(P.u,P.v,P.lightness),{r:F,g:R,b:B}=this.clampColor(D);w.addColorStop(E/_,`rgba(${F}, ${R}, ${B}, ${P.alpha})`)}}const T=this.getInterpolatedPropertiesAt(0),v=T?l-T[n]*h:I;t.beginPath(),t.moveTo(c,v),t.lineTo(M,I),t.strokeStyle=w,t.stroke()}}else if(!m){const S=c+p.pos*d,I=c+y.pos*d,b=(M,C,w,_)=>{const T=C-M;if(Math.abs(T)<1e-9)return;const v=t.createLinearGradient(w,0,_,0),E=Math.ceil(Math.abs(_-w)/2);for(let O=0;O<=E;O++){const P=M+O/E*T,D=this.getInterpolatedPropertiesAt(P);if(!D)continue;const F=this.abstractToRgb(D.u,D.v,D.lightness),{r:R,g:B,b:L}=this.clampColor(F);v.addColorStop(O/E,`rgba(${R}, ${B}, ${L}, ${D.alpha})`)}t.beginPath();for(let O=0;O<=E;O++){const P=M+O/E*T,D=this.getInterpolatedPropertiesAt(P);if(!D)continue;const F=Math.max(0,Math.min(1,P)),R=c+F*d,B=l-D[n]*h;O===0?t.moveTo(R,B):t.lineTo(R,B)}t.strokeStyle=v,t.stroke()};if(g===0&&!this.state.isCyclic&&Math.abs(p.pos)>=1e-6){const M=this.getInterpolatedPropertiesAt(p.pos);if(M){const C=this.abstractToRgb(M.u,M.v,M.lightness),{r:w,g:_,b:T}=this.clampColor(C);t.strokeStyle=`rgba(${w}, ${_}, ${T}, ${M.alpha})`;const v=l-M[n]*h;t.beginPath(),t.moveTo(c,v),t.lineTo(S,v),t.stroke()}}if(b(p.pos,y.pos,S,I),g===u-1&&!this.state.isCyclic&&Math.abs(y.pos-1)>=1e-6){const M=this.getInterpolatedPropertiesAt(y.pos);if(M){const C=this.abstractToRgb(M.u,M.v,M.lightness),{r:w,g:_,b:T}=this.clampColor(C);t.strokeStyle=`rgba(${w}, ${_}, ${T}, ${M.alpha})`;const v=l-M[n]*h;t.beginPath(),t.moveTo(I,v),t.lineTo(f,v),t.stroke()}}}}t.restore()}shouldDrawDirectPath(t,n){const o=t.lightness<.05||t.lightness>.95,i=n.lightness<.05||n.lightness>.95;if(o&&i)return!0;const s=10;for(let a=0;a<=s;a++){const r=a/s,c=t.hsPos.u+(n.hsPos.u-t.hsPos.u)*r,l=t.hsPos.v+(n.hsPos.v-t.hsPos.v)*r,d=t.lightness+(n.lightness-t.lightness)*r,h=this.abstractToRgb(c,l,d);if(!this.isValidColor(h.r,h.g,h.b))return!1}return!0}drawInterpolatedPath(t,n,o,i){const s=o.pos-n.pos;if(s<1e-6)return;const a=Math.max(2,Math.ceil(s*t.canvas.width/4));let r=!1;for(let c=0;c<=a;c++){const l=n.pos+c/a*s,d=this.getInterpolatedPropertiesAt(l);if(!d)continue;const h=this.clampAbstractPoint(d.u,d.v,d.lightness),f=h.u*this.state.transform.scale+this.state.transform.offsetX,u=h.v*this.state.transform.scale+this.state.transform.offsetY;!r||c===0?(t.moveTo(f,u),r=!0):t.lineTo(f,u)}}drawHSSegment(t,n,o,i,s){let a=n.pos,r=o.pos;this.state.isCyclic&&r<a&&(r+=1);const c=r-a;if(c<1e-6&&!this.state.isCyclic)return;const l=Math.max(10,Math.ceil(c*t.canvas.width/8)),d=[];for(let f=0;f<=l;f++){const u=a+f/l*c,g=this.getInterpolatedPropertiesAt(this.wrapPositionCyclic(u));if(!g)continue;const p=this.clampAbstractPoint(g.u,g.v,g.lightness),y=p.u*this.state.transform.scale+this.state.transform.offsetX,x=p.v*this.state.transform.scale+this.state.transform.offsetY,m=Math.abs(g.lightness-this.state.viewLightness)<1e-10;d.push({x:y,y:x,isOnPlane:m,u:p.u,v:p.v})}if(d.length<2)return;if(d.every(f=>f.isOnPlane)){t.strokeStyle="black",t.lineWidth=ws,t.setLineDash([]),t.globalAlpha=.7,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let f=1;f<d.length;f++)t.lineTo(d[f].x,d[f].y);t.stroke()}else{t.strokeStyle="black",t.lineWidth=ws,t.globalAlpha=.4;const f=Math.sqrt((o.hsPos.u-n.hsPos.u)**2+(o.hsPos.v-n.hsPos.v)**2),u=((n.hsPos.u*73+n.hsPos.v*127)*50+f*100)%8;t.setLineDash([4,4]),t.lineDashOffset=u,t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let g=1;g<d.length;g++)t.lineTo(d[g].x,d[g].y);t.stroke(),t.lineDashOffset=0}t.setLineDash([]),t.globalAlpha=.7}drawLightnessIntersectionDots(t,n){const o=this.state.isCyclic?this.state.points.length:this.state.points.length-1;for(let i=0;i<o;i++){const s=this.state.points[i],a=this.state.points[(i+1)%this.state.points.length];if(Math.max(s.order,a.order)===0)continue;const c=Math.abs(s.lightness-this.state.viewLightness)<1e-10,l=Math.abs(a.lightness-this.state.viewLightness)<1e-10;if(c&&l)continue;const d=s.lightness,h=a.lightness,f=this.state.viewLightness;if(d<f&&h>f||d>f&&h<f){const u=this.findLightnessIntersection(s,a,f);if(u!==null){let g=a.pos-s.pos;this.state.isCyclic&&a.pos<s.pos&&(g+=1);const p=s.pos+u*g,y=this.getInterpolatedPropertiesAt(p);if(!y)continue;const x=this.clampAbstractPoint(y.u,y.v,y.lightness),m=x.u*this.state.transform.scale+this.state.transform.offsetX,S=x.v*this.state.transform.scale+this.state.transform.offsetY;t.fillStyle="black",t.beginPath(),t.arc(m,S,2.5,0,2*Math.PI),t.fill()}}}}findLightnessIntersection(t,n,o){const i=t.lightness,s=n.lightness;if(Math.abs(s-i)<1e-10)return null;if(Math.max(t.order,n.order)===1){const h=(o-i)/(s-i);return h>0&&h<1?h:null}let r=0,c=1;const l=25;for(let h=0;h<l;h++){const f=(r+c)/2,u=t.pos+(n.pos-t.pos)*f,g=this.getInterpolatedPropertiesAt(u);if(!g)break;if(Math.abs(g.lightness-o)<1e-10)return f;g.lightness<o?s>i?r=f:c=f:s>i?c=f:r=f}const d=(r+c)/2;return d>.01&&d<.99?d:null}drawTicks(t,n){if(this.wrapper.style.display==="none")return;const o=t.canvas,i=Math.ceil(be*2.2),s=Math.ceil(We/2),a=i+s;t.save(),t.strokeStyle="white",t.lineWidth=1;const r=a,c=o.width-i,l=a,d=o.height-i,h=c-r,f=d-l;this.clearTickLabels(o);const u=[0,.2,.4,.6,.8,1],g=["0","0.2","0.4","0.6","0.8","1"],p=o.getBoundingClientRect(),y=window.pageXOffset||document.documentElement.scrollLeft,x=window.pageYOffset||document.documentElement.scrollTop;for(let m=0;m<u.length;m++){const S=u[m],I=Math.floor(r+S*h)+.5;S===0?(t.beginPath(),t.moveTo(I,l),t.lineTo(I,d+5),t.stroke()):(t.beginPath(),t.moveTo(I,d),t.lineTo(I,d+5),t.stroke());const b=p.left+y+I,M=p.top+x+d+8;this.createKaTeXLabel(g[m],b,M,"bottom",o)}for(let m=0;m<u.length;m++){const S=u[m],I=Math.floor(d-S*f)+.5;S===0?(t.beginPath(),t.moveTo(r-5,I),t.lineTo(c,I),t.stroke()):(t.beginPath(),t.moveTo(r-5,I),t.lineTo(r,I),t.stroke());const b=p.left+y+r-8,M=p.top+x+I;this.createKaTeXLabel(g[m],b,M,"left",o)}t.restore()}clearTickLabels(t){document.querySelectorAll(`[data-tick-canvas="${t.dataset.type}"]`).forEach(o=>o.remove())}createKaTeXLabel(t,n,o,i,s){if(this.wrapper.style.display!=="none"){if(typeof katex>"u"){const a=document.createElement("div");a.textContent=t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${o}px;
            color: white;
            font-size: 10px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=s.dataset.type,document.body.appendChild(a);return}try{const a=document.createElement("div");a.style.cssText=`
            position: absolute;
            left: ${n}px;
            top: ${o}px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 1001;
            transform: ${i==="left"?"translate(-100%, -50%)":"translate(-50%, 0)"};
        `,a.dataset.tickCanvas=s.dataset.type,katex.render(t,a,{throwOnError:!1,displayMode:!1}),document.body.appendChild(a)}catch(a){console.warn("KaTeX rendering failed:",a),this.createKaTeXLabel(t.replace(/\\frac\{(\d+)\}\{(\d+)\}/,"$1/$2"),n,o,i,s)}}}drawAlphaElements(){const t=this.elements.interactiveCanvases.alpha;if(!t)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=t.width-o,c=s,l=t.height-o,d=r-a,h=l-c;let f=this.state.viewAlpha;if(this.state.activeDrag.pointId&&this.state.activeDrag.type==="alpha"){const g=this.getPointById(this.state.activeDrag.pointId);g&&(f=g.alpha)}const u=l-f*h;this.drawHorizontalLine(n,u),this.drawConnectingLine(n,"alpha"),this.drawTicks(n,"alpha"),this.state.points.forEach(g=>{const p=a+g.pos*d,y=l-g.alpha*h,x=this.abstractToRgb(g.hsPos.u,g.hsPos.v,g.lightness),{r:m,g:S,b:I}=this.clampColor(x),b=this.state.selectedPointIds.has(g.id),M=g.id===this.state.lastSelectedPointId;this.drawPoint(n,p,y,m,S,I,b,M,g.order)})}_drawCircle(t,n,o,i){t.arc(n,o,i,0,2*Math.PI)}_drawJoukowsky(t,n,o,i,s){const r=[];let c=1/0,l=-1/0,d=1/0,h=-1/0;for(let x=0;x<=50;x++){const m=x/50*2*Math.PI,S=Math.cos(m),I=Math.sin(m),b=1-s+s*S,M=s*I,C=b*b+M*M;if(Math.abs(C)<1e-9)continue;const w=s*I-s*I/C,_=s*S+b/C;r.push({x:w,y:_}),w<c&&(c=w),w>l&&(l=w),_<d&&(d=_),_>h&&(h=_)}const f=h-d,u=i*2.5/f,g=(l+c)/2,p=(h+d)/2;t.beginPath();const y=r[0];t.moveTo(n+(y.x-g)*u,o-(y.y-p)*u);for(let x=1;x<r.length;x++){const m=r[x];t.lineTo(n+(m.x-g)*u,o-(m.y-p)*u)}t.closePath()}_drawDroplet(t,n,o,i){this._drawJoukowsky(t,n,o,i,.6666666666666666)}_drawTriangle(t,n,o,i){const s=i*1.4;t.moveTo(n,o-s),t.lineTo(n+s*Math.sqrt(3)/2,o+s/2),t.lineTo(n-s*Math.sqrt(3)/2,o+s/2),t.closePath()}drawPoint(t,n,o,i,s,a,r,c,l){switch(t.beginPath(),l){case 0:this._drawCircle(t,n,o,be);break;case 1:this._drawDroplet(t,n,o,be);break;case 3:this._drawTriangle(t,n,o,be);break;default:this._drawCircle(t,n,o,be)}t.fillStyle=`rgb(${i}, ${s}, ${a})`,t.fill(),t.strokeStyle=r?Ai:"black",t.lineWidth=c?Ja:ws,t.stroke()}clampColor(t){return{r:Math.round(Math.max(0,Math.min(255,t.r*255))),g:Math.round(Math.max(0,Math.min(255,t.g*255))),b:Math.round(Math.max(0,Math.min(255,t.b*255)))}}updateUIReadouts(){const t=this.getLastSelectedPoint(),n=document.activeElement,o=[this.elements.rgbRInput,this.elements.rgbGInput,this.elements.rgbBInput,this.elements.hslHInput,this.elements.hslSInput].includes(n),i=this.state.colorSpace==="RGB_CUBE";if(this.elements.rgbInputsContainer.classList.toggle("hidden",!i),this.elements.hslInputsContainer.classList.toggle("hidden",i),n!==this.elements.lightnessInput&&(this.elements.lightnessInput.value=this.state.viewLightness.toFixed(2)),n!==this.elements.alphaInput&&(this.elements.alphaInput.value=this.state.viewAlpha.toFixed(2)),n!==this.elements.positionInput&&(this.elements.positionInput.value=t?t.pos.toFixed(2):"--"),t?(this.elements.constantButton.classList.toggle("active",t.order===0),this.elements.linearButton.classList.toggle("active",t.order===1),this.elements.cubicButton.classList.toggle("active",t.order===3)):(this.elements.constantButton.classList.remove("active"),this.elements.linearButton.classList.remove("active"),this.elements.cubicButton.classList.remove("active")),this.elements.cycleButton.textContent=this.state.isCyclic?"Uncycle":"Cycle",this.elements.selectButton.disabled=this.state.points.length===0,this.elements.reverseButton.disabled=this.state.points.length===0,this.elements.cycleButton.disabled=this.state.points.length<2,!t){o||(this.elements.rgbRInput.value="",this.elements.rgbGInput.value="",this.elements.rgbBInput.value="",this.elements.hslHInput.value="",this.elements.hslSInput.value=""),this.drawColormapPreview(),this.drawSelectedColorPreview();return}if(!o){const{lightness:s,hsPos:a}=t,r=this.abstractToRgb(a.u,a.v,s);if(i){const{r:c,g:l,b:d}=this.clampColor(r);this.elements.rgbRInput.value=c,this.elements.rgbGInput.value=l,this.elements.rgbBInput.value=d}else{const c=this.rgbToHsl(r.r,r.g,r.b);this.elements.hslHInput.value=c.h.toFixed(2),this.elements.hslSInput.value=c.s.toFixed(2)}}this.drawColormapPreview(),this.drawSelectedColorPreview()}drawSelectedColorPreview(){const t=this.elements.selectedColorPreviewCanvas;if(!t)return;const{clientWidth:n,clientHeight:o}=t.parentElement;(t.width!==n||t.height!==o)&&(t.width=n,t.height=o);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),this.drawCheckerboard(i);const s=this.getLastSelectedPoint();if(s){const{hsPos:a,lightness:r,alpha:c}=s,l=this.abstractToRgb(a.u,a.v,r),{r:d,g:h,b:f}=this.clampColor(l);i.fillStyle=`rgba(${d}, ${h}, ${f}, ${c})`,i.fillRect(0,0,t.width,t.height)}}wrapPositionCyclic(t){return this.state.isCyclic?(t%1+1)%1:Math.max(0,Math.min(1,t))}drawColormapPreview(){const t=this.elements.colormapPreviewCanvas.getContext("2d"),n=this.elements.colormapPreviewCanvas.width,o=this.elements.colormapPreviewCanvas.height;if(this.drawCheckerboard(t),this.state.points.length!==0)for(let i=0;i<n;i++){const s=i/(n-1),a=this.getInterpolatedPropertiesAt(s);if(!a)continue;const r=this.clampAbstractPoint(a.u,a.v,a.lightness),c=this.abstractToRgb(r.u,r.v,a.lightness),{r:l,g:d,b:h}=this.clampColor(c);t.fillStyle=`rgba(${l}, ${d}, ${h}, ${a.alpha})`,t.fillRect(i,0,1,o)}}getInterpolatedPropertiesAt(t){const n=this.state.points,o=n.length;if(o===0)return null;if(o===1){const f=n[0];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}const i=this.state.isCyclic,s=i?(t%1+1)%1:t;let a,r,c=-1;for(let f=0;f<o-1;f++)if(s>=n[f].pos&&s<=n[f+1].pos){c=f,a=n[f],r=n[f+1];break}if(c===-1)if(i)c=o-1,a=n[o-1],r=n[0];else{const f=s<n[0].pos?n[0]:n[o-1];return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(!a||!r)return null;let l=r.pos-a.pos;if(i&&c===o-1&&(l+=1),Math.abs(l)<1e-9)return{u:a.hsPos.u,v:a.hsPos.v,lightness:a.lightness,alpha:a.alpha,order:a.order};let d;i&&c===o-1?d=s>=a.pos?(s-a.pos)/l:(s+1-a.pos)/l:d=(s-a.pos)/l;const h=Math.max(a.order,r.order);if(h===0){const f=d<.5?a:r;return{u:f.hsPos.u,v:f.hsPos.v,lightness:f.lightness,alpha:f.alpha,order:f.order}}if(h===3){const f=this.evaluateCubicSpline(c,d);if(f){const u=Math.max(0,Math.min(1,f.lightness)),g=Math.max(0,Math.min(1,f.alpha)),p=this.clampAbstractPoint(f.u,f.v,u);return{u:p.u,v:p.v,lightness:u,alpha:g,order:2}}}return{u:a.hsPos.u+(r.hsPos.u-a.hsPos.u)*d,v:a.hsPos.v+(r.hsPos.v-a.hsPos.v)*d,lightness:a.lightness+(r.lightness-a.lightness)*d,alpha:a.alpha+(r.alpha-a.alpha)*d,order:1}}abstractToRgb(t,n,o){if(this.state.colorSpace==="HSL_DI_CONE")return this.hslDiConeAbstractToRgb(t,n,o);const i=this.rgbCubeAbstractToRgb(t,n,o);return this.isValidColor(i.r,i.g,i.b)?i:{r:-1,g:-1,b:-1}}clampAbstractPoint(t,n,o){if(this.state.colorSpace==="HSL_DI_CONE"){const f=Math.sqrt(t*t+n*n),u=1-Math.abs(2*o-1);return f>u&&u>1e-6?{u:t/f*u,v:n/f*u}:{u:t,v:n}}if(o<=.01||o>=.99)return{u:0,v:0};let{r:i,g:s,b:a}=this.abstractToRgb(t,n,o);if(this.isValidColor(i,s,a))return{u:t,v:n};let r=0,c=0,l=1/0;const d=Math.max(Math.abs(t),Math.abs(n),.5),h=50;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const g=t+(f/h-.5)*2*d,p=n+(u/h-.5)*2*d,y=this.abstractToRgb(g,p,o);if(this.isValidColor(y.r,y.g,y.b)){const x=Math.sqrt((g-t)**2+(p-n)**2);x<l&&(l=x,r=g,c=p)}}return l<1/0?{u:r,v:c}:{u:0,v:0}}hslToRgb(t,n,o){if(n===0)return{r:o,g:o,b:o};const i=o<.5?o*(1+n):o+n-o*n,s=2*o-i,a=(d,h,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<1/6?d+(h-d)*6*f:f<1/2?h:f<2/3?d+(h-d)*(2/3-f)*6:d),r=a(s,i,t+1/3),c=a(s,i,t),l=a(s,i,t-1/3);return{r,g:c,b:l}}rgbToHsl(t,n,o){const i=Math.max(t,n,o),s=Math.min(t,n,o);let a=0,r=0,c=(i+s)/2;if(i!==s){const l=i-s;switch(r=c>.5?l/(2-i-s):l/(i+s),i){case t:a=(n-o)/l+(n<o?6:0);break;case n:a=(o-t)/l+2;break;case o:a=(t-n)/l+4;break}a/=6}return{h:a,s:r,l:c}}drawCheckerboard(t){const n=t.canvas.width,o=t.canvas.height,i=n/We,s=o/We;t.fillStyle=Di,t.fillRect(0,0,n,o),t.fillStyle=ki;for(let a=0;a<s;a++)for(let r=0;r<i;r++)(a+r)%2===0&&t.fillRect(r*We,a*We,We,We)}findClosestValidPoint(t,n,o){const i=Math.ceil(be*2.2),s=Math.ceil(We/2),a=i+s,r=a,c=a,l=this.elements.hsBgCanvas.width-a-i,d=this.elements.hsBgCanvas.height-a-i,h=Math.max(r,Math.min(r+l,t)),f=Math.max(c,Math.min(c+d,n)),{scale:u,offsetX:g,offsetY:p}=this.state.transform,y=(h-g)/u,x=(f-p)/u,m=this.abstractToRgb(y,x,o);if(this.isValidColor(m.r,m.g,m.b))return{x:h,y:f};if(this.state.colorSpace==="HSL_DI_CONE"){const S=Math.sqrt(y*y+x*x),I=1-Math.abs(2*o-1);if(S>I&&I>1e-6){const b=y/S*I,M=x/S*I;return{x:b*u+g,y:M*u+p}}return{x:h,y:f}}return this.findClosestPointOnRgbGamut(y,x,o,u,g,p,r,c,l,d)}getGamutVerticesRgb(t){const n=[],o=r=>r>=-1e-6&&r<=1.000001,i=(r,c)=>Math.abs(r.r-c.r)<1e-6&&Math.abs(r.g-c.g)<1e-6&&Math.abs(r.b-c.b)<1e-6,s=(r,c,l)=>{if(o(r)&&o(c)&&o(l)){const d={r,g:c,b:l};n.some(h=>i(h,d))||n.push(d)}},a=3*t;return s(a,0,0),s(0,a,0),s(0,0,a),s(1,a-1,0),s(1,0,a-1),s(a-1,1,0),s(0,1,a-1),s(a-1,0,1),s(0,a-1,1),s(1,1,a-2),s(1,a-2,1),s(a-2,1,1),n}rgbCubeAbstractToRgb(t,n,o){const i={x:1/Math.sqrt(2),y:-1/Math.sqrt(2),z:0},s={x:1/Math.sqrt(6),y:1/Math.sqrt(6),z:-2/Math.sqrt(6)},a=o+t*i.x+n*s.x,r=o+t*i.y+n*s.y,c=o+t*i.z+n*s.z;return{r:a,g:r,b:c}}findClosestPointOnRgbGamut(t,n,o,i,s,a,r,c,l,d){let h=t,f=n,u=1/0;const g=.5,p=50;for(let m=0;m<=p;m++)for(let S=0;S<=p;S++){const I=t+(m/p-.5)*2*g,b=n+(S/p-.5)*2*g,M=this.abstractToRgb(I,b,o);if(this.isValidColor(M.r,M.g,M.b)){const C=Math.sqrt((I-t)**2+(b-n)**2);C<u&&(u=C,h=I,f=b)}}if(u<1/0){const m=this.refineClosestPoint(t,n,h,f,o);h=m.u,f=m.v}const y=h*i+s,x=f*i+a;return{x:Math.max(r,Math.min(r+l,y)),y:Math.max(c,Math.min(c+d,x))}}refineClosestPoint(t,n,o,i,s){let a=o,r=i,c=.02;for(let l=0;l<5;l++){let d=!1;const h=20;for(let f=0;f<=h;f++)for(let u=0;u<=h;u++){const g=a+(f/h-.5)*2*c,p=r+(u/h-.5)*2*c,y=this.abstractToRgb(g,p,s);if(this.isValidColor(y.r,y.g,y.b)){const x=Math.sqrt((a-t)**2+(r-n)**2);Math.sqrt((g-t)**2+(p-n)**2)<x&&(a=g,r=p,d=!0)}}if(c*=.5,!d)break}return{u:a,v:r}}findClosestPointOnPolygon(t,n){let o=null,i=1/0;for(let s=0;s<n.length;s++){const a=n[s],r=n[(s+1)%n.length],c=r.x-a.x,l=r.y-a.y;let d;if(c===0&&l===0)d=a;else{const f=((t.x-a.x)*c+(t.y-a.y)*l)/(c*c+l*l);f<0?d=a:f>1?d=r:d={x:a.x+f*c,y:a.y+f*l}}const h=(t.x-d.x)**2+(t.y-d.y)**2;h<i&&(i=h,o=d)}return o}constrainPointToValidArea(t){const n=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(n.r,n.g,n.b)){t.hsPos={...t.originalHsPos};return}const o=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=o.u,t.hsPos.v=o.v}findHitPointSlider(t,n,o){const i=this.elements.interactiveCanvases[o],s=Math.ceil(be*2.2),a=Math.ceil(We/2),r=s+a,c=i.height-r-s,l=i.height-s,d=o==="lightness"?l-this.state.viewLightness*c:l-this.state.viewAlpha*c;let h=Math.abs(n-d)<=Za,f=null;for(let u=0;u<this.state.points.length;u++){const g=this.state.points[u],p=i.width-r-s,y=r+g.pos*p,x=o==="lightness"?l-g.lightness*c:l-g.alpha*c;if(Math.sqrt((t-y)**2+(n-x)**2)<=Li){f=g;break}}return{hitPoint:f,hitLine:h}}findHitPointSlider(t,n,o){const i=this.elements.interactiveCanvases[o],s=Math.ceil(be*2.2),a=i.height-2*s,r=i.height-s,c=o==="lightness"?r-this.state.viewLightness*a:r-this.state.viewAlpha*a;let l=Math.abs(n-c)<=Za,d=null;for(let h=0;h<this.state.points.length;h++){const f=this.state.points[h],u=i.width-2*s,g=s+f.pos*u,p=o==="lightness"?r-f.lightness*a:r-f.alpha*a;if(Math.sqrt((t-g)**2+(n-p)**2)<=Li){d=f;break}}return{hitPoint:d,hitLine:l}}createNewPointHS(t,n){const o=Math.ceil(be*2.2),i=Math.ceil(We/2),s=o+i,a=s,r=s,c=this.elements.hsBgCanvas.width-s-o,l=this.elements.hsBgCanvas.height-s-o;if(t<a||t>a+c||n<r||n>r+l)return;const d=(t-this.state.transform.offsetX)/this.state.transform.scale,h=(n-this.state.transform.offsetY)/this.state.transform.scale,{viewLightness:f,viewAlpha:u}=this.state,{r:g,g:p,b:y}=this.abstractToRgb(d,h,f);if(this.isValidColor(g,p,y)){this.markAsDirty();const x=this.state.points.length;x>0&&this.state.points.forEach(S=>{S.pos=S.pos-S.pos/x});const m={id:Date.now(),hsPos:{u:d,v:h},originalHsPos:{u:d,v:h},lightness:f,alpha:u,pos:x===0?.5:1,order:1};this.state.points.push(m),this.sortPoints(),this.state.selectedPointIds.clear(),this.state.selectedPointIds.add(m.id),this.state.lastSelectedPointId=m.id,this.drawAll()}}handleLineDrag(t,n,o){const i=o.startsWith("lightness")?"lightness":"alpha",s=o.startsWith("lightness")?"viewLightness":"viewAlpha",a=Math.ceil(be*2.2),r=Math.ceil(We/2),c=a+r,l=n-c-a,h=(this.findSnapPosition(t,n,i)-c)/l,f=Math.max(0,Math.min(1,1-h));this.state[s]=f,this.drawAll()}handlePointDrag(t,n,o,i){const s=this.getPointById(this.state.activeDrag.pointId);s&&(i==="hs"?this.handleHSPointDrag(t,n):(i==="lightness"||i==="alpha")&&this.handleSliderPointDrag(s,t,n,o,i),this.drawAll())}handleHSPointDrag(t,n){const{startX:o,startY:i,initialPointPositions:s}=this.state.activeDrag,{scale:a,offsetX:r,offsetY:c}=this.state.transform,l=Math.ceil(be*2.2),d=Math.ceil(We/2),h=l+d,f=h,u=h,g=this.elements.hsBgCanvas.width-h-l,p=this.elements.hsBgCanvas.height-h-l,y=t-o,x=n-i;this.state.points.forEach(m=>{if(s.has(m.id)){const S=s.get(m.id),I=S.x+y,b=S.y+x,M=Math.max(f,Math.min(f+g,I)),C=Math.max(u,Math.min(u+p,b)),w=this.findClosestValidPoint(M,C,m.lightness),_=(w.x-r)/a,T=(w.y-c)/a;m.hsPos={u:_,v:T};const v=this.abstractToRgb(_,T,m.lightness);this.isValidColor(v.r,v.g,v.b)&&(m.originalHsPos={u:_,v:T})}})}adjustPointForNewLightness(t,n){const o=this.abstractToRgb(t.originalHsPos.u,t.originalHsPos.v,t.lightness);if(this.isValidColor(o.r,o.g,o.b)){t.hsPos={...t.originalHsPos};return}const i=this.clampAbstractPoint(t.originalHsPos.u,t.originalHsPos.v,t.lightness);t.hsPos.u=i.u,t.hsPos.v=i.v}handleSliderPointDrag(t,n,o,i,s){const{offsets:a}=this.state.activeDrag,r=Math.ceil(be*2.2),c=Math.ceil(We/2),l=r+c;i.width-r,i.height-r;const d=this.findSnapPosition(o,i.height,s,t.id),h=l,f=i.width-r,u=l,g=i.height-r,p=f-h,y=g-u,x=(d-u)/y,m=Math.max(0,Math.min(1,1-x));let S=(n-h)/p,I=S;this.state.isCyclic?(S<0?I=1+S:S>1&&(I=S-1),I=this.wrapPositionCyclic(I)):I=Math.max(0,Math.min(1,S));for(const b of this.state.points)if(a.has(b.id)){const M=a.get(b.id),C=m+M[s];let w=I+M.pos;if(this.state.isCyclic?w=this.wrapPositionCyclic(w):w=Math.max(0,Math.min(1,w)),b.pos=w,s==="lightness"){const _=Math.max(0,Math.min(1,C));b.lightness=_;const T=this.abstractToRgb(b.originalHsPos.u,b.originalHsPos.v,_);if(this.isValidColor(T.r,T.g,T.b))b.hsPos={...b.originalHsPos};else{const v=this.clampAbstractPoint(b.originalHsPos.u,b.originalHsPos.v,_);b.hsPos.u=v.u,b.hsPos.v=v.v}this.state.viewLightness=_}else b.alpha=Math.max(0,Math.min(1,C)),this.state.viewAlpha=b.alpha}this.sortPoints()}}const Xl=[5,4],ya=16,zl=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],tr=e=>{const t=[{power:3,value:e[0]},{power:2,value:e[1]},{power:1,value:e[2]},{power:0,value:e[3]}],n=o=>Number(o.toFixed(6));return t.filter(o=>Math.abs(o.value)>1e-10).map((o,i)=>{const s=o.value<0?"-":"+",a=Math.abs(o.value),r=n(a),c=o.power===0?"":`t^${o.power}`,l=o.power===0?`${r}`:`${r}${c}`;return i===0?o.value<0?`-${l}`:`${l}`:`${s} ${l}`}).join(" ").replace(/t\^1\b/g,"t")},Hl=(e,t,n,o,i)=>{const s=[t.x,n.x,o.x,i.x],a=[t.y,n.y,o.y,i.y],r=e.map(l=>l.reduce((d,h,f)=>d+h*s[f],0)),c=e.map(l=>l.reduce((d,h,f)=>d+h*a[f],0));return{x:r,y:c}},Gl=(e,t)=>{if(e.length<2)return[];const n=e.length,o=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),s=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[o(l)]:l<0?i():l>=n?s():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c};function Wl(e,t=!1,n=ya){if(e.length<2)return e;const o=[],i=e.length,s=t?i:i-1;for(let a=0;a<s;a++){const r=e[a],c=e[(a+1)%i],l=a===0?0:1;for(let d=l;d<=n;d++){const h=d/n;o.push({x:r.x+(c.x-r.x)*h,y:r.y+(c.y-r.y)*h})}}return o}const zt=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},Uo=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),ql=(e,t)=>{const n=Math.PI*2;let o=(t-e)%n;return o<0&&(o+=n),o>Math.PI&&(o-=n),o},Zn=(e,t,n,o,i,s,a,r=null)=>{const c=i*.5;if(c<=1e-6)return;const l={x:c,y:c},d=Math.PI,h=-Math.PI/2,f=ql(d,h),u=Math.max(2,s);for(let g=a?0:1;g<=u;g++){const p=g/u,y=d+f*p,x={x:l.x+Math.cos(y)*c,y:l.y+Math.sin(y)*c},m={x:t.x+n.x*x.x+o.x*x.y,y:t.y+n.y*x.x+o.y*x.y};r?r(m):e.push(m)}};function nr(e,t=!1,n="relative",o=0,i=ya,s=!1,a=!1,r=!1,c=!1){if(e.length<2)return e;if(o<=1e-6)return t?[...e,e[0]]:[...e];const l=e.length,d=[],h=[],f=n==="fixed"?"absolute":n,u=f==="absolute"?"relative":f,g=I=>{const b=e[(I-1+l)%l],M=e[I],C=e[(I+1)%l],w=Uo(b,M),_=Uo(C,M),T=Math.hypot(w.x,w.y),v=Math.hypot(_.x,_.y);if(T<=1e-6||v<=1e-6)return null;let E,O,P;const D=Math.min(T,v)*.5;if(u==="absolute"?(E=Math.max(0,Math.min(1,o)),O=zt(_),P=zt(w)):(f==="absolute"?E=Math.max(0,Math.min(o,D))*2:E=Math.max(0,Math.min(1,o)),O=f==="absolute"?zt(_):_,P=f==="absolute"?zt(w):w),E<=1e-6)return null;const F=E*.5,R=r?-F:f==="absolute"?T*.5:.5,B=r?-F:f==="absolute"?v*.5:.5,L={x:M.x+P.x*R,y:M.y+P.y*R},N={x:M.x+O.x*B,y:M.y+O.y*B},$=zt(P),A=zt(O),k={x:$.x+A.x,y:$.y+A.y},V=Math.hypot(k.x,k.y),X=V>1e-6?{x:k.x/V,y:k.y/V}:{x:0,y:0},Y=f==="absolute"?F:F*Math.min(T,v),H={x:M.x-X.x*(Y/Math.sqrt(2)),y:M.y-X.y*(Y/Math.sqrt(2))},G={x:-$.y,y:$.x},W={x:-A.y,y:A.x},Q=G.x*X.x+G.y*X.y<0?{x:-G.x,y:-G.y}:G,te=W.x*X.x+W.y*X.y<0?{x:-W.x,y:-W.y}:W,pe=(f==="absolute"?F:F*T)/Math.sqrt(2),me=(f==="absolute"?F:F*v)/Math.sqrt(2),vt={x:M.x+$.x*(T*.5)+Q.x*pe,y:M.y+$.y*(T*.5)+Q.y*pe},Qe={x:M.x+A.x*(v*.5)+te.x*me,y:M.y+A.y*(v*.5)+te.y*me},rt={x:M.x+P.x*F,y:M.y+P.y*F},Xt={x:M.x+O.x*F,y:M.y+O.y*F};return{index:I,origin:M,axisX:O,axisY:P,baseScale:E,radius:F,edgeInIndex:(I-1+l)%l,edgeOutIndex:I,midIn:L,midOut:N,arcStart:rt,arcEnd:Xt,bisectorOuter:H,midInOrtho:vt,midOutOrtho:Qe}},p=(I,b=null,M=null)=>{if(!c){d.push({x:I.x,y:I.y});return}d.push({x:I.x,y:I.y,tag:b||void 0,edgeIndex:M??void 0})},y=I=>p(I,"arc"),x=(I,b)=>{!r||I.radius<=1e-6||(b?(p(I.midInOrtho,"line",I.edgeInIndex),p(I.bisectorOuter,"corner")):(p(I.bisectorOuter,"corner"),p(I.midOutOrtho,"line",I.edgeOutIndex)))};if(t){for(let b=0;b<l;b++){const M=g(b);M&&h.push(M)}if(!h.length)return[...e,e[0]];if(r){const b=h[0];p(b.arcStart,"line",b.edgeInIndex),Zn(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!1,y);for(let M=1;M<h.length;M++){const C=h[M];p(C.arcStart,"line",C.edgeInIndex),Zn(d,C.origin,C.axisX,C.axisY,C.baseScale,i,!1,y)}return p({...b.arcStart},"line",b.edgeInIndex),d}const I=h[0];return p(I.midIn,"line",I.edgeInIndex),x(I,!0),h.forEach((b,M)=>{M>0&&(p(b.midIn,"line",b.edgeInIndex),x(b,!0)),Zn(d,b.origin,b.axisX,b.axisY,b.baseScale,i,!0,y),x(b,!1),p(b.midOut,"line",b.edgeOutIndex),p(b.origin,"corner")}),p({...I.midIn},"line",I.edgeInIndex),d}if(u==="absolute"){for(let M=1;M<l-1;M++){const C=g(M);C&&h.push(C)}if(!h.length)return[...e];const I=h[0];p(e[0],"line",0),I&&p(I.midIn,"line",I.edgeInIndex),x(I,!0),h.forEach((M,C)=>{C>0&&(p(M.midIn,"line",M.edgeInIndex),x(M,!0)),Zn(d,M.origin,M.axisX,M.axisY,M.baseScale,i,!0,y),x(M,!1),p(M.midOut,"line",M.edgeOutIndex)});const b=h[h.length-1];return b&&p(b.midOut,"line",b.edgeOutIndex),p(e[l-1],"line",l-2),d}if(r){for(let b=1;b<l-1;b++){const M=g(b);M&&h.push(M)}if(!h.length)return[...e];p(e[0],"line",0);const I=h[0];p(I.arcStart,"line",I.edgeInIndex),Zn(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!1,y);for(let b=1;b<h.length;b++){const M=h[b];p(M.arcStart,"line",M.edgeInIndex),Zn(d,M.origin,M.axisX,M.axisY,M.baseScale,i,!1,y)}return p(e[l-1],"line",l-2),d}for(let I=1;I<l-1;I++){const b=g(I);b&&h.push(b)}if(!h.length)return[...e];const m=h[0],S=h[h.length-1];return p(e[0],"line",0),p(m.midIn,"line",m.edgeInIndex),h.forEach((I,b)=>{b>0&&p(I.midIn,"line",I.edgeInIndex),x(I,!0),Zn(d,I.origin,I.axisX,I.axisY,I.baseScale,i,!0,y),x(I,!1),p(I.midOut,"line",I.edgeOutIndex)}),p(S.midOut,"line",S.edgeOutIndex),p(e[l-1],"line",l-2),d}function Ul(e,t=!1,n="relative",o=0){if(e.length<3)return[];if(o<=1e-6)return[];const i=e.length,s=[],a=n==="fixed"?"absolute":n,r=a==="absolute"?"relative":a,c=t?i:i-1;for(let l=1;l<c;l++){const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=Uo(d,h),g=Uo(f,h),p=Math.hypot(u.x,u.y),y=Math.hypot(g.x,g.y);if(p<=1e-6||y<=1e-6)continue;const x=Math.min(p,y)*.5;let m,S,I;if(r==="absolute"){const X=Math.min(p,y);m=Math.max(0,Math.min(o,X*.5))*2,S=zt(g),I=zt(u)}else m=a==="absolute"?Math.max(0,Math.min(o,x))*2:Math.max(0,Math.min(1,o)),S=a==="absolute"?zt(g):g,I=a==="absolute"?zt(u):u;if(m<=1e-6)continue;const b=m*.5,M=zt(I),C=zt(S),w={x:M.x+C.x,y:M.y+C.y},_=Math.hypot(w.x,w.y),T=_>1e-6?{x:w.x/_,y:w.y/_}:{x:0,y:0},v=a==="absolute"?b:b*Math.min(p,y),E=t?(()=>{let X=0;for(let Y=0;Y<i;Y++){const H=e[Y],G=e[(Y+1)%i];X+=H.x*G.y-G.x*H.y}return X})():1,O=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),D=(E>=0?O>=0:O<=0)?-1:1,F={x:h.x+T.x*v*D,y:h.y+T.y*v*D},R={x:-M.y,y:M.x},B={x:-C.y,y:C.x},L=R.x*T.x+R.y*T.y<0?{x:-R.x,y:-R.y}:R,N=B.x*T.x+B.y*T.y<0?{x:-B.x,y:-B.y}:B,$=(a==="absolute"?b:b*p)/Math.sqrt(2),A=(a==="absolute"?b:b*y)/Math.sqrt(2),k={x:h.x+M.x*(p*.5)+L.x*$,y:h.y+M.y*(p*.5)+L.y*$},V={x:h.x+C.x*(y*.5)+N.x*A,y:h.y+C.y*(y*.5)+N.y*A};s.push(F,k,V)}return s}function sr(e,t=.5,n=!1,o=ya,i={}){if(e.length<2)return e;const s=[],a=Math.max(0,Math.min(1,t)),r=(1-a)*.5,c=zl(r),l=i?.logSegments??!1,d=i?.label??"Catmull-Rom",h=(u,g,p,y,x)=>{const m=x*x,S=m*x,I=2*S-3*m+1,b=S-2*m+x,M=-2*S+3*m,C=S-m;return{x:I*u.x+b*p.x+M*g.x+C*y.x,y:I*u.y+b*p.y+M*g.y+C*y.y}};return Gl(e,n).forEach(({index:u,p0:g,p1:p,p2:y,p3:x})=>{if(l){const b=Hl(c,g,p,y,x);console.groupCollapsed(`${d} segment ${u}`),console.log("Matrix M (rows t^3,t^2,t,1; cols P0..P3):",c),console.log("P0..P3:",g,p,y,x),console.log(`tension: ${a}, tau: ${r}`),console.log("P(t) = [t^3 t^2 t 1] * M * [P0 P1 P2 P3]"),console.log(`x(t) = ${tr(b.x)}`),console.log(`y(t) = ${tr(b.y)}`),console.groupEnd()}const m=u===0?0:1,S={x:(y.x-g.x)*r,y:(y.y-g.y)*r},I={x:(x.x-p.x)*r,y:(x.y-p.y)*r};for(let b=m;b<=o;b++){const M=b/o;s.push(h(p,y,S,I,M))}}),s}const jl={id:null,preset:"closed",type:"spline",mode:"piecewise",order:3,tension:.5,radiusMode:"absolute",radiusValue:.5,relRadiusValue:.5,absRadiusValue:.5,linearStyle:"lines",nurbsDegree:3,pointHandling:"anchor"},xi=500,_s=e=>Math.max(0,Math.min(1,e)),Nr=e=>Math.max(0,Math.min(xi,e)),Ro=e=>{const t=_s(Number(e)||0);return t*t*xi},or=e=>{const t=Nr(Number(e)||0);return Math.sqrt(t/xi)},ir=[{id:"closed",label:"Closed"},{id:"open",label:"Open"},{id:"figure8",label:"Figure 8"},{id:"branching",label:"Branching"},{id:"branching4",label:"Branching (4)"},{id:"branching5",label:"Branching (5)"}],Kl=[{id:"linear",label:"Linear"},{id:"spline",label:"Spline"},{id:"radius",label:"Radius"}];class Jl{constructor(t={}){this.container=t.container||document.body,this.onSelect=t.onSelect||(()=>{}),this.state={style:this._createStyle(),previewPoints:this._createDefaultPresetPoints()},this.wrapper=null,this.elements={},this.previewCards=new Map,this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}initialize(){this.wrapper||(this._initializeDOM(),this._setupEventListeners(),this._updateUIFromState(),this._renderAllPreviews())}show(t=null){this.state.style=this._normalizeStyle(t),this._updateUIFromState(),this.wrapper.style.display="block",requestAnimationFrame(()=>{this._renderAllPreviews()})}hide(){this.wrapper&&(this.wrapper.style.display="none")}_createStyle(){return{...jl,id:`style_${Date.now()}`}}_normalizeStyle(t){const n=this._createStyle();if(!t)return n;const i=Number(t.order)===3?3:1;let s=t.type==="px_radius"?"abs_radius":t.type,a=t.radiusMode==="fixed"?"absolute":t.radiusMode,r=t.pointHandling;s==="cubic_spline"?(s="spline",r="anchor"):s==="circular_arc"?s="radius":s==="linear"&&(s="linear"),s==="catmull"?(s="spline",r="anchor"):s==="nurbs"?(s="spline",r="control"):s==="linear"?(s="spline",r="anchor"):s==="rel_radius"?(s="radius",a="relative"):s==="abs_radius"&&(s="radius",a="absolute");const c=t.relRadiusValue??(a==="relative"?_s(t.radiusValue):n.relRadiusValue),l=t.absRadiusValue??(a==="absolute"?or(t.radiusValue):n.absRadiusValue),d=a==="relative"?c:Ro(l);return s||(t.mode==="radius"?s="radius":i===3&&t.tension!==void 0?(s="spline",r="anchor"):i===3?s="spline":(s="spline",r="anchor")),{...n,...t,id:t.id||n.id,preset:t.preset||n.preset,order:i,type:s||n.type,radiusMode:a||n.radiusMode,radiusValue:d,relRadiusValue:c,absRadiusValue:l,linearStyle:t.linearStyle||n.linearStyle,nurbsDegree:t.nurbsDegree||n.nurbsDegree,pointHandling:s==="spline"?"anchor":r??t.pointHandling??n.pointHandling}}_createDefaultPresetPoints(){const t={x:.6,y:.25},n={x:.55,y:.45},o={x:.55,y:.5},i=[{x:.2,y:.2},{x:.8,y:.25},{x:.7,y:.6},{x:.5,y:.45},{x:.3,y:.75}],s=[{x:.05,y:.8},{x:.25,y:.4},{x:.45,y:.7},{x:.65,y:.2},{x:.85,y:.55}],a=[{x:.72,y:.5},{x:.61,y:.31},{x:.39,y:.31},{x:.28,y:.5},{x:.39,y:.69},{x:.61,y:.69},{x:.5,y:.5}];return{closed:{vertices:i,edges:i.map((r,c)=>[c,(c+1)%i.length])},open:{vertices:s,edges:s.slice(0,-1).map((r,c)=>[c,c+1])},figure8:{vertices:a,edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0],[0,6],[6,3]],faces:[[0,1,2,3,4,5]]},branching:[[{x:.1,y:.85},{x:.3,y:.6},{x:.5,y:.4},t],[t,{x:.75,y:.15},{x:.9,y:.1}],[t,{x:.75,y:.35},{x:.9,y:.45}]],branching4:{in:[[{x:.12,y:.15},{x:.32,y:.3},n],[{x:.18,y:.75},{x:.35,y:.58},n]],out:[[n,{x:.75,y:.25},{x:.92,y:.2}],[n,{x:.75,y:.6},{x:.9,y:.72}]]},branching5:{in:[[{x:.1,y:.25},{x:.32,y:.38},o],[{x:.18,y:.8},{x:.35,y:.64},o]],out:[[o,{x:.78,y:.25},{x:.92,y:.2}],[o,{x:.78,y:.5},{x:.92,y:.52}],[o,{x:.78,y:.78},{x:.9,y:.85}]]}}}_initializeDOM(){const t=(C,w={})=>{const _=document.createElement(C);if(w.id){_.id=w.id;const T=w.id.replace(/-(\w)/g,(v,E)=>E.toUpperCase());this.elements[T]=_}return w.className&&(_.className=w.className),w.text&&(_.textContent=w.text),w.type&&(_.type=w.type),w.value!==void 0&&(_.value=w.value),w.attrs&&Object.entries(w.attrs).forEach(([T,v])=>_.setAttribute(T,v)),_};this.wrapper=t("div",{id:"interpolation-editor-wrapper",className:"interpolation-editor-container"}),this.wrapper.style.display="none";const n=t("div",{className:"interpolation-editor-layout"}),o=t("div",{className:"editor-panel preview-panel"});o.append(t("div",{className:"panel-header",text:"Preview Presets"}));const i=t("div",{className:"preview-list"});ir.forEach(C=>{const w=t("button",{className:"preview-card",attrs:{"data-preset":C.id,type:"button"}}),_=t("div",{className:"preview-card-label",text:C.label}),T=t("canvas",{className:"preview-card-canvas"});w.append(T,_),i.append(w),this.previewCards.set(C.id,{card:w,canvas:T})}),o.append(i);const s=t("div",{className:"editor-panel type-panel"});s.append(t("div",{className:"panel-header",text:"Interpolation Type"}));const a=t("div",{className:"toggle-stack",id:"type-list"});Kl.forEach(C=>{const w=t("button",{className:"toggle-row",text:C.label,attrs:{"data-type":C.id,type:"button"}});a.append(w)}),s.append(a);const r=t("div",{className:"editor-panel params-panel"});r.append(t("div",{className:"panel-header",text:"Parameters"}));const c=t("div",{className:"param-section",id:"tension-section"});c.append(t("div",{className:"section-caption",text:"Catmull-Rom tension."}));const l=t("div",{className:"param-row"});this.elements.tensionSlider=t("input",{id:"tension-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.tensionInput=t("input",{id:"tension-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),l.append(this.elements.tensionSlider,this.elements.tensionInput),c.append(l);const d=t("div",{className:"param-section",id:"linear-section"});d.append(t("div",{className:"section-caption",text:"Linear marker style."}));const h=t("div",{className:"param-row"}),f=t("div",{className:"toggle-group",id:"linear-style-toggle"});f.append(t("button",{className:"toggle-button",text:"Lines",attrs:{"data-linear-style":"lines",type:"button"}}),t("button",{className:"toggle-button",text:"Arrows",attrs:{"data-linear-style":"arrows",type:"button"}})),h.append(f),d.append(h);const u=t("div",{className:"param-section",id:"handling-section"});u.append(t("div",{className:"section-caption",text:"Point handling."}));const g=t("div",{className:"param-row"}),p=t("div",{className:"toggle-group",id:"point-handling-toggle"});p.append(t("button",{className:"toggle-button",text:"Control",attrs:{"data-point-handling":"control",type:"button"}}),t("button",{className:"toggle-button",text:"Anchor",attrs:{"data-point-handling":"anchor",type:"button"}}),t("button",{className:"toggle-button",text:"Mixed",attrs:{"data-point-handling":"mixed",type:"button"}})),g.append(p),u.append(g);const y=t("div",{className:"param-section",id:"radius-section"});y.append(t("div",{className:"section-caption",text:"Clamped to half each adjacent edge."}));const x=t("div",{className:"param-row"});this.elements.radiusSlider=t("input",{id:"radius-slider",type:"range",attrs:{min:"0",max:"1",step:"0.01"}}),this.elements.radiusInput=t("input",{id:"radius-input",type:"number",attrs:{min:"0",max:"1",step:"0.01"}}),x.append(this.elements.radiusSlider,this.elements.radiusInput),y.append(x);const m=t("div",{className:"toggle-group",id:"radius-mode-toggle"});m.append(t("button",{className:"toggle-button",text:"Relative",attrs:{"data-radius-mode":"relative",type:"button"}}),t("button",{className:"toggle-button",text:"Absolute",attrs:{"data-radius-mode":"absolute",type:"button"}})),y.append(m);const S=t("div",{className:"param-section",id:"nurbs-section"});S.append(t("div",{className:"section-caption",text:"NURBS degree."}));const I=t("div",{className:"param-row"});this.elements.nurbsDegreeSlider=t("input",{id:"nurbs-degree-slider",type:"range",attrs:{min:"2",max:"5",step:"1"}}),this.elements.nurbsDegreeInput=t("input",{id:"nurbs-degree-input",type:"number",attrs:{min:"2",max:"5",step:"1"}}),I.append(this.elements.nurbsDegreeSlider,this.elements.nurbsDegreeInput),S.append(I),r.append(d,u,c,y,S);const b=t("div",{className:"editor-panel actions-panel"});b.append(t("div",{className:"panel-header",text:"Actions"}));const M=t("div",{className:"button-row"});this.elements.closeButton=t("button",{id:"close-button",className:"editor-button secondary",text:"Close",attrs:{type:"button"}}),this.elements.selectButton=t("button",{id:"select-button",className:"editor-button primary",text:"Select",attrs:{type:"button"}}),M.append(this.elements.closeButton,this.elements.selectButton),b.append(M),n.append(o,s,r,b),this.wrapper.append(n),this.container.appendChild(this.wrapper)}_setupEventListeners(){window.addEventListener("resize",()=>{this.wrapper&&this.wrapper.style.display!=="none"&&this._renderAllPreviews()}),this.previewCards.forEach((s,a)=>{s.card.addEventListener("click",()=>{this._setStyle({preset:a})}),s.canvas.addEventListener("mousedown",r=>{this._handlePreviewMouseDown(r,a)})}),this.wrapper.querySelector("#type-list").querySelectorAll(".toggle-row").forEach(s=>{s.addEventListener("click",()=>{this._applyTypeSelection(s.dataset.type)})}),this.wrapper.querySelector("#linear-style-toggle").querySelectorAll(".toggle-button").forEach(s=>{s.addEventListener("click",()=>{this._setStyle({linearStyle:s.dataset.linearStyle})})}),this.wrapper.querySelector("#point-handling-toggle").querySelectorAll(".toggle-button").forEach(s=>{s.addEventListener("click",()=>{this._setStyle({pointHandling:s.dataset.pointHandling})})}),this.elements.radiusSlider.addEventListener("input",s=>{const a=Number(s.target.value);this._applyRadiusValue(a,!0)}),this.elements.radiusInput.addEventListener("change",s=>{const a=Number(s.target.value);this._applyRadiusValue(a,!1)}),this.wrapper.querySelector("#radius-mode-toggle").querySelectorAll(".toggle-button").forEach(s=>{s.addEventListener("click",()=>{this._applyRadiusMode(s.dataset.radiusMode)})}),this.elements.tensionSlider.addEventListener("input",s=>{const a=Number(s.target.value);this._applyTensionValue(a,!0)}),this.elements.tensionInput.addEventListener("change",s=>{const a=Number(s.target.value);this._applyTensionValue(a,!1)}),this.elements.nurbsDegreeSlider.addEventListener("input",s=>{const a=Number(s.target.value);this._applyNurbsDegreeValue(a,!0)}),this.elements.nurbsDegreeInput.addEventListener("change",s=>{const a=Number(s.target.value);this._applyNurbsDegreeValue(a,!1)}),this.elements.closeButton.addEventListener("click",()=>{this.hide()}),this.elements.selectButton.addEventListener("click",()=>{this.onSelect(this._exportStyleForHost()),this.hide()}),window.addEventListener("mousemove",s=>{this._handlePreviewMouseMove(s)}),window.addEventListener("mouseup",()=>{this._handlePreviewMouseUp()})}_setStyle(t){this.state.style={...this.state.style,...t},this._updateUIFromState(),this._renderAllPreviews()}_exportStyleForHost(){const{id:t,name:n,type:o,tension:i,radiusMode:s,radiusValue:a,pointHandling:r,order:c,preset:l,mode:d,linearStyle:h}=this.state.style,f={id:t,name:n,order:c,preset:l,mode:d,linearStyle:h};return o==="spline"?{...f,type:"cubic_spline",cornerHandling:"pass_through",tension:Number(i??.5)}:o==="radius"?{...f,type:"circular_arc",cornerHandling:r==="mixed"?"mixed":"cut_all",radiusMode:s,radiusValue:a}:{...f,type:"linear",cornerHandling:"pass_through"}}_applyRadiusValue(t,n){if(Number.isNaN(t))return;const o={...this.state.style};if(o.radiusMode==="relative"){const i=_s(t);o.radiusValue=i,o.relRadiusValue=i}else{const i=n?_s(t):or(t);o.absRadiusValue=i,o.radiusValue=Ro(i)}this.state.style=o,n?this.elements.radiusInput.value=o.radiusValue.toFixed(o.radiusMode==="absolute"?0:2):this.elements.radiusSlider.value=o.radiusMode==="absolute"?o.absRadiusValue:o.radiusValue,this._updateUIFromState(),this._renderAllPreviews()}_applyTensionValue(t,n){if(Number.isNaN(t))return;const o={...this.state.style};o.tension=Math.max(0,Math.min(1,t)),this.state.style=o,n?this.elements.tensionInput.value=o.tension.toFixed(2):this.elements.tensionSlider.value=o.tension,this._updateUIFromState(),this._renderAllPreviews()}_applyRadiusMode(t){if(t!=="relative"&&t!=="absolute")return;const n={...this.state.style};n.radiusMode=t,t==="relative"?n.radiusValue=n.relRadiusValue??n.radiusValue:n.radiusValue=Ro(n.absRadiusValue??n.radiusValue),this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_applyNurbsDegreeValue(t,n){if(Number.isNaN(t))return;const o={...this.state.style};o.nurbsDegree=Math.max(2,Math.min(5,Math.round(t))),this.state.style=o,n?this.elements.nurbsDegreeInput.value=o.nurbsDegree:this.elements.nurbsDegreeSlider.value=o.nurbsDegree,this._updateUIFromState()}_applyTypeSelection(t){const n={...this.state.style,type:t};switch(t){case"linear":n.mode="piecewise",n.order=1,n.pointHandling="anchor";break;case"spline":n.mode="piecewise",n.order=3,n.pointHandling="anchor";break;case"radius":n.mode="radius",n.radiusMode=n.radiusMode||"relative",n.radiusValue=n.radiusMode==="relative"?n.relRadiusValue??n.radiusValue:Ro(n.absRadiusValue??n.radiusValue),n.pointHandling=n.pointHandling==="mixed"?"mixed":"control";break}this.state.style=n,this._updateUIFromState(),this._renderAllPreviews()}_updateUIFromState(){const{preset:t,mode:n,order:o,radiusMode:i,radiusValue:s,tension:a,type:r,linearStyle:c,nurbsDegree:l,pointHandling:d}=this.state.style;this.previewCards.forEach((y,x)=>{y.card.classList.toggle("is-active",x===t)}),this.wrapper.querySelectorAll("#type-list .toggle-row").forEach(y=>{y.classList.toggle("is-active",y.dataset.type===r)}),this.wrapper.querySelectorAll("#linear-style-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.linearStyle===c)}),this.wrapper.querySelectorAll("#point-handling-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.pointHandling===d)});const h=this.wrapper.querySelector("#linear-section"),f=this.wrapper.querySelector("#handling-section"),u=this.wrapper.querySelector("#tension-section"),g=this.wrapper.querySelector("#radius-section"),p=this.wrapper.querySelector("#nurbs-section");h.classList.toggle("is-hidden",r!=="linear"),f.classList.toggle("is-hidden",!0),u.classList.toggle("is-hidden",r!=="spline"),g.classList.toggle("is-hidden",r!=="radius"),p.classList.toggle("is-hidden",!0),this.wrapper.querySelectorAll("#radius-mode-toggle .toggle-button").forEach(y=>{y.classList.toggle("is-active",y.dataset.radiusMode===i)}),i==="absolute"?(this.elements.radiusSlider.value=_s(this.state.style.absRadiusValue),this.elements.radiusInput.value=Nr(s).toFixed(0),this.elements.radiusInput.min="0",this.elements.radiusInput.max=String(xi),this.elements.radiusInput.step="1"):(this.elements.radiusSlider.value=_s(s),this.elements.radiusInput.value=Number(this.elements.radiusSlider.value).toFixed(2),this.elements.radiusInput.min="0",this.elements.radiusInput.max="1",this.elements.radiusInput.step="0.01"),this.elements.tensionSlider.value=Math.max(0,Math.min(1,a)),this.elements.tensionInput.value=Number(a).toFixed(2),this.elements.nurbsDegreeSlider.value=l,this.elements.nurbsDegreeInput.value=l}_renderAllPreviews(){ir.forEach(t=>{const n=this.previewCards.get(t.id);n&&this._renderPreviewCard(n.canvas,t.id,t.id===this.state.style.preset)})}_renderPreviewCard(t,n,o){const i=t.getBoundingClientRect(),s=window.devicePixelRatio||1,a=Math.max(1,Math.floor(i.width*s)),r=Math.max(1,Math.floor(i.height*s));(t.width!==a||t.height!==r)&&(t.width=a,t.height=r);const c=t.getContext("2d");c.save(),c.scale(s,s),c.clearRect(0,0,i.width,i.height),c.fillStyle="#1f2937",c.fillRect(0,0,i.width,i.height),this._drawPreset(c,i.width,i.height,n,o),c.restore()}_drawPreset(t,n,o,i,s){const r=n-32,c=o-32,l=v=>({x:16+v.x*r,y:16+v.y*c}),d=this._getPresetPoints(i),h=s?"#3b82f6":"#6b7280",f=s?"#60a5fa":"#94a3b8";t.lineWidth=this._getStrokeWidth(),t.lineJoin=this.state.style.mode==="radius"?"round":"miter",t.lineCap="round",t.strokeStyle=h;const u=[],g=new Set,p=new Set,y=v=>{g.has(v)||(g.add(v),u.push(v))},x=this.state.style.mode==="radius"&&i==="branching",m=(v,E,O)=>{const P=O.x-E.x,D=O.y-E.y,F=v.x-E.x,R=v.y-E.y,B=P*P+D*D;return B<1e-6?0:(F*P+R*D)/B},S=v=>{if(!v)return 0;const E=Math.hypot(v.b.x-v.a.x,v.b.y-v.a.y);return E<=1e-6?0:this.state.style.radiusMode==="relative"?Math.max(0,Math.min(.5,this.state.style.radiusValue*.5)):Math.max(0,Math.min(.5,this.state.style.radiusValue/E))},I=(v,E,O,P,D)=>{if(v.length<3||!P)return v;const F=S(P),R=O?D?0:.5:F,B=O?1-F:D?1:.5,L=v.filter(N=>{if(N.tag==="line"&&N.edgeIndex!==void 0){if(N.edgeIndex!==E)return!0;const $=m(N,P.a,P.b);return $>=R&&$<=B}return N.tag!=="line"});return L.length>=2,L},b=d.faces&&d.vertices?d.vertices:null,M=d.faces||null,C=!!(b&&M&&M.length);let w=null,_=null;const T=Math.hypot(r,c);if(d.paths.forEach((v,E)=>{const O=v.points,P=O.map(l);if(O.forEach(y),E===0&&i==="closed"&&(console.groupCollapsed("anchor-control-debug"),console.log("mode",this.state.style.mode),console.log("type",this.state.style.type),console.log("pointHandling",this.state.style.pointHandling),console.log("radiusMode",this.state.style.radiusMode),console.log("radiusValue",this.state.style.radiusValue)),P.length>=2){t.save(),t.lineWidth=Math.max(1,this._getStrokeWidth()*.6),t.strokeStyle="#94a3b8",t.lineCap="round",t.lineJoin="round",t.setLineDash(Xl);const F=[];for(let R=0;R<P.length-1;R++)x&&i==="branching"&&E===0&&R===P.length-2||F.push([P[R],P[R+1]]);v.closed&&F.push([P[P.length-1],P[0]]),F.forEach(([R,B])=>{const L=Math.round(R.x),N=Math.round(R.y),$=Math.round(B.x),A=Math.round(B.y),k=`${L}:${N}`,V=`${$}:${A}`,X=k<V?`${k}|${V}`:`${V}|${k}`;p.has(X)||(p.add(X),t.beginPath(),t.moveTo(R.x,R.y),t.lineTo(B.x,B.y),t.stroke())}),t.restore()}let D=this._getInterpolatedPoints(P,v.closed,T);if(D.length<2){E===0&&i==="closed"&&(console.log("drawPoints empty"),console.groupEnd());return}if(E===0&&i==="closed"){const F=D.reduce((B,L)=>({x:Math.min(B.x,L.x),y:Math.min(B.y,L.y)}),{x:1/0,y:1/0}),R=D.reduce((B,L)=>({x:Math.max(B.x,L.x),y:Math.max(B.y,L.y)}),{x:-1/0,y:-1/0});console.log("drawPoints bounds",{min:F,max:R}),console.groupEnd()}if(x){const F=6+this.state.style.order*4,R=this.state.style.pointHandling==="control";D=nr(P,v.closed,this.state.style.radiusMode,this.state.style.radiusValue,F,!1,!1,R,!0);const B=v.trueEndpointStart===!0,L=v.trueEndpointEnd===!0;if(E===0){const N=P.length>=2?{a:P[0],b:P[1]}:null;D=I(D,0,!0,N,B);const $=P.length>=2?{a:P[P.length-2],b:P[P.length-1]}:null;D=I(D,P.length-2,!1,$,L)}else{const N=P.length>=2?{a:P[0],b:P[1]}:null,$=P.length>=2?{a:P[P.length-2],b:P[P.length-1]}:null;D=I(D,0,!0,N,B),D=I(D,P.length-2,!1,$,L)}if(D.length<2)return;D=D.map(N=>({x:N.x,y:N.y}))}if(this.state.style.mode!=="radius"&&(this.state.style.type!=="spline"||v.forceTrim)){if(v.trimFromPoint){const F=l(v.trimFromPoint);let R=0,B=1/0;D.forEach((L,N)=>{const $=Math.hypot(L.x-F.x,L.y-F.y);$<B&&(B=$,R=N)}),D=D.slice(R),!D.length||Math.hypot(D[0].x-F.x,D[0].y-F.y)>1e-6?D.unshift(F):D[0]=F}if(v.trimToPoint){const F=l(v.trimToPoint);let R=0,B=1/0;D.forEach((L,N)=>{const $=Math.hypot(L.x-F.x,L.y-F.y);$<B&&(B=$,R=N)}),D=D.slice(0,R+1),!D.length||Math.hypot(D[D.length-1].x-F.x,D[D.length-1].y-F.y)>1e-6?D.push(F):D[D.length-1]=F}}if(!(D.length<2)){if(t.beginPath(),t.moveTo(D[0].x,D[0].y),D.slice(1).forEach(F=>t.lineTo(F.x,F.y)),v.closed&&(this.state.style.mode!=="radius"||this.state.style.radiusValue<=1e-6)&&t.closePath(),t.stroke(),v.isBoundary&&v.closed?(w=D,_=new Set(O)):!C&&i==="closed"&&v.closed&&!Object.prototype.hasOwnProperty.call(v,"isBoundary")&&(w=D),this.state.style.mode==="radius"&&this.state.style.pointHandling==="anchor"){const F=Ul(P,v.closed,this.state.style.radiusMode,this.state.style.radiusValue);F.length&&(t.save(),t.fillStyle="#f87171",F.forEach(R=>{t.beginPath(),t.arc(R.x,R.y,3,0,Math.PI*2),t.fill()}),t.restore())}this.state.style.type==="linear"&&this.state.style.linearStyle==="arrows"&&this._drawEdgeArrows(t,P,v.closed)}}),w&&w.length>=2&&(t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)",t.beginPath(),t.moveTo(w[0].x,w[0].y),w.slice(1).forEach(v=>t.lineTo(v.x,v.y)),t.closePath(),t.fill(),t.restore()),C){t.save(),t.fillStyle="rgba(59, 130, 246, 0.2)";let v=!1;M.forEach(E=>{if(!Array.isArray(E)||E.length<3)return;const O=E.map(R=>b[R]).filter(Boolean);if(O.length<3)return;const P=_?O.every(R=>_.has(R)):!1;if(P&&w&&!v){t.beginPath(),t.moveTo(w[0].x,w[0].y),w.slice(1).forEach(R=>t.lineTo(R.x,R.y)),t.closePath(),t.fill(),v=!0;return}if(P&&w)return;const D=O.map(l),F=this._getInterpolatedPoints(D,!0,T);!F||F.length<2||(t.beginPath(),t.moveTo(F[0].x,F[0].y),F.slice(1).forEach(R=>t.lineTo(R.x,R.y)),t.closePath(),t.fill())}),t.restore()}t.fillStyle=f,u.map(l).forEach(v=>{t.beginPath(),t.arc(v.x,v.y,3.5,0,Math.PI*2),t.fill()})}_getStrokeWidth(){return 2}_drawEdgeArrows(t,n,o){if(n.length<2)return;const i=10,s=6,a=n.length,r=o?a:a-1;t.save(),t.fillStyle=t.strokeStyle;for(let c=0;c<r;c++){const l=n[c],d=n[(c+1)%a],h=d.x-l.x,f=d.y-l.y,u=Math.hypot(h,f);if(u<.001)continue;const g=h/u,p=f/u,y=d,x={x:y.x-g*i,y:y.y-p*i},m={x:x.x+-p*(s/2),y:x.y+g*(s/2)},S={x:x.x+p*(s/2),y:x.y-g*(s/2)};t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(m.x,m.y),t.lineTo(S.x,S.y),t.closePath(),t.fill()}t.restore()}_getInterpolatedPoints(t,n,o=1){const{mode:i,order:s,type:a,pointHandling:r,nurbsDegree:c,radiusMode:l,radiusValue:d}=this.state.style;if(i==="radius"||t.length<2){if(i==="radius"){const u=6+s*4,g=d;return g<=1e-6?t:nr(t,n,l,g,u,!1,!1,r==="control")}return t}const h=4+s*4;if(a==="linear"||s===1)return Wl(t,n,h);if(t.length<3)return t;const f=this.state.style.tension??.5;return sr(t,f,n,h)}_buildControlCatmullTargets(t,n){if(t.length<2)return t;const o=[],i=t.length,s=n?i:i-1;n||o.push(t[0]);for(let a=0;a<s;a++){const r=t[a],c=t[(a+1)%i];o.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5})}return n||o.push(t[i-1]),o}_buildMixedCatmullTargets(t,n){if(t.length<2)return t;const o=this._getPathOrientation(t,n),i=[],s=t.length;for(let a=0;a<s;a++){if(!n&&(a===0||a===s-1)){i.push(t[a]);continue}const r=t[(a-1+s)%s],c=t[a],l=t[(a+1)%s],d=(c.x-r.x)*(l.y-c.y)-(c.y-r.y)*(l.x-c.x);(o>=0?d>=0:d<=0)?i.push(c):(i.push({x:(r.x+c.x)*.5,y:(r.y+c.y)*.5}),i.push({x:(c.x+l.x)*.5,y:(c.y+l.y)*.5}))}return i}_buildMixedControlPoints(t,n,o){if(t.length<3)return t;const i=this._getPathOrientation(t,n),s=Math.max(0,o-1),a=[];n?t.length:t.length-1;for(let r=0;r<t.length;r++){const c=(r-1+t.length)%t.length,l=(r+1)%t.length,d=t[c],h=t[r],f=t[l],u=(h.x-d.x)*(f.y-h.y)-(h.y-d.y)*(f.x-h.x),p=!n&&(r===0||r===t.length-1)||(i>=0?u>=0:u<=0);if(a.push(h),p)for(let y=0;y<s;y++)a.push({x:h.x,y:h.y})}return a}_getPathOrientation(t,n){if(!n)return 1;let o=0;for(let i=0;i<t.length;i++){const s=t[(i+1)%t.length];o+=t[i].x*s.y-s.x*t[i].y}return o}_getPresetPoints(t){const n=this.state.previewPoints[t];if(n&&n.vertices&&n.edges)return this._buildPathsFromGraph(n);if(t==="open")return{paths:this.state.previewPoints.open.map(o=>({closed:!1,points:o}))};if(t==="branching"){const o=this.state.previewPoints.branching[0]||[],i=o.length>=1?o[o.length-1]:null,s=o.length>=2?o[o.length-2]:null,a=this.state.style.type==="spline",r=a?o.slice(Math.max(0,o.length-3)):o.slice(Math.max(0,o.length-2));return{paths:this.state.previewPoints.branching.map((c,l)=>{if(l===0)return{closed:!1,points:c,trimToPoint:a?s:null,forceTrim:a,trueEndpointStart:!0,trueEndpointEnd:!1};const d=[...r],h=c[0],u=i&&h&&Math.abs(h.x-i.x)<1e-6&&Math.abs(h.y-i.y)<1e-6?c.slice(1):c;return d.push(...u),{closed:!1,points:d,trimFromPoint:a?s:i,forceTrim:a,trueEndpointStart:!1,trueEndpointEnd:!0}})}}if(t==="branching4"){const o=this.state.previewPoints.branching4;if(!o)return{paths:[]};const i=o.in||[],s=o.out||[],a=d=>{const h=Math.hypot(d.x,d.y);return h>1e-6?{x:d.x/h,y:d.y/h}:{x:0,y:0}},r=i.map(d=>{if(d.length<2)return null;const h=d[d.length-1],f=d[d.length-2];return a({x:h.x-f.x,y:h.y-f.y})}),c=s.map(d=>{if(d.length<2)return null;const h=d[0],f=d[1];return a({x:f.x-h.x,y:f.y-h.y})});if(i.length!==1&&s.length!==1){const d=[];if(i.length===2&&s.length===2){const f=this.dragState?.presetId==="branching4"&&this.dragState.pointIndex!==null,u=T=>f?(this.branching4Pairing||(this.branching4Pairing=T),this.branching4Pairing):(this.branching4Pairing=null,T),g=r.map(T=>T?{x:-T.x,y:-T.y}:null),p=T=>Math.atan2(T.y,T.x),y=(T,v)=>{const E=g[T],O=c[v];return!E||!O?-1/0:E.x*O.x+E.y*O.y},x=(T,v)=>T.x*v.y-T.y*v.x,S=[{type:"in",idx:0,dir:g[0]},{type:"in",idx:1,dir:g[1]},{type:"out",idx:0,dir:c[0]},{type:"out",idx:1,dir:c[1]}].filter(T=>T.dir).slice().sort((T,v)=>p(T.dir)-p(v.dir)),I=S.map((T,v)=>T.type==="in"?v:null).filter(T=>T!==null),b=I.length===2&&(Math.abs(I[0]-I[1])===1||Math.abs(I[0]-I[1])===3),M=T=>y(0,T[0])+y(1,T[1]),C=[0,1],w=[1,0];let _=C;if(b){const T=(P,D)=>{const F=Math.abs(P-D);return Math.min(F,4-F)},v=P=>S.findIndex(D=>D.type==="out"&&D.idx===P),E=P=>S.findIndex(D=>D.type==="in"&&D.idx===P),O=P=>{const D=T(E(0),v(P[0])),F=T(E(1),v(P[1]));return D+F};_=O(w)>O(C)?w:C}else{const T=M(C),v=M(w);if(v===T&&this.state.style.type==="spline"){const E=O=>{const P=g[0]&&c[O[0]]?Math.sign(x(g[0],c[O[0]])):0,D=g[1]&&c[O[1]]?Math.sign(x(g[1],c[O[1]])):0;return(P<0?1:0)+(D<0?1:0)};_=E(w)>E(C)?w:C}else _=v>T?w:C}return _=u(_),i.forEach((T,v)=>{const E=_[v],O=s[E],P=O[0]===T[T.length-1]?O.slice(1):O;d.push({closed:!1,points:[...T,...P]})}),{paths:d}}const h=new Set;return i.forEach((f,u)=>{let g=-1,p=-1/0;const y=r[u];if(s.forEach((x,m)=>{if(h.has(m))return;const S=c[m];if(!y||!S)return;const I=y.x*S.x+y.y*S.y;I>p&&(p=I,g=m)}),g>=0){h.add(g);const x=s[g],m=x[0]===f[f.length-1]?x.slice(1):x;d.push({closed:!1,points:[...f,...m]})}else d.push({closed:!1,points:f})}),s.forEach((f,u)=>{h.has(u)||d.push({closed:!1,points:f})}),{paths:d}}const l=[];return i.length===1?s.forEach(d=>{const h=i[0],f=d[0]===h[h.length-1]?d.slice(1):d;l.push({closed:!1,points:[...h,...f]})}):i.forEach(d=>{const h=s[0],f=h[0]===d[d.length-1]?h.slice(1):h;l.push({closed:!1,points:[...d,...f]})}),{paths:l}}if(t==="branching5"){const o=this.state.previewPoints.branching5;if(!o)return{paths:[]};const i=o.in||[],s=o.out||[];return{paths:[...i.map(r=>({closed:!1,points:r})),...s.map(r=>({closed:!1,points:r}))]}}return{paths:[{closed:!0,points:this.state.previewPoints.closed[0]}]}}_buildPathsFromGraph(t){const n=t.vertices||[],o=t.edges||[];if(!n.length||!o.length)return{paths:[]};const i=new Map,s=new Map,a=new Map;o.forEach(([A,k])=>{i.has(A)||i.set(A,[]),i.get(A).push(k),s.has(k)||s.set(k,[]),s.get(k).push(A),a.set(A,(a.get(A)||0)+1),a.set(k,(a.get(k)||0)+1)});const r=new Map,c=new Map,l=(A,k)=>A<k?`${A}-${k}`:`${k}-${A}`;o.forEach(([A,k])=>{const V=l(A,k);c.has(V)||c.set(V,[A,k]),r.has(A)||r.set(A,new Set),r.has(k)||r.set(k,new Set),r.get(A).add(k),r.get(k).add(A)});const d=(A,k)=>Math.atan2(n[k].y-n[A].y,n[k].x-n[A].x),h=new Map;n.forEach((A,k)=>{const V=[...r.get(k)||[]];V.sort((X,Y)=>d(k,X)-d(k,Y)),h.set(k,V)});const f=(A,k)=>{const V=h.get(k)||[];if(!V.length)return null;const X=V.indexOf(A);return X<0?V[0]:V[(X-1+V.length)%V.length]},g=(()=>{const A=[],k=new Set,V=(X,Y)=>`${X}->${Y}`;return c.forEach(([X,Y])=>{[[X,Y],[Y,X]].forEach(([H,G])=>{const W=V(H,G);if(k.has(W))return;const Q=[];let te=H,pe=G,me=0;for(;me++<o.length*4;){k.add(V(te,pe)),Q.push(te);const vt=f(te,pe);if(vt==null)break;const Qe=pe,rt=vt;if(te=Qe,pe=rt,te===H&&pe===G)break}Q.length>=3&&A.push(Q)})}),A})(),p=A=>[...A].sort((k,V)=>k-V).join("_"),y=[],x=new Set;g.forEach(A=>{const k=p(A);x.has(k)||(x.add(k),y.push(A))});const m=A=>{let k=0;for(let V=0;V<A.length;V++){const X=n[A[V]],Y=n[A[(V+1)%A.length]];k+=X.x*Y.y-Y.x*X.y}return k*.5};let S=null;if(y.length){let A=null,k=-1/0;y.forEach(V=>{const X=Math.abs(m(V));X>k&&(k=X,A=V)}),S=A}const I=new Set(S||[]),b=new Set;if(S&&S.length>=2)for(let A=0;A<S.length;A++){const k=S[A],V=S[(A+1)%S.length];b.add(l(k,V))}const M=new Map,C=A=>Math.atan2(A.y,A.x),w=(A,k)=>A.x*k.y-A.y*k.x,_=(A,k)=>A.x*k.x+A.y*k.y,T=(A,k)=>({x:k.x-A.x,y:k.y-A.y}),v=A=>{const k=Math.hypot(A.x,A.y);return k>1e-6?{x:A.x/k,y:A.y/k}:{x:0,y:0}};n.forEach((A,k)=>{if(I.has(k))return;const V=s.get(k)||[],X=i.get(k)||[];if(V.length===2&&X.length===2){const Y=V.map(ve=>v(T(n[ve],n[k]))),H=X.map(ve=>v(T(n[k],n[ve]))),G=Y.map(ve=>({x:-ve.x,y:-ve.y})),W=(ve,Je)=>_(G[ve],H[Je]),Q=[0,1],te=[1,0],pe=W(0,0)+W(1,1),me=W(0,1)+W(1,0),Qe=[{type:"in",idx:0,dir:G[0]},{type:"in",idx:1,dir:G[1]},{type:"out",idx:0,dir:H[0]},{type:"out",idx:1,dir:H[1]}].filter(ve=>ve.dir).slice().sort((ve,Je)=>C(ve.dir)-C(Je.dir)),rt=Qe.map((ve,Je)=>ve.type==="in"?Je:null).filter(ve=>ve!==null),Xt=rt.length===2&&(Math.abs(rt[0]-rt[1])===1||Math.abs(rt[0]-rt[1])===3);let Nt=Q;if(Xt){const ve=(rn,Jt)=>{const Do=Math.abs(rn-Jt);return Math.min(Do,4-Do)},Je=rn=>Qe.findIndex(Jt=>Jt.type==="out"&&Jt.idx===rn),Mt=rn=>Qe.findIndex(Jt=>Jt.type==="in"&&Jt.idx===rn),Es=rn=>{const Jt=ve(Mt(0),Je(rn[0])),Do=ve(Mt(1),Je(rn[1]));return Jt+Do};Nt=Es(te)>Es(Q)?te:Q}else if(me===pe&&this.state.style.type==="spline"){const ve=Je=>{const Mt=Math.sign(w(G[0],H[Je[0]])),Es=Math.sign(w(G[1],H[Je[1]]));return(Mt<0?1:0)+(Es<0?1:0)};Nt=ve(te)>ve(Q)?te:Q}else Nt=me>pe?te:Q;V.forEach((ve,Je)=>{const Mt=X[Nt[Je]];M.set(`${ve}->${k}`,Mt)})}});const E=n.map((A,k)=>k).filter(A=>(s.get(A)||[]).length===0),O=[],P=new Set,D=(A,k)=>`${A}->${k}`,F=(A,k)=>b.has(l(A,k)),R=(A,k,V,X=!1)=>{const Y=D(A,k);if(P.has(Y)){O.push([...V,k]);return}P.add(Y);const H=[...V,k];if(!X&&I.has(k)&&H.length>1){O.push(H);return}const G=i.get(k)||[],W=s.get(k)||[],Q=M.get(`${A}->${k}`);if(Q!==void 0){if(H.includes(Q)){O.push(H);return}R(k,Q,H);return}if(G.length===0){O.push(H);return}if(W.length===2&&G.length>2){O.push(H);return}if(W.length===1&&G.length>1){G.forEach(te=>{!X&&F(k,te)||R(k,te,H,X)});return}if(W.length<=1&&G.length===1){if(!X&&F(k,G[0])){O.push(H);return}R(k,G[0],H,X);return}G.forEach(te=>{!X&&F(k,te)||R(k,te,H,X)})};let B=null;if(S&&S.length>=3)B=[...S,S[0]],O.push(B),o.forEach(([A,k])=>{F(A,k)&&P.add(D(A,k))}),o.forEach(([A,k])=>{const V=D(A,k);P.has(V)||R(A,k,[A],!1)});else if(E.length)E.forEach(A=>{(i.get(A)||[]).forEach(V=>R(A,V,[A]))});else{const A=o[0]?.[0];A!==void 0&&(i.get(A)||[]).forEach(V=>R(A,V,[A]))}const L=O.map(A=>{const k=A.length>2&&A[0]===A[A.length-1],V=k?A.slice(0,-1):A,X=V.map(te=>n[te]),Y=V[0],H=V[V.length-1],G=a.get(Y)||0,W=a.get(H)||0,Q=A===B;return{closed:k,points:X,isBoundary:Q,trueEndpointStart:G===1,trueEndpointEnd:W===1,trimFromPoint:!Q&&this.state.style.type==="spline"&&G>2?n[Y]:null,trimToPoint:!Q&&this.state.style.type==="spline"&&W>2?n[H]:null,forceTrim:!Q&&this.state.style.type==="spline"}}),N=S?p(S):null,$=y.filter(A=>p(A)!==N);return{paths:L,vertices:n,faces:$}}_handlePreviewMouseDown(t,n){const o=this._findHitPoint(t,n);o&&(this.dragState=o,t.preventDefault())}_handlePreviewMouseMove(t){const{presetId:n,pathIndex:o,pointIndex:i,vertexIndex:s,ioType:a,ioIndex:r}=this.dragState;if(n===null)return;const c=this.previewCards.get(n);if(!c)return;const{x:l,y:d}=this._getNormalizedPoint(t,c.canvas),h={x:Math.max(0,Math.min(1,l)),y:Math.max(0,Math.min(1,d))},f=this.state.previewPoints[n];if(f&&f.in&&f.out&&a&&Number.isInteger(r)){const m=f[a]?.[r]?.[i];m&&(m.x=h.x,m.y=h.y,this._renderAllPreviews());return}if(f&&f.vertices&&f.edges){Number.isInteger(s)&&f.vertices[s]&&(f.vertices[s].x=h.x,f.vertices[s].y=h.y,f.pathOverrides&&delete f.pathOverrides,this._renderAllPreviews());return}const g=(f&&f.vertices&&f.edges?f.pathOverrides?.map(y=>y.points):this.state.previewPoints[n])?.[o];if(!g)return;const p=g[i];p?(p.x=h.x,p.y=h.y):g[i]=h,this._renderAllPreviews()}_handlePreviewMouseUp(){this.dragState={presetId:null,pathIndex:null,pointIndex:null,vertexIndex:null,ioType:null,ioIndex:null},this.branching4Pairing=null}_findHitPoint(t,n){const o=this.previewCards.get(n);if(!o)return null;const s=o.canvas.getBoundingClientRect(),a=t.clientX-s.left,r=t.clientY-s.top,c=16,l=s.width-c*2,d=s.height-c*2,h=8,f=this.state.previewPoints[n];if(f&&f.in&&f.out){const g=[...f.in.map((p,y)=>({points:p,ioType:"in",ioIndex:y})),...f.out.map((p,y)=>({points:p,ioType:"out",ioIndex:y}))];for(let p=0;p<g.length;p++){const{points:y,ioType:x,ioIndex:m}=g[p];for(let S=0;S<y.length;S++){const I=c+y[S].x*l,b=c+y[S].y*d;if(Math.hypot(a-I,r-b)<=h)return{presetId:n,pathIndex:p,pointIndex:S,vertexIndex:null,ioType:x,ioIndex:m}}}return null}const u=f&&f.vertices&&f.edges?this._getPresetPoints(n).paths.map(g=>g.points):this.state.previewPoints[n];for(let g=0;g<u.length;g++){const p=u[g];for(let y=0;y<p.length;y++){const x=c+p[y].x*l,m=c+p[y].y*d;if(Math.hypot(a-x,r-m)<=h){let S=null;return f&&f.vertices&&f.edges&&(S=f.vertices.indexOf(p[y]),S<0&&(S=null)),{presetId:n,pathIndex:g,pointIndex:y,vertexIndex:S,ioType:null,ioIndex:null}}}}return null}_getNormalizedPoint(t,n){const o=n.getBoundingClientRect(),i=16,s=o.width-i*2,a=o.height-i*2,r=(t.clientX-o.left-i)/s,c=(t.clientY-o.top-i)/a;return{x:r,y:c}}}function oo(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Zl(e){if(e==null)return[{type:"text",content:""}];const t=String(e);if(t==="")return[{type:"text",content:""}];const n=/(\$\$([\s\S]+?)\$\$|\$([^$\\]*(?:\\.[^$\\]*)*)\$|\\\$)/g,o=[];let i=0,s;for(;(s=n.exec(t))!==null;){const c=s[0],l=s.index;l>i&&o.push({type:"text",content:t.substring(i,l)}),c==="\\$"?o.push({type:"text",content:"$"}):o.push({type:"math",content:c}),i=l+c.length}i<t.length&&o.push({type:"text",content:t.substring(i)});const a=[];let r=null;for(const c of o)c.type==="text"?r===null?r={type:"text",content:c.content}:r.content+=c.content:(r!==null&&(a.push(r),r=null),a.push(c));return r!==null&&a.push(r),a.length===0&&o.length===1&&o[0].type==="text"?o:a}function Ql(e){const t=e.match(/^\$\$([\s\S]+)\$\$$/),n=e.match(/^\$([^$]+)\$$/);let o=null,i=!1;if(t&&t[1]?.trim()?(o=t[1].trim(),i=!0):n&&n[1]?.trim()&&(o=n[1].trim(),i=!1),o===null)return`<span class="text-segment">${oo(e)}</span>`;try{if(typeof katex>"u")throw new Error("KaTeX not loaded");return katex.renderToString(o,{throwOnError:!1,displayMode:i,output:"html",strict:"warn"})}catch(s){return console.error("KaTeX renderToString unexpected error:",s),`<span class="katex-error" title="${oo(s.message||"Unknown KaTeX error")}">${oo(e)}</span>`}}function ec(e,t,n={}){if(!e){console.warn("renderStringToElement: No container provided");return}const o=t==null?"":String(t);let i="";try{i=Zl(o).map(a=>a.type==="text"?`<span class="text-segment">${oo(a.content)}</span>`:a.type==="math"?Ql(a.content):"").join("")}catch(s){console.error("Error processing string segments for rendering:",s,o),i=`<span class="katex-error" title="${oo(String(s.message||"Unknown error"))}">Error</span>`}e.innerHTML=i}function tc(e,t={}){const{debug:n=!1}=t;if(n&&console.log("[formatStringToMathDisplay] Input:",e),typeof e!="string"||e.trim()==="")return"";const o=/(\\[a-zA-Z]_\\[a-zA-Z])|(\\\\)|(\\[a-zA-Z]{2,})|(\\[a-zA-Z])|([a-zA-Z][a-zA-Z0-9]*)|([0-9]+(?:\.[0-9]+)?)|(\$)|(&)|( )|(\r?\n)|([\s\S])/g;let i;const s=[];for(o.lastIndex=0;(i=o.exec(e))!==null;){const[,f,u,g,p,y,x,m,S,I,b,M]=i;let C={};if(f){const w=f.split("_"),_=w[0].slice(1),T=w[1].slice(1);C={type:"backslashSubscript",value:`\\mathrm{${_}}_\\mathrm{${T}}`}}else if(u)C={type:"doubleBackslash",value:"\\\\"};else if(g)C={type:"command",value:g};else if(p)C={type:"backslashLetter",value:p.slice(1)};else if(y){C={type:"word",value:y};const w=s[s.length-1],_=s[s.length-2],T=w?.type==="other"&&w.value==="{"&&_?.type==="command";C.isArgument=T}else x?C={type:"number",value:x}:m?C={type:"dollar",value:"\\$"}:S?C={type:"ampersand",value:"&"}:I?C={type:"space",value:" "}:b?C={type:"newline",value:"\\\\"}:M&&(C={type:"other",value:M});C.type&&s.push(C)}const a=["a","I"],r=["+","-","=","*","/","<",">"],c=(f,u)=>{let g=f+u;for(;g>=0&&g<s.length;){if(s[g].type!=="space")return s[g];g+=u}return null},l=f=>f?f.type==="other"&&r.includes(f.value):!1,d=f=>f?f.type==="backslashLetter"||f.type==="word"&&f.value.length===1&&!a.includes(f.value):!1;let h="";for(let f=0;f<s.length;f++){const u=s[f];switch(u.type){case"command":case"number":case"ampersand":case"doubleBackslash":case"newline":case"backslashSubscript":case"dollar":h+=u.value;break;case"other":["#","%"].includes(u.value)?h+="\\"+u.value:h+=u.value;break;case"backslashLetter":h+=u.value;break;case"word":if(u.isArgument)h+=u.value;else if(u.value.length>1)h+=`\\mathrm{${u.value}}`;else{const m=s[f-1],S=s[f-2],I=m?.type==="other"&&m.value==="(",b=I&&S?.type==="space",M=I&&S?.type!=="space",C=c(f,-1),w=c(f,1),_=l(C)||l(w);b?h+=`\\mathrm{${u.value}}`:a.includes(u.value)?_||M?h+=u.value:h+=`\\mathrm{${u.value}}`:h+=u.value}break;case"space":let p=!0;const y=c(f,-1),x=c(f,1);if(!y||!x)p=!0;else{const m=d(y),S=d(x),I=l(y),b=l(x);(I||b)&&(p=!1),m&&S&&(p=!1)}h+=p?"\\ ":" ";break;default:h+=u.value;break}}if(h.endsWith("\\ ")){const f=h.match(/(\\ )+$/);if(f){const u=f[0].length/2,g="\\,".repeat(u);h=h.replace(/(\\ )+$/,g)}}return h===""?"":`$$${h}$$`}const nc={activeCenterGlow:"#00ffff",uiIconDisabled:"#ff0000",helperLine:"rgba(200, 200, 200, 0.6)",coordSysX:"#ff0000",coordSysY:"#00ff00",coordSysOrigin:"#0000ff",checkerboardColor1:"#808080",checkerboardColor2:"#c0c0c0",background:"#1a1a1a",htmlBody:"#1e1e1e",grid:[136,136,136],axis:"rgba(255, 255, 255, 1)",axisTickLabel:[255,255,255],defaultStroke:"white",vertex:"#ffffff",edge:"#BFC5D0",face:"#808080",frozenReference:"rgba(240, 240, 130, 0.95)",feedbackDefault:[230,230,230],feedbackSnapped:"rgba(240, 240, 130, 0.95)",geometryInfoText:"rgba(255, 255, 255, 0.95)",geometryInfoTextSnapped:"rgba(240, 240, 130, 0.95)",mouseCoords:"rgba(255, 255, 255, 0.7)",uiIcon:"white",uiIconDefault:"#9CA3AF",uiIconSelected:"#F9FAFB",uiTextSelected:"#E0F2FE",uiTextDefault:"#D1D5DB",uiDefault:"rgba(255, 255, 255, 0.8)",selectionGlow:"#4da6ff",activeCenterGlow:"#00ffff",helperLine:"rgba(200, 200, 200, 0.6)"},sc={background:"#e5e5e5",htmlBody:"#e1e1e1",grid:[119,119,119],axis:"rgba(0, 0, 0, 1)",axisTickLabel:[0,0,0],defaultStroke:"black",vertex:"#000000",edge:"#403A2F",face:"#7F7F7F",frozenReference:"rgba(217, 119, 6, 0.95)",feedbackDefault:[25,25,25],feedbackSnapped:"rgba(217, 119, 6, 0.95)",geometryInfoText:"rgba(0, 0, 0, 0.95)",geometryInfoTextSnapped:"rgba(217, 119, 6, 0.95)",mouseCoords:"rgba(0, 0, 0, 0.7)",uiIcon:"black",uiIconDefault:"#635C50",uiIconSelected:"#060504",uiTextSelected:"#1F0D01",uiTextDefault:"#2E2A24",uiDefault:"rgba(0, 0, 0, 0.8)",selectionGlow:"#0059B3",activeCenterGlow:"#008080",helperLine:"rgba(55, 55, 55, 0.6)",coordSysX:"#ff0000",coordSysY:"#008000",coordSysOrigin:"#0000ff",checkerboardColor1:"#ffffff",checkerboardColor2:"#cccccc",uiIconDisabled:"#cc0000"},ar=5,so=25,Ki=20,oc=20,ic=.1,Br=[1/4,1/3,1/2,2/3,3/4],Ji=4,zn=30,Fe=5,Si=zn/2,ma=10,ts=2,Tn=1,Mn=[6,6],Fr=[3,3],Oi=360,io=180,$r=90,$e=2*Math.PI,Ii=.01,xa=Math.sqrt(3)/2,ac=400,rc=Math.PI/3,lc=1.5,qt=Math.PI/6,cc=1.5,dc=[2,3],hc=[1,3],fc=.01,uc=8,pc=5,gc=Math.PI/24,yc=15,zs="_EDGE_",jo=300,mc=3,Sa=7,rr=1e-15,lr=1e13,cr=1.15,xc=1e-5,Sc=1-1e-5,Ia=.001,Vr=.01,Ic=.95,bc=100,vc=1.5,Mc=.5,Cc=1.5,et=4,Ko=.9,ns=24,ss=10,Bn=8,mt=20,De=12,Zi=5,Qi=20,ea=10,ta=5,Ni=20,Bi=12,Ec="\\phantom{-}0",Xo="i",Lo="r",wc="\\mathrm{Re}",Tc="\\mathrm{Im}",Pc=80,na=1,Fi=Math.PI/2,_c="#808080",As="rgba(128, 128, 128, 1)",Ac=4,Dc=.25,je=10,Le=56,ba=35,dr=10,kc=36,Rc=30,ut=40,Lc=20,Qs=32,va=2,yn=1.5,$i=[2,4],Cn=1.5,fo=10,Yr=3,eo=15,Oc=24,Nc="T",Bc=35,Fc=12,$c=10,Vc=10,Yc=3,os=2,Ns=2,Ht=7,Vi=30,bi=["#ffffff","#BFC5D0","#808080","#ff4444","#44ff44","#4444ff","#ffff44","#ff44ff","rgba(0, 0, 0, 0)"],Yi=4,tn=12,Hs=30,Fn=18,jt=1,Xr=1.5,sa=11,Jo=18,Zo=60,zr=20,Hr=8,Xc=20,hr=18,oa=1e6,ia=1e-6,Qo=1e-5,is=.015,Ds=32,zc=10,fr=16,Hc=12,Gc=14,Ts="\\hphantom{-}",Et="\\pi",ur="\\delta = ",no="\\theta = ",Ma=15,fs=.8,ei=3,Hn=2,Wc=1,qc=3,Uc=1,jc=140,pr=.4,Kc=.9,Oo=.05,Jc=10,gr=1.5,Xi=[15,5,1],yr=80,Zc=.01,re=1e-9,Ca=50,Qc=6,ed=10,Ea=(()=>{const e=new Set,t=[1,2,3,4,5];for(const n of t)for(let o=1;o<=n*4;o++)e.add(o/n);return Array.from(e).sort((n,o)=>n-o)})();function td(e,t){const n=new Set;n.add(0);for(let o=1;o<=e;o++)for(let i=1;i<=o*t;i++)n.add(i/o);return Array.from(n).sort((o,i)=>o-i)}const $n=td(Qc,ed),Pn="regular",Kt=" transformation_rotation",Rn=" transformation_scale",sn="transformation_rotate_scale",Jn="transformation_directional_scale",vi="none",wa="regular",uo="complex",Mi="polar",Io="none",Ta="lines",Pa="points",_a="triangular",Aa="polar",us="degrees",bo="radians",po="none",go="on",nd="none",sd=" ",od="Escape",id="Delete",ad="Backspace",rd="r",mr="=",xr="+",Sr="-",Ir="c",br="v",vr="x",zi="z",Mr="y",Cr="a",_e="vertex",Re="edge",we="face",It="text",ld=e=>[[-e,2-e,-2+e,e],[2*e,-3+e,3-2*e,-e],[-e,0,e,0],[0,1,0,0]],cd=(e,t)=>{if(e.length<2)return[];const n=e.length,o=l=>(l+n)%n,i=()=>({x:e[0].x+(e[0].x-e[1].x),y:e[0].y+(e[0].y-e[1].y)}),s=()=>({x:e[n-1].x+(e[n-1].x-e[n-2].x),y:e[n-1].y+(e[n-1].y-e[n-2].y)}),a=l=>t?e[o(l)]:l<0?i():l>=n?s():e[l],r=t?n:n-1,c=[];for(let l=0;l<r;l++)c.push({index:l,p0:a(l-1),p1:a(l),p2:a(l+1),p3:a(l+2)});return c},Er=e=>{const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},wr=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),dd=(e,t)=>{const n=Math.PI*2;let o=(t-e)%n;return o<0&&(o+=n),o>Math.PI&&(o-=n),o},ao=(e,t=!1)=>{const n=[],o=e.length,i=t?o:o-1;for(let s=0;s<i;s++)n.push({type:"line",a:e[s],b:e[(s+1)%o]});return n},hd=(e,t=!1,n=.5)=>{const i=(1-Math.max(0,Math.min(1,n)))*.5,s=ld(i),a=[];return cd(e,t).forEach(({p0:c,p1:l,p2:d,p3:h})=>{const f=[c.x,l.x,d.x,h.x],u=[c.y,l.y,d.y,h.y],g=s.map(y=>y.reduce((x,m,S)=>x+m*f[S],0)),p=s.map(y=>y.reduce((x,m,S)=>x+m*u[S],0));a.push({type:"cubic",coeffX:g,coeffY:p})}),a},fd=(e,t,n,o)=>{if(e.length<2||o<=1e-6)return ao(e,t);const i=e.length,s=n==="fixed"?"absolute":n,a=[],r=l=>{const d=e[(l-1+i)%i],h=e[l],f=e[(l+1)%i],u=wr(d,h),g=wr(f,h),p=Math.hypot(u.x,u.y),y=Math.hypot(g.x,g.y);if(p<=1e-6||y<=1e-6)return null;const x=Math.min(p,y)*.5;let m,S,I;if(s==="absolute"?(m=Math.max(0,Math.min(o,x))*2,S=Er(g),I=Er(u)):(m=Math.max(0,Math.min(1,o)),S=g,I=u),m<=1e-6)return null;const b=m*.5,M=s==="absolute"?p*.5:.5,C=s==="absolute"?y*.5:.5,w={x:h.x+I.x*M,y:h.y+I.y*M},_={x:h.x+S.x*C,y:h.y+S.y*C},T={x:h.x+I.x*b,y:h.y+I.y*b},v={x:h.x+S.x*b,y:h.y+S.y*b},E=Math.PI,O=-Math.PI/2,P=dd(E,O);return{origin:h,axisX:S,axisY:I,baseScale:m,midIn:w,midOut:_,arcStart:T,arcEnd:v,startAngle:E,sweep:P}};if(t){const l=[];for(let d=0;d<i;d++){const h=r(d);h&&l.push(h)}return l.length?(a.push({type:"line",a:l[0].midIn,b:l[0].arcStart}),l.forEach(d=>{a.push({type:"affineArc",origin:d.origin,axisX:d.axisX,axisY:d.axisY,baseScale:d.baseScale,startAngle:d.startAngle,sweep:d.sweep}),a.push({type:"line",a:d.arcEnd,b:d.midOut})}),a.push({type:"line",a:l[l.length-1].midOut,b:l[0].midIn}),a):ao(e,!0)}const c=[];for(let l=1;l<i-1;l++){const d=r(l);d&&c.push(d)}return c.length?(a.push({type:"line",a:e[0],b:c[0].midIn}),c.forEach(l=>{a.push({type:"line",a:l.midIn,b:l.arcStart}),a.push({type:"affineArc",origin:l.origin,axisX:l.axisX,axisY:l.axisY,baseScale:l.baseScale,startAngle:l.startAngle,sweep:l.sweep}),a.push({type:"line",a:l.arcEnd,b:l.midOut})}),a.push({type:"line",a:c[c.length-1].midOut,b:e[i-1]}),a):ao(e,!1)};function ud(e,t,n=!1){return!t||e.length<2?[]:t.type==="linear"?ao(e,n):t.type==="cubic_spline"?hd(e,n,t.tension??.5):t.type==="circular_arc"?fd(e,n,t.radiusMode??"relative",t.radiusValue??0):ao(e,n)}function pd(e,t){const n=[];return e.forEach((o,i)=>{const s=(a,r=!1)=>{i>0,n.push(a)};if(o.type==="line"){const a=o.a,r=o.b,c=t?t(a):a,l=t?t(r):r,d=Math.hypot(l.x-c.x,l.y-c.y),h=Math.max(2,Math.ceil(d/8));for(let f=0;f<=h;f++){const u=f/h;s({x:a.x+(r.x-a.x)*u,y:a.y+(r.y-a.y)*u},f===0)}return}if(o.type==="cubic"){const a=o.coeffX,r=o.coeffY,c=p=>({x:((a[0]*p+a[1])*p+a[2])*p+a[3],y:((r[0]*p+r[1])*p+r[2])*p+r[3]}),l=c(0),d=c(1),h=t?t(l):l,f=t?t(d):d,u=Math.hypot(f.x-h.x,f.y-h.y),g=Math.max(4,Math.ceil(u/6));for(let p=0;p<=g;p++){const y=p/g;s(c(y),p===0)}return}if(o.type==="affineArc"){const{origin:a,axisX:r,axisY:c,baseScale:l,startAngle:d,sweep:h}=o,f=l*.5,u={x:f,y:f},g=24;for(let p=0;p<=g;p++){const y=p/g,x=d+h*y,m={x:u.x+Math.cos(x)*f,y:u.y+Math.sin(x)*f};s({x:a.x+r.x*m.x+c.x*m.y,y:a.y+r.y*m.x+c.y*m.y},p===0)}}}),n}function Gs(e,t,n=!1,o=null){const i=ud(e,t,n);return i.length?pd(i,o):e}function lt(e,t,n=!1){if(e===0)return"0";const o=Math.abs(e),i=e<0?"-":"";let s;if(n||o>=oa||o!==0&&o<ia){if(e===0)return"0";const r=o.toExponential(Math.max(0,t-1)).split("e");let c=parseFloat(r[0]).toString(),l=parseInt(r[1],10);s=`${c} \\cdot 10^{${l}}`}else{const a=o<1?0:Math.floor(Math.log10(o))+1;let r;if(o===0)r=t-1;else if(o<1){let d=0,h=o;for(;h<1&&d<t+5;)h*=10,d++;r=Math.max(0,d-1+t)}else r=Math.max(0,t-a);let c=o.toFixed(r),l=parseFloat(c);if(Math.abs(l)===0&&e!==0)return"0";s=Math.abs(l).toString()}return i+s}function Da(e,t){return t===0?e:Da(t,e%t)}function ne(e){return e.id1<e.id2?`${e.id1}${zs}${e.id2}`:`${e.id2}${zs}${e.id1}`}function No(e,t,n,o,i,s){const a=i-n,r=s-o,c=a*a+r*r;if(c===0){const g=e-n,p=t-o;return Math.sqrt(g*g+p*p)}let l=-((n-e)*a+(o-t)*r)/c;l<0&&(l=0),l>1&&(l=1);const d=n+l*a,h=o+l*r,f=e-d,u=t-h;return Math.sqrt(f*f+u*u)}function ge(e){return e.id?e.id:e.vertexIds?`face_${[...e.vertexIds].sort().join("_")}`:null}function Gn(e,t,n,o,i=!1){const s=[];if(t==="none"||!n||n<=0)return s;if(t==="polar"){const a=(Math.atan2(e.y,e.x)*180/Math.PI+360)%360,r=Math.hypot(e.x,e.y),c=Math.round(r/n)*n;o.forEach(l=>{if(l.alpha>.01&&l.angle>0){const d=l.angle,f=Math.round(a/d)*d*Math.PI/180;s.push({x:c*Math.cos(f),y:c*Math.sin(f),isGridPoint:!0})}})}else if(t==="triangular"){const a=n*xa,r=e.x/n-e.y/(n*Math.sqrt(3)),c=e.y/a;let l=Math.round(r),d=Math.round(c),h=Math.round(-r-c);const f=Math.abs(l-r),u=Math.abs(d-c),g=Math.abs(h-(-r-c));f>u&&f>g?l=-d-h:u>g&&(d=-l-h);const p=l*n+d*n/2,y=d*a;s.push({x:p,y,isGridPoint:!0})}else if(i){const a=Math.floor(e.x/n)*n,r=Math.floor(e.y/n)*n;s.push({x:a,y:r,isGridPoint:!0},{x:a+n,y:r,isGridPoint:!0},{x:a,y:r+n,isGridPoint:!0},{x:a+n,y:r+n,isGridPoint:!0})}else s.push({x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n,isGridPoint:!0});return s}function Lt(){return crypto.randomUUID()}function bn(e){for(;e<0;)e+=$e;for(;e>=$e;)e-=$e;return e}function Tr(e,t,n=0){let o=t-e,i=Math.round((n-o)/(2*Math.PI));return o+i*(2*Math.PI)}function nt(e){return e=bn(e),e>Math.PI&&(e-=$e),e}function gd(e){for(;e<0;)e+=Oi;for(;e>=Oi;)e-=Oi;return e}function ka(e,t){const{p1:n,p2:o}=e,{center:i,radius:s}=t,a={x:o.x-n.x,y:o.y-n.y},r={x:n.x-i.x,y:n.y-i.y},c=a.x*a.x+a.y*a.y,l=2*(r.x*a.x+r.y*a.y),d=r.x*r.x+r.y*r.y-s*s;let h=l*l-4*c*d;if(h<0)return[];h=Math.sqrt(h);const f=(-l-h)/(2*c),u=(-l+h)/(2*c);return[{x:n.x+f*a.x,y:n.y+f*a.y},{x:n.x+u*a.x,y:n.y+u*a.y}]}function ls(e){if(e<0||!Number.isInteger(e))return[null,null];if(e===0)return[0,1];let t=1,n=e;for(let o=2;o*o<=n;o++)for(;n%(o*o)===0;)n/=o*o,t*=o;return[t,n]}function cs(e,t,n=""){const o=n?`\\${n}`:"";return t===1?e===1&&n?o:`${e}${o}`:e===1?`\\sqrt{${t}}${o}`:`${e}\\sqrt{${t}}${o}`}function J(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Ut(e,t=is,n=Ds){if(Math.abs(e)<Qo)return"0";const o=e<0?"-":"",i=Math.abs(e);if(Math.abs(i-Math.round(i))<t){const r=Math.round(i);return o+r.toString()}const s=[[1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6],[1,8],[3,8],[5,8],[7,8],[1,10],[3,10],[7,10],[9,10],[1,12],[5,12],[7,12],[11,12],[1,16],[3,16],[5,16],[7,16],[9,16],[11,16],[13,16],[15,16]];for(const[r,c]of s)if(c<=n&&Math.abs(i-r/c)<t)return o+`${r}/${c}`;for(let r=1;r<=n;r++){const c=Math.round(i*r);if(!(c===0&&i>Qo)&&Math.abs(i-c/r)<t/r){const l=Da(c,r),d=c/l,h=r/l;return h===1?o+`${d}`:o+`${d}/${h}`}}let a=2;return i<.01?a=3:i<.1?a=2:i<10?a=1:a=0,o+i.toFixed(a)}function ps(e,t){if(t.length<3)return!1;const n=e.x,o=e.y;let i=!1;for(let s=0,a=t.length-1;s<t.length;a=s++){const r=t[s].x,c=t[s].y,l=t[a].x,d=t[a].y;if(r===n&&c===o||c===d&&c===o&&n>=Math.min(r,l)&&n<=Math.max(r,l)||r===l&&r===n&&o>=Math.min(c,d)&&o<=Math.max(c,d))return!0;c>o!=d>o&&n<(l-r)*(o-c)/(d-c)+r&&(i=!i)}return i}function Ws(e){if(!e||typeof e!="string")return{r:255,g:255,b:255,a:1};if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:Math.max(0,Math.min(1,parseFloat(t[4])))}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:Math.max(0,Math.min(255,parseInt(t[1]))),g:Math.max(0,Math.min(255,parseInt(t[2]))),b:Math.max(0,Math.min(255,parseInt(t[3]))),a:1}}if(e.startsWith("#")){const t=e.slice(1);if(t.length===6)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16),a:1};if(t.length===3)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1}}return{r:255,g:255,b:255,a:1}}function yd(e,t,n){const o=t.localCoordSystem;if(!o)return null;const i=n(o.origin),s=uc;if(J(e,i)<s)return{face:t,type:"center"};const a=pc,r=_n({x:1,y:0},o),c=n(r);if(bt(e,i,c).distance<a)return{face:t,type:"x_axis"};const d=_n({x:0,y:1},o),h=n(d);return bt(e,i,h).distance<a?{face:t,type:"y_axis"}:null}function qs(e,t){if(ps(e,t))return e;let n=e,o=1/0;for(let i=0;i<t.length;i++){const s=t[i],a=t[(i+1)%t.length],r=bt(e,s,a);r.distance<o&&(o=r.distance,n={x:r.x,y:r.y})}return n}function md(e,t,{isToolbarExpanded:n,isColorPaletteExpanded:o,isColorModePanelExpanded:i,isInterpolationPanelExpanded:s,isTransformPanelExpanded:a,isDisplayPanelExpanded:r,isVisibilityPanelExpanded:c,isSessionsPanelExpanded:l}){const d=(h,f)=>f?h.x>=f.x&&h.x<=f.x+f.width&&h.y>=f.y&&h.y<=f.y+f.height:!1;if(o){for(const h of t.colorTargetIcons||[])if(d(e,h))return{...h,type:"colorTargetIcon"};for(const h of t.colorSwatches||[])if(d(e,h))return{...h,type:"colorSwatch"};if(d(e,t.applyColorsButton))return{...t.applyColorsButton,type:"button"};if(d(e,t.randomColorButton))return{...t.randomColorButton,type:"button"};if(d(e,t.removeColorButton))return{...t.removeColorButton,type:"button"};if(d(e,t.addColorButton))return{...t.addColorButton,type:"button"}}if(i){for(const h of t.colorModeIcons||[])if(d(e,h))return{...h,type:"colorModeIcon"}}if(a){for(const h of t.transformIcons||[])if(d(e,h))return{...h,type:"transformIcon"}}if(s){for(const h of t.interpolationIcons||[])if(d(e,h))return{...h,type:"interpolationIcon"}}if(r){for(const h of t.displayIcons||[])if(d(e,h))return{...h,type:"displayIcon"}}if(c){for(const h of t.visibilityIcons||[])if(d(e,h))return{...h,type:"visibilityIcon"}}if(l){for(const h of t.sessionIcons||[])if(d(e,h))return{...h,type:"sessionIcon"};if(d(e,t.removeSessionButton))return{...t.removeSessionButton,type:"button"};if(d(e,t.addSessionButton))return{...t.addSessionButton,type:"button"}}if(n){if(d(e,t.colorToolButton))return{...t.colorToolButton,type:"toolButton"};if(d(e,t.interpolationToolButton))return{...t.interpolationToolButton,type:"toolButton"};if(d(e,t.transformToolButton))return{...t.transformToolButton,type:"toolButton"};if(d(e,t.displayToolButton))return{...t.displayToolButton,type:"toolButton"};if(d(e,t.visibilityToolButton))return{...t.visibilityToolButton,type:"toolButton"};if(d(e,t.themeToggleButton))return{...t.themeToggleButton,type:"toolButton"};if(d(e,t.sessionsToolButton))return{...t.sessionsToolButton,type:"toolButton"};if(d(e,t.colorModeToolButton))return{...t.colorModeToolButton,type:"toolButton"}}return d(e,t.toolbarButton)?{...t.toolbarButton,type:"menuButton"}:null}function xd(e){const t=Math.hypot(e.x,e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}}function bt(e,t,n){const o=n.x-t.x,i=n.y-t.y,s=e.x-t.x,a=e.y-t.y,r=o*o+i*i;if(r===0)return{x:t.x,y:t.y,distance:J(e,t),onSegmentStrict:!0,t:0};let c=(s*o+a*i)/r;const l=c>xc&&c<Sc,d=Math.max(0,Math.min(1,c)),h=t.x+d*o,f=t.y+d*i,u=J(e,{x:h,y:f});return{x:h,y:f,distance:u,onSegmentStrict:l,t:d}}function Gr(e,t,n){const o=n.x-t.x,i=n.y-t.y,s=e.x-t.x,a=e.y-t.y,r=o*o+i*i;if(r===0)return{x:t.x,y:t.y,distance:J(e,t)};let c=(s*o+a*i)/r;const l=t.x+c*o,d=t.y+c*i,h=J(e,{x:l,y:d});return{x:l,y:d,distance:h}}function Bs(e,t={},n=0){if(!e||typeof e!="string")return n;const o=e.trim();if(!o)return n;try{const i={...t},s=Object.keys(i),a=s.map(l=>i[l]),c=new Function(...s,`'use strict'; return (${o});`)(...a);return Number.isFinite(c)?c:n}catch{return n}}function to(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}function Hi(e,t,n){e/=255,t/=255,n/=255;const o=Math.max(e,t,n),i=Math.min(e,t,n);let s,a,r=(o+i)/2;if(o===i)s=a=0;else{const c=o-i;switch(a=r>.5?c/(2-o-i):c/(o+i),o){case e:s=(t-n)/c+(t<n?6:0);break;case t:s=(n-e)/c+2;break;case n:s=(e-t)/c+4;break}s/=6}return[s,a,r]}function Sd(e,t,n,o,i=null){const s=Math.atan2(e.y-t.y,e.x-t.x);if(!o)return{angle:s,edgeIndex:null,snapType:null,snapped:!1,targetVertexId:null};const a=gc;let r={angle:s,difference:1/0,edgeIndex:null,snapType:null,targetVertexId:null};const c={edge:1,vertex_direction:2,cardinal:3},l=(h,f,u=null,g=null)=>{const p=nt(h),y=Math.abs(nt(s-p));if(y<a){const x=c[f],m=r.snapType?c[r.snapType]:1/0;x<m?r={angle:p,difference:y,edgeIndex:u,snapType:f,targetVertexId:g}:x===m&&y<r.difference&&(r={angle:p,difference:y,edgeIndex:u,snapType:f,targetVertexId:g})}};return o.edgeAngles&&o.edgeAngles.forEach((h,f)=>{[h,h+Math.PI/2,h-Math.PI/2,h+Math.PI].forEach(u=>{l(u,"edge",f)})}),o.vertices&&o.vertices.forEach(h=>{if(J(t,h)>re){const f=Math.atan2(h.y-t.y,h.x-t.x);l(f,"vertex_direction",null,h.id)}}),[0,Math.PI/2,Math.PI,-Math.PI/2].forEach(h=>l(h,"cardinal")),{angle:r.angle,edgeIndex:r.edgeIndex,snapType:r.snapType,snapped:r.difference<1/0,targetVertexId:r.targetVertexId}}function Id(e,t,n,o,i,s=null,a=null,r="x_axis"){if(!s||!a||!n.alignedEdgeInfo)return{snapped:!1};const c=yc/a.scale;let l=[];const{v1Id:d,v2Id:h}=n.alignedEdgeInfo,f=i(d),u=i(h);if(f&&u&&f.type==="regular"&&u.type==="regular"){const p=J(f,u);[.25,1/3,.5,2/3,.75,1].forEach(x=>{const m=p*x,S=Math.abs(s-m);l.push({scale:m,distance:S,type:"edge_fraction",priority:x===.5?1:x===1?2:3,fraction:x})})}if(l.length===0)return{snapped:!1};l.sort((p,y)=>p.priority!==y.priority?p.priority-y.priority:p.distance-y.distance);const g=l.find(p=>p.distance<c);return g?{snapped:!0,scale:g.scale,snapType:"edge_fraction",edgeFraction:g.fraction}:{snapped:!1}}function bd(e,t,n,o,i){let s=null,a=1/0;if(t&&(t.vertices&&t.vertices.forEach(r=>{const c=J(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:r,snapType:"vertex",vertexId:r.id})}),t.edgeMidvertices&&t.edgeMidvertices.forEach(r=>{const c=J(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:{x:r.x,y:r.y},snapType:"edge",edgeInfo:{v1:r.v1,v2:r.v2}})}),t.faceCenters&&t.faceCenters.forEach(r=>{const c=J(e,r);c<a&&(a=c,s={snapped:!0,snapPoint:r,snapType:"faceCenter"})})),n&&n!=="none"&&o&&o.interval1){const r=o.alpha2>o.alpha1&&o.interval2?o.interval2:o.interval1;Gn(e,n,r,i,!0).forEach(l=>{const d=J(e,l);d<a&&(a=d,s={snapped:!0,snapPoint:l,snapType:"grid"})})}return s||{snapped:!1}}function vd(e){if(Array.isArray(e)){const[t,n,o]=Hi(e[0],e[1],e[2]),i=1-o,[s,a,r]=Gi(t,n,i);return[s,a,r]}if(typeof e=="string"){if(e.startsWith("rgba(")){const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(t){const[,n,o,i,s]=t,a=parseInt(n),r=parseInt(o),c=parseInt(i),[l,d,h]=Hi(a,r,c),f=1-h,[u,g,p]=Gi(l,d,f);return`rgba(${u}, ${g}, ${p}, ${s})`}}if(e.startsWith("#")&&e.length===7){const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16),[i,s,a]=Hi(t,n,o),r=1-a,[c,l,d]=Gi(i,s,r);return`#${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}if(e==="white")return"black";if(e==="black")return"white"}return e}function Ci(e){let t=0;const n=e.length;for(let o=0;o<n;o++){const i=(o+1)%n;t+=e[o].x*e[i].y,t-=e[i].x*e[o].y}return t/2}function Md(e,t,n){return Math.max(t,Math.min(n,e))}function Cd(e,t){return e==="light"?sc:t}function Gi(e,t,n){let o,i,s;if(t===0)o=i=s=n;else{const a=(l,d,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?l+(d-l)*6*h:h<.5?d:h<.6666666666666666?l+(d-l)*(6*(.6666666666666666-h)):l),r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;o=a(c,r,e+1/3),i=a(c,r,e),s=a(c,r,e-1/3)}return[Math.round(o*255),Math.round(i*255),Math.round(s*255)]}function Ps(e,t){const n=Ut(e,.001),o=t==="A"?"\\theta":t==="D"?"\\delta":t;if(n==="0")return`0${o}`;if(n==="1")return o;if(n==="-1")return`-${o}`;if(n.endsWith("/1"))return`${n.slice(0,-2)}${o}`;if(n.includes("/")){let i="",s=n;s.startsWith("-")&&(i="-",s=s.substring(1));const a=s.split("/"),r=a[0],c=a[1];return r==="1"?`${i}\\frac{1}{${c}}${o}`:`${i}\\frac{${r}}{${c}}${o}`}return`${n}${o}`}function He(e,t,n,o,i,s){const a={x:e.x-t.x,y:e.y-t.y};if(i){const r=Math.hypot(s.x,s.y);if(r>re){const c={x:s.x/r,y:s.y/r},l=a.x*c.x+a.y*c.y,d={x:a.x-l*c.x,y:a.y-l*c.y},h=l*o,f={x:h*c.x+d.x,y:h*c.y+d.y};return{x:t.x+f.x,y:t.y+f.y}}return{x:e.x,y:e.y}}else{let r={...a};r.x*=o,r.y*=o;const c=r.x,l=r.y;return r.x=c*Math.cos(n)-l*Math.sin(n),r.y=c*Math.sin(n)+l*Math.cos(n),{x:t.x+r.x,y:t.y+r.y}}}function Ei(e){if(e.length<3)return null;if(e.length===3){const[t,n,o]=e,i=J(n,o),s=J(t,o),a=J(t,n),r=i+s+a;if(r<re)return null;const c=(i*t.x+s*n.x+a*o.x)/r,l=(i*t.y+s*n.y+a*o.y)/r,h=2*(Math.abs((n.x-t.x)*(o.y-t.y)-(o.x-t.x)*(n.y-t.y))/2)/r;return{center:{x:c,y:l},radius:h}}return wd(e)}function Ed(e,t,n){const o=Br.reduce((s,a)=>Math.abs(a-e.t)<Math.abs(s-e.t)?a:s),i={x:t.x+o*(n.x-t.x),y:t.y+o*(n.y-t.y)};return{fraction:o,point:i}}function wd(e){if(e.length<3)return null;let t={x:e.reduce((i,s)=>i+s.x,0)/e.length,y:e.reduce((i,s)=>i+s.y,0)/e.length};ps(t,e)||(t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3);let n=t,o=Pr(t,e);for(let i=0;i<oc;i++){let s=!1;const a=o*ic,r=[{x:a,y:0},{x:-a,y:0},{x:0,y:a},{x:0,y:-a},{x:a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:a*Math.SQRT1_2},{x:a*Math.SQRT1_2,y:-a*Math.SQRT1_2},{x:-a*Math.SQRT1_2,y:-a*Math.SQRT1_2}];for(const c of r){const l={x:n.x+c.x,y:n.y+c.y};if(ps(l,e)){const d=Pr(l,e);d>o&&(n=l,o=d,s=!0)}}if(!s)break}return{center:n,radius:Math.max(o,re)}}function Pr(e,t){let n=1/0;for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length],a=Wr(e,i,s);n=Math.min(n,a)}return n}function Wr(e,t,n){return bt(e,t,n).distance}function Td(e,t){e.forEach(n=>{if(!n.localCoordSystem)n.localCoordSystem=_r(n,t);else if(!n.localCoordSystem.isCustom){const o=_r(n,t);o&&(n.localCoordSystem.origin=o.origin,n.localCoordSystem.scale=o.scale)}})}function Pd(e,t,n){const o=[e];let i=e,s=t;const a=n.size+2;for(let r=0;r<a;r++){if(o.push(s),s===e)return o.pop(),o;const c=n.get(s);if(!c||c.length<1)return null;const l=c.indexOf(i);if(l===-1)return null;const d=(l+1)%c.length,h=c[d];i=s,s=h}return null}function _d(e,t,n){if(e.length<=1)return e;const o=new Set(t.map(i=>[i.id1,i.id2].sort().join("_")));return e.filter(i=>{const s=i.vertexIds;if(s.length<3)return!1;for(let a=0;a<s.length;a++)for(let r=a+2;r<s.length;r++){if(a===0&&r===s.length-1)continue;const c=s[a],l=s[r],d=[c,l].sort().join("_");if(o.has(d))return!1}return!0})}function wi(e,t){const n=new Map,o=new Map;e.forEach(l=>{const d=t(l.id1),h=t(l.id2);!d||!h||d.type!=="regular"||h.type!=="regular"||(o.has(d.id)||o.set(d.id,d),o.has(h.id)||o.set(h.id,h),n.has(l.id1)||n.set(l.id1,[]),n.has(l.id2)||n.set(l.id2,[]),n.get(l.id1).push(l.id2),n.get(l.id2).push(l.id1))});for(const[l,d]of n.entries()){const h=o.get(l);h&&d.sort((f,u)=>{const g=o.get(f),p=o.get(u);if(!g||!p)return 0;const y=Math.atan2(g.y-h.y,g.x-h.x),x=Math.atan2(p.y-h.y,p.x-h.x);return y-x})}const i=[],s=new Set;for(const[l,d]of n.entries())for(const h of d){const f=`${l}->${h}`;if(s.has(f))continue;const u=Pd(l,h,n);if(u&&u.length>=3&&new Set(u).size===u.length){for(let y=0;y<u.length;y++){const x=u[y],m=u[(y+1)%u.length];s.add(`${x}->${m}`)}const p={vertexIds:u};p.id=ge(p),i.push(p)}}const a=_d(i,e),r=[],c=new Set;return a.forEach(l=>{const d=[...l.vertexIds].sort().join("_");c.has(d)||(r.push(l),c.add(d))}),r}function gs(e,t,n,o){const i={id1:e.id,id2:t.id},s=e.x-t.x,a=e.y-t.y,r=s/n,c=a/n,l=1e-5;if(n&&Math.abs(r-Math.round(r))<l&&Math.abs(c-Math.round(c))<l){i.labelMode="exact";const h=Math.round(r),f=Math.round(c);i.exactValue={g2gSquaredSum:h*h+f*f,gridInterval:n}}else i.labelMode="decimal";return i.color=o(Re),i}function qr(e,t){let n=null,o=1/0;return t.forEach(i=>{if(!i)return;const s=Math.abs(e.x-(i.x+i.width/2));s<o&&s<i.width/2+je&&(o=s,n=i)}),n}function Ad(e){if(e&&e.points){const t=e.points.map(n=>({pos:n.pos,color:Array.isArray(n.color)?n.color:[n.color.r||0,n.color.g||0,n.color.b||0],alpha:n.alpha!==void 0?n.alpha:1}));if(t.length===1){const n=t[0];return{type:"color",value:n.alpha!==void 0&&n.alpha<1?`rgba(${n.color.join(",")},${n.alpha})`:`rgb(${n.color.join(",")})`}}return{type:"colormap",vertices:t,isCyclic:e.isCyclic===!0}}if(e&&e.vertices&&e.vertices.length===1){const t=e.vertices[0];return{type:"color",value:t.alpha!==void 0&&t.alpha<1?`rgba(${t.color.join(",")},${t.alpha})`:`rgb(${t.color.join(",")})`}}else if(e&&e.vertices)return{type:"colormap",vertices:e.vertices.map(n=>({...n,alpha:n.alpha!==void 0?n.alpha:1})),isCyclic:e.isCyclic===!0};return e}function Ae(e,t){if(!e||e.type!=="colormap"||!e.vertices)return"#ffffff";const n=e.vertices;if(n.length===0)return"#ffffff";if(n.length===1){const u=n[0],g=u.alpha!==void 0?u.alpha:1;return`rgba(${u.color.join(",")},${g})`}t=Math.max(0,Math.min(1,t));let o=n[0],i=n[n.length-1];for(let u=0;u<n.length-1;u++)if(t>=n[u].pos&&t<=n[u+1].pos){o=n[u],i=n[u+1];break}const s=i.pos-o.pos,a=s>0?(t-o.pos)/s:0,r=Math.round(o.color[0]+(i.color[0]-o.color[0])*a),c=Math.round(o.color[1]+(i.color[1]-o.color[1])*a),l=Math.round(o.color[2]+(i.color[2]-o.color[2])*a),d=o.alpha!==void 0?o.alpha:1,h=i.alpha!==void 0?i.alpha:1,f=d+(h-d)*a;return`rgba(${r},${c},${l},${f})`}function _r(e,t){const n=e.vertexIds.map(i=>t(i)).filter(i=>i&&i.type==="regular");if(n.length<3)return null;const o=Ei(n);return o?{origin:{...o.center},angle:0,scale:o.radius,isCustom:!1,showCoordSystem:!1}:null}function Wi(e,t){if(!t)return e;const n={x:e.x-t.origin.x,y:e.y-t.origin.y},o=Math.cos(-t.angle),i=Math.sin(-t.angle),s={x:n.x*o-n.y*i,y:n.x*i+n.y*o};return t.scale===0?{x:0,y:0}:{x:s.x/t.scale,y:s.y/t.scale}}function cn(e,t){const n=new Set;return t.forEach(o=>{o.id1===e?n.add(o.id2):o.id2===e&&n.add(o.id1)}),Array.from(n)}function _n(e,t){if(!t)return e;const n={x:e.x*t.scale,y:e.y*t.scale},o=Math.cos(t.angle),i=Math.sin(t.angle),s={x:n.x*o-n.y*i,y:n.x*i+n.y*o};return{x:s.x+t.origin.x,y:s.y+t.origin.y}}function Dd(e,t,n,o){const i=(e.x-t.x)*(n.y-o.y)-(e.y-t.y)*(n.x-o.x);if(Math.abs(i)<re)return null;const s=((e.x-n.x)*(n.y-o.y)-(e.y-n.y)*(n.x-o.x))/i,a=-((e.x-t.x)*(e.y-n.y)-(e.y-t.y)*(e.x-n.x))/i;return s>re&&s<1-re&&a>re&&a<1-re?{x:e.x+s*(t.x-e.x),y:e.y+s*(t.y-e.y)}:null}function kd(e,t){if(!e||!t||e.length===0||t.length<3)return!1;for(const n of e){for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length];if(Wr(n,i,s)<re)return!1}if(!ps(n,t))return!1}return!0}function Rd(e,t,n){const o=[];for(let i=0;i<t.length;i++)o.push({p1:t[i],p2:t[(i+1)%t.length]});for(const i of e){const s=n(i.id1),a=n(i.id2);if(!(!s||!a)){for(const r of o)if(Dd(s,a,r.p1,r.p2))return!0}}return!1}function Ar(e,t,n){const o=[];for(const i of e)for(const s of t){if(i.originalId===s.originalId&&i.transformIndex===s.transformIndex)continue;const a=J(i,s);a<n&&o.push({dist:a,sourceVertex:i,targetVertex:s,correctionVector:{x:s.x-i.x,y:s.y-i.y},type:"vertex-vertex"})}return o}function Bo(e,t,n){const o=[];for(const i of e)for(const s of t){if(!s||!s.originalEdge||!s.p1||!s.p2)continue;const a=i.transformIndex===s.transformIndex,r=i.originalId===s.originalEdge.id1||i.originalId===s.originalEdge.id2;if(a&&r)continue;const c=bt(i,s.p1,s.p2);c.distance<n&&c.onSegmentStrict&&o.push({dist:c.distance,sourceVertex:i,targetEdge:s,snapPoint:{x:c.x,y:c.y},correctionVector:{x:c.x-i.x,y:c.y-i.y},type:"vertex-to-edge"})}return o}function Ur(e,t,n,o,i,s,a,r){const c=Fe*2/s.scale,l=Fe/s.scale,d=String(Pn).trim(),h=e.filter(Y=>(Y&&Y.type?String(Y.type).trim():"undefined")===d);if(h.length===0||i<=0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const f=new Set(e.map(Y=>Y.id)),u=[];for(let Y=0;Y<i&&(Y+=i==1,!(Y>=i));Y++){const H=Y,G=Y;h.forEach(W=>{u.push({...r(W,H,a),originalId:W.id,transformIndex:G,type:"regular"})})}const g=t.filter(Y=>Y.type==="regular"&&!f.has(Y.id)).map(Y=>({...Y,originalId:Y.id,transformIndex:void 0})),p=n.filter(Y=>f.has(Y.id1)&&f.has(Y.id2)),y=[];for(let Y=0;Y<i&&(Y+=i==1,!(Y>=i));Y++){const H=Y,G=u.filter(W=>W.transformIndex===H);G.length>0&&p.forEach(W=>{const Q=G.find(pe=>pe.originalId===W.id1),te=G.find(pe=>pe.originalId===W.id2);Q&&te&&y.push({p1:Q,p2:te,originalEdge:W,transformIndex:H,originalEdgeId:ne(W)})})}const x=n.filter(Y=>!f.has(Y.id1)||!f.has(Y.id2)).map(Y=>({p1:o(Y.id1),p2:o(Y.id2),originalEdge:Y,transformIndex:void 0,originalEdgeId:ne(Y)})).filter(Y=>Y.p1&&Y.p2),m=[...g,...u],S=[...x,...y],I=Ar(u,m,c),b=Bo(u,S,l),C=Bo(g,y,l).map(Y=>({dist:Y.dist,sourceEdge:Y.targetEdge,targetVertex:Y.sourceVertex,correctionVector:{x:Y.sourceVertex.x-Y.snapPoint.x,y:Y.sourceVertex.y-Y.snapPoint.y},type:"edge-to-vertex"})),w=[...I,...b,...C];if(w.length===0)return{snapped:!1,finalTransform:a,mergePairs:[],edgeSnaps:[]};const _={"vertex-vertex":1,"vertex-to-edge":2,"edge-to-vertex":2};w.sort((Y,H)=>{const G=_[Y.type]??99,W=_[H.type]??99;return G!==W?G-W:Y.dist-H.dist});const T=w[0];let v={...T.correctionVector};const E=T.sourceVertex?T.sourceVertex.transformIndex:T.sourceEdge.transformIndex,O=T.targetVertex?T.targetVertex.transformIndex:T.targetEdge?T.targetEdge.transformIndex:void 0;let P;O===void 0?P=E:P=E-O;let D={x:0,y:0};Math.abs(P)>1e-9?(D.x=v.x/P,D.y=v.y/P):D={x:0,y:0};const F={...a,delta:{x:a.delta.x+D.x,y:a.delta.y+D.y}},R=[];for(let Y=0;Y<i&&(Y+=i==1,!(Y>=i));Y++){const H=Y,G=Y;h.forEach(W=>{R.push({...r(W,H,F),id:`final_${W.id}_${Y}`,originalId:W.id,transformIndex:G,type:"regular"})})}const B=g.map(Y=>({...Y})),L=[...B,...R],N=Ar(R,L,re),$=x.map(Y=>({...Y})),A=[];for(let Y=0;Y<i&&(Y+=i==1,!(Y>=i));Y++){const H=Y,G=R.filter(W=>W.transformIndex===H);G.length>0&&p.forEach(W=>{const Q=G.find(pe=>pe.originalId===W.id1),te=G.find(pe=>pe.originalId===W.id2);Q&&te&&A.push({p1:Q,p2:te,originalEdge:W,transformIndex:H,originalEdgeId:ne(W)})})}const k=[...$,...A],V=Bo(R,k,re),X=Bo(B,A,re);return{snapped:!0,finalTransform:F,bestSnap:T,mergePairs:N.map(Y=>({source:{originalId:Y.sourceVertex.originalId,transformIndex:Y.sourceVertex.transformIndex},target:{originalId:Y.targetVertex.originalId,transformIndex:Y.targetVertex.transformIndex}})),edgeSnaps:[...V,...X].map(Y=>({sourceVertex:{originalId:Y.sourceVertex.originalId,transformIndex:Y.sourceVertex.transformIndex},targetEdge:{originalEdgeId:Y.targetEdge.originalEdgeId,transformIndex:Y.targetEdge.transformIndex}}))}}function Ld(e,t,n,o,i,s,a){const r={delta:i},l=Ur(e,t,n,o,s,a,r,(d,h,f=r)=>({x:d.x+f.delta.x*h,y:d.y+f.delta.y*h}));return{snapped:l.snapped,finalDelta:l.finalTransform.delta,bestSnap:l.bestSnap,mergePairs:l.mergePairs,edgeSnaps:l.edgeSnaps}}const Fs=e=>Math.max(0,Math.min(1,e)),ct=(e,t)=>{const n=Ws(e);return n||t},St=(e,t,n)=>e+(t-e)*n,Dr=(e,t)=>{let n=0,o=0,i=0,s=0,a=0;return e.forEach((r,c)=>{const l=t[c]||0;a+=l,n+=r.r*l,o+=r.g*l,i+=r.b*l,s+=r.a*l}),a<=0?{r:0,g:0,b:0,a:1}:{r:n/a,g:o/a,b:i/a,a:s/a}};function Od(e){const t=jc/e;let n=Math.pow(10,Math.floor(Math.log10(t))),o=Math.pow(10,Math.ceil(Math.log10(t)));(Math.abs(n-o)<re||n===0)&&(o=n===0?.001:n*10,n===0&&(n=1e-4));const i=n,s=o;let a=0;s>i&&i>0&&(a=(Math.log10(t)-Math.log10(i))/(Math.log10(s)-Math.log10(i)));let r=(a-pr)/(Kc-pr);r=Math.max(0,Math.min(1,r)),r=r*r*(3-2*r);let c=1-r,l=r;c<Oo?c=0:c>1-Oo&&(c=1),l<Oo?l=0:l>1-Oo&&(l=1);const d=c+l;return d>0&&d!==2&&(c/=d,l/=d),{grid1Interval:i,grid2Interval:s,alpha1:c,alpha2:l}}function Nd(e,t,n,o){const i=o({x:0,y:0}),s={x:t/2,y:n/2},a=J(i,s);let r;a<1e-6?r=yr:r=yr/a*(180/Math.PI),(isNaN(r)||r<=re)&&(r=re);const c=[];let l=[...Xi],d=l[l.length-1];const h=1e-15;for(;d>h;)d/=10,l.includes(d)||l.push(d);l.sort((y,x)=>x-y);let f=null,u=null;for(let y=l.length-1;y>=0;y--){const x=l[y];if(r<x){f={angle:x,alpha:1},y+1<l.length&&(u={angle:l[y+1],alpha:0});break}}if(!f&&l.length>0?(f={angle:l[0],alpha:1},l.length>1&&(u={angle:l[1],alpha:0})):!f&&l.length===0&&(f={angle:Xi[0],alpha:1}),c.push(f),u){const y=Math.log10(f.angle),x=Math.log10(u.angle),m=Math.log10(r);let S;x===y?S=0:S=(m-y)/(x-y),S=Math.max(0,Math.min(1,S));const I=S*S*(3-2*S);I>Zc&&(u.alpha=I,c.push(u))}const g=[],p=new Set;c.sort((y,x)=>x.angle-y.angle);for(const y of c)p.has(y.angle)||(g.push(y),p.add(y.angle));return g.length===0&&g.push({angle:Xi[0],alpha:1}),g}function jr(e,{allFaces:t,hoveredFaceId:n,selectedFaceIds:o,colors:i,isDragConfirmed:s,dragPreviewVertices:a,currentAltPressed:r},c,l,d){if(!n&&o.length===0)return;const h=new Map;s&&a&&a.forEach(u=>{if(u&&u.id){const g=u.originalId||u.id;h.set(g,u)}});const f=u=>s&&h.has(u)?h.get(u):l(u);t.forEach(u=>{const g=d(u),p=o.includes(g),y=!r&&g===n;if(s&&u.vertexIds.some(x=>h.has(x)),(p||y)&&u.color!=="transparent"){e.save(),e.fillStyle=i.selectionGlow,e.globalAlpha=Dc,e.beginPath();const x=u.vertexIds.map(S=>f(S)).filter(S=>S&&S.type==="regular");if(x.length<3){e.restore();return}x.map(S=>c(S)).forEach((S,I)=>{I===0?e.moveTo(S.x,S.y):e.lineTo(S.x,S.y)}),e.closePath(),u.childFaceIds&&u.childFaceIds.length>0&&u.childFaceIds.forEach(S=>{const I=t.find(b=>b.id===S);if(I){const b=I.vertexIds.map(M=>f(M)).filter(M=>M&&M.type==="regular");if(b.length>=3){const M=b.map(C=>c(C));e.moveTo(M[0].x,M[0].y),M.slice(1).forEach(C=>e.lineTo(C.x,C.y)),e.closePath()}}}),e.fill("evenodd"),e.restore()}})}function Ra(e,t,{colors:n,verticesVisible:o=!0,isSnapped:i=!1},s){if(t.type===Pn&&!o&&!i)return;const a=s(t);switch(t.type){case Pn:e.beginPath(),e.arc(a.x,a.y,Fe,0,$e),e.fillStyle=i?n.feedbackSnapped:t.color||n.vertex,e.fill();break;case Kt:case Rn:case sn:case Jn:const r=Si*2,c={type:t.type,x:a.x-r/2,y:a.y-r/2,width:r,height:r};Ti(e,c,n);break}}function Kr(e,t,n,o){if(e.x>=0&&e.x<=n&&e.y>=0&&e.y<=o)return{ranges:[[0,360]],isFullCircle:!0};const i={left:0,right:n,top:0,bottom:o};if(e.x+t<i.left||e.x-t>i.right||e.y+t<i.top||e.y-t>i.bottom)return null;const s=[{x:i.left,y:i.top},{x:i.right,y:i.top},{x:i.right,y:i.bottom},{x:i.left,y:i.bottom}];if(s.every(u=>(u.x-e.x)**2+(u.y-e.y)**2<=t**2))return{ranges:[[0,360]],isFullCircle:!0};const r=[];if(s.forEach(u=>{if((u.x-e.x)**2+(u.y-e.y)**2>t**2){const p=u.x-e.x,y=u.y-e.y,x=Math.atan2(-y,p),m=x<0?x+2*Math.PI:x;r.push(m*180/Math.PI)}}),[{x1:i.left,y1:i.top,x2:i.right,y2:i.top},{x1:i.right,y1:i.top,x2:i.right,y2:i.bottom},{x1:i.right,y1:i.bottom,x2:i.left,y2:i.bottom},{x1:i.left,y1:i.bottom,x2:i.left,y2:i.top}].forEach(u=>{ka({p1:{x:u.x1,y:u.y1},p2:{x:u.x2,y:u.y2}},{center:{x:e.x,y:e.y},radius:t}).forEach(p=>{const y=p.x-e.x,x=p.y-e.y,m=Math.atan2(-x,y),S=m<0?m+2*Math.PI:m;r.push(S*180/Math.PI)})}),r.length===0)return{ranges:[[0,360]],isFullCircle:!0};const l=[...new Set(r.map(u=>Math.round(u*1e6)/1e6))].sort((u,g)=>u-g);if(l.length<2)return{ranges:[[0,360]],isFullCircle:!0};let d=0,h=0,f=0;for(let u=0;u<l.length;u++){const g=l[u],p=l[(u+1)%l.length];let y;u===l.length-1?y=360-g+p:y=p-g,y>d&&(d=y,h=g,f=p)}return f>h?{ranges:[[f,h+360]],isFullCircle:!1}:{ranges:[[f,h]],isFullCircle:!1}}function Bd(e,{canvas:t,dpr:n,colors:o}){const i=t.width/n,s=t.height/n;e.resetTransform(),e.scale(n,n),e.fillStyle=o.background,e.fillRect(0,0,i,s)}function Fd(e,{allFaces:t,allEdges:n,facesVisible:o,isDragConfirmed:i,dragPreviewVertices:s,transformIndicatorData:a,initialDragVertexStates:r,colors:c,initialCoordSystemStates:l,interpolationStyle:d,getInterpolationStyleById:h,faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:g="x",faceColorPolarExpression:p="r",edgeColorExpression:y="x"},x,m){if(!o||!t||!c||!e)return;const S=M=>m(M);t.filter(M=>!M.parentFaceId).forEach(M=>{if(!M||!M.vertexIds||M.vertexIds.length<3)return;const C=M.vertexIds.map(E=>S(E)).filter(E=>E&&E.type==="regular");if(C.length<3)return;const w=M.interpolationStyleId&&h?h(M.interpolationStyleId):d,T=(w?Gs(C,w,!0,x):C).map(E=>x(E));let v=M;M.localCoordSystem,T.every(E=>E&&typeof E.x=="number"&&typeof E.y=="number")&&si(e,T,v,c,x,m,n,t,S,!0,d,{faceColorMode:f,edgeColorMode:u,faceColorExpression:g,faceColorPolarExpression:p,edgeColorExpression:y})}),t.filter(M=>M.parentFaceId&&M.color!=="transparent").forEach(M=>{if(!M||!M.vertexIds||M.vertexIds.length<3)return;const C=M.vertexIds.map(E=>S(E)).filter(E=>E&&E.type==="regular");if(C.length<3)return;const w=M.interpolationStyleId&&h?h(M.interpolationStyleId):d,T=(w?Gs(C,w,!0,x):C).map(E=>x(E));let v=M;M.localCoordSystem,T.every(E=>E&&typeof E.x=="number"&&typeof E.y=="number")&&si(e,T,v,c,x,m,n,t,S,!1,d,{faceColorMode:f,edgeColorMode:u,faceColorExpression:g,faceColorPolarExpression:p,edgeColorExpression:y})})}function $d(e,{initialSystem:t,dragPreviewVertices:n,initialDragVertexStates:o,findVertexById:i,transformIndicatorData:s}){if(!t)return e.localCoordSystem;const a=new Set(e.vertexIds),r=new Set(o.map(g=>g.id));if([...a].every(g=>r.has(g))){const g=JSON.parse(JSON.stringify(t));if(s){const{center:p,rotation:y,scale:x,directionalScale:m,startPos:S}=s,I={x:S.x-p.x,y:S.y-p.y};if(g.origin=He(t.origin,p,y,x,m,I),m){const b=_n({x:1,y:0},t),M=He(b,p,y,x,m,I);g.scale=J(g.origin,M)}else g.angle=bn(t.angle+y),g.scale=t.scale*x}else if(o.length>0&&n.length>0){const p=o.find(x=>a.has(x.id)),y=p?n.find(x=>x.id===p.id):null;if(y){const x=y.x-p.x,m=y.y-p.y;g.origin.x+=x,g.origin.y+=m}}return g}const l=e.vertexIds.map(g=>n.find(p=>p&&p.id===g)||i(g)).filter(g=>g&&g.type==="regular");if(!t.isCustom){const g=Ei(l);if(g){const p=s?s.rotation:0;return{...t,origin:g.center,scale:g.radius,angle:bn(t.angle+p)}}return t}const d=JSON.parse(JSON.stringify(t));if(s){const{center:g,rotation:p,scale:y,directionalScale:x,startPos:m}=s,S={x:m.x-g.x,y:m.y-g.y};if(d.origin=He(t.origin,g,p,y,x,S),x){const I=_n({x:1,y:0},t),b=He(I,g,p,y,x,S);d.scale=J(d.origin,b)}else d.angle=bn(t.angle+p),d.scale=t.scale*y}let h={...d.origin},f=d.angle,u=d.scale;if(d.attachedToVertex){if(r.has(d.attachedToVertex)){const g=n.find(p=>p.id===d.attachedToVertex);g&&(h={...g})}}else if(d.attachedToEdge&&(r.has(d.attachedToEdge.v1)||r.has(d.attachedToEdge.v2))){const g=n.find(y=>y.id===d.attachedToEdge.v1)||i(d.attachedToEdge.v1),p=n.find(y=>y.id===d.attachedToEdge.v2)||i(d.attachedToEdge.v2);g&&p&&(h={x:g.x+d.attachedToEdge.t*(p.x-g.x),y:g.y+d.attachedToEdge.t*(p.y-g.y)})}if(d.rotationAlignedToEdge&&(r.has(d.rotationAlignedToEdge.v1)||r.has(d.rotationAlignedToEdge.v2))){const g=n.find(y=>y.id===d.rotationAlignedToEdge.v1)||i(d.rotationAlignedToEdge.v1),p=n.find(y=>y.id===d.rotationAlignedToEdge.v2)||i(d.rotationAlignedToEdge.v2);if(g&&p){const y=Math.atan2(p.y-g.y,p.x-g.x),{originalAngle:x,originalSystemAngle:m}=d.rotationAlignedToEdge,S=m-x;f=bn(y+S)}}if(d.scaleAttachedToEdge&&(r.has(d.scaleAttachedToEdge.v1)||r.has(d.scaleAttachedToEdge.v2))){const g=n.find(y=>y.id===d.scaleAttachedToEdge.v1)||i(d.scaleAttachedToEdge.v1),p=n.find(y=>y.id===d.scaleAttachedToEdge.v2)||i(d.scaleAttachedToEdge.v2);g&&p&&(u=J(g,p)*d.scaleAttachedToEdge.scaleRatio)}return l.length>=3?d.origin=qs(h,l):d.origin=h,d.angle=f,d.scale=Math.max(.01,u),d}function Vd(e,t,n){const{copyCount:o,isDragConfirmed:i,initialDragVertexStates:s,dragPreviewVertices:a,transformIndicatorData:r,allEdges:c,allFaces:l,findVertexById:d,colors:h,snappedEdgesInfo:f,snappedVertexIds:u,edgeColorMode:g="fixed",faceColorMode:p="fixed",edgeColorExpression:y="x",faceColorExpression:x="x",faceColorPolarExpression:m="r"}=t,S=s.length===1&&!r&&s[0].type==="regular";if(!i||!s.length||o<=0||S)return;const I=s.filter(_=>_.type==="regular");if(I.length===0)return;const b=new Set(I.map(_=>_.id)),M=c.filter(_=>b.has(_.id1)&&b.has(_.id2)),C=c.filter(_=>b.has(_.id1)&&!b.has(_.id2)||b.has(_.id2)&&!b.has(_.id1)),w=l.filter(_=>_.vertexIds.every(T=>b.has(T)));e.save(),e.globalAlpha=1;for(let _=0;_<o;_++){_+=o==1;const T=_,v=_;let E;const O=new Map;if(r){const{center:R,rotation:B,scale:L,directionalScale:N,startPos:$}=r,A={x:$.x-R.x,y:$.y-R.y};E=I.map(k=>{const V=He(k,R,B*v,Math.pow(L,v),N,A);return{...k,...V,id:`preview_${k.id}_${T}`,originalId:k.id,transformIndex:T}})}else{const R=a.length>0?a[0].x-s[0].x:0,B=a.length>0?a[0].y-s[0].y:0;E=I.map(L=>({...L,x:L.x+R*v,y:L.y+B*v,id:`preview_${L.id}_${T}`,originalId:L.id,transformIndex:T}))}if(!E||E.length===0)continue;E.forEach(R=>O.set(R.originalId,R)),w.forEach(R=>{const B=R.vertexIds.map(L=>O.get(L)).filter(Boolean);if(B.length===R.vertexIds.length){const L=B.map(N=>n(N));si(e,L,R,h,n,d,c,[],N=>O.get(N),!1,null,{faceColorMode:p,edgeColorMode:g,faceColorExpression:x,faceColorPolarExpression:m,edgeColorExpression:y})}}),e.setLineDash([]),e.lineWidth=ts;const P=ct(h.edge,{r:255,g:255,b:255,a:1}),D=R=>ct(R?.color||h.vertex||h.edge,P),F=(R,B,L,N)=>{if(g==="inherit_vertices"&&L&&N){const $=D(L),A=D(N);return{r:St($.r,A.r,B),g:St($.g,A.g,B),b:St($.b,A.b,B),a:St($.a,A.a,B)}}if(g==="colormap"&&R.colormapItem){const $=Bs(y,{x:B},B),A=Fs($),k=Ae(R.colormapItem,A);return ct(k,P)}return ct(R.color||h.edge,P)};M.forEach(R=>{const B=O.get(R.id1),L=O.get(R.id2);if(B&&L){const N=n(B),$=n(L);if(g==="colormap"||g==="inherit_vertices"){const V=F(R,.5,B,L);e.beginPath(),e.moveTo(N.x,N.y),e.lineTo($.x,$.y),e.strokeStyle=`rgba(${Math.round(V.r)},${Math.round(V.g)},${Math.round(V.b)},${V.a})`,e.stroke()}else if(R.colormapItem){const V=e.createLinearGradient(N.x,N.y,$.x,$.y),X=Ae(R.colormapItem,R.gradientStart),Y=Ae(R.colormapItem,R.gradientEnd);V.addColorStop(0,X),V.addColorStop(1,Y),e.strokeStyle=V,e.stroke()}else e.strokeStyle=R.color||h.edge,e.stroke();const A=ne(R);if((f?.get(A)||[]).some(V=>V.copyIndex===T)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=fs,e.lineWidth=Hn,e.lineCap="round",e.lineJoin="round";const V=$.x-N.x,X=$.y-N.y,Y=Math.hypot(V,X),H=Ji;if(Y>re){const G=-X/Y,W=V/Y,Q=G*H,te=W*H;e.beginPath(),e.arc(N.x,N.y,H,Math.atan2(te,Q),Math.atan2(-te,-Q)),e.lineTo($.x-Q,$.y-te),e.arc($.x,$.y,H,Math.atan2(-te,-Q),Math.atan2(te,Q)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(N.x,N.y,H,0,$e),e.stroke();e.restore()}}}),C.forEach(R=>{const B=b.has(R.id1)?R.id2:R.id1,L=b.has(R.id1)?R.id1:R.id2,N=O.get(L),$=d(B);if(N&&$){const A=n(N),k=n($);if(g==="colormap"||g==="inherit_vertices"){const Y=F(R,.5,N,$);e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(k.x,k.y),e.strokeStyle=`rgba(${Math.round(Y.r)},${Math.round(Y.g)},${Math.round(Y.b)},${Y.a})`,e.stroke()}else if(R.colormapItem){const Y=e.createLinearGradient(A.x,A.y,k.x,k.y),H=Ae(R.colormapItem,R.gradientStart),G=Ae(R.colormapItem,R.gradientEnd);Y.addColorStop(0,H),Y.addColorStop(1,G),e.strokeStyle=Y,e.stroke()}else e.strokeStyle=R.color||h.edge,e.stroke();const V=ne(R);if((f?.get(V)||[]).some(Y=>Y.copyIndex===T)){e.save(),e.strokeStyle=h.feedbackSnapped,e.globalAlpha=fs,e.lineWidth=Hn,e.lineCap="round",e.lineJoin="round";const Y=k.x-A.x,H=k.y-A.y,G=Math.hypot(Y,H),W=Ji;if(G>re){const Q=-H/G,te=Y/G,pe=Q*W,me=te*W;e.beginPath(),e.arc(A.x,A.y,W,Math.atan2(me,pe),Math.atan2(-me,-pe)),e.lineTo(k.x-pe,k.y-me),e.arc(k.x,k.y,W,Math.atan2(-me,-pe),Math.atan2(me,pe)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(A.x,A.y,W,0,$e),e.stroke();e.restore()}}}),E.forEach(R=>{const B=R.originalId,L=u.get(B)||[],N=L.some(k=>k.copyIndex===T),$=L.find(k=>k.copyIndex===T),A=$?$.type:null;Ra(e,R,{colors:h,verticesVisible:!0,isSnapped:!1},n),N&&La(e,R,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:h,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:A,currentAltPressed:!1},n)})}e.restore()}function La(e,t,n,o,i){const{selectedVertexIds:s,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,isSnapped:h=!1,snapType:f=null,currentAltPressed:u}=n;if(u&&d)return;let g;if(t.type===Pn){if(g=s.includes(t.id),!l&&!g&&!d&&!h)return}else g=a.includes(t.id);if(g||d||h){const y=o(t);e.save();let x=c.selectionGlow;t.id===r&&t.type!=="regular"?x=c.activeCenterGlow:h?x=c.feedbackSnapped:d&&(x=c.selectionGlow),e.shadowColor=x,e.shadowBlur=Ma,e.globalAlpha=fs,e.strokeStyle=x,e.lineWidth=Hn,e.beginPath();let m;t.type===Pn?m=Fe+ei:m=Si+ei,e.arc(y.x,y.y,m,0,$e),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,e.restore()}}function Yd(e,t,n){const{copyCount:o=1,initialDragVertexStates:i,dragPreviewVertices:s,allEdges:a,allFaces:r,findVertexById:c,findAllVerticesInSubgraph:l,colors:d,snappedEdgesInfo:h,snappedVertexIds:f,edgeColorMode:u="fixed",faceColorMode:g="fixed",edgeColorExpression:p="x",faceColorExpression:y="x",faceColorPolarExpression:x="r"}=t;if(!i||i.length!==1||!s||s.length===0)return;const m=i[0];for(let S=0;S<o;S++){S+=o==1;const I=S,b=S;let M;const C=s.length>0?s[0].x-i[0].x:0,w=s.length>0?s[0].y-i[0].y:0;M={x:m.x+C*b,y:m.y+w*b};const _={...m,...M,originalId:m.id,transformIndex:I},T=new Set(l(m.id)),v=a.filter(R=>T.has(R.id1)&&T.has(R.id2)),E=r.filter(R=>R.vertexIds.every(B=>T.has(B))),O=R=>R===m.id?_:T.has(R)?c(R):null;E.forEach(R=>{const B=R.vertexIds.map(O).filter(Boolean);if(B.length>=3){const L=B.map(N=>n(N));si(e,L,R,d,n,c,a,r,O,!0,null,{faceColorMode:g,edgeColorMode:u,faceColorExpression:y,faceColorPolarExpression:x,edgeColorExpression:p})}}),e.save(),e.lineWidth=ts,e.setLineDash([]);const P=ct(d.edge,{r:255,g:255,b:255,a:1}),D=R=>ct(R?.color||d.vertex||d.edge,P),F=(R,B,L,N)=>{if(u==="inherit_vertices"&&L&&N){const $=D(L),A=D(N);return{r:St($.r,A.r,B),g:St($.g,A.g,B),b:St($.b,A.b,B),a:St($.a,A.a,B)}}if(u==="colormap"&&R.colormapItem){const $=Bs(p,{x:B},B),A=Fs($),k=Ae(R.colormapItem,A);return ct(k,P)}return ct(R.color||d.edge,P)};v.forEach(R=>{const B=O(R.id1),L=O(R.id2);if(B&&L){const N=n(B),$=n(L);if(e.beginPath(),e.moveTo(N.x,N.y),e.lineTo($.x,$.y),u==="colormap"||u==="inherit_vertices"){const V=F(R,.5,B,L);e.strokeStyle=`rgba(${Math.round(V.r)},${Math.round(V.g)},${Math.round(V.b)},${V.a})`,e.stroke()}else if(R.colormapItem){const V=e.createLinearGradient(N.x,N.y,$.x,$.y),X=Ae(R.colormapItem,R.gradientStart),Y=Ae(R.colormapItem,R.gradientEnd);V.addColorStop(0,X),V.addColorStop(1,Y),e.strokeStyle=V,e.stroke()}else e.strokeStyle=R.color||d.edge,e.stroke();const A=ne(R);if((h?.get(A)||[]).some(V=>V.copyIndex===I)){e.save(),e.strokeStyle=d.feedbackSnapped,e.globalAlpha=fs,e.lineWidth=Hn,e.lineCap="round",e.lineJoin="round";const V=$.x-N.x,X=$.y-N.y,Y=Math.hypot(V,X),H=Ji;if(Y>re){const G=-X/Y,W=V/Y,Q=G*H,te=W*H;e.beginPath(),e.arc(N.x,N.y,H,Math.atan2(te,Q),Math.atan2(-te,-Q)),e.lineTo($.x-Q,$.y-te),e.arc($.x,$.y,H,Math.atan2(-te,-Q),Math.atan2(te,Q)),e.closePath(),e.stroke()}else e.beginPath(),e.arc(N.x,N.y,H,0,$e),e.stroke();e.restore()}}}),e.restore(),T.forEach(R=>{const B=O(R);if(!B)return;const L=R===m.id,N=f.get(m.id)||[],$=L&&N.some(X=>X.copyIndex===I),A=L?N.find(X=>X.copyIndex===I):null,k=A?A.type:null,V={...B,id:`preview_${B.originalId||B.id}_${I}`,originalId:B.originalId||B.id,transformIndex:I};Ra(e,V,{colors:d,verticesVisible:!0,isSnapped:!1},n),$&&La(e,V,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:d,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:k,currentAltPressed:!1},n)})}}function Jr(e,{startVertex:t,snappedData:n,isShiftPressed:o,currentColor:i,nextCreationColor:s,nextEdgeColor:a,colors:r,edgeColormapInfo:c,interpolationStyle:l},d){const h=d(t),f=d(n);e.save();let u=[{x:t.x,y:t.y},{x:n.x,y:n.y}];if(l&&l.type&&l.type!=="linear"?(u=Gs(u,l,!1,null),e.setLineDash([])):e.setLineDash(Mn),c&&c.colormapItem){const x=e.createLinearGradient(h.x,h.y,f.x,f.y),m=Ae(c.colormapItem,c.startT),S=Ae(c.colormapItem,c.endT);x.addColorStop(0,m),x.addColorStop(1,S),e.strokeStyle=x}else n.snapped||o?e.strokeStyle=r.feedbackSnapped:e.strokeStyle=a;e.lineWidth=ts;const p=u.map(x=>d(x));e.beginPath(),e.moveTo(p[0].x,p[0].y);for(let x=1;x<p.length;x++)e.lineTo(p[x].x,p[x].y);if(e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(f.x,f.y,Fe,0,$e),n.snapped?e.fillStyle=r.feedbackSnapped:e.fillStyle=s,e.fill(),n.snapped&&(n.snapType==="vertex"||n.snapType==="edge"||n.snapType==="edge_fraction")){e.shadowColor=r.feedbackSnapped,e.shadowBlur=Ma,e.globalAlpha=fs,e.strokeStyle=r.feedbackSnapped,e.lineWidth=Hn;const x=Fe+ei;e.beginPath(),e.arc(f.x,f.y,x,0,$e),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}e.restore()}function ti(e,t,n){const o=[];if(n>360){const s=n-360,a=Math.floor(t/e)*e;for(let r=a;r<360;r+=e)r>=t&&o.push(r);for(let r=0;r<=s+e;r+=e)r<=s&&o.push(r)}else{const s=Math.floor(t/e)*e;for(let a=s;a<=n+e;a+=e)a>=t&&a<=n&&a>=0&&a<360&&o.push(a)}return[...new Set(o)].sort((s,a)=>s-a)}function Xd(e,t,n){return e.x>=-20&&e.x<=t+mt&&e.y>=-20&&e.y<=n+mt}function zd(e,t,n,o,i,{canvas:s,dpr:a,viewTransform:r,angleDisplayMode:c,colors:l},d,h){if(typeof d!="function"||typeof n!="function")return;const f=d({x:0,y:0}),u=s.width/a,g=s.height/a,p={x:u/2,y:g/2},y=Math.min(u,g)/4,x=J(f,p),m=y+x;if(m<zr||!Zr(f.x,f.y,m,u,g))return;e.save(),e.strokeStyle=`rgba(${l.feedbackDefault.join(",")}, 1.0)`,e.lineWidth=jt;const S=Math.min(u,g)*400,I=m>S;let b=null;if(I){const E={x:0,y:0,w:u,h:g},O={x:f.x,y:f.y,r:m},P=aa(O,E);if(P.length>=2){let D=P[0],F=P[1],R=0;for(let N=0;N<P.length;N++)for(let $=N+1;$<P.length;$++){const A=(P[N].x-P[$].x)**2+(P[N].y-P[$].y)**2;A>R&&(R=A,D=P[N],F=P[$])}e.beginPath(),e.moveTo(D.x,D.y),e.lineTo(F.x,F.y),e.stroke();const B=(Math.atan2(f.y-D.y,D.x-f.x)*180/Math.PI+360)%360,L=(Math.atan2(f.y-F.y,F.x-f.x)*180/Math.PI+360)%360;b={minAngle:Math.min(B,L),maxAngle:Math.max(B,L),isFullCircle:!1},Math.abs(B-L)>180&&(b={minAngle:Math.max(B,L),maxAngle:Math.min(B,L)+360,isFullCircle:!1})}}else e.beginPath(),e.arc(f.x,f.y,m,0,2*Math.PI),e.stroke(),b=Kr(f,m,u,g);if(e.restore(),!b)return;const M=m/(r.scale/a),C=new Set,w=new Map;h.forEach(E=>{const O=E.alpha;if(O<Vr||m*(E.angle*Math.PI/180)<Hr*.5)return;const D=`rgba(${l.feedbackDefault.join(",")}, ${O*Ic})`;let F;if(b.isFullCircle){F=[];for(let R=0;R<360;R+=E.angle)F.push(R)}else F=[],b.ranges&&Array.isArray(b.ranges)?b.ranges.forEach(R=>{const[B,L]=R,N=ti(E.angle,B,L);F.push(...N)}):b.minAngle!==void 0&&b.maxAngle!==void 0&&(F=ti(E.angle,b.minAngle,b.maxAngle)),F=[...new Set(F)];F.forEach(R=>{if(R=Math.round(R*1e10)/1e10,c==="degrees"){if(C.has(R))return}else if(c==="radians"){const V=`${R}-${E.angle}`;if(w.has(V))return}const B=R*Math.PI/180,L={x:f.x+(m+Jo)*Math.cos(B),y:f.y-(m+Jo)*Math.sin(B)},N=bc;if(!(L.x>-N&&L.x<u+N&&L.y>-N&&L.y<g+N))return;let A={textAlign:"center",textBaseline:"middle"};if(c==="radians"&&(A={textAlign:"left",textBaseline:"middle"}),e.save(),e.strokeStyle=D,e.lineWidth=Tn,R%90===0&&R<360){const V={x:f.x+m*Math.cos(B),y:f.y-m*Math.sin(B)};let X;const Y=et*1.5;switch(R){case 0:X={x:Math.SQRT1_2,y:-Math.SQRT1_2},A={textAlign:"left",textBaseline:"bottom"};break;case 90:X={x:Math.SQRT1_2,y:-Math.SQRT1_2},A={textAlign:"left",textBaseline:"bottom"};break;case 180:X={x:-Math.SQRT1_2,y:-Math.SQRT1_2},A={textAlign:"right",textBaseline:"bottom"};break;case 270:X={x:Math.SQRT1_2,y:Math.SQRT1_2},A={textAlign:"left",textBaseline:"top"};break}const H={x:V.x+X.x*Y,y:V.y+X.y*Y};e.lineWidth=vc,e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(H.x,H.y),e.stroke(),L.x=H.x,L.y=H.y}else{const V={x:f.x+(m-Fe)*Math.cos(B),y:f.y-(m-Fe)*Math.sin(B)},X={x:f.x+(m+Fe)*Math.cos(B),y:f.y-(m+Fe)*Math.sin(B)};Xd(X,u,g)&&(e.beginPath(),e.moveTo(V.x,V.y),e.lineTo(X.x,X.y),e.stroke())}e.restore();let k="";if(c==="degrees"){let V=Math.max(0,(E.angle.toString().split(".")[1]||"").length);E.angle<1&&(V=Math.max(V,Math.ceil(-Math.log10(E.angle))+1));const X=Math.round(R*Math.pow(10,V))/Math.pow(10,V),Y=parseFloat(X.toFixed(V));k=`${Math.round(Y*1e10)/1e10}^{\\circ}`}else if(R===0&&c==="radians")k="0";else if(R!==0)if(E.angle<=5){const X=R*Math.PI/180,Y=Math.max(0,(E.angle.toString().split(".")[1]||"").length),H=Math.max(3,Y+2);let G=X.toFixed(H);G=parseFloat(G).toString(),parseFloat(G)!==0&&(k=G)}else{const X=R,Y=180,H=Da(X,Y),G=X/H,W=Y/H;W===1?G===1?k="\\pi":G===-1?k="-\\pi":k=`${G}\\pi`:G===1?k=`\\frac{\\pi}{${W}}`:G===-1?k=`-\\frac{\\pi}{${W}}`:G<0?k=`-\\frac{${Math.abs(G)}\\pi}{${W}}`:k=`\\frac{${G}\\pi}{${W}}`}if(k){const V=c==="radians"?`circ-label-${R}-${E.angle}-${M.toExponential(15)}`:`circ-label-${R}-${M.toExponential(15)}`;if(n({id:V,content:k,x:L.x,y:L.y,color:D,fontSize:sa,options:A}),c==="degrees")C.add(R);else{const X=`${R}-${E.angle}`;w.set(X,{levelAngle:E.angle,alpha:O,labelId:V})}}})});const _=l.feedbackDefault;let T=-1/0;const v={x:f.x+m,y:f.y};if(v.x>-20&&v.x<u+mt&&v.y>-20&&v.y<g+mt)T=0;else{const E={x:0,y:0,w:u,h:g},O={x:f.x,y:f.y,r:m},P=aa(O,E);if(P.length>0){let D=-1/0;P.forEach(R=>{const B=Math.atan2(f.y-R.y,R.x-f.x),L=B>=0?B:B+2*Math.PI,N={x:f.x+m*Math.cos(L),y:f.y-m*Math.sin(L)},$=mt;N.x>-$&&N.x<u+$&&N.y>-$&&N.y<g+$&&L>D&&(D=L)}),[{x:0,y:0},{x:E.w,y:0},{x:E.w,y:E.h},{x:0,y:E.h}].forEach(R=>{if(J(R,f)<O.r){const B=Math.atan2(f.y-R.y,R.x-f.x),L=B>=0?B:B+2*Math.PI,N={x:f.x+m*Math.cos(L),y:f.y-m*Math.sin(L)},$=mt;N.x>-$&&N.x<u+$&&N.y>-$&&N.y<g+$&&L>D&&(D=L)}}),D>-1/0&&(T=D)}}if(T>-1/0){const E=T,O={x:f.x+m*Math.cos(E),y:f.y-m*Math.sin(E)},P={x:-Math.sin(E),y:-Math.cos(E)},D={x:Math.cos(E),y:-Math.sin(E)},F={x:O.x-De*P.x+De/2*D.x,y:O.y-De*P.y+De/2*D.y},R={x:O.x-De*P.x-De/2*D.x,y:O.y-De*P.y-De/2*D.y};e.save(),e.fillStyle=`rgba(${_.join(",")}, 1.0)`,e.beginPath(),e.moveTo(O.x,O.y),e.lineTo(F.x,F.y),e.lineTo(R.x,R.y),e.closePath(),e.fill(),e.restore();let B;if(E===0)B={x:O.x-Ni,y:O.y+Bi+De};else{const L={x:-Math.cos(E),y:Math.sin(E)};B={x:O.x+L.x*(Bi+De)+P.x*Ni,y:O.y+L.y*(Bi+De)+P.y*Ni}}n({id:"theta-label-sticky",content:"\\theta",x:B.x,y:B.y,color:`rgba(${_.join(",")}, 1.0)`,fontSize:ns,options:{textAlign:"center",textBaseline:"middle"}})}}function aa(e,t){const{x:n,y:o,r:i}=e,{x:s,y:a,w:r,h:c}=t,l=[],d={center:{x:n,y:o},radius:i},h=(f,u,g,p)=>{ka({p1:{x:f,y:u},p2:{x:g,y:p}},d).forEach(m=>{const S=g-f,I=p-u;let b;Math.abs(S)>Math.abs(I)?b=(m.x-f)/S:b=(m.y-u)/I,b>=0&&b<=1&&l.push({x:m.x,y:m.y})})};return h(s,a,s+r,a),h(s+r,a,s+r,a+c),h(s+r,a+c,s,a+c),h(s,a+c,s,a),l}function Zr(e,t,n,o,i){return!(e+n<0||e-n>o||t+n<0||t-n>i)}function Hd(e,t,n,o,i,s,a){const r=`rgba(${a.axisTickLabel.join(",")}, ${Ko})`,c=et*lc;e.save(),e.strokeStyle=r,e.lineWidth=cc,e.setLineDash([]);const l=c,d=l/Math.tan(rc),h=t.x-d,f=t.y+l;e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(h,f),e.stroke(),e.restore(),s({id:"tick-label-origin",content:Ec,x:t.x-et-Bn,y:t.y+et+Bn,color:r,fontSize:ss,options:{textAlign:"right",textBaseline:"top"}})}function Gd(e,t,{canvas:n,dpr:o,coordsDisplayMode:i,viewTransform:s,angleDisplayMode:a,colors:r},c,l,d,h,f){e.save();const u=n.width/o,g=n.height/o,p=c({x:0,y:0}),y=(S,I,b,M)=>{e.beginPath(),e.moveTo(S,I),e.lineTo(b,M),e.stroke();const C=Math.atan2(M-I,b-S);e.beginPath(),e.moveTo(b,M),e.lineTo(b-De*Math.cos(C-qt),M-De*Math.sin(C-qt)),e.lineTo(b-De*Math.cos(C+qt),M-De*Math.sin(C+qt)),e.closePath(),e.fill()},x=(S,I,b,M,C)=>{const w=new Map,_=new Map,T=(B,L,N)=>{if(!B||L<Ii)return;const $=l({x:0,y:0}),A=l({x:u,y:g}),k=B*re;{const V=Math.floor($.x/B),X=Math.ceil(A.x/B),Y=Math.floor(A.y/B),H=Math.ceil($.y/B);for(let G=V;G<=X;G++){const W=G*B;if(Math.abs(W)<k)continue;const Q=w.get(W);Q?N?w.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!0}):Q.isCoarser||w.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!1}):w.set(W,{alpha:L,isCoarser:N})}for(let G=Y;G<=H;G++){const W=G*B;if(Math.abs(W)<k)continue;const Q=_.get(W);Q?N?_.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!0}):Q.isCoarser||_.set(W,{alpha:Math.max(Q.alpha,L),isCoarser:!1}):_.set(W,{alpha:L,isCoarser:N})}}},v=!b||S>=b;T(S,I,v),T(b,M,!v);let E=!1;const O=B=>{const L=Math.abs(B);(L>=oa||L>0&&L<ia)&&(E=!0)};w.forEach((B,L)=>O(L)),_.forEach((B,L)=>O(L));const P=l({x:0,y:0}),D=l({x:u,y:g});O(P.x),O(P.y),O(D.x),O(D.y);const F=S||b||1,R=F>0?Math.max(0,-Math.floor(Math.log10(F))):0;return w.forEach((B,L)=>{const N=B.isCoarser?1:B.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${Ko*N})`;e.strokeStyle=$,e.lineWidth=Tn;{const A=c({x:L,y:0}).x;e.beginPath(),e.moveTo(A,p.y),e.lineTo(A,p.y+et),e.stroke();let k;if(E){const X=Math.log10(Math.abs(L)),Y=Math.floor(X),H=F/Math.pow(10,Y),G=Math.max(0,-Math.floor(Math.log10(H))+1),Q=Math.abs(L).toExponential(G).split("e");let te=Q[0];te=te.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let pe=parseInt(Q[1],10);k=`${L<0?"-":""}${te} \\cdot 10^{${pe}}`}else k=L.toFixed(R).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");f({id:((X,Y)=>`${X}-${Y.toExponential(15)}`)("tick-label-x",L),content:k,x:A,y:p.y+et+Bn,color:$,fontSize:ss,options:{textAlign:"center",textBaseline:"top"}})}}),_.forEach((B,L)=>{const N=B.isCoarser?1:B.alpha,$=`rgba(${r.axisTickLabel.join(",")}, ${Ko*N})`;e.strokeStyle=$,e.lineWidth=Tn;const A=c({x:0,y:L}).y;let k;if(E){const X=Math.log10(Math.abs(L)),Y=Math.floor(X),H=F/Math.pow(10,Y),G=Math.max(0,-Math.floor(Math.log10(H))+1),Q=Math.abs(L).toExponential(G).split("e");let te=Q[0];te=te.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let pe=parseInt(Q[1],10);k=`${L<0?"-":""}${te} \\cdot 10^{${pe}}`}else k=L.toFixed(R).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");i===uo&&Math.abs(L)>re&&(k==="1"?k=Xo:k==="-1"?k=`-${Xo}`:k+=Xo),e.beginPath(),e.moveTo(p.x,A),e.lineTo(p.x-et,A),e.stroke(),f({id:((X,Y)=>`${X}-${Y.toExponential(15)}`)("tick-label-y",L),content:k,x:p.x-et-Bn,y:A,color:$,fontSize:ss,options:{textAlign:"right",textBaseline:"middle"}})}),{useScientific:E}};e.lineWidth=Cc,e.strokeStyle=r.axis,e.fillStyle=r.axis;let m={useScientific:!1};if(i===Mi){const{interval1:S,interval2:I,alpha1:b,alpha2:M}=d;qd(e,t,{canvas:n,dpr:o,colors:r},c,f);let C=!1;const w=v=>{const E=Math.abs(v);(E>=oa||E>0&&E<ia)&&(C=!0)},_=l({x:0,y:0}),T=l({x:u,y:g});w(_.x),w(_.y),w(T.x),w(T.y),Wd(e,t,{canvas:n,dpr:o,colors:r},c,l,d,f,C),zd(e,t,f,0,0,{canvas:n,dpr:o,viewTransform:s,angleDisplayMode:a,colors:r},c,h),m={useScientific:C}}else{p.y>0&&p.y<g&&y(0,p.y,u,p.y),p.x>0&&p.x<u&&y(p.x,g,p.x,0);let S="x",I="y";i===uo&&(S=wc,I=Tc),f({id:"axis-label-x",content:S,x:u-De-Qi,y:p.y-Zi,color:r.axis,fontSize:ns,options:{textAlign:"center",textBaseline:"bottom"}}),f({id:"axis-label-y",content:I,x:p.x+ea,y:De+ta,color:r.axis,fontSize:ns,options:{textAlign:"left",textBaseline:"middle"}}),m=x(d.interval1,d.alpha1,d.interval2,d.alpha2)}return Hd(e,p,u,g,i,f,r),e.restore(),m}function Wd(e,t,{canvas:n,dpr:o,colors:i},s,a,r,c,l){const d=n.width/o,h=n.height/o,f=s({x:0,y:0}),u=f.y>-20&&f.y<h+mt,g=f.x>-20&&f.x<d+mt;if(!u&&!g)return;const{interval1:p,interval2:y,alpha1:x,alpha2:m}=r,S=new Map,I=p||y||1,b=I>0?Math.max(0,-Math.floor(Math.log10(I))):0,M=(w,_,T)=>{if(!w||_<Ii)return;let v=0;if(u){const F=a({x:0,y:f.y}),R=a({x:d,y:f.y});v=Math.max(v,Math.abs(F.x),Math.abs(R.x))}if(g){const F=a({x:f.x,y:0}),R=a({x:f.x,y:h});v=Math.max(v,Math.abs(F.y),Math.abs(R.y))}v*=1.1;const E=1,O=Math.ceil(v/w),D=Math.min(O,E+1e3);for(let F=E;F<=D;F++){const R=F*w;let B=!1;if(u){const L=s({x:R,y:0}).x,N=s({x:-R,y:0}).x;(L>=-20&&L<=d+mt||N>=-20&&N<=d+mt)&&(B=!0)}if(!B&&g){const L=s({x:0,y:R}).y,N=s({x:0,y:-R}).y;(L>=-20&&L<=h+mt||N>=-20&&N<=h+mt)&&(B=!0)}if(B){const L=S.get(R);L?T?S.set(R,{alpha:Math.max(L.alpha,_),isCoarser:!0}):L.isCoarser||S.set(R,{alpha:Math.max(L.alpha,_),isCoarser:!1}):S.set(R,{alpha:_,isCoarser:T})}}},C=!y||p>=y;M(p,x,C),M(y,m,!C),S.forEach((w,_)=>{const T=w.isCoarser?1:w.alpha,v=`rgba(${i.axisTickLabel.join(",")}, ${Ko*T})`;e.strokeStyle=v,e.lineWidth=Tn;let E;if(l){const P=Math.log10(Math.abs(_)),D=Math.floor(P),F=I/Math.pow(10,D),R=Math.max(0,-Math.floor(Math.log10(F))+1),L=Math.abs(_).toExponential(R).split("e");let N=L[0];N=N.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");let $=parseInt(L[1],10);E=`${_<0?"-":""}${N} \\cdot 10^{${$}}`}else E=_.toFixed(b).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");const O=_.toExponential(15);if(u){const P=s({x:_,y:0});P.x>-20&&P.x<d+mt&&(e.beginPath(),e.moveTo(P.x,f.y-et/2),e.lineTo(P.x,f.y+et/2),e.stroke(),c({id:`polartick-r-x-${O}`,content:E,x:P.x,y:f.y+et+Bn,color:v,fontSize:ss,options:{textAlign:"center",textBaseline:"top"}}));const D=s({x:-_,y:0});D.x>-20&&D.x<d+mt&&(e.beginPath(),e.moveTo(D.x,f.y-et/2),e.lineTo(D.x,f.y+et/2),e.stroke(),c({id:`polartick-r-negx-${O}`,content:E,x:D.x,y:f.y+et+Bn,color:v,fontSize:ss,options:{textAlign:"center",textBaseline:"top"}}))}if(g){const P=s({x:0,y:_});P.y>-20&&P.y<h+mt&&(e.beginPath(),e.moveTo(f.x-et/2,P.y),e.lineTo(f.x+et/2,P.y),e.stroke(),c({id:`polartick-r-posy-${O}`,content:E,x:f.x-et-Bn,y:P.y,color:v,fontSize:ss,options:{textAlign:"right",textBaseline:"middle"}}));const D=s({x:0,y:-_});D.y>-20&&D.y<h+mt&&(e.beginPath(),e.moveTo(f.x-et/2,D.y),e.lineTo(f.x+et/2,D.y),e.stroke(),c({id:`polartick-r-negy-${O}`,content:E,x:f.x-et-Bn,y:D.y,color:v,fontSize:ss,options:{textAlign:"right",textBaseline:"middle"}}))}})}function qd(e,t,{canvas:n,dpr:o,colors:i},s,a){const r=n.width/o,c=n.height/o,l=s({x:0,y:0}),d=(p,y,x,m)=>{e.beginPath(),e.moveTo(p,y),e.lineTo(x,m),e.stroke();const S=Math.atan2(m-y,x-p);e.beginPath(),e.moveTo(x,m),e.lineTo(x-De*Math.cos(S-qt),m-De*Math.sin(S-qt)),e.lineTo(x-De*Math.cos(S+qt),m-De*Math.sin(S+qt)),e.closePath(),e.fill()};e.lineWidth=Tn;const h=r>l.x,f=0<l.x,u=0<l.y,g=c>l.y;h&&(d(l.x,l.y,r,l.y),a({id:"axis-label-r-posx",content:Lo,x:r-De-Qi,y:l.y-Zi,color:i.axis,fontSize:ns,options:{textAlign:"center",textBaseline:"bottom"}})),f&&(d(l.x,l.y,0,l.y),a({id:"axis-label-r-negx",content:Lo,x:De+Qi,y:l.y-Zi,color:i.axis,fontSize:ns,options:{textAlign:"center",textBaseline:"bottom"}})),u&&(d(l.x,l.y,l.x,0),a({id:"axis-label-r-posy",content:Lo,x:l.x+ea,y:De+ta,color:i.axis,fontSize:ns,options:{textAlign:"left",textBaseline:"middle"}})),g&&(d(l.x,l.y,l.x,c),a({id:"axis-label-r-negy",content:Lo,x:l.x+ea,y:c-De-ta,color:i.axis,fontSize:ns,options:{textAlign:"left",textBaseline:"middle"}}))}function Ud(e,{canvas:t,dpr:n,colors:o,gridAlpha:i},s,a,r,c,l){const d=t.width/n,h=t.height/n,f=Math.min(d,h)*ac;let u,g;if(s.x>=0&&s.x<=d&&s.y>=0&&s.y<=h)u=0;else{const v=[No(s.x,s.y,0,0,d,0),No(s.x,s.y,d,0,d,h),No(s.x,s.y,d,h,0,h),No(s.x,s.y,0,h,0,0)];u=Math.min(...v)}const y=[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(v=>Math.sqrt((v.x-s.x)**2+(v.y-s.y)**2));g=Math.max(...y);const x=u*n/r.scale,m=g*n/r.scale,S=(v,E)=>{if(!v||E<Ii||v*r.scale/n<Jc)return;e.strokeStyle=`rgba(${o.grid.join(",")}, ${E*i})`,e.lineWidth=Tn;const P=x===0?1:Math.ceil(x/v),D=Math.floor(m/v);for(let F=P;F<=D;F++){const B=F*v*r.scale/n;if(B>f){const L=[],N={center:{x:s.x,y:s.y},radius:B};if([{p1:{x:0,y:0},p2:{x:d,y:0}},{p1:{x:d,y:0},p2:{x:d,y:h}},{p1:{x:d,y:h},p2:{x:0,y:h}},{p1:{x:0,y:h},p2:{x:0,y:0}}].forEach(A=>{ka(A,N).forEach(V=>{V.x>=0&&V.x<=d&&V.y>=0&&V.y<=h&&L.push(V)})}),L.length>=2){let A=L[0],k=L[1],V=0;for(let X=0;X<L.length;X++)for(let Y=X+1;Y<L.length;Y++){const H=(L[X].x-L[Y].x)**2+(L[X].y-L[Y].y)**2;H>V&&(V=H,A=L[X],k=L[Y])}e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(k.x,k.y),e.stroke()}}else e.beginPath(),e.arc(s.x,s.y,B,0,$e),e.stroke()}};if(S(c.interval1,c.alpha1),S(c.interval2,c.alpha2),!l||!Array.isArray(l))return;const I={x:d/2,y:h/2},b=Math.min(d,h)/4,M=Math.sqrt((s.x-I.x)**2+(s.y-I.y)**2),C=b+M;if(C<zr||!Zr(s.x,s.y,C,d,h))return;const w=C>f;let _=null;if(w){const v={x:0,y:0,w:d,h},E={x:s.x,y:s.y,r:C},O=aa(E,v);if(O.length>=2){let P=O[0],D=O[1],F=0;for(let L=0;L<O.length;L++)for(let N=L+1;N<O.length;N++){const $=(O[L].x-O[N].x)**2+(O[L].y-O[N].y)**2;$>F&&(F=$,P=O[L],D=O[N])}const R=(Math.atan2(s.y-P.y,P.x-s.x)*180/Math.PI+360)%360,B=(Math.atan2(s.y-D.y,D.x-s.x)*180/Math.PI+360)%360;_={minAngle:Math.min(R,B),maxAngle:Math.max(R,B),isFullCircle:!1},Math.abs(R-B)>180&&(_={minAngle:Math.max(R,B),maxAngle:Math.min(R,B)+360,isFullCircle:!1})}}else _=Kr(s,C,d,h);if(!_)return;const T=new Set;l.forEach(v=>{const E=v.alpha;if(E<Vr||C*(v.angle*Math.PI/180)<Hr*.5)return;e.strokeStyle=`rgba(${o.grid.join(",")}, ${E*i})`,e.lineWidth=Tn*Mc;let P;if(_.isFullCircle){P=[];for(let D=0;D<360;D+=v.angle)P.push(D)}else{if(P=[],_.ranges&&Array.isArray(_.ranges))_.ranges.forEach(D=>{let[F,R]=D;if(w){const $=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(V=>(Math.atan2(s.y-V.y,V.x-s.x)*180/Math.PI+360)%360),F,R].sort((V,X)=>V-X),A=Math.min(...$)-v.angle*2,k=Math.max(...$)+v.angle*2;F=A,R=k}const B=ti(v.angle,F,R);P.push(...B)});else if(_.minAngle!==void 0&&_.maxAngle!==void 0){let D=_.minAngle,F=_.maxAngle;if(w){const L=[...[{x:0,y:0},{x:d,y:0},{x:d,y:h},{x:0,y:h}].map(A=>(Math.atan2(s.y-A.y,A.x-s.x)*180/Math.PI+360)%360),D,F].sort((A,k)=>A-k),N=Math.min(...L)-v.angle*2,$=Math.max(...L)+v.angle*2;D=N,F=$}P=ti(v.angle,D,F)}P=[...new Set(P)]}P.forEach(D=>{if(D=Math.round(D*1e10)/1e10,T.has(D))return;const F=D*Math.PI/180,R={x:s.x+x*r.scale/n*Math.cos(F),y:s.y-x*r.scale/n*Math.sin(F)},B={x:s.x+m*r.scale/n*Math.cos(F),y:s.y-m*r.scale/n*Math.sin(F)};e.beginPath(),e.moveTo(R.x,R.y),e.lineTo(B.x,B.y),e.stroke(),T.add(D)})})}function jd(e,{gridDisplayMode:t,canvas:n,dpr:o,viewTransform:i,gridAlpha:s,colors:a},r,c,l,d){if(t===Io)return;e.save();const h=r({x:0,y:0}),f=n.width/o,u=n.height/o;if(t===Aa){const g=c({x:0,y:0}),p=c({x:f,y:u}),y=Math.hypot(Math.max(Math.abs(g.x),Math.abs(p.x)),Math.max(Math.abs(g.y),Math.abs(p.y)));Ud(e,{canvas:n,dpr:o,colors:a,gridAlpha:s},h,y,i,l,d)}else{const g=(p,y)=>{if(!p||y<Ii)return;const x=`rgba(${a.grid.join(",")}, ${y*s})`,m=c({x:0,y:u}),S=c({x:f,y:0}),I=Math.floor(m.x/p),b=Math.ceil(S.x/p),M=Math.floor(m.y/p),C=Math.ceil(S.y/p);if(t===Ta){e.strokeStyle=x,e.lineWidth=Tn;for(let w=I;w<=b;w++){const _=w*p,T=r({x:_,y:0}).x;e.beginPath(),e.moveTo(T,0),e.lineTo(T,u),e.stroke()}for(let w=M;w<=C;w++){const _=w*p,T=r({x:0,y:_}).y;e.beginPath(),e.moveTo(0,T),e.lineTo(f,T),e.stroke()}}else if(t===Pa){e.fillStyle=x;const w=gr*o;for(let _=I;_<=b;_++){const T=_*p;for(let v=M;v<=C;v++){const E=v*p,O=r({x:T,y:E});e.beginPath(),e.arc(O.x,O.y,w,0,$e),e.fill()}}}else if(t===_a){e.fillStyle=x;const w=gr*o,_=p*xa,T=Math.floor(m.y/_),v=Math.ceil(S.y/_);for(let E=T;E<=v;E++){const O=E*_,D=E%2!==0?p/2:0;for(let F=I;F<=b;F++){const B=F*p+D,L=r({x:B,y:O});e.beginPath(),e.arc(L.x,L.y,w,0,$e),e.fill()}}}};g(l.interval1,l.alpha1),g(l.interval2,l.alpha2)}e.restore()}function Oa(e,t,n,o,i,s,a=!1){e.save(),e.strokeStyle=s,e.lineWidth=Tn,e.setLineDash(a?Fr:[]);const r=-n,c=-o;let l=nt(o-n);e.beginPath(),e.arc(t.x,t.y,i,r,c,l>0),e.stroke(),e.restore()}function Qr(e,{info:t,colors:n,idPrefix:o,startVertexScreen:i},s,a,r){if(!t||!t.edge)return;const{edge:c,fraction:l,snapPoint:d}=t,h=a(c.id1),f=a(c.id2);if(!h||!f)return;const u=s(h),g=s(f),p=s(d),y=n.feedbackSnapped,x=xd({x:-(g.y-u.y),y:g.x-u.x});let m=1;i&&(m=(g.x-u.x)*(i.y-u.y)-(g.y-u.y)*(i.x-u.x)>0?-1:1);const S=so,I={x:(u.x+p.x)/2,y:(u.y+p.y)/2},b={x:I.x+m*x.x*S,y:I.y+m*x.y*S},M=Ut(l,.001,8);r({id:`${o}-1`,content:M,x:b.x,y:b.y,color:y,fontSize:Ki,options:{textAlign:"center",textBaseline:"middle"}});const C={x:(p.x+g.x)/2,y:(p.y+g.y)/2},w={x:C.x+m*x.x*S,y:C.y+m*x.y*S},_=Ut(1-l,.001,8);r({id:`${o}-2`,content:_,x:w.x,y:w.y,color:y,fontSize:Ki,options:{textAlign:"center",textBaseline:"middle"}})}function Kd(e,{allEdges:t,selectedEdgeIds:n,hoveredEdgeId:o,isDragConfirmed:i,dragPreviewVertices:s,colors:a,edgesVisible:r,snappedEdgeIds:c,currentAltPressed:l,interpolationStyle:d,getInterpolationStyleById:h,edgeColorMode:f="fixed",edgeColorExpression:u="x"},g,p,y){e.lineWidth=ts;const x=ct(a.defaultStroke,{r:255,g:255,b:255,a:1}),m=I=>{const b=I?.color||a.vertex||a.defaultStroke;return ct(b,x)},S=(I,b,M,C)=>{if(f==="inherit_vertices"&&M&&C){const w=m(M),_=m(C);return{r:St(w.r,_.r,b),g:St(w.g,_.g,b),b:St(w.b,_.b,b),a:St(w.a,_.a,b)}}if(f==="colormap"&&I.colormapItem){const w=Bs(u,{x:b},b),_=Fs(w),T=Ae(I.colormapItem,_);return ct(T,x)}return ct(I.color||a.defaultStroke,x)};t.forEach(I=>{const b=p(I.id1),M=p(I.id2);if(!b||!M||b.type!==Pn||M.type!==Pn)return;const C=y(I),w=n.includes(C),_=c&&c.has(C)&&c.get(C).some(B=>B.copyIndex===void 0||B.copyIndex===0),T=!l&&C===o;if(!r&&!w&&!_&&!T)return;let v=b,E=M;const O=I.interpolationStyleId&&h?h(I.interpolationStyleId):d,D=(O?Gs([v,E],O,!1,g):[v,E]).map(B=>g(B));if(D.length<2)return;const F=D[0],R=D[D.length-1];e.beginPath(),e.moveTo(D[0].x,D[0].y);for(let B=1;B<D.length;B++)e.lineTo(D[B].x,D[B].y);if(f==="colormap"||f==="inherit_vertices"){let B=0;for(let N=1;N<D.length;N++)B+=Math.hypot(D[N].x-D[N-1].x,D[N].y-D[N-1].y);let L=0;for(let N=1;N<D.length;N++){const $=D[N-1],A=D[N],k=Math.hypot(A.x-$.x,A.y-$.y),V=B>0?L/B:0,X=B>0?(L+k)/B:1,Y=(V+X)/2,H=S(I,Y,v,E);e.strokeStyle=`rgba(${Math.round(H.r)},${Math.round(H.g)},${Math.round(H.b)},${H.a})`,e.beginPath(),e.moveTo($.x,$.y),e.lineTo(A.x,A.y),e.setLineDash([]),e.lineWidth=ts,e.stroke(),L+=k}}else if(I.colormapItem){const B=e.createLinearGradient(F.x,F.y,R.x,R.y),L=Ae(I.colormapItem,I.gradientStart),N=Ae(I.colormapItem,I.gradientEnd);B.addColorStop(0,L),B.addColorStop(1,N),e.strokeStyle=B,e.setLineDash([]),e.lineWidth=ts,e.stroke()}else e.strokeStyle=I.color||a.defaultStroke,e.setLineDash([]),e.lineWidth=ts,e.stroke();if(w||_||T){e.save(),e.strokeStyle=_?a.feedbackSnapped:a.selectionGlow,e.globalAlpha=fs,e.lineWidth=Hn,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(D[0].x,D[0].y);for(let B=1;B<D.length;B++)e.lineTo(D[B].x,D[B].y);e.stroke(),e.restore()}}),e.setLineDash([]),e.strokeStyle=a.defaultStroke,e.globalAlpha=1}function ni(e,t,n,o,i){const{selectedVertexIds:s,selectedCenterIds:a,activeCenterId:r,colors:c,verticesVisible:l=!0,isHovered:d=!1,snappedVertexIds:h,isDragConfirmed:f,dragPreviewVertices:u,currentAltPressed:g}=n;let p=t,y=!1,x=null,m;if(f&&u){const M=u.find(C=>C&&(C.id===t.id||C.originalId===t.id));M&&(p=M,m=M.transformIndex)}if(h&&p.originalId&&h.has(p.originalId)){const C=h.get(p.originalId).find(w=>w.copyIndex===m);C&&(y=!0,x=C.type)}else if(h&&!p.originalId&&h.has(p.id)){const C=h.get(p.id).find(w=>w.copyIndex===m);C&&(y=!0,x=C.type)}let S;if(p.type===Pn){if(S=s.includes(p.id),!l&&!S&&!d&&!y&&!(g&&d))return}else S=a.includes(p.id);const I=o(p);switch(p.type){case Pn:e.beginPath(),e.arc(I.x,I.y,Fe,0,$e),e.fillStyle=p.color||c.vertex,e.fill();break;case Kt:case Rn:case sn:case Jn:const M=Si*2,C={type:p.type,x:I.x-M/2,y:I.y-M/2,width:M,height:M};Ti(e,C,c);break}const b={...n,isSnapped:y,snapType:x};La(e,p,b,o)}function Jd(e,{altHoverInfo:t,colors:n},o,i,s){if(!t)return;const{point:a,element:r,shiftKey:c,fraction:l}=t,d=o(a),h=n.feedbackSnapped,f=n.feedbackSnapped;e.save(),e.shadowColor=f,e.shadowBlur=Ma,e.globalAlpha=fs,e.beginPath();const u=Fe+ei;e.arc(d.x,d.y,u,0,$e),e.strokeStyle=f,e.lineWidth=Hn,e.stroke(),e.restore(),e.save(),e.beginPath(),e.arc(d.x,d.y,Fe,0,$e),e.fillStyle=h,e.fill(),e.restore(),r.type==="edge"&&c&&Zd(e,{info:{edge:r.edge,fraction:l,snapPoint:a},colors:n},o,i,s)}function Zd(e,{info:t,colors:n},o,i,s){Qr(e,{info:t,colors:n,idPrefix:"alt-snap-label"},o,i,s)}function Qd(e,{info:t,colors:n},o,i,s){if(!t||!t.startVertex)return;const a=o(t.startVertex);Qr(e,{info:t,colors:n,idPrefix:"snap-label",startVertexScreen:a},o,i,s)}function eh(e,{transformIndicatorData:t,colors:n,currentShiftPressed:o},i){const{center:s,startPos:a,currentPos:r,rotation:c,isSnapping:l,snapType:d}=t,h=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(s),u=i(a),g=i(r);if(e.save(),e.lineWidth=jt,e.strokeStyle=h,e.setLineDash(Mn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!o||o&&d==="projection"){const y=He(a,s,c,1),x=i(y);e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(g.x,g.y),e.stroke()}if(Math.abs(c)>Ia){e.setLineDash([]);const y=J(f,u),x=Math.atan2(u.y-f.y,u.x-f.x),m=-c,S=c>0;e.beginPath(),e.arc(f.x,f.y,y,x,x+m,S),e.stroke()}e.restore()}function th(e,{transformIndicatorData:t,colors:n,currentShiftPressed:o},i){const{center:s,startPos:a,scale:r,isSnapping:c,snapType:l,currentPos:d}=t,h=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,f=i(s),u=i(a),g=i(d);if(e.save(),e.lineWidth=jt,e.strokeStyle=h,e.setLineDash(Mn),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke(),!o){const m=J(f,g),S=Math.atan2(u.y-f.y,u.x-f.x),I=Math.atan2(g.y-f.y,g.x-f.x);let b=I-S;b>Math.PI?b-=2*Math.PI:b<-Math.PI&&(b+=2*Math.PI);const M=b<0;e.beginPath(),e.arc(f.x,f.y,m,S,I,M),e.stroke()}const y={x:s.x+(a.x-s.x)*r,y:s.y+(a.y-s.y)*r},x=i(y);e.setLineDash([]),e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(x.x,x.y),e.stroke(),e.restore()}function nh(e,{transformIndicatorData:t,colors:n,currentShiftPressed:o},i){const{center:s,startPos:a,currentPos:r,scale:c,startVector:l,isSnapping:d,snapType:h,projectionSource:f}=t,u=d?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,g=i(s),p=i(a),y=i(r);e.save(),e.lineWidth=jt,e.strokeStyle=u,e.setLineDash(Mn),e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(p.x,p.y),e.stroke();const x=He(a,s,0,c,!0,l),m=i(x);if((!o||o&&h==="projection")&&(e.setLineDash(Mn),e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(m.x,m.y),e.stroke()),e.setLineDash([]),e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(m.x,m.y),e.stroke(),d&&h==="projection"&&f){const I=i(f),b=s,M={x:s.x+l.x,y:s.y+l.y},C=Gr(f,b,M),w=i(C);e.setLineDash(Mn),e.beginPath(),e.moveTo(I.x,I.y),e.lineTo(w.x,w.y),e.stroke()}e.restore()}function sh(e,{transformIndicatorData:t,colors:n},o){const{center:i,startPos:s,rotation:a,scale:r,isSnapping:c}=t,l=c?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`,d=o(i),h=o(s);e.save(),e.lineWidth=jt,e.strokeStyle=l,e.setLineDash(Mn),e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(h.x,h.y),e.stroke();const f={x:i.x+(s.x-i.x)*r,y:i.y+(s.y-i.y)*r},u=o(f);if(e.setLineDash([]),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(u.x,u.y),e.stroke(),Math.abs(a)>Ia){const g=J(d,u),p=Math.atan2(h.y-d.y,h.x-d.x),y=-a,x=a>0;e.beginPath(),e.arc(d.x,d.y,g,p,p+y,x),e.stroke()}e.restore()}function oh(e,t,{transformIndicatorData:n,colors:o,coordSystemTransformIndicatorData:i,currentShiftPressed:s},a,r){if(n){const{isSnapping:c,snapType:l,transformType:d}=n;switch(e.save(),e.lineWidth=jt,d){case sn:sh(e,{transformIndicatorData:n,colors:o},a);break;case Kt:eh(e,{transformIndicatorData:n,colors:o,currentShiftPressed:s},a);break;case Rn:th(e,{transformIndicatorData:n,colors:o,currentShiftPressed:s},a);break;case Jn:nh(e,{transformIndicatorData:n,colors:o,currentShiftPressed:s},a);break}c&&l==="projection"&&s&&ih(e,{transformIndicatorData:n,colors:o},a),e.restore(),ah(t,{transformIndicatorData:n,colors:o},a,r)}i&&rh(t,{coordSystemTransformIndicatorData:i,colors:o},a,r)}function ih(e,{transformIndicatorData:t,colors:n},o){const{transformType:i,projectionSource:s,projectionCenter:a,projectionPoint:r,currentPos:c}=t;if(i!==sn){if(e.setLineDash(Mn),e.strokeStyle=n.feedbackSnapped,i===Kt&&r){const l=o(c),d=o(r),h=o(s);e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(d.x,d.y),e.stroke(),e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(d.x,d.y),e.stroke()}else if(i===Rn&&a){const l=o(a),d=o(s),h=o(c),f=J(l,d);let u=Math.atan2(d.y-l.y,d.x-l.x),g=Math.atan2(h.y-l.y,h.x-l.x);const p=2*Math.PI;u=(u+p)%p,g=(g+p)%p;const y=(g-u+p)%p,m=(u-g+p)%p<y;e.beginPath(),e.arc(l.x,l.y,f,u,g,m),e.stroke()}}}function ah(e,{transformIndicatorData:t,colors:n},o,i){const{center:s,startPos:a,rotation:r,scale:c,isSnapping:l,snapType:d,snappedScaleValue:h,transformType:f}=t,u=o(s),g=o(a),p=l?n.feedbackSnapped:`rgba(${n.feedbackDefault.join(",")}, 1.0)`;if(f===Rn||f===sn||f===Jn){let y;const x=h!==null?h:c;d==="projection"||d==="merge"&&f===sn?y=`\\times ${parseFloat(x.toFixed(Yi)).toString()}`:l&&h!==null?y=`\\times ${Ut(h,is,zc)}`:y=`\\times ${parseFloat(x.toFixed(Yi)).toString()}`;const S=(u.x+g.x)/2,I=(u.y+g.y)/2,b=Math.atan2(g.y-u.y,g.x-u.x),M=b-Math.PI/2,C=S+Math.cos(M)*hr,w=I+Math.sin(M)*hr;let _=b*(180/Math.PI);(_>90||_<-90)&&(_+=180),i({id:"transform-scale-indicator",content:y,x:C,y:w,color:p,fontSize:tn,options:{textAlign:"center",textBaseline:"bottom",rotation:_}})}else i({id:"transform-scale-indicator",content:"",x:0,y:0,color:p,fontSize:tn,options:{}});if((f===Kt||f===sn)&&Math.abs(r)>Ia){const y=r*(180/Math.PI),x=`${parseFloat(y.toFixed(Yi)).toString()}^{\\circ}`,m={x:g.x-u.x,y:g.y-u.y},S=Math.atan2(m.y,m.x)+-r/2,b=Math.hypot(m.x,m.y)+Xc,M=u.x+b*Math.cos(S),C=u.y+b*Math.sin(S);let w=S*(180/Math.PI);(w>90||w<-90)&&(w+=180),i({id:"transform-angle-indicator",content:x,x:M,y:C,color:p,fontSize:tn,options:{rotation:w}})}else i({id:"transform-angle-indicator",content:"",x:0,y:0,color:p,fontSize:tn,options:{}})}function rh(e,{coordSystemTransformIndicatorData:t,colors:n},o,i){const{edgeFraction:s,orthogonalDistanceFraction:a,v1:r,v2:c,snapPosition:l}=t;let d="",h={x:0,y:0};if(a!==void 0){d=Ut(a,.001,8);const f=o(l.origin),u=o(l.closest),g=(f.x+u.x)/2,p=(f.y+u.y)/2,y=Math.atan2(u.y-f.y,u.x-f.x);h.x=g+Math.cos(y+Math.PI/2)*so,h.y=p+Math.sin(y+Math.PI/2)*so}else if(s!==void 0){const f=o(r),u=o(c),g=o(l),p=Math.atan2(u.y-f.y,u.x-f.x),y=Math.cos(p+Math.PI/2)*so,x=Math.sin(p+Math.PI/2)*so;h.x=g.x+y,h.y=g.y+x,d=Ut(s,.001,8)}d&&i({id:"coord-system-edge-fraction",content:d,x:h.x,y:h.y,color:n.feedbackSnapped,fontSize:Ki,options:{textAlign:"center",textBaseline:"middle"}})}function lh(e,t,n,o,{showAngles:i,showDistances:s,viewTransform:a,mousePos:r,colors:c}){if(!i&&!s||!t.frozen_Origin_Data_to_display)return;const l=t.frozen_Origin_Data_to_display,d=o(r);if(J(l,d)<re)return;const f=c.frozenReference,u=t.displayAngleA_valueRad_for_A_equals_label,g=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0;if(!l)return;const p=n(l),y=g+u;if(e.save(),e.lineWidth=jt,e.strokeStyle=f,i&&t.displayAngleA_valueRad_for_A_equals_label!==null&&Math.abs(t.displayAngleA_valueRad_for_A_equals_label)>re){const x=Hs+e.lineWidth/2,m={x:l.x+Math.cos(g)*(x/a.scale),y:l.y+Math.sin(g)*(x/a.scale)},S=n(m);e.beginPath(),e.moveTo(p.x,p.y),e.lineTo(S.x,S.y),e.setLineDash(hc),e.stroke(),Oa(e,p,g,y,Hs,f,!1)}e.restore()}function el(e,t,n,o,i,{showDistances:s,showAngles:a,currentShiftPressed:r,distanceSigFigs:c,angleSigFigs:l,angleDisplayMode:d,viewTransform:h,frozenReference_D_du:f,gridDisplayMode:u,frozenReference_A_rad:g,colors:p,lastGridState:y},x,m,S){if(!a&&!s||i.distance<re){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const I=x(n),{angle:b,distance:M,lengthSnapFactor:C,angleSnapFactor:w,angleTurn:_,gridToGridSquaredSum:T,gridInterval:v,snapType:E}=i,{offsetAngleRad:O,isFirstSegmentBeingDrawn:P,currentSegmentReferenceD:D}=m,F=i.snapped||r?p.feedbackSnapped:p.geometryInfoText,R=Math.atan2(o.y-n.y,o.x-n.x);if(M*h.scale/window.devicePixelRatio<Xr){S({id:"snap-dist",content:"",x:0,y:0}),S({id:"snap-angle",content:"",x:0,y:0});return}const B=a&&M>re&&(P||Math.abs(_)>re);if(s){let L="",N=i.gridInterval||null;if(!N&&y&&typeof y.alpha1=="number"&&typeof y.alpha2=="number"&&(N=y.alpha2>=y.alpha1&&y.interval2?y.interval2:y.interval1),r&&i.snapped)if(P)if(E==="grid"&&T!==null&&N)if(T===0)L="0";else{const[$,A]=ls(T),k=N*$,V=parseFloat(k.toFixed(10));L=cs(V,A)}else if(E==="geometric"&&C!==null){const $=C*D;L=Ut($,is,Ds),(L===$.toFixed(2)||L===String(Math.round($)))&&(L=lt($,c))}else if(E==="vertex"||E==="edge_fraction"||E==="edge"){let $=!1;if(N){const A=i.x-n.x,k=i.y-n.y,V=A/N,X=k/N;if(Math.abs(V-Math.round(V))<1e-5&&Math.abs(X-Math.round(X))<1e-5){const Y=Math.round(V),H=Math.round(X),G=Y*Y+H*H;if(G===0)L="0";else{const[W,Q]=ls(G),te=N*W,pe=parseFloat(te.toFixed(10));L=cs(pe,Q)}$=!0}}$||(L=lt(M,c))}else L=lt(M,c);else if(E==="geometric"&&C!==null)L=Ps(C,"D");else if(E==="grid"&&T!==null&&N&&f!==null&&f>re){const A=N*Math.sqrt(T)/f;let k=!1;for(const V of $n)if(Math.abs(A-V)<re){L=Ps(V,"D"),k=!0;break}if(!k)if(T===0)L="0";else{const[V,X]=ls(T),Y=N*V,H=parseFloat(Y.toFixed(10));L=cs(H,X)}}else if(E==="vertex"||E==="edge_fraction"||E==="edge")if(f!==null&&f>re){const $=M/f;let A=!1;for(const k of $n)if(Math.abs($-k)<re){L=Ps(k,"D"),A=!0;break}A||(L=lt(M,c))}else L=lt(M,c);else L=lt(M,c);else if(!P&&f!==null&&f>re){const $=M/f;let A=!1;for(const k of $n)if(Math.abs($-k)<re){L=Ps(k,"D"),A=!0;break}A||(L=lt(M,c))}else L=lt(M,c);if(L){const $=x(n),A=x(o),k=Math.atan2(A.y-$.y,A.x-$.x),V=($.x+A.x)/2,X=($.y+A.y)/2;let Y;if(B){const Q=P?-R:-_;Q<0&&Q>-Math.PI||Q>Math.PI?Y=k-Math.PI/2:Y=k+Math.PI/2}else Y=k-Math.PI/2,Math.sin(Y)>0&&(Y+=Math.PI);const H=V+Math.cos(Y)*Fn,G=X+Math.sin(Y)*Fn;let W=k*(io/Math.PI);(W>$r||W<-90)&&(W+=io),S({id:"snap-dist",content:L,x:H,y:G,color:F,fontSize:tn,options:{rotation:W}},t)}else S({id:"snap-dist",content:"",x:0,y:0})}else S({id:"snap-dist",content:"",x:0,y:0});if(B){const L=P?0:O;Oa(e,I,L,R,Hs,F),e.save(),e.beginPath();const N=Hs+e.lineWidth/2,$={x:n.x+N/h.scale*Math.cos(L),y:n.y+N/h.scale*Math.sin(L)},A=x($);e.moveTo(I.x,I.y),e.lineTo(A.x,A.y),e.strokeStyle=F,e.setLineDash(dc),e.lineWidth=jt,e.stroke(),e.restore();let k="";const V=!P&&g!==null&&Math.abs(g)>re,X=m.currentSegmentReferenceA_for_display,Y=P?R:_;if(d===us){let H=nt(Y)*(180/Math.PI);r&&!P&&i.snapped&&E==="geometric"&&w!==null||r&&V&&w!==null&&i.snapped&&E!=="geometric"?k=Ps(w,"A"):Math.abs(H)>Qo&&(k=`${lt(H,l)}^{\\circ}`)}else if(d===bo){let H=nt(Y);if(r&&!P&&i.snapped&&E==="geometric"&&w!==null&&X){const G=Ut(w*(X/Math.PI),is,Ds);G==="0"?k="0":G==="1"?k=Et:G==="-1"?k=`-${Et}`:k=`${G}${Et}`}else if(r&&V&&w!==null&&i.snapped&&E!=="geometric"&&X){const G=Ut(w*(X/Math.PI),is,Ds);G==="0"?k="0":G==="1"?k=Et:G==="-1"?k=`-${Et}`:k=`${G}${Et}`}else if(Math.abs(H)>Qo){const G=Ut(H/Math.PI,is,Ds);G!==H.toFixed(2)?G==="0"?k="0":G==="1"?k=Et:G==="-1"?k=`-${Et}`:k=`${G}${Et}`:k=lt(H,l)}}if(k){const H=-L,G=-R,W=Math.cos(H)+Math.cos(G),Q=Math.sin(H)+Math.sin(G),te=Math.atan2(Q,W),pe=Zo;let me=te*(180/Math.PI);const vt={x:pe*Math.cos(te),y:pe*Math.sin(te)},Qe={x:I.x+vt.x,y:I.y+vt.y};(me>90||me<-90)&&(me+=180),S({id:"snap-angle",content:k,x:Qe.x,y:Qe.y,color:F,fontSize:tn,options:{rotation:me}},t)}else S({id:"snap-angle",content:"",x:0,y:0})}else S({id:"snap-angle",content:"",x:0,y:0})}function ch(e,t,{showAngles:n,showDistances:o,viewTransform:i,mousePos:s,frozenReference_D_du:a,distanceSigFigs:r,angleSigFigs:c,angleDisplayMode:l,colors:d},h,f,u){const g=Xr/i.scale;let p=-1;if(t.frozen_Origin_Data_to_display){const v=t.frozen_Origin_Data_to_display,E=h(s);p=J(v,E)}if(!n&&!o||!t.frozen_Origin_Data_to_display||p<g)return;const y=d.frozenReference,x=t.frozen_Origin_Data_to_display,m=t.displayAngleA_valueRad_for_A_equals_label,S=t.frozen_A_baseRad_to_display!==null?t.frozen_A_baseRad_to_display:0,I=t.frozen_D_du_to_display,b=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.g2gSquaredSum:null,M=t.frozen_D_g2g_to_display?t.frozen_D_g2g_to_display.interval:null;if(!x)return;const C=S+m,w={x:x.x+I*Math.cos(C),y:x.y+I*Math.sin(C)},_=f(x),T=f(w);if(o&&I!==null&&I>g){let v="";if(b!==null&&b>0&&M){const[L,N]=ls(b),$=M*L,A=parseFloat($.toFixed(10));v=`${ur}${cs(A,N)}`}else{const L=I/na;v=`${ur}${lt(L,r)}`}const E=Math.atan2(T.y-_.y,T.x-_.x),O=(_.x+T.x)/2,P=(_.y+T.y)/2;let D=E*(io/Math.PI);(D>$r||D<-90)&&(D+=io);let F;m!==null&&Math.abs(m)>re?-m<0?F=E-Math.PI/2:F=E+Math.PI/2:(F=E-Math.PI/2,Math.sin(F)>0&&(F+=Math.PI));const R=O+Math.cos(F)*Jo,B=P+Math.sin(F)*Jo;u({id:"ref-dist",content:v,x:R,y:B,color:y,fontSize:sa,options:{rotation:D}},e)}if(n&&m!==null&&Math.abs(m)>re){const v=-S,E=-(S+m),O=Math.cos(v)+Math.cos(E),P=Math.sin(v)+Math.sin(E),D=Math.atan2(P,O),F=Zo,R=_.x+Math.cos(D)*F,B=_.y+Math.sin(D)*F;let L=D*(180/Math.PI);(L>90||L<-90)&&(L+=180);let N="";if(l===us){let $=m*(io/Math.PI);N=`${no}${lt($,c)}^{\\circ}`}else l===bo&&(N=`${no}${Ut(m/Math.PI,is,Ds)}${Et}`,N===`${no}1${Et}`&&(N=Et),N===`${no}-1${Et}`&&(N=`-${Et}`),N===`${no}0${Et}`&&(N="0"));u({id:"ref-angle",content:N,x:R,y:B,color:y,fontSize:sa,options:{rotation:L}},e)}}function dh(e,{coordsDisplayMode:t,isMouseOverCanvas:n,currentShiftPressed:o,ghostVertexPosition:i,gridDisplayMode:s,lastGridState:a,angleDisplayMode:r,canvas:c,dpr:l,mousePos:d,colors:h,useScientific:f},u,g){if(t===vi||!d||!n)return;let p;o&&i?p=i:p=u(d);let y=1;s!==Io&&a&&a.interval1&&(y=a.interval1);let x=y;a&&a.interval2&&a.interval2<x&&(x=a.interval2);let m,S=1;x>=1e4?(S=100,m=0):x>=1e3?(S=10,m=0):x>=100?(S=1,m=0):x>=10?m=1:m=Math.max(0,-Math.floor(Math.log10(x)))+2;const M=(v=>1)(x)+2,C=v=>{if(f){const E=M-1,P=Math.abs(v).toExponential(E).split("e");let D=P[0],F=parseInt(P[1],10);return`${v<0?"-":""}${D} \\cdot 10^{${F}}`}else return S>1?(Math.round(v/S)*S).toFixed(m):v.toFixed(m)},w=Math.min(m,Hc);let _="";switch(t){case wa:{let v=C(p.x);p.x>=0&&!v.includes("cdot")&&(v=`${Ts}${v}`);let E=C(p.y);p.y>=0&&!E.includes("cdot")&&(E=`${Ts}${E}`),_=`\\begin{pmatrix*}[r] x \\\\ y \\end{pmatrix*} = \\begin{pmatrix*}[r] ${v} \\\\ ${E} \\end{pmatrix*}`;break}case uo:{let v=C(p.x);p.x>=0&&!v.includes("cdot")&&(v=`${Ts}${v}`);const E=Math.abs(p.y);let O=C(E);const P=p.y<0?"-":"+";_=`z = ${v} ${P} ${O}${Xo}`;break}case Mi:{const v=Math.hypot(p.x,p.y),E=Math.atan2(p.y,p.x);let O=C(v);v>=0&&!O.includes("cdot")&&(O=`${Ts}${O}`);let P;if(r===us){let D=gd(E*180/Math.PI);P=D.toFixed(w),D>=0&&(P=`${Ts}${P}`),P+="^{\\circ}"}else{let D=nt(E);P=D.toFixed(w),D>=0&&(P=`${Ts}${P}`)}_=`\\begin{pmatrix*}[r] r \\\\ \\theta \\end{pmatrix*} = \\begin{pmatrix*}[r] ${O} \\\\ ${P} \\end{pmatrix*}`;break}}const T=c.width/l;g({id:"mouse-coord-text",content:_,x:T-dr,y:dr,color:h.mouseCoords,fontSize:Gc,options:{textAlign:"right",textBaseline:"top"}})}function tl(e,t,n,o){e.save();const i=t.x+t.width/2,s=t.y+t.height/2,a=t.width/2*.6;if(e.strokeStyle=o.uiIcon,e.fillStyle=o.uiIcon,e.lineWidth=2,n==="dark"){e.beginPath(),e.arc(i,s,a*.7,0,2*Math.PI),e.fill();for(let r=0;r<8;r++){const c=r/8*2*Math.PI,l=i+Math.cos(c)*(a*.85),d=s+Math.sin(c)*(a*.85),h=i+Math.cos(c)*(a*1.1),f=s+Math.sin(c)*(a*1.1);e.beginPath(),e.moveTo(l,d),e.lineTo(h,f),e.stroke()}}else e.beginPath(),e.arc(i,s,a,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(i-5,s-3,a,0,2*Math.PI),e.fillStyle=o.background,e.fill();e.restore()}function hh(e,t,n,o,i,s,a){const r=o?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/Qs;e.scale(l,l),e.translate(-16,-16);const d=1;e.strokeStyle=r,e.lineWidth=yn,e.lineCap="round",e.beginPath(),e.moveTo(2+d,30),e.lineTo(30+d,30),e.moveTo(2+d,30),e.lineTo(2+d,2),e.stroke(),e.fillStyle=r;const h={x:16+d,y:16};let f={x:17+d,y:8},u="";switch(n){case wa:e.setLineDash($i),e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(h.x,30),e.moveTo(h.x,h.y),e.lineTo(2+d,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Cn,0,$e),e.fill(),u="(x,y)";break;case uo:e.setLineDash($i),e.beginPath(),e.moveTo(2+d,30),e.lineTo(h.x,h.y),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Cn,0,$e),e.fill(),u="x+iy";break;case Mi:e.setLineDash($i),e.beginPath(),e.moveTo(2+d,30),e.lineTo(h.x,h.y),e.stroke(),e.beginPath(),e.arc(2+d,30,8,-Math.atan2(30-h.y,h.x-(2+d)),0),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(h.x,h.y,Cn,0,$e),e.fill(),u="(r,\\theta)";break}if(e.restore(),u){const g="icon-label-coords",p=o?a.uiTextSelected:a.uiTextDefault;s({id:g,content:u,x:c.x+(f.x-16)*l,y:c.y+(f.y-16)*l,color:p,fontSize:fo,options:{textAlign:"center",textBaseline:"middle"}},i)}}function nl(e,t,n,o,i,s,a){const r=o?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};let l=0;e.save(),e.translate(c.x,c.y);const d=t.width/Qs;e.scale(d,d),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=yn;const h={x:28,y:30},f={x:4,y:30},u={x:16,y:8};e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(f.x,f.y),e.lineTo(u.x,u.y),e.stroke();let g="",p={x:20,y:22};if(n!==po){e.beginPath();const y=Math.atan2(u.y-f.y,u.x-f.x);e.arc(f.x,f.y,8,y,0),e.stroke(),n===us?g="60^\\circ":n===bo&&(g="\\frac{\\pi}{3}",l=2)}if(e.restore(),g){const y="icon-label-angles",x=o?a.uiTextSelected:a.uiTextDefault;s({id:y,content:g,x:c.x+(p.x-16)*d,y:c.y+(p.y-20)*d,color:x,fontSize:fo+l,options:{textAlign:"center",textBaseline:"middle"}},i)}}function sl(e,t,n,o,i,s,a){const r=o?a.uiIconSelected:a.uiIconDefault,c={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(c.x,c.y);const l=t.width/Qs;e.scale(l,l),e.translate(-16,-16),e.strokeStyle=r,e.lineWidth=yn,e.beginPath(),e.moveTo(2,30),e.lineTo(30,30),e.stroke();let d="",h={x:16,y:22};if(n===go&&(d="3.14"),e.restore(),d){const f="icon-label-distances",u=o?a.uiTextSelected:a.uiTextDefault;s({id:f,content:d,x:c.x+(h.x-16)*l,y:c.y+(h.y-16)*l,color:u,fontSize:12,options:{textAlign:"center",textBaseline:"middle"}},i)}}function fh(e,t,n,o,i){const s=o?i.uiIconSelected:i.uiIconDefault,a={x:t.x+t.width/2,y:t.y+t.height/2};e.save(),e.translate(a.x,a.y);const r=t.width/Qs;switch(e.scale(r,r),e.translate(-16,-16),e.strokeStyle=s,e.fillStyle=s,e.lineWidth=yn,n){case Ta:e.strokeRect(2,2,28,28),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Pa:e.strokeRect(2,2,28,28),e.beginPath(),[8,16,24].forEach(h=>{[8,16,24].forEach(f=>{e.moveTo(h,f),e.arc(h,f,Cn,0,$e)})}),e.fill();break;case _a:e.strokeRect(2,2,28,28);const c=8,l=16,d=16;e.beginPath(),e.arc(l,d,Cn,0,$e);for(let h=0;h<6;h++){const f=Math.PI/3*h,u=l+c*Math.cos(f),g=d+c*Math.sin(f);e.moveTo(u,g),e.arc(u,g,Cn,0,$e)}e.fill();break;case Aa:e.beginPath(),e.arc(16,16,14,0,$e),e.stroke(),e.beginPath(),e.arc(16,16,7,0,$e),e.stroke(),e.beginPath(),e.moveTo(2,16),e.lineTo(30,16),e.moveTo(16,2),e.lineTo(16,30),e.stroke();break;case Io:e.strokeRect(2,2,28,28);break}e.restore()}function Ti(e,t,n){const o={x:t.x+t.width/2,y:t.y+t.height/2},i=t.width/2;switch(e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.setLineDash([]),e.lineWidth=yn,e.lineCap="round",e.lineJoin="round",e.save(),e.translate(o.x,o.y),t.type){case Kt:{const s=-Math.PI/4;e.beginPath(),e.arc(0,0,i,s,-s),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+s,Math.PI-s),e.stroke();const a=i*.25,r=i*Math.cos(s),c=i*Math.sin(s);e.save(),e.translate(r,c),e.rotate(s-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+s),d=i*Math.sin(Math.PI+s);e.save(),e.translate(l,d),e.rotate(s+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();break}case Rn:{const s=i*.8,a=i*.25;e.beginPath(),e.moveTo(-s,0),e.lineTo(s,0),e.moveTo(0,-s),e.lineTo(0,s),e.stroke(),[{x:s,y:0,dirX:1,dirY:0},{x:-s,y:0,dirX:-1,dirY:0},{x:0,y:-s,dirX:0,dirY:-1},{x:0,y:s,dirX:0,dirY:1}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}case sn:{const s=-Math.PI/4;e.beginPath(),e.arc(0,0,i,s,-s),e.stroke(),e.beginPath(),e.arc(0,0,i,Math.PI+s,Math.PI-s),e.stroke();let a=i*.25;const r=i*Math.cos(s),c=i*Math.sin(s);e.save(),e.translate(r,c),e.rotate(s-Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const l=i*Math.cos(Math.PI+s),d=i*Math.sin(Math.PI+s);e.save(),e.translate(l,d),e.rotate(s+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-a,-a*.5),e.moveTo(0,0),e.lineTo(-a,a*.5),e.stroke(),e.restore();const h=i*.8;a=i*.25,e.beginPath(),e.moveTo(-h,0),e.lineTo(h,0),e.moveTo(0,-h),e.lineTo(0,h),e.stroke(),[{x:h,y:0,dirX:1,dirY:0},{x:-h,y:0,dirX:-1,dirY:0},{x:0,y:-h,dirX:0,dirY:-1},{x:0,y:h,dirX:0,dirY:1}].forEach(u=>{e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a+u.dirY*a*.5,u.y-u.dirY*a-u.dirX*a*.5),e.moveTo(u.x,u.y),e.lineTo(u.x-u.dirX*a-u.dirY*a*.5,u.y-u.dirY*a+u.dirX*a*.5),e.stroke()});break}case Jn:{const s=i*.8,a=i*.25;e.beginPath(),e.moveTo(-s/Math.sqrt(2),-s/Math.sqrt(2)),e.lineTo(s/Math.sqrt(2),s/Math.sqrt(2)),e.moveTo(s/Math.sqrt(2),-s/Math.sqrt(2)),e.lineTo(-s/Math.sqrt(2),s/Math.sqrt(2)),e.stroke(),[{x:s/Math.sqrt(2),y:-s/Math.sqrt(2),dirX:1/Math.sqrt(2),dirY:-1/Math.sqrt(2)},{x:-s/Math.sqrt(2),y:s/Math.sqrt(2),dirX:-1/Math.sqrt(2),dirY:1/Math.sqrt(2)}].forEach(c=>{e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a+c.dirY*a*.5,c.y-c.dirY*a-c.dirX*a*.5),e.moveTo(c.x,c.y),e.lineTo(c.x-c.dirX*a-c.dirY*a*.5,c.y-c.dirY*a+c.dirX*a*.5),e.stroke()});break}}e.restore()}function uh(e,t,n){const o=t.x+t.width/2,i=t.y+t.height/2,s=t.width*.6,a=t.height*.3;e.save(),e.strokeStyle=n.uiIcon,e.fillStyle=n.uiIcon,e.lineWidth=yn,e.lineCap="round",e.beginPath(),e.ellipse(o,i,s/2,a/2,0,0,2*Math.PI),e.stroke();const r=a*.3;e.beginPath(),e.arc(o,i,r,0,2*Math.PI),e.fill(),e.restore()}function ph(e,t,n,o){const{canvasUI:i,colors:s,allColors:a,namedColors:r,colorAssignments:c,activeColorTargets:l,verticesVisible:d,edgesVisible:h,facesVisible:f,isDraggingColorTarget:u,draggedColorTargetInfo:g,mousePos:p}=n,y=s.checkerboardColor1,x=s.checkerboardColor2;function m(C){const w=C.height/3,_=Math.ceil(C.width/w);for(let T=0;T<3;T++)for(let v=0;v<_;v++){e.fillStyle=(T+v)%2===0?y:x;const E=C.x+v*w,O=C.y+T*w,P=Math.min(w,C.x+C.width-E),D=Math.min(w,C.y+C.height-O);P>0&&D>0&&e.fillRect(E,O,P,D)}}const S=i.randomColorButton;if(S){e.fillStyle="#000000",e.fillRect(S.x,S.y,S.width,S.height),e.strokeStyle=s.uiDefault,e.lineWidth=os,e.strokeRect(S.x,S.y,S.width,S.height);const C=S.x+S.width/2,w=S.y+S.height/2,_=S.width*.35,T=8;for(let v=0;v<T;v++){const E=v/T*2*Math.PI,O=(v+1)/T*2*Math.PI,P=v/T*360;e.fillStyle=`hsl(${P}, 70%, 60%)`,e.beginPath(),e.moveTo(C,w),e.arc(C,w,_,E,O),e.closePath(),e.fill()}e.fillStyle=s.background,e.beginPath(),e.arc(C,w,_*.4,0,2*Math.PI),e.fill()}const I=i.removeColorButton;I&&(e.strokeStyle=s.uiDefault,e.lineWidth=os,e.strokeRect(I.x,I.y,I.width,I.height),e.beginPath(),e.moveTo(I.x+Ht,I.y+I.height/2),e.lineTo(I.x+I.width-Ht,I.y+I.height/2),e.stroke()),i.colorSwatches.forEach(C=>{const w=C.item;let _=!1;if(w&&w.type==="color"){const T=Ws(w.value);T&&T.a<1&&(_=!0)}else w&&w.type==="colormap"&&w.vertices.some(T=>T.alpha!==void 0&&T.alpha<1)&&(_=!0);if(_&&m(C),w&&w.type==="colormap"){const T=e.createLinearGradient(C.x,C.y,C.x+C.width,C.y);w.vertices.forEach(v=>{let E=v.color;typeof E=="string"&&(E=r[E]||[0,0,0]),T.addColorStop(v.pos,`rgba(${E.join(",")},${v.alpha||1})`)}),e.fillStyle=T}else w&&(e.fillStyle=w.value);e.fillRect(C.x,C.y,C.width,C.height)});const b=i.addColorButton;if(b&&(e.strokeStyle=s.uiDefault,e.lineWidth=os,e.strokeRect(b.x,b.y,b.width,b.height),e.beginPath(),e.moveTo(b.x+b.width/2,b.y+Ht),e.lineTo(b.x+b.width/2,b.y+b.height-Ht),e.moveTo(b.x+Ht,b.y+b.height/2),e.lineTo(b.x+b.width-Ht,b.y+b.height/2),e.stroke()),i.colorTargetIcons){const C=T=>{let v=c[T];return u&&g&&g.target===T&&g.previewColorIndex!==void 0&&(v=g.previewColorIndex),v},w=T=>{let v=C(T);const E=v===-1?null:a[v],O={};if(T===_e)O.vertexState=d?"filled":"disabled",v===-1?O.vertexColor=As:E&&E.type==="color"?O.vertexColor=E.value:E&&E.type==="colormap"&&(O.vertexColormapItem=E);else if(T===Re)O.edgeState=h?"solid":"disabled",v===-1?O.edgeColor=As:E&&E.type==="color"?O.edgeColor=E.value:E&&E.type==="colormap"&&(O.edgeColormapItem=E);else if(T===we)O.faceState=f?"filled":"disabled",v===-1?O.faceColor=As:E&&E.type==="color"?O.faceColor=E.value:E&&E.type==="colormap"&&(O.faceColormapItem=E);else if(T===It){v===-1?O.textColor=As:E&&E.type==="color"?O.textColor=E.value:E&&E.type==="colormap"&&(O.textColor=Ae(E,.5));const P=C(we);if(P===v){const D=P===-1?null:a[P];D?D.type==="color"?O.faceColorForContrast=D.value:D.type==="colormap"&&(O.faceColorForContrast=Ae(D,.5)):O.faceColorForContrast=As}}return O};[we,Re,_e,It].forEach(T=>{const v=i.colorTargetIcons.find(E=>E.target===T);if(v){const E=l.includes(T),O=w(T);if(u&&g&&g.target===we&&T===we){const P=i.colorSwatches.find(D=>p.x>=D.x&&p.x<=D.x+D.width&&p.y>=D.y&&p.y<=D.y+D.height);if(P&&P.item.type==="colormap"){const D=Md((p.x-P.x)/P.width,0,1);O.faceColor=Ae(P.item,D),O.faceState="filled"}}T===It?Ih(e,v,O,s,E):yo(e,v,O,s,E)}})}const M=new Set;l.forEach(C=>{let w=c[C];if(u&&g&&g.target===C&&g.previewColorIndex!==void 0&&(w=g.previewColorIndex),w===-1||M.has(w))return;const _=i.colorSwatches.find(T=>T.index===w);if(_){const T=Object.keys(c).filter(E=>{let O=c[E];return u&&g&&g.target===E&&g.previewColorIndex!==void 0&&(O=g.previewColorIndex),O===_.index&&l.includes(E)}),v=i.colorTargetIcons.filter(E=>T.includes(E.target));if(v.length>0){const E=Math.min(...v.map(B=>B.y));e.strokeStyle=s.selectionGlow,e.lineWidth=os;const O=2,P=_.x-O,D=E-O,F=_.width+O*2,R=_.y+_.height-D+O;e.strokeRect(P,D,F,R),M.add(w)}}})}function gh(e,t,n,o){const{canvasUI:i,colors:s,edgeColorMode:a,faceColorMode:r,edgeColorExpression:c,faceColorExpression:l,faceColorPolarExpression:d}=n,h=i.colorModeIcons||[];if(!h.length)return;const f=()=>allColors&&allColors.find(p=>p&&p.type==="colormap")||null;h.forEach(p=>{e.save(),e.strokeStyle=s.uiDefault,e.lineWidth=Ns,e.strokeRect(p.x,p.y,p.width,p.height),e.strokeStyle=s.uiIcon,e.fillStyle=s.uiIcon,e.lineWidth=yn;const y={vertexState:"none",edgeState:"none",faceState:"none",faceColor:s.uiIcon,edgeColor:s.uiIcon,vertexColor:s.uiIcon};if(p.group==="edge"){const x={...y,edgeState:"solid"};a==="inherit_vertices"&&(x.vertexState="solid"),a==="colormap"&&(x.edgeColormapItem=f()),yo(e,p,x,s,!1)}else if(p.group==="face"){const x={...y,faceState:"filled"};r==="inherit_vertices"&&(x.vertexState="solid"),r==="inherit_edges"&&(x.edgeState="solid"),(r==="colormap_xy"||r==="colormap_polar")&&(x.faceColormapItem=f()),yo(e,p,x,s,!1)}e.restore()});const u=h.find(p=>p.group==="edge"),g=h.find(p=>p.group==="face");a==="colormap"&&u&&o({id:"edge-color-mode-label",content:`c(${c||"x"}) =`,x:u.x+u.width+12,y:u.y+u.height/2,color:s.uiTextDefault,fontSize:fo,options:{textAlign:"left",textBaseline:"middle"}},t),(r==="colormap_xy"||r==="colormap_polar")&&g&&o({id:"face-color-mode-label",content:`${r==="colormap_polar"?"c(r,\\phi) =":"c(x,y) ="}`,x:g.x+g.width+12,y:g.y+g.height/2,color:s.uiTextDefault,fontSize:fo,options:{textAlign:"left",textBaseline:"middle"}},t)}function yh(e,t,n,o){const i=(n?.vertices||[]).filter(C=>C&&C.type==="regular");if(!i.length){e.save(),e.fillStyle=o.uiIconDefault,e.beginPath(),e.arc(t.x+t.width/2,t.y+t.height/2,t.width*.08,0,2*Math.PI),e.fill(),e.restore();return}let s=1/0,a=1/0,r=-1/0,c=-1/0;i.forEach(C=>{C.x<s&&(s=C.x),C.y<a&&(a=C.y),C.x>r&&(r=C.x),C.y>c&&(c=C.y)});const l=3,d=Math.max(t.width-l*2,1),h=Math.max(t.height-l*2,1),f=Math.max(r-s,1e-6),u=Math.max(c-a,1e-6),g=Math.min(d/f,h/u),p=(s+r)/2,y=(a+c)/2,x=t.x+t.width/2,m=t.y+t.height/2,S=C=>({x:x+(C.x-p)*g,y:m+(C.y-y)*g}),I=n?.edges||[],b=n?.faces||[],M=new Map(i.map(C=>[C.id,C]));e.save(),e.lineWidth=1,b.length>0&&(e.fillStyle=o.uiIconDefault,e.globalAlpha=.2,b.forEach(C=>{const w=(C.vertexIds||[]).map(T=>M.get(T)).filter(Boolean);if(w.length<3)return;e.beginPath();const _=S(w[0]);e.moveTo(_.x,_.y);for(let T=1;T<w.length;T++){const v=S(w[T]);e.lineTo(v.x,v.y)}e.closePath(),e.fill()}),e.globalAlpha=1),e.strokeStyle=o.uiIconDefault,I.forEach(C=>{const w=M.get(C.id1),_=M.get(C.id2);if(!w||!_)return;const T=S(w),v=S(_);e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(v.x,v.y),e.stroke()}),e.fillStyle=o.uiIconDefault,i.forEach(C=>{const w=S(C);e.beginPath(),e.arc(w.x,w.y,1.2,0,2*Math.PI),e.fill()}),e.restore()}function mh(e,t){const{canvasUI:n,colors:o,sessions:i,activeSessionIndex:s,selectedSessionIndex:a}=t,r=n.removeSessionButton;r&&(e.strokeStyle=o.uiDefault,e.lineWidth=os,e.strokeRect(r.x,r.y,r.width,r.height),e.beginPath(),e.moveTo(r.x+Ht,r.y+r.height/2),e.lineTo(r.x+r.width-Ht,r.y+r.height/2),e.stroke()),(n.sessionIcons||[]).forEach(l=>{const d=l.index===a,h=l.index===s;e.save(),e.strokeStyle=d?o.selectionGlow:o.uiDefault,e.lineWidth=Ns,e.strokeRect(l.x,l.y,l.width,l.height),h&&!d&&(e.strokeStyle=o.selectionGlow,e.lineWidth=Ns,e.strokeRect(l.x+2,l.y+2,l.width-4,l.height-4)),yh(e,l,l.session?.state,o),e.restore()});const c=n.addSessionButton;c&&(e.strokeStyle=o.uiDefault,e.lineWidth=os,e.strokeRect(c.x,c.y,c.width,c.height),e.beginPath(),e.moveTo(c.x+c.width/2,c.y+Ht),e.lineTo(c.x+c.width/2,c.y+c.height-Ht),e.moveTo(c.x+Ht,c.y+c.height/2),e.lineTo(c.x+c.width-Ht,c.y+c.height/2),e.stroke())}function xh(e,t,{verticesVisible:n,edgesVisible:o,facesVisible:i,colorAssignments:s,allColors:a},r){const c=!n&&!o&&!i,l={vertexState:n||c?"filled":"hidden",edgeState:o||c?"solid":"hidden",faceState:i||c?"filled":"hidden",showAllDisabled:c},d=s[_e];if(d!==-1){const u=a[d];u&&u.type==="colormap"?l.vertexColormapItem=u:u&&u.type==="color"&&(l.vertexColor=u.value)}else l.vertexColor=r.vertex;const h=s[Re];if(h!==-1){const u=a[h];u&&u.type==="colormap"?l.edgeColormapItem=u:u&&u.type==="color"&&(l.edgeColor=u.value)}else l.edgeColor=r.edge;const f=s[we];if(f!==-1){const u=a[f];u&&u.type==="color"?l.faceColor=u.value:u&&u.type==="colormap"&&(l.faceColormapItem=u)}else l.faceColor=r.face;yo(e,t,l,r)}function Sh(e){const t={x:e.x+e.width/2,y:e.y+e.height/2},o=26*(e.width/Qs),i=o*Math.sqrt(3)/2,s=[{x:t.x,y:t.y-i/1.5},{x:t.x-o/2,y:t.y+i/3},{x:t.x+o/2,y:t.y+i/3}],a=new Path2D;a.moveTo(s[0].x,s[0].y),a.lineTo(s[1].x,s[1].y),a.lineTo(s[2].x,s[2].y),a.closePath();const r=Math.min(s[0].x,s[1].x,s[2].x),c=Math.max(s[0].x,s[1].x,s[2].x),l=Math.min(s[0].y,s[1].y,s[2].y),d=Math.max(s[0].y,s[1].y,s[2].y);return{vertices:s,facePath:a,bounds:{x:r,y:l,w:c-r,h:d-l}}}function yo(e,t,n,o,i=!1){const{vertexState:s="none",edgeState:a="none",faceState:r="none",faceColor:c,edgeColor:l,vertexColor:d,faceColormapItem:h,showAllDisabled:f=!1}=n;e.save();const{vertices:u,facePath:g}=Sh(t);if(r==="filled"){if(h&&h.type==="colormap"){const y=e.createLinearGradient(u[1].x,0,u[2].x,0);h.vertices.forEach(x=>{const m=x.color,S=x.alpha!==void 0?x.alpha:1,I=`rgba(${m.join(",")},${S})`;y.addColorStop(x.pos,I)}),e.fillStyle=y}else e.fillStyle=c||o.face;e.fill(g)}else r==="disabled"&&(e.fillStyle=_c,e.fill(g));if(a==="solid"||a==="disabled"){e.lineWidth=yn,e.setLineDash([]);const y=[[u[0],u[1]],[u[1],u[2]],[u[2],u[0]]];y.forEach((x,m)=>{const[S,I]=x;if(n.edgeColormapItem&&n.edgeColormapItem.type==="colormap"&&a==="solid"){const b=e.createLinearGradient(S.x,S.y,I.x,I.y),M=y.length>1?m/(y.length-1):.5,C=Math.max(0,Math.min(1,M)),w=Math.max(0,Math.min(1,M+.3)),_=Ae(n.edgeColormapItem,C),T=Ae(n.edgeColormapItem,w);b.addColorStop(0,_),b.addColorStop(1,T),e.strokeStyle=b}else a==="disabled"?e.strokeStyle="#808080":e.strokeStyle=l||o.edge;e.beginPath(),e.moveTo(S.x,S.y),e.lineTo(I.x,I.y),e.stroke()})}(s==="filled"||s==="disabled")&&(e.lineWidth=yn,u.forEach((y,x)=>{let m=d||o.vertex;if(n.vertexColormapItem&&n.vertexColormapItem.type==="colormap"&&s==="filled"){const I=u.length>1?x/(u.length-1):.5;m=Ae(n.vertexColormapItem,I)}s==="disabled"&&(m="#808080");const S=new Path2D;S.moveTo(y.x+Cn*2,y.y),S.arc(y.x,y.y,Cn*2,0,2*Math.PI),e.fillStyle=m,e.setLineDash([]),e.fill(S)})),f?(e.strokeStyle=o.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()):(s==="disabled"||a==="disabled"||r==="disabled")&&(e.strokeStyle=o.uiIconDisabled,e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(2,2),e.lineTo(30,30),e.stroke()),e.restore()}function Ih(e,t,n,o,i=!1){e.save();const s={x:t.x+t.width/2,y:t.y+t.height/2};e.translate(s.x,s.y);const a=t.width/Qs;e.scale(a,a),e.translate(-16,-16);let r=n.textColor||o.uiTextDefault;if(n.faceColorForContrast){const c=Ws(n.faceColorForContrast);r=(.2126*c.r+.7152*c.g+.0722*c.b)/255>.5?"#000000":"#ffffff"}e.fillStyle=r,e.font="bold 14px KaTeX_Main, Times New Roman, serif",e.textAlign="center",e.textBaseline="middle",e.fillText("A",16,16),e.restore()}function si(e,t,n,o,i,s,a,r,c,l,d,h={}){if(!t||t.length<3)return;e.save(),e.beginPath(),t.forEach((M,C)=>{C===0?e.moveTo(M.x,M.y):e.lineTo(M.x,M.y)}),e.closePath(),l&&n.childFaceIds&&n.childFaceIds.length>0&&n.childFaceIds.forEach(M=>{const C=r.find(w=>w.id===M);if(C){const w=C.vertexIds.map(_=>c(_)).filter(_=>_&&_.type==="regular");if(w.length>=3){const T=(d?Gs(w,d,!0,i):w).map(v=>i(v));e.moveTo(T[0].x,T[0].y),T.slice(1).forEach(v=>{e.lineTo(v.x,v.y)}),e.closePath()}}});const{faceColorMode:f="fixed",edgeColorMode:u="fixed",faceColorExpression:g="x",faceColorPolarExpression:p="r",edgeColorExpression:y="x"}=h,x=n?.vertexIds?n.vertexIds.map(M=>c(M)).filter(Boolean):[],m=M=>M?.color||o.face,S=ct(o.face,{r:255,g:255,b:255,a:1}),I=(M,C)=>{const w=e.createPattern(M,"no-repeat"),_=i(C.origin),T=_n({x:1,y:0},C),v=_n({x:0,y:1},C),E=i(T),O=i(v),P=E.x-_.x,D=E.y-_.y,F=O.x-_.x,R=O.y-_.y,B=M.width,L=B/2,N=P/L,$=D/L,A=F/L,k=R/L,V=_.x-(P+F)*(B/2)/L,X=_.y-(D+R)*(B/2)/L,Y=new DOMMatrix([N,$,A,k,V,X]);return w.setTransform(Y),w},b=(M,C)=>{const _=document.createElement("canvas");_.width=64,_.height=64;const T=_.getContext("2d"),v=T.createImageData(64,64),E=v.data,O=1/63,P=x.filter(L=>L.type==="regular"),D=P.map(L=>Wi(L,C)),F=P.map(L=>ct(m(L),S)),R=[];if(n?.vertexIds&&n.vertexIds.length>1)for(let L=0;L<n.vertexIds.length;L++){const N=n.vertexIds[L],$=n.vertexIds[(L+1)%n.vertexIds.length],A=a?.find(X=>X.id1===N&&X.id2===$||X.id1===$&&X.id2===N)||{id1:N,id2:$},k=c(A.id1),V=c(A.id2);k&&V&&R.push({edge:A,v1:k,v2:V,v1Local:Wi(k,C),v2Local:Wi(V,C)})}const B=(L,N)=>{const{edge:$,v1:A,v2:k}=L;if(u==="inherit_vertices"&&A&&k){const V=ct(m(A),S),X=ct(m(k),S);return{r:St(V.r,X.r,N),g:St(V.g,X.g,N),b:St(V.b,X.b,N),a:St(V.a,X.a,N)}}if(u==="colormap"&&$.colormapItem){const V=Bs(y,{x:N},N),X=Fs(V),Y=Ae($.colormapItem,X);return ct(Y,S)}return ct($.color||o.edge,S)};for(let L=0;L<64;L++)for(let N=0;N<64;N++){const $=N*O*2-1,A=L*O*2-1;let k=S;if(M==="colormap_xy"||M==="colormap_polar")if(n?.colormapItem){let X=.5;if(M==="colormap_xy")X=Bs(g,{x:$,y:A},$);else{const G=Math.hypot($,A),W=Math.atan2(A,$);X=Bs(p,{r:G,phi:W},G)}const Y=Fs(X),H=Ae(n.colormapItem,Y);k=ct(H,S)}else k=S;else if(M==="inherit_vertices"&&D.length>0){const X=D.map(Y=>{const H=$-Y.x,G=A-Y.y,W=Math.hypot(H,G);return 1/Math.max(W,1e-4)});k=Dr(F,X)}else if(M==="inherit_edges"&&R.length>0){const X=R.map(H=>{const G=bt({x:$,y:A},H.v1Local,H.v2Local);return 1/Math.max(G.distance,1e-4)}),Y=R.map((H,G)=>{const W=bt({x:$,y:A},H.v1Local,H.v2Local);return B(H,W.t)});k=Dr(Y,X)}const V=(L*64+N)*4;E[V]=Math.round(k.r),E[V+1]=Math.round(k.g),E[V+2]=Math.round(k.b),E[V+3]=Math.round(Fs(k.a)*255)}return T.putImageData(v,0,0),_};if(f==="fixed")e.fillStyle=n?.color||o.face,e.fill(l?"evenodd":"nonzero");else if(n.localCoordSystem){const M=b(f,n.localCoordSystem),C=I(M,n.localCoordSystem);e.fillStyle=C||n?.color||o.face,e.fill(l?"evenodd":"nonzero")}else n?.colormapItem&&n.localCoordSystem,e.fillStyle=n?.color||o.face,e.fill(l?"evenodd":"nonzero");e.restore()}function bh(e,t,n,o,i,s){const{angleDisplayMode:a,distanceDisplayMode:r,colors:c}=n,l={x:t.x,y:t.y,width:t.width,height:t.height};switch(t.group){case"angles":nl(e,l,a,a!==po,o,i,c);break;case"distances":sl(e,l,r,r===go,o,i,c);break}}function vh(e,t,n,o){const{canvasUI:i,colorAssignments:s,allColors:a,colors:r}=n,c=l=>{if(!s||!a)return r.uiIcon;const d=s[l];if(d===-1)return As;const h=a[d];return h&&h.type==="color"?h.value:r.uiIcon};c(_e),c(Re),c(we),i.visibilityIcons.forEach(l=>{bh(e,l,n,t,o)})}function ol(e,t,n,o){const i={x:t.x+t.width*.22,y:t.y+t.height*.78},s={x:t.x+t.width*.22,y:t.y+t.height*.22},a={x:t.x+t.width*.78,y:t.y+t.height*.22},r=[i,s,a],l=!o||o.type==="linear"?r:Gs(r,o,!1,null),d=(h,f)=>{const u=Math.atan2(f.y-h.y,f.x-h.x),g=t.width*.08,p={x:f.x-Math.cos(u)*g+Math.cos(u+Math.PI/2)*g*.6,y:f.y-Math.sin(u)*g+Math.sin(u+Math.PI/2)*g*.6},y={x:f.x-Math.cos(u)*g+Math.cos(u-Math.PI/2)*g*.6,y:f.y-Math.sin(u)*g+Math.sin(u-Math.PI/2)*g*.6};e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(p.x,p.y),e.lineTo(y.x,y.y),e.closePath(),e.fill()};e.save(),e.strokeStyle=n.uiIcon,e.lineWidth=va,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let h=1;h<l.length;h++)e.lineTo(l[h].x,l[h].y);e.stroke(),e.fillStyle=n.uiIcon,r.forEach(h=>{e.beginPath(),e.arc(h.x,h.y,Cn+.5,0,Math.PI*2),e.fill()}),o?.linearStyle==="arrows"&&(d(i,s),d(s,a)),e.restore()}function Mh(e,t,n,o){const{canvasUI:i,colors:s,activeInterpolationStyleId:a,selectedInterpolationStyleId:r,interpolationStyles:c}=n;i.interpolationIcons.forEach(l=>{const d={x:l.x,y:l.y,width:l.width,height:l.height};if(l.type==="interpolationStyle"){const h=l.styleId===(r||a);e.strokeStyle=s.uiDefault,e.lineWidth=Ns,e.strokeRect(d.x,d.y,d.width,d.height),h&&(e.strokeStyle=s.selectionGlow,e.lineWidth=os,e.strokeRect(d.x-2,d.y-2,d.width+4,d.height+4));const f=c.find(g=>g.id===l.styleId);ol(e,d,s,f);const u=f?.name||"";u&&u.toLowerCase()!=="linear"&&o({id:`interpolation-label-${l.styleId}`,content:u.length>6?`${u.slice(0,6)}...`:u,x:d.x+d.width/2,y:d.y+d.height+10,color:s.uiTextDefault,fontSize:fo,options:{textAlign:"center",textBaseline:"top"}},t)}else l.type==="interpolationRemove"?(e.strokeStyle=s.uiDefault,e.lineWidth=Ns,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.strokeStyle=s.uiIcon,e.lineWidth=va,e.stroke()):l.type==="interpolationAdd"&&(e.strokeStyle=s.uiDefault,e.lineWidth=Ns,e.strokeRect(d.x,d.y,d.width,d.height),e.beginPath(),e.moveTo(d.x+d.width/2,d.y+d.height*.25),e.lineTo(d.x+d.width/2,d.y+d.height*.75),e.moveTo(d.x+d.width*.25,d.y+d.height/2),e.lineTo(d.x+d.width*.75,d.y+d.height/2),e.stroke())})}function Ch(e,t,n,o){const{canvasUI:i,colors:s,activeThemeName:a,colorAssignments:r,allColors:c,verticesVisible:l,edgesVisible:d,facesVisible:h}=n,f=i.toolbarButton;e.strokeStyle=s.uiDefault,e.lineWidth=Yr,e.beginPath();for(let b=0;b<3;b++){const M=f.y+5+b*10;e.moveTo(f.x+4,M),e.lineTo(f.x+f.width-4,M)}e.stroke();const u=i.colorToolButton;u&&xh(e,u,{verticesVisible:l,edgesVisible:d,facesVisible:h,colorAssignments:r,allColors:c},s);const g=i.colorModeToolButton;if(g){const b=g,M={x:b.x+3,y:b.y+2,width:b.width-8,height:b.height-8},C={x:b.x+6,y:b.y+6,width:b.width-10,height:b.height-10};(_=>{const T={x:_.x+_.width/2,y:_.y+_.height/2},v=_.width*.85,E=v*Math.sqrt(3)/2,O=[{x:T.x,y:T.y-E/1.5},{x:T.x-v/2,y:T.y+E/3},{x:T.x+v/2,y:T.y+E/3}],P=[[O[0],O[1]],[O[1],O[2]],[O[2],O[0]]],D=["rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)"];P.forEach((F,R)=>{e.strokeStyle=D[R],e.lineWidth=2,e.beginPath(),e.moveTo(F[0].x,F[0].y),e.lineTo(F[1].x,F[1].y),e.stroke()})})(M),e.fillStyle="#ffffff",yo(e,C,{edgeState:"none",faceState:"filled",vertexState:"none",faceColor:"#ffffff"},s)}const p=i.transformToolButton;p&&o({id:"transform-tool-label",content:Nc,x:p.x+p.width/2,y:p.y+p.height/2,color:s.uiIcon,fontSize:Oc,options:{textAlign:"center",textBaseline:"middle"}},t);const y=i.interpolationToolButton;y&&ol(e,y,s);const x=i.displayToolButton;if(x){e.strokeStyle=s.uiDefault,e.fillStyle=s.uiDefault,e.lineWidth=va;const b=x.width-Fc;for(let M=0;M<3;M++){const C=x.y+$c+M*Vc;e.beginPath(),e.moveTo(x.x+6,C),e.lineTo(x.x+6+b,C),e.stroke(),e.beginPath(),e.arc(x.x+6+b*(M/2),C,Yc,0,2*Math.PI),e.fill()}}const m=i.visibilityToolButton;m&&uh(e,m,s);const S=i.sessionsToolButton;if(S){e.save(),e.strokeStyle=s.uiDefault,e.lineWidth=yn;const b=6,M=Math.min(S.width,S.height)-b*2,C=S.x+b,w=S.y+b;e.strokeRect(C+4,w+2,M,M),e.strokeRect(C,w+6,M,M),e.restore()}const I=i.themeToggleButton;I&&tl(e,I,a,s)}function Eh(e,t){const{canvasUI:n,colors:o}=t;n.transformIcons.forEach(i=>{Ti(e,i,o)})}function wh(e,t,n,o){const{canvasUI:i,colors:s,coordsDisplayMode:a,gridDisplayMode:r,angleDisplayMode:c,distanceDisplayMode:l,activeThemeName:d}=n;i.displayIcons.forEach(h=>{const f={x:h.x,y:h.y,width:h.width,height:h.height};switch(h.group){case"coords":hh(e,f,a,a!==vi,t,o,s);break;case"grid":fh(e,f,r,r!==Io,s);break;case"angles":nl(e,f,c,c!==po,t,o,s);break;case"distances":sl(e,f,l,l===go,t,o,s);break;case"theme":tl(e,f,d,s);break}})}function Th(e,t,n,o){const{dpr:i,isToolbarExpanded:s,isColorPaletteExpanded:a,isColorModePanelExpanded:r,isInterpolationPanelExpanded:c,isTransformPanelExpanded:l,isDisplayPanelExpanded:d,isVisibilityPanelExpanded:h,isSessionsPanelExpanded:f,isPlacingTransform:u,placingTransformType:g,placingSnapPos:p,mousePos:y,colors:x}=n;if(e.save(),e.resetTransform(),e.scale(i,i),s)Ch(e,t,n,o);else{const m=n.canvasUI.toolbarButton;e.strokeStyle=x.uiDefault,e.lineWidth=Yr,e.beginPath();for(let S=0;S<3;S++){const I=m.y+5+S*10;e.moveTo(m.x+4,I),e.lineTo(m.x+m.width-4,I)}e.stroke()}if(a&&ph(e,t,n),r&&gh(e,t,n,o),c&&Mh(e,t,n,o),l&&Eh(e,n),d&&wh(e,t,n,o),h&&vh(e,t,n,o),f&&mh(e,n),u){const m=p||y;if(m){const S=Vi/2,I={type:g,x:m.x-S,y:m.y-S,width:Vi,height:Vi};Ti(e,I,x)}}e.restore()}function kr(e,t,n,o,{showDistances:i,distanceSigFigs:s,colors:a,lastGridState:r,currentShiftPressed:c},l,d,h,f,u=null,g=null,p=null){!i||n.length===0||n.forEach(y=>{const x=o.find(m=>d(m)===y);if(x){let m=l(x.id1),S=l(x.id2);if(u){const I=u.find(M=>M.id===x.id1),b=u.find(M=>M.id===x.id2);I&&(m=I),b&&(S=b)}if(m&&S&&m.type==="regular"&&S.type==="regular"){let I;const b=u&&p;if(x.labelMode==="exact"&&x.exactValue){const[D,F]=ls(x.exactValue.g2gSquaredSum);let R=x.exactValue.gridInterval*D;if(b&&p.transformType!==Kt){const B=p.snappedScaleValue!==null?p.snappedScaleValue:p.scale;R*=B}I=cs(parseFloat(R.toFixed(10)),F)}else I=lt(J(m,S),s);const M=h(m),C=h(S),w=(M.x+C.x)/2,_=(M.y+C.y)/2,T=Math.atan2(C.y-M.y,C.x-M.x);let v=T-Math.PI/2;Math.sin(v)>0&&(v+=Math.PI);const E=w+Math.cos(v)*Fn,O=_+Math.sin(v)*Fn;let P=T*(180/Math.PI);(P>90||P<-90)&&(P+=180),f({id:`selected-edge-dist-${y}`,content:I,x:E,y:O,color:`rgba(${a.feedbackDefault.join(",")}, 1.0)`,fontSize:tn,options:{rotation:P}})}}})}function Ph(e,t,n,o){e.save(),e.strokeStyle=o.mouseCoords,e.lineWidth=jt,e.setLineDash(Mn);const i=Math.min(t.x,n.x),s=Math.min(t.y,n.y),a=Math.abs(t.x-n.x),r=Math.abs(t.y-n.y);e.strokeRect(i,s,a,r),e.restore()}function ro(e,t,n,o,{lastGridState:i,showDistances:s,showAngles:a,distanceSigFigs:r,angleDisplayMode:c,angleSigFigs:l,currentShiftPressed:d,viewTransform:h,colors:f},u,g,p,y=!1,x=null,m=null,S=[],I=!1,b=[],M=null,C=new Map){const w=y?f.feedbackSnapped:`rgba(${f.feedbackDefault.join(",")}, 1.0)`,_=new Map(o.map(N=>[N.id,{...N}])),T=N=>_.get(N),v=T(n);if(!v)return;const E=g(v.id).map(T).filter(Boolean),O=u(v),P=i.alpha2>i.alpha1&&i.interval2?i.interval2:i.interval1,F=(C.get(n)||[]).find(N=>N.type==="projection"&&N.projectionLine);if(F){const[N,$]=F.projectionLine,A=u(N),k=u($),V={x:k.x-A.x,y:k.y-A.y},X=Math.hypot(V.x,V.y);if(X>0){const Y={x:V.x/X,y:V.y/X},H=1e4,G={x:A.x-Y.x*H,y:A.y-Y.y*H},W={x:A.x+Y.x*H,y:A.y+Y.y*H};e.save(),e.strokeStyle=w,e.lineWidth=jt,e.setLineDash(Fr),e.beginPath(),e.moveTo(G.x,G.y),e.lineTo(W.x,W.y),e.stroke(),e.restore()}}const R=(N,$)=>{if(!N||!$||$<=0)return!1;const A=$*1e-6,k=Math.abs(N.x/$-Math.round(N.x/$))<A,V=Math.abs(N.y/$-Math.round(N.y/$))<A;return k&&V},B=E.every(N=>S.includes(N.id)),L=b.find(N=>N.id===n);if(!M&&I&&d&&B&&L&&J(L,v)>re){const N=u(L),$=O,A=Math.atan2($.y-N.y,$.x-N.x),k=Math.atan2(v.y-L.y,v.x-L.x);if(s){let V;const X=P&&R(L,P),Y=P&&R(v,P);if(X&&Y){const me=v.x-L.x,vt=v.y-L.y,Qe=Math.round(me/P),rt=Math.round(vt/P),Xt=Qe*Qe+rt*rt;if(Xt===0)V="0";else{const[Nt,ve]=ls(Xt),Je=P*Nt,Mt=parseFloat(Je.toFixed(10));V=cs(Mt,ve)}}else{const me=r+2;V=lt(J(L,v),me)}const H=(N.x+$.x)/2,G=(N.y+$.y)/2;let W;a&&Math.abs(k)>re?-k<0?W=A-Math.PI/2:W=A+Math.PI/2:(W=A-Math.PI/2,Math.sin(W)>0&&(W+=Math.PI));const Q=H+Math.cos(W)*Fn,te=G+Math.sin(W)*Fn;let pe=A*(180/Math.PI);(pe>90||pe<-90)&&(pe+=180),m({id:`drag-dist-vector-${v.id}`,content:V,x:Q,y:te,color:w,fontSize:tn,options:{rotation:pe}},t)}if(e.save(),e.setLineDash([]),e.strokeStyle=w,e.lineWidth=jt,e.beginPath(),e.moveTo(N.x,N.y),e.lineTo($.x,$.y),e.stroke(),e.restore(),a&&Math.abs(A)>re){Oa(e,N,0,k,Hs,w);let V;if(c===us?V=`${lt(k*(180/Math.PI),l)}^{\\circ}`:V=lt(k,l),V){const X=-k/2,Y=Zo,H={x:Y*Math.cos(X),y:Y*Math.sin(X)},G={x:N.x+H.x,y:N.y+H.y};let W=X*(180/Math.PI);(W>90||W<-90)&&(W+=180),m({id:`drag-angle-vector-${v.id}`,content:V,x:G.x,y:G.y,color:w,fontSize:tn,options:{rotation:W}},t)}}}if(s&&E.forEach(N=>{const $=S.includes(N.id);if(!I||!$){const A=v,k=N,V=p({id1:A.id,id2:k.id});let X;if(P&&R(A,P)&&R(k,P)){const rt=A.x-k.x,Xt=A.y-k.y,Nt=Math.round(rt/P),ve=Math.round(Xt/P),Je=Nt*Nt+ve*ve;if(Je===0)X="0";else{const[Mt,Es]=ls(Je),rn=P*Mt,Jt=parseFloat(rn.toFixed(10));X=cs(Jt,Es)}}else{const rt=J(A,k);X=lt(rt,r)}const H=u(A),G=u(k),W=(H.x+G.x)/2,Q=(H.y+G.y)/2,te=Math.atan2(G.y-H.y,G.x-H.x);let pe=te-Math.PI/2;Math.sin(pe)>0&&(pe+=Math.PI);const me=W+Math.cos(pe)*Fn,vt=Q+Math.sin(pe)*Fn;let Qe=te*(180/Math.PI);(Qe>90||Qe<-90)&&(Qe+=180),m({id:`drag-dist-${V}`,content:X,x:me,y:vt,color:w,fontSize:tn,options:{rotation:Qe}})}}),a&&E.length>=2&&(!I||E.some(N=>!S.includes(N.id)))){const N=[...E].sort(($,A)=>{const k=Math.atan2($.y-v.y,$.x-v.x),V=Math.atan2(A.y-v.y,A.x-v.x);return k-V});for(let $=0;$<N.length;$++){const A=N[$],k=N[($+1)%N.length],V=S.includes(A.id),X=S.includes(k.id);if(!(!I||!V||!X))continue;const H={x:A.x-v.x,y:A.y-v.y},G={x:k.x-v.x,y:k.y-v.y},W=Math.atan2(H.y,H.x),Q=Math.atan2(G.y,G.x);let te=Q-W;if(te<0&&(te+=2*Math.PI),te<re)continue;const pe=W+te/2;e.save(),e.strokeStyle=w,e.lineWidth=jt,e.beginPath(),e.arc(O.x,O.y,Hs,-W,-Q,!1),e.stroke(),e.restore();let me;if(c===us?me=`${lt(te*(180/Math.PI),l)}^{\\circ}`:c===bo&&(d?(me=Ut(te/Math.PI,.015,32)+"\\pi",me.startsWith("1\\pi")&&(me="\\pi"),me.startsWith("-1\\pi")&&(me="-\\pi"),me==="0\\pi"&&(me="0")):me=lt(te,l)),me){const vt=`drag-angle-${v.id}-${A.id}-${k.id}`,Qe={x:v.x+Math.cos(pe),y:v.y+Math.sin(pe)},rt=u(Qe),Xt=Math.atan2(rt.y-O.y,rt.x-O.x),Nt=Zo,ve={x:Nt*Math.cos(Xt),y:Nt*Math.sin(Xt)},Je={x:O.x+ve.x,y:O.y+ve.y};let Mt=Xt*(180/Math.PI);(Mt>90||Mt<-90)&&(Mt+=180),m({id:vt,content:me,x:Je.x,y:Je.y,color:w,fontSize:tn,options:{rotation:Mt}},t)}}}}function _h(e,t,n,o,{showAngles:i,angleSigFigs:s,angleDisplayMode:a,currentShiftPressed:r,distanceSigFigs:c,viewTransform:l,lastGridState:d,colors:h},f,u,g,p,y){!i||n.length===0||n.forEach(x=>{const m=o.find(S=>u(S)===x);if(m){const S=f(m.id1),I=f(m.id2);if(S&&I&&S.type==="regular"&&I.type==="regular"){const b={lastGridState:d,showDistances:!1,showAngles:!0,distanceSigFigs:c,angleDisplayMode:a,angleSigFigs:s,currentShiftPressed:r,viewTransform:l,colors:h};ro(e,t,S.id,[S,I],b,g,p,u,!1,null,y),ro(e,t,I.id,[S,I],b,g,p,u,!1,null,y)}}})}function il(e,{allFaces:t,selectedFaceIds:n,colors:o,isDragConfirmed:i,dragPreviewVertices:s,initialDragVertexStates:a,transformIndicatorData:r,highlightedEdgeForSnap:c,draggedFaceId:l,coordSystemSnapAngle:d,coordSystemSnapType:h,coordSystemSnapScale:f,initialCoordSystemStates:u},g,p){if(n.length>Uc)return;const y=new Set(n);y.size!==0&&y.forEach(x=>{const m=t.find(I=>I.id===x);if(!m||!m.localCoordSystem)return;let S=m.localCoordSystem;if(i&&m.vertexIds.some(I=>s.some(b=>b.id===I))){const I=u.get(m.id);S=$d(m,{initialSystem:I,dragPreviewVertices:s,initialDragVertexStates:a,findVertexById:p,transformIndicatorData:r})}if(l===x&&d!==null){const I=M=>{if(i&&s){const C=s.find(w=>w&&w.id===M);if(C)return C}return p(M)},b=g(S.origin);if(h==="edge"&&c!==null){const M=m.vertexIds.map(C=>I(C)).filter(C=>C&&C.type==="regular");if(c<M.length){const C=M[c],w=M[(c+1)%M.length],_=g(C),T=g(w);e.save(),e.strokeStyle=o.feedbackSnapped,e.lineWidth=3,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(T.x,T.y),e.stroke(),e.restore()}}else if(h==="cardinal"){const C=b.x+Math.cos(-d)*100,w=b.y+Math.sin(-d)*100,_=b.x-Math.cos(-d)*100,T=b.y-Math.sin(-d)*100;e.save(),e.strokeStyle=o.feedbackSnapped,e.lineWidth=2,e.setLineDash([8,4]),e.beginPath(),e.moveTo(_,T),e.lineTo(C,w),e.stroke(),e.restore()}}Ah(e,S,o,g,f)})}function Ah(e,t,n,o,i=null){const s=o(t.origin),a=_n({x:1,y:0},t),r=_n({x:0,y:1},t),c=o(a),l=o(r);e.save(),e.lineWidth=Hn,e.lineCap="round";const d=(u,g,p,y)=>{e.strokeStyle=p,e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(g.x,g.y),e.stroke(),e.fillStyle=y;const x=Math.atan2(g.y-u.y,g.x-u.x);e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(g.x-De*Math.cos(x-qt),g.y-De*Math.sin(x-qt)),e.lineTo(g.x-De*Math.cos(x+qt),g.y-De*Math.sin(x+qt)),e.closePath(),e.fill()},h=i!==null?n.feedbackSnapped:n.coordSysX,f=i!==null?n.feedbackSnapped:n.coordSysY;d(s,c,h,h),d(s,l,f,f),e.fillStyle=n.coordSysOrigin,e.beginPath(),e.arc(s.x,s.y,Ac,0,2*Math.PI),e.fill(),e.restore()}const fe=document.getElementById("drawingCanvas"),Me=fe.getContext("2d",{willReadFrequently:!0}),tt=document.getElementById("html-overlay"),Ve=window.devicePixelRatio||1,mo=new Map,Na=18,Fo=8,qi={x:12,y:-12},Dh={x:8,y:-8};let as={activeId:null,inputEl:null};const An={id:"linear",name:"Linear",type:"linear",cornerHandling:"pass_through",tension:0,radiusMode:"relative",radiusValue:.25},Ba="platonic-play",oi=1,Ui=`${Ba}.user-id`;let Zt=null,$o=null,al=!1,Nn,ks,fn=[JSON.parse(JSON.stringify(An))],vo=An.id;const z={toolbarButton:null,mainToolbar:null,colorToolButton:null,colorSwatches:[],addColorButton:null,colorModeToolButton:null,colorModeIcons:[],colorModePanelBounds:null,interpolationToolButton:null,interpolationIcons:[],transformToolButton:null,transformIcons:[],displayToolButton:null,displayIcons:[],themeToggleButton:null,symmetryToolButton:null,symmetryIcons:[],sessionsToolButton:null,sessionIcons:[],addSessionButton:null,removeSessionButton:null,sessionsPanelBounds:null};let ht,Rs=null,Ls=null,Dt=null,ra=[],ii=null,ys=new Map,dn=null,vn=null,Us=null,Mo=null,ms=null,Sn=null,$s=!1,wt=null,Ce=[],kt=null,Wn=null,dt=null,Dn=null,xo=!1,Co=null,hn=!1,Fa=!1,Qt=!1,pt=!1,en=!1,xs="regular",st="lines",nn="degrees",zo="on",ai=!0,ri=!0,kn=!0,un=null,En=null,pn=null,li=!1,Vs=!1,ae=[],U=[],Z=[],qe=[],Ss=new Map,gt=new Map,le=[],ie=[],se=[],ye=[],Ye=null,K={x:0,y:0},qn=null,rs=!1,ot=!1,ci=!1,lo=null,In=!1,Vt=!1,js=null,Ze=[],Gt=0,On=!0,xn=!0,Ke=null,Ho=4,Qn=3,kh=.5,Xe=null,Bt=!1,Ne=!1,ds=!1,Un=!1,gn=-1,Wt={x:0,y:0},ji={x:0,y:0},ce=[],rl={x:0,y:0},ee=null,ue=bi,Ue=!1,it=null,di=null,Se=[],Os=[],la=[],ke=!1,Tt={vertices:[],edges:[],faces:[],texts:[],referenceVertex:null},de={targetId:null,type:null,count:0,timestamp:0},Vo={id:null,timestamp:0},ft=[],Te=[],$t=0,yt=0,co=null,hi=[],At="fixed",Oe="fixed",wn="x",Vn="x",Yn="r",mn=null,Ln=null,_t=!1,ln=null;function Rh(){const e=Array.prototype.pop,t=Array.prototype.push,n=Array.prototype.shift,o=Array.prototype.splice;ft.pop=function(){return e.call(this)},ft.push=function(...i){return t.call(this,...i)},ft.shift=function(){return n.call(this)},ft.splice=function(...i){return o.call(this,...i)}}let ca=!1,Xn=[],Be=null,Ie=[],Rt="",Ft=null,Is=[],Go=0,j={interval1:null,interval2:null,alpha1:0,alpha2:0,scale:null},oe={scale:Pc,offsetX:0,offsetY:0},on={angle1:30,angle2:15,alpha1:1,alpha2:0},$a=new Set,fi="dark",ze=[],hs=!1,Pt=null,ho=!1,Wo=null,he={[_e]:0,[Re]:1,[we]:2,[It]:0},jn=!1,an=null,ui=null,Ys=new Set,es=!1;function Ms(){Td(Z,q)}function Va(){return Cd(fi,nc)}function Pe(e,t=0,n=1){let o=he[e];(o<0||o>=ue.length)&&(o=0);const i=ue[o];if(i?.type==="color")return i.value;if(i?.type==="colormap"){const a=n>1?t/(n-1):.5;return Ae(i,a)}const s=Va();return e===_e?s.vertex:e===Re?s.edge:e===we?s.face:e===It?s.uiTextDefault||s.geometryInfoText:s.vertex}function Pi(){At==="inherit_vertices"&&(he[Re]=he[_e]),Oe==="inherit_vertices"?he[we]=he[_e]:Oe==="inherit_edges"&&(he[we]=he[Re])}function ll(e){if(e===Re&&At==="inherit_vertices")return _e;if(e===we){if(Oe==="inherit_vertices")return _e;if(Oe==="inherit_edges")return Re}return e}function pi(e){const t=[];return e===_e&&(At==="inherit_vertices"&&t.push(Re),Oe==="inherit_vertices"&&t.push(we)),e===Re&&Oe==="inherit_edges"&&t.push(we),t}function cl(){if(At==="fixed"){const e=Pe(Re);U.forEach(t=>{t.color=t.color||e,delete t.colormapItem,delete t.gradientStart,delete t.gradientEnd})}if(Oe==="fixed"){const e=Pe(we);Z.forEach(t=>{t.color=t.color||e,delete t.colormapItem,delete t.colormapDistribution})}if(Oe.startsWith("colormap")){const e=he[we],t=ue[e];t&&t.type==="colormap"&&Z.forEach(n=>{n.colormapItem=n.colormapItem||t,n.colormapDistribution="x"})}}function Ya(){ze.forEach(e=>{const t=he[e];if(e===_e){const n=ue[t];if(n&&n.type==="colormap"){const o=le.map(i=>q(i)).filter(i=>i&&i.type==="regular");o.forEach((i,s)=>{const a=o.length>1?s/(o.length-1):.5;i.color=Ae(n,a)})}else le.forEach(o=>{const i=q(o);i&&i.type==="regular"&&(i.color=Pe(_e))})}else if(e===Re){const n=ue[t];if(At==="colormap"&&n&&n.type==="colormap")ie.forEach((o,i)=>{const s=U.find(a=>ne(a)===o);if(s){const a=ie.length,r=a>1?i/a:0,c=a>1?(i+1)/a:1;s.gradientStart=r,s.gradientEnd=c,s.colormapItem=n,delete s.color}});else{const o=n&&n.type==="colormap"?Ae(n,.5):Pe(Re);U.forEach(i=>{ie.includes(ne(i))&&(i.color=o,delete i.gradientStart,delete i.gradientEnd,delete i.colormapItem)})}}else if(e===we){const n=he[e];if(Oe==="inherit_vertices"||Oe==="inherit_edges")return;if(n===-1){const o=Pe(we);Z.forEach(i=>{se.includes(ge(i))&&(i.color=o,delete i.colormapItem,delete i.colormapDistribution)})}else{const o=ue[n];if(Oe.startsWith("colormap")&&o&&o.type==="colormap")Z.forEach(i=>{se.includes(ge(i))&&(i.colormapItem=o,i.colormapDistribution="x",delete i.color)});else{const i=o&&o.type==="colormap"?Ae(o,.5):Pe(we);Z.forEach(s=>{se.includes(ge(s))&&(s.color=i,delete s.colormapItem,delete s.colormapDistribution)})}}}else if(e===It){const n=ue[t];if(n&&n.type==="colormap")ye.forEach((o,i)=>{const s=So(o);if(!s)return;const a=ye.length>1?i/(ye.length-1):.5;s.color=Ae(n,a)});else{const o=Pe(It);ye.forEach(i=>{const s=So(i);s&&(s.color=o)})}}})}function xt({id:e,content:t,x:n,y:o,color:i,fontSize:s,options:a={}}){$a.add(e);let r=mo.get(e);if(r){if(!r.contentEl||!r.katexEl){const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const g=document.createElement("div");g.style.display="inline-block",g.style.whiteSpace="nowrap",g.style.lineHeight="1",u.appendChild(g),r.textContent="",r.appendChild(u),r.contentEl=u,r.katexEl=g,r.katexContent=null,r.style.pointerEvents="none"}}else{r=document.createElement("div"),r.style.position="absolute",r.style.fontFamily="KaTeX_Main, Times New Roman, serif",r.style.whiteSpace="nowrap",r.style.lineHeight="1",r.style.display="inline-block",r.style.padding="0",r.style.pointerEvents="none";const u=document.createElement("div");u.style.display="inline-block",u.style.position="relative",u.style.overflow="visible";const g=document.createElement("div");g.style.display="inline-block",g.style.whiteSpace="nowrap",g.style.lineHeight="1",u.appendChild(g),r.appendChild(u),r.contentEl=u,r.katexEl=g,tt.appendChild(r),mo.set(e,r)}let c="-50%",l="-50%",d="center";switch(a.textAlign){case"left":c="0%";break;case"right":c="-100%";break}switch(a.textBaseline){case"top":l="0%";break;case"bottom":l="-100%";break}a.textAlign==="left"&&a.textBaseline==="top"?d="top left":a.textAlign==="right"&&a.textBaseline==="top"?d="top right":a.textAlign==="left"&&a.textBaseline==="bottom"?d="bottom left":a.textAlign==="right"&&a.textBaseline==="bottom"&&(d="bottom right"),r.style.left=`${n}px`,r.style.top=`${o}px`,r.style.transformOrigin=d,r.style.transform=`translate(${c}, ${l}) rotate(${a.rotation||0}deg)`,r.style.color=i,r.style.fontSize=`${s}px`;const h=t==null?"":String(t),f=tc(h);if(r.katexContent!==f){const u=r.katexEl||r.contentEl||r;ec(u,f),r.katexContent=f}}function Rr(e,{placeholder:t,onChange:n}){if(e)return e;const o=document.createElement("input");return o.type="text",o.placeholder=t,o.style.position="absolute",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize="12px",o.style.padding="2px 4px",o.style.borderRadius="4px",o.style.border="1px solid rgba(0,0,0,0.3)",o.style.background="rgba(255,255,255,0.9)",o.style.color="#111111",o.style.width="70px",o.style.display="none",o.style.pointerEvents="auto",o.addEventListener("input",()=>{n&&n(o.value)}),tt.appendChild(o),o}function Lh(e){const t=e.match(/[A-Za-z_][A-Za-z0-9_]*/g);return t||[]}function Lr(e,t){const n=(e||"").trim();return n?Lh(n).every(i=>t.includes(i)):!0}function Oh(){if(mn=Rr(mn,{placeholder:"x",onChange:e=>{const t=e.trim();if(!Lr(t,["x"])){mn.value=wn||"x";return}wn=t||"x",Yt()}}),Ln=Rr(Ln,{placeholder:"x",onChange:e=>{const t=e.trim();if(!Lr(t,Oe==="colormap_polar"?["r","phi"]:["x","y"])){const o=Oe==="colormap_polar"?Yn||"r":Vn||"x";Ln.value=o;return}Oe==="colormap_polar"?Yn=t||"r":Vn=t||"x",Yt()}}),mn.style.display="none",Ln.style.display="none",!(!en||!z.colorModeIcons.length)){if(At==="colormap"){const e=z.colorModeIcons.find(n=>n.group==="edge"),t=z.colorModeIcons.find(n=>n.group==="face");if(e){mn.value=wn||"x";const n=t?t.x-(e.x+e.width):160,o=e.x+e.width+60;mn.style.left=`${o}px`,mn.style.top=`${e.y+e.height/2-10}px`,mn.style.width=`${Math.max(60,n-70)}px`,mn.style.display="block"}}if(Oe==="colormap_xy"||Oe==="colormap_polar"){const e=z.colorModeIcons.find(t=>t.group==="face");if(e){const t=Oe==="colormap_polar"?Yn:Vn;Ln.value=t||(Oe==="colormap_polar"?"r":"x"),Ln.style.left=`${e.x+e.width+60}px`,Ln.style.top=`${e.y+e.height/2-10}px`,Ln.style.display="block"}}}}function Nh(e,t,n){const o=Ws(e),i=Ws(t),s=Math.max(0,Math.min(1,n)),a=Math.round(o.r*(1-s)+i.r*s),r=Math.round(o.g*(1-s)+i.g*s),c=Math.round(o.b*(1-s)+i.b*s),l=o.a;return`rgba(${a}, ${r}, ${c}, ${l})`}function Bh(){for(const[e,t]of mo.entries())$a.has(e)||(t.remove(),mo.delete(e))}function Xs(e){return{x:e.x*Ve/oe.scale,y:-e.y*Ve/oe.scale}}function So(e){return qe.find(t=>t.id===e)}function Xa(e,t,n,o=null){if(!e||!t||!n)return null;const i={x:n.x-t.x,y:n.y-t.y},s=Math.hypot(i.x,i.y);if(s<1e-6)return null;let a={x:-i.y/s,y:i.x/s};if(o&&o.length>=3){const r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},c=o.reduce((h,f)=>({x:h.x+f.x,y:h.y+f.y}),{x:0,y:0});c.x/=o.length,c.y/=o.length;const l={x:c.x-r.x,y:c.y-r.y};a.x*l.x+a.y*l.y>0&&(a={x:-a.x,y:-a.y})}return{normalData:a,edgeLen:s}}function dl(e){const t=U.find(l=>ne(l)===e);if(!t)return Xs(Fo);const n=q(t.id1),o=q(t.id2);if(!n||!o)return Xs(Fo);const i=Z.filter(l=>{const d=l.vertexIds||[];for(let h=0;h<d.length;h++){const f=d[h],u=d[(h+1)%d.length];if(f===t.id1&&u===t.id2||f===t.id2&&u===t.id1)return!0}return!1});let s=null;i.length===1&&(s=(i[0].vertexIds||[]).map(d=>q(d)).filter(Boolean));const a=Xa(t,n,o,s);if(!a)return Xs(Fo);const r=a.normalData,c=Fo*Ve/oe.scale;return{x:r.x*c,y:r.y*c}}function da(e,t){const n=U.find(l=>ne(l)===e);if(!n||!t)return null;const o=q(n.id1),i=q(n.id2);if(!o||!i)return null;const s=Xa(n,o,i);if(!s)return null;const{normalData:a,edgeLen:r}=s;return r<1e-6?null:(t.x*a.x+t.y*a.y)/r}function ha(e){const t=q(e);if(!t)return{offset:Xs(qi),align:"left",baseline:"middle"};const o=cn(e,U).map(f=>q(f)).filter(Boolean);let i={x:1,y:0};if(o.length===2){const f={x:o[0].x-t.x,y:o[0].y-t.y},u={x:o[1].x-t.x,y:o[1].y-t.y},g=Math.hypot(f.x,f.y),p=Math.hypot(u.x,u.y);if(g>1e-6&&p>1e-6){const y={x:f.x/g,y:f.y/g},x={x:u.x/p,y:u.y/p},m={x:y.x+x.x,y:y.y+x.y},S=Math.hypot(m.x,m.y);S>1e-6?i={x:-m.x/S,y:-m.y/S}:i={x:-y.y,y:y.x}}}const s=xe(t),a=xe({x:t.x+i.x,y:t.y+i.y});let r={x:a.x-s.x,y:a.y-s.y};const c=Math.hypot(r.x,r.y);c>1e-6?(r.x/=c,r.y/=c):r={x:1,y:0};const l=Math.hypot(qi.x,qi.y),d={x:r.x*l,y:r.y*l},h=r.x>=0?"left":"right";return{offset:Xs(d),align:h,baseline:"middle"}}function gi(e){return fn.find(t=>t.id===e)||null}function yi(){return gi(vo)||fn[0]||An}function fa(e){e&&(vo=e,Yt())}function Fh(){const e=new Set(ie),t=new Set(se),n=new Set(le),o=new Set,i=s=>{const a=s||An.id;o.add(a)};return e.size>0&&U.forEach(s=>{const a=ne(s);e.has(a)&&i(s.interpolationStyleId)}),t.size>0&&Z.forEach(s=>{const a=ge(s);a&&t.has(a)&&i(s.interpolationStyleId)}),e.size===0&&t.size===0&&n.size>0&&(U.forEach(s=>{(n.has(s.id1)||n.has(s.id2))&&i(s.interpolationStyleId)}),Z.forEach(s=>{s.vertexIds&&s.vertexIds.some(a=>n.has(a))&&i(s.interpolationStyleId)})),o.size===1?[...o][0]:null}function $h(e){if(!e)return;const t=new Set(ie),n=new Set(se),o=new Set(le);let i=!1;t.size>0&&U.forEach(s=>{const a=ne(s);t.has(a)&&(s.interpolationStyleId=e,i=!0)}),n.size>0&&Z.forEach(s=>{const a=ge(s);a&&n.has(a)&&(s.interpolationStyleId=e,i=!0)}),t.size===0&&n.size===0&&o.size>0&&(U.forEach(s=>{(o.has(s.id1)||o.has(s.id2))&&(s.interpolationStyleId=e,i=!0)}),Z.forEach(s=>{s.vertexIds&&s.vertexIds.some(a=>o.has(a))&&(s.interpolationStyleId=e,i=!0)})),i&&Yt()}function Vh(){const e=new Set(ie),t=new Set(se),n=new Set(le);let o=!1;e.size>0&&U.forEach(i=>{const s=ne(i);e.has(s)&&(delete i.interpolationStyleId,o=!0)}),t.size>0&&Z.forEach(i=>{const s=ge(i);s&&t.has(s)&&(delete i.interpolationStyleId,o=!0)}),e.size===0&&t.size===0&&n.size>0&&(U.forEach(i=>{(n.has(i.id1)||n.has(i.id2))&&(delete i.interpolationStyleId,o=!0)}),Z.forEach(i=>{i.vertexIds&&i.vertexIds.some(s=>n.has(s))&&(delete i.interpolationStyleId,o=!0)})),o&&Yt()}function bs(e){const t=yi();t&&t.type&&t.type!=="linear"&&(e.interpolationStyleId=t.id)}function hl(e){if(!e)return null;const t=new Map;Ne&&Array.isArray(Se)&&Se.length>0&&Se.forEach(o=>{if(!o||!o.id)return;const i=o.originalId||o.id;t.set(i,o)});const n=o=>t.has(o)?t.get(o):q(o);if(e.anchorType==="canvas")return e.position?{anchor:e.position}:null;if(e.anchorType==="vertex"){const o=n(e.anchorId);return o?{anchor:{x:o.x,y:o.y}}:null}if(e.anchorType==="edge"){const o=U.find(p=>ne(p)===e.anchorId);if(!o)return null;const i=n(o.id1),s=n(o.id2);if(!i||!s)return null;const a={x:(i.x+s.x)/2,y:(i.y+s.y)/2},r=Math.atan2(s.y-i.y,s.x-i.x),c=xe(i),l=xe(s),d=Math.atan2(l.y-c.y,l.x-c.x),h=Z.filter(p=>{const y=p.vertexIds||[];for(let x=0;x<y.length;x++){const m=y[x],S=y[(x+1)%y.length];if(m===o.id1&&S===o.id2||m===o.id2&&S===o.id1)return!0}return!1});let f=null;h.length===1&&(f=(h[0].vertexIds||[]).map(y=>n(y)).filter(Boolean));const u=Xa(o,i,s,f),g=u?u.normalData:null;return{anchor:a,edgeAngleRad:r,edgeAngleRadScreen:d,edgeNormalData:g,edgeLength:u?u.edgeLen:null}}if(e.anchorType==="face"){const o=Z.find(a=>ge(a)===e.anchorId);if(!o)return null;const i=o.vertexIds.map(a=>n(a)).filter(a=>a&&a.type==="regular");return i.length<3?null:{anchor:{x:i.reduce((a,r)=>a+r.x,0)/i.length,y:i.reduce((a,r)=>a+r.y,0)/i.length}}}return null}function fl(){return ee?.finalSnapResult?.finalDelta?ee.finalSnapResult.finalDelta:ee?.textFinalDelta?ee.textFinalDelta:Se.length>0&&ce.length>0?{x:Se[0].x-ce[0].x,y:Se[0].y-ce[0].y}:null}function ul(e){const t=hl(e);if(!t)return null;let n=e.offset||{x:0,y:0};if(e.anchorType==="edge"){if(typeof e.edgeOffsetFactor=="number"&&t.edgeNormalData&&t.edgeLength)n={x:t.edgeNormalData.x*t.edgeLength*e.edgeOffsetFactor,y:t.edgeNormalData.y*t.edgeLength*e.edgeOffsetFactor};else if(!e.offset||!("x"in e.offset)||!("y"in e.offset)){n=dl(e.anchorId);const l=da(e.anchorId,n);typeof l=="number"&&(e.edgeOffsetFactor=l)}}let o={x:t.anchor.x+n.x,y:t.anchor.y+n.y},i=e.rotationDeg||0,s=e.scale||1,a="center",r="middle";if(e.anchorType==="vertex"){const l=ha(e.anchorId);a=e.vertexAlign||l.align||"left",r=e.vertexBaseline||l.baseline||"middle"}else e.anchorType==="edge"?(a="center",r="middle",typeof t.edgeAngleRadScreen=="number"?i+=t.edgeAngleRadScreen*(180/Math.PI):typeof t.edgeAngleRad=="number"&&(i+=t.edgeAngleRad*(180/Math.PI))):e.anchorType==="canvas"&&(a="left",r="top");e.anchorType==="edge"&&(i>90||i<-90)&&(i+=180,i>180&&(i-=360),r="top");const c=ye.includes(e.id);if(Ne&&c)if(Xe){const{center:l,rotation:d,scale:h,directionalScale:f,startVector:u}=Xe;o=He(o,l,d,h,f,u),i-=d*(180/Math.PI),s*=h}else{const l=fl();l&&(o={x:o.x+l.x,y:o.y+l.y})}return{id:e.id,content:e.content||"",position:o,rotationDeg:i,scale:s,textAlign:a,textBaseline:r}}function Yh(e){const t=tt.getBoundingClientRect(),n=[];qe.forEach(o=>{const i=ul(o);if(!i){n.push(o.id);return}const s=xe(i.position),a=`text-${i.id}`,r=ye.includes(o.id),c=o.color||Pe(It)||e.uiTextDefault||e.geometryInfoText,l=e.selectionGlow||"rgba(120, 170, 255, 1)",d=Nh(c,l,.35);xt({id:a,content:i.content,x:s.x,y:s.y,color:r?d:c,fontSize:(o.fontSize||Na)*i.scale,options:{textAlign:i.textAlign,textBaseline:i.textBaseline,rotation:i.rotationDeg}});const h=mo.get(a);if(h){const f=h.contentEl||h;f.style.outline="none",f.style.textShadow="none",f.style.color=r?d:c;const g=(h.katexEl||f).getBoundingClientRect();o.screenBounds={left:g.left-t.left,top:g.top-t.top,right:g.right-t.left,bottom:g.bottom-t.top}}}),n.length>0&&(qe=qe.filter(o=>!n.includes(o.id)),ye=ye.filter(o=>!n.includes(o)))}function pl(e){for(let t=qe.length-1;t>=0;t--){const n=qe[t],o=n.screenBounds;if(o&&e.x>=o.left&&e.x<=o.right&&e.y>=o.top&&e.y<=o.bottom)return n}return null}function gl(e,t=""){if(!as.inputEl){const s=document.createElement("input");s.type="text",s.style.position="absolute",s.style.zIndex="5",s.style.pointerEvents="auto",s.style.fontFamily="KaTeX_Main, Times New Roman, serif",s.style.fontSize=`${e.fontSize||Na}px`,s.style.border="1px solid rgba(255, 255, 255, 0.4)",s.style.borderRadius="4px",s.style.padding="2px 4px",s.style.background="rgba(0, 0, 0, 0.6)",s.style.color="#ffffff",s.style.outline="none",s.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),Yo(!0)):a.key==="Escape"&&(a.preventDefault(),Yo(!1))}),s.addEventListener("mouseleave",()=>Yo(!0)),s.addEventListener("blur",()=>Yo(!0)),tt.appendChild(s),as.inputEl=s}const n=ul(e);if(!n)return;const o=xe(n.position),i=as.inputEl;i.value=t||e.content||"",i.style.left=`${o.x}px`,i.style.top=`${o.y}px`,i.style.transform="translate(-10%, -10%)",i.style.display="block",as.activeId=e.id,i.focus(),i.setSelectionRange(i.value.length,i.value.length)}function Yo(e){const t=as.inputEl;if(!t)return;const n=as.activeId;if(n&&e){const o=So(n);if(o){Ge();const i=t.value.trim();!i&&o.isDraft?(qe=qe.filter(s=>s.id!==o.id),ye=ye.filter(s=>s!==o.id)):(o.content=i||o.content||"",delete o.isDraft)}}t.style.display="none",as.activeId=null}function Xh(e=""){let t="canvas",n=null,o={x:0,y:0},i=Ee(K);if(un)t="vertex",n=un,o=ha(n).offset;else if(En)t="edge",n=En,o=dl(n);else if(pn)t="face",n=pn;else{const a=Xs(Dh);i={x:i.x+a.x,y:i.y+a.y}}const s={id:Lt(),content:e,anchorType:t,anchorId:n,position:t==="canvas"?i:null,offset:t==="canvas"?{x:0,y:0}:o,rotationDeg:0,scale:1,fontSize:Na,color:Pe(It),isDraft:!0};if(t==="vertex"){const a=ha(n);s.vertexAlign=a.align,s.vertexBaseline=a.baseline}qe.push(s),ye=[s.id],gl(s,e)}function za(e,t,n){if(n){const o=Ie.indexOf(e);if(o>-1){Ie.splice(o,1),Ye===e&&(Ye=Ie.length>0?Ie[Ie.length-1]:null);return}Ie.push(e),Ye=e;return}Ie.includes(e)||Ie.push(e),Ye=e}function qo(e){const t=Gn(e,st,j.interval1,on,!0);if(ae.forEach(o=>{o.type==="regular"&&t.push({x:o.x,y:o.y,isGridVertex:!1})}),U.forEach(o=>{const i=q(o.id1),s=q(o.id2);if(i&&s&&i.type==="regular"&&s.type==="regular"){const a={x:(i.x+s.x)/2,y:(i.y+s.y)/2,isGridVertex:!1};t.push(a)}}),t.length===0)return null;const n=(o,i)=>(o.x-i.x)**2+(o.y-i.y)**2;return t.reduce((o,i)=>{const s=n(e,o);return n(e,i)<s?i:o})}function Ot(){const e=new Set(ae.map(a=>a.id)),t=new Set,n=[];for(const a of e)if(!t.has(a)){const r=_o(a),c=new Set(r);n.push(c),r.forEach(l=>t.add(l))}const o=a=>[...a].sort().join(","),i=[],s=new Set;ra.forEach(a=>{const r=o(a);for(let c=0;c<n.length;c++){if(s.has(c))continue;const l=n[c];if(r===o(l)){i.push(l),s.add(c);break}}});for(let a=0;a<n.length;a++)s.has(a)||i.push(n[a]);ra=i}function zh(e,t,n=!1,o=[],i=1){if(n&&o.length>0&&[...e].some(l=>o.some(d=>d.id===l)))return;const s=Z.filter(c=>c.vertexIds.every(l=>e.has(l)));Fd(Me,{allFaces:s,allEdges:U,facesVisible:kn,isDragConfirmed:!1,dragPreviewVertices:[],transformIndicatorData:null,initialDragVertexStates:[],colors:t,initialCoordSystemStates:new Map,interpolationStyle:yi(),getInterpolationStyleById:gi,faceColorMode:Oe,edgeColorMode:At,faceColorExpression:Vn,faceColorPolarExpression:Yn,edgeColorExpression:wn},xe,q);const a=U.filter(c=>e.has(c.id1)&&e.has(c.id2));Kd(Me,{allEdges:a,selectedEdgeIds:ie,hoveredEdgeId:En,isDragConfirmed:!1,dragPreviewVertices:[],colors:t,edgesVisible:ri,snappedEdgeIds:Ss,currentAltPressed:_t,interpolationStyle:yi(),getInterpolationStyleById:gi,edgeColorMode:At,edgeColorExpression:wn},xe,q,ne),ae.filter(c=>e.has(c.id)).forEach(c=>{let l=!1;gt.has(c.id)&&gt.get(c.id).some(h=>h.copyIndex===void 0)&&(l=!0),ni(Me,c,{selectedVertexIds:le,selectedCenterIds:Ie,activeCenterId:Ye,colors:t,verticesVisible:ai,isHovered:un===c.id,isSnapped:l,snappedVertexIds:gt,isDragConfirmed:!1,dragPreviewVertices:[],currentAltPressed:_t},xe)})}function Eo(e,t,n,o=!1,i=null){const s=Ee(t),a=i||Ua(e.id),r=ma/oe.scale,c=Sa/oe.scale,l=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j?.interval1,d=Fe*2/oe.scale,h=Fe/oe.scale,f=Fe*2/oe.scale,u=Fe*2/oe.scale,g=Ue&&Ce.length>=1;if(n){const p=[];let y=!1;for(const S of ae)if(S.id!==e.id&&S.type==="regular"&&J(s,S)<r){y=!0;break}if(!y)for(const S of U){const I=q(S.id1),b=q(S.id2);if(I&&b&&I.type==="regular"&&b.type==="regular"&&bt(s,I,b).distance<c){y=!0;break}}if(g){if(ae.forEach(v=>{if(v.id!==e.id&&v.type==="regular"){const E=J(s,v);p.push({priority:1,dist:E,pos:v,snapType:"vertex",targetVertex:v})}}),U.forEach(v=>{const E=q(v.id1),O=q(v.id2);E&&O&&E.type==="regular"&&O.type==="regular"&&E.id!==e.id&&O.id!==e.id&&bt(s,E,O).distance<h*1.5&&Br.forEach(D=>{const F={x:E.x+D*(O.x-E.x),y:E.y+D*(O.y-E.y)},R=J(s,F);p.push({priority:2,dist:R,pos:F,snapType:"edge_fraction",targetEdge:v,fraction:D})})}),st!=="none"&&l){const v=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j.interval1;v&&Gn(s,st,v,on,!0).forEach(O=>{const P=J(s,O);p.push({priority:3,dist:P,pos:O,snapType:"grid"})})}const S=a.currentSegmentReferenceA_for_display,I=a.currentSegmentReferenceD,b=new Set([0,...Ea.flatMap(v=>[v,-v])]),C=Array.from(b).sort((v,E)=>v-E).map(v=>({factor:v,angle:bn(a.offsetAngleRad+v*S),turn:nt(v*S)})),w=J(e,s),_=[];if([0,...$n].forEach(v=>_.push({factor:v,dist:v*I})),I>re){const v=w/I,E=Math.round(v),O=Math.round(v*2)/2;[E,O].forEach(P=>{P>=0&&!_.some(D=>Math.abs(D.factor-P)<re)&&_.push({factor:P,dist:P*I})})}if(_.sort((v,E)=>v.dist-E.dist),C.length>0&&_.length>0)for(const v of C)for(const E of _){if(E.dist<re&&(v.factor!==0||_.length>1))continue;const O={x:e.x+E.dist*Math.cos(v.angle),y:e.y+E.dist*Math.sin(v.angle)},P=J(s,O);p.push({priority:4,dist:P,pos:O,snapType:"geometric",lengthSnapFactor:E.factor,angleSnapFactor:v.factor,angleTurn:v.turn})}}else if(!y&&st!=="none"&&l){const S=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j.interval1;if(S){const I=Gn(s,st,S,on,!0);if(I.length>0){const b=I.sort((M,C)=>J(s,M)-J(s,C))[0];p.push({priority:3,dist:J(s,b),pos:b,snapType:"grid"})}}}let x=null;if(p.length>0)if(!g)x=p[0];else{let S=!1;for(let I=1;I<=3;I++){let b;I===1?b=d:I===2?b=h:b=f;const M=p.filter(C=>C.priority===I&&C.dist<b);if(M.length>0){x=M.sort((C,w)=>C.dist-w.dist)[0],S=!0;break}}if(!S){const I=p.filter(b=>b.priority===4);if(I.length>0){const b=I.sort((M,C)=>M.dist-C.dist)[0];b.dist<u&&(x=b)}}x||(x=p.sort((I,b)=>I.dist-b.dist)[0])}if(x){const S=Math.atan2(x.pos.y-e.y,x.pos.x-e.x)||0,I=parseFloat(J(e,x.pos).toFixed(10));let b=null,M=null;if(x.snapType==="grid"&&l){const w=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j.interval1;if(w){const _=x.pos.x-e.x,T=x.pos.y-e.y,v=w*1e-5;if(st==="triangular"){const E=w*xa,O=T/E,P=Math.round(O),D=P%2!==0?w/2:0,F=(_-D)/w;if(Math.abs(O-P)<v/E&&Math.abs(F-Math.round(F))<v/w){const R=P,B=Math.round(F);b=B*B+B*R+R*R,M=w}}else{const E=_/w,O=T/w;if(Math.abs(E-Math.round(E))<v/w&&Math.abs(O-Math.round(O))<v/w){const P=Math.round(E),D=Math.round(O);b=P*P+D*D,M=w}}}}let C=x.angleTurn!=null?x.angleTurn:nt(S-a.offsetAngleRad);return{x:parseFloat(x.pos.x.toFixed(fr)),y:parseFloat(x.pos.y.toFixed(fr)),angle:S*(180/Math.PI),distance:I,snapped:!0,snapType:x.snapType,targetEdge:x.targetEdge,fraction:x.fraction,targetVertex:x.targetVertex,gridSnapped:x.snapType==="grid",lengthSnapFactor:x.lengthSnapFactor||null,angleSnapFactor:x.angleSnapFactor||null,angleTurn:C,gridToGridSquaredSum:b,gridInterval:M}}const m=Math.atan2(s.y-e.y,s.x-e.x)||0;return{x:s.x,y:s.y,angle:m*(180/Math.PI),distance:J(e,s),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:nt(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}else{const p=[];for(const m of ae)if(m.id!==e.id&&m.type==="regular"){const S=J(s,m);S<r&&p.push({priority:1,dist:S,pos:m,snapType:"vertex",targetVertex:m})}for(const m of U){const S=q(m.id1),I=q(m.id2);if(S&&I&&S.type==="regular"&&I.type==="regular"){const b=bt(s,S,I);b.distance<c&&b.onSegmentStrict&&p.push({priority:2,dist:b.distance,pos:{x:b.x,y:b.y},snapType:"edge",targetEdge:m})}}let y=null;if(p.length>0){y=p.sort((S,I)=>S.priority!==I.priority?S.priority-I.priority:S.dist-I.dist)[0];const m=y.priority===1?d:h;y.dist>m&&(y=null)}if(y){const m=Math.atan2(y.pos.y-e.y,y.pos.x-e.x)||0;return{...y.pos,angle:m*(180/Math.PI),distance:J(e,y.pos),snapped:!0,snapType:y.snapType,targetEdge:y.targetEdge,targetVertex:y.targetVertex,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:nt(m-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}const x=Math.atan2(s.y-e.y,s.x-e.x)||0;return{x:s.x,y:s.y,angle:x*(180/Math.PI),distance:J(e,s),snapped:!1,gridSnapped:!1,lengthSnapFactor:null,angleSnapFactor:null,angleTurn:nt(x-a.offsetAngleRad),gridToGridSquaredSum:null,gridInterval:null}}}function Hh(e,t,n){const o=[],i=ma/oe.scale,s=Sa/oe.scale;if(ae.forEach(a=>{if(a.id!==e.id&&a.type==="regular"){const r=J(t,a);r<i&&o.push({priority:1,dist:r,pos:a,snapType:"vertex",targetVertex:a})}}),U.forEach(a=>{if(a.id1===e.id||a.id2===e.id)return;const r=q(a.id1),c=q(a.id2);if(r&&c&&r.type==="regular"&&c.type==="regular"){const l=bt(t,r,c);l.distance<s&&l.onSegmentStrict&&o.push({priority:2,dist:l.distance,pos:{x:l.x,y:l.y},snapType:"edge",targetEdge:a})}}),o.length>0){const a=o.sort((r,c)=>r.priority!==c.priority?r.priority-c.priority:r.dist-c.dist)[0];return{pos:a.pos,snapped:!0,snapType:a.snapType,targetEdge:a.targetEdge,targetVertex:a.targetVertex}}return{pos:t,snapped:!1}}function Gh(){ue=ue.map(e=>e.type==="color"?{...e,value:vd(e.value)}:e)}function Wh(){z.toolbarButton={id:"toolbar-button",x:je,y:je,width:kc,height:Rc,type:"menuButton"}}function yl(){const e=fe.height/Ve;z.mainToolbar={id:"main-toolbar-bg",x:0,y:0,width:Le,height:e,type:"toolbar"};const t=je;let n=z.toolbarButton.y+z.toolbarButton.height+Lc;z.colorToolButton={id:"color-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,z.colorModeToolButton={id:"color-mode-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,z.interpolationToolButton={id:"interpolation-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,z.transformToolButton={id:"transform-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,z.visibilityToolButton={id:"visibility-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut},n+=ut+t,z.sessionsToolButton={id:"sessions-tool-button",type:"toolButton",x:je,y:n,width:Le-2*je,height:ut}}function at(){z.colorSwatches=[],z.colorTargetIcons=[];const e=zn+eo,t=Le+je,n=z.colorToolButton.y+ut/2,o=ba,s=n-o/2+-2;let a=t;z.removeColorButton={id:"remove-color-button",type:"button",x:a+(e-o)/2,y:s,width:o,height:o},a+=e,ue.forEach((l,d)=>{z.colorSwatches.push({id:`swatch-${d}`,type:"colorSwatch",x:a+(e-o)/2,y:s,width:o,height:o,index:d,item:l}),a+=e}),z.addColorButton={id:"add-color-button",type:"button",x:a+(e-o)/2,y:s,width:o,height:o},Object.entries(he).forEach(([l,d])=>{const h=o*.75,f=z.colorSwatches.find(u=>u.index===d);f&&z.colorTargetIcons.push({id:`target-icon-${l}`,type:"colorTargetIcon",target:l,x:f.x+(f.width-h)/2,y:f.y-h-5,width:h,height:h})});const r=new Map(z.colorTargetIcons.map(l=>[l.target,l]));Object.keys(he).forEach(l=>{const d=ll(l);if(d!==l){const h=r.get(d),f=r.get(l);h&&f&&(f.x=h.x,f.y=h.y,f.width=h.width,f.height=h.height)}});const c=[...z.colorSwatches,z.removeColorButton,z.addColorButton,...z.colorTargetIcons].filter(Boolean);if(c.length>0){const l=Math.min(...c.map(u=>u.y)),d=Math.max(...c.map(u=>u.x+u.width)),h=Math.max(...c.map(u=>u.y+u.height)),f=5;z.colorPaletteBounds={x:Le,y:l-f,width:d-Le+f,height:h-l+f*2}}else z.colorPaletteBounds=null}function ml(){if(z.colorModeIcons=[],!z.colorModeToolButton)return;const e=Le+je,t=z.colorModeToolButton.y+ut/2,n=ba,i=t-n/2+-2,s=zn+eo,a=[{id:"edge-color-mode",group:"edge"},{id:"face-color-mode",group:"face"}];let r=e;a.forEach(l=>{const d=l.group==="face"&&(At==="colormap"||Oe.startsWith("colormap"))?240:0;z.colorModeIcons.push({id:l.id,type:"colorModeIcon",group:l.group,x:r+(s-n)/2,y:i,width:n,height:n}),r+=s+d});const c=z.colorModeIcons.filter(Boolean);if(c.length>0){const l=Math.min(...c.map(u=>u.y)),d=Math.max(...c.map(u=>u.x+u.width)),h=Math.max(...c.map(u=>u.y+u.height)),f=5;z.colorModePanelBounds={x:Le,y:l-f,width:d-Le+f,height:h-l+f*2}}else z.colorModePanelBounds=null}function xl(){if(z.interpolationIcons=[],!z.interpolationToolButton)return;const e=Le+je,t=z.interpolationToolButton.y+ut/2,n=zn,i=t-n/2+-2,s=zn+eo;let a=e;z.interpolationIcons.push({id:"interpolation-remove",type:"interpolationRemove",x:a+(s-n)/2,y:i,width:n,height:n}),a+=s,fn.forEach(c=>{z.interpolationIcons.push({id:`interpolation-${c.id}`,type:"interpolationStyle",styleId:c.id,x:a+(s-n)/2,y:i,width:n,height:n}),a+=s}),z.interpolationIcons.push({id:"interpolation-add",type:"interpolationAdd",x:a+(s-n)/2,y:i,width:n,height:n});const r=z.interpolationIcons.filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;z.interpolationPanelBounds={x:Le,y:c-h,width:l-Le+h,height:d-c+h*2}}else z.interpolationPanelBounds=null}function qh(){if(z.displayIcons=[],!z.visibilityToolButton)return;const e=zn+eo,t=Le+je,n=z.visibilityToolButton.y+ut/2,o=Bc,s=n-o/2+-2;let a=t;if(["coords","grid","angles","distances","theme"].forEach(c=>{z.displayIcons.push({id:`display-icon-${c}`,group:c,x:a+(e-o)/2,y:s,width:o,height:o}),a+=e}),z.displayIcons.length>0){const c=z.displayIcons[0],l=z.displayIcons[z.displayIcons.length-1],d=5;z.displayPanelBounds={x:Le,y:c.y-d,width:l.x+l.width-Le+d,height:c.height+d*2}}else z.displayPanelBounds=null}function _i(){if(z.sessionIcons=[],!z.sessionsToolButton)return;const e=Le+je,t=z.sessionsToolButton.y+ut/2,n=ba,i=t-n/2+-2,s=zn+eo;let a=e;z.removeSessionButton={id:"remove-session-button",type:"button",x:a+(s-n)/2,y:i,width:n,height:n},a+=s,Te.forEach((c,l)=>{z.sessionIcons.push({id:`session-${c.id}`,type:"sessionIcon",x:a+(s-n)/2,y:i,width:n,height:n,index:l,session:c}),a+=s}),z.addSessionButton={id:"add-session-button",type:"button",x:a+(s-n)/2,y:i,width:n,height:n};const r=[...z.sessionIcons,z.removeSessionButton,z.addSessionButton].filter(Boolean);if(r.length>0){const c=Math.min(...r.map(f=>f.y)),l=Math.max(...r.map(f=>f.x+f.width)),d=Math.max(...r.map(f=>f.y+f.height)),h=5;z.sessionsPanelBounds={x:Le,y:c-h,width:l-Le+h,height:d-c+h*2}}else z.sessionsPanelBounds=null}function Uh(){z.transformIcons=[];const e=zn,t=e+eo,n=Le+je,i=z.transformToolButton.y+ut/2-e/2,s=[Kt,Rn,sn,Jn];let a=n;if(s.forEach(r=>{z.transformIcons.push({id:`transform-icon-${r}`,type:r,x:a+(t-e)/2,y:i,width:e,height:e}),a+=t}),z.transformIcons.length>0){const r=z.transformIcons[0],c=z.transformIcons[z.transformIcons.length-1],l=5;z.transformPanelBounds={x:Le,y:r.y-l,width:c.x+c.width-Le+l,height:r.height+l*2}}else z.transformPanelBounds=null}function Ha(e){e<0||e>=ue.length||ue.length<=1||(ue.splice(e,1),Object.keys(he).forEach(t=>{he[t]>e?he[t]--:he[t]===e&&(he[t]=Math.min(e,ue.length-1))}),Pi(),at())}function jh(e){if(!e||!e.type){console.error("Invalid color object passed to addToColors:",e);return}ue.some(n=>!n||n.type!==e.type?!1:n.type==="colormap"?JSON.stringify(n.vertices)===JSON.stringify(e.vertices):n.value===e.value)||(ue.push(e),ot&&at())}function Sl(e,t=[]){const n=q(e);if(!n)return null;for(let o=U.length-1;o>=0;o--){const i=U[o],s=ne(i);if(t.includes(s))continue;let a=null;if(i.id1===e?a=i.id2:i.id2===e&&(a=i.id1),a){const r=q(a);if(r){const c=n.x-r.x,l=n.y-r.y;return{p1:r,p2:n,angleRad:Math.atan2(l,c),length:Math.sqrt(c*c+l*l),edgeId:s}}}}return null}function Ge(){const e=To();ue.length,ue[0]?.value,ae.length,ft.push(e),ft.length>Ca&&ft.shift(),Xn=[],Yt()}function Ga(e){const t=z.toolbarButton;if(t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height)return!0;if(!rs)return!1;const n=[];z.mainToolbar&&n.push(z.mainToolbar),ot&&z.colorPaletteBounds&&n.push(z.colorPaletteBounds),Qt&&z.interpolationPanelBounds&&n.push(z.interpolationPanelBounds),In&&z.transformPanelBounds&&n.push(z.transformPanelBounds),hn&&z.displayPanelBounds&&n.push(z.displayPanelBounds),pt&&z.sessionsPanelBounds&&n.push(z.sessionsPanelBounds),en&&z.colorModePanelBounds&&n.push(z.colorModePanelBounds);for(const i of n)if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;const o=[];ot&&z.colorPaletteBounds&&o.push(z.colorPaletteBounds),Qt&&z.interpolationPanelBounds&&o.push(z.interpolationPanelBounds),In&&z.transformPanelBounds&&o.push(z.transformPanelBounds),hn&&z.displayPanelBounds&&o.push(z.displayPanelBounds),pt&&z.sessionsPanelBounds&&o.push(z.sessionsPanelBounds),en&&z.colorModePanelBounds&&o.push(z.colorModePanelBounds),o.sort((i,s)=>i.y-s.y);for(let i=0;i<o.length-1;i++){const s=o[i],a=o[i+1],r=s.y+s.height,c=a.y;if(e.y>r&&e.y<c){const l=Le,d=s.x+s.width-l,h=a.x+a.width-l,f=Math.min(d,h),u=l+f;if(e.x<Le||e.x>=l&&e.x<=u)return!0}}return!1}function wo(e){ae=JSON.parse(JSON.stringify(e.vertices)),U=JSON.parse(JSON.stringify(e.edges)),Z=JSON.parse(JSON.stringify(e.faces||[])),qe=JSON.parse(JSON.stringify(e.textElements||[])),le=JSON.parse(JSON.stringify(e.selectedVertexIds||[])),ie=JSON.parse(JSON.stringify(e.selectedEdgeIds||[])),se=JSON.parse(JSON.stringify(e.selectedFaceIds||[])),ye=JSON.parse(JSON.stringify(e.selectedTextIds||[])),Ie=JSON.parse(JSON.stringify(e.selectedCenterIds||[])),ze=JSON.parse(JSON.stringify(e.activeColorTargets||[])),fn=e.interpolationStyles&&e.interpolationStyles.length>0?JSON.parse(JSON.stringify(e.interpolationStyles)):[JSON.parse(JSON.stringify(An))],vo=e.activeInterpolationStyleId||fn[0]?.id||An.id,ue=e.allColors?JSON.parse(JSON.stringify(e.allColors)):bi.map(n=>typeof n=="string"?{type:"color",value:n}:n),he=e.colorAssignments?JSON.parse(JSON.stringify(e.colorAssignments)):{[_e]:0,[Re]:1,[we]:2,[It]:0},At=e.edgeColorMode||"fixed",Oe=e.faceColorMode||"fixed",wn=e.edgeColorExpression||"x",Vn=e.faceColorExpression||"x",Yn=e.faceColorPolarExpression||"r",he[It]===void 0&&(he[It]=0),Pi(),cl(),Ye=e.activeCenterId!==void 0?e.activeCenterId:null,Ue=e.isDrawingMode!==void 0?e.isDrawingMode:!1,it=e.previewLineStartVertexId!==void 0?e.previewLineStartVertexId:null,kt=e.frozenReference_A_rad!==void 0?e.frozenReference_A_rad:null,Wn=e.frozenReference_A_baseRad!==void 0?e.frozenReference_A_baseRad:null,dt=e.frozenReference_D_du!==void 0?e.frozenReference_D_du:null,Dn=e.frozenReference_Origin_Data!==void 0?e.frozenReference_Origin_Data:null,qn=e.frozenReference_D_g2g!==void 0?e.frozenReference_D_g2g:null,Ys=e.deletedFaceIds!==void 0?new Set(e.deletedFaceIds):new Set,Bt=!1,Ne=!1,Un=!1,ds=!1,Se=[],di=null,gn=-1,de={targetId:null,type:null,count:0,timestamp:0},fe.style.cursor="crosshair",ot&&at();const t=To();ft.length===0&&ft.push(t),Yt()}function To(){return{vertices:JSON.parse(JSON.stringify(ae)),edges:JSON.parse(JSON.stringify(U)),faces:JSON.parse(JSON.stringify(Z)),textElements:JSON.parse(JSON.stringify(qe)),selectedVertexIds:JSON.parse(JSON.stringify(le)),selectedEdgeIds:JSON.parse(JSON.stringify(ie)),selectedFaceIds:JSON.parse(JSON.stringify(se)),selectedTextIds:JSON.parse(JSON.stringify(ye)),selectedCenterIds:JSON.parse(JSON.stringify(Ie)),activeColorTargets:JSON.parse(JSON.stringify(ze)),interpolationStyles:JSON.parse(JSON.stringify(fn)),activeInterpolationStyleId:vo,colorAssignments:JSON.parse(JSON.stringify(he)),edgeColorMode:At,faceColorMode:Oe,edgeColorExpression:wn,faceColorExpression:Vn,faceColorPolarExpression:Yn,allColors:JSON.parse(JSON.stringify(ue)),activeCenterId:Ye,isDrawingMode:Ue,previewLineStartVertexId:it,frozenReference_A_rad:kt,frozenReference_A_baseRad:Wn,frozenReference_D_du:dt,frozenReference_Origin_Data:Dn,frozenReference_D_g2g:qn,deletedFaceIds:new Set(Ys)}}function Il(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9_-]/g,"").slice(0,40):""}function Kh(){try{const e=new URLSearchParams(window.location.search);return Il(e.get("user"))}catch{return""}}function bl(){if(Zt)return Zt;const e=Kh();if(e){Zt=e;try{localStorage.setItem(Ui,Zt)}catch(t){console.warn("Could not persist user id to localStorage.",t)}return Zt}try{Zt=localStorage.getItem(Ui)}catch{Zt=null}if(!Zt){let t="";try{t=window.prompt("Enter a name to keep your drawings on this device:","")||""}catch{t=""}Zt=Il(t)||`user-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;try{localStorage.setItem(Ui,Zt)}catch(o){console.warn("Could not persist user id to localStorage.",o)}}return Zt}function vl(){const e=bl();return`${Ba}.state.v${oi}.${e}`}function Ml(){const e=bl();return`${Ba}.sessions.v${oi}.${e}`}function Cl(){return{vertices:[],edges:[],faces:[],textElements:[],selectedVertexIds:[],selectedEdgeIds:[],selectedFaceIds:[],selectedTextIds:[],selectedCenterIds:[],activeColorTargets:[],interpolationStyles:[JSON.parse(JSON.stringify(An))],activeInterpolationStyleId:An.id,colorAssignments:{[_e]:0,[Re]:1,[we]:2,[It]:0},edgeColorMode:"fixed",faceColorMode:"fixed",edgeColorExpression:"x",faceColorExpression:"x",faceColorPolarExpression:"r",allColors:bi.map(e=>typeof e=="string"?{type:"color",value:e}:e),activeCenterId:null,isDrawingMode:!1,previewLineStartVertexId:null,frozenReference_A_rad:null,frozenReference_A_baseRad:null,frozenReference_D_du:null,frozenReference_Origin_Data:null,frozenReference_D_g2g:null,deletedFaceIds:[]}}function Po(){if(!Te.length)return;const e=Te[$t];e&&(e.state=qa())}function Wa(e,t=""){return{id:Lt(),name:t,state:JSON.parse(JSON.stringify(e))}}function qa(){const e=To();return{...e,deletedFaceIds:Array.from(e.deletedFaceIds||[])}}function El(){if(!window.localStorage)return;const e=vl(),t={version:oi,savedAt:Date.now(),state:qa()};try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Could not persist state to localStorage.",n)}if(Te.length>0){Po();const n=Ml(),o={version:oi,savedAt:Date.now(),activeSessionIndex:$t,sessions:Te.map(i=>({...i,state:JSON.parse(JSON.stringify(i.state))}))};try{localStorage.setItem(n,JSON.stringify(o))}catch(i){console.warn("Could not persist sessions to localStorage.",i)}}}function Yt(){window.localStorage&&($o&&clearTimeout($o),$o=setTimeout(()=>{$o=null,El()},300))}function Jh(){if(!window.localStorage)return!1;const e=vl();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!n.state?!1:(wo(n.state),Ot(),al=!0,!0)}catch(t){return console.warn("Could not load state from localStorage.",t),!1}}function Zh(){if(!window.localStorage)return!1;const e=Ml();try{const t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);return!n||!Array.isArray(n.sessions)||n.sessions.length===0?!1:(Te=n.sessions.map(o=>({id:o.id||Lt(),name:o.name||"",state:o.state||Cl()})),$t=Math.min(Math.max(n.activeSessionIndex||0,0),Te.length-1),yt=$t,ft=[],Xn=[],wo(Te[$t].state),Ot(),al=!0,!0)}catch(t){return console.warn("Could not load sessions from localStorage.",t),!1}}function Qh(){const e=qa();Te=[Wa(e,"World 1")],$t=0,yt=0}function Cs(e){e<0||e>=Te.length||(Po(),$t=e,yt=e,ft=[],Xn=[],wo(Te[$t].state),Ot(),pt&&_i(),Yt())}function ef(){Po();const e=Wa(Cl(),`World ${Te.length+1}`),t=yt!==null?yt+1:Te.length;Te.splice(t,0,e),Cs(t)}function tf(){if(!co||!co.state)return;Po();const e=Wa(co.state,`World ${Te.length+1}`),t=yt!==null?yt+1:Te.length;Te.splice(t,0,e),Cs(t)}function wl(e){if(e<0||e>=Te.length||(Po(),Te.length===1))return;const t=e<Te.length-1?e:e-1,[n]=Te.splice(e,1);hi.push({session:n,index:e}),$t===e?Cs(Math.max(0,Math.min(t,Te.length-1))):($t>e&&($t-=1),yt>e&&(yt-=1),pt&&_i(),Yt())}function nf(){if(!hi.length)return!1;const{session:e,index:t}=hi.pop(),n=Math.max(0,Math.min(t,Te.length));return Te.splice(n,0,e),Cs(n),!0}function sf(){if(!Te.length)return;const e=(yt+1)%Te.length;Cs(e)}function of(){if(!Te.length)return;const e=(yt-1+Te.length)%Te.length;Cs(e)}function mi(){Z.forEach(t=>{t.parentFaceId=null,t.childFaceIds=[]});const e=Z.map(t=>{const n=t.vertexIds.map(o=>q(o));return n.some(o=>!o)?null:{face:t,vertices:n,area:Math.abs(Ci(n))}}).filter(Boolean);e.forEach(t=>{let n=null,o=1/0;e.forEach(i=>{if(t.face.id===i.face.id||i.area<=t.area)return;const s=t.face.vertexIds,a=s.map(c=>q(c));if(a.some(c=>!c))return;if(kd(a,i.vertices)){const c=new Set(s),l=U.filter(h=>c.has(h.id1)&&c.has(h.id2));!Rd(l,i.vertices,q)&&i.area<o&&(o=i.area,n=i.face)}}),n&&(t.face.parentFaceId=n.id)}),Z.forEach(t=>{if(t.parentFaceId){const n=Z.find(o=>o.id===t.parentFaceId);n&&!n.childFaceIds.includes(t.id)&&n.childFaceIds.push(t.id)}})}function Ee(e){const t=e.x*Ve,n=e.y*Ve,o=fe.height;return{x:(t-oe.offsetX)/oe.scale,y:(o-n-oe.offsetY)/oe.scale}}function xe(e){const t=fe.height,n=e.x*oe.scale+oe.offsetX,o=t-(e.y*oe.scale+oe.offsetY);return{x:n/Ve,y:o/Ve}}function q(e){return ae.find(t=>t.id===e)}function _o(e){if(!q(e))return[];const t=new Set,n=[e],o=[];for(t.add(e);n.length>0;){const i=n.shift();o.push(i),cn(i,U).forEach(s=>{t.has(s)||(t.add(s),n.push(s))})}return o}function Ks(e){const t=Ee(e),n=Fe*2/oe.scale,o=(Si+Fe)/oe.scale;for(let i=ae.length-1;i>=0;i--){const s=ae[i];if(s.type!=="regular"&&J(t,s)<o)return s}for(let i=ae.length-1;i>=0;i--){const s=ae[i];if(s.type==="regular"&&J(t,s)<n)return s}return null}function Js(e){const t=Ee(e),n=Sa/oe.scale;for(let o=U.length-1;o>=0;o--){const i=U[o],s=q(i.id1),a=q(i.id2);if(s&&a&&s.type==="regular"&&a.type==="regular"){const r=bt(t,s,a);if(r.distance<n&&r.onSegmentStrict)return i}}return null}function Zs(e){const t=Ee(e),n=[];for(const s of Z){if(s.color==="transparent")continue;const a=s.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular");a.length<3||ps(t,a)&&n.push(s)}if(n.length===0)return null;let o=null,i=1/0;for(const s of n){let a=!1;if(s.childFaceIds&&s.childFaceIds.length>0)for(const r of s.childFaceIds){const c=Z.find(l=>l.id===r);if(c&&c.color==="transparent"){const l=c.vertexIds.map(d=>q(d)).filter(Boolean);if(l.length>=3&&ps(t,l)){a=!0;break}}}if(!a){const r=s.vertexIds.map(c=>q(c));if(r.every(Boolean)){const c=Math.abs(Ci(r));c<i&&(i=c,o=s)}}}return o}function ua(e){return U.filter(t=>t.id1===e||t.id2===e)}function af(){le.length===0&&ie.length===0&&Ie.length===0||(Ge(),Tl(),Ao())}function Tl(){const e=new Set(le);Ye&&e.add(Ye);const t=[];se.length>0&&se.forEach(s=>{const a=Z.find(r=>ge(r)===s);a&&(t.push(a),a.vertexIds.forEach(r=>e.add(r)))}),ie.forEach(s=>{const[a,r]=s.split(zs);e.add(a),e.add(r)}),Tt.vertices=Array.from(e).map(s=>{const a=q(s);return a?{...a}:null}).filter(s=>s),Tt.edges=[],U.forEach(s=>{e.has(s.id1)&&e.has(s.id2)&&Tt.edges.push({...s})}),Tt.faces=t.map(s=>JSON.parse(JSON.stringify(s)));const n=new Set(ye),o=new Set(se),i=new Set(ie);Tt.texts=qe.filter(s=>{if(n.has(s.id))return!0;if(s.anchorType==="vertex")return e.has(s.anchorId);if(s.anchorType==="edge"){if(i.has(s.anchorId))return!0;const a=U.find(r=>ne(r)===s.anchorId);return a?e.has(a.id1)&&e.has(a.id2):!1}if(s.anchorType==="face"){if(o.has(s.anchorId))return!0;const a=Z.find(r=>ge(r)===s.anchorId);return a?a.vertexIds.every(r=>e.has(r)):!1}return!1}).map(s=>JSON.parse(JSON.stringify(s))),Tt.referenceVertex=Ee(K)}function rf(){if(Tt.vertices.length===0||!Tt.referenceVertex)return;Ge();const e=Ee(K),t=e.x-Tt.referenceVertex.x,n=e.y-Tt.referenceVertex.y,o=new Map,i=[];let s=null;Kn(),Tt.vertices.forEach(c=>{const l=Lt(),d={...c,id:l,x:c.x+t,y:c.y+n};ae.push(d),o.set(c.id,l),d.type==="regular"?i.push(l):s=l}),Tt.edges.forEach(c=>{const l=o.get(c.id1),d=o.get(c.id2);l&&d&&U.push({...c,id1:l,id2:d})});const a=[];Tt.faces.forEach(c=>{const l=c.vertexIds.map(d=>o.get(d)).filter(Boolean);if(l.length===c.vertexIds.length){const d={...c,id:ge({vertexIds:l}),vertexIds:l};d.localCoordSystem&&(d.localCoordSystem.origin.x+=t,d.localCoordSystem.origin.y+=n,d.localCoordSystem.attachedToVertex&&(d.localCoordSystem.attachedToVertex=o.get(d.localCoordSystem.attachedToVertex)),d.localCoordSystem.attachedToEdge&&(d.localCoordSystem.attachedToEdge.v1=o.get(d.localCoordSystem.attachedToEdge.v1),d.localCoordSystem.attachedToEdge.v2=o.get(d.localCoordSystem.attachedToEdge.v2)),d.localCoordSystem.rotationAlignedToEdge&&(d.localCoordSystem.rotationAlignedToEdge.v1=o.get(d.localCoordSystem.rotationAlignedToEdge.v1),d.localCoordSystem.rotationAlignedToEdge.v2=o.get(d.localCoordSystem.rotationAlignedToEdge.v2)),d.localCoordSystem.scaleAttachedToEdge&&(d.localCoordSystem.scaleAttachedToEdge.v1=o.get(d.localCoordSystem.scaleAttachedToEdge.v1),d.localCoordSystem.scaleAttachedToEdge.v2=o.get(d.localCoordSystem.scaleAttachedToEdge.v2))),d.parentFaceId=null,d.childFaceIds=[],Z.push(d),a.push(d.id)}}),Ms();const r=[];Tt.texts.forEach(c=>{const l=JSON.parse(JSON.stringify(c));if(l.id=Lt(),l.anchorType==="canvas"){if(!l.position)return;l.position={x:l.position.x+t,y:l.position.y+n}}else if(l.anchorType==="vertex"){const d=o.get(l.anchorId);if(!d)return;l.anchorId=d}else if(l.anchorType==="edge"){const d=U.find(u=>ne(u)===l.anchorId);if(!d)return;const h=o.get(d.id1),f=o.get(d.id2);if(!h||!f)return;l.anchorId=ne({id1:h,id2:f})}else if(l.anchorType==="face"){const d=Z.find(f=>ge(f)===l.anchorId);if(!d)return;const h=d.vertexIds.map(f=>o.get(f));if(!h.every(Boolean))return;l.anchorId=ge({vertexIds:h})}qe.push(l),r.push(l.id)}),le=i,ie=Tt.edges.map(c=>ne({id1:o.get(c.id1),id2:o.get(c.id2)})),se=a,ye=r,Ye=s,Ot()}function Ao(){const e=new Set(le),t=new Set(Ie),n=new Set(ie),o=new Set(se),i=new Set(ye);if(e.size===0&&t.size===0&&n.size===0&&o.size===0&&i.size===0)return;if(Ge(),o.size>0){const l=new Set;Z.forEach(d=>{const h=d.id||ge(d);o.has(h)&&(Ys.add(h),d.childFaceIds&&d.childFaceIds.length>0&&d.childFaceIds.forEach(f=>{const u=Z.find(g=>g.id===f);u&&(u.parentFaceId=null)}),d.parentFaceId?d.color="transparent":l.add(h))}),l.size>0&&(Z=Z.filter(d=>!l.has(d.id||ge(d))))}const s=[...U];if(n.size>0&&(U=U.filter(l=>!n.has(ne(l)))),e.size>0){const l=JSON.parse(JSON.stringify(U)),d=[],h=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1,f=new Set(e);for(;f.size>0;){const u=f.values().next().value,g=new Set,p=[u];for(;p.length>0;){const S=p.shift();f.has(S)&&(g.add(S),f.delete(S),cn(S,U).forEach(b=>{f.has(b)&&p.push(b)}))}const y=U.filter(S=>g.has(S.id1)&&!g.has(S.id2)||g.has(S.id2)&&!g.has(S.id1)),x=new Set;y.forEach(S=>{g.has(S.id1)||x.add(S.id1),g.has(S.id2)||x.add(S.id2)});const m=Array.from(x);if(m.length===2){const[S,I]=m,b=q(S),M=q(I),C=U.some(w=>w.id1===S&&w.id2===I||w.id1===I&&w.id2===S);if(b&&M&&!C){const w=gs(b,M,h,Pe);bs(w),d.push(w)}}}ae=ae.filter(u=>!e.has(u.id)),U=U.filter(u=>!e.has(u.id1)&&!e.has(u.id2)),d.length>0&&(U.push(...d),vs(l,U),Ms())}vs(s,U),t.size>0&&(ae=ae.filter(l=>!t.has(l.id))),i.size>0&&(qe=qe.filter(l=>!i.has(l.id)));const a=new Set(ae.map(l=>l.id)),r=new Set(U.map(l=>ne(l))),c=new Set(Z.map(l=>ge(l)));qe=qe.filter(l=>l.anchorType==="vertex"?a.has(l.anchorId):l.anchorType==="edge"?r.has(l.anchorId):l.anchorType==="face"?c.has(l.anchorId):!0),ye=ye.filter(l=>qe.some(d=>d.id===l)),Kn(),Ot()}function pa(e,t){let n=oe.scale*t;n<rr&&(n=rr),n>lr&&(n=lr);const o=n/oe.scale,i=e.x*Ve,s=e.y*Ve;oe.offsetX=i*(1-o)+oe.offsetX*o,oe.offsetY=(fe.height-s)*(1-o)+oe.offsetY*o,oe.scale=n}function Ua(e){let t=0,n,o=Math.PI/2,i=!0;const s=q(e);if(!s)return i=!0,st!=="none"&&j.interval1?n=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1:n=na,dt!==null&&(n=dt),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:o,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:null,displayAngleA_originVertexData_for_A_equals_label:null,frozen_A_baseRad_to_display:null,frozen_D_du_to_display:null,frozen_D_g2g_to_display:null,frozen_Origin_Data_to_display:null};const a=Sl(s.id);return a?(i=!1,t=a.angleRad,n=dt!==null?dt:a.length,kt!==null?Math.abs(kt)<re?o=Fi:o=Math.abs(kt):o=Fi):(i=!0,st!=="none"&&j.interval1?n=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1:n=na,dt!==null&&(n=dt),t=0,o=Fi),{offsetAngleRad:t,currentSegmentReferenceD:n,currentSegmentReferenceA_for_display:o,isFirstSegmentBeingDrawn:i,displayAngleA_valueRad_for_A_equals_label:kt,displayAngleA_originVertexData_for_A_equals_label:Dn,frozen_A_baseRad_to_display:Wn,frozen_D_du_to_display:dt,frozen_D_g2g_to_display:qn}}function Or(e,t,n){if(!e||!t)return null;const o=Math.atan2(t.y-e.y,t.x-e.x),i=J(e,t);let s=0,a=!0;for(let c=n.length-1;c>=0;c--){const l=n[c];let d=null;if(l.id1===e.id&&q(l.id2)?.type==="regular"?d=l.id2:l.id2===e.id&&q(l.id1)?.type==="regular"&&(d=l.id1),d&&d!==t.id){const h=q(d);if(h){s=Math.atan2(e.y-h.y,e.x-h.x),a=!1;break}}}const r=nt(o-s);return{startVertex:e,endVertex:t,absoluteAngleRad:o,length:i,precedingSegmentAbsoluteAngleRad:s,turnAngleRad:r,isFirstSegmentOfLine:a}}function Pl(e,t){const n=new Set,o=[e],i=new Set([e]);for(;o.length>0;){const s=o.shift(),a=t.find(r=>r.id===s);a&&(a.vertexIds.forEach(r=>n.add(r)),a.childFaceIds&&a.childFaceIds.forEach(r=>{i.has(r)||(i.add(r),o.push(r))}))}return Array.from(n)}function lf(){const e=le.filter(i=>{const s=q(i);return s&&s.type==="regular"});if(e.length<2)return;Ge();const t=JSON.parse(JSON.stringify(U));let n=!1;const o=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;for(let i=0;i<e.length;i++)for(let s=i+1;s<e.length;s++){const a=e[i],r=e[s];if(!U.some(l=>l.id1===a&&l.id2===r||l.id1===r&&l.id2===a)){const l=q(a),d=q(r);if(l&&d){const h=gs(l,d,o,Pe);bs(h),U.push(h),n=!0}}}n&&kn&&(vs(t,U),Z.forEach(i=>{i.color||(i.color=Pe(we))}),Ms()),Ot()}function Ct(e=[],t=[],n=[],o,i,s=!1,a=[]){s?za(e[0],o,i):o?(le=[...new Set([...le,...e])],ie=[...new Set([...ie,...t])],se=[...new Set([...se,...n])],ye=[...new Set([...ye,...a])]):i?(e.forEach(r=>{const c=le.indexOf(r);c>-1?le.splice(c,1):le.push(r)}),t.forEach(r=>{const c=ie.indexOf(r);c>-1?ie.splice(c,1):ie.push(r)}),n.forEach(r=>{const c=se.indexOf(r);c>-1?se.splice(c,1):se.push(r)}),a.forEach(r=>{const c=ye.indexOf(r);c>-1?ye.splice(c,1):ye.push(r)})):(le=[...e],ie=[...t],se=[...n],ye=[...a])}function cf(e,t,n,o,i=0){const s={x:n.x-e.x,y:n.y-e.y},a={x:t.x-e.x,y:t.y-e.y},r=Math.hypot(s.x,s.y),c=Math.hypot(a.x,a.y),l=Math.atan2(s.y,s.x),d=Math.atan2(a.y,a.x);let h=0,f=1,u=!1;if(o===Kt)f=1,h=Tr(l,d,i);else if(o===Rn)h=0,r>re&&(f=c/r);else if(o===sn)h=Tr(l,d,i),r>re&&(f=c/r);else if(o===Jn&&(u=!0,h=0,r>re)){const g={x:s.x/r,y:s.y/r};f=(a.x*g.x+a.y*g.y)/r}return{rotation:h,scale:f,directionalScale:u}}function vs(e,t){if(!kn){Z=[],Ys.clear();return}const n=new Set(e.map(p=>ne(p))),o=new Set(t.map(p=>ne(p))),i=t.filter(p=>!n.has(ne(p))),s=e.filter(p=>!o.has(ne(p)));if(i.length===0&&s.length===0)return;const a=new Set;i.forEach(p=>{a.add(p.id1),a.add(p.id2)}),s.forEach(p=>{a.add(p.id1),a.add(p.id2)});const r=new Set,c=new Set;for(const p of a)c.has(p)||_o(p).forEach(x=>{r.add(x),c.add(x)});const l=U.filter(p=>r.has(p.id1)&&r.has(p.id2)),d=Z.filter(p=>p.vertexIds.every(y=>r.has(y))),h=wi(l,q),f=new Set(d.map(p=>p.id));Z=Z.filter(p=>!f.has(p.id));let u=h;if(h.length>1){const p=h.map(y=>{const x=y.vertexIds.map(m=>q(m));return x.some(m=>!m)?null:{face:y,area:Math.abs(Ci(x))}}).filter(Boolean);if(p.length>1){p.sort((m,S)=>S.area-m.area);const y=p[0],x=p.slice(1).reduce((m,S)=>m+S.area,0);Math.abs(y.area-x)<re&&(u=p.slice(1).map(m=>m.face))}}const g=new Set(i.map(p=>ne(p)));u.forEach(p=>{let y=!1;if(i.length>0)for(let m=0;m<p.vertexIds.length;m++){const S=p.vertexIds[m],I=p.vertexIds[(m+1)%p.vertexIds.length],b=ne({id1:S,id2:I});if(g.has(b)){y=!0;break}}if(Ys.has(p.id))if(y)Ys.delete(p.id);else return;const x=he[we];if(x!==-1){const m=ue[x];m&&m.type==="colormap"?(p.colormapItem=m,p.colormapDistribution="x",delete p.color):(p.color=Pe(we),delete p.colormapItem,delete p.colormapDistribution)}else p.color=Pe(we),delete p.colormapItem,delete p.colormapDistribution;p.parentFaceId=null,p.childFaceIds=[],Z.push(p)}),Ms()}function _l(e,t,n,o){const i=q(e.id1),s=q(e.id2);if(!i||!s)return null;const a=[...U],r={id:Lt(),x:t.x,y:t.y,type:"regular",color:o(_e)};ae.push(r),U=U.filter(d=>ne(d)!==ne(e));const c=gs(i,r,n,o),l=gs(r,s,n,o);return bs(c),bs(l),U.push(c),U.push(l),kn&&vs(a,U),r}function df(e,t,n,o,i){const s=He(n,e,o,i,!1,null),a={x:n.x-e.x,y:n.y-e.y},r=2*Fe/oe.scale,c=t.filter(d=>d.type==="regular"),l=[];if(c.length>0){const d=ae.filter(f=>f.type==="regular"&&!t.some(u=>u.id===f.id)),h=parseInt(Rt||"1",10)||1;for(let f=1;f<=h;f++)c.forEach(u=>{d.forEach(g=>{const p={x:u.x-e.x,y:u.y-e.y},y={x:g.x-e.x,y:g.y-e.y},x=Math.hypot(p.x,p.y),m=Math.hypot(y.x,y.y);if(x>re){const S=Math.pow(m/x,1/f);let I=Math.atan2(y.y,y.x)-Math.atan2(p.y,p.x);const M=(I+Math.round((o*f-I)/(2*Math.PI))*(2*Math.PI))/f,C=He(n,e,M,S,!1,a),w=J(s,C);l.push({dist:w,rotation:M,scale:S,pos:C})}})})}if(l.length>0){const d=l.sort((h,f)=>h.dist-f.dist)[0];if(d.dist<r)return{...d,snapped:!0,snapType:"merge",snappedScaleValue:d.scale}}if(ke){const d=[],h=[],f=Ea.flatMap(m=>{const S=m*Math.PI/2;return S===0?[0]:[S,-S]}).sort((m,S)=>Math.abs(nt(o-m))-Math.abs(nt(o-S))),u=$n.filter(m=>m>0).sort((m,S)=>Math.abs(i-m)-Math.abs(i-S)),g=f.slice(0,2),p=u.slice(0,2);g.forEach(m=>{p.forEach(S=>{const I=m+Math.round((o-m)/(2*Math.PI))*(2*Math.PI),b=He(n,e,I,S,!1,a);d.push({dist:J(s,b),rotation:I,scale:S,pos:b})})});const y=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;if(y){const m=Gn(s,st,y,on,!0),S=Math.hypot(a.x,a.y);m.forEach(I=>{if(S>re){const b={x:I.x-e.x,y:I.y-e.y},M=Math.hypot(b.x,b.y)/S,C=Math.atan2(b.y,b.x)-Math.atan2(a.y,a.x),w=C+Math.round((o-C)/(2*Math.PI))*(2*Math.PI);h.push({dist:J(s,I),rotation:w,scale:M,pos:I})}})}const x=[...d,...h].sort((m,S)=>m.dist-S.dist)[0];return{...x,snapped:!0,snapType:"geometric",snappedScaleValue:x.scale}}return{rotation:o,scale:i,pos:s,snapped:!1}}function hf(e,t,n,o,i){const s=parseInt(Rt||"1",10);let a=[];const r=Math.hypot(n.x-e.x,n.y-e.y),c=2*Fe/oe.scale,l=t.filter(p=>p.type==="regular"),d=ae.filter(p=>p.type==="regular"&&!t.some(y=>y.id===p.id));if(Array.from({length:s},(p,y)=>y+1).forEach(p=>{l.forEach(y=>{d.forEach(x=>{const m={x:y.x-e.x,y:y.y-e.y},S={x:x.x-e.x,y:x.y-e.y};if(Math.abs(Math.hypot(m.x,m.y)-Math.hypot(S.x,S.y))<re){let I=Math.atan2(S.y,S.x)-Math.atan2(m.y,m.x);const b=I+Math.round((o*p-I)/(2*Math.PI))*(2*Math.PI);a.push({rotation:b/p,priority:Math.abs(nt(b/p-o)),snapType:"merge"})}})})}),ke){Ea.flatMap(m=>{const S=m*Math.PI/2;return S===0?[0]:[S,-S]}).forEach(m=>{const S=Math.abs(nt(o-m)),I=m+Math.round((o-m)/(2*Math.PI))*(2*Math.PI);a.push({rotation:I,priority:S,snapType:"geometric"})});const y=new Set(t.map(m=>m.id));let x=ae.filter(m=>m.type==="regular"&&!y.has(m.id));if(j){const m=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;m&&x.push(...Gn(i,st,m,on,!0))}x.forEach(m=>{const S=J(i,m);if(S<ma/oe.scale){const I=Math.atan2(n.y-e.y,n.x-e.x),b=Math.atan2(m.y-e.y,m.x-e.x),M=nt(b-I),C=M+Math.round((o-M)/(2*Math.PI))*(2*Math.PI);a.push({rotation:C,priority:S/1e3,snapType:"projection",projectionSource:m})}})}if(a.length===0)return{rotation:o,snapped:!1,snapType:null};a.sort((p,y)=>p.priority-y.priority);const f=a[0];if(f.snapType==="merge"){const p=He(n,e,f.rotation,1,!1,null);if(J(i,p)>c)return{rotation:o,snapped:!1,snapType:null}}const u=He(n,e,f.rotation,1,!1,null);let g=null;return f.snapType==="projection"&&(g={x:e.x+r*Math.cos(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation),y:e.y+r*Math.sin(Math.atan2(n.y-e.y,n.x-e.x)+f.rotation)}),{rotation:f.rotation,pos:u,snapped:!0,snapType:f.snapType,projectionSource:f.projectionSource||null,projectionPoint:g}}function ff(e,t,n,o){const i=Ee(K),s=2*Fe/oe.scale,a=t.filter(c=>c.type==="regular"),r=[];if(a.length>0){const c=ae.filter(h=>h.type==="regular"&&!t.some(f=>f.id===h.id)),l=s/100,d=parseInt(Rt||"1",10);for(let h=1;h<=d;h++)a.forEach(f=>{c.forEach(u=>{const g={x:f.x-e.x,y:f.y-e.y},p={x:u.x-e.x,y:u.y-e.y},y=Math.hypot(g.x,g.y),x=Math.hypot(p.x,p.y);if(y>re){const m=Math.atan2(g.y,g.x),S=Math.atan2(p.y,p.y);if(Math.abs(nt(m-S))<l){const I=Math.pow(x/y,1/h),b=He(n,e,0,I,!1,null);r.push({scale:I,dist:J(i,b)})}}})})}if(r.length>0){const c=r.sort((l,d)=>l.dist-d.dist)[0];if(c.dist<s){const l=He(n,e,0,c.scale,!1,null);return{...c,pos:l,snapped:!0,snapType:"merge"}}}if(ke){let c,l,d=1,h=1/0;$n.forEach(p=>{const y=Math.abs(o-p);y<h&&(h=y,d=p)});const f=He(n,e,0,d,!1,null);c={scale:d,pos:f,dist:J(i,f),snapType:"geometric",snappedScaleValue:d};const u=new Set(t.map(p=>p.id)),g=ae.filter(p=>p.type==="regular"&&!u.has(p.id));if(j){const p=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;p&&g.push(...Gn(i,st,p,on,!0))}if(g.length>0){const p=g.reduce((m,S)=>J(i,m)<J(i,S)?m:S),y=Math.hypot(n.x-e.x,n.y-e.y),x=J(e,p);if(y>re){const m=x/y,S=Math.atan2(n.y-e.y,n.x-e.x),I={x:e.x+x*Math.cos(S),y:e.y+x*Math.sin(S)};l={scale:m,pos:I,dist:J(i,I),snapType:"projection",snappedScaleValue:m,projectionSource:p}}}return l&&J(i,l.projectionSource)<s?{...l,snapped:!0}:{...c,snapped:!0}}return{scale:o,snapped:!1,snapType:null}}function uf(e,t,n,o,i,s){let a=[];const r=2*Fe/oe.scale;if(t.filter(l=>l.type==="regular"),ke){let l=null,d=null,h=1,f=1/0;[...$n,...$n.map(x=>-x)].forEach(x=>{const m=Math.abs(o-x);m<f&&(f=m,h=x)});const g=He(n,e,0,h,!0,i);l={scale:h,pos:g,dist:J(s,g),snapType:"geometric",snappedScaleValue:h};const p=new Set(t.map(x=>x.id)),y=ae.filter(x=>x.type==="regular"&&!p.has(x.id));if(j){const x=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;x&&y.push(...Gn(s,st,x,on,!0))}if(y.length>0){const x=y.reduce((S,I)=>J(s,I)<J(s,S)?I:S),m=Math.hypot(i.x,i.y);if(m>re){const S={x:i.x/m,y:i.y/m},I=M=>(M.x-e.x)*S.x+(M.y-e.y)*S.y,b=I(n);if(Math.abs(b)>re){const C=I(x)/b,w=He(n,e,0,C,!0,i);d={scale:C,pos:w,dist:J(s,w),snapType:"projection",snappedScaleValue:C,projectionSource:x}}}}d&&J(s,d.projectionSource)<r?a.push({...d,priority:0}):a.push({...l,priority:1})}return a.length===0?{scale:o,snapped:!1,snapType:null}:{...a.sort((l,d)=>l.priority-d.priority)[0],snapped:!0}}function pf(e){const t=fe.width/Ve,n=fe.height/Ve,{grid1Interval:o,grid2Interval:i,alpha1:s,alpha2:a}=Od(oe.scale);j={interval1:o,interval2:i,alpha1:s,alpha2:a,scale:oe.scale},on=Nd(oe,t,n,xe),jd(Me,{gridDisplayMode:st,canvas:fe,dpr:Ve,viewTransform:oe,gridAlpha:kh,colors:e},xe,Ee,j,on);let r={useScientific:!1};return xs!==vi&&(r=Gd(Me,tt,{canvas:fe,dpr:Ve,coordsDisplayMode:xs,viewTransform:oe,angleDisplayMode:nn,colors:e},xe,Ee,j,on,xt)),r}function gf(e){const t=Ne&&ce.length===1&&!Xe&&ce[0].type==="regular";if(ra.forEach(n=>{Ne&&ce.length>0&&[...n].some(i=>ce.some(s=>s.id===i))||zh(n,e,!1,[],0)}),ae.forEach(n=>{if(n.type!=="regular"){const o=Ne&&ce.some(c=>c.id===n.id);let i=n,s=!1,a=o?0:void 0;if(o&&!t&&Se.length>0){const c=Se.find(l=>l&&l.originalId===n.id&&l.transformIndex===0);c&&(i=c)}if(gt){const c=n.originalId||n.id;gt.has(c)&&gt.get(c).find(h=>h.copyIndex===a)&&(s=!0)}const r={selectedVertexIds:[],selectedCenterIds:Ie,activeCenterId:Ye,colors:e,verticesVisible:!0,isHovered:un===n.id&&!_t,isSnapped:s,snappedVertexIds:gt,isDragConfirmed:Ne,dragPreviewVertices:Se,currentAltPressed:_t};ni(Me,i,r,xe)}}),Ne){const o={copyCount:parseInt(Rt||"1",10),isDragConfirmed:Ne,initialDragVertexStates:ce,dragPreviewVertices:Se,transformIndicatorData:Xe,allEdges:U,allFaces:Z,findVertexById:q,findAllVerticesInSubgraph:i=>_o(i),colors:e,edgeColorMode:At,faceColorMode:Oe,edgeColorExpression:wn,faceColorExpression:Vn,faceColorPolarExpression:Yn,snappedEdgesInfo:Ss,snappedVertexIds:gt};t?Yd(Me,o,xe):Vd(Me,o,xe)}}function yf(e,t){dh(tt,{coordsDisplayMode:xs,isMouseOverCanvas:xo,currentShiftPressed:ke,ghostVertexPosition:Be,gridDisplayMode:st,lastGridState:j,angleDisplayMode:nn,canvas:fe,dpr:Ve,mousePos:K,colors:e,useScientific:t.useScientific},Ee,xt),Oh();const n={dpr:Ve,canvasUI:z,isToolbarExpanded:rs,isColorPaletteExpanded:ot,isColorModePanelExpanded:en,isInterpolationPanelExpanded:Qt,isTransformPanelExpanded:In,isDisplayPanelExpanded:hn,isVisibilityPanelExpanded:Fa,isSessionsPanelExpanded:pt,isPlacingTransform:Vt,placingTransformType:js,placingSnapPos:Co,mousePos:K,allColors:ue,activeThemeName:fi,colors:e,verticesVisible:ai,edgesVisible:ri,facesVisible:kn,coordsDisplayMode:xs,gridDisplayMode:st,angleDisplayMode:nn,distanceDisplayMode:zo,namedColors:Nn.namedColors,colorAssignments:he,activeColorTargets:ze,interpolationStyles:fn,activeInterpolationStyleId:vo,sessions:Te,activeSessionIndex:$t,selectedSessionIndex:yt,edgeColorMode:At,faceColorMode:Oe,edgeColorExpression:wn,faceColorExpression:Vn,faceColorPolarExpression:Yn,isDraggingColorTarget:$s,draggedColorTargetInfo:wt};n.selectedInterpolationStyleId=Fh(),Th(Me,tt,n,xt)}function Al(){$a.clear();const e=Va();Bd(Me,{canvas:fe,dpr:Ve,colors:e});const t=pf(e);gf(e),jr(Me,{allFaces:Z,hoveredFaceId:pn,selectedFaceIds:se,colors:e,isDragConfirmed:Ne,dragPreviewVertices:Se,currentAltPressed:_t},xe,q,ge),se.length>0&&il(Me,{allFaces:Z,selectedFaceIds:se,colors:e,isDragConfirmed:Ne,dragPreviewVertices:Se,initialDragVertexStates:ce,transformIndicatorData:Xe,highlightedEdgeForSnap:vn,draggedFaceId:Mo,coordSystemSnapAngle:Us,coordSystemSnapType:ms,coordSystemSnapScale:Sn,initialCoordSystemStates:ys},xe,q),Qf(e),Yh(e),Jd(Me,{altHoverInfo:Ke,colors:e},xe,q,xt),yf(e,t),Bh()}function Dl(){if(!Ce||Ce.length<2)return;const e=he[_e];if(e===-1)return;const t=ue[e];if(!t||t.type!=="colormap")return;const n=Ce.length;Ce.forEach((o,i)=>{const s=q(o);if(s&&s.type==="regular"){const a=n>1?i/(n-1):.5;s.color=Ae(t,a)}})}function kl(){if(!Ce||Ce.length<2)return;const e=he[Re];if(e===-1)return;const t=ue[e];if(!t||t.type!=="colormap")return;const o=Ce.length-1;for(let i=0;i<o;i++){const s=Ce[i],a=Ce[i+1],r=U.find(c=>c.id1===s&&c.id2===a||c.id1===a&&c.id2===s);if(r){const c=i/o,l=(i+1)/o;r.gradientStart=c,r.gradientEnd=l,r.colormapItem=t,delete r.colormapOffset,delete r.color}}}function mf(e,t,n){if(!ot)return!1;const o=z.removeColorButton;if(o&&e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height){if(ue.length>1&&ze.length>0){const s=ze[ze.length-1],a=he[s];a>=0&&(Ge(),Ha(a))}return!0}const i=z.addColorButton;return i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height?(ci=!1,lo=null,Nn.show(),!0):!1}function Kn(){if(Ft&&clearTimeout(Ft),Rt="",Ft=null,hs&&(ue=Pt.originalAllColors,he=Pt.originalAssignments,at(),ft.length>0&&ft.pop(),hs=!1,Pt=null,es=!1),Ue){Ue=!1,it=null,kt=null,Wn=null,dt=null,qn=null,Dn=null,Ze=[],Gt=0,Ce=[],ii=null;return}Vt&&(Vt=!1,js=null,Co=null),le=[],ie=[],se=[],Ie=[],ye=[],Ye=null,ze=[],ot&&at(),dn=null,Bt=!1,Ne=!1,Un=!1,li=!1,Vs=!1,ds=!1,Se=[],ce=[],di=null,gn=-1,de={targetId:null,type:null,count:0,timestamp:0},fe.style.cursor="crosshair",Xe=null,Is=[],Be=null,vn=null,Us=null,Mo=null,ms=null,dn=null,Ke=null}function xf(){if(!Ue||!it||Ze.length===0)return;Ge();const e=q(it);if(!e){Kn();return}const t=Sl(e.id);if(!t){Kn();return}const n=t.angleRad;if(Ze.length===1)return;const o=Ze.length-1,i=(Gt-1)%o+1,s=Ze[i],a=s.length;let r;if(i===Ze.length-1){const x=Ze.length>2?1:0;r=Ze[x].turn}else r=s.turn;let c,l;if(i===Ze.length-1){const x=[Ze[0].endVertexColor,Ze[1].endVertexColor],m=(Gt-1)%x.length;l=x[m];const S=Gt%x.length;c=x[S],e.color=l}else c=s.endVertexColor;const d=bn(n+r),h=e.x+a*Math.cos(d),f=e.y+a*Math.sin(d);let u=null,g=!1;const p=Fe*2/oe.scale;for(const x of ae)if(x.type==="regular"&&J({x:h,y:f},x)<p){u=x,g=!0;break}g||(u={id:Lt(),x:h,y:f,type:"regular",color:c},ae.push(u)),U.some(x=>x.id1===e.id&&x.id2===u.id||x.id2===e.id&&x.id1===u.id)||U.push({id1:e.id,id2:u.id,color:Pe(Re)}),kn&&(Z=wi(U,q),Ms()),Ce.push(u.id),window.currentDrawingPath=Ce,Dl(),kl(),it=u.id,Gt++,Gt>=Ze.length&&(Gt=1),dt=null,qn=null,kt=null,Wn=null,Dn=null}function Rl(){Al(),requestAnimationFrame(Rl)}function Sf(e){if(se.length===0)return!1;const t=to(e,fe);for(const n of se){const o=Z.find(s=>s.id===n);if(!o||!o.localCoordSystem)continue;const i=yd(t,o,xe);if(i)return jn=!0,an=i,Mo=o.id,ui=If(o),i.type==="center"&&(o.localCoordSystem.isCustom=!0),e.preventDefault(),!0}return!1}function If(e){const t=[],n=[],o=[],i=[],s=[];e.vertexIds.forEach(a=>{const r=q(a);r&&r.type==="regular"&&t.push({...r,id:a})});for(let a=0;a<t.length;a++){const r=t[a],c=t[(a+1)%t.length];n.push({x:(r.x+c.x)/2,y:(r.y+c.y)/2,v1:r.id,v2:c.id}),o.push(r.id,c.id),s.push(Math.atan2(c.y-r.y,c.x-r.x))}return Z.forEach(a=>{a.id!==e.id&&a.localCoordSystem&&i.push(a.localCoordSystem.origin)}),{vertices:t,edgeMidvertices:n,edgeVertexIds:o,faceCenters:i,edgeAngles:s}}function ga(e,t){const n=e.vertexIds[t],o=e.vertexIds[(t+1)%e.vertexIds.length],i=q(n),s=q(o);return i&&s?{v1Id:n,v2Id:o,edgeAngle:Math.atan2(s.y-i.y,s.x-i.x)}:null}function bf(e,t){if(e.length===0||t&&t.transformType===Kt||!t)return;const i=new Set;e.forEach(a=>{ua(a).forEach(r=>i.add(r))});const s=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;i.forEach(a=>{const r=q(a.id1),c=q(a.id2);if(!r||!c)return;const l=r.x-c.x,d=r.y-c.y,h=l/s,f=d/s,u=1e-5;if(s&&Math.abs(h-Math.round(h))<u&&Math.abs(f-Math.round(f))<u){a.labelMode="exact";const p=Math.round(h),y=Math.round(f);a.exactValue={g2gSquaredSum:p*p+y*y,gridInterval:s}}else a.labelMode="decimal",delete a.exactValue})}function vf(){if(Dt){Ge();let e=Z.find(t=>t.id===Dt);if(e)e.color=Pe(we),mi();else{const n=wi(U,q).find(o=>o.id===Dt);n&&(n.color=Pe(we),Z.push(n),mi(),Ms())}Dt=null}ht.style.display="none"}function Mf(e,t){const n=[],o=t.find(a=>a.id===e);if(!o)return[];const i=[...o.childFaceIds||[]],s=new Set(o.childFaceIds);for(;i.length>0;){const a=i.shift(),r=t.find(c=>c.id===a);r&&(n.push(r),r.childFaceIds&&r.childFaceIds.forEach(c=>{s.has(c)||(s.add(c),i.push(c))}))}return n}function Cf(e,t,n,o,i){if(!t.isCustom){const l=e.vertexIds.map(d=>o.find(h=>h.id===d)||i(d)).filter(d=>d&&d.type==="regular");if(l.length>=3){const d=Ei(l);d&&(e.localCoordSystem.origin=d.center,e.localCoordSystem.scale=d.radius)}return}let s={...t.origin},a=t.angle,r=t.scale;if(e.localCoordSystem.attachedToVertex){const l=o.find(d=>d.id===e.localCoordSystem.attachedToVertex);l&&(s={x:l.x,y:l.y})}else if(e.localCoordSystem.attachedToEdge){const l=o.find(h=>h.id===e.localCoordSystem.attachedToEdge.v1)||i(e.localCoordSystem.attachedToEdge.v1),d=o.find(h=>h.id===e.localCoordSystem.attachedToEdge.v2)||i(e.localCoordSystem.attachedToEdge.v2);l&&d&&(s={x:l.x+e.localCoordSystem.attachedToEdge.t*(d.x-l.x),y:l.y+e.localCoordSystem.attachedToEdge.t*(d.y-l.y)})}if(e.localCoordSystem.rotationAlignedToEdge){const l=o.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v1)||i(e.localCoordSystem.rotationAlignedToEdge.v1),d=o.find(h=>h.id===e.localCoordSystem.rotationAlignedToEdge.v2)||i(e.localCoordSystem.rotationAlignedToEdge.v2);if(l&&d){const h=Math.atan2(d.y-l.y,d.x-l.x),f=e.localCoordSystem.rotationAlignedToEdge.originalAngle,g=e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle-f;a=bn(h+g),e.localCoordSystem.rotationAlignedToEdge.originalAngle=h,e.localCoordSystem.rotationAlignedToEdge.originalSystemAngle=a}}if(e.localCoordSystem.scaleAttachedToEdge){const l=o.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v1)||i(e.localCoordSystem.scaleAttachedToEdge.v1),d=o.find(h=>h.id===e.localCoordSystem.scaleAttachedToEdge.v2)||i(e.localCoordSystem.scaleAttachedToEdge.v2);if(l&&d){const h=J(l,d);r=h*e.localCoordSystem.scaleAttachedToEdge.scaleRatio,e.localCoordSystem.scaleAttachedToEdge.originalLength=h}}const c=e.vertexIds.map(l=>o.find(d=>d.id===l)||i(l)).filter(l=>l&&l.type==="regular");c.length>=3&&(e.localCoordSystem.origin=qs(s,c),e.localCoordSystem.angle=a,e.localCoordSystem.scale=Math.max(.01,r),e.localCoordSystem.isCustom=!0)}function Ef(e,t){const n=new Map;return e.forEach(o=>{const i=[...new Set(o.vertexIds.map(s=>t(s)))];if(i.length>=3){const s=ge({vertexIds:i});if(o.localCoordSystem&&o.localCoordSystem.isCustom){const a=JSON.parse(JSON.stringify(o.localCoordSystem));a.attachedToVertex&&(a.attachedToVertex=t(a.attachedToVertex)),a.attachedToEdge&&(a.attachedToEdge.v1=t(a.attachedToEdge.v1),a.attachedToEdge.v2=t(a.attachedToEdge.v2)),a.rotationAlignedToEdge&&(a.rotationAlignedToEdge.v1=t(a.rotationAlignedToEdge.v1),a.rotationAlignedToEdge.v2=t(a.rotationAlignedToEdge.v2)),a.scaleAttachedToEdge&&(a.scaleAttachedToEdge.v1=t(a.scaleAttachedToEdge.v1),a.scaleAttachedToEdge.v2=t(a.scaleAttachedToEdge.v2)),n.set(s,a)}}}),n}function wf(e){ht.innerHTML="",ht.style.display="none",K=to(e,fe);const t=Ks(K),n=t?null:Js(K),o=!t&&!n?Zs(K):null;if(t||n||o){let d=!1;t?d=le.includes(t.id):n?d=ie.includes(ne(n)):o&&(d=se.includes(ge(o))),d||(le=[],ie=[],se=[],Ie=[],ye=[],t?le=[t.id]:n?ie=[ne(n)]:o&&(se=[ge(o)]))}else Kn();const s=Ee(K);let a=[];Dt=null,Ls=null,Rs=null;const r=(le.length>0?1:0)+(ie.length>0?1:0)+(se.length>0?1:0),c=Ks(K),l=c?null:Js(K);if(c&&c.type==="regular"){Rs=c.id;const d=r>1?"Remove Geometry":"Remove Vertex";a.push({text:d,handler:Ff})}else if(l){Ls=ne(l);const d=r>1?"Remove Geometry":"Remove Edge";a.push({text:d,handler:$f})}else{const d=Zs(K);if(d){Dt=ge(d);const h=r>1?"Remove Geometry":"Remove Face";a.push({text:h,handler:Vf}),d.childFaceIds&&d.childFaceIds.length>0&&a.push({text:"Remove Face and Children",handler:Bf})}else{const h=wi(U,q);let f=null,u=1/0;h.forEach(g=>{const p=g.vertexIds.map(y=>q(y));if(p.every(Boolean)&&ps(s,p)){const y=Math.abs(Ci(p));y<u&&(u=y,f=g)}}),f&&(Dt=f.id||ge(f),a.push({text:"Add Face",handler:vf}))}}if(a.length>0){const d=document.createElement("ul");a.forEach(h=>{const f=document.createElement("li");f.textContent=h.text,f.addEventListener("click",h.handler),d.appendChild(f)}),ht.appendChild(d),ht.style.left=`${e.clientX-ar}px`,ht.style.top=`${e.clientY-ar}px`,ht.style.display="block"}}function Tf(e){if(hn){for(const t of z.displayIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){switch(t.group){case"coords":const n=[vi,wa,uo,Mi];xs=n[(n.indexOf(xs)+1)%n.length];break;case"grid":const o=[Ta,Pa,_a,Aa,Io];st=o[(o.indexOf(st)+1)%o.length];break;case"angles":const i=[us,bo,po];nn=i[(i.indexOf(nn)+1)%i.length],On=nn!==po;break;case"distances":const s=[go,nd];zo=s[(s.indexOf(zo)+1)%s.length],xn=zo===go;break;case"theme":Rf();break}return!0}}return!1}function Pf(e){if(!Qt)return!1;for(const t of z.interpolationIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.type==="interpolationRemove")return ie.length>0||se.length>0||le.length>0?Vh():fa(An.id),!0;if(t.type==="interpolationAdd")return ks?.initialize?.(),ks?.show(),!0;if(t.type==="interpolationStyle"){const n=Date.now();if(Vo.id===t.styleId&&n-Vo.timestamp<jo){const i=gi(t.styleId);return i&&(ks?.initialize?.(),ks?.show(i)),Vo={id:null,timestamp:0},!0}return Vo={id:t.styleId,timestamp:n},(ie.length>0||se.length>0||le.length>0)&&$h(t.styleId),fa(t.styleId),!0}}return!1}function _f(e){if(!en)return!1;for(const t of z.colorModeIcons)if(e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height){if(t.group==="edge"){const n=["fixed","inherit_vertices","colormap"];At=n[(n.indexOf(At)+1)%n.length]}else if(t.group==="face"){const n=["fixed","inherit_vertices","inherit_edges","colormap_xy","colormap_polar"];Oe=n[(n.indexOf(Oe)+1)%n.length]}return Pi(),cl(),at(),ml(),Yt(),!0}return!1}function Af(e,t=!1,n=!1){const o=z.toolbarButton;if(e.x>=o.x&&e.x<=o.x+o.width&&e.y>=o.y&&e.y<=o.y+o.height)return rs=!rs,rs?yl():(ot=!1,en=!1,Qt=!1,In=!1,hn=!1,Fa=!1,pt=!1,ze=[]),!0;if(rs){const i=z.colorToolButton;if(i&&e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return Nf(),!0;const s=z.colorModeToolButton;if(s&&e.x>=s.x&&e.x<=s.x+s.width&&e.y>=s.y&&e.y<=s.y+s.height)return en=!en,en&&ml(),!0;const a=z.interpolationToolButton;if(a&&e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height)return Qt=!Qt,Qt&&xl(),!0;const r=z.transformToolButton;if(r&&e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return In=!In,In&&Uh(),!0;const c=z.visibilityToolButton;if(c&&e.x>=c.x&&e.x<=c.x+c.width&&e.y>=c.y&&e.y<=c.y+c.height)return hn=!hn,hn&&qh(),!0;const l=z.sessionsToolButton;if(l&&e.x>=l.x&&e.x<=l.x+l.width&&e.y>=l.y&&e.y<=l.y+l.height)return pt=!pt,pt&&(yt=$t,_i()),!0}if(ot&&mf(e)||en&&_f(e)||Qt&&Pf(e))return!0;if(In){for(const i of z.transformIcons)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return Vt?js=i.type:(Vt=!0,js=i.type,fe.style.cursor="none"),!0}if(hn&&Tf(e))return!0;if(pt&&z.sessionsPanelBounds){const i=z.sessionsPanelBounds;if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return sf(),!0}return!!Ga(e)}function Df(){if(ft.length===0)return;const e=To();ue.length,ue[0]?.value,ae.length,Xn.push(e),Xn.length>Ca&&Xn.shift();const t=ft.pop();wo(t),ue.length,ue[0]?.value,ae.length,Ot()}function kf(){if(Xn.length===0)return;const e=To();ft.push(e),ft.length>Ca&&ft.shift();const t=Xn.pop();wo(t),Ot()}function ja(e,t){const n=Ee(e),o=Ks(e),i=o?null:Js(e),s=!o&&!i?Zs(e):null;if(o)Ke={point:{x:o.x,y:o.y},element:{type:"vertex",id:o.id},shiftKey:t};else if(i){const a=q(i.id1),r=q(i.id2);if(a&&r){let c,l;const d=bt(n,a,r);if(t){const h=Ed(d,a,r);c=h.point,l=h.fraction}else c={x:d.x,y:d.y},l=d.t;Ke={point:c,element:{type:"edge",edge:i},shiftKey:t,fraction:l}}}else s?Ke={point:n,element:{type:"face",id:ge(s)},shiftKey:t}:Ke=null;un=null,En=null,pn=null}function Rf(){Ge(),fi=fi==="dark"?"light":"dark",Gh(),ot&&at()}function Lf(e){if(!jn||!an)return!1;const t=to(e,fe),n=Ee(t),o=an,i=o.face,s=i.localCoordSystem,a=i.vertexIds.map(r=>q(r)).filter(r=>r&&r.type==="regular"&&r.x!==void 0&&r.y!==void 0);if(o.type==="center"){let r,c={snapped:!1};if(e.shiftKey){if(c=bd(n,ui,st,j,on),c.snapped){if(r=c.snapPoint,c.snapType==="edge"){const l=c.edgeInfo,d=q(l.v1),h=q(l.v2);d&&h&&(r=c.snapPoint,dn=null)}}else{const l=Ei(a);r=l?l.center:a[0]}o.type==="center"&&(Be=r)}else r=n,Be=null,dn=null;a.length>0&&a.every(l=>l&&l.x!==void 0&&l.y!==void 0)&&(r=qs(r,a),Be&&(Be=qs(Be,a))),s.origin.x=r.x,s.origin.y=r.y,s.isCustom=!0,c.snapped?(s.attachedToVertex=c.vertexId||null,s.attachedToEdge=c.edgeInfo||null):(s.attachedToVertex=null,s.attachedToEdge=null)}else if(o.type==="x_axis"||o.type==="y_axis"){const r={x:n.x-s.origin.x,y:n.y-s.origin.y};let c=Math.atan2(r.y,r.x),l=Math.hypot(r.x,r.y);if(vn=null,Us=null,ms=null,Is=[],Be=null,dn=null,Sn=null,e.shiftKey){const d=Sd(n,s.origin,!0,ui);if(d.snapped){c=d.angle,Us=c,ms=d.snapType;const h={x:Math.cos(c),y:Math.sin(c)},f={x:n.x-s.origin.x,y:n.y-s.origin.y},u=f.x*h.x+f.y*h.y;if(d.snapType==="vertex_direction"){const g=q(d.targetVertexId);g&&(l=J(s.origin,g),Sn=l)}else if(d.edgeIndex!==null){vn=d.edgeIndex;const g=ga(i,d.edgeIndex);if(g){const p=Math.abs(nt(c-g.edgeAngle))>Math.PI/4&&Math.abs(nt(c-g.edgeAngle))<3*Math.PI/4;if(o.type==="x_axis"&&p){const y=q(g.v1Id),x=q(g.v2Id);if(y&&x){const m=Gr(s.origin,y,x),S=m.distance,I=[.25,1/3,.5,2/3,.75,1];let b={scale:u,dist:1/0,fraction:null};I.forEach(C=>{const w=S*C,_=Math.abs(u-w);_<b.dist&&(b={scale:w,dist:_,fraction:C})});const M=15/oe.scale;b.dist<M?(l=b.scale,Sn=l,dn={orthogonalDistanceFraction:b.fraction,v1:y,v2:x,snapPosition:{origin:s.origin,closest:m}}):(l=u>0?u:0,Sn=l)}}else{const y=Id(s.origin,o.type==="y_axis"?c-Math.PI/2:c,{alignedEdgeInfo:g},i,q,u,oe,o.type);if(y.snapped){if(l=y.scale,Sn=l,y.edgeFraction!==null){const x={x:s.origin.x+l*Math.cos((o.type==="y_axis",c)),y:s.origin.y+l*Math.sin((o.type==="y_axis",c))};dn={edgeFraction:y.edgeFraction,v1:q(g.v1Id),v2:q(g.v2Id),snapPosition:x}}}else l=u>0?u:0}}}}else l=Math.hypot(r.x,r.y)}o.type==="y_axis"?s.angle=c-Math.PI/2:s.angle=c,l>.01&&(s.scale=l),s.isCustom=!0}return!0}function Of(){if(jn){const e=an,t=e.face,n=t.localCoordSystem;if(e.type==="center"&&n){const o=fc;let i=null,s=null,a=1/0,r={dist:1/0,t:.5,v1:null,v2:null};if(t.vertexIds.forEach(c=>{const l=q(c);if(l&&l.type==="regular"){const d=J(n.origin,l);d<a&&(a=d,d<o&&(i=c))}}),!i){for(let c=0;c<t.vertexIds.length;c++){const l=q(t.vertexIds[c]),d=q(t.vertexIds[(c+1)%t.vertexIds.length]);if(l&&d&&l.type==="regular"&&d.type==="regular"){const h=bt(n.origin,l,d);h.distance<r.dist&&(r={dist:h.distance,t:h.t,v1:l.id,v2:d.id})}}if(r.dist<o){const c=J(q(r.v1),q(r.v2));c>re&&(s={v1:r.v1,v2:r.v2,t:r.t,originalLength:c,scaleRatio:n.scale/c})}}n.attachedToVertex=i,n.attachedToEdge=s}if(e.type==="x_axis"||e.type==="y_axis"){let o=!1,i=!1;if(ms==="edge"&&vn!==null){const s=ga(t,vn);s&&(n.rotationAlignedToEdge={v1:s.v1Id,v2:s.v2Id,originalAngle:s.edgeAngle,originalSystemAngle:n.angle},o=!0)}if(Sn!==null&&n.rotationAlignedToEdge){const s=ga(t,vn);if(s){const a=q(s.v1Id),r=q(s.v2Id);if(a&&r){const c=J(a,r);c>re&&(n.scaleAttachedToEdge={v1:s.v1Id,v2:s.v2Id,scaleRatio:n.scale/c,originalLength:c},i=!0)}}}o||(n.rotationAlignedToEdge=null),i||(n.scaleAttachedToEdge=null)}return Sn=null,dn=null,jn=!1,an=null,ui=null,vn=null,Us=null,ms=null,Mo=null,Be=null,Is=[],!0}return!1}function Nf(){ot=!ot,ot&&at()}function Bf(){if(Dt){Ge();const e=Z.find(t=>t.id===Dt);if(e){const t=Mf(e.id,Z),n=new Set(t.map(s=>s.id)),o=new Set;t.forEach(s=>{s.vertexIds.forEach(a=>o.add(a))}),ae=ae.filter(s=>!o.has(s.id)),U=U.filter(s=>!o.has(s.id1)&&!o.has(s.id2));const i=new Set([e.id,...n]);Z=Z.filter(s=>!i.has(s.id)),Kn()}Dt=null}ht.style.display="none"}function Ff(){Rs&&(Ge(),le.includes(Rs)||(ie=[],se=[],Ie=[],ye=[],le=[Rs]),Ao(),Rs=null),ht.style.display="none"}function $f(){Ls&&(Ge(),ie.includes(Ls)||(le=[],se=[],Ie=[],ye=[],ie=[Ls]),Ao(),Ls=null),ht.style.display="none"}function Vf(){Dt&&(Ge(),se.includes(Dt)||(le=[],ie=[],Ie=[],ye=[],se=[Dt]),Ao(),Dt=null),ht.style.display="none"}function Yf(e){const t=md(K,z,{isToolbarExpanded:rs,isColorPaletteExpanded:ot,isColorModePanelExpanded:en,isInterpolationPanelExpanded:Qt,isTransformPanelExpanded:In,isDisplayPanelExpanded:hn,isVisibilityPanelExpanded:Fa,isSessionsPanelExpanded:pt});if(Vt&&(!t||t.type!=="transformIcon")){Ge();const h=Ee(K),f=ke?qo(h):h,u={id:Lt(),x:f.x,y:f.y,type:js};ae.push(u),Ie=[u.id],Ye=u.id,le=[],ie=[],se=[],ye=[],Vt=!1,js=null,Co=null,fe.style.cursor="crosshair",e.preventDefault();return}if(e.altKey&&!Ue){ja(K,e.shiftKey);const h=Ke&&Ke.element.type==="vertex"?q(Ke.element.id):null,f=Ke&&Ke.element.type==="edge"?Ke.element.edge:null,u=Ke&&Ke.element.type==="face"?Z.find(g=>ge(g)===Ke.element.id):null;if(h||f||u){Ge(),le=[],ie=[],se=[],Ie=[],ye=[],Ye=null,ze=[],ot&&at();const g=j?.alpha2>=j?.alpha1&&j?.interval2?j.interval2:j?.interval1;if(h&&h.type==="regular")Ue=!0,it=h.id,Ze=[],Gt=0,Ce=[h.id],window.currentDrawingPath=Ce;else if(f&&Ke){const p=Ke.point,y=_l(f,p,g,Pe);y&&(Ue=!0,it=y.id,Ze=[],Gt=0,Ce=[y.id],window.currentDrawingPath=Ce,Ot())}else if(u&&Ke){const p=Ke.point;let y=Pe(_e);const x=he[_e];if(x!==-1){const S=ue[x];S&&S.type==="colormap"&&(y=Ae(S,0))}const m={id:Lt(),...p,type:"regular",color:y};ae.push(m),Ue=!0,it=m.id,Ze=[],Gt=0,Ce=[m.id],window.currentDrawingPath=Ce,Ot()}Bt=!1,e.preventDefault();return}}if(Bt=!0,Ne=!1,ds=!1,ot){const h=(z.colorTargetIcons||[]).filter(f=>K.x>=f.x&&K.x<=f.x+f.width&&K.y>=f.y&&K.y<=f.y+f.height);if(h.length>0){const f=h[h.length-1],{element:u,shiftKey:g,ctrlKey:p}={element:f,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey};g?ze.includes(u.target)||ze.push(u.target):p?ze.includes(u.target)?ze=ze.filter(y=>y!==u.target):ze.push(u.target):ze=[u.target],at(),ee={target:"ui_icon_click",element:{...f,type:"colorTargetIcon"}},fe.style.cursor="default";return}for(const f of z.colorSwatches)if(K.x>=f.x&&K.x<=f.x+f.width&&K.y>=f.y&&K.y<=f.y+f.height){ee={target:"ui_swatch",element:{...f}},fe.style.cursor="default";return}}if(pt){const h=z.removeSessionButton;if(h&&K.x>=h.x&&K.x<=h.x+h.width&&K.y>=h.y&&K.y<=h.y+h.height){ee={target:"ui_session_remove"},fe.style.cursor="default";return}const f=z.addSessionButton;if(f&&K.x>=f.x&&K.x<=f.x+f.width&&K.y>=f.y&&K.y<=f.y+f.height){ee={target:"ui_session_add"},fe.style.cursor="default";return}for(const u of z.sessionIcons)if(K.x>=u.x&&K.x<=u.x+u.width&&K.y>=u.y&&K.y<=u.y+u.height){ee={target:"ui_session",element:{...u}},fe.style.cursor="default";return}}if(Af(K,e.shiftKey,e.ctrlKey||e.metaKey)){ee={target:"ui"},fe.style.cursor="default";return}if(Sf(e)){ee={target:"coord_system"};return}const n=pl(K);let o=n?null:Ks(K),i=!n&&!o?Js(K):null,s=!n&&!o&&!i?Zs(K):null;const a=e.shiftKey||e.ctrlKey||e.metaKey,r=n||o||i||s;let c=!1;n?c=ye.includes(n.id):o?c=le.includes(o.id)||Ie.includes(o.id):i?c=ie.includes(ne(i)):s&&(c=se.includes(ge(s))),!Ue&&!a&&r&&!c&&(n?Ct([],[],[],!1,!1,!1,[n.id]):o?Ct([o.id],[],[],!1,!1,o.type!=="regular"):i?Ct([],[ne(i)],[],!1,!1):s&&Ct([],[],[ge(s)],!1,!1));let l=null;if(n)l=Ee(K);else if(o)l=o;else if(i){const h=q(i.id1),f=q(i.id2);l=bt(Ee(K),h,f)}else s&&(l=Ee(K));const d=Ye&&(le.length>0||ie.length>0||se.length>0||ye.length>0);ce=[],Se=[],ee={targetVertex:o,dragHandle:l,targetEdge:i,targetFace:s,targetText:n,target:r||"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey,altKey:e.altKey,isTransformDrag:d},o&&o.type!=="regular"&&(Vs=!0,za(o.id,e.shiftKey,e.ctrlKey||e.metaKey))}function Xf(){Ge();const e=[...le],t=[...ie],n=[...se],o=[...Ie],i=Ye;le=[],ie=[],se=[],Ie=[],ye=[],Ye=null;const s=parseInt(Rt,10)||1;let a=null;const r=Ne&&ce.length===1&&ee?.finalSnapResult?.snapType==="edge",c=new Set(Os.map(y=>y.id));if(c.size>0){const y=new Map(Os.map(_=>[_.id,_])),x=new Set(e);t.forEach(_=>{const[T,v]=_.split(zs);T&&x.add(T),v&&x.add(v)}),n.forEach(_=>{const T=Z.find(v=>ge(v)===_);T&&Pl(T.id,Z).forEach(E=>x.add(E))});const m=Xe?null:fl(),{center:S,rotation:I=0,scale:b=1,directionalScale:M=!1,startVector:C}=Xe||{},w=-I*(180/Math.PI);qe.forEach(_=>{if(!c.has(_.id))return;const T=y.get(_.id)||_,v=hl(T);if(T.anchorType!=="canvas"&&!v)return;const E=T.anchorType==="canvas"?T.position||_.position:v.anchor,O=T.anchorType==="canvas"?{x:0,y:0}:T.offset||{x:0,y:0},P=T.anchorType==="canvas"?T.position||_.position||{x:0,y:0}:{x:E.x+O.x,y:E.y+O.y},D=(()=>{if(T.anchorType==="vertex")return x.has(T.anchorId);if(T.anchorType==="edge"){if(t.includes(T.anchorId))return!0;const F=U.find(R=>ne(R)===T.anchorId);return F?x.has(F.id1)&&x.has(F.id2):!1}if(T.anchorType==="face"){if(n.includes(T.anchorId))return!0;const F=Z.find(R=>ge(R)===T.anchorId);return F?F.vertexIds.every(R=>x.has(R)):!1}return!1})();if(Xe){const F=He(P,S,I,b,M,C);if(_.rotationDeg=(T.rotationDeg||0)+w,_.scale=(T.scale||1)*b,T.anchorType==="canvas")_.position=F;else{const R=D?He(E,S,I,b,M,C):E,B={x:F.x-R.x,y:F.y-R.y};if(_.offset=B,_.anchorType==="edge"){const L=da(_.anchorId,B);typeof L=="number"&&(_.edgeOffsetFactor=L)}}}else if(m){if(T.anchorType==="canvas"){const F=T.position||_.position||{x:0,y:0};_.position={x:F.x+m.x,y:F.y+m.y}}else if(!D){const F=T.offset||{x:0,y:0},R={x:F.x+m.x,y:F.y+m.y};if(_.offset=R,_.anchorType==="edge"){const B=da(_.anchorId,R);typeof B=="number"&&(_.edgeOffsetFactor=B)}}}})}if(r){const y=ee.finalSnapResult,x=ce[0].id,m=y.targetEdge,S=q(x);if(S&&m){const I=JSON.parse(JSON.stringify(U)),b=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;S.x=y.pos.x,S.y=y.pos.y,U=U.filter(T=>ne(T)!==ne(m));const M=q(m.id1),C=q(m.id2),w=gs(M,S,b,Pe),_=gs(C,S,b,Pe);bs(w),bs(_),U.push(w),U.push(_),vs(I,U)}}else if(Xe){const{center:y,rotation:x,scale:m,directionalScale:S,startPos:I}=Xe,b={x:I.x-y.x,y:I.y-y.y};ce.forEach(M=>{const C=q(M.id);if(C){const w=He(M,y,x,m,S,b);C.x=w.x,C.y=w.y}})}else if(Se.length>0){const y=ee.finalSnapResult&&ee.finalSnapResult.snapped?ee.finalSnapResult.finalDelta:{x:Se[0].x-ce[0].x,y:Se[0].y-ce[0].y},x=ce.filter(m=>m.type==="regular");if(s>1&&x.length>0){const m=new Set(x.map(P=>P.id)),S=new Set(se),I=new Set(ie);se.forEach(P=>{const D=Z.find(F=>ge(F)===P);D&&D.vertexIds.forEach(F=>m.add(F))});const b=new Set;se.forEach(P=>{const D=Z.find(F=>ge(F)===P);if(D)for(let F=0;F<D.vertexIds.length;F++){const R=D.vertexIds[F],B=D.vertexIds[(F+1)%D.vertexIds.length];b.add(ne({id1:R,id2:B}))}});const M=U.filter(P=>{const D=ne(P);return I.has(D)||b.has(D)?!0:m.has(P.id1)&&m.has(P.id2)}),C=se.length>0?Z.filter(P=>S.has(ge(P))):Z.filter(P=>P.vertexIds.every(D=>m.has(D))),w=U.filter(P=>m.has(P.id1)&&!m.has(P.id2)||m.has(P.id2)&&!m.has(P.id1)),_=[],T=[],v=[];a={vertices:[],edges:[],faces:[],texts:[]};const E=new Set(ye),O=qe.filter(P=>{if(E.has(P.id))return!0;if(P.anchorType==="vertex")return m.has(P.anchorId);if(P.anchorType==="edge"){const D=U.find(F=>ne(F)===P.anchorId);return D?m.has(D.id1)&&m.has(D.id2):!1}if(P.anchorType==="face"){if(S.has(P.anchorId))return!0;const D=Z.find(F=>ge(F)===P.anchorId);return D?D.vertexIds.every(F=>m.has(F)):!1}return!1});for(let P=1;P<s;P++){const D=new Map,F=[],R=[],B=[],L=[];x.forEach(N=>{const $={x:N.x+y.x*P,y:N.y+y.y*P},A={...N,...$,id:Lt()};_.push(A),D.set(N.id,A.id),F.push(A.id)}),M.forEach(N=>{const $=D.get(N.id1),A=D.get(N.id2);if($&&A){const k={...N,id1:$,id2:A};T.push(k),R.push(ne(k))}}),w.forEach(N=>{const $=m.has(N.id1)?N.id2:N.id1,A=m.has(N.id1)?N.id1:N.id2,k=D.get(A);if(k){const V={...N,id1:k,id2:$};T.push(V)}}),C.forEach(N=>{const $=ys.get(N.id),A=N.vertexIds.map(k=>D.get(k));if(A.every(Boolean)){const k=JSON.parse(JSON.stringify(N));if(k.id=ge({vertexIds:A}),k.vertexIds=A,k.localCoordSystem&&$){const V={x:y.x*P,y:y.y*P};k.localCoordSystem.origin.x=$.origin.x+V.x,k.localCoordSystem.origin.y=$.origin.y+V.y}v.push(k),B.push(k.id)}}),O.forEach(N=>{const $=JSON.parse(JSON.stringify(N));if($.id=Lt(),N.anchorType==="canvas"){if(!$.position)return;$.position={x:$.position.x+y.x*P,y:$.position.y+y.y*P}}else if(N.anchorType==="vertex"){const A=D.get(N.anchorId);if(!A)return;$.anchorId=A}else if(N.anchorType==="edge"){const A=U.find(X=>ne(X)===N.anchorId);if(!A)return;const k=D.get(A.id1),V=D.get(A.id2);if(!k||!V)return;$.anchorId=ne({id1:k,id2:V})}else if(N.anchorType==="face"){const A=Z.find(V=>ge(V)===N.anchorId);if(!A)return;const k=A.vertexIds.map(V=>D.get(V));if(!k.every(Boolean))return;$.anchorId=ge({vertexIds:k})}qe.push($),E.has(N.id)&&L.push($.id)}),P===1&&(a={vertices:F,edges:R,faces:B,texts:L})}ae.push(..._),U.push(...T),Z.push(...v)}else s===1&&ce.forEach(m=>{const S=q(m.id);S&&(S.x=m.x+y.x,S.y=m.y+y.y)})}const l=new Set(ce.map(y=>y.id)),d=Z.filter(y=>y.vertexIds.some(x=>l.has(x)));d.length>0&&d.forEach(y=>{const x=ys.get(y.id);if(y.localCoordSystem&&x){const m=new Set(y.vertexIds),S=new Set(ce.map(b=>b.id));if([...m].every(b=>S.has(b))){if(Xe){const{center:b,rotation:M,scale:C,directionalScale:w,startPos:_}=Xe,T={x:_.x-b.x,y:_.y-b.y},v=He(x.origin,b,M,C,w,T);if(y.localCoordSystem.origin=v,w){const E=_n({x:1,y:0},x),O=He(E,b,M,C,w,T);y.localCoordSystem.scale=J(v,O)}else y.localCoordSystem.angle=bn(x.angle+M),y.localCoordSystem.scale=x.scale*C}else if(s===1){const b=ee.finalSnapResult&&ee.finalSnapResult.snapped?ee.finalSnapResult.finalDelta:{x:Se[0].x-ce[0].x,y:Se[0].y-ce[0].y};y.localCoordSystem.origin.x=x.origin.x+b.x,y.localCoordSystem.origin.y=x.origin.y+b.y}}else{const b=y.vertexIds.map(M=>q(M)).filter(Boolean);Cf(y,x,ce,b,q)}}}),bf(Array.from(l),Xe);const{vertexMerges:h,edgeSplits:f}=iu(ae,U,oe),u=new Map;ae.forEach(y=>u.set(y.id,y.id));const g=y=>{if(!u.has(y)||u.get(y)===y)return y;const x=g(u.get(y));return u.set(y,x),x};h.forEach((y,x)=>{const m=g(x),S=g(y);m!==S&&u.set(S,m)});const p=new Set;if(ae.forEach(y=>{const x=g(y.id);y.id!==x&&p.add(y.id)}),p.size>0||f.size>0){const y=JSON.parse(JSON.stringify(U)),x=Ef(Z,g);U.forEach(m=>{m.id1=g(m.id1),m.id2=g(m.id2)}),ae=ae.filter(m=>!p.has(m.id)),U=U.filter((m,S,I)=>m.id1!==m.id2&&S===I.findIndex(b=>ne(b)===ne(m))),vs(y,U),Z.forEach(m=>{const S=x.get(m.id);S&&(m.localCoordSystem=S)}),Ms()}s>1&&a?(le=e.length>0?a.vertices.map(y=>g(y)):[],ie=t.length>0?a.edges:[],se=n.length>0?a.faces:[],ye=Os.length>0?a.texts:[]):s===1&&(le=e.map(y=>g(y)),ie=t,se=n,ye=Os.map(y=>y.id).filter(y=>qe.some(x=>x.id===y))),Ie=o,Ye=i,mi(),Ot()}function zf(e){const{shiftKey:t,ctrlKey:n,targetVertex:o,targetEdge:i,targetFace:s,targetText:a}=e,r=q(it);if(Ue&&r){Ge();const c=JSON.parse(JSON.stringify(U)),l=Eo(r,K,t);let d=null;const h=j.alpha2>j.alpha1&&j.interval2?j.interval2:j.interval1;if(l.snapType==="vertex"&&l.targetVertex)d=l.targetVertex;else if(l.snapType?.startsWith("edge")&&l.targetEdge)d=_l(l.targetEdge,{x:l.x,y:l.y},h,Pe);else{let f=Pe(_e);const u=he[_e];if(u!==-1){const g=ue[u];g&&g.type==="colormap"&&(f=Ae(g,.5))}d={id:Lt(),x:l.x,y:l.y,type:"regular",color:f},ae.push(d)}if(d){if(!U.some(g=>g.id1===r.id&&g.id2===d.id||g.id2===r.id&&g.id1===d.id)){const g=gs(r,d,h,Pe);bs(g),U.push(g),vs(c,U),mi(),Z.forEach(p=>{p.color||(p.color=Pe(we))})}const u=Or(r,d,U);u&&(Ze.length>0&&(Ze[Ze.length-1].turn=u.turnAngleRad),Ze.push({length:u.length,turn:0,endVertexColor:d.color}),Gt=Ze.length-1,Dn=u.startVertex,dt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):u.length,qn=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,kt=u.turnAngleRad,Wn=u.precedingSegmentAbsoluteAngleRad),Ce.push(d.id),window.currentDrawingPath=Ce,Dl(),kl(),Ot(),it=d.id}if(t&&d&&l){const f=Or(r,d,U);f&&(Dn=f.startVertex,dt=l.gridToGridSquaredSum>0&&l.gridInterval?l.gridInterval*Math.sqrt(l.gridToGridSquaredSum):f.length,qn=l.gridToGridSquaredSum>0?{g2gSquaredSum:l.gridToGridSquaredSum,interval:l.gridInterval}:null,kt=f.turnAngleRad,Wn=f.precedingSegmentAbsoluteAngleRad)}de.count=0}else if(e.target==="canvas"){Ge();const c=Be||Ee(K);let l=Pe(_e);const d=he[_e];if(d!==-1){const f=ue[d];f&&f.type==="colormap"&&(l=Ae(f,0))}const h={id:Lt(),...c,type:"regular",color:l};ae.push(h),Ue=!0,it=h.id,Ze=[],Gt=0,Ce=[h.id],window.currentDrawingPath=Ce,Ot()}else if(!(e&&e.altKey)){if(!(e&&e.targetVertex&&e.targetVertex.type!=="regular")&&(a||o||i||s)){Ge();const l=a?a.id:s?ge(s):i?ne(i):o.id;let d;switch(a?d="text":s?d="face":o&&o.type!=="regular"?d="center":o?d="vertex":i&&(d="edge"),l&&de.targetId===l&&Date.now()-de.timestamp<jo?de.count++:de.count=1,de.targetId=l,de.type=d,de.timestamp=Date.now(),de.count){case 1:de.type==="text"?Ct([],[],[],t,n,!1,[de.targetId]):de.type==="face"?Ct([],[],[de.targetId],t,n):de.type==="edge"?Ct([],[de.targetId],[],t,n):de.type==="vertex"?Ct([de.targetId],[],[],t,n):de.type==="center"&&za(de.targetId,t,n);break;case 2:if(de.type==="text"){const f=So(de.targetId);f&&gl(f,f.content||"")}else if(de.type==="vertex"){const f=cn(de.targetId,U);Ct([de.targetId,...f],[],[],t,n)}else if(de.type==="edge"){const f=U.find(u=>ne(u)===de.targetId);if(f){const u=[...ua(f.id1),...ua(f.id2)];Ct([],Array.from(new Set(u.map(g=>ne(g)))),[],t,n)}}else if(de.type==="face"){const f=Z.find(u=>ge(u)===de.targetId);if(f){const u=[],g=new Set;for(let p=0;p<f.vertexIds.length;p++){const y=f.vertexIds[p],x=f.vertexIds[(p+1)%f.vertexIds.length];g.add(ne({id1:y,id2:x}))}Z.forEach(p=>{if(ge(p)!==ge(f))for(let y=0;y<p.vertexIds.length;y++){const x=p.vertexIds[y],m=p.vertexIds[(y+1)%p.vertexIds.length];if(g.has(ne({id1:x,id2:m}))){u.push(ge(p));break}}}),Ct([],[],[ge(f),...u],t,n)}}break;case 3:if(de.type==="vertex"||de.type==="edge"||de.type==="face"){let f;if(de.type==="vertex")f=de.targetId;else if(de.type==="edge")f=de.targetId.split(zs)[0];else if(de.type==="face"){const u=Z.find(g=>ge(g)===de.targetId);u&&(f=u.vertexIds[0])}if(f){const u=new Set(_o(f));if(de.type==="vertex")Ct(Array.from(u),[],[],t,n);else if(de.type==="edge"){const g=U.filter(p=>u.has(p.id1)&&u.has(p.id2)).map(p=>ne(p));Ct([],g,[],t,n)}else if(de.type==="face"){const g=Z.filter(p=>p.vertexIds.every(y=>u.has(y))).map(p=>ge(p));Ct([],[],g,t,n)}}}de.count=0;break}const h=[];se.length>0&&h.push(we),ie.length>0&&h.push(Re),le.length>0&&h.push(_e),ye.length>0&&h.push(It),h.length>0&&(ze=h,ot&&at())}}}function Hf(e){if(e.target==="ui_icon_click"&&e.element.type==="colorTargetIcon"){const{element:t}=e,n=Date.now(),o=`icon-${t.target}`;if(de.targetId===o&&n-de.timestamp<jo){switch(Ge(),t.target){case _e:ai=!ai;break;case Re:ri=!ri;break;case we:kn=!kn;break}at(),de.count=0}de.targetId=o,de.timestamp=n;return}if(e.target==="ui_swatch"){const{element:t}=e,n=Date.now(),o=`swatch-${t.index}`;if(de.targetId===o&&n-de.timestamp<jo){ci=!0,lo=t.index;const i=ue[t.index];let s;if(i.type==="color"){const a=Ws(i.value);s={type:"colormap",points:[{pos:.5,alpha:a.a,color:[a.r,a.g,a.b],order:1}]}}else i.type==="colormap"&&(s={type:"colormap",points:i.vertices.map(a=>({pos:a.pos,alpha:a.alpha!==void 0?a.alpha:1,color:Array.isArray(a.color)?[...a.color]:[a.color.r||0,a.color.g||0,a.color.b||0],order:a.order||1})),isCyclic:i.isCyclic===!0});Nn.show(void 0,void 0,s),de.count=0}else ze.length>0&&(Ge(),ze.forEach(i=>he[i]=t.index),Pi(),Ya(),at());de.targetId=o,de.timestamp=n;return}if(e.target==="ui_session"){const{element:t}=e;t&&t.index!==void 0&&Cs(t.index);return}if(e.target==="ui_session_add"){ef();return}if(e.target==="ui_session_remove"){yt!==null&&wl(yt);return}}function Gf(e){if($s||hs||ho){if($s){if(z.colorTargetIcons.find(n=>n.target===wt.target)){const n=z.colorSwatches,o=qr(K,n);o&&(he[wt.target]=o.index,pi(wt.target).forEach(i=>{he[i]=o.index}),Ya())}}else if(hs){const t=z.removeColorButton;if(t&&K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height&&ue.length>1){const o=ue.indexOf(Pt.item);o!==-1&&Ha(o)}}else if(ho){const t=z.removeSessionButton;t&&K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height&&Wo&&wl(Wo.index)}$s=!1,wt=null,hs=!1,Pt=null,ho=!1,Wo=null,es=!1,ot&&at(),pt&&_i()}else Ne?Xf():ee&&(typeof ee.target=="string"&&ee.target.startsWith("ui")?Hf(ee):zf(ee));Ol()}function Wf(e){Bt=!0,Un=!1,rl=Wt,ee={target:"canvas",shiftKey:e.shiftKey,ctrlKey:e.ctrlKey||e.metaKey}}function qf(e){if(Ne&&Un){const t=Ee({x:Math.min(Wt.x,K.x),y:Math.min(Wt.y,K.y)}),n=Ee({x:Math.max(Wt.x,K.x),y:Math.max(Wt.y,K.y)}),o=Math.min(t.x,n.x),i=Math.max(t.x,n.x),s=Math.min(t.y,n.y),a=Math.max(t.y,n.y),r=ae.filter(u=>u.type==="regular"&&u.x>=o&&u.x<=i&&u.y>=s&&u.y<=a).map(u=>u.id),c=ae.filter(u=>u.type!=="regular"&&u.x>=o&&u.x<=i&&u.y>=s&&u.y<=a).map(u=>u.id),l=new Set(r),d=U.filter(u=>l.has(u.id1)&&l.has(u.id2)).map(u=>ne(u)),h=Z.filter(u=>u.vertexIds.every(g=>l.has(g))).map(u=>ge(u));ee.shiftKey?(le=[...new Set([...le,...r])],ie=[...new Set([...ie,...d])],se=[...new Set([...se,...h])],Ie=[...new Set([...Ie,...c])]):ee.ctrlKey?(r.forEach(u=>{const g=le.indexOf(u);g>-1?le.splice(g,1):le.push(u)}),d.forEach(u=>{const g=ie.indexOf(u);g>-1?ie.splice(g,1):ie.push(u)}),h.forEach(u=>{const g=se.indexOf(u);g>-1?se.splice(g,1):se.push(u)}),c.forEach(u=>{const g=Ie.indexOf(u);g>-1?Ie.splice(g,1):Ie.push(u)})):(le=r,ie=d,se=h,Ie=c);const f=[];se.length>0&&f.push(we),ie.length>0&&f.push(Re),le.length>0&&f.push(_e),ye.length>0&&f.push(It),f.length>0&&(ze=f,ot&&at())}else{if(pt&&z.sessionsPanelBounds){const t=z.sessionsPanelBounds;if(K.x>=t.x&&K.x<=t.x+t.width&&K.y>=t.y&&K.y<=t.y+t.height){of();return}}wf(e)}}function Uf(e){e.preventDefault();const t=to(e,fe),n=e.deltaY>0?1/1.15:1.15;pa(t,n)}function jf(){xo=!0}function Kf(){xo=!1,Al()}function Jf(e){e.preventDefault()}function Zf(e,t){const n=parseInt(Rt||"1",10)||1,o=Ld(ce,ae,U,q,e,n,oe),i=o.finalDelta;ce.forEach(s=>{const a=Se.find(r=>r&&r.id===s.id);a&&(a.x=s.x+i.x,a.y=s.y+i.y)}),Ll(i,o),ee.finalSnapResult=o}function Qf(e){if(kn&&ae.length>0&&(jr(Me,{allFaces:Z,hoveredFaceId:pn,selectedFaceIds:se,colors:e,isDragConfirmed:Ne,dragPreviewVertices:Se,currentAltPressed:_t},xe,q,ge),se.length>0&&il(Me,{allFaces:Z,selectedFaceIds:se,colors:e,isDragConfirmed:Ne,dragPreviewVertices:Se,initialDragVertexStates:ce,transformIndicatorData:Xe,highlightedEdgeForSnap:vn,draggedFaceId:Mo,coordSystemSnapAngle:Us,coordSystemSnapType:ms,coordSystemSnapScale:Sn,initialCoordSystemStates:ys},xe,q)),Ue&&ke&&(dt!==null||kt!==null)&&Ce.length>=1&&Dn){const o=q(Dn.id);if(o){const i={frozen_Origin_Data_to_display:o,displayAngleA_valueRad_for_A_equals_label:kt,frozen_A_baseRad_to_display:Wn,frozen_D_du_to_display:dt,frozen_D_g2g_to_display:qn};lh(Me,i,xe,Ee,{showAngles:On,showDistances:xn,viewTransform:oe,mousePos:K,colors:e}),ch(tt,i,{showAngles:On,showDistances:xn,viewTransform:oe,mousePos:K,frozenReference_D_du:dt,distanceSigFigs:Qn,angleDisplayMode:nn,colors:e},Ee,xe,xt)}}const t={lastGridState:j,showDistances:xn,showAngles:On,distanceSigFigs:Qn,angleDisplayMode:nn,angleSigFigs:Ho,currentShiftPressed:ke,viewTransform:oe,colors:e};if(Ne){const o=new Set(ce.map(a=>a.id));let i=!1;if(ce.length>0){const a=new Set(_o(ce[0].id));i=!(o.size===a.size&&[...o].every(r=>a.has(r)))}const s=ae.map(a=>Se.find(c=>c.id===a.id)||a);if(i&&ke)ce.forEach(a=>{cn(a.id,U).some(c=>!o.has(c))&&ro(Me,tt,a.id,s,t,xe,c=>cn(c,U),ne,ke,null,xt,le,!0,ce,Ye,gt)});else if(ee&&(ee.targetVertex||ee.targetEdge)){const a=ee.targetVertex?ee.targetVertex.id:ce[0]?.id;a&&ro(Me,tt,a,s,t,xe,r=>cn(r,U),ne,ke,null,xt,le,!0,ce,Ye,gt),ee.targetEdge&&kr(Me,tt,ie,U,{showDistances:xn,distanceSigFigs:Qn,colors:e,lastGridState:j,currentShiftPressed:ke},q,ne,xe,xt,Se,ce,Xe)}}else(xn||On)&&!Ue&&!(parseInt(Rt||"1",10)>1&&Ne)&&!Vt&&(le.length>0&&le.length<=Wc&&le.forEach(o=>{ro(Me,tt,o,ae,{...t,currentShiftPressed:!1},xe,i=>cn(i,U),ne,!1,null,xt,le,!1,[],Ye)}),ie.length>0&&ie.length<=qc&&(kr(Me,tt,ie,U,{showDistances:xn,distanceSigFigs:Qn,colors:e,lastGridState:j},q,ne,xe,xt,Se,ce,Xe),_h(Me,tt,ie,U,{showAngles:On,angleSigFigs:Ho,angleDisplayMode:nn,currentShiftPressed:ke,distanceSigFigs:Qn,viewTransform:oe,lastGridState:j,colors:e},q,ne,xe,o=>cn(o,U),xt)));const n=!_t&&(un||En||pn);if(Ue&&it&&!n){const o=q(it);if(o){const i=Ua(o.id),s=Eo(o,K,ke);let a=Pe(Re),r=null;const c=he[Re];if(c!==-1){const h=ue[c];if(h&&h.type==="colormap"&&Ce&&Ce.length>=1){const f=Ce.length,u=Ce.length-1,g=f>1?u/(f-1):0,p=f>1?(u+1)/f:1;r={colormapItem:h,startT:g,endT:p}}}Jr(Me,{startVertex:o,snappedData:s,isShiftPressed:ke,currentColor:Pe(_e),nextCreationColor:Pe(_e),nextEdgeColor:a,colors:e,edgeColormapInfo:r,interpolationStyle:yi()},xe);const l={x:s.x,y:s.y};el(Me,tt,o,l,s,{showDistances:xn,showAngles:On,currentShiftPressed:ke,distanceSigFigs:Qn,angleSigFigs:Ho,angleDisplayMode:nn,viewTransform:oe,frozenReference_D_du:dt,gridDisplayMode:st,frozenReference_A_rad:kt,colors:e},xe,i,xt)}}if(Be&&!n){const o={...Be,id:"ghost",type:"regular"};ni(Me,o,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:ln==="vertex"||ln==="edge_fraction"||ln==="edge"?ln:null,currentAltPressed:_t},xe)}if(Un&&Ne&&Ph(Me,rl,K,e),Qd(Me,{info:{...ii,startVertex:q(it)},colors:e},xe,q,xt),(Xe||dn)&&oh(Me,tt,{transformIndicatorData:Xe,colors:e,coordSystemTransformIndicatorData:dn,currentShiftPressed:ke},xe,xt),Be&&!n){const o={...Be,id:"ghost",type:"regular"},i=ln==="vertex"||ln==="edge_fraction"||ln==="edge";i?ni(Me,o,{selectedVertexIds:[],selectedCenterIds:[],activeCenterId:null,colors:e,verticesVisible:!0,isHovered:!1,isSnapped:!0,snapType:i?ln:null,currentAltPressed:_t},xe):Ra(Me,o,{colors:e,verticesVisible:!0,isSnapped:!0},xe)}}function eu(e){if(un=null,En=null,pn=null,Be=null,ln=null,!Bt){if(!_t){const s=pl(e);if(s){s.id;return}}const t=Ks(e),n=t?null:Js(e),o=!t&&!n?Zs(e):null,i=t||n||o;if(_t)i?ja(e,ke):Ke=null,un=null,En=null,pn=null;else if(t?un=t.id:n?En=ne(n):o&&(pn=o.id),ke&&!i){Ee(e);const s=Eo({id:"dummy_start",x:0,y:0},e,!0);s.snapped&&(Be={x:s.x,y:s.y},ln=s.snapType)}}}function tu(e){if(it){const t=q(it);if(t)if(ke){const n=Eo(t,e,ke);ii=n.snapped&&n.snapType==="edge_fraction"?{edge:n.targetEdge,fraction:n.fraction,snapPoint:{x:n.x,y:n.y},mousePos:e}:null}else ii=null}Be=null}function nu(e,t,n,o){const i=cf(n,e,t,o,Go);let s={},a={};if(o===Kt)s=hf(n,ce,t,i.rotation,e),a={rotation:s.rotation,scale:1,directionalScale:!1},Go=i.rotation;else if(o===Rn)s=ff(n,ce,t,i.scale),a={rotation:0,scale:s.scale||i.scale,directionalScale:!1};else if(o===sn)s=df(n,ce,t,i.rotation,i.scale),a={rotation:s.rotation,scale:s.scale,directionalScale:!1},Go=i.rotation;else if(o===Jn){const h={x:t.x-n.x,y:t.y-n.y};s=uf(n,ce,t,i.scale,h,e),a={rotation:0,scale:s.scale||i.scale,directionalScale:!0}}s.snapped&&s.snapType==="projection"&&s.projectionSource&&(Be=s.projectionSource);const r={x:t.x-n.x,y:t.y-n.y};Xe={center:n,startPos:t,currentPos:s.pos||e,rotation:a.rotation,scale:a.scale,isSnapping:s.snapped||!1,transformType:o,directionalScale:a.directionalScale,snappedScaleValue:s.snappedScaleValue||null,gridToGridInfo:s.gridToGridInfo||null,gridPoint:s.gridPoint||null,nearbyVertex:s.nearbyVertex||null,projectionPoint:s.projectionPoint||null,projectionSource:s.projectionSource||null,snapType:s.snapType||null,projectionCenter:s.snapType==="projection"?n:null,projectionHandleInitial:s.projectionHandleInitial||null,startVector:r};const c={x:t.x-n.x,y:t.y-n.y};if(Se=ce.map(h=>{const f=He(h,n,a.rotation,a.scale,a.directionalScale,c);return{...h,x:f.x,y:f.y}}),s.snapped&&s.snapType==="merge"&&s.mergingVertex&&s.mergeTarget){const h=ce.find(f=>f.id===s.mergingVertex.id);if(h){const f=Se.find(u=>u.id===h.id);if(f){const u={x:s.mergeTarget.x-f.x,y:s.mergeTarget.y-f.y};Se.forEach(g=>{g.x+=u.x,g.y+=u.y}),Xe.currentPos&&(Xe.currentPos.x+=u.x,Xe.currentPos.y+=u.y)}}}const l=Fe*2/oe.scale,d=ae.filter(h=>h.type==="regular"&&!ce.some(f=>f.id===h.id));Se.forEach(h=>{h.type==="regular"&&d.forEach(f=>{J(h,f)<l&&Is.push({x:f.x,y:f.y})})});for(let h=0;h<Se.length;h++)for(let f=h+1;f<Se.length;f++){const u=Se[h],g=Se[f];u.type==="regular"&&g.type==="regular"&&J(u,g)<l&&Is.push({x:(u.x+g.x)/2,y:(u.y+g.y)/2})}}function su(e){if($s&&wt){const t=z.colorTargetIcons.find(n=>n.target===wt.target);if(t){const n=[...z.colorSwatches],o=qr(e,n);o?(t.x=o.x+(o.width-t.width)/2,t.y=o.y-t.height-5,wt.previewColorIndex=o.index,pi(wt.target).forEach(i=>{const s=z.colorTargetIcons.find(a=>a.target===i);s&&(s.x=t.x,s.y=t.y)})):(t.x=e.x-wt.offsetX,t.y=e.y-wt.offsetY,wt.previewColorIndex=wt.originalColorIndex,pi(wt.target).forEach(i=>{const s=z.colorTargetIcons.find(a=>a.target===i);s&&(s.x=t.x,s.y=t.y)}))}return!0}if(hs){const t=z.removeColorButton,n=t&&e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height;if(n&&ue.length>1&&!es){es=!0;const s=ue.indexOf(Pt.item);return s>=0&&(Ha(s),at()),!0}else if(!n&&es)return es=!1,ue.splice(Pt.originalIndex,0,Pt.item),Object.keys(he).forEach(s=>{he[s]>=Pt.originalIndex&&he[s]++}),Object.keys(Pt.originalAssignments).forEach(s=>{Pt.originalAssignments[s]===Pt.originalIndex&&(he[s]=Pt.originalIndex)}),at(),!0;if(es)return!0;const o=ue.indexOf(Pt.item);let i=o;for(let s=0;s<z.colorSwatches.length;s++){const a=z.colorSwatches[s];if(e.x>=a.x&&e.x<=a.x+a.width){i=ue.indexOf(a.item);break}}if(i!==o){const s=ue[o];ue.splice(o,1),ue.splice(i,0,s),Object.keys(he).forEach(a=>{he[a]===o?he[a]=i:he[a]>o&&he[a]<=i?he[a]--:he[a]<o&&he[a]>=i&&he[a]++}),at()}return!0}return!!ho}function Ka(){if(Bt||Ue){Ke=null,Be=null,un=null,En=null,pn=null;return}_t?ja(K,ke):(Ke=null,eu(K))}function ou(e){if(K=to(e,fe),ke=e.shiftKey,_t=e.altKey,Ga(K)?fe.style.cursor="default":Vt?fe.style.cursor="none":ds||Ne?fe.style.cursor="grabbing":fe.style.cursor="crosshair",Bt){if(!Ne&&J(K,Wt)>mc&&!Ue){if(Ne=!0,ee&&ee.target==="coord_system")return;if(di=ee.dragHandle,li=ee.target==="edge",ee.target==="ui_icon_click"){$s=!0;const t=ll(ee.element.target);wt={target:t,offsetX:K.x-ee.element.x,offsetY:K.y-ee.element.y,originalColorIndex:he[t],previewColorIndex:he[t]},ee.target="ui_icon_drag",ze=[t,...pi(t)]}else if(ee.target==="ui_swatch")Ge(),hs=!0,Pt={index:ee.element.index,item:ee.element.item,offsetX:K.x-ee.element.x,originalIndex:ee.element.index,originalAllColors:JSON.parse(JSON.stringify(ue)),originalAssignments:JSON.parse(JSON.stringify(he))};else if(ee.target==="ui_session")ho=!0,Wo={index:ee.element.index,session:ee.element.session,offsetX:K.x-ee.element.x,offsetY:K.y-ee.element.y},ee.target="ui_session_drag";else if(gn===2){Un=!0;return}else if(ee.target==="canvas")ds=!0,ji={x:oe.offsetX,y:oe.offsetY},fe.style.cursor="move";else{fe.style.cursor="grabbing",Vs=ee.targetVertex&&ee.targetVertex.type!=="regular"&&!ee.isTransformDrag;let n;if(Vs)n=[ee.targetVertex];else{let i=new Set(le);ie.forEach(s=>{const[a,r]=s.split(zs);i.add(a),i.add(r)}),se.forEach(s=>{const a=Z.find(r=>ge(r)===s);a&&Pl(a.id,Z).forEach(c=>i.add(c))}),n=Array.from(i).map(s=>q(s)).filter(s=>s&&s.type==="regular")}if(Vs&&ee.targetVertex.type===Kt){const i=ee.targetVertex,s=Ee(Wt),a={x:s.x-i.x,y:s.y-i.y};ee.initialRotationStartAngle=Math.atan2(a.y,a.x),Go=0}const o=ye.map(i=>So(i)).filter(Boolean);if(n.length>0||o.length>0){ce=JSON.parse(JSON.stringify(n)),Se=JSON.parse(JSON.stringify(n)),Os=JSON.parse(JSON.stringify(o)),la=JSON.parse(JSON.stringify(o)),ys.clear();const i=new Set(ce.map(s=>s.id));Z.forEach(s=>{s.vertexIds.some(a=>i.has(a))&&s.localCoordSystem&&ys.set(s.id,JSON.parse(JSON.stringify(s.localCoordSystem)))})}}}if(Ne){if(ds){const t=K.x-Wt.x,n=K.y-Wt.y;oe.offsetX=ji.x+t*Ve,oe.offsetY=ji.y-n*Ve}else if(!Un){if(su(K)||Lf(e))return;if(Ye&&(le.length>0||ie.length>0||se.length>0||ye.length>0)&&!li){const n=q(Ye);let o=di;!o&&ce.length>0&&(o=ce.find(i=>i.type==="regular"&&J(i,n)>1e-6)||ce.find(i=>i.type==="regular")),n&&o&&nu(Ee(K),o,n,n.type)}else if(Se.length>0){const n=ce.length===1&&ce[0].type==="regular",o=Ee(K);if(n){const i=ce[0];cn(i.id,U).filter(a=>!ce.some(r=>r.id===a)).map(a=>q(a));const s=Hh(i,o);if(Se[0].x=s.pos.x,Se[0].y=s.pos.y,gt.clear(),Ss.clear(),s.snapped){const a={copyIndex:0,type:s.snapType,projectionLine:s.projectionLine};gt.set(i.id,[a]),s.targetEdge&&Ss.set(ne(s.targetEdge),[{copyIndex:0,type:"external_to_static"}])}ee.finalSnapResult={...s,finalDelta:{x:s.pos.x-i.x,y:s.pos.y-i.y}}}else{const i=Ee(Wt),s={x:o.x-i.x,y:o.y-i.y};Zf(s)}}else if(la.length>0){const n=Ee(Wt),o=Ee(K),i={x:o.x-n.x,y:o.y-n.y};ee.textFinalDelta=i}}}}else Ue?tu(K):Ka()}function Ll(e,t){if(gt.clear(),Ss.clear(),!t||!t.snapped)return;const n=(o,i,s,a)=>{if(i===void 0)return;let r;if(s===void 0)r=void 0;else if(s===-1)r=0;else if(s>=0)r=s;else return;(r===void 0||r>=0)&&(o.has(i)||o.set(i,[]),o.get(i).some(c=>c.copyIndex===r&&c.type===a)||o.get(i).push({copyIndex:r,type:a}))};t.mergePairs.forEach(o=>{n(gt,o.source.originalId,o.source.transformIndex,"vertex"),n(gt,o.target.originalId,o.target.transformIndex,"vertex")}),t.edgeSnaps.forEach(({sourceVertex:o,targetEdge:i})=>{n(gt,o.originalId,o.transformIndex,"edge"),n(Ss,i.originalEdgeId,i.transformIndex,"vertex_on_edge")})}function iu(e,t,n){const o=2*Fe/n.scale,i=new Map,s=new Map,a=new Map;e.forEach(d=>a.set(d.id,d.id));const r=d=>{if(!a.has(d)||a.get(d)===d)return d;const h=r(a.get(d));return a.set(d,h),h};for(let d=0;d<e.length;d++)for(let h=d+1;h<e.length;h++){const f=e[d],u=e[h];if(f.type==="regular"&&u.type==="regular"&&J(f,u)<o){const g=r(f.id),p=r(u.id);g!==p&&a.set(p,g)}}e.forEach(d=>{const h=r(d.id);d.id!==h&&i.set(d.id,h)});const c=new Set(i.keys()),l=new Map(e.map(d=>[d.id,d]));return t.forEach(d=>{const h=r(d.id1),f=r(d.id2);if(h===f)return;const u=l.get(h),g=l.get(f);!u||!g||e.forEach(p=>{if(p.type!=="regular"||c.has(p.id)||p.id===h||p.id===f)return;const y=bt(p,u,g);if(y.distance<o&&y.onSegmentStrict){const x=ne({id1:h,id2:f});s.has(x)||s.set(x,{edge:{id1:h,id2:f},pointsToInsert:[]}),s.get(x).pointsToInsert.push(p)}})}),{vertexMerges:i,edgeSplits:s}}function au(e){jn?Of():gn===0?Gf():gn===2&&qf(e),jn||Ol(),Ga(K)?fe.style.cursor="default":Vt||(fe.style.cursor="crosshair"),Yt()}function Ol(){Ft&&clearTimeout(Ft),Rt="",Ft=null,Bt=!1,Ne=!1,Un=!1,li=!1,Vs=!1,ds=!1,Se=[],ce=[],la=[],Os=[],ee=null,Xe=null,Is=[],Be=null,Ss.clear(),gt.clear(),ys.clear(),gn=-1}function ru(e){Ft&&clearTimeout(Ft),Rt="",Ft=null,ht.style.display==="block"&&(ht.style.display="none");const t=e.target;if(t&&(t.tagName==="INPUT"||t.closest(".katex"))){e.stopPropagation();return}if((Ue||Vt)&&e.button===2){Kn(),e.preventDefault();return}K=to(e,fe),Wt={...K},gn=e.button,gn===0?Yf(e):gn===2&&Wf(e)}function lu(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable)return;if(e.key==="Alt"&&!e.repeat&&(e.preventDefault(),_t=!0,Ka()),e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey&&!Ue&&!Vt&&!Bt){e.preventDefault(),Xh(e.key);return}const n=e.ctrlKey||e.metaKey;if(n&&(e.key==="a"||e.key==="A")){e.preventDefault();const i=ae.filter(c=>c.type==="regular").map(c=>c.id),s=U.map(c=>ne(c)),a=Z.map(c=>ge(c)),r=qe.map(c=>c.id);Ct(i,s,a,!1,!1,!1,r),Ie=ae.filter(c=>c.type!=="regular").map(c=>c.id),Ye=Ie.length>0?Ie[Ie.length-1]:null;return}if(e.key==="Shift"&&!ke){ke=!0;const i=Ee(K);if(Vt){const s=qo(i);s&&(Co=xe(s),Be=s)}else if(Ue&&it){const s=q(it);if(s){const a=Va(),r=Ua(s.id),c=Eo(s,K,ke);let l=Pe(Re),d=null;const h=he[Re];if(h!==-1){const u=ue[h];if(u&&u.type==="colormap"&&Ce&&Ce.length>=1){const g=Ce.length,p=Ce.length-1,y=g>1?p/(g-1):0,x=g>1?(p+1)/g:1;d={colormapItem:u,startT:y,endT:x}}}Jr(Me,{startVertex:s,snappedData:c,isShiftPressed:ke,currentColor:Pe(_e),nextCreationColor:Pe(_e),nextEdgeColor:l,colors:a,edgeColormapInfo:d},xe),el(Me,tt,s,c,c,{showDistances:xn,showAngles:On,currentShiftPressed:ke,distanceSigFigs:Qn,angleSigFigs:Ho,angleDisplayMode:nn,viewTransform:oe,frozenReference_D_du:dt,gridDisplayMode:st,frozenReference_A_rad:kt,colors:a},xe,r,xt)}}else if(!Bt)if(jn&&an&&an.type==="center"){const s=qo(i);if(s){Be=s;const a=an.face,r=a.localCoordSystem,c=a.vertexIds.map(d=>q(d)).filter(d=>d&&d.type==="regular"),l=qs(s,c);r.origin.x=l.x,r.origin.y=l.y,r.isCustom=!0}}else{const s=Ks(K),a=s?null:Js(K),r=!s&&!a?Zs(K):null;!s&&!a&&!r?Be=qo(i):Be=null}}if(Bt&&gn===0&&(ee?.targetVertex||ee?.targetEdge||ee?.targetFace)&&e.key>="0"&&e.key<="9"){if(e.repeat)return;e.preventDefault(),clearTimeout(Ft),Ft===null||Rt.length>=2?Rt=e.key:Rt+=e.key;const i=parseInt(Rt,10)||1;if(ee?.finalSnapResult?.finalDelta){const s=ee.finalSnapResult.finalDelta,a={delta:s},c=Ur(ce,ae,U,q,i,oe,a,(l,d,h=a)=>({x:l.x+h.delta.x*d,y:l.y+h.delta.y*d}));Ll(s,c),ee.finalSnapResult={...c,finalDelta:s}}Ft=setTimeout(()=>{Ft=null},500)}if(n&&e.key.toLowerCase()===rd){e.preventDefault(),Ue&&it&&xf();return}if(!(Bt&&!["Shift","Control","Meta","Alt","Escape","Delete","Backspace"].includes(e.key)&&!(n&&[Ir,vr,br,zi,Mr,Cr,Sr,mr,xr].includes(e.key.toLowerCase())))){if(xo&&n&&(e.key===mr||e.key===xr)){e.preventDefault();const i={x:fe.width/Ve/2,y:fe.height/Ve/2};pa(i,cr);return}if(xo&&n&&e.key===Sr){e.preventDefault();const i={x:fe.width/Ve/2,y:fe.height/Ve/2};pa(i,1/cr);return}if(e.key===sd)e.preventDefault(),lf();else if(e.key===od)Kn();else if(e.key===id||e.key===ad)e.preventDefault(),Ao();else if(n&&e.key.toLowerCase()===Ir){if(pt&&Te[yt]){e.preventDefault(),co=JSON.parse(JSON.stringify(Te[yt]));return}e.preventDefault(),Tl()}else if(n&&e.key.toLowerCase()===vr)e.preventDefault(),af();else if(n&&e.key.toLowerCase()===br){if(pt&&co){e.preventDefault(),tf();return}e.preventDefault(),rf()}else if(n&&e.key.toLowerCase()===zi&&!e.shiftKey){if(pt&&hi.length>0){e.preventDefault(),nf();return}e.preventDefault(),Df()}else if(n&&(e.key.toLowerCase()===Mr||e.shiftKey&&e.key.toLowerCase()===zi))e.preventDefault(),kf();else if(n&&e.key.toLowerCase()===Cr&&!ca){e.preventDefault(),Ge(),le=ae.filter(s=>s.type==="regular").map(s=>s.id),ie=U.map(s=>ne(s)),se=Z.map(s=>s.id),Ie=ae.filter(s=>s.type!=="regular").map(s=>s.id),Ye=null;const i=[];se.length>0&&i.push(we),ie.length>0&&i.push(Re),le.length>0&&i.push(_e),ye.length>0&&i.push(It),i.length>0&&(ze=i,ot&&at())}}}function cu(e){if(e.key==="Shift"&&(ke=!1,Be=null,Co=null,Is=[],jn&&an&&an.type==="center")){const t=Ee(K),n=an.face,o=n.localCoordSystem,i=n.vertexIds.map(a=>q(a)).filter(a=>a&&a.type==="regular"),s=qs(t,i);o.origin.x=s.x,o.origin.y=s.y,o.isCustom=!0}e.key==="Alt"&&(_t=!1,Ka()),Yt()}function Nl(){const e=document.querySelector(".canvas-container"),t=document.querySelector(".canvas-wrapper-relative");if(!e||!t)return;const n=t.offsetWidth,o=t.offsetHeight;fe.width=n*Ve,fe.height=o*Ve,fe.style.width=`${n}px`,fe.style.height=`${o}px`,tt&&(tt.style.width=`${n}px`,tt.style.height=`${o}px`)}function du(){Rh(),ue=bi.map(n=>typeof n=="string"?{type:"color",value:n}:n),typeof window.katex>"u"&&console.error("KaTeX library failed to load or initialize. Math rendering will be broken."),Wh(),yl(),Nl(),Nn=new Yl,Nn.initialize(),document.body.appendChild(Nn.getElement());const e=Nn.getElement();e.addEventListener("mouseenter",()=>{ca=!0}),e.addEventListener("mouseleave",()=>{ca=!1}),Nn.getElement().addEventListener("select",n=>{const o=n.detail,i=Ad(o);if(i){if(ci&&lo!==null)ue[lo]=i;else{jh(i);const s=ue.length-1;ze.forEach(a=>{he[a]=s})}Ya(),ci=!1,lo=null,at()}}),ks=new Jl({container:document.body,onSelect:n=>{if(!n)return;const o={...n};o.id||(o.id=Lt());const i=fn.findIndex(s=>s.id===o.id);i>=0?fn[i]=o:fn.push(o),fa(o.id),Qt&&xl(),Yt()}}),ks.initialize(),oe.scale=70,oe.offsetX=fe.width/2,oe.offsetY=fe.height/2,xs="regular",ht=document.getElementById("context-menu"),window.addEventListener("click",()=>{ht&&(ht.style.display="none")}),ht.addEventListener("mouseleave",()=>{ht.style.display="none"}),Zh()||(Jh()||Ge(),Qh()),Rl(),Ot()}fe.addEventListener("wheel",Uf,{passive:!1});fe.addEventListener("mouseenter",jf);fe.addEventListener("mouseleave",Kf);window.addEventListener("contextmenu",Jf);fe.addEventListener("mousemove",ou);fe.addEventListener("mouseup",au);fe.addEventListener("mousedown",ru);window.addEventListener("keyup",cu);window.addEventListener("keydown",lu);window.addEventListener("resize",Nl);window.addEventListener("beforeunload",()=>{El()});window.addEventListener("load",du);
